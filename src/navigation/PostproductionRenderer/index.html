<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="../../../resources/styles.css">
  <link rel="icon" type="image/x-icon" href="../../../resources/favicon.ico">
  <title>Tools Component</title>
</head>
<body>
<div class="full-screen" id="container"></div>
<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
        "three/examples/jsm/libs/lil-gui.module.min": "https://unpkg.com/three@0.152.2/examples/jsm/libs/lil-gui.module.min.js",
        "stats.js/src/Stats.js": "https://unpkg.com/stats-js@1.0.1/src/Stats.js",
        "openbim-components": "../../../resources/openbim-components.js"
      }
    }
</script>
<script type="module">

	// Set up scene (see SimpleScene tutorial)

	import Stats from 'stats.js/src/Stats.js';
	import * as THREE from 'three';
	import * as OBC from 'openbim-components';
    import * as dat from 'three/examples/jsm/libs/lil-gui.module.min';

	// Set up basic components

	const container = document.getElementById('container');

	const components = new OBC.Components();
	const sceneComponent = new OBC.SimpleScene(components);
	components.scene = sceneComponent


	const grid = new OBC.SimpleGrid(components);
	components.tools.add(grid);

	const scene = sceneComponent.get();
	// scene.background = null;

	// Add some lights to the scene

	const directionalLight = new THREE.DirectionalLight();
	directionalLight.position.set(5, 10, 3)
	directionalLight.intensity = 0.5;
	scene.add(directionalLight);

	const ambientLight = new THREE.AmbientLight();
	ambientLight.intensity = 0.5;
	scene.add(ambientLight);

	// Set up postproduction renderer
	components.renderer = new OBC.PostproductionRenderer(components, container);
	components.camera = new OBC.OrthoPerspectiveCamera(components);
	components.raycaster = new OBC.SimpleRaycaster(components);
	components.init();

   components.camera.controls.setLookAt(10, 8, 20, 0, 0, 10);

    // Set up stats

    const stats = new Stats();
    stats.showPanel(2);
    document.body.append(stats.dom);
    stats.dom.style.left = '0px';
    const renderer = components.renderer;
    renderer.beforeUpdate.on(() => stats.begin());
    renderer.afterUpdate.on(() => stats.end());

    /*MD
    ### üß™ Cool Post-Production Effects
    ---
    Post-production effects enrich your 3D scenes. There are several post-production effects, such as
    adding shadows, rendering outlines, adding ambient occlusion and applying bloom, that can enhance
    and make your scene look cool.üçπ

    :::tip First, let's set up a simple scene!

    üëÄ If you haven't started there, check out [that tutorial first](SimpleScene.mdx)!

    :::

    In this tutorial we will use **Post-Production Renderer** to add neat **Outlines** and **Ambient Occlusion** to the 3D Model.ü¶æ

    ### üè¢ Adding Fragments
    ---
    We'll start by adding a **Fragment** to our scene using Fragment Manager.

    We'll use a simple fragment for the purposes of this tutorial, but the code is capable of handling big files as well.üèóÔ∏è

    :::info Using Fragment Manager!

    üèãÔ∏è There is a dedicated tutorial on how to use Fragment Manager to load **IFC** files!

    :::

    */

    const fragments = new OBC.FragmentManager(components);
    const file = await fetch("../../../resources/small.frag");
    const data = await file.arrayBuffer();
    const buffer = new Uint8Array(data);
    const ids = fragments.load(buffer);

    const culler = new OBC.ScreenCuller(components);
    for(const id of ids) {
      const fragment = fragments.list[id];
      culler.add(fragment.mesh);
    }
    culler.needsUpdate = true;

    const controls = components.camera.controls;
    controls.addEventListener("controlend", () => {
      culler.needsUpdate = true;
    })

	/*MD
	### üéõÔ∏è Setting Up Post-Production
	---

    Let's start by specifying the outline color, we'll set it to `0x999999`. Also, we will pass the
    camera controls to the post-production object.

	 */

	components.renderer.postproduction.outlineColor = 0x999999;


    /*MD
    ### üé¨ Activating the Post-Production
    ---

    Now that set up is complete, we wil activate the post-production effect.
    Also, we will enable the visibility for post-production layer.

    - `postproduction.active` - Enable or Disable the active status of the post-processing effect
    - `postproduction.visible` - Toggle the visibility of post-processing layer that is created to display the effect.

     */

	components.renderer.postproduction.enabled = true;
    const postproduction = components.renderer.postproduction;

    postproduction.outlineColor = 0x202932;

    const configuration = postproduction.n8ao.configuration;

    postproduction.n8ao.setQualityMode("Low");

    configuration.aoSamples = 10;
    configuration.denoiseSamples = 1;
    configuration.denoiseRadius = 1;
    configuration.aoRadius = 1;
    configuration.distanceFalloff = 4;
    configuration.aoRadius = 1;
    configuration.intensity = 4;

    configuration.halfRes = true;
    configuration.color = new THREE.Color().setHex(0xcccccc, "srgb-linear");

    const gui = new dat.GUI();
    gui.add(postproduction, "enabled");
    gui.add(configuration, "aoSamples").step(1).min(1).max(16);
    gui.add(configuration, "denoiseSamples").step(1).min(0).max(16);
    gui.add(configuration, "denoiseRadius").step(1).min(0).max(100);
    gui.add(configuration, "aoRadius").step(1).min(0).max(16);
    gui.add(configuration, "distanceFalloff").step(1).min(0).max(16);
    gui.add(configuration, "intensity").step(1).min(0).max(16);
    gui.add(configuration, "halfRes");
    gui.add(configuration, "screenSpaceRadius");
    gui.addColor(configuration, "color");
    gui.addColor(postproduction, "outlineColor");


    /*MD
    **Congratulations** üéâ on completing this tutorial! Now you know how to add cool effects easily using
    Post Production üñºÔ∏è
    Let's keep it up and check out another tutorial! üéì
     */
</script>
</body>
</html>