var E=Object.defineProperty;var C=(S,m,e)=>m in S?E(S,m,{enumerable:!0,configurable:!0,writable:!0,value:e}):S[m]=e;var r=(S,m,e)=>(C(S,typeof m!="symbol"?m+"":m,e),e);import{c as D,E as v,e as N,R as T,F as M}from"./graphic-vertex-picker-CqNhsDsK.js";import{v as O,C as B,Y as H,S as j,g as x}from"./index-lvtjgYNN.js";const y=class y extends D{constructor(e){super(e);r(this,"onDisposed",new v);r(this,"onBeforeUpdate",new v);r(this,"onAfterUpdate",new v);r(this,"onSetup",new v);r(this,"isSetup",!1);r(this,"enabled",!0);r(this,"events",{});r(this,"multiple","ctrlKey");r(this,"zoomFactor",1.5);r(this,"zoomToSelection",!1);r(this,"backupColor",null);r(this,"selection",{});r(this,"config",{selectName:"select",selectionColor:null,autoHighlightOnClick:!0,world:null,selectEnabled:!0,selectMaterialDefinition:{color:new B("#BCF124"),renderedFaces:O.ONE,opacity:1,transparent:!1}});r(this,"styles",new H);r(this,"autoToggle",new Set);r(this,"mouseDownPosition",{x:0,y:0});r(this,"mouseMoveThreshold",5);r(this,"selectable",{});r(this,"eventManager",new N);r(this,"_mouseState",{down:!1,moved:!1});r(this,"_fromHighlight",!1);r(this,"restorePreviousColors",(e=this.selection.select)=>{for(const[t,s]of Object.entries(this.selection))if(!(t===this.config.selectName||!this.styles.get(t)))for(const[i,l]of Object.entries(e)){const a=s[i];if(!a)continue;const c=[...l].filter(n=>a.has(n));c.length!==0&&new Set(c)}});r(this,"onMouseDown",e=>{this.enabled&&(this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.mouseDownPosition={x:e.clientX,y:e.clientY},this._mouseState.down=!0)});r(this,"debounceTimeout",null);r(this,"onMouseUp",async e=>{if(!this.enabled)return;const{world:t,autoHighlightOnClick:s,selectEnabled:o}=this.config;if(!t)throw new Error("No world found!");if(!t.renderer)throw new Error("This world doesn't have a renderer!");if(e.target===t.renderer.three.domElement){if(this._mouseState.down=!1,this._mouseState.moved||e.button!==0){this._mouseState.moved=!1;return}if(this._mouseState.moved=!1,s&&o){const i=this.multiple==="none"?!0:!e[this.multiple];await this.highlight(this.config.selectName,i,this.zoomToSelection)}}});r(this,"onMouseMove",async e=>{if(!this.enabled)return;const t=e.clientX-this.mouseDownPosition.x,s=e.clientY-this.mouseDownPosition.y,o=Math.sqrt(t*t+s*s);this._mouseState.moved||o>this.mouseMoveThreshold&&(this._mouseState.moved=this._mouseState.down)});this.components.add(y.uuid,this),this.eventManager.list.add(this.onSetup),this.eventManager.list.add(this.onDisposed),this.setStyleEvents()}setStyleEvents(){this.styles.onBeforeDelete.add(async({key:e})=>{if(await this.clear(e),delete this.selection[e],!(e in this.events))return;const{onClear:t,onHighlight:s,onBeforeHighlight:o}=this.events[e];this.eventManager.list.delete(t),this.eventManager.list.delete(s),this.eventManager.list.delete(o),delete this.events[e]}),this.styles.onItemSet.add(({key:e})=>{this.selection[e]={};const t=new v,s=new v,o=new v;this.events[e]={onHighlight:t,onClear:o,onBeforeHighlight:s},this.eventManager.add([o,t,s])})}async dispose(){this.setupEvents(!1),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.selection={},this.styles.clear(),this.onDisposed.trigger(y.uuid),this.eventManager.reset(),this.isSetup=!1}add(e){if(console.warn("highlighter.add() is deprecated, use highlighter.styles.set() instead"),typeof e=="string")this.styles.set(e,null);else{const{customId:t}=e;this.styles.set(t,e)}}async remove(e){console.warn("highlighter.remove() is deprecated, use highlighter.styles.delete() instead"),this.styles.delete(e)}async highlight(e,t=!0,s=this.zoomToSelection,o=null){if(!this.enabled)return;if(!this.config.world)throw new Error("No world found in config!");const i=this.config.world;if(!this.selection[e])throw new Error(`Selection ${e} does not exist.`);const c=await this.components.get(T).get(i).castRay();if(!c||c.localId===void 0||c.localId===null){t&&this.clear(e);return}const{localId:n,fragments:{modelId:d}}=c,h={[d]:new Set([n])};await this.highlightByID(e,h,t,s,o,!0)}async highlightByID(e,t,s=!0,o=this.zoomToSelection,i=null,l=!1){var c;if(!this.enabled)return;this._fromHighlight=!0,this.events[e].onBeforeHighlight.trigger(this.selection[e]),s&&await this.clear(e);let a={};if(Object.keys(this.selectable).length!==0||i!==null)for(const n in t){const d=new Set(t[n]),h=(c=this.selectable)==null?void 0:c[e],f=h?h[n]:void 0,w=f?new Set(f):void 0,u=i==null?void 0:i[n],g=u?new Set(u):void 0;if(g||w)for(const b of d){if(g&&g.has(b)||w&&!w.has(b))continue;let p=a[n];p||(p=new Set,a[n]=p),p.add(b)}}else a=t;if(l&&this.autoToggle.has(e)){const n={};let d=!1;for(const h in a){const f=this.selection[e][h];if(!f)continue;const w=a[h];for(const u of w)if(f.has(u)){f.delete(u);let g=n[h];g||(g=new Set,n[h]=g),g.add(u),d=!0}else f.add(u);a[h]=f}d&&(this.events[e].onClear.trigger(n),e===this.config.selectName&&this.restorePreviousColors(n))}this.updateStyleMap(e,a),this.events[e].onHighlight.trigger(this.selection[e]),this._fromHighlight=!1,await this.updateColors(),o&&await this.zoomSelection(a)}async updateColors(){const e=this.components.get(M),t=[e.resetHighlight()];for(const[s,o]of Object.entries(this.selection)){const i=this.styles.get(s);if(!i)continue;const l=s==="select"||!this.styles.get(this.config.selectName)?o:this.getMapWithoutSelection(s);l&&t.push(e.highlight({...i,customId:s},l))}t.push(e.core.update(!0)),await Promise.allSettled(t)}updateStyleMap(e,t){const s=this.selection[e];for(const o in t){let i=s[o];i||(i=new Set,s[o]=i);const l=t[o];for(const a of l)i.add(a)}if(e!==this.config.selectName)for(const[o,i]of Object.entries(this.selection)){if(o===this.config.selectName||o===e)continue;const l=i;for(const[a,c]of Object.entries(s)){const n=l[a];if(n)for(const d of c)n.delete(d)}}}getMapWithoutSelection(e,t){const s=this.selection[e];if(!s)throw new Error(`Style ${e} does not exist.`);const o=this.selection[this.config.selectName]??{},i={};for(const l in s){const a=s[l],c=e===this.config.selectName?new Set:o[l]??new Set,n=Array.from(a).filter(d=>{var h;return!c.has(d)&&(!t||((h=t[l])==null?void 0:h.has(d)))});n.length>0&&(i[l]=new Set(n))}return Object.keys(i).length>0?i:null}async clear(e,t){const s=e?[e]:Object.keys(this.selection),o=t??void 0;for(const i of s){const l=this.selection[i]??{},a=o??l;i===this.config.selectName&&this.restorePreviousColors();const c={};for(const[n,d]of Object.entries(a)){const h=l[n];if(h)for(const f of d){if(!h.delete(f))continue;let u=c[n];u||(u=new Set,c[n]=u),u.add(f)}}Object.keys(c).length>0&&this.events[i].onClear.trigger(c)}this._fromHighlight||await this.updateColors()}setup(e){if(this.isSetup)return;this.config={...this.config,...e};const{selectName:t,selectionColor:s,selectMaterialDefinition:o}=this.config;o?(s&&(console.warn("highlighter.config.selectionColor is deprecated, use selectMaterialDefinition instead"),o.color=s),this.styles.set(t,o)):this.styles.set(t,null),this.autoToggle.add(this.config.selectName),this.setupEvents(!0),this.enabled=!0,this.isSetup=!0,this.onSetup.trigger(this)}async zoomSelection(e){if(!this.config.world)throw new Error("No world found in config!");const t=this.config.world;let s=!1;for(const p in e)if(e[p].size>0){s=!0;break}if(!s||!t.camera.hasCameraControls())return;const i=await this.components.get(M).getBBoxes(e),l=new j,a=new x;for(const p of i)a.union(p);a.getBoundingSphere(l);const c=1/0,n=-1/0,{x:d,y:h,z:f}=l.center,w=l.radius===c||d===c||h===c||f===c,u=l.radius===n||d===n||h===n||f===n,g=l.radius===0;if(w||u||g)return;l.radius*=this.zoomFactor,await t.camera.controls.fitToSphere(l,!0)}setupEvents(e){if(!this.config.world){console.log("No world found while setting up events!");return}if(this.config.world.isDisposing)return;if(!this.config.world.renderer)throw new Error("The given world doesn't have a renderer!");const t=this.config.world.renderer.three.domElement;t.removeEventListener("mousedown",this.onMouseDown),t.removeEventListener("mouseup",this.onMouseUp),t.removeEventListener("pointermove",this.onMouseMove),e&&(t.addEventListener("mousedown",this.onMouseDown),t.addEventListener("mouseup",this.onMouseUp),t.addEventListener("pointermove",this.onMouseMove))}};r(y,"uuid","cb8a76f2-654a-4b50-80c6-66fd83cafd77");let I=y;export{I as H};
