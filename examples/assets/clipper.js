var Oe=Object.defineProperty;var We=(h,n,t)=>n in h?Oe(h,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[n]=t;var r=(h,n,t)=>(We(h,typeof n!="symbol"?n+"":n,t),t);import{s as Ge,V as l,r as le,Q as I,E as Ne,g as me,M as he,k as Ue,a7 as g,d as u,f as ge,aj as ye,b as o,ak as ie,al as X,am as Ve,an as O,P as Ae,z as De,h as Je,F as Ke,I as $e,e as et,C as tt}from"./unzipit.module-DQmiVUKU.js";import{g as nt}from"./lil-gui.module.min-Bc0DeA9g.js";import{S as it}from"./stats.min-GTpOrGrX.js";import{E as b,c as st,W as Ye,C as ot,S as at,a as rt,b as lt}from"./index-DECOYrZp.js";import{R as _e}from"./index-BV-26MJy.js";import"./_commonjsHelpers-Cpj98o6Y.js";const z=new Ge,f=new l,C=new l,d=new I,be={X:new l(1,0,0),Y:new l(0,1,0),Z:new l(0,0,1)},ce={type:"change"},Pe={type:"mouseDown"},Me={type:"mouseUp",mode:null},xe={type:"objectChange"};class ht extends le{constructor(n,t){super(),t===void 0&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),t=document),this.isTransformControls=!0,this.visible=!1,this.domElement=t,this.domElement.style.touchAction="none";const i=new ft;this._gizmo=i,this.add(i);const s=new wt;this._plane=s,this.add(s);const a=this;function e(w,P){let k=P;Object.defineProperty(a,w,{get:function(){return k!==void 0?k:P},set:function(T){k!==T&&(k=T,s[w]=T,i[w]=T,a.dispatchEvent({type:w+"-changed",value:T}),a.dispatchEvent(ce))}}),a[w]=P,s[w]=P,i[w]=P}e("camera",n),e("object",void 0),e("enabled",!0),e("axis",null),e("mode","translate"),e("translationSnap",null),e("rotationSnap",null),e("scaleSnap",null),e("space","world"),e("size",1),e("dragging",!1),e("showX",!0),e("showY",!0),e("showZ",!0);const c=new l,m=new l,v=new I,B=new I,L=new l,q=new I,fe=new l,K=new l,D=new l,Y=0,S=new l;e("worldPosition",c),e("worldPositionStart",m),e("worldQuaternion",v),e("worldQuaternionStart",B),e("cameraPosition",L),e("cameraQuaternion",q),e("pointStart",fe),e("pointEnd",K),e("rotationAxis",D),e("rotationAngle",Y),e("eye",S),this._offset=new l,this._startNorm=new l,this._endNorm=new l,this._cameraScale=new l,this._parentPosition=new l,this._parentQuaternion=new I,this._parentQuaternionInv=new I,this._parentScale=new l,this._worldScaleStart=new l,this._worldQuaternionInv=new I,this._worldScale=new l,this._positionStart=new l,this._quaternionStart=new I,this._scaleStart=new l,this._getPointer=ct.bind(this),this._onPointerDown=dt.bind(this),this._onPointerHover=pt.bind(this),this._onPointerMove=mt.bind(this),this._onPointerUp=ut.bind(this),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp)}updateMatrixWorld(){this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this._parentPosition,this._parentQuaternion,this._parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this._worldScale),this._parentQuaternionInv.copy(this._parentQuaternion).invert(),this._worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this._cameraScale),this.camera.isOrthographicCamera?this.camera.getWorldDirection(this.eye).negate():this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld(this)}pointerHover(n){if(this.object===void 0||this.dragging===!0)return;z.setFromCamera(n,this.camera);const t=pe(this._gizmo.picker[this.mode],z);t?this.axis=t.object.name:this.axis=null}pointerDown(n){if(!(this.object===void 0||this.dragging===!0||n.button!==0)&&this.axis!==null){z.setFromCamera(n,this.camera);const t=pe(this._plane,z,!0);t&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(t.point).sub(this.worldPositionStart)),this.dragging=!0,Pe.mode=this.mode,this.dispatchEvent(Pe)}}pointerMove(n){const t=this.axis,i=this.mode,s=this.object;let a=this.space;if(i==="scale"?a="local":(t==="E"||t==="XYZE"||t==="XYZ")&&(a="world"),s===void 0||t===null||this.dragging===!1||n.button!==-1)return;z.setFromCamera(n,this.camera);const e=pe(this._plane,z,!0);if(e){if(this.pointEnd.copy(e.point).sub(this.worldPositionStart),i==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),a==="local"&&t!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),t.indexOf("X")===-1&&(this._offset.x=0),t.indexOf("Y")===-1&&(this._offset.y=0),t.indexOf("Z")===-1&&(this._offset.z=0),a==="local"&&t!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),s.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(a==="local"&&(s.position.applyQuaternion(d.copy(this._quaternionStart).invert()),t.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),t.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),t.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.position.applyQuaternion(this._quaternionStart)),a==="world"&&(s.parent&&s.position.add(f.setFromMatrixPosition(s.parent.matrixWorld)),t.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),t.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),t.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.parent&&s.position.sub(f.setFromMatrixPosition(s.parent.matrixWorld))));else if(i==="scale"){if(t.search("XYZ")!==-1){let c=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(c*=-1),C.set(c,c,c)}else f.copy(this.pointStart),C.copy(this.pointEnd),f.applyQuaternion(this._worldQuaternionInv),C.applyQuaternion(this._worldQuaternionInv),C.divide(f),t.search("X")===-1&&(C.x=1),t.search("Y")===-1&&(C.y=1),t.search("Z")===-1&&(C.z=1);s.scale.copy(this._scaleStart).multiply(C),this.scaleSnap&&(t.search("X")!==-1&&(s.scale.x=Math.round(s.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),t.search("Y")!==-1&&(s.scale.y=Math.round(s.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),t.search("Z")!==-1&&(s.scale.z=Math.round(s.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(i==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const c=20/this.worldPosition.distanceTo(f.setFromMatrixPosition(this.camera.matrixWorld));let m=!1;t==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(f.copy(this.rotationAxis).cross(this.eye))*c):(t==="X"||t==="Y"||t==="Z")&&(this.rotationAxis.copy(be[t]),f.copy(be[t]),a==="local"&&f.applyQuaternion(this.worldQuaternion),f.cross(this.eye),f.length()===0?m=!0:this.rotationAngle=this._offset.dot(f.normalize())*c),(t==="E"||m)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),a==="local"&&t!=="E"&&t!=="XYZE"?(s.quaternion.copy(this._quaternionStart),s.quaternion.multiply(d.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),s.quaternion.copy(d.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),s.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(ce),this.dispatchEvent(xe)}}pointerUp(n){n.button===0&&(this.dragging&&this.axis!==null&&(Me.mode=this.mode,this.dispatchEvent(Me)),this.dragging=!1,this.axis=null)}dispose(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.traverse(function(n){n.geometry&&n.geometry.dispose(),n.material&&n.material.dispose()})}attach(n){return this.object=n,this.visible=!0,this}detach(){return this.object=void 0,this.visible=!1,this.axis=null,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(ce),this.dispatchEvent(xe),this.pointStart.copy(this.pointEnd))}getRaycaster(){return z}getMode(){return this.mode}setMode(n){this.mode=n}setTranslationSnap(n){this.translationSnap=n}setRotationSnap(n){this.rotationSnap=n}setScaleSnap(n){this.scaleSnap=n}setSize(n){this.size=n}setSpace(n){this.space=n}}function ct(h){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:h.button};{const n=this.domElement.getBoundingClientRect();return{x:(h.clientX-n.left)/n.width*2-1,y:-(h.clientY-n.top)/n.height*2+1,button:h.button}}}function pt(h){if(this.enabled)switch(h.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(h));break}}function dt(h){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(h.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(h)),this.pointerDown(this._getPointer(h)))}function mt(h){this.enabled&&this.pointerMove(this._getPointer(h))}function ut(h){this.enabled&&(this.domElement.releasePointerCapture(h.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(h)))}function pe(h,n,t){const i=n.intersectObject(h,!0);for(let s=0;s<i.length;s++)if(i[s].object.visible||t)return i[s];return!1}const se=new Ne,p=new l(0,1,0),ve=new l(0,0,0),Se=new me,oe=new I,re=new I,E=new l,Ee=new me,N=new l(1,0,0),Z=new l(0,1,0),U=new l(0,0,1),ae=new l,W=new l,G=new l;class ft extends le{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const n=new he({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),t=new Ue({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),i=n.clone();i.opacity=.15;const s=t.clone();s.opacity=.5;const a=n.clone();a.color.setHex(16711680);const e=n.clone();e.color.setHex(65280);const c=n.clone();c.color.setHex(255);const m=n.clone();m.color.setHex(16711680),m.opacity=.5;const v=n.clone();v.color.setHex(65280),v.opacity=.5;const B=n.clone();B.color.setHex(255),B.opacity=.5;const L=n.clone();L.opacity=.25;const q=n.clone();q.color.setHex(16776960),q.opacity=.25,n.clone().color.setHex(16776960);const K=n.clone();K.color.setHex(7895160);const D=new g(0,.04,.1,12);D.translate(0,.05,0);const Y=new u(.08,.08,.08);Y.translate(0,.04,0);const S=new ge;S.setAttribute("position",new ye([0,0,0,1,0,0],3));const w=new g(.0075,.0075,.5,3);w.translate(0,.25,0);function P(_,$){const M=new O(_,.0075,3,64,$*Math.PI*2);return M.rotateY(Math.PI/2),M.rotateX(Math.PI/2),M}function k(){const _=new ge;return _.setAttribute("position",new ye([0,0,0,1,1,1],3)),_}const T={X:[[new o(D,a),[.5,0,0],[0,0,-Math.PI/2]],[new o(D,a),[-.5,0,0],[0,0,Math.PI/2]],[new o(w,a),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new o(D,e),[0,.5,0]],[new o(D,e),[0,-.5,0],[Math.PI,0,0]],[new o(w,e)]],Z:[[new o(D,c),[0,0,.5],[Math.PI/2,0,0]],[new o(D,c),[0,0,-.5],[-Math.PI/2,0,0]],[new o(w,c),null,[Math.PI/2,0,0]]],XYZ:[[new o(new ie(.1,0),L.clone()),[0,0,0]]],XY:[[new o(new u(.15,.15,.01),B.clone()),[.15,.15,0]]],YZ:[[new o(new u(.15,.15,.01),m.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new o(new u(.15,.15,.01),v.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},Ze={X:[[new o(new g(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new o(new g(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new o(new g(.2,0,.6,4),i),[0,.3,0]],[new o(new g(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new o(new g(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new o(new g(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new o(new ie(.2,0),i)]],XY:[[new o(new u(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new o(new u(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new o(new u(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]]},He={START:[[new o(new ie(.01,2),s),null,null,null,"helper"]],END:[[new o(new ie(.01,2),s),null,null,null,"helper"]],DELTA:[[new X(k(),s),null,null,null,"helper"]],X:[[new X(S,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new X(S,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new X(S,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},Be={XYZE:[[new o(P(.5,1),K),null,[0,Math.PI/2,0]]],X:[[new o(P(.5,.5),a)]],Y:[[new o(P(.5,.5),e),null,[0,0,-Math.PI/2]]],Z:[[new o(P(.5,.5),c),null,[0,Math.PI/2,0]]],E:[[new o(P(.75,1),q),null,[0,Math.PI/2,0]]]},ke={AXIS:[[new X(S,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},je={XYZE:[[new o(new Ve(.25,10,8),i)]],X:[[new o(new O(.5,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new o(new O(.5,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new o(new O(.5,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new o(new O(.75,.1,2,24),i)]]},Re={X:[[new o(Y,a),[.5,0,0],[0,0,-Math.PI/2]],[new o(w,a),[0,0,0],[0,0,-Math.PI/2]],[new o(Y,a),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new o(Y,e),[0,.5,0]],[new o(w,e)],[new o(Y,e),[0,-.5,0],[0,0,Math.PI]]],Z:[[new o(Y,c),[0,0,.5],[Math.PI/2,0,0]],[new o(w,c),[0,0,0],[Math.PI/2,0,0]],[new o(Y,c),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new o(new u(.15,.15,.01),B),[.15,.15,0]]],YZ:[[new o(new u(.15,.15,.01),m),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new o(new u(.15,.15,.01),v),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new o(new u(.1,.1,.1),L.clone())]]},Fe={X:[[new o(new g(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new o(new g(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new o(new g(.2,0,.6,4),i),[0,.3,0]],[new o(new g(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new o(new g(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new o(new g(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new o(new u(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new o(new u(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new o(new u(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new o(new u(.2,.2,.2),i),[0,0,0]]]},Le={X:[[new X(S,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new X(S,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new X(S,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function Q(_){const $=new le;for(const M in _)for(let j=_[M].length;j--;){const y=_[M][j][0].clone(),ee=_[M][j][1],te=_[M][j][2],ne=_[M][j][3],qe=_[M][j][4];y.name=M,y.tag=qe,ee&&y.position.set(ee[0],ee[1],ee[2]),te&&y.rotation.set(te[0],te[1],te[2]),ne&&y.scale.set(ne[0],ne[1],ne[2]),y.updateMatrix();const we=y.geometry.clone();we.applyMatrix4(y.matrix),y.geometry=we,y.renderOrder=1/0,y.position.set(0,0,0),y.rotation.set(0,0,0),y.scale.set(1,1,1),$.add(y)}return $}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=Q(T)),this.add(this.gizmo.rotate=Q(Be)),this.add(this.gizmo.scale=Q(Re)),this.add(this.picker.translate=Q(Ze)),this.add(this.picker.rotate=Q(je)),this.add(this.picker.scale=Q(Fe)),this.add(this.helper.translate=Q(He)),this.add(this.helper.rotate=Q(ke)),this.add(this.helper.scale=Q(Le)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(n){const i=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:re;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let s=[];s=s.concat(this.picker[this.mode].children),s=s.concat(this.gizmo[this.mode].children),s=s.concat(this.helper[this.mode].children);for(let a=0;a<s.length;a++){const e=s[a];e.visible=!0,e.rotation.set(0,0,0),e.position.copy(this.worldPosition);let c;if(this.camera.isOrthographicCamera?c=(this.camera.top-this.camera.bottom)/this.camera.zoom:c=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),e.scale.set(1,1,1).multiplyScalar(c*this.size/4),e.tag==="helper"){e.visible=!1,e.name==="AXIS"?(e.visible=!!this.axis,this.axis==="X"&&(d.setFromEuler(se.set(0,0,0)),e.quaternion.copy(i).multiply(d),Math.abs(p.copy(N).applyQuaternion(i).dot(this.eye))>.9&&(e.visible=!1)),this.axis==="Y"&&(d.setFromEuler(se.set(0,0,Math.PI/2)),e.quaternion.copy(i).multiply(d),Math.abs(p.copy(Z).applyQuaternion(i).dot(this.eye))>.9&&(e.visible=!1)),this.axis==="Z"&&(d.setFromEuler(se.set(0,Math.PI/2,0)),e.quaternion.copy(i).multiply(d),Math.abs(p.copy(U).applyQuaternion(i).dot(this.eye))>.9&&(e.visible=!1)),this.axis==="XYZE"&&(d.setFromEuler(se.set(0,Math.PI/2,0)),p.copy(this.rotationAxis),e.quaternion.setFromRotationMatrix(Se.lookAt(ve,p,Z)),e.quaternion.multiply(d),e.visible=this.dragging),this.axis==="E"&&(e.visible=!1)):e.name==="START"?(e.position.copy(this.worldPositionStart),e.visible=this.dragging):e.name==="END"?(e.position.copy(this.worldPosition),e.visible=this.dragging):e.name==="DELTA"?(e.position.copy(this.worldPositionStart),e.quaternion.copy(this.worldQuaternionStart),f.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),f.applyQuaternion(this.worldQuaternionStart.clone().invert()),e.scale.copy(f),e.visible=this.dragging):(e.quaternion.copy(i),this.dragging?e.position.copy(this.worldPositionStart):e.position.copy(this.worldPosition),this.axis&&(e.visible=this.axis.search(e.name)!==-1));continue}e.quaternion.copy(i),this.mode==="translate"||this.mode==="scale"?(e.name==="X"&&Math.abs(p.copy(N).applyQuaternion(i).dot(this.eye))>.99&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),e.name==="Y"&&Math.abs(p.copy(Z).applyQuaternion(i).dot(this.eye))>.99&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),e.name==="Z"&&Math.abs(p.copy(U).applyQuaternion(i).dot(this.eye))>.99&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),e.name==="XY"&&Math.abs(p.copy(U).applyQuaternion(i).dot(this.eye))<.2&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),e.name==="YZ"&&Math.abs(p.copy(N).applyQuaternion(i).dot(this.eye))<.2&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1),e.name==="XZ"&&Math.abs(p.copy(Z).applyQuaternion(i).dot(this.eye))<.2&&(e.scale.set(1e-10,1e-10,1e-10),e.visible=!1)):this.mode==="rotate"&&(oe.copy(i),p.copy(this.eye).applyQuaternion(d.copy(i).invert()),e.name.search("E")!==-1&&e.quaternion.setFromRotationMatrix(Se.lookAt(this.eye,ve,Z)),e.name==="X"&&(d.setFromAxisAngle(N,Math.atan2(-p.y,p.z)),d.multiplyQuaternions(oe,d),e.quaternion.copy(d)),e.name==="Y"&&(d.setFromAxisAngle(Z,Math.atan2(p.x,p.z)),d.multiplyQuaternions(oe,d),e.quaternion.copy(d)),e.name==="Z"&&(d.setFromAxisAngle(U,Math.atan2(p.y,p.x)),d.multiplyQuaternions(oe,d),e.quaternion.copy(d))),e.visible=e.visible&&(e.name.indexOf("X")===-1||this.showX),e.visible=e.visible&&(e.name.indexOf("Y")===-1||this.showY),e.visible=e.visible&&(e.name.indexOf("Z")===-1||this.showZ),e.visible=e.visible&&(e.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),e.material._color=e.material._color||e.material.color.clone(),e.material._opacity=e.material._opacity||e.material.opacity,e.material.color.copy(e.material._color),e.material.opacity=e.material._opacity,this.enabled&&this.axis&&(e.name===this.axis||this.axis.split("").some(function(m){return e.name===m}))&&(e.material.color.setHex(16776960),e.material.opacity=1)}super.updateMatrixWorld(n)}}class wt extends o{constructor(){super(new Ae(1e5,1e5,2,2),new he({visible:!1,wireframe:!0,side:De,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(n){let t=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(t="local"),ae.copy(N).applyQuaternion(t==="local"?this.worldQuaternion:re),W.copy(Z).applyQuaternion(t==="local"?this.worldQuaternion:re),G.copy(U).applyQuaternion(t==="local"?this.worldQuaternion:re),p.copy(W),this.mode){case"translate":case"scale":switch(this.axis){case"X":p.copy(this.eye).cross(ae),E.copy(ae).cross(p);break;case"Y":p.copy(this.eye).cross(W),E.copy(W).cross(p);break;case"Z":p.copy(this.eye).cross(G),E.copy(G).cross(p);break;case"XY":E.copy(G);break;case"YZ":E.copy(ae);break;case"XZ":p.copy(G),E.copy(W);break;case"XYZ":case"E":E.set(0,0,0);break}break;case"rotate":default:E.set(0,0,0)}E.length()===0?this.quaternion.copy(this.cameraQuaternion):(Ee.lookAt(f.set(0,0,0),E,p),this.quaternion.setFromRotationMatrix(Ee)),super.updateMatrixWorld(n)}}class ue{constructor(n,t,i,s,a,e=5,c=!0){r(this,"onDraggingStarted",new b);r(this,"onDraggingEnded",new b);r(this,"onDisposed",new b);r(this,"normal");r(this,"origin");r(this,"three",new Je);r(this,"_helper");r(this,"_visible",!0);r(this,"_enabled",!0);r(this,"components");r(this,"world");r(this,"_controlsActive",!1);r(this,"_arrowBoundBox",new o);r(this,"_planeMesh");r(this,"_controls");r(this,"_hiddenMaterial",new he({visible:!1}));r(this,"update",async()=>{this._enabled&&this.three.setFromNormalAndCoplanarPoint(this.normal,this._helper.position)});r(this,"changeDrag",n=>{this._visible=!n.value,this.preventCameraMovement(),this.notifyDraggingChanged(n)});if(this.components=n,this.world=t,!t.renderer)throw new Error("The given world must have a renderer!");this.normal=s,this.origin=i,t.renderer.setPlane(!0,this.three),this._planeMesh=ue.newPlaneMesh(e,a),this._helper=this.newHelper(),this._controls=this.newTransformControls(),this.three.setFromNormalAndCoplanarPoint(s,i),c&&this.toggleControls(!0)}get enabled(){return this._enabled}set enabled(n){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");this._enabled=n,this.world.renderer.setPlane(n,this.three)}get visible(){return this._visible}set visible(n){this._visible=n,this._controls.visible=n,this._helper.visible=n,this.toggleControls(n)}get meshes(){return[this._planeMesh,this._arrowBoundBox]}get planeMaterial(){return this._planeMesh.material}set planeMaterial(n){this._planeMesh.material=n}get size(){return this._planeMesh.scale.x}set size(n){this._planeMesh.scale.set(n,n,n)}get helper(){return this._helper}async setFromNormalAndCoplanarPoint(n,t){this.reset(),this.normal.equals(n)||(this.normal.copy(n),this._helper.lookAt(n)),this.origin.copy(t),this._helper.position.copy(t),this._helper.updateMatrix(),await this.update()}dispose(){this._enabled=!1,this.onDraggingStarted.reset(),this.onDraggingEnded.reset(),this._helper.removeFromParent(),this.world.renderer&&this.world.renderer.setPlane(!1,this.three),this._arrowBoundBox.removeFromParent(),this._arrowBoundBox.geometry.dispose(),this._planeMesh.geometry.dispose(),this._controls.removeFromParent(),this._controls.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}reset(){const n=new l(1,0,0),t=new l;this.normal.equals(n)||(this.normal.copy(n),this._helper.lookAt(n)),this.origin.copy(t),this._helper.position.copy(t),this._helper.updateMatrix()}toggleControls(n){if(n){if(this._controlsActive)return;this._controls.addEventListener("change",this.update),this._controls.addEventListener("dragging-changed",this.changeDrag)}else this._controls.removeEventListener("change",this.update),this._controls.removeEventListener("dragging-changed",this.changeDrag);this._controlsActive=n}newTransformControls(){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");const n=this.world.camera.three,t=this.world.renderer.three.domElement,i=new ht(n,t);return this.initializeControls(i),this.world.scene.three.add(i),i}initializeControls(n){n.attach(this._helper),n.showX=!1,n.showY=!1,n.setSpace("local"),this.createArrowBoundingBox(),n.children[0].children[0].add(this._arrowBoundBox)}createArrowBoundingBox(){this._arrowBoundBox.geometry=new g(.18,.18,1.2),this._arrowBoundBox.material=this._hiddenMaterial,this._arrowBoundBox.rotateX(Math.PI/2),this._arrowBoundBox.updateMatrix(),this._arrowBoundBox.geometry.applyMatrix4(this._arrowBoundBox.matrix)}notifyDraggingChanged(n){n.value?this.onDraggingStarted.trigger():this.onDraggingEnded.trigger()}preventCameraMovement(){this.world.camera.enabled=this._visible}newHelper(){const n=new le;return n.lookAt(this.normal),n.position.copy(this.origin),this._planeMesh.position.z+=.01,n.add(this._planeMesh),this.world.scene.three.add(n),n}static newPlaneMesh(n,t){const i=new Ae(1),s=new o(i,t);return s.scale.set(n,n,n),s}}const V=class V extends st{constructor(t){super(t);r(this,"onAfterCreate",new b);r(this,"onAfterDelete",new b);r(this,"onBeforeDrag",new b);r(this,"onAfterDrag",new b);r(this,"onBeforeCreate",new b);r(this,"onBeforeCancel",new b);r(this,"onAfterCancel",new b);r(this,"onBeforeDelete",new b);r(this,"onDisposed",new b);r(this,"orthogonalY",!1);r(this,"toleranceOrthogonalY",.7);r(this,"list",[]);r(this,"PlaneType");r(this,"_material",new he({color:16776960,side:De,transparent:!0,opacity:.2}));r(this,"_size",5);r(this,"_enabled",!1);r(this,"_visible",!1);r(this,"_onStartDragging",()=>{this.onBeforeDrag.trigger()});r(this,"_onEndDragging",()=>{this.onAfterDrag.trigger()});this.components.add(V.uuid,this),this.PlaneType=ue}get enabled(){return this._enabled}set enabled(t){this._enabled=t;for(const i of this.list)i.enabled=t;this.updateMaterialsAndPlanes()}get visible(){return this._visible}set visible(t){this._visible=t;for(const i of this.list)i.visible=t}get material(){return this._material}set material(t){this._material=t;for(const i of this.list)i.planeMaterial=t}get size(){return this._size}set size(t){this._size=t;for(const i of this.list)i.size=t}endCreation(){}cancelCreation(){}dispose(){this._enabled=!1;for(const t of this.list)t.dispose();this.list.length=0,this._material.dispose(),this.onBeforeCreate.reset(),this.onBeforeCancel.reset(),this.onBeforeDelete.reset(),this.onBeforeDrag.reset(),this.onAfterCreate.reset(),this.onAfterCancel.reset(),this.onAfterDelete.reset(),this.onAfterDrag.reset(),this.onDisposed.trigger(V.uuid),this.onDisposed.reset()}create(t){if(!this.enabled)return;const a=this.components.get(_e).get(t).castRay();a&&this.createPlaneFromIntersection(t,a)}createFromNormalAndCoplanarPoint(t,i,s){const a=this.newPlane(t,s,i);return this.updateMaterialsAndPlanes(),a}delete(t,i){this.enabled&&(i||(i=this.pickPlane(t)),i&&this.deletePlane(i))}deleteAll(){for(;this.list.length>0;){const t=this.list[0];this.delete(t.world,t)}}deletePlane(t){const i=this.list.indexOf(t);if(i!==-1){if(this.list.splice(i,1),!t.world.renderer)throw new Error("Renderer not found for this plane's world!");t.world.renderer.setPlane(!1,t.three),t.dispose(),this.updateMaterialsAndPlanes(),this.onAfterDelete.trigger(t)}}pickPlane(t){const s=this.components.get(_e).get(t),a=this.getAllPlaneMeshes(),e=s.castRay(a);if(e){const c=e.object;return this.list.find(m=>m.meshes.includes(c))}}getAllPlaneMeshes(){const t=[];for(const i of this.list)t.push(...i.meshes);return t}createPlaneFromIntersection(t,i){var m;if(!t.renderer)throw new Error("The given world must have a renderer!");const s=i.point.distanceTo(new l(0,0,0)),a=(m=i.face)==null?void 0:m.normal;if(!s||!a)return;const e=this.getWorldNormal(i,a),c=this.newPlane(t,i.point,e.negate());t.renderer.setPlane(!0,c.three),this.updateMaterialsAndPlanes()}getWorldNormal(t,i){const s=t.object;let a=t.object.matrixWorld.clone();if(s instanceof $e&&t.instanceId!==void 0){const v=new me;s.getMatrixAt(t.instanceId,v),a=v.multiply(a)}const c=new Ke().getNormalMatrix(a),m=i.clone().applyMatrix3(c).normalize();return this.normalizePlaneDirectionY(m),m}normalizePlaneDirectionY(t){this.orthogonalY&&(t.y>this.toleranceOrthogonalY&&(t.x=0,t.y=1,t.z=0),t.y<-this.toleranceOrthogonalY&&(t.x=0,t.y=-1,t.z=0))}newPlane(t,i,s){const a=this.newPlaneInstance(t,i,s);return a.onDraggingStarted.add(this._onStartDragging),a.onDraggingEnded.add(this._onEndDragging),this.list.push(a),this.onAfterCreate.trigger(a),a}newPlaneInstance(t,i,s){return new this.PlaneType(this.components,t,i,s,this._material)}updateMaterialsAndPlanes(){const t=this.components.get(Ye);for(const[i,s]of t.list){if(!s.renderer)continue;s.renderer.updateClippingPlanes();const{clippingPlanes:a}=s.renderer;for(const e of s.meshes)if(Array.isArray(e.material))for(const c of e.material)c.clippingPlanes=a;else e.material.clippingPlanes=a}}};r(V,"uuid","66290bc5-18c4-4cd1-9379-2e17a0617611");let de=V;const Qe=document.getElementById("container"),F=new ot,gt=F.get(Ye),x=gt.create();x.scene=new at(F);x.renderer=new rt(F,Qe);x.camera=new lt(F);F.init();x.camera.controls.setLookAt(10,10,10,0,0,0);x.scene.setup();const yt=new u(3,3,3),_t=new et({color:"#6528D7"}),R=new o(yt,_t);R.position.set(0,1.5,0);x.scene.three.add(R);x.meshes.add(R);const A=new de(F);A.enabled=!0;Qe.ondblclick=()=>A.create(x);window.onkeydown=h=>{(h.code==="Delete"||h.code==="Backspace")&&A.delete(x)};const J=new it;J.showPanel(2);document.body.append(J.dom);J.dom.style.left="0px";x.renderer.onBeforeUpdate.add(()=>J.begin());x.renderer.onAfterUpdate.add(()=>J.end());const Xe=new nt,Ce=Xe.addFolder("Shortcuts"),Te={"Create clipping plane":"Double click","Delete clipping plane":"Delete"};Ce.add(Te,"Create clipping plane");Ce.add(Te,"Delete clipping plane");const H=Xe.addFolder("Actions");H.add(A,"enabled").name("Toggle clipping planes enabled");H.add(A,"visible").name("Toggle clipping planes visible");const bt={value:0},Ie=new tt;H.addColor(bt,"value").name("Plane color").onChange(h=>{Ie.setHex(h),"color"in A.material&&(A.material.color=Ie)});H.add(A,"size").name("Plane Size").min(0).max(15);H.add(A.material,"opacity").name("Plane Opacity").min(0).max(1);const ze={"Delete all planes":()=>{A.deleteAll()},"Rotate cube":()=>{R.rotation.x=2*Math.PI*Math.random(),R.rotation.y=2*Math.PI*Math.random(),R.rotation.z=2*Math.PI*Math.random()}};H.add(ze,"Rotate cube");H.add(ze,"Delete all planes");
