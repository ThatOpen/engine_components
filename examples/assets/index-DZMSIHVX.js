var Q=Object.defineProperty;var b=(u,e,t)=>e in u?Q(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var a=(u,e,t)=>(b(u,typeof e!="symbol"?e+"":e,t),t);import{Y as x}from"./index-lvtjgYNN.js";import{d as z,F as f,M as p}from"./index-BPZgAaC0.js";class R{constructor(e,t){a(this,"description");a(this,"_components");a(this,"_queries",[]);a(this,"_aggregation","exclusive");a(this,"result",null);a(this,"cache",!0);a(this,"serializeQueryParameters",e=>{var s;return{categories:(s=e.categories)==null?void 0:s.map(i=>i.source),attributes:e.attributes?{aggregation:e.attributes.aggregation,queries:e.attributes.queries.map(this.serializeAttributeQuery)}:void 0,relation:e.relation?{name:e.relation.name,query:e.relation.query?this.serializeQueryParameters(e.relation.query):void 0}:void 0}});a(this,"deserializeQueryParameters",e=>{var s;return{categories:(s=e.categories)==null?void 0:s.map(i=>new RegExp(i)),attributes:e.attributes?{aggregation:e.attributes.aggregation,queries:e.attributes.queries.map(this.deserializeAttributeQuery)}:void 0,relation:e.relation?{name:e.relation.name,query:e.relation.query?this.deserializeQueryParameters(e.relation.query):void 0}:void 0}});this._components=e,this.queries=t}set queries(e){this._queries=e,this.clearCache()}get queries(){return this._queries}set aggregation(e){e!==this._aggregation&&this.clearCache(),this._aggregation=e}get aggregation(){return this._aggregation}async test(e){const{modelIds:t,force:s}={force:!1,...e};if(this.result&&!s)return this.result;const n=await this._components.get(m).getItems(this.queries,{modelIds:t,aggregation:this.aggregation});return this.cache&&(this.result=n),n}clearCache(){this.result=null}serializeAttributeQuery(e){let t;return Array.isArray(e.value)?t=e.value.map(i=>i.source):e.value instanceof RegExp?t=e.value.source:t=e.value,{name:e.name.source,value:t,type:e.type instanceof RegExp?e.type.source:e.type,negate:e.negate,itemIds:e.itemIds}}toJSON(){return{name:"Finder Query",description:this.description,queries:this.queries.map(this.serializeQueryParameters),aggregation:this.aggregation,cache:this.cache}}deserializeAttributeQuery(e){let t;return Array.isArray(e.value)?t=e.value.map(i=>new RegExp(i)):typeof e.value=="string"?t=new RegExp(e.value):t=e.value,{name:new RegExp(e.name),value:t,type:e.type?new RegExp(e.type):void 0,negate:e.negate,itemIds:e.itemIds}}fromJSON(e){return this.description=e.description,this.aggregation=e.aggregation,this.cache=e.cache,this.queries=e.queries.map(this.deserializeQueryParameters),this}}const d=class d extends z{constructor(t){super(t);a(this,"enabled",!0);a(this,"list",new x);t.add(d.uuid,this)}async getItems(t,s){const{modelIds:i}=s??{},n=(s==null?void 0:s.aggregation)??"exclusive",o=this.components.get(f),c=await Promise.all(t.map(async r=>{const h={};return await Promise.all(Array.from(o.list).map(async([l,y])=>{if(i&&!i.some(w=>w.test(l)))return;const v=await y.getItemsByQuery(r);h[l]=new Set(v)})),h}));return n==="inclusive"?p.join(c):p.intersect(c)}create(t,s){const i=new R(this.components,s);return this.list.set(t,i),i}async addFromCategories(t){const s=new Set,i=this.components.get(f);for(const[n,o]of i.list){if(t&&!t.some(r=>r.test(n)))continue;const c=(await o.getItemsWithGeometryCategories()).filter(r=>r!==null),g=new Set(c);for(const r of g)this.list.has(r)||(this.create(r,[{categories:[new RegExp(`^${r}$`)]}]),s.add(r))}return[...s]}import(t){const{data:s}=t,i=[];if(!s)return i;for(const n of s){const{name:o,description:c,queries:g,aggregation:r,cache:h}=n,l=this.create(o,[]);l.fromJSON({description:c,queries:g,aggregation:r,cache:h}),i.push(l)}return i}export(){const t=[];for(const[s,i]of this.list.entries()){const o={...i.toJSON(),name:s};t.push(o)}return{data:t}}};a(d,"uuid","0da7ad77-f734-42ca-942f-a074adfd1e3a");let m=d;export{m as I};
