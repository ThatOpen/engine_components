var x=Object.defineProperty;var M=(i,a,e)=>a in i?x(i,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[a]=e;var c=(i,a,e)=>(M(i,typeof a!="symbol"?a+"":a,e),e);import{b as p,d as P,o as I,M as A,V as w,f as v,u as D,a as W}from"./index-BVinSk0X.js";import{c as z,E as B,b as E,C as R,W as T,S as j,O as U,F as V}from"./graphic-vertex-picker-DIM7gQA5.js";import{P as q}from"./index-BLwIRjEQ.js";const b=class b extends z{constructor(e){super(e);c(this,"onDisposed",new B);c(this,"enabled",!0);c(this,"threshold",50);c(this,"autoCluster",!0);c(this,"list",new Map);c(this,"clusterLabels",new Set);c(this,"currentKeys",new Set);c(this,"_color","white");c(this,"_markerKey",0);c(this,"_clusterKey",0);c(this,"_worldEvents",new Map);c(this,"_setupWorlds",new Set);c(this,"clusterElementFactory",()=>{const e=document.createElement("div");return e.style.color="#000000",e.style.background="#FFFFFF",e.style.fontSize="1.2rem",e.style.fontWeight="500",e.style.borderRadius="50%",e.style.padding="5px 11px",e.style.textAlign="center",e.addEventListener("pointerover",()=>{e.style.background="#BCF124"}),e.addEventListener("pointerout",()=>{e.style.background="#FFFFFF"}),e});e.add(b.uuid,this)}get color(){return this._color}set color(e){this._color=e;for(const[s,t]of this.list)for(const[r,n]of t)n.label.three.element.style.color=e}create(e,s,t,r=!1){this.setupEvents(e,!0);const n=this._markerKey.toString(),o=this.getWorldMarkerList(e);if(o.has(n))return null;const l=document.createElement("span");l.append(s);const u=new E(e,l);return u.three.position.copy(t),o.set(n,{key:n,label:u,merged:!1,static:r}),this._markerKey++,n}delete(e){for(const[s,t]of this.list){const r=t.get(e);r&&r.label.dispose(),t.delete(e)}}getWorldMarkerList(e){return this.list.has(e.uuid)||this.list.set(e.uuid,new Map),this.list.get(e.uuid)}dispose(e){for(const[s,t]of this.list){const r=[...t.keys()];for(const n of r){const o=t.get(n);e&&o.type!==e||(o.label.dispose(),t.delete(n))}}if(!e){this.list.clear(),this._markerKey=0;for(const s of this.clusterLabels)s.label.dispose();this.clusterLabels.clear(),this._clusterKey=0,this.currentKeys.clear()}this.onDisposed.trigger()}setupEvents(e,s){if(s&&this._setupWorlds.has(e.uuid)||!e.camera.hasCameraControls())return;const t=this.getWorldEvent(e);e.camera.controls.removeEventListener("sleep",t),e.camera.controls.removeEventListener("rest",t),s&&(e.camera.controls.addEventListener("sleep",t),e.camera.controls.addEventListener("rest",t))}cluster(e){if(!this.autoCluster)return;this.resetMarkers();const s=this.list.get(e.uuid);if(s){for(const[t,r]of s)if(!r.merged&&!r.static){this.currentKeys.clear();for(const[n,o]of s)o.static||r.key!==o.key&&!o.merged&&this.distance(r.label,o.label)<this.threshold&&(this.currentKeys.add(o.key),o.merged=!0);if(this.currentKeys.size>0){this.currentKeys.add(r.key),r.merged=!0;const n=Array.from(this.currentKeys),o=this.getAveragePositionFromLabels(n),l=new E(r.label.world,this.createClusterElement(this._clusterKey.toString())),{element:u}=l.three;u.firstChild.textContent=n.length.toString(),l.three.position.copy(o),this.clusterLabels.add({key:this._clusterKey.toString(),markerKeys:n,label:l}),this._clusterKey++}}this.removeMergeMarkers(e)}}getWorldEvent(e){if(!this._worldEvents.has(e.uuid)){const s=()=>{this.cluster(e)};this._worldEvents.set(e.uuid,s)}return this._worldEvents.get(e.uuid)}resetMarkers(){for(const[e,s]of this.list)for(const[t,r]of s)r.merged=!1;for(const e of this.clusterLabels)e.label.dispose();this.clusterLabels.clear(),this._clusterKey=0}removeMergeMarkers(e){const s=this.list.get(e.uuid);if(s){for(const[t,r]of s)r.merged?r.label.dispose():r.label.world.scene.three.add(r.label.three);for(const t of this.clusterLabels)if(t.markerKeys.length===1){for(const[r,n]of this.list){const o=n.get(t.markerKeys[0]);if(!o)continue;o.label.world.scene.three.add(o.label.three),o.merged=!1}t.label.dispose(),this.clusterLabels.delete(t)}}}getAveragePositionFromLabels(e){const s=e.map(t=>{for(const[r,n]of this.list){const o=n.get(t);if(o)return o.label.three.position}return new p});return s.reduce((t,r)=>t.add(r),new p).divideScalar(s.length)}createClusterElement(e){const s=this.clusterElementFactory();s.textContent=e;const t=document.createElement("span");return t.append(s),t.style.pointerEvents="auto",t.style.cursor="pointer",t.addEventListener("pointerdown",()=>{this.navigateToCluster(e)}),t}getScreenPosition(e){const s=new p;if(!e.world.renderer)throw new Error("Renderer not found!");const t=e.three.position.clone();t.project(e.world.camera.three);const r=e.world.renderer.getSize();return s.x=t.x*r.x/2+r.x/2,s.y=-(t.y*r.y/2)+r.y/2,s}distance(e,s){const t=this.getScreenPosition(e),r=this.getScreenPosition(s),n=t.x-r.x,o=t.y-r.y,l=Math.sqrt(n*n+o*o)*.5;return l===0?this.threshold+1:l}navigateToCluster(e){const s=[],t=Array.from(this.clusterLabels).find(y=>y.key===e);if(!t)return;const r=t.label.world.camera;if(!r.hasCameraControls()){console.warn("Zoom to clusters only supported with Camera Controls!");return}for(const y of t.markerKeys)for(const[N,C]of this.list){const _=C.get(y);if(_){const{x:S,y:K,z:F}=_.label.three.position;s.push(S,K,F)}}t.label.dispose(),this.clusterLabels.delete(t);const n=new P,o=new Float32Array(s),l=new I(o,3);n.setAttribute("position",l);const u=new A(n);u.geometry.computeBoundingSphere(),u.geometry.boundingSphere&&r.controls.fitToSphere(u,!0),n.dispose(),u.clear(),s.length=0}};c(b,"uuid","4079eb91-79b0-4ede-bcf2-15b837129236");let k=b;const h=new R,G=h.get(T),d=G.create();d.scene=new j(h);d.scene.setup();d.scene.three.background=null;const O=document.getElementById("container");d.renderer=new q(h,O);d.camera=new U(h);await d.camera.controls.setLookAt(68,23,-8.5,21.5,-5.5,23);h.init();const Z="https://thatopen.github.io/engine_fragment/resources/worker.mjs",m=h.get(V);m.init(Z);d.camera.controls.addEventListener("rest",()=>m.core.update(!0));d.onCameraChanged.add(i=>{for(const[,a]of m.list)a.useCamera(i.three);m.core.update(!0)});m.list.onItemSet.add(({value:i})=>{i.useCamera(d.camera.three),d.scene.three.add(i.object),m.core.update(!0)});const $=["https://thatopen.github.io/engine_components/resources/frags/school_arq.frag"];await Promise.all($.map(async i=>{var t;const a=(t=i.split("/").pop())==null?void 0:t.split(".").shift();if(!a)return null;const s=await(await fetch(i)).arrayBuffer();return m.core.load(s,{modelId:a})}));const L=h.get(k);L.threshold=10;for(let i=0;i<20;i++){const a=Math.random()*100-50,e=Math.random()*10,s=Math.random()*100-50,t=w.create(()=>v`<bim-label style="font-size: 20px">ðŸš€</bim-label>`);L.create(d,t,new p(a,e,s))}D.init();const g=w.create(()=>v`
    <bim-panel active label="Marker Tutorial" class="options-menu">
    </bim-panel>
  `);document.body.append(g);const H=w.create(()=>v`
      <bim-button class="phone-menu-toggler" icon="solar:settings-bold"
        @click="${()=>{g.classList.contains("options-menu-visible")?g.classList.remove("options-menu-visible"):g.classList.add("options-menu-visible")}}">
      </bim-button>
    `);document.body.append(H);const f=new W;f.showPanel(2);document.body.append(f.dom);f.dom.style.left="0px";f.dom.style.zIndex="unset";d.renderer.onBeforeUpdate.add(()=>f.begin());d.renderer.onAfterUpdate.add(()=>f.end());
