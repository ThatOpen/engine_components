var K=Object.defineProperty;var M=(a,c,e)=>c in a?K(a,c,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[c]=e;var i=(a,c,e)=>(M(a,typeof c!="symbol"?c+"":c,e),e);import{b as g,e as P,p as A,c as D,V as v,f as w,u as I,a as B}from"./index-DcyXhVxI.js";import{c as T,E as W,b as _,C as z,W as R,S as U,O as j,F as V}from"./graphic-vertex-picker-ClbEbQzL.js";import{P as q}from"./index-CoP0RxlY.js";const f=class f extends T{constructor(e){super(e);i(this,"onDisposed",new W);i(this,"enabled",!0);i(this,"threshold",50);i(this,"autoCluster",!0);i(this,"clusterElementStyles",{...f.DEFAULT_CLUSTER_STYLES});i(this,"list",new Map);i(this,"clusterLabels",new Set);i(this,"currentKeys",new Set);i(this,"_color","white");i(this,"_markerKey",0);i(this,"_clusterKey",0);i(this,"_worldEvents",new Map);i(this,"_setupWorlds",new Set);i(this,"clusterElementFactory",()=>{const e=document.createElement("div");return e.style.color="#000000",e.style.background="#FFFFFF",e.style.fontSize="1.2rem",e.style.fontWeight="500",e.style.borderRadius="50%",e.style.padding="5px 11px",e.style.textAlign="center",e.addEventListener("pointerover",()=>{e.style.background=this.clusterElementStyles.hoverBackgroundColor||"#BCF124"}),e.addEventListener("pointerout",()=>{e.style.background=this.clusterElementStyles.backgroundColor||"#FFFFFF"}),e});e.add(f.uuid,this)}get color(){return this._color}set color(e){this._color=e;for(const[s,t]of this.list)for(const[r,n]of t)n.label.three.element.style.color=e}create(e,s,t,r=!1){this.setupEvents(e,!0);const n=this._markerKey.toString(),o=this.getWorldMarkerList(e);if(o.has(n))return null;const l=document.createElement("span");l.append(s);const u=new _(e,l);return u.three.position.copy(t),o.set(n,{key:n,label:u,merged:!1,static:r}),this._markerKey++,n}delete(e){for(const[s,t]of this.list){const r=t.get(e);r&&r.label.dispose(),t.delete(e)}}getWorldMarkerList(e){return this.list.has(e.uuid)||this.list.set(e.uuid,new Map),this.list.get(e.uuid)}dispose(e){for(const[s,t]of this.list){const r=[...t.keys()];for(const n of r){const o=t.get(n);e&&o.type!==e||(o.label.dispose(),t.delete(n))}}if(!e){this.list.clear(),this._markerKey=0;for(const s of this.clusterLabels)s.label.dispose();this.clusterLabels.clear(),this._clusterKey=0,this.currentKeys.clear()}this.onDisposed.trigger()}setupEvents(e,s){if(s&&this._setupWorlds.has(e.uuid)||!e.camera.hasCameraControls())return;const t=this.getWorldEvent(e);e.camera.controls.removeEventListener("sleep",t),e.camera.controls.removeEventListener("rest",t),s&&(e.camera.controls.addEventListener("sleep",t),e.camera.controls.addEventListener("rest",t))}cluster(e){if(!this.autoCluster)return;this.resetMarkers();const s=this.list.get(e.uuid);if(s){for(const[t,r]of s)if(!r.merged&&!r.static){this.currentKeys.clear();for(const[n,o]of s)o.static||r.key!==o.key&&!o.merged&&this.distance(r.label,o.label)<this.threshold&&(this.currentKeys.add(o.key),o.merged=!0);if(this.currentKeys.size>0){this.currentKeys.add(r.key),r.merged=!0;const n=Array.from(this.currentKeys),o=this.getAveragePositionFromLabels(n),l=new _(r.label.world,this.createClusterElement(this._clusterKey.toString())),{element:u}=l.three;u.firstChild.textContent=n.length.toString(),l.three.position.copy(o),this.clusterLabels.add({key:this._clusterKey.toString(),markerKeys:n,label:l}),this._clusterKey++}}this.removeMergeMarkers(e)}}getWorldEvent(e){if(!this._worldEvents.has(e.uuid)){const s=()=>{this.cluster(e)};this._worldEvents.set(e.uuid,s)}return this._worldEvents.get(e.uuid)}resetMarkers(){for(const[e,s]of this.list)for(const[t,r]of s)r.merged=!1;for(const e of this.clusterLabels)e.label.dispose();this.clusterLabels.clear(),this._clusterKey=0}removeMergeMarkers(e){const s=this.list.get(e.uuid);if(s){for(const[t,r]of s)r.merged?r.label.dispose():r.label.world.scene.three.add(r.label.three);for(const t of this.clusterLabels)if(t.markerKeys.length===1){for(const[r,n]of this.list){const o=n.get(t.markerKeys[0]);if(!o)continue;o.label.world.scene.three.add(o.label.three),o.merged=!1}t.label.dispose(),this.clusterLabels.delete(t)}}}getAveragePositionFromLabels(e){const s=e.map(t=>{for(const[r,n]of this.list){const o=n.get(t);if(o)return o.label.three.position}return new g});return s.reduce((t,r)=>t.add(r),new g).divideScalar(s.length)}createClusterElement(e){const s=this.clusterElementFactory();s.textContent=e;const t=document.createElement("span");return t.append(s),t.style.pointerEvents="auto",t.style.cursor="pointer",t.addEventListener("pointerdown",()=>{this.navigateToCluster(e)}),t}getScreenPosition(e){const s=new g;if(!e.world.renderer)throw new Error("Renderer not found!");const t=e.three.position.clone();t.project(e.world.camera.three);const r=e.world.renderer.getSize();return s.x=t.x*r.x/2+r.x/2,s.y=-(t.y*r.y/2)+r.y/2,s}distance(e,s){const t=this.getScreenPosition(e),r=this.getScreenPosition(s),n=t.x-r.x,o=t.y-r.y,l=Math.sqrt(n*n+o*o)*.5;return l===0?this.threshold+1:l}navigateToCluster(e){const s=[],t=Array.from(this.clusterLabels).find(y=>y.key===e);if(!t)return;const r=t.label.world.camera;if(!r.hasCameraControls()){console.warn("Zoom to clusters only supported with Camera Controls!");return}for(const y of t.markerKeys)for(const[J,S]of this.list){const E=S.get(y);if(E){const{x:C,y:F,z:x}=E.label.three.position;s.push(C,F,x)}}t.label.dispose(),this.clusterLabels.delete(t);const n=new P,o=new Float32Array(s),l=new A(o,3);n.setAttribute("position",l);const u=new D(n);u.geometry.computeBoundingSphere(),u.geometry.boundingSphere&&r.controls.fitToSphere(u,!0),n.dispose(),u.clear(),s.length=0}};i(f,"uuid","4079eb91-79b0-4ede-bcf2-15b837129236"),i(f,"DEFAULT_CLUSTER_STYLES",{backgroundColor:"#FFFFFF",textColor:"#000000",fontSize:"1.2rem",fontWeight:"500",borderRadius:"50%",padding:"5px 11px",textAlign:"center",cursor:"pointer",hoverBackgroundColor:"#BCF124",transition:void 0});let k=f;const h=new z,G=h.get(R),d=G.create();d.scene=new U(h);d.scene.setup();d.scene.three.background=null;const O=document.getElementById("container");d.renderer=new q(h,O);d.camera=new j(h);await d.camera.controls.setLookAt(68,23,-8.5,21.5,-5.5,23);h.init();const Y="https://thatopen.github.io/engine_fragment/resources/worker.mjs",m=h.get(V);m.init(Y);d.camera.controls.addEventListener("rest",()=>m.core.update(!0));d.onCameraChanged.add(a=>{for(const[,c]of m.list)c.useCamera(a.three);m.core.update(!0)});m.list.onItemSet.add(({value:a})=>{a.useCamera(d.camera.three),d.scene.three.add(a.object),m.core.update(!0)});const Z=["https://thatopen.github.io/engine_components/resources/frags/school_arq.frag"];await Promise.all(Z.map(async a=>{var t;const c=(t=a.split("/").pop())==null?void 0:t.split(".").shift();if(!c)return null;const s=await(await fetch(a)).arrayBuffer();return m.core.load(s,{modelId:c})}));const L=h.get(k);L.threshold=10;for(let a=0;a<20;a++){const c=Math.random()*100-50,e=Math.random()*10,s=Math.random()*100-50,t=v.create(()=>w`<bim-label style="font-size: 20px">ðŸš€</bim-label>`);L.create(d,t,new g(c,e,s))}I.init();const b=v.create(()=>w`
    <bim-panel active label="Marker Tutorial" class="options-menu">
    </bim-panel>
  `);document.body.append(b);const $=v.create(()=>w`
      <bim-button class="phone-menu-toggler" icon="solar:settings-bold"
        @click="${()=>{b.classList.contains("options-menu-visible")?b.classList.remove("options-menu-visible"):b.classList.add("options-menu-visible")}}">
      </bim-button>
    `);document.body.append($);const p=new B;p.showPanel(2);document.body.append(p.dom);p.dom.style.left="0px";p.dom.style.zIndex="unset";d.renderer.onBeforeUpdate.add(()=>p.begin());d.renderer.onAfterUpdate.add(()=>p.end());
