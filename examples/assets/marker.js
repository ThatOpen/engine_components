var F=Object.defineProperty;var M=(i,a,e)=>a in i?F(i,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[a]=e;var c=(i,a,e)=>(M(i,typeof a!="symbol"?a+"":a,e),e);import{V as p,d as P,l as I,M as A,R as w,m as v,a as D,b as W}from"./index-CZukAoYd.js";import{b as z,E as B,a as L,C as R,W as T,S as j,O as U,F as q}from"./graphic-vertex-picker-DJhsmSZm.js";import{P as G}from"./index-DaXsRl3f.js";const b=class b extends z{constructor(e){super(e);c(this,"onDisposed",new B);c(this,"enabled",!0);c(this,"threshold",50);c(this,"autoCluster",!0);c(this,"list",new Map);c(this,"clusterLabels",new Set);c(this,"currentKeys",new Set);c(this,"_color","white");c(this,"_markerKey",0);c(this,"_clusterKey",0);c(this,"_worldEvents",new Map);c(this,"_setupWorlds",new Set);e.add(b.uuid,this)}get color(){return this._color}set color(e){this._color=e;for(const[t,s]of this.list)for(const[r,n]of s)n.label.three.element.style.color=e}create(e,t,s,r=!1){this.setupEvents(e,!0);const n=this._markerKey.toString(),o=this.getWorldMarkerList(e);if(o.has(n))return null;const l=document.createElement("span");l.append(t);const u=new L(e,l);return u.three.position.copy(s),o.set(n,{key:n,label:u,merged:!1,static:r}),this._markerKey++,n}delete(e){for(const[t,s]of this.list){const r=s.get(e);r&&r.label.dispose(),s.delete(e)}}getWorldMarkerList(e){return this.list.has(e.uuid)||this.list.set(e.uuid,new Map),this.list.get(e.uuid)}dispose(e){for(const[t,s]of this.list){const r=[...s.keys()];for(const n of r){const o=s.get(n);e&&o.type!==e||(o.label.dispose(),s.delete(n))}}if(!e){this.list.clear(),this._markerKey=0;for(const t of this.clusterLabels)t.label.dispose();this.clusterLabels.clear(),this._clusterKey=0,this.currentKeys.clear()}this.onDisposed.trigger()}setupEvents(e,t){if(t&&this._setupWorlds.has(e.uuid)||!e.camera.hasCameraControls())return;const s=this.getWorldEvent(e);e.camera.controls.removeEventListener("sleep",s),e.camera.controls.removeEventListener("rest",s),t&&(e.camera.controls.addEventListener("sleep",s),e.camera.controls.addEventListener("rest",s))}cluster(e){if(!this.autoCluster)return;this.resetMarkers();const t=this.list.get(e.uuid);if(t){for(const[s,r]of t)if(!r.merged&&!r.static){this.currentKeys.clear();for(const[n,o]of t)o.static||r.key!==o.key&&!o.merged&&this.distance(r.label,o.label)<this.threshold&&(this.currentKeys.add(o.key),o.merged=!0);if(this.currentKeys.size>0){this.currentKeys.add(r.key),r.merged=!0;const n=Array.from(this.currentKeys),o=this.getAveragePositionFromLabels(n),l=new L(r.label.world,this.createClusterElement(this._clusterKey.toString())),{element:u}=l.three;u.textContent=n.length.toString(),l.three.position.copy(o),this.clusterLabels.add({key:this._clusterKey.toString(),markerKeys:n,label:l}),this._clusterKey++}}this.removeMergeMarkers(e)}}getWorldEvent(e){if(!this._worldEvents.has(e.uuid)){const t=()=>{this.cluster(e)};this._worldEvents.set(e.uuid,t)}return this._worldEvents.get(e.uuid)}resetMarkers(){for(const[e,t]of this.list)for(const[s,r]of t)r.merged=!1;for(const e of this.clusterLabels)e.label.dispose();this.clusterLabels.clear(),this._clusterKey=0}removeMergeMarkers(e){const t=this.list.get(e.uuid);if(t){for(const[s,r]of t)r.merged?r.label.dispose():r.label.world.scene.three.add(r.label.three);for(const s of this.clusterLabels)if(s.markerKeys.length===1){for(const[r,n]of this.list){const o=n.get(s.markerKeys[0]);if(!o)continue;o.label.world.scene.three.add(o.label.three),o.merged=!1}s.label.dispose(),this.clusterLabels.delete(s)}}}getAveragePositionFromLabels(e){const t=e.map(s=>{for(const[r,n]of this.list){const o=n.get(s);if(o)return o.label.three.position}return new p});return t.reduce((s,r)=>s.add(r),new p).divideScalar(t.length)}createClusterElement(e){const t=document.createElement("div");return t.textContent=e,t.style.color="#000000",t.style.background="#FFFFFF",t.style.fontSize="1.2rem",t.style.fontWeight="500",t.style.pointerEvents="auto",t.style.borderRadius="50%",t.style.padding="5px 11px",t.style.textAlign="center",t.style.cursor="pointer",t.addEventListener("pointerdown",()=>{this.navigateToCluster(e)}),t.addEventListener("pointerover",()=>{t.style.background="#BCF124"}),t.addEventListener("pointerout",()=>{t.style.background="#FFFFFF"}),t}getScreenPosition(e){const t=new p;if(!e.world.renderer)throw new Error("Renderer not found!");const s=e.three.position.clone();s.project(e.world.camera.three);const r=e.world.renderer.getSize();return t.x=s.x*r.x/2+r.x/2,t.y=-(s.y*r.y/2)+r.y/2,t}distance(e,t){const s=this.getScreenPosition(e),r=this.getScreenPosition(t),n=s.x-r.x,o=s.y-r.y,l=Math.sqrt(n*n+o*o)*.5;return l===0?this.threshold+1:l}navigateToCluster(e){const t=[],s=Array.from(this.clusterLabels).find(y=>y.key===e);if(!s)return;const r=s.label.world.camera;if(!r.hasCameraControls()){console.warn("Zoom to clusters only supported with Camera Controls!");return}for(const y of s.markerKeys)for(const[N,C]of this.list){const _=C.get(y);if(_){const{x:S,y:K,z:x}=_.label.three.position;t.push(S,K,x)}}s.label.dispose(),this.clusterLabels.delete(s);const n=new P,o=new Float32Array(t),l=new I(o,3);n.setAttribute("position",l);const u=new A(n);u.geometry.computeBoundingSphere(),u.geometry.boundingSphere&&r.controls.fitToSphere(u,!0),n.dispose(),u.clear(),t.length=0}};c(b,"uuid","4079eb91-79b0-4ede-bcf2-15b837129236");let k=b;const h=new R,O=h.get(T),d=O.create();d.scene=new j(h);d.scene.setup();d.scene.three.background=null;const V=document.getElementById("container");d.renderer=new G(h,V);d.camera=new U(h);await d.camera.controls.setLookAt(68,23,-8.5,21.5,-5.5,23);h.init();const Z="https://thatopen.github.io/engine_fragment/resources/worker.mjs",m=h.get(q);m.init(Z);d.camera.controls.addEventListener("rest",()=>m.core.update(!0));d.onCameraChanged.add(i=>{for(const[,a]of m.list)a.useCamera(i.three);m.core.update(!0)});m.list.onItemSet.add(({value:i})=>{i.useCamera(d.camera.three),d.scene.three.add(i.object),m.core.update(!0)});const $=["https://thatopen.github.io/engine_components/resources/frags/school_arq.frag"];await Promise.all($.map(async i=>{var s;const a=(s=i.split("/").pop())==null?void 0:s.split(".").shift();if(!a)return null;const t=await(await fetch(i)).arrayBuffer();return m.core.load(t,{modelId:a})}));const E=h.get(k);E.threshold=10;for(let i=0;i<20;i++){const a=Math.random()*100-50,e=Math.random()*10,t=Math.random()*100-50,s=w.create(()=>v`<bim-label style="font-size: 20px">ðŸš€</bim-label>`);E.create(d,s,new p(a,e,t))}D.init();const g=w.create(()=>v`
    <bim-panel active label="Marker Tutorial" class="options-menu">
    </bim-panel>
  `);document.body.append(g);const H=w.create(()=>v`
      <bim-button class="phone-menu-toggler" icon="solar:settings-bold"
        @click="${()=>{g.classList.contains("options-menu-visible")?g.classList.remove("options-menu-visible"):g.classList.add("options-menu-visible")}}">
      </bim-button>
    `);document.body.append(H);const f=new W;f.showPanel(2);document.body.append(f.dom);f.dom.style.left="0px";f.dom.style.zIndex="unset";d.renderer.onBeforeUpdate.add(()=>f.begin());d.renderer.onAfterUpdate.add(()=>f.end());
