var To=Object.defineProperty;var Eo=(a,t,e)=>t in a?To(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var Pt=(a,t,e)=>(Eo(a,typeof t!="symbol"?t+"":t,e),e);import{b as V,h as Wt,P as pe,L as le,j as Ft,ah as en,x as Ot,an as vs,S as oi,Y as Nt,W as we,at as Cr,O as sn,z as So,C as zt,w as Ao,e as ai,c as et,ak as Oo,m as Os,D as ci,ap as Po,as as Io,ao as ko,au as $t,av as Ss,ar as nn,aC as Mo,aD as zo,aE as ae,af as No,aF as Do,p as Tr,aG as wn,aH as Lo,l as Ro,B as Ht,F as vn,aI as Ms,g as be,aJ as ns,aK as Bo,aL as Uo,v as Fo,a0 as Vo,a1 as Ho,aM as $o,ae as Er,aO as Zo,aP as Yo,aN as bn,t as jo,aw as Wo,ax as xn,al as Cn,am as Xo,aq as qo,M as ne}from"./index-DcyXhVxI.js";var Go=Object.defineProperty,Qo=(a,t,e)=>t in a?Go(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e,x=(a,t,e)=>(Qo(a,typeof t!="symbol"?t+"":t,e),e);class it{constructor(){x(this,"enabled",!0),x(this,"trigger",t=>{if(!this.enabled)return;const e=this.handlers.slice(0);for(const s of e)s(t)}),x(this,"handlers",[])}add(t){this.handlers.push(t)}remove(t){this.handlers=this.handlers.filter(e=>e!==t)}reset(){this.handlers.length=0}}class rn{constructor(t){x(this,"isDisposeable",()=>"dispose"in this&&"onDisposed"in this),x(this,"isResizeable",()=>"resize"in this&&"getSize"in this),x(this,"isUpdateable",()=>"onAfterUpdate"in this&&"onBeforeUpdate"in this&&"update"in this),x(this,"isHideable",()=>"visible"in this),x(this,"isConfigurable",()=>"setup"in this&&"config"in this&&"onSetup"in this),x(this,"isSerializable",()=>"import"in this&&"export"in this),this.components=t}}class Dt extends rn{}class on extends rn{constructor(t){super(t),x(this,"worlds",new Nt),x(this,"onWorldChanged",new it),x(this,"_currentWorld",null),this.onWorldChanged.add(({world:e,action:s})=>{s==="removed"&&this.worlds.delete(e.uuid)})}set currentWorld(t){this._currentWorld=t}get currentWorld(){return this._currentWorld}}class Ko extends on{constructor(){super(...arguments),x(this,"hasCameraControls",()=>"controls"in this)}}class Jo extends on{constructor(){super(...arguments),x(this,"onAfterUpdate",new it),x(this,"onBeforeUpdate",new it),x(this,"onDisposed",new it),x(this,"onResize",new it),x(this,"onClippingPlanesUpdated",new it),x(this,"clippingPlanes",[])}updateClippingPlanes(){this.onClippingPlanesUpdated.trigger()}setPlane(t,e,s){e.isLocal=s;const i=this.clippingPlanes.indexOf(e);t&&i===-1?this.clippingPlanes.push(e):!t&&i>-1&&this.clippingPlanes.splice(i,1),this.three.clippingPlanes=this.clippingPlanes.filter(n=>!n.isLocal)}}const Sr=class Ui extends Dt{constructor(t){super(t),x(this,"_disposedComponents",new Set),x(this,"enabled",!0),t.add(Ui.uuid,this)}get(){return this._disposedComponents}destroy(t,e=!0,s=!0){t.removeFromParent();const i=t;i.dispose&&i.dispose(),this.disposeGeometryAndMaterials(t,e),s&&i.children&&i.children.length&&this.disposeChildren(i),t.children.length=0}disposeGeometry(t){t.boundsTree&&t.disposeBoundsTree&&t.disposeBoundsTree(),t.dispose()}disposeGeometryAndMaterials(t,e){const s=t;s.geometry&&this.disposeGeometry(s.geometry),e&&s.material&&Ui.disposeMaterial(s),s.material=[],s.geometry=null}disposeChildren(t){for(const e of t.children)this.destroy(e)}static disposeMaterial(t){if(t.material)if(Array.isArray(t.material))for(const e of t.material)e.dispose();else t.material.dispose()}};x(Sr,"uuid","76e9cd8e-ad8f-4753-9ef6-cbc60f7247fe");let hi=Sr;class ta extends on{constructor(t){super(t),x(this,"onDisposed",new it),x(this,"directionalLights",new Map),x(this,"ambientLights",new Map)}dispose(){const t=this.components.get(hi);for(const e of this.three.children){const s=e;s.geometry&&t.destroy(s)}this.deleteAllLights(),this.three.children=[],this.onDisposed.trigger(),this.onDisposed.reset()}deleteAllLights(){for(const[,t]of this.directionalLights)t.removeFromParent(),t.target.removeFromParent(),t.dispose();this.directionalLights.clear();for(const[,t]of this.ambientLights)t.removeFromParent(),t.dispose();this.ambientLights.clear()}}const an=class It{static create(){const t=Math.random()*4294967295|0,e=Math.random()*4294967295|0,s=Math.random()*4294967295|0,i=Math.random()*4294967295|0;return`${It._lut[t&255]+It._lut[t>>8&255]+It._lut[t>>16&255]+It._lut[t>>24&255]}-${It._lut[e&255]}${It._lut[e>>8&255]}-${It._lut[e>>16&15|64]}${It._lut[e>>24&255]}-${It._lut[s&63|128]}${It._lut[s>>8&255]}-${It._lut[s>>16&255]}${It._lut[s>>24&255]}${It._lut[i&255]}${It._lut[i>>8&255]}${It._lut[i>>16&255]}${It._lut[i>>24&255]}`.toLowerCase()}static validate(t){if(!It._pattern.test(t))throw new Error(`${t} is not a valid UUID v4.

- If you're the tool creator, you can take one from https://www.uuidgenerator.net/.

- If you're using a platform tool, verify the uuid isn't misspelled or contact the tool creator.`)}};x(an,"_pattern",/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/);x(an,"_lut",["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"]);let qt=an;var zs=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ea(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var Ar={},ui={};(function(a){const t=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",e=t+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",s="["+t+"]["+e+"]*",i=new RegExp("^"+s+"$"),n=function(o,l){const c=[];let h=l.exec(o);for(;h;){const d=[];d.startIndex=l.lastIndex-h[0].length;const f=h.length;for(let u=0;u<f;u++)d.push(h[u]);c.push(d),h=l.exec(o)}return c},r=function(o){const l=i.exec(o);return!(l===null||typeof l>"u")};a.isExist=function(o){return typeof o<"u"},a.isEmptyObject=function(o){return Object.keys(o).length===0},a.merge=function(o,l,c){if(l){const h=Object.keys(l),d=h.length;for(let f=0;f<d;f++)c==="strict"?o[h[f]]=[l[h[f]]]:o[h[f]]=l[h[f]]}},a.getValue=function(o){return a.isExist(o)?o:""},a.isName=r,a.getAllMatches=n,a.nameRegexp=s})(ui);const ln=ui,sa={allowBooleanAttributes:!1,unpairedTags:[]};Ar.validate=function(a,t){t=Object.assign({},sa,t);const e=[];let s=!1,i=!1;a[0]==="\uFEFF"&&(a=a.substr(1));for(let n=0;n<a.length;n++)if(a[n]==="<"&&a[n+1]==="?"){if(n+=2,n=En(a,n),n.err)return n}else if(a[n]==="<"){let r=n;if(n++,a[n]==="!"){n=Sn(a,n);continue}else{let o=!1;a[n]==="/"&&(o=!0,n++);let l="";for(;n<a.length&&a[n]!==">"&&a[n]!==" "&&a[n]!=="	"&&a[n]!==`
`&&a[n]!=="\r";n++)l+=a[n];if(l=l.trim(),l[l.length-1]==="/"&&(l=l.substring(0,l.length-1),n--),!ha(l)){let d;return l.trim().length===0?d="Invalid space after '<'.":d="Tag '"+l+"' is an invalid name.",St("InvalidTag",d,Zt(a,n))}const c=ra(a,n);if(c===!1)return St("InvalidAttr","Attributes for '"+l+"' have open quote.",Zt(a,n));let h=c.value;if(n=c.index,h[h.length-1]==="/"){const d=n-h.length;h=h.substring(0,h.length-1);const f=An(h,t);if(f===!0)s=!0;else return St(f.err.code,f.err.msg,Zt(a,d+f.err.line))}else if(o)if(c.tagClosed){if(h.trim().length>0)return St("InvalidTag","Closing tag '"+l+"' can't have attributes or invalid starting.",Zt(a,r));if(e.length===0)return St("InvalidTag","Closing tag '"+l+"' has not been opened.",Zt(a,r));{const d=e.pop();if(l!==d.tagName){let f=Zt(a,d.tagStartPos);return St("InvalidTag","Expected closing tag '"+d.tagName+"' (opened in line "+f.line+", col "+f.col+") instead of closing tag '"+l+"'.",Zt(a,r))}e.length==0&&(i=!0)}}else return St("InvalidTag","Closing tag '"+l+"' doesn't have proper closing.",Zt(a,n));else{const d=An(h,t);if(d!==!0)return St(d.err.code,d.err.msg,Zt(a,n-h.length+d.err.line));if(i===!0)return St("InvalidXml","Multiple possible root nodes found.",Zt(a,n));t.unpairedTags.indexOf(l)!==-1||e.push({tagName:l,tagStartPos:r}),s=!0}for(n++;n<a.length;n++)if(a[n]==="<")if(a[n+1]==="!"){n++,n=Sn(a,n);continue}else if(a[n+1]==="?"){if(n=En(a,++n),n.err)return n}else break;else if(a[n]==="&"){const d=la(a,n);if(d==-1)return St("InvalidChar","char '&' is not expected.",Zt(a,n));n=d}else if(i===!0&&!Tn(a[n]))return St("InvalidXml","Extra text at the end",Zt(a,n));a[n]==="<"&&n--}}else{if(Tn(a[n]))continue;return St("InvalidChar","char '"+a[n]+"' is not expected.",Zt(a,n))}if(s){if(e.length==1)return St("InvalidTag","Unclosed tag '"+e[0].tagName+"'.",Zt(a,e[0].tagStartPos));if(e.length>0)return St("InvalidXml","Invalid '"+JSON.stringify(e.map(n=>n.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return St("InvalidXml","Start tag expected.",1);return!0};function Tn(a){return a===" "||a==="	"||a===`
`||a==="\r"}function En(a,t){const e=t;for(;t<a.length;t++)if(a[t]=="?"||a[t]==" "){const s=a.substr(e,t-e);if(t>5&&s==="xml")return St("InvalidXml","XML declaration allowed only at the start of the document.",Zt(a,t));if(a[t]=="?"&&a[t+1]==">"){t++;break}else continue}return t}function Sn(a,t){if(a.length>t+5&&a[t+1]==="-"&&a[t+2]==="-"){for(t+=3;t<a.length;t++)if(a[t]==="-"&&a[t+1]==="-"&&a[t+2]===">"){t+=2;break}}else if(a.length>t+8&&a[t+1]==="D"&&a[t+2]==="O"&&a[t+3]==="C"&&a[t+4]==="T"&&a[t+5]==="Y"&&a[t+6]==="P"&&a[t+7]==="E"){let e=1;for(t+=8;t<a.length;t++)if(a[t]==="<")e++;else if(a[t]===">"&&(e--,e===0))break}else if(a.length>t+9&&a[t+1]==="["&&a[t+2]==="C"&&a[t+3]==="D"&&a[t+4]==="A"&&a[t+5]==="T"&&a[t+6]==="A"&&a[t+7]==="["){for(t+=8;t<a.length;t++)if(a[t]==="]"&&a[t+1]==="]"&&a[t+2]===">"){t+=2;break}}return t}const ia='"',na="'";function ra(a,t){let e="",s="",i=!1;for(;t<a.length;t++){if(a[t]===ia||a[t]===na)s===""?s=a[t]:s!==a[t]||(s="");else if(a[t]===">"&&s===""){i=!0;break}e+=a[t]}return s!==""?!1:{value:e,index:t,tagClosed:i}}const oa=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function An(a,t){const e=ln.getAllMatches(a,oa),s={};for(let i=0;i<e.length;i++){if(e[i][1].length===0)return St("InvalidAttr","Attribute '"+e[i][2]+"' has no space in starting.",rs(e[i]));if(e[i][3]!==void 0&&e[i][4]===void 0)return St("InvalidAttr","Attribute '"+e[i][2]+"' is without value.",rs(e[i]));if(e[i][3]===void 0&&!t.allowBooleanAttributes)return St("InvalidAttr","boolean attribute '"+e[i][2]+"' is not allowed.",rs(e[i]));const n=e[i][2];if(!ca(n))return St("InvalidAttr","Attribute '"+n+"' is an invalid name.",rs(e[i]));if(!s.hasOwnProperty(n))s[n]=1;else return St("InvalidAttr","Attribute '"+n+"' is repeated.",rs(e[i]))}return!0}function aa(a,t){let e=/\d/;for(a[t]==="x"&&(t++,e=/[\da-fA-F]/);t<a.length;t++){if(a[t]===";")return t;if(!a[t].match(e))break}return-1}function la(a,t){if(t++,a[t]===";")return-1;if(a[t]==="#")return t++,aa(a,t);let e=0;for(;t<a.length;t++,e++)if(!(a[t].match(/\w/)&&e<20)){if(a[t]===";")break;return-1}return t}function St(a,t,e){return{err:{code:a,msg:t,line:e.line||e,col:e.col}}}function ca(a){return ln.isName(a)}function ha(a){return ln.isName(a)}function Zt(a,t){const e=a.substring(0,t).split(/\r?\n/);return{line:e.length,col:e[e.length-1].length+1}}function rs(a){return a.startIndex+a[1].length}var cn={};const Or={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(a,t){return t},attributeValueProcessor:function(a,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(a,t,e){return a}},ua=function(a){return Object.assign({},Or,a)};cn.buildOptions=ua;cn.defaultOptions=Or;class da{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,e){t==="__proto__"&&(t="#__proto__"),this.child.push({[t]:e})}addChild(t){t.tagname==="__proto__"&&(t.tagname="#__proto__"),t[":@"]&&Object.keys(t[":@"]).length>0?this.child.push({[t.tagname]:t.child,":@":t[":@"]}):this.child.push({[t.tagname]:t.child})}}var fa=da;const pa=ui;function ma(a,t){const e={};if(a[t+3]==="O"&&a[t+4]==="C"&&a[t+5]==="T"&&a[t+6]==="Y"&&a[t+7]==="P"&&a[t+8]==="E"){t=t+9;let s=1,i=!1,n=!1,r="";for(;t<a.length;t++)if(a[t]==="<"&&!n){if(i&&ya(a,t))t+=7,[entityName,val,t]=ga(a,t+1),val.indexOf("&")===-1&&(e[xa(entityName)]={regx:RegExp(`&${entityName};`,"g"),val});else if(i&&wa(a,t))t+=8;else if(i&&va(a,t))t+=8;else if(i&&ba(a,t))t+=9;else if(_a)n=!0;else throw new Error("Invalid DOCTYPE");s++,r=""}else if(a[t]===">"){if(n?a[t-1]==="-"&&a[t-2]==="-"&&(n=!1,s--):s--,s===0)break}else a[t]==="["?i=!0:r+=a[t];if(s!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:e,i:t}}function ga(a,t){let e="";for(;t<a.length&&a[t]!=="'"&&a[t]!=='"';t++)e+=a[t];if(e=e.trim(),e.indexOf(" ")!==-1)throw new Error("External entites are not supported");const s=a[t++];let i="";for(;t<a.length&&a[t]!==s;t++)i+=a[t];return[e,i,t]}function _a(a,t){return a[t+1]==="!"&&a[t+2]==="-"&&a[t+3]==="-"}function ya(a,t){return a[t+1]==="!"&&a[t+2]==="E"&&a[t+3]==="N"&&a[t+4]==="T"&&a[t+5]==="I"&&a[t+6]==="T"&&a[t+7]==="Y"}function wa(a,t){return a[t+1]==="!"&&a[t+2]==="E"&&a[t+3]==="L"&&a[t+4]==="E"&&a[t+5]==="M"&&a[t+6]==="E"&&a[t+7]==="N"&&a[t+8]==="T"}function va(a,t){return a[t+1]==="!"&&a[t+2]==="A"&&a[t+3]==="T"&&a[t+4]==="T"&&a[t+5]==="L"&&a[t+6]==="I"&&a[t+7]==="S"&&a[t+8]==="T"}function ba(a,t){return a[t+1]==="!"&&a[t+2]==="N"&&a[t+3]==="O"&&a[t+4]==="T"&&a[t+5]==="A"&&a[t+6]==="T"&&a[t+7]==="I"&&a[t+8]==="O"&&a[t+9]==="N"}function xa(a){if(pa.isName(a))return a;throw new Error(`Invalid entity name ${a}`)}var Ca=ma;const Ta=/^[-+]?0x[a-fA-F0-9]+$/,Ea=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,Sa={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function Aa(a,t={}){if(t=Object.assign({},Sa,t),!a||typeof a!="string")return a;let e=a.trim();if(t.skipLike!==void 0&&t.skipLike.test(e))return a;if(a==="0")return 0;if(t.hex&&Ta.test(e))return Pa(e,16);if(e.search(/[eE]/)!==-1){const s=e.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(s){if(t.leadingZeros)e=(s[1]||"")+s[3];else if(!(s[2]==="0"&&s[3][0]==="."))return a;return t.eNotation?Number(e):a}else return a}else{const s=Ea.exec(e);if(s){const i=s[1],n=s[2];let r=Oa(s[3]);if(!t.leadingZeros&&n.length>0&&i&&e[2]!==".")return a;if(!t.leadingZeros&&n.length>0&&!i&&e[1]!==".")return a;if(t.leadingZeros&&n===a)return 0;{const o=Number(e),l=""+o;return l.search(/[eE]/)!==-1?t.eNotation?o:a:e.indexOf(".")!==-1?l==="0"&&r===""||l===r||i&&l==="-"+r?o:a:n?r===l||i+r===l?o:a:e===l||e===i+l?o:a}}else return a}}function Oa(a){return a&&a.indexOf(".")!==-1&&(a=a.replace(/0+$/,""),a==="."?a="0":a[0]==="."?a="0"+a:a[a.length-1]==="."&&(a=a.substr(0,a.length-1))),a}function Pa(a,t){if(parseInt)return parseInt(a,t);if(Number.parseInt)return Number.parseInt(a,t);if(window&&window.parseInt)return window.parseInt(a,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}var Ia=Aa;const Pr=ui,os=fa,ka=Ca,Ma=Ia;let za=class{constructor(t){this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,s)=>String.fromCharCode(Number.parseInt(s,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,s)=>String.fromCharCode(Number.parseInt(s,16))}},this.addExternalEntities=Na,this.parseXml=Ua,this.parseTextData=Da,this.resolveNameSpace=La,this.buildAttributesMap=Ba,this.isItStopNode=$a,this.replaceEntitiesValue=Va,this.readStopNodeData=Ya,this.saveTextToParentTag=Ha,this.addChild=Fa}};function Na(a){const t=Object.keys(a);for(let e=0;e<t.length;e++){const s=t[e];this.lastEntities[s]={regex:new RegExp("&"+s+";","g"),val:a[s]}}}function Da(a,t,e,s,i,n,r){if(a!==void 0&&(this.options.trimValues&&!s&&(a=a.trim()),a.length>0)){r||(a=this.replaceEntitiesValue(a));const o=this.options.tagValueProcessor(t,a,e,i,n);return o==null?a:typeof o!=typeof a||o!==a?o:this.options.trimValues?Vi(a,this.options.parseTagValue,this.options.numberParseOptions):a.trim()===a?Vi(a,this.options.parseTagValue,this.options.numberParseOptions):a}}function La(a){if(this.options.removeNSPrefix){const t=a.split(":"),e=a.charAt(0)==="/"?"/":"";if(t[0]==="xmlns")return"";t.length===2&&(a=e+t[1])}return a}const Ra=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function Ba(a,t,e){if(!this.options.ignoreAttributes&&typeof a=="string"){const s=Pr.getAllMatches(a,Ra),i=s.length,n={};for(let r=0;r<i;r++){const o=this.resolveNameSpace(s[r][1]);let l=s[r][4],c=this.options.attributeNamePrefix+o;if(o.length)if(this.options.transformAttributeName&&(c=this.options.transformAttributeName(c)),c==="__proto__"&&(c="#__proto__"),l!==void 0){this.options.trimValues&&(l=l.trim()),l=this.replaceEntitiesValue(l);const h=this.options.attributeValueProcessor(o,l,t);h==null?n[c]=l:typeof h!=typeof l||h!==l?n[c]=h:n[c]=Vi(l,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(n[c]=!0)}if(!Object.keys(n).length)return;if(this.options.attributesGroupName){const r={};return r[this.options.attributesGroupName]=n,r}return n}}const Ua=function(a){a=a.replace(/\r\n?/g,`
`);const t=new os("!xml");let e=t,s="",i="";for(let n=0;n<a.length;n++)if(a[n]==="<")if(a[n+1]==="/"){const o=Ne(a,">",n,"Closing Tag is not closed.");let l=a.substring(n+2,o).trim();if(this.options.removeNSPrefix){const d=l.indexOf(":");d!==-1&&(l=l.substr(d+1))}this.options.transformTagName&&(l=this.options.transformTagName(l)),e&&(s=this.saveTextToParentTag(s,e,i));const c=i.substring(i.lastIndexOf(".")+1);if(l&&this.options.unpairedTags.indexOf(l)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${l}>`);let h=0;c&&this.options.unpairedTags.indexOf(c)!==-1?(h=i.lastIndexOf(".",i.lastIndexOf(".")-1),this.tagsNodeStack.pop()):h=i.lastIndexOf("."),i=i.substring(0,h),e=this.tagsNodeStack.pop(),s="",n=o}else if(a[n+1]==="?"){let o=Fi(a,n,!1,"?>");if(!o)throw new Error("Pi Tag is not closed.");if(s=this.saveTextToParentTag(s,e,i),!(this.options.ignoreDeclaration&&o.tagName==="?xml"||this.options.ignorePiTags)){const l=new os(o.tagName);l.add(this.options.textNodeName,""),o.tagName!==o.tagExp&&o.attrExpPresent&&(l[":@"]=this.buildAttributesMap(o.tagExp,i,o.tagName)),this.addChild(e,l,i)}n=o.closeIndex+1}else if(a.substr(n+1,3)==="!--"){const o=Ne(a,"-->",n+4,"Comment is not closed.");if(this.options.commentPropName){const l=a.substring(n+4,o-2);s=this.saveTextToParentTag(s,e,i),e.add(this.options.commentPropName,[{[this.options.textNodeName]:l}])}n=o}else if(a.substr(n+1,2)==="!D"){const o=ka(a,n);this.docTypeEntities=o.entities,n=o.i}else if(a.substr(n+1,2)==="!["){const o=Ne(a,"]]>",n,"CDATA is not closed.")-2,l=a.substring(n+9,o);s=this.saveTextToParentTag(s,e,i);let c=this.parseTextData(l,e.tagname,i,!0,!1,!0,!0);c==null&&(c=""),this.options.cdataPropName?e.add(this.options.cdataPropName,[{[this.options.textNodeName]:l}]):e.add(this.options.textNodeName,c),n=o+2}else{let o=Fi(a,n,this.options.removeNSPrefix),l=o.tagName;const c=o.rawTagName;let h=o.tagExp,d=o.attrExpPresent,f=o.closeIndex;this.options.transformTagName&&(l=this.options.transformTagName(l)),e&&s&&e.tagname!=="!xml"&&(s=this.saveTextToParentTag(s,e,i,!1));const u=e;if(u&&this.options.unpairedTags.indexOf(u.tagname)!==-1&&(e=this.tagsNodeStack.pop(),i=i.substring(0,i.lastIndexOf("."))),l!==t.tagname&&(i+=i?"."+l:l),this.isItStopNode(this.options.stopNodes,i,l)){let m="";if(h.length>0&&h.lastIndexOf("/")===h.length-1)l[l.length-1]==="/"?(l=l.substr(0,l.length-1),i=i.substr(0,i.length-1),h=l):h=h.substr(0,h.length-1),n=o.closeIndex;else if(this.options.unpairedTags.indexOf(l)!==-1)n=o.closeIndex;else{const _=this.readStopNodeData(a,c,f+1);if(!_)throw new Error(`Unexpected end of ${c}`);n=_.i,m=_.tagContent}const g=new os(l);l!==h&&d&&(g[":@"]=this.buildAttributesMap(h,i,l)),m&&(m=this.parseTextData(m,l,i,!0,d,!0,!0)),i=i.substr(0,i.lastIndexOf(".")),g.add(this.options.textNodeName,m),this.addChild(e,g,i)}else{if(h.length>0&&h.lastIndexOf("/")===h.length-1){l[l.length-1]==="/"?(l=l.substr(0,l.length-1),i=i.substr(0,i.length-1),h=l):h=h.substr(0,h.length-1),this.options.transformTagName&&(l=this.options.transformTagName(l));const m=new os(l);l!==h&&d&&(m[":@"]=this.buildAttributesMap(h,i,l)),this.addChild(e,m,i),i=i.substr(0,i.lastIndexOf("."))}else{const m=new os(l);this.tagsNodeStack.push(e),l!==h&&d&&(m[":@"]=this.buildAttributesMap(h,i,l)),this.addChild(e,m,i),e=m}s="",n=f}}else s+=a[n];return t.child};function Fa(a,t,e){const s=this.options.updateTag(t.tagname,e,t[":@"]);s===!1||(typeof s=="string"&&(t.tagname=s),a.addChild(t))}const Va=function(a){if(this.options.processEntities){for(let t in this.docTypeEntities){const e=this.docTypeEntities[t];a=a.replace(e.regx,e.val)}for(let t in this.lastEntities){const e=this.lastEntities[t];a=a.replace(e.regex,e.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const e=this.htmlEntities[t];a=a.replace(e.regex,e.val)}a=a.replace(this.ampEntity.regex,this.ampEntity.val)}return a};function Ha(a,t,e,s){return a&&(s===void 0&&(s=Object.keys(t.child).length===0),a=this.parseTextData(a,t.tagname,e,!1,t[":@"]?Object.keys(t[":@"]).length!==0:!1,s),a!==void 0&&a!==""&&t.add(this.options.textNodeName,a),a=""),a}function $a(a,t,e){const s="*."+e;for(const i in a){const n=a[i];if(s===n||t===n)return!0}return!1}function Za(a,t,e=">"){let s,i="";for(let n=t;n<a.length;n++){let r=a[n];if(s)r===s&&(s="");else if(r==='"'||r==="'")s=r;else if(r===e[0])if(e[1]){if(a[n+1]===e[1])return{data:i,index:n}}else return{data:i,index:n};else r==="	"&&(r=" ");i+=r}}function Ne(a,t,e,s){const i=a.indexOf(t,e);if(i===-1)throw new Error(s);return i+t.length-1}function Fi(a,t,e,s=">"){const i=Za(a,t+1,s);if(!i)return;let n=i.data;const r=i.index,o=n.search(/\s/);let l=n,c=!0;o!==-1&&(l=n.substring(0,o),n=n.substring(o+1).trimStart());const h=l;if(e){const d=l.indexOf(":");d!==-1&&(l=l.substr(d+1),c=l!==i.data.substr(d+1))}return{tagName:l,tagExp:n,closeIndex:r,attrExpPresent:c,rawTagName:h}}function Ya(a,t,e){const s=e;let i=1;for(;e<a.length;e++)if(a[e]==="<")if(a[e+1]==="/"){const n=Ne(a,">",e,`${t} is not closed`);if(a.substring(e+2,n).trim()===t&&(i--,i===0))return{tagContent:a.substring(s,e),i:n};e=n}else if(a[e+1]==="?")e=Ne(a,"?>",e+1,"StopNode is not closed.");else if(a.substr(e+1,3)==="!--")e=Ne(a,"-->",e+3,"StopNode is not closed.");else if(a.substr(e+1,2)==="![")e=Ne(a,"]]>",e,"StopNode is not closed.")-2;else{const n=Fi(a,e,">");n&&((n&&n.tagName)===t&&n.tagExp[n.tagExp.length-1]!=="/"&&i++,e=n.closeIndex)}}function Vi(a,t,e){if(t&&typeof a=="string"){const s=a.trim();return s==="true"?!0:s==="false"?!1:Ma(a,e)}else return Pr.isExist(a)?a:""}var ja=za,Ir={};function Wa(a,t){return kr(a,t)}function kr(a,t,e){let s;const i={};for(let n=0;n<a.length;n++){const r=a[n],o=Xa(r);let l="";if(e===void 0?l=o:l=e+"."+o,o===t.textNodeName)s===void 0?s=r[o]:s+=""+r[o];else{if(o===void 0)continue;if(r[o]){let c=kr(r[o],t,l);const h=Ga(c,t);r[":@"]?qa(c,r[":@"],l,t):Object.keys(c).length===1&&c[t.textNodeName]!==void 0&&!t.alwaysCreateTextNode?c=c[t.textNodeName]:Object.keys(c).length===0&&(t.alwaysCreateTextNode?c[t.textNodeName]="":c=""),i[o]!==void 0&&i.hasOwnProperty(o)?(Array.isArray(i[o])||(i[o]=[i[o]]),i[o].push(c)):t.isArray(o,l,h)?i[o]=[c]:i[o]=c}}}return typeof s=="string"?s.length>0&&(i[t.textNodeName]=s):s!==void 0&&(i[t.textNodeName]=s),i}function Xa(a){const t=Object.keys(a);for(let e=0;e<t.length;e++){const s=t[e];if(s!==":@")return s}}function qa(a,t,e,s){if(t){const i=Object.keys(t),n=i.length;for(let r=0;r<n;r++){const o=i[r];s.isArray(o,e+"."+o,!0,!0)?a[o]=[t[o]]:a[o]=t[o]}}}function Ga(a,t){const{textNodeName:e}=t,s=Object.keys(a).length;return!!(s===0||s===1&&(a[e]||typeof a[e]=="boolean"||a[e]===0))}Ir.prettify=Wa;const{buildOptions:Qa}=cn,Ka=ja,{prettify:Ja}=Ir,tl=Ar;let el=class{constructor(t){this.externalEntities={},this.options=Qa(t)}parse(t,e){if(typeof t!="string")if(t.toString)t=t.toString();else throw new Error("XML data is accepted in String or Bytes[] form.");if(e){e===!0&&(e={});const n=tl.validate(t,e);if(n!==!0)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const s=new Ka(this.options);s.addExternalEntities(this.externalEntities);const i=s.parseXml(t);return this.options.preserveOrder||i===void 0?i:Ja(i,this.options)}addEntity(t,e){if(e.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(t.indexOf("&")!==-1||t.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(e==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[t]=e}};var sl=el;const il=`
`;function nl(a,t){let e="";return t.format&&t.indentBy.length>0&&(e=il),Mr(a,t,"",e)}function Mr(a,t,e,s){let i="",n=!1;for(let r=0;r<a.length;r++){const o=a[r],l=rl(o);if(l===void 0)continue;let c="";if(e.length===0?c=l:c=`${e}.${l}`,l===t.textNodeName){let m=o[l];ol(c,t)||(m=t.tagValueProcessor(l,m),m=zr(m,t)),n&&(i+=s),i+=m,n=!1;continue}else if(l===t.cdataPropName){n&&(i+=s),i+=`<![CDATA[${o[l][0][t.textNodeName]}]]>`,n=!1;continue}else if(l===t.commentPropName){i+=s+`<!--${o[l][0][t.textNodeName]}-->`,n=!0;continue}else if(l[0]==="?"){const m=On(o[":@"],t),g=l==="?xml"?"":s;let _=o[l][0][t.textNodeName];_=_.length!==0?" "+_:"",i+=g+`<${l}${_}${m}?>`,n=!0;continue}let h=s;h!==""&&(h+=t.indentBy);const d=On(o[":@"],t),f=s+`<${l}${d}`,u=Mr(o[l],t,c,h);t.unpairedTags.indexOf(l)!==-1?t.suppressUnpairedNode?i+=f+">":i+=f+"/>":(!u||u.length===0)&&t.suppressEmptyNode?i+=f+"/>":u&&u.endsWith(">")?i+=f+`>${u}${s}</${l}>`:(i+=f+">",u&&s!==""&&(u.includes("/>")||u.includes("</"))?i+=s+t.indentBy+u+s:i+=u,i+=`</${l}>`),n=!0}return i}function rl(a){const t=Object.keys(a);for(let e=0;e<t.length;e++){const s=t[e];if(a.hasOwnProperty(s)&&s!==":@")return s}}function On(a,t){let e="";if(a&&!t.ignoreAttributes)for(let s in a){if(!a.hasOwnProperty(s))continue;let i=t.attributeValueProcessor(s,a[s]);i=zr(i,t),i===!0&&t.suppressBooleanAttributes?e+=` ${s.substr(t.attributeNamePrefix.length)}`:e+=` ${s.substr(t.attributeNamePrefix.length)}="${i}"`}return e}function ol(a,t){a=a.substr(0,a.length-t.textNodeName.length-1);let e=a.substr(a.lastIndexOf(".")+1);for(let s in t.stopNodes)if(t.stopNodes[s]===a||t.stopNodes[s]==="*."+e)return!0;return!1}function zr(a,t){if(a&&a.length>0&&t.processEntities)for(let e=0;e<t.entities.length;e++){const s=t.entities[e];a=a.replace(s.regex,s.val)}return a}var al=nl;const ll=al,cl={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(a,t){return t},attributeValueProcessor:function(a,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function Pe(a){this.options=Object.assign({},cl,a),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=dl),this.processTextOrObjNode=hl,this.options.format?(this.indentate=ul,this.tagEndChar=`>
`,this.newLine=`
`):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}Pe.prototype.build=function(a){return this.options.preserveOrder?ll(a,this.options):(Array.isArray(a)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(a={[this.options.arrayNodeName]:a}),this.j2x(a,0).val)};Pe.prototype.j2x=function(a,t){let e="",s="";for(let i in a)if(Object.prototype.hasOwnProperty.call(a,i))if(typeof a[i]>"u")this.isAttribute(i)&&(s+="");else if(a[i]===null)this.isAttribute(i)?s+="":i[0]==="?"?s+=this.indentate(t)+"<"+i+"?"+this.tagEndChar:s+=this.indentate(t)+"<"+i+"/"+this.tagEndChar;else if(a[i]instanceof Date)s+=this.buildTextValNode(a[i],i,"",t);else if(typeof a[i]!="object"){const n=this.isAttribute(i);if(n)e+=this.buildAttrPairStr(n,""+a[i]);else if(i===this.options.textNodeName){let r=this.options.tagValueProcessor(i,""+a[i]);s+=this.replaceEntitiesValue(r)}else s+=this.buildTextValNode(a[i],i,"",t)}else if(Array.isArray(a[i])){const n=a[i].length;let r="",o="";for(let l=0;l<n;l++){const c=a[i][l];if(!(typeof c>"u"))if(c===null)i[0]==="?"?s+=this.indentate(t)+"<"+i+"?"+this.tagEndChar:s+=this.indentate(t)+"<"+i+"/"+this.tagEndChar;else if(typeof c=="object")if(this.options.oneListGroup){const h=this.j2x(c,t+1);r+=h.val,this.options.attributesGroupName&&c.hasOwnProperty(this.options.attributesGroupName)&&(o+=h.attrStr)}else r+=this.processTextOrObjNode(c,i,t);else if(this.options.oneListGroup){let h=this.options.tagValueProcessor(i,c);h=this.replaceEntitiesValue(h),r+=h}else r+=this.buildTextValNode(c,i,"",t)}this.options.oneListGroup&&(r=this.buildObjectNode(r,i,o,t)),s+=r}else if(this.options.attributesGroupName&&i===this.options.attributesGroupName){const n=Object.keys(a[i]),r=n.length;for(let o=0;o<r;o++)e+=this.buildAttrPairStr(n[o],""+a[i][n[o]])}else s+=this.processTextOrObjNode(a[i],i,t);return{attrStr:e,val:s}};Pe.prototype.buildAttrPairStr=function(a,t){return t=this.options.attributeValueProcessor(a,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&t==="true"?" "+a:" "+a+'="'+t+'"'};function hl(a,t,e){const s=this.j2x(a,e+1);return a[this.options.textNodeName]!==void 0&&Object.keys(a).length===1?this.buildTextValNode(a[this.options.textNodeName],t,s.attrStr,e):this.buildObjectNode(s.val,t,s.attrStr,e)}Pe.prototype.buildObjectNode=function(a,t,e,s){if(a==="")return t[0]==="?"?this.indentate(s)+"<"+t+e+"?"+this.tagEndChar:this.indentate(s)+"<"+t+e+this.closeTag(t)+this.tagEndChar;{let i="</"+t+this.tagEndChar,n="";return t[0]==="?"&&(n="?",i=""),(e||e==="")&&a.indexOf("<")===-1?this.indentate(s)+"<"+t+e+n+">"+a+i:this.options.commentPropName!==!1&&t===this.options.commentPropName&&n.length===0?this.indentate(s)+`<!--${a}-->`+this.newLine:this.indentate(s)+"<"+t+e+n+this.tagEndChar+a+this.indentate(s)+i}};Pe.prototype.closeTag=function(a){let t="";return this.options.unpairedTags.indexOf(a)!==-1?this.options.suppressUnpairedNode||(t="/"):this.options.suppressEmptyNode?t="/":t=`></${a}`,t};Pe.prototype.buildTextValNode=function(a,t,e,s){if(this.options.cdataPropName!==!1&&t===this.options.cdataPropName)return this.indentate(s)+`<![CDATA[${a}]]>`+this.newLine;if(this.options.commentPropName!==!1&&t===this.options.commentPropName)return this.indentate(s)+`<!--${a}-->`+this.newLine;if(t[0]==="?")return this.indentate(s)+"<"+t+e+"?"+this.tagEndChar;{let i=this.options.tagValueProcessor(t,a);return i=this.replaceEntitiesValue(i),i===""?this.indentate(s)+"<"+t+e+this.closeTag(t)+this.tagEndChar:this.indentate(s)+"<"+t+e+">"+i+"</"+t+this.tagEndChar}};Pe.prototype.replaceEntitiesValue=function(a){if(a&&a.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const e=this.options.entities[t];a=a.replace(e.regex,e.val)}return a};function ul(a){return this.options.indentBy.repeat(a)}function dl(a){return a.startsWith(this.options.attributeNamePrefix)&&a!==this.options.textNodeName?a.substr(this.attrPrefixLen):!1}var fl=Pe;const pl=sl,ml=fl;var di={XMLParser:pl,XMLBuilder:ml};class fi{}x(fi,"parser",new di.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));x(fi,"builder",new di.XMLBuilder({attributeNamePrefix:"$",ignoreAttributes:!1,suppressBooleanAttributes:!1}));class Mt{static join(t){const e={};for(const s of t)for(const i in s)if(!e[i])e[i]=new Set(s[i]);else for(const n of s[i])e[i].add(n);return e}static intersect(t){if(t.length===0)return{};let e=Mt.clone(t[0]);for(let s=1;s<t.length;s++){const i=t[s],n={};for(const r in e)if(i[r]){const o=new Set;for(const l of e[r])i[r].has(l)&&o.add(l);o.size>0&&(n[r]=o)}e=n}return e}static clone(t){const e={};for(const s in t)e[s]=new Set(t[s]);return e}static remove(t,e,s=!1){s&&(t=Mt.clone(t));for(const i in e)if(t[i]){for(const n of e[i])t[i].delete(n);t[i].size===0&&delete t[i]}}static add(t,e,s=!1){s&&(t=Mt.clone(t));for(const i in e)if(!t[i])t[i]=new Set(e[i]);else for(const n of e[i])t[i].add(n)}static append(t,e,...s){let i=t[e];i||(i=new Set,t[e]=i);for(const n of s)i.add(n)}static isEqual(t,e){const s=Object.keys(t),i=Object.keys(e);if(s.length!==i.length)return!1;for(const n of s){if(!e[n]||t[n].size!==e[n].size)return!1;for(const r of t[n])if(!e[n].has(r))return!1}return!0}static isEmpty(t){return Object.values(t).reduce((s,i)=>s+i.size,0)===0}static toRaw(t){const e={};for(const s in t)e[s]=Array.from(t[s]);return e}static fromRaw(t){const e={};for(const s in t)e[s]=new Set(t[s]);return e}}class yi{static isEntry(t){return new Set(["Boolean","Color","Text","Number","Select","Vector3","TextSet","None"]).has(t.type)}static copySchema(t,e={}){for(const s in t){const i=t[s];this.isEntry(i)?e[s]=this.copyEntry(i):(e[s]={},this.copySchema(i,e[s]))}return e}static copyEntry(t){if(t.type==="Boolean"){const e=t;return{type:e.type,value:e.value}}if(t.type==="Color"){const e=t;return{type:e.type,value:e.value.clone()}}if(t.type==="Text"){const e=t;return{type:e.type,value:e.value}}if(t.type==="Number"){const e=t;return{type:e.type,value:e.value,min:e.min,max:e.max,interpolable:e.interpolable}}if(t.type==="Select"){const e=t;return{type:e.type,value:e.value,multiple:e.multiple,options:new Set(e.options)}}if(t.type==="Vector3"){const e=t;return{type:e.type,value:e.value.clone()}}if(t.type==="TextSet"){const e=t;return{type:e.type,value:new Set(e.value)}}if(t.type==="None"){const e=t;return{type:e.type,value:e.value}}throw new Error("Invalid entry!")}}class gh{constructor(){x(this,"list",new Set)}add(t){for(const e of t)this.list.add(e)}remove(t){for(const e of t)this.list.delete(e)}set(t){for(const e of this.list)e.enabled=t}reset(){for(const t of this.list)t.reset()}}class Ps{constructor(t,e,s,i){x(this,"_component"),x(this,"name"),x(this,"uuid"),this._component=t,this.name=s,this.uuid=i??qt.create(),e.get(pi).list.set(this.uuid,this)}get controls(){return yi.copySchema(this._config)}set(t){for(const e in t)if(e in this){const s=e;this[s]=t[e].value}}export(t=this._config,e={}){for(const s in t){const i=t[s];if(yi.isEntry(i))if(i.type==="Color"){const{r,g:o,b:l}=i.value;e[s]={...i,value:{r,g:o,b:l}}}else if(i.type==="Vector3"){const{x:r,y:o,z:l}=i.value;e[s]={...i,value:{x:r,y:o,z:l}}}else if(i.type==="TextSet"){const r=Array.from(i.value);e[s]={...i,value:r}}else if(i.type==="Select"){const r=Array.from(i.options);e[s]={...i,options:r}}else e[s]={...i};else e[s]={},this.export(i,e[s])}return e}import(t,e={},s=!0){for(const i in t){const n=t[i];if(yi.isEntry(n))if(n.type==="Color"){const{r:o,g:l,b:c}=n.value;e[i]={...n,value:new zt(o,l,c)}}else if(n.type==="Vector3"){const{x:o,y:l,z:c}=n.value;e[i]={...n,value:new V(o,l,c)}}else n.type==="TextSet"?e[i]={...n,value:new Set(n.value)}:n.type==="Select"?e[i]={...n,options:new Set(n.options)}:e[i]={...n};else e[i]={},this.import(n,e[i],!1)}s&&this.set(e)}}const Nr=class Dr extends Dt{constructor(t){super(t),x(this,"list",new Nt),x(this,"enabled",!0),t.add(Dr.uuid,this)}};x(Nr,"uuid","b8c764e0-6b24-4e77-9a32-35fa728ee5b4");let pi=Nr;class Lr{constructor(t){x(this,"_event"),x(this,"_position",new Wt),x(this,"onDisposed",new it),x(this,"updateMouseInfo",e=>{this._event=e}),this.dom=t,this.setupEvents(!0)}get position(){return this.updatePosition(!1),this._position.clone()}get rawPosition(){return this.updatePosition(!0),this._position.clone()}dispose(){this.setupEvents(!1),this.onDisposed.trigger(),this.onDisposed.reset()}updatePosition(t){if(this._event){const e=this.dom.getBoundingClientRect();this._position.x=this.getPositionX(e,this._event,t),this._position.y=this.getPositionY(e,this._event,t)}}getPositionY(t,e,s){const i=this.getDataObject(e);return s?i.clientY:-((i.clientY-t.top)/(t.bottom-t.top))*2+1}getPositionX(t,e,s){const i=this.getDataObject(e);return s?i.clientX:(i.clientX-t.left)/(t.right-t.left)*2-1}getDataObject(t){return t instanceof MouseEvent?t:t.touches[0]}setupEvents(t){t?(this.dom.addEventListener("pointermove",this.updateMouseInfo),this.dom.addEventListener("touchstart",this.updateMouseInfo)):(this.dom.removeEventListener("pointermove",this.updateMouseInfo),this.dom.removeEventListener("touchstart",this.updateMouseInfo))}}const Rr=class Br extends Dt{constructor(t){super(t),x(this,"onDisposed",new it),x(this,"onBeforeDispose",new it),x(this,"onFragmentsLoaded",new it),x(this,"baseCoordinationModel",""),x(this,"baseCoordinationMatrix",new Ot),x(this,"enabled",!0),x(this,"_core"),this.components.add(Br.uuid,this)}get initialized(){return!!this._core}get list(){return this.core.models.list}get core(){if(!this._core)throw new Error("FragmentsManager not initialized. Call init() first.");return this._core}get _hasCoordinationModel(){return this.baseCoordinationModel!==""}dispose(){this.onBeforeDispose.trigger(),this._core&&(this.core.dispose(),this._core=void 0),this.baseCoordinationModel="",this.onFragmentsLoaded.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}init(t){this._core=new Oo(t),this.core.onModelLoaded.add(async()=>{if(this._hasCoordinationModel)return;const e=[...this.list.values()][0];e&&(this.baseCoordinationModel=e.modelId,this.baseCoordinationMatrix=await e.getCoordinationMatrix())}),this.list.onItemDeleted.add(()=>{this.list.size>0||(this.baseCoordinationModel="",this.baseCoordinationMatrix=new Ot)})}async raycast(t){const e=[];for(const n of this.core.models.list.values())if(t.snappingClasses&&t.snappingClasses.length>0){const r=await n.raycastWithSnapping(t);if(r&&r.length>0)e.push(r[0]);else{const o=await n.raycast(t);o&&e.push(o)}}else{const r=await n.raycast(t);r&&e.push(r)}if(await Promise.all(e),e.length===0)return;let s=e[0],i=s.distance;for(let n=1;n<e.length;n++)e[n].distance<i&&(i=e[n].distance,s=e[n]);return s}async getPositions(t){const e=[],s=async(n,r)=>{const o=await n.getPositions(r);for(const l of o)e.push(l)},i=[];for(const n in t){const r=this.core.models.list.get(n);r&&i.push(s(r,Array.from(t[n])))}return await Promise.all(i),e}async getBBoxes(t){const e=[],s=async(n,r)=>{const o=await n.getBoxes(r);if(o)for(const l of o)e.push(l)},i=[];for(const n in t){const r=this.core.models.list.get(n);r&&i.push(s(r,Array.from(t[n])))}return await Promise.all(i),e}async highlight(t,e){await this.forEachModel(e,"highlight",t)}async getData(t,e){const s={};for(const[i,n]of Object.entries(t)){const r=this.list.get(i);if(!r)continue;if(n.size===0){s[i]=[];continue}const o=await r.getItemsData([...n],e);s[i]=o}return s}async resetHighlight(t){await this.forEachModel(t,"resetHighlight")}async forEachModel(t,e,...s){const i={};if(t)for(const r in t){const o=t[r];i[r]=Array.from(o)}else for(const r of this.core.models.list.keys())i[r]=void 0;const n=[];for(const r in i){const o=this.core.models.list.get(r);if(o){const l=i[r],c=o[e](l,...s);n.push(c)}}await Promise.all(n)}async guidsToModelIdMap(t){const e={};for(const[s,i]of this.list){const n=(await i.getLocalIdsByGuids([...t])).filter(r=>r!==null);e[s]=new Set(n)}return e}async modelIdMapToGuids(t){const e=[];for(const[s,i]of Object.entries(t)){const n=this.list.get(s);if(!n)continue;const r=(await n.getGuidsByLocalIds([...i])).filter(o=>o!==null);e.push(...r)}return e}applyBaseCoordinateSystem(t,e){const s=new Ot;return e&&s.copy(e.clone()).invert(),s.multiply(this.baseCoordinationMatrix),t.applyMatrix4(s),s}};x(Rr,"uuid","fef46874-46a3-461b-8c44-2922ab77c806");let ct=Rr;class gl{constructor(){x(this,"wasm",{path:"",absolute:!1,logLevel:qo.LOG_LEVEL_OFF}),x(this,"webIfc",{COORDINATE_TO_ORIGIN:!0}),x(this,"autoSetWasm",!0),x(this,"customLocateFileHandler",null)}}const Ur=class Hi extends Dt{constructor(t){super(t),x(this,"onDisposed",new it),x(this,"onIfcStartedLoading",new it),x(this,"onIfcImporterInitialized",new it),x(this,"onSetup",new it),x(this,"settings",new gl),x(this,"webIfc",new Cn),x(this,"enabled",!0),this.components.add(Hi.uuid,this)}dispose(){this.webIfc=null,this.onDisposed.trigger(Hi.uuid),this.onDisposed.reset()}async setup(t){this.settings={...this.settings,...t},this.settings.autoSetWasm&&await this.autoSetWasm(),this.onSetup.trigger()}async load(t,e,s,i){const n=this.components.get(ct);if(!n.initialized)throw new Error("You need to initialize fragments first.");this.settings.autoSetWasm&&await this.autoSetWasm(),n.core.settings.autoCoordinate=e;const r=new Xo;r.wasm.path=this.settings.wasm.path,r.wasm.absolute=this.settings.wasm.absolute,r.webIfcSettings=this.settings.webIfc,this.onIfcImporterInitialized.trigger(r),i!=null&&i.instanceCallback&&i.instanceCallback(r);const o=await r.process({...i==null?void 0:i.processData,bytes:t});return await n.core.load(o,{modelId:s,userData:i==null?void 0:i.userData})}async readIfcFile(t){const{path:e,absolute:s,logLevel:i}=this.settings.wasm;return this.webIfc.SetWasmPath(e,s),await this.webIfc.Init(this.settings.customLocateFileHandler||void 0),i&&this.webIfc.SetLogLevel(i),this.webIfc.OpenModel(t,this.settings.webIfc)}cleanUp(){try{this.webIfc.Dispose()}catch{console.log("Web-ifc wasn't disposed.")}this.webIfc=null,this.webIfc=new Cn}async autoSetWasm(){const t=await fetch(`https://unpkg.com/@thatopen/components@${ho.release}/package.json`);if(!t.ok){console.warn("Couldn't get openbim-components package.json. Set wasm settings manually.");return}const e=await t.json();if(!("web-ifc"in e.peerDependencies))console.warn("Couldn't get web-ifc from peer dependencies in openbim-components. Set wasm settings manually.");else{const s=e.peerDependencies["web-ifc"];this.settings.wasm.path=`https://unpkg.com/web-ifc@${s}/`,this.settings.wasm.absolute=!0}}};x(Ur,"uuid","a659add7-1418-4771-a0d6-7d4d438e4624");let _h=Ur;const Fr=class Vr extends Dt{constructor(t){super(t),x(this,"enabled",!0),this.components.add(Vr.uuid,this)}async set(t,e){const s=this.components.get(ct),i=[];if(e)for(const[n,r]of Object.entries(e)){const o=s.list.get(n);o&&i.push(o.setVisible([...r],t))}else for(const n of s.list.values())i.push(n.setVisible(void 0,t));await Promise.all(i),await s.core.update(!0)}async isolate(t){await Promise.all([this.set(!1),this.set(!0,t)])}async toggle(t){const e=[],s=this.components.get(ct);for(const[i,n]of Object.entries(t)){const r=s.list.get(i);r&&e.push(r.toggleVisible([...n]))}await Promise.all(e),await s.core.update(!0)}async getVisibilityMap(t,e){const s=[],i=[],n=this.components.get(ct);if(e)for(const l of e){const c=n.list.get(l);c&&(s.push(c.modelId),i.push(c.getItemsByVisibility(t)))}else for(const l of n.list.values())s.push(l.modelId),i.push(l.getItemsByVisibility(t));const r=await Promise.all(i),o={};for(const[l,c]of s.entries())o[c]=r[l];return o}};x(Fr,"uuid","dd9ccf2d-8a21-4821-b7f6-2949add16a29");let _l=Fr;const Hr=class $i extends Dt{constructor(t){super(t),x(this,"enabled",!0),x(this,"onDisposed",new it),x(this,"list",new we),this.components.add($i.uuid,this)}dispose(t=!0){this.list.clear(),this.onDisposed.trigger($i.uuid),t&&(this.onDisposed.reset(),this.list.eventsEnabled=!1,this.list.dispose())}get(){const t=new Ft;for(const e of this.list)t.union(e);return t}async addFromModelIdMap(t){const e=this.components.get(ct),s=new Ft;for(const[i,n]of Object.entries(t)){const r=e.list.get(i);if(!r)continue;const o=await r.getMergedBox([...n]);s.union(o)}this.list.add(s)}addFromModels(t){const e=this.components.get(ct);for(const[s,i]of e.list)t&&!t.some(n=>n.test(s))||this.list.add(i.box)}async getCenter(t){this.list.clear(),await this.addFromModelIdMap(t);const e=this.get();this.list.clear();const s=new V;return e.getCenter(s),s}async getCameraOrientation(t,e=1){const s=this.components.get(ct);this.list.clear();for(const[c,h]of s.list)this.list.add(h.box);const i=this.get();this.list.clear();const n=new V;i.getCenter(n);const r=new V;i.getSize(r);const o=Math.max(r.x,r.y,r.z)*e,l=new V;switch(t){case"front":l.set(n.x,n.y,n.z+o);break;case"back":l.set(n.x,n.y,n.z-o);break;case"left":l.set(n.x-o,n.y,n.z);break;case"right":l.set(n.x+o,n.y,n.z);break;case"top":l.set(n.x,n.y+o,n.z);break;case"bottom":l.set(n.x,n.y-o,n.z);break;default:l.set(n.x,n.y,n.z+o)}return{position:l,target:n}}};x(Hr,"uuid","d1444724-dba6-4cdd-a0c7-68ee1450d166");let $r=Hr;class yl{constructor(t,e){x(this,"name","Query"),x(this,"customData",{}),x(this,"_components"),x(this,"_queries",[]),x(this,"_aggregation","exclusive"),x(this,"result",null),x(this,"cache",!0),x(this,"serializeQueryParameters",s=>{var i;return{categories:(i=s.categories)==null?void 0:i.map(r=>r.source),attributes:s.attributes?{aggregation:s.attributes.aggregation,queries:s.attributes.queries.map(this.serializeAttributeQuery)}:void 0,relation:s.relation?{name:s.relation.name,query:s.relation.query?this.serializeQueryParameters(s.relation.query):void 0}:void 0}}),x(this,"deserializeQueryParameters",s=>{var i;return{categories:(i=s.categories)==null?void 0:i.map(r=>new RegExp(r)),attributes:s.attributes?{aggregation:s.attributes.aggregation,queries:s.attributes.queries.map(this.deserializeAttributeQuery)}:void 0,relation:s.relation?{name:s.relation.name,query:s.relation.query?this.deserializeQueryParameters(s.relation.query):void 0}:void 0}}),this._components=t,this.queries=e}set queries(t){this._queries=t,this.clearCache()}get queries(){return this._queries}set aggregation(t){t!==this._aggregation&&this.clearCache(),this._aggregation=t}get aggregation(){return this._aggregation}async test(t){const{modelIds:e,force:s}={force:!1,...t};if(this.result&&!s)return this.result;const n=await this._components.get(Ts).getItems(this.queries,{modelIds:e,aggregation:this.aggregation});return this.cache&&(this.result=n),n}clearCache(){this.result=null}serializeAttributeQuery(t){let e;return Array.isArray(t.value)?e=t.value.map(i=>i.source):t.value instanceof RegExp?e=t.value.source:e=t.value,{name:t.name.source,value:e,type:t.type instanceof RegExp?t.type.source:t.type,negate:t.negate,itemIds:t.itemIds}}toJSON(){return{guid:this._components.get(Ts).list.getKey(this)??qt.create(),name:this.name,customData:this.customData,queries:this.queries.map(this.serializeQueryParameters),aggregation:this.aggregation,cache:this.cache}}deserializeAttributeQuery(t){let e;return Array.isArray(t.value)?e=t.value.map(i=>new RegExp(i)):typeof t.value=="string"?e=new RegExp(t.value):e=t.value,{name:new RegExp(t.name),value:e,type:t.type?new RegExp(t.type):void 0,negate:t.negate,itemIds:t.itemIds}}fromJSON(t){return this.name=t.name,this.customData=t.customData,this.aggregation=t.aggregation,this.cache=t.cache,this.queries=t.queries.map(this.deserializeQueryParameters),this}}const Zr=class Yr extends Dt{constructor(t){super(t),x(this,"enabled",!0),x(this,"list",new Nt),t.add(Yr.uuid,this)}async getItems(t,e){let s;if(e){const{modelIds:l,items:c}=e;if(c){const h=Object.keys(c);h.length>0&&(s=h.map(d=>new RegExp(`^${d}$`)))}else l&&(s=l)}const i=(e==null?void 0:e.aggregation)??"exclusive",n=this.components.get(ct),r=await Promise.all(t.map(async l=>{const c={};return await Promise.all(Array.from(n.list).map(async([h,d])=>{var f;if(s&&!s.some(g=>g.test(h)))return;const u=(f=e==null?void 0:e.items)==null?void 0:f[h],m=await d.getItemsByQuery(l,{localIds:u?[...u]:void 0});c[h]=new Set(m)})),c}));return i==="inclusive"?Mt.join(r):Mt.intersect(r)}create(t,e){const s=new yl(this.components,e);return this.list.set(t,s),s}async addFromCategories(t){const e=new Set,s=this.components.get(ct);for(const[i,n]of s.list){if(t&&!t.some(l=>l.test(i)))continue;const r=(await n.getItemsWithGeometryCategories()).filter(l=>l!==null),o=new Set(r);for(const l of o)this.list.has(l)||(this.create(l,[{categories:[new RegExp(`^${l}$`)]}]),e.add(l))}return[...e]}import(t){const{data:e}=t,s=[];if(!e)return s;for(const i of e){const n=this.create(i.guid,[]);n.fromJSON(i),s.push(n)}return s}export(){const t=[];for(const[e,s]of this.list.entries()){const n={...s.toJSON(),name:e};t.push(n)}return{data:t}}};x(Zr,"uuid","0da7ad77-f734-42ca-942f-a074adfd1e3a");let Ts=Zr;const jr=class Wr extends Dt{constructor(t){super(t),x(this,"enabled",!0),x(this,"onDisposed",new it),x(this,"list",new Nt),x(this,"defaultSaveFunction",s=>"value"in s.Name?s.Name.value:null),x(this,"onBeforeFragmentsDispose",async s=>{const{key:i,value:n}=s,r=await n.getLocalIds(),o={[i]:new Set(r)};this.removeItems(o)}),t.add(Wr.uuid,this),this.setupEvents(),t.get(ct).list.onBeforeDelete.add(this.onBeforeFragmentsDispose)}setupEvents(){this.list.onBeforeDelete.add(({value:t})=>t.dispose())}getClassificationGroups(t){let e=this.list.get(t);return e||(e=new Nt,this.list.set(t,e)),e}getModelItems(t,e,s){const{map:i}=this.getGroupData(t,e);let n=i[s];return n||(n=new Set,i[s]=n),n}getGroupData(t,e){const s=this.components.get(Ts),i=this.getClassificationGroups(t);let n=i.get(e);return n||(n={map:{},get(){return new Promise(r=>{if(!n){r({});return}if(n.query){const{name:o,config:l}=n.query,c=s.list.get(o);if(!c)throw new Error("Classifier: the query name associated with the group doesn't exist in the ItemsFinder component");c.test(l).then(h=>{if(!n){r({});return}const d=Mt.join([h,n.map]);r(d)})}else r(n.map)})}},i.set(e,n)),n}async aggregateItems(t,e,s){const i=(s==null?void 0:s.data)??void 0,n=(s==null?void 0:s.aggregationCallback)??this.defaultSaveFunction,r=this.components.get(ct),l=await this.components.get(Ts).getItems([e],{modelIds:s==null?void 0:s.modelIds});for(const[c,h]of Object.entries(l)){const d=r.list.get(c);if(!d)continue;const f=(m,...g)=>{const _=this.getModelItems(t,m,c);for(const p of g)_.add(p)},u=await d.getItemsData([...h],i);for(const m of u)n(m,f)}}addGroupItems(t,e,s){const{map:i}=this.getGroupData(t,e);Mt.add(i,s)}setGroupQuery(t,e,s){const i=this.getGroupData(t,e);i.query=s}async find(t){const e=[];for(const[i,n]of Object.entries(t)){const r=[],o=this.list.get(i);if(!o)continue;for(const c of n){const h=o.get(c);if(!h)continue;const d=await h.get();r.push(d)}const l=Mt.join(r);e.push(l)}return Mt.intersect(e)}async aggregateItemRelations(t,e,s,i){const n=(i==null?void 0:i.attribute)??"Name",r={relations:{[s]:{attributes:!0,relations:!1}}};await this.aggregateItems(t,e,{modelIds:i==null?void 0:i.modelIds,data:r,aggregationCallback:(o,l)=>{if(!(o!=null&&o[n]))return;const c=o[n];if(!("value"in c))return;const h=o[s];if(Array.isArray(h))for(const d of h)"value"in d._localId&&l(c.value,d._localId.value)}})}async byIfcBuildingStorey(t){await this.aggregateItemRelations((t==null?void 0:t.classificationName)??"Storeys",{categories:[/BUILDINGSTOREY/]},"ContainsElements",{modelIds:t==null?void 0:t.modelIds})}async byCategory(t){const s=await this.components.get(Ts).addFromCategories(t==null?void 0:t.modelIds);for(const i of s)this.setGroupQuery((t==null?void 0:t.classificationName)??"Categories",i,{name:i})}dispose(){this.list.clear(),this.components.get(ct).list.onBeforeDelete.remove(this.onBeforeFragmentsDispose),this.onDisposed.trigger()}removeItems(t,e){if(e&&e.classificationName){const s=this.list.get(e.classificationName);if(!s||e.groupName&&!s.get(e.groupName))return;for(const[,i]of s)Mt.remove(i.map,t);return}for(const[,s]of this.list.entries())for(const[,i]of s)Mt.remove(i.map,t)}async byModel(t){const e=this.components.get(ct),s=(t==null?void 0:t.classificationName)??"Models";for(const[i,n]of e.list){if(t&&t.modelIds&&!t.modelIds.some(l=>l.test(i)))continue;const r=await n.getItemsIdsWithGeometry(),o={[i]:new Set(r)};this.getGroupData(s,i),this.addGroupItems(s,i,o)}}};x(jr,"uuid","e25a7f3c-46c4-4a14-9d3d-5115f24ebeb7");let yh=jr;class wl{constructor(t,e){x(this,"enabled",!0),x(this,"components"),x(this,"onDisposed",new it),x(this,"mouse"),x(this,"world"),x(this,"debugMode",!1),x(this,"colorToModelId",new Map),x(this,"modelIdToColor",new Map),x(this,"renderTarget"),x(this,"renderTargetSize",new Wt),x(this,"debugCanvas"),x(this,"debugContainer"),x(this,"colorMaterials",new Map),x(this,"originalMaterials",new Map),x(this,"originalLodColors",new Map),x(this,"colorsNeedUpdate",!0);const s=e.renderer;if(!s)throw new Error("A renderer is needed for the FastModelPicker to work!");this.world=e,this.mouse=new Lr(s.three.domElement),this.components=t,this.setupRenderTarget(),this.setupFragmentListeners()}setupFragmentListeners(){const t=this.components.get(ct);t.list.onItemSet.add(()=>{this.colorsNeedUpdate=!0}),t.list.onItemDeleted.add(()=>{this.colorsNeedUpdate=!0})}setupRenderTarget(){const e=this.world.renderer.three.getSize(new Wt);this.renderTargetSize.copy(e),this.renderTarget=new Fo(e.x,e.y),this.renderTarget.texture.format=Vo,this.renderTarget.texture.type=Ho,this.debugMode&&this.setupDebugCanvas(),this.world.renderer.onResize.add(s=>{this.renderTargetSize.copy(s),this.renderTarget.setSize(s.x,s.y),this.debugCanvas&&(this.debugCanvas.width=s.x,this.debugCanvas.height=s.y)})}setupDebugCanvas(){if(this.debugCanvas)return;const t=this.world.renderer.three.getSize(new Wt);this.debugContainer=document.createElement("div"),this.debugContainer.style.position="fixed",this.debugContainer.style.top="10px",this.debugContainer.style.right="10px",this.debugContainer.style.width="300px",this.debugContainer.style.height="300px",this.debugContainer.style.border="2px solid #fff",this.debugContainer.style.backgroundColor="#000",this.debugContainer.style.zIndex="10000",this.debugContainer.style.pointerEvents="none",this.debugCanvas=document.createElement("canvas"),this.debugCanvas.width=t.x,this.debugCanvas.height=t.y,this.debugCanvas.style.width="100%",this.debugCanvas.style.height="100%",this.debugCanvas.style.imageRendering="pixelated",this.debugContainer.appendChild(this.debugCanvas),document.body.appendChild(this.debugContainer)}generateColorForModel(t){let e=0;for(let o=0;o<t.length;o++)e=(e<<5)-e+t.charCodeAt(o),e&=e;let s=Math.abs(e)%16777215;s===0&&(s=1);const i=s>>16&255||1,n=s>>8&255||1,r=s&255||1;return new zt(i/255,n/255,r/255)}colorToId(t){const e=Math.round(t.r*255),s=Math.round(t.g*255),i=Math.round(t.b*255);return e<<16|s<<8|i}assignColors(){const t=this.components.get(ct);if(t.initialized){if(!this.colorsNeedUpdate){const e=new Set(t.list.keys()),s=new Set(this.modelIdToColor.keys());(e.size!==s.size||[...e].some(i=>!s.has(i)))&&(this.colorsNeedUpdate=!0)}if(this.colorsNeedUpdate){this.colorToModelId.clear(),this.modelIdToColor.clear();for(const e of this.colorMaterials.values())e.dispose();this.colorMaterials.clear();for(const[e]of t.list){const s=this.generateColorForModel(e),i=this.colorToId(s);this.colorToModelId.set(i,e),this.modelIdToColor.set(e,s);const n=new Os({color:s,depthTest:!0,depthWrite:!0});this.colorMaterials.set(e,n)}this.colorsNeedUpdate=!1}}}applyColorMaterials(){const t=this.components.get(ct);if(t.initialized)for(const[e,s]of t.list){const i=this.colorMaterials.get(e);i&&s.object.traverse(n=>{if(n instanceof et){if("isLODGeometry"in n.geometry){const o=n.material[0].uniforms.lodColor;this.originalLodColors.has(o)||this.originalLodColors.set(o,o.value),o.value=i.color;return}this.originalMaterials.has(n)||this.originalMaterials.set(n,n.material),n.material=i}})}}restoreOriginalMaterials(){for(const[t,e]of this.originalMaterials)t.material=e;for(const[t,e]of this.originalLodColors)t.value=e;this.originalMaterials.clear()}renderColorCoded(){if(!this.renderTarget||!this.world.renderer)throw new Error("Render target not initialized!");const t=this.world.renderer.three,e=this.world.scene.three,s=this.world.camera.three,i=t.getRenderTarget(),n=t.autoClear,r=new zt,o=t.getClearAlpha();t.getClearColor(r),this.applyColorMaterials(),t.setRenderTarget(this.renderTarget),t.autoClear=!0,t.setClearColor(0,1),t.clear(!0,!0,!1),t.render(e,s),t.setRenderTarget(i),t.autoClear=n,t.setClearColor(r,o),this.restoreOriginalMaterials(),this.debugMode&&this.debugCanvas&&this.updateDebugCanvas()}updateDebugCanvas(){if(!this.debugCanvas||!this.renderTarget||!this.world.renderer)return;const t=this.world.renderer.three,e=this.renderTargetSize,s=new Uint8Array(e.x*e.y*4);t.readRenderTargetPixels(this.renderTarget,0,0,e.x,e.y,s);const i=this.debugCanvas.getContext("2d");if(!i)return;const n=i.createImageData(e.x,e.y),r=e.x*4;for(let o=0;o<e.y;o++){const l=o,c=e.y-1-o,h=l*r,d=c*r;n.data.set(s.subarray(h,h+r),d)}i.putImageData(n,0,0)}async getModelAt(t){if(!this.renderTarget||!this.world.renderer)throw new Error("Render target not initialized!");const e=this.components.get(ct);if(!e.initialized||e.list.size===0)return null;this.assignColors(),this.renderColorCoded();const s=t||this.mouse.position,i=this.renderTargetSize,n=Math.floor((s.x+1)*.5*i.x),r=Math.floor((s.y+1)*.5*(i.y-1)),o=Math.max(0,Math.min(i.x-1,n)),l=Math.max(0,Math.min(i.y-1,r)),c=this.world.renderer.three,h=new Uint8Array(4);c.readRenderTargetPixels(this.renderTarget,o,l,1,1,h);const d=h[0],f=h[1],u=h[2],m=d<<16|f<<8|u;return this.colorToModelId.get(m)||null}setDebugMode(t){this.debugMode=t,t?this.setupDebugCanvas():this.removeDebugCanvas()}removeDebugCanvas(){this.debugContainer&&(this.debugContainer.remove(),this.debugContainer=void 0,this.debugCanvas=void 0)}dispose(){this.mouse.dispose(),this.removeDebugCanvas();for(const t of this.colorMaterials.values())t.dispose();this.colorMaterials.clear(),this.renderTarget&&this.renderTarget.dispose(),this.colorToModelId.clear(),this.modelIdToColor.clear(),this.originalMaterials.clear(),this.originalLodColors.clear(),this.onDisposed.trigger(),this.onDisposed.reset()}}const Xr=class qr extends Dt{constructor(t){super(t),x(this,"enabled",!0),x(this,"list",new Map),x(this,"onDisposed",new it),t.add(qr.uuid,this)}get(t){if(this.list.has(t.uuid))return this.list.get(t.uuid);const e=new wl(this.components,t);return this.list.set(t.uuid,e),t.onDisposed.add(()=>{this.delete(t)}),e}delete(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}};x(Xr,"uuid","4a82430c-7ff2-49ea-9401-60807502dad6");let vl=Xr;class bl{constructor(t,e){x(this,"enabled",!0),x(this,"components"),x(this,"onDisposed",new it),x(this,"mouse"),x(this,"three",new en),x(this,"world"),x(this,"useFastModelPicking",!1);const s=e.renderer;if(!s)throw new Error("A renderer is needed for the raycaster to work!");this.world=e,this.mouse=new Lr(s.three.domElement),this.components=t}dispose(){this.mouse.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}castRayToObjects(t=Array.from(this.world.meshes),e=this.mouse.position){if(!this.world)throw new Error("A world is needed to cast rays!");const s=this.world.camera.three;return this.three.setFromCamera(e,s),this.intersect(t)}async castRay(t){const e=t==null?void 0:t.snappingClasses,s=(t==null?void 0:t.items)??Array.from(this.world.meshes),i=(t==null?void 0:t.position)??this.mouse.position;if(!this.world)throw new Error("A world is needed to cast rays!");const n=this.world.camera.three,r=this.components.get(ct),o=this.world.renderer.three.domElement,l=this.mouse.rawPosition;let c=null;if(r.initialized){if(this.useFastModelPicking){const u=await this.components.get(vl).get(this.world).getModelAt(i);if(u){const m=r.list.get(u);if(m)if(e&&e.length>0){const g=await m.raycastWithSnapping({camera:n,dom:o,mouse:l,snappingClasses:e});g&&g.length>0?c=g[0]:c=await m.raycast({camera:n,dom:o,mouse:l})}else c=await m.raycast({camera:n,dom:o,mouse:l})}}else c=await r.raycast({camera:n,dom:o,mouse:l,snappingClasses:e});if(s.length===0)return c}this.three.setFromCamera(i,n);const h=this.intersect(s);return c?h&&h.distance<c.distance?h:c:h}castRayFromVector(t,e,s=Array.from(this.world.meshes)){return this.three.set(t,e),this.intersect(s)}intersect(t=Array.from(this.world.meshes)){const e=this.three.intersectObjects(t),s=this.filterClippingPlanes(e);return s.length>0?s[0]:null}filterClippingPlanes(t){if(!this.world.renderer)throw new Error("Renderer not found!");const e=this.world.renderer.three;if(!e.clippingPlanes)return t;const s=e.clippingPlanes;return t.length<=0||!s||(s==null?void 0:s.length)<=0?t:t.filter(i=>s.every(n=>n.distanceToPoint(i.point)>0))}}const Gr=class Qr extends Dt{constructor(t){super(t),x(this,"enabled",!0),x(this,"list",new Map),x(this,"onDisposed",new it),t.add(Qr.uuid,this)}get(t){if(this.list.has(t.uuid))return this.list.get(t.uuid);const e=new bl(this.components,t);return this.list.set(t.uuid,e),t.onDisposed.add(()=>{this.delete(t)}),e}delete(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}};x(Gr,"uuid","d5d8bdf0-db25-4952-b951-b643af207ace");let Ke=Gr;class xl extends rn{constructor(){super(...arguments),x(this,"onCameraChanged",new it),x(this,"meshes",new Set),x(this,"onAfterUpdate",new it),x(this,"onBeforeUpdate",new it),x(this,"onDisposed",new it),x(this,"isDisposing",!1),x(this,"enabled",!0),x(this,"_dynamicAnchor",!1),x(this,"uuid",qt.create()),x(this,"name"),x(this,"_scene"),x(this,"_camera"),x(this,"_renderer",null),x(this,"onPointerDown",async t=>{if(!this.camera.hasCameraControls())throw new Error("World: can't set dynamic anchor if the camera doesn't have controls.");const s=await this.components.get(Ke).get(this).castRay();s&&s.point&&t.button===0&&this.camera.controls.setOrbitPoint(s.point.x,s.point.y,s.point.z)}),x(this,"_defaultCamera")}set dynamicAnchor(t){var e;const s=(e=this.renderer)==null?void 0:e.three.domElement.parentElement;if(!s)throw new Error("World: the renderer must have a parentElement to set dynamic anchoring.");t?(this.camera.controls&&(this.camera.controls.minDistance=.01),s.addEventListener("pointerdown",this.onPointerDown)):s.removeEventListener("pointerdown",this.onPointerDown)}get dynamicAnchor(){return this._dynamicAnchor}get defaultCamera(){if(!this._defaultCamera)throw new Error("World: there is no default camera defined.");return this._defaultCamera}set defaultCamera(t){this._defaultCamera=t}get scene(){if(!this._scene)throw new Error("No scene initialized!");return this._scene}set scene(t){this._scene=t,t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"})}get camera(){if(!this._camera)throw new Error("No camera initialized!");return this._camera}set camera(t){this._camera||(this.defaultCamera=t),this._camera=t,t.currentWorld=this,this.onCameraChanged.trigger(t)}get renderer(){return this._renderer}set renderer(t){this._renderer=t,t&&(t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"}))}useDefaultCamera(){this.camera=this.defaultCamera}update(t){this.enabled&&(!this._scene||!this._camera||(this.scene.currentWorld=this,this.camera.currentWorld=this,this.renderer&&(this.renderer.currentWorld=this),this.onBeforeUpdate.trigger(),this.scene.isUpdateable()&&this.scene.update(t),this.camera.isUpdateable()&&this.camera.update(t),this.renderer&&this.renderer.update(t),this.onAfterUpdate.trigger()))}dispose(t=!0){if(this.enabled=!1,this.isDisposing=!0,this.scene.onWorldChanged.trigger({world:this,action:"removed"}),this.camera.onWorldChanged.trigger({world:this,action:"removed"}),this.renderer&&this.renderer.onWorldChanged.trigger({world:this,action:"removed"}),t){const s=this.components.get(hi);this.scene.dispose(),this.camera.isDisposeable()&&this.camera.dispose(),this.renderer&&this.renderer.dispose();for(const i of this.meshes)s.destroy(i);this.meshes.clear()}this._scene=null,this._camera=null,this._renderer=null,this.components.get(eo).list.delete(this.uuid),this.onDisposed.trigger(),this.onDisposed.reset()}}class Cl{constructor(t,e){x(this,"_list"),x(this,"_scene"),this._list=t,this._scene=e}get color(){return this._list.directionalLight.color.value}set color(t){this._list.directionalLight.color.value=t;for(const[,e]of this._scene.directionalLights)e.color.copy(t)}get intensity(){return this._list.directionalLight.intensity.value}set intensity(t){this._list.directionalLight.intensity.value=t;for(const[,e]of this._scene.directionalLights)e.intensity=t}get position(){return this._list.directionalLight.position.value.clone()}set position(t){this._list.directionalLight.position.value=t;for(const[,e]of this._scene.directionalLights)e.position.copy(t)}}class Tl{constructor(t,e){x(this,"_list"),x(this,"_scene"),this._list=t,this._scene=e}get color(){return this._list.ambientLight.color.value}set color(t){this._list.ambientLight.color.value=t;for(const[,e]of this._scene.ambientLights)e.color.copy(t)}get intensity(){return this._list.ambientLight.intensity.value}set intensity(t){this._list.ambientLight.intensity.value=t;for(const[,e]of this._scene.ambientLights)e.intensity=t}}class El extends Ps{constructor(){super(...arguments),x(this,"_config",{backgroundColor:{value:new zt,type:"Color"},ambientLight:{color:{type:"Color",value:new zt},intensity:{type:"Number",interpolable:!0,min:0,max:10,value:2}},directionalLight:{color:{type:"Color",value:new zt},intensity:{type:"Number",interpolable:!0,min:0,max:10,value:2},position:{type:"Vector3",value:new V}}}),x(this,"ambientLight",new Tl(this._config,this._component)),x(this,"directionalLight",new Cl(this._config,this._component))}get backgroundColor(){return this._config.backgroundColor.value}set backgroundColor(t){this._config.backgroundColor.value=t,this._component.three.background=t}}class wh extends ta{constructor(t){super(t),x(this,"onSetup",new it),x(this,"isSetup",!1),x(this,"three"),x(this,"config",new El(this,this.components,"Scene")),x(this,"_defaultConfig",{backgroundColor:new zt(2107698),directionalLight:{color:new zt("white"),intensity:1.5,position:new V(5,10,3)},ambientLight:{color:new zt("white"),intensity:1}}),this.three=new Er,this.three.background=new zt(2107698)}setup(t){const e={...this._defaultConfig,...t};this.config.backgroundColor=e.backgroundColor;const s=e.ambientLight;this.config.ambientLight.color=s.color,this.config.ambientLight.intensity=s.intensity;const i=e.directionalLight;this.config.directionalLight.color=i.color,this.config.directionalLight.intensity=i.intensity,this.config.directionalLight.position=i.position,this.deleteAllLights();const{color:n,intensity:r}=this.config.directionalLight,o=new Zo(n,r);o.position.copy(i.position);const{color:l,intensity:c}=this.config.directionalLight,h=new Yo(l,c);this.three.add(o,h),this.directionalLights.set(o.uuid,o),this.ambientLights.set(h.uuid,h),this.isSetup=!0,this.onSetup.trigger()}dispose(){super.dispose(),this.components.get(pi).list.delete(this.config.uuid)}}var Sl=(a=>(a[a.MANUAL=0]="MANUAL",a[a.AUTO=1]="AUTO",a))(Sl||{});class Al extends Jo{constructor(t,e,s){super(t),x(this,"enabled",!0),x(this,"container"),x(this,"three"),x(this,"mode",1),x(this,"needsUpdate",!1),x(this,"_canvas"),x(this,"_parameters"),x(this,"_resizeObserver",null),x(this,"onContainerUpdated",new it),x(this,"_resizing",!1),x(this,"resize",r=>{if(this._resizing)return;this._resizing=!0,this.onContainerUpdated.trigger();const o=r?r.x:this.container.clientWidth,l=r?r.y:this.container.clientHeight;this.three.setSize(o,l),this.onResize.trigger(new Wt(o,l)),this._resizing=!1}),x(this,"resizeEvent",()=>{this.resize()}),x(this,"onContextLost",r=>{r.preventDefault(),this.enabled=!1}),x(this,"onContextBack",()=>{this.three.setRenderTarget(null),this.three.dispose(),this.three=new bn({canvas:this._canvas,antialias:!0,alpha:!0,...this._parameters}),this.enabled=!0}),this.container=e,this._parameters=s,this.three=new bn({antialias:!0,alpha:!0,...s}),this.three.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.setupRenderer(),this.setupEvents(!0),this.resize(),this._canvas=this.three.domElement;const i=this.three.getContext(),{canvas:n}=i;n.addEventListener("webglcontextlost",this.onContextLost,!1),n.addEventListener("webglcontextrestored",this.onContextBack,!1)}update(){if(!this.enabled||!this.currentWorld||this.mode===0&&!this.needsUpdate)return;this.needsUpdate=!1,this.onBeforeUpdate.trigger(this);const t=this.currentWorld.scene.three,e=this.currentWorld.camera.three;this.three.render(t,e),this.onAfterUpdate.trigger(this)}dispose(){this.enabled=!1,this.setupEvents(!1),this.three.domElement.remove(),this.three.forceContextLoss(),this.three.dispose(),this.onResize.reset(),this.onAfterUpdate.reset(),this.onBeforeUpdate.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}getSize(){return new Wt(this.three.domElement.clientWidth,this.three.domElement.clientHeight)}setupEvents(t){const e=this.three.domElement.parentElement;if(!e)throw new Error("This renderer needs to have an HTML container!");this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),window.removeEventListener("resize",this.resizeEvent),t&&(this._resizeObserver=new ResizeObserver(this.resizeEvent),this._resizeObserver.observe(e),window.addEventListener("resize",this.resizeEvent))}setupRenderer(){this.three.localClippingEnabled=!0,this.container&&this.container.appendChild(this.three.domElement),this.onContainerUpdated.trigger()}}/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */const xt={LEFT:1,RIGHT:2,MIDDLE:4},B=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,SCREEN_PAN:4,OFFSET:8,DOLLY:16,ZOOM:32,TOUCH_ROTATE:64,TOUCH_TRUCK:128,TOUCH_SCREEN_PAN:256,TOUCH_OFFSET:512,TOUCH_DOLLY:1024,TOUCH_ZOOM:2048,TOUCH_DOLLY_TRUCK:4096,TOUCH_DOLLY_SCREEN_PAN:8192,TOUCH_DOLLY_OFFSET:16384,TOUCH_DOLLY_ROTATE:32768,TOUCH_ZOOM_TRUCK:65536,TOUCH_ZOOM_OFFSET:131072,TOUCH_ZOOM_SCREEN_PAN:262144,TOUCH_ZOOM_ROTATE:524288}),De={NONE:0,IN:1,OUT:-1};function Ie(a){return a.isPerspectiveCamera}function Te(a){return a.isOrthographicCamera}const Le=Math.PI*2,Pn=Math.PI/2,Kr=1e-5,as=Math.PI/180;function re(a,t,e){return Math.max(t,Math.min(e,a))}function yt(a,t=Kr){return Math.abs(a)<t}function ft(a,t,e=Kr){return yt(a-t,e)}function In(a,t){return Math.round(a/t)*t}function ls(a){return isFinite(a)?a:a<0?-Number.MAX_VALUE:Number.MAX_VALUE}function cs(a){return Math.abs(a)<Number.MAX_VALUE?a:a*(1/0)}function Ns(a,t,e,s,i=1/0,n){s=Math.max(1e-4,s);const r=2/s,o=r*n,l=1/(1+o+.48*o*o+.235*o*o*o);let c=a-t;const h=t,d=i*s;c=re(c,-d,d),t=a-c;const f=(e.value+r*c)*n;e.value=(e.value-r*f)*l;let u=t+(c+f)*l;return h-a>0==u>h&&(u=h,e.value=(u-h)/n),u}function kn(a,t,e,s,i=1/0,n,r){s=Math.max(1e-4,s);const o=2/s,l=o*n,c=1/(1+l+.48*l*l+.235*l*l*l);let h=t.x,d=t.y,f=t.z,u=a.x-h,m=a.y-d,g=a.z-f;const _=h,p=d,y=f,b=i*s,C=b*b,T=u*u+m*m+g*g;if(T>C){const z=Math.sqrt(T);u=u/z*b,m=m/z*b,g=g/z*b}h=a.x-u,d=a.y-m,f=a.z-g;const S=(e.x+o*u)*n,A=(e.y+o*m)*n,M=(e.z+o*g)*n;e.x=(e.x-o*S)*c,e.y=(e.y-o*A)*c,e.z=(e.z-o*M)*c,r.x=h+(u+S)*c,r.y=d+(m+A)*c,r.z=f+(g+M)*c;const P=_-a.x,N=p-a.y,H=y-a.z,E=r.x-_,k=r.y-p,w=r.z-y;return P*E+N*k+H*w>0&&(r.x=_,r.y=p,r.z=y,e.x=(r.x-_)/n,e.y=(r.y-p)/n,e.z=(r.z-y)/n),r}function wi(a,t){t.set(0,0),a.forEach(e=>{t.x+=e.clientX,t.y+=e.clientY}),t.x/=a.length,t.y/=a.length}function vi(a,t){return Te(a)?(console.warn(`${t} is not supported in OrthographicCamera`),!0):!1}class Ol{constructor(){this._listeners={}}addEventListener(t,e){const s=this._listeners;s[t]===void 0&&(s[t]=[]),s[t].indexOf(e)===-1&&s[t].push(e)}hasEventListener(t,e){const s=this._listeners;return s[t]!==void 0&&s[t].indexOf(e)!==-1}removeEventListener(t,e){const i=this._listeners[t];if(i!==void 0){const n=i.indexOf(e);n!==-1&&i.splice(n,1)}}removeAllEventListeners(t){if(!t){this._listeners={};return}Array.isArray(this._listeners[t])&&(this._listeners[t].length=0)}dispatchEvent(t){const s=this._listeners[t.type];if(s!==void 0){t.target=this;const i=s.slice(0);for(let n=0,r=i.length;n<r;n++)i[n].call(this,t)}}}var bi;const Pl="2.10.1",Ds=1/8,Il=/Mac/.test((bi=globalThis==null?void 0:globalThis.navigator)===null||bi===void 0?void 0:bi.platform);let ot,Mn,Ls,xi,jt,lt,dt,Re,hs,ue,de,ke,zn,Nn,Kt,us,Be,Dn,Ci,Ln,Ti,Ei,Rs;class Ut extends Ol{static install(t){ot=t.THREE,Mn=Object.freeze(new ot.Vector3(0,0,0)),Ls=Object.freeze(new ot.Vector3(0,1,0)),xi=Object.freeze(new ot.Vector3(0,0,1)),jt=new ot.Vector2,lt=new ot.Vector3,dt=new ot.Vector3,Re=new ot.Vector3,hs=new ot.Vector3,ue=new ot.Vector3,de=new ot.Vector3,ke=new ot.Vector3,zn=new ot.Vector3,Nn=new ot.Vector3,Kt=new ot.Spherical,us=new ot.Spherical,Be=new ot.Box3,Dn=new ot.Box3,Ci=new ot.Sphere,Ln=new ot.Quaternion,Ti=new ot.Quaternion,Ei=new ot.Matrix4,Rs=new ot.Raycaster}static get ACTION(){return B}set verticalDragToForward(t){console.warn("camera-controls: `verticalDragToForward` was removed. Use `mouseButtons.left = CameraControls.ACTION.SCREEN_PAN` instead.")}constructor(t,e){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=B.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=De.NONE,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new ot.Vector3,this._focalOffsetVelocity=new ot.Vector3,this._zoomVelocity={value:0},this._truckInternal=(p,y,b,C)=>{let T,S;if(Ie(this._camera)){const A=lt.copy(this._camera.position).sub(this._target),M=this._camera.getEffectiveFOV()*as,P=A.length()*Math.tan(M*.5);T=this.truckSpeed*p*P/this._elementRect.height,S=this.truckSpeed*y*P/this._elementRect.height}else if(Te(this._camera)){const A=this._camera;T=this.truckSpeed*p*(A.right-A.left)/A.zoom/this._elementRect.width,S=this.truckSpeed*y*(A.top-A.bottom)/A.zoom/this._elementRect.height}else return;C?(b?this.setFocalOffset(this._focalOffsetEnd.x+T,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(T,0,!0),this.forward(-S,!0)):b?this.setFocalOffset(this._focalOffsetEnd.x+T,this._focalOffsetEnd.y+S,this._focalOffsetEnd.z,!0):this.truck(T,S,!0)},this._rotateInternal=(p,y)=>{const b=Le*this.azimuthRotateSpeed*p/this._elementRect.height,C=Le*this.polarRotateSpeed*y/this._elementRect.height;this.rotate(b,C,!0)},this._dollyInternal=(p,y,b)=>{const C=Math.pow(.95,-p*this.dollySpeed),T=this._sphericalEnd.radius,S=this._sphericalEnd.radius*C,A=re(S,this.minDistance,this.maxDistance),M=A-S;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(S,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(M,!0),this._dollyToNoClamp(A,!0)):this._dollyToNoClamp(A,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?S:A)-T,this._dollyControlCoord.set(y,b)),this._lastDollyDirection=Math.sign(-p)},this._zoomInternal=(p,y,b)=>{const C=Math.pow(.95,p*this.dollySpeed),T=this._zoom,S=this._zoom*C;this.zoomTo(S,!0),this.dollyToCursor&&(this._changedZoom+=S-T,this._dollyControlCoord.set(y,b))},typeof ot>"u"&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=t,this._yAxisUpSpace=new ot.Quaternion().setFromUnitVectors(this._camera.up,Ls),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=B.NONE,this._target=new ot.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new ot.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=new ot.Spherical().setFromVector3(lt.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new ot.Vector3,new ot.Vector3,new ot.Vector3,new ot.Vector3],this._updateNearPlaneCorners(),this._boundary=new ot.Box3(new ot.Vector3(-1/0,-1/0,-1/0),new ot.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new ot.Vector2,this.mouseButtons={left:B.ROTATE,middle:B.DOLLY,right:B.TRUCK,wheel:Ie(this._camera)?B.DOLLY:Te(this._camera)?B.ZOOM:B.NONE},this.touches={one:B.TOUCH_ROTATE,two:Ie(this._camera)?B.TOUCH_DOLLY_TRUCK:Te(this._camera)?B.TOUCH_ZOOM_TRUCK:B.NONE,three:B.TOUCH_TRUCK};const s=new ot.Vector2,i=new ot.Vector2,n=new ot.Vector2,r=p=>{if(!this._enabled||!this._domElement)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const C=this._domElement.getBoundingClientRect(),T=p.clientX/C.width,S=p.clientY/C.height;if(T<this._interactiveArea.left||T>this._interactiveArea.right||S<this._interactiveArea.top||S>this._interactiveArea.bottom)return}const y=p.pointerType!=="mouse"?null:(p.buttons&xt.LEFT)===xt.LEFT?xt.LEFT:(p.buttons&xt.MIDDLE)===xt.MIDDLE?xt.MIDDLE:(p.buttons&xt.RIGHT)===xt.RIGHT?xt.RIGHT:null;if(y!==null){const C=this._findPointerByMouseButton(y);C&&this._disposePointer(C)}if((p.buttons&xt.LEFT)===xt.LEFT&&this._lockedPointer)return;const b={pointerId:p.pointerId,clientX:p.clientX,clientY:p.clientY,deltaX:0,deltaY:0,mouseButton:y};this._activePointers.push(b),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.ownerDocument.addEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",l),this._isDragging=!0,f(p)},o=p=>{p.cancelable&&p.preventDefault();const y=p.pointerId,b=this._lockedPointer||this._findPointerById(y);if(b){if(b.clientX=p.clientX,b.clientY=p.clientY,b.deltaX=p.movementX,b.deltaY=p.movementY,this._state=0,p.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(p.buttons&xt.LEFT)===xt.LEFT)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(p.buttons&xt.MIDDLE)===xt.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(p.buttons&xt.RIGHT)===xt.RIGHT&&(this._state=this._state|this.mouseButtons.right);u()}},l=p=>{const y=this._findPointerById(p.pointerId);if(!(y&&y===this._lockedPointer)){if(y&&this._disposePointer(y),p.pointerType==="touch")switch(this._activePointers.length){case 0:this._state=B.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else this._state=B.NONE;m()}};let c=-1;const h=p=>{if(!this._domElement||!this._enabled||this.mouseButtons.wheel===B.NONE)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const S=this._domElement.getBoundingClientRect(),A=p.clientX/S.width,M=p.clientY/S.height;if(A<this._interactiveArea.left||A>this._interactiveArea.right||M<this._interactiveArea.top||M>this._interactiveArea.bottom)return}if(p.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===B.ROTATE||this.mouseButtons.wheel===B.TRUCK){const S=performance.now();c-S<1e3&&this._getClientRect(this._elementRect),c=S}const y=Il?-1:-3,b=p.deltaMode===1||p.ctrlKey?p.deltaY/y:p.deltaY/(y*10),C=this.dollyToCursor?(p.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,T=this.dollyToCursor?(p.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case B.ROTATE:{this._rotateInternal(p.deltaX,p.deltaY),this._isUserControllingRotate=!0;break}case B.TRUCK:{this._truckInternal(p.deltaX,p.deltaY,!1,!1),this._isUserControllingTruck=!0;break}case B.SCREEN_PAN:{this._truckInternal(p.deltaX,p.deltaY,!1,!0),this._isUserControllingTruck=!0;break}case B.OFFSET:{this._truckInternal(p.deltaX,p.deltaY,!0,!1),this._isUserControllingOffset=!0;break}case B.DOLLY:{this._dollyInternal(-b,C,T),this._isUserControllingDolly=!0;break}case B.ZOOM:{this._zoomInternal(-b,C,T),this._isUserControllingZoom=!0;break}}this.dispatchEvent({type:"control"})},d=p=>{if(!(!this._domElement||!this._enabled)){if(this.mouseButtons.right===Ut.ACTION.NONE){const y=p instanceof PointerEvent?p.pointerId:0,b=this._findPointerById(y);b&&this._disposePointer(b),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l);return}p.preventDefault()}},f=p=>{if(!this._enabled)return;if(wi(this._activePointers,jt),this._getClientRect(this._elementRect),s.copy(jt),i.copy(jt),this._activePointers.length>=2){const b=jt.x-this._activePointers[1].clientX,C=jt.y-this._activePointers[1].clientY,T=Math.sqrt(b*b+C*C);n.set(0,T);const S=(this._activePointers[0].clientX+this._activePointers[1].clientX)*.5,A=(this._activePointers[0].clientY+this._activePointers[1].clientY)*.5;i.set(S,A)}if(this._state=0,!p)this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);else if("pointerType"in p&&p.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else!this._lockedPointer&&(p.buttons&xt.LEFT)===xt.LEFT&&(this._state=this._state|this.mouseButtons.left),(p.buttons&xt.MIDDLE)===xt.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(p.buttons&xt.RIGHT)===xt.RIGHT&&(this._state=this._state|this.mouseButtons.right);((this._state&B.ROTATE)===B.ROTATE||(this._state&B.TOUCH_ROTATE)===B.TOUCH_ROTATE||(this._state&B.TOUCH_DOLLY_ROTATE)===B.TOUCH_DOLLY_ROTATE||(this._state&B.TOUCH_ZOOM_ROTATE)===B.TOUCH_ZOOM_ROTATE)&&(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),((this._state&B.TRUCK)===B.TRUCK||(this._state&B.SCREEN_PAN)===B.SCREEN_PAN||(this._state&B.TOUCH_TRUCK)===B.TOUCH_TRUCK||(this._state&B.TOUCH_SCREEN_PAN)===B.TOUCH_SCREEN_PAN||(this._state&B.TOUCH_DOLLY_TRUCK)===B.TOUCH_DOLLY_TRUCK||(this._state&B.TOUCH_DOLLY_SCREEN_PAN)===B.TOUCH_DOLLY_SCREEN_PAN||(this._state&B.TOUCH_ZOOM_TRUCK)===B.TOUCH_ZOOM_TRUCK||(this._state&B.TOUCH_ZOOM_SCREEN_PAN)===B.TOUCH_DOLLY_SCREEN_PAN)&&(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),((this._state&B.DOLLY)===B.DOLLY||(this._state&B.TOUCH_DOLLY)===B.TOUCH_DOLLY||(this._state&B.TOUCH_DOLLY_TRUCK)===B.TOUCH_DOLLY_TRUCK||(this._state&B.TOUCH_DOLLY_SCREEN_PAN)===B.TOUCH_DOLLY_SCREEN_PAN||(this._state&B.TOUCH_DOLLY_OFFSET)===B.TOUCH_DOLLY_OFFSET||(this._state&B.TOUCH_DOLLY_ROTATE)===B.TOUCH_DOLLY_ROTATE)&&(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),((this._state&B.ZOOM)===B.ZOOM||(this._state&B.TOUCH_ZOOM)===B.TOUCH_ZOOM||(this._state&B.TOUCH_ZOOM_TRUCK)===B.TOUCH_ZOOM_TRUCK||(this._state&B.TOUCH_ZOOM_SCREEN_PAN)===B.TOUCH_ZOOM_SCREEN_PAN||(this._state&B.TOUCH_ZOOM_OFFSET)===B.TOUCH_ZOOM_OFFSET||(this._state&B.TOUCH_ZOOM_ROTATE)===B.TOUCH_ZOOM_ROTATE)&&(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),((this._state&B.OFFSET)===B.OFFSET||(this._state&B.TOUCH_OFFSET)===B.TOUCH_OFFSET||(this._state&B.TOUCH_DOLLY_OFFSET)===B.TOUCH_DOLLY_OFFSET||(this._state&B.TOUCH_ZOOM_OFFSET)===B.TOUCH_ZOOM_OFFSET)&&(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})},u=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,wi(this._activePointers,jt);const y=this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,b=y?-y.deltaX:i.x-jt.x,C=y?-y.deltaY:i.y-jt.y;if(i.copy(jt),((this._state&B.ROTATE)===B.ROTATE||(this._state&B.TOUCH_ROTATE)===B.TOUCH_ROTATE||(this._state&B.TOUCH_DOLLY_ROTATE)===B.TOUCH_DOLLY_ROTATE||(this._state&B.TOUCH_ZOOM_ROTATE)===B.TOUCH_ZOOM_ROTATE)&&(this._rotateInternal(b,C),this._isUserControllingRotate=!0),(this._state&B.DOLLY)===B.DOLLY||(this._state&B.ZOOM)===B.ZOOM){const T=this.dollyToCursor?(s.x-this._elementRect.x)/this._elementRect.width*2-1:0,S=this.dollyToCursor?(s.y-this._elementRect.y)/this._elementRect.height*-2+1:0,A=this.dollyDragInverted?-1:1;(this._state&B.DOLLY)===B.DOLLY?(this._dollyInternal(A*C*Ds,T,S),this._isUserControllingDolly=!0):(this._zoomInternal(A*C*Ds,T,S),this._isUserControllingZoom=!0)}if((this._state&B.TOUCH_DOLLY)===B.TOUCH_DOLLY||(this._state&B.TOUCH_ZOOM)===B.TOUCH_ZOOM||(this._state&B.TOUCH_DOLLY_TRUCK)===B.TOUCH_DOLLY_TRUCK||(this._state&B.TOUCH_ZOOM_TRUCK)===B.TOUCH_ZOOM_TRUCK||(this._state&B.TOUCH_DOLLY_SCREEN_PAN)===B.TOUCH_DOLLY_SCREEN_PAN||(this._state&B.TOUCH_ZOOM_SCREEN_PAN)===B.TOUCH_ZOOM_SCREEN_PAN||(this._state&B.TOUCH_DOLLY_OFFSET)===B.TOUCH_DOLLY_OFFSET||(this._state&B.TOUCH_ZOOM_OFFSET)===B.TOUCH_ZOOM_OFFSET||(this._state&B.TOUCH_DOLLY_ROTATE)===B.TOUCH_DOLLY_ROTATE||(this._state&B.TOUCH_ZOOM_ROTATE)===B.TOUCH_ZOOM_ROTATE){const T=jt.x-this._activePointers[1].clientX,S=jt.y-this._activePointers[1].clientY,A=Math.sqrt(T*T+S*S),M=n.y-A;n.set(0,A);const P=this.dollyToCursor?(i.x-this._elementRect.x)/this._elementRect.width*2-1:0,N=this.dollyToCursor?(i.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&B.TOUCH_DOLLY)===B.TOUCH_DOLLY||(this._state&B.TOUCH_DOLLY_ROTATE)===B.TOUCH_DOLLY_ROTATE||(this._state&B.TOUCH_DOLLY_TRUCK)===B.TOUCH_DOLLY_TRUCK||(this._state&B.TOUCH_DOLLY_SCREEN_PAN)===B.TOUCH_DOLLY_SCREEN_PAN||(this._state&B.TOUCH_DOLLY_OFFSET)===B.TOUCH_DOLLY_OFFSET?(this._dollyInternal(M*Ds,P,N),this._isUserControllingDolly=!0):(this._zoomInternal(M*Ds,P,N),this._isUserControllingZoom=!0)}((this._state&B.TRUCK)===B.TRUCK||(this._state&B.TOUCH_TRUCK)===B.TOUCH_TRUCK||(this._state&B.TOUCH_DOLLY_TRUCK)===B.TOUCH_DOLLY_TRUCK||(this._state&B.TOUCH_ZOOM_TRUCK)===B.TOUCH_ZOOM_TRUCK)&&(this._truckInternal(b,C,!1,!1),this._isUserControllingTruck=!0),((this._state&B.SCREEN_PAN)===B.SCREEN_PAN||(this._state&B.TOUCH_SCREEN_PAN)===B.TOUCH_SCREEN_PAN||(this._state&B.TOUCH_DOLLY_SCREEN_PAN)===B.TOUCH_DOLLY_SCREEN_PAN||(this._state&B.TOUCH_ZOOM_SCREEN_PAN)===B.TOUCH_ZOOM_SCREEN_PAN)&&(this._truckInternal(b,C,!1,!0),this._isUserControllingTruck=!0),((this._state&B.OFFSET)===B.OFFSET||(this._state&B.TOUCH_OFFSET)===B.TOUCH_OFFSET||(this._state&B.TOUCH_DOLLY_OFFSET)===B.TOUCH_DOLLY_OFFSET||(this._state&B.TOUCH_ZOOM_OFFSET)===B.TOUCH_ZOOM_OFFSET)&&(this._truckInternal(b,C,!0,!1),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},m=()=>{wi(this._activePointers,jt),i.copy(jt),this._dragNeedsUpdate=!1,(this._activePointers.length===0||this._activePointers.length===1&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),this._activePointers.length===0&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{!this._enabled||!this._domElement||(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",g),this._domElement.ownerDocument.addEventListener("pointerlockerror",_),this._domElement.ownerDocument.addEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",l),f())},this.unlockPointer=()=>{var p,y,b;this._lockedPointer!==null&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),(p=this._domElement)===null||p===void 0||p.ownerDocument.exitPointerLock(),(y=this._domElement)===null||y===void 0||y.ownerDocument.removeEventListener("pointerlockchange",g),(b=this._domElement)===null||b===void 0||b.ownerDocument.removeEventListener("pointerlockerror",_),this.cancel()};const g=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},_=()=>{this.unlockPointer()};this._addAllEventListeners=p=>{this._domElement=p,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",r),this._domElement.addEventListener("pointercancel",l),this._domElement.addEventListener("wheel",h,{passive:!1}),this._domElement.addEventListener("contextmenu",d)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",r),this._domElement.removeEventListener("pointercancel",l),this._domElement.removeEventListener("wheel",h,{passive:!1}),this._domElement.removeEventListener("contextmenu",d),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.ownerDocument.removeEventListener("pointerlockchange",g),this._domElement.ownerDocument.removeEventListener("pointerlockerror",_))},this.cancel=()=>{this._state!==B.NONE&&(this._state=B.NONE,this._activePointers.length=0,m())},e&&this.connect(e),this.update(0)}get camera(){return this._camera}set camera(t){this._camera=t,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this._domElement&&(t?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(t){this._spherical.radius===t&&this._sphericalEnd.radius===t||(this._spherical.radius=t,this._sphericalEnd.radius=t,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(t){this._spherical.theta===t&&this._sphericalEnd.theta===t||(this._spherical.theta=t,this._sphericalEnd.theta=t,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(t){this._spherical.phi===t&&this._sphericalEnd.phi===t||(this._spherical.phi=t,this._sphericalEnd.phi=t,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(t){this._boundaryEnclosesCamera=t,this._needsUpdate=!0}set interactiveArea(t){this._interactiveArea.width=re(t.width,0,1),this._interactiveArea.height=re(t.height,0,1),this._interactiveArea.x=re(t.x,0,1-this._interactiveArea.width),this._interactiveArea.y=re(t.y,0,1-this._interactiveArea.height)}addEventListener(t,e){super.addEventListener(t,e)}removeEventListener(t,e){super.removeEventListener(t,e)}rotate(t,e,s=!1){return this.rotateTo(this._sphericalEnd.theta+t,this._sphericalEnd.phi+e,s)}rotateAzimuthTo(t,e=!1){return this.rotateTo(t,this._sphericalEnd.phi,e)}rotatePolarTo(t,e=!1){return this.rotateTo(this._sphericalEnd.theta,t,e)}rotateTo(t,e,s=!1){this._isUserControllingRotate=!1;const i=re(t,this.minAzimuthAngle,this.maxAzimuthAngle),n=re(e,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=i,this._sphericalEnd.phi=n,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,s||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const r=!s||ft(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&ft(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(r)}dolly(t,e=!1){return this.dollyTo(this._sphericalEnd.radius-t,e)}dollyTo(t,e=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=De.NONE,this._changedDolly=0,this._dollyToNoClamp(re(t,this.minDistance,this.maxDistance),e)}_dollyToNoClamp(t,e=!1){const s=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const r=this._collisionTest(),o=ft(r,this._spherical.radius);if(!(s>t)&&o)return Promise.resolve();this._sphericalEnd.radius=Math.min(t,r)}else this._sphericalEnd.radius=t;this._needsUpdate=!0,e||(this._spherical.radius=this._sphericalEnd.radius);const n=!e||ft(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(n)}dollyInFixed(t,e=!1){this._targetEnd.add(this._getCameraDirection(hs).multiplyScalar(t)),e||this._target.copy(this._targetEnd);const s=!e||ft(this._target.x,this._targetEnd.x,this.restThreshold)&&ft(this._target.y,this._targetEnd.y,this.restThreshold)&&ft(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(s)}zoom(t,e=!1){return this.zoomTo(this._zoomEnd+t,e)}zoomTo(t,e=!1){this._isUserControllingZoom=!1,this._zoomEnd=re(t,this.minZoom,this.maxZoom),this._needsUpdate=!0,e||(this._zoom=this._zoomEnd);const s=!e||ft(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(s)}pan(t,e,s=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(t,e,s)}truck(t,e,s=!1){this._camera.updateMatrix(),ue.setFromMatrixColumn(this._camera.matrix,0),de.setFromMatrixColumn(this._camera.matrix,1),ue.multiplyScalar(t),de.multiplyScalar(-e);const i=lt.copy(ue).add(de),n=dt.copy(this._targetEnd).add(i);return this.moveTo(n.x,n.y,n.z,s)}forward(t,e=!1){lt.setFromMatrixColumn(this._camera.matrix,0),lt.crossVectors(this._camera.up,lt),lt.multiplyScalar(t);const s=dt.copy(this._targetEnd).add(lt);return this.moveTo(s.x,s.y,s.z,e)}elevate(t,e=!1){return lt.copy(this._camera.up).multiplyScalar(t),this.moveTo(this._targetEnd.x+lt.x,this._targetEnd.y+lt.y,this._targetEnd.z+lt.z,e)}moveTo(t,e,s,i=!1){this._isUserControllingTruck=!1;const n=lt.set(t,e,s).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,n,this.boundaryFriction),this._needsUpdate=!0,i||this._target.copy(this._targetEnd);const r=!i||ft(this._target.x,this._targetEnd.x,this.restThreshold)&&ft(this._target.y,this._targetEnd.y,this.restThreshold)&&ft(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(r)}lookInDirectionOf(t,e,s,i=!1){const o=lt.set(t,e,s).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius).add(this._targetEnd);return this.setPosition(o.x,o.y,o.z,i)}fitToBox(t,e,{cover:s=!1,paddingLeft:i=0,paddingRight:n=0,paddingBottom:r=0,paddingTop:o=0}={}){const l=[],c=t.isBox3?Be.copy(t):Be.setFromObject(t);c.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const h=In(this._sphericalEnd.theta,Pn),d=In(this._sphericalEnd.phi,Pn);l.push(this.rotateTo(h,d,e));const f=lt.setFromSpherical(this._sphericalEnd).normalize(),u=Ln.setFromUnitVectors(f,xi),m=ft(Math.abs(f.y),1);m&&u.multiply(Ti.setFromAxisAngle(Ls,h)),u.multiply(this._yAxisUpSpaceInverse);const g=Dn.makeEmpty();dt.copy(c.min).applyQuaternion(u),g.expandByPoint(dt),dt.copy(c.min).setX(c.max.x).applyQuaternion(u),g.expandByPoint(dt),dt.copy(c.min).setY(c.max.y).applyQuaternion(u),g.expandByPoint(dt),dt.copy(c.max).setZ(c.min.z).applyQuaternion(u),g.expandByPoint(dt),dt.copy(c.min).setZ(c.max.z).applyQuaternion(u),g.expandByPoint(dt),dt.copy(c.max).setY(c.min.y).applyQuaternion(u),g.expandByPoint(dt),dt.copy(c.max).setX(c.min.x).applyQuaternion(u),g.expandByPoint(dt),dt.copy(c.max).applyQuaternion(u),g.expandByPoint(dt),g.min.x-=i,g.min.y-=r,g.max.x+=n,g.max.y+=o,u.setFromUnitVectors(xi,f),m&&u.premultiply(Ti.invert()),u.premultiply(this._yAxisUpSpace);const _=g.getSize(lt),p=g.getCenter(dt).applyQuaternion(u);if(Ie(this._camera)){const y=this.getDistanceToFitBox(_.x,_.y,_.z,s);l.push(this.moveTo(p.x,p.y,p.z,e)),l.push(this.dollyTo(y,e)),l.push(this.setFocalOffset(0,0,0,e))}else if(Te(this._camera)){const y=this._camera,b=y.right-y.left,C=y.top-y.bottom,T=s?Math.max(b/_.x,C/_.y):Math.min(b/_.x,C/_.y);l.push(this.moveTo(p.x,p.y,p.z,e)),l.push(this.zoomTo(T,e)),l.push(this.setFocalOffset(0,0,0,e))}return Promise.all(l)}fitToSphere(t,e){const s=[],n="isObject3D"in t?Ut.createBoundingSphere(t,Ci):Ci.copy(t);if(s.push(this.moveTo(n.center.x,n.center.y,n.center.z,e)),Ie(this._camera)){const r=this.getDistanceToFitSphere(n.radius);s.push(this.dollyTo(r,e))}else if(Te(this._camera)){const r=this._camera.right-this._camera.left,o=this._camera.top-this._camera.bottom,l=2*n.radius,c=Math.min(r/l,o/l);s.push(this.zoomTo(c,e))}return s.push(this.setFocalOffset(0,0,0,e)),Promise.all(s)}setLookAt(t,e,s,i,n,r,o=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=De.NONE,this._changedDolly=0;const l=dt.set(i,n,r),c=lt.set(t,e,s);this._targetEnd.copy(l),this._sphericalEnd.setFromVector3(c.sub(l).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,o||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const h=!o||ft(this._target.x,this._targetEnd.x,this.restThreshold)&&ft(this._target.y,this._targetEnd.y,this.restThreshold)&&ft(this._target.z,this._targetEnd.z,this.restThreshold)&&ft(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&ft(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&ft(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(h)}lerpLookAt(t,e,s,i,n,r,o,l,c,h,d,f,u,m=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=De.NONE,this._changedDolly=0;const g=lt.set(i,n,r),_=dt.set(t,e,s);Kt.setFromVector3(_.sub(g).applyQuaternion(this._yAxisUpSpace));const p=Re.set(h,d,f),y=dt.set(o,l,c);us.setFromVector3(y.sub(p).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(g.lerp(p,u));const b=us.theta-Kt.theta,C=us.phi-Kt.phi,T=us.radius-Kt.radius;this._sphericalEnd.set(Kt.radius+T*u,Kt.phi+C*u,Kt.theta+b*u),this.normalizeRotations(),this._needsUpdate=!0,m||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const S=!m||ft(this._target.x,this._targetEnd.x,this.restThreshold)&&ft(this._target.y,this._targetEnd.y,this.restThreshold)&&ft(this._target.z,this._targetEnd.z,this.restThreshold)&&ft(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&ft(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&ft(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(S)}setPosition(t,e,s,i=!1){return this.setLookAt(t,e,s,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,i)}setTarget(t,e,s,i=!1){const n=this.getPosition(lt),r=this.setLookAt(n.x,n.y,n.z,t,e,s,i);return this._sphericalEnd.phi=re(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),r}setFocalOffset(t,e,s,i=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(t,e,s),this._needsUpdate=!0,i||this._focalOffset.copy(this._focalOffsetEnd);const n=!i||ft(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&ft(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&ft(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(n)}setOrbitPoint(t,e,s){this._camera.updateMatrixWorld(),ue.setFromMatrixColumn(this._camera.matrixWorldInverse,0),de.setFromMatrixColumn(this._camera.matrixWorldInverse,1),ke.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const i=lt.set(t,e,s),n=i.distanceTo(this._camera.position),r=i.sub(this._camera.position);ue.multiplyScalar(r.x),de.multiplyScalar(r.y),ke.multiplyScalar(r.z),lt.copy(ue).add(de).add(ke),lt.z=lt.z+n,this.dollyTo(n,!1),this.setFocalOffset(-lt.x,lt.y,-lt.z,!1),this.moveTo(t,e,s,!1)}setBoundary(t){if(!t){this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),this._needsUpdate=!0;return}this._boundary.copy(t),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(t,e,s,i){if(t===null){this._viewport=null;return}this._viewport=this._viewport||new ot.Vector4,typeof t=="number"?this._viewport.set(t,e,s,i):this._viewport.copy(t)}getDistanceToFitBox(t,e,s,i=!1){if(vi(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const n=t/e,r=this._camera.getEffectiveFOV()*as,o=this._camera.aspect;return((i?n>o:n<o)?e:t/o)*.5/Math.tan(r*.5)+s*.5}getDistanceToFitSphere(t){if(vi(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const e=this._camera.getEffectiveFOV()*as,s=Math.atan(Math.tan(e*.5)*this._camera.aspect)*2,i=1<this._camera.aspect?e:s;return t/Math.sin(i*.5)}getTarget(t,e=!0){return(t&&t.isVector3?t:new ot.Vector3).copy(e?this._targetEnd:this._target)}getPosition(t,e=!0){return(t&&t.isVector3?t:new ot.Vector3).setFromSpherical(e?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(e?this._targetEnd:this._target)}getSpherical(t,e=!0){return(t||new ot.Spherical).copy(e?this._sphericalEnd:this._spherical)}getFocalOffset(t,e=!0){return(t&&t.isVector3?t:new ot.Vector3).copy(e?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%Le,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=Le),this._spherical.theta+=Le*Math.round((this._sphericalEnd.theta-this._spherical.theta)/Le)}stop(){this._focalOffset.copy(this._focalOffsetEnd),this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd),this._zoom=this._zoomEnd}reset(t=!1){if(!ft(this._camera.up.x,this._cameraUp0.x)||!ft(this._camera.up.y,this._cameraUp0.y)||!ft(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const s=this.getPosition(lt);this.updateCameraUp(),this.setPosition(s.x,s.y,s.z)}const e=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,t),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,t),this.zoomTo(this._zoom0,t)];return Promise.all(e)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,Ls),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const t=lt.subVectors(this._target,this._camera.position).normalize(),e=dt.crossVectors(t,this._camera.up);this._camera.up.crossVectors(e,t).normalize(),this._camera.updateMatrixWorld();const s=this.getPosition(lt);this.updateCameraUp(),this.setPosition(s.x,s.y,s.z)}update(t){const e=this._sphericalEnd.theta-this._spherical.theta,s=this._sphericalEnd.phi-this._spherical.phi,i=this._sphericalEnd.radius-this._spherical.radius,n=zn.subVectors(this._targetEnd,this._target),r=Nn.subVectors(this._focalOffsetEnd,this._focalOffset),o=this._zoomEnd-this._zoom;if(yt(e))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const d=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=Ns(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,d,1/0,t),this._needsUpdate=!0}if(yt(s))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const d=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=Ns(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,d,1/0,t),this._needsUpdate=!0}if(yt(i))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const d=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=Ns(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,d,this.maxSpeed,t),this._needsUpdate=!0}if(yt(n.x)&&yt(n.y)&&yt(n.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const d=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;kn(this._target,this._targetEnd,this._targetVelocity,d,this.maxSpeed,t,this._target),this._needsUpdate=!0}if(yt(r.x)&&yt(r.y)&&yt(r.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const d=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;kn(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,d,this.maxSpeed,t,this._focalOffset),this._needsUpdate=!0}if(yt(o))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const d=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=Ns(this._zoom,this._zoomEnd,this._zoomVelocity,d,1/0,t)}if(this.dollyToCursor){if(Ie(this._camera)&&this._changedDolly!==0){const d=this._spherical.radius-this._lastDistance,f=this._camera,u=this._getCameraDirection(hs),m=lt.copy(u).cross(f.up).normalize();m.lengthSq()===0&&(m.x=1);const g=dt.crossVectors(m,u),_=this._sphericalEnd.radius*Math.tan(f.getEffectiveFOV()*as*.5),y=(this._sphericalEnd.radius-d-this._sphericalEnd.radius)/this._sphericalEnd.radius,b=Re.copy(this._targetEnd).add(m.multiplyScalar(this._dollyControlCoord.x*_*f.aspect)).add(g.multiplyScalar(this._dollyControlCoord.y*_)),C=lt.copy(this._targetEnd).lerp(b,y),T=this._lastDollyDirection===De.IN&&this._spherical.radius<=this.minDistance,S=this._lastDollyDirection===De.OUT&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(T||S)){this._sphericalEnd.radius-=d,this._spherical.radius-=d;const M=dt.copy(u).multiplyScalar(-d);C.add(M)}this._boundary.clampPoint(C,C);const A=dt.subVectors(C,this._targetEnd);this._targetEnd.copy(C),this._target.add(A),this._changedDolly-=d,yt(this._changedDolly)&&(this._changedDolly=0)}else if(Te(this._camera)&&this._changedZoom!==0){const d=this._zoom-this._lastZoom,f=this._camera,u=lt.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(f.near+f.far)/(f.near-f.far)).unproject(f),m=dt.set(0,0,-1).applyQuaternion(f.quaternion),g=Re.copy(u).add(m.multiplyScalar(-u.dot(f.up))),p=-(this._zoom-d-this._zoom)/this._zoom,y=this._getCameraDirection(hs),b=this._targetEnd.dot(y),C=lt.copy(this._targetEnd).lerp(g,p),T=C.dot(y),S=y.multiplyScalar(T-b);C.sub(S),this._boundary.clampPoint(C,C);const A=dt.subVectors(C,this._targetEnd);this._targetEnd.copy(C),this._target.add(A),this._changedZoom-=d,yt(this._changedZoom)&&(this._changedZoom=0)}}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const l=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,l),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target),(!yt(this._focalOffset.x)||!yt(this._focalOffset.y)||!yt(this._focalOffset.z))&&(ue.setFromMatrixColumn(this._camera.matrix,0),de.setFromMatrixColumn(this._camera.matrix,1),ke.setFromMatrixColumn(this._camera.matrix,2),ue.multiplyScalar(this._focalOffset.x),de.multiplyScalar(-this._focalOffset.y),ke.multiplyScalar(this._focalOffset.z),lt.copy(ue).add(de).add(ke),this._camera.position.add(lt),this._camera.updateMatrixWorld()),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),lt.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const h=this._needsUpdate;return h&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):h?(this.dispatchEvent({type:"update"}),yt(e,this.restThreshold)&&yt(s,this.restThreshold)&&yt(i,this.restThreshold)&&yt(n.x,this.restThreshold)&&yt(n.y,this.restThreshold)&&yt(n.z,this.restThreshold)&&yt(r.x,this.restThreshold)&&yt(r.y,this.restThreshold)&&yt(r.z,this.restThreshold)&&yt(o,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!h&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=h,this._needsUpdate=!1,h}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:ls(this.maxDistance),minZoom:this.minZoom,maxZoom:ls(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:ls(this.maxPolarAngle),minAzimuthAngle:ls(this.minAzimuthAngle),maxAzimuthAngle:ls(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,target:this._targetEnd.toArray(),position:lt.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(t,e=!1){const s=JSON.parse(t);this.enabled=s.enabled,this.minDistance=s.minDistance,this.maxDistance=cs(s.maxDistance),this.minZoom=s.minZoom,this.maxZoom=cs(s.maxZoom),this.minPolarAngle=s.minPolarAngle,this.maxPolarAngle=cs(s.maxPolarAngle),this.minAzimuthAngle=cs(s.minAzimuthAngle),this.maxAzimuthAngle=cs(s.maxAzimuthAngle),this.smoothTime=s.smoothTime,this.draggingSmoothTime=s.draggingSmoothTime,this.dollySpeed=s.dollySpeed,this.truckSpeed=s.truckSpeed,this.dollyToCursor=s.dollyToCursor,this._target0.fromArray(s.target0),this._position0.fromArray(s.position0),this._zoom0=s.zoom0,this._focalOffset0.fromArray(s.focalOffset0),this.moveTo(s.target[0],s.target[1],s.target[2],e),Kt.setFromVector3(lt.fromArray(s.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(Kt.theta,Kt.phi,e),this.dollyTo(Kt.radius,e),this.zoomTo(s.zoom,e),this.setFocalOffset(s.focalOffset[0],s.focalOffset[1],s.focalOffset[2],e),this._needsUpdate=!0}connect(t){if(this._domElement){console.warn("camera-controls is already connected.");return}t.setAttribute("data-camera-controls-version",Pl),this._addAllEventListeners(t),this._getClientRect(this._elementRect)}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(t){return t.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(t){return this._getTargetDirection(t).negate()}_findPointerById(t){return this._activePointers.find(e=>e.pointerId===t)}_findPointerByMouseButton(t){return this._activePointers.find(e=>e.mouseButton===t)}_disposePointer(t){this._activePointers.splice(this._activePointers.indexOf(t),1)}_encloseToBoundary(t,e,s){const i=e.lengthSq();if(i===0)return t;const n=dt.copy(e).add(t),o=this._boundary.clampPoint(n,Re).sub(n),l=o.lengthSq();if(l===0)return t.add(e);if(l===i)return t;if(s===0)return t.add(e).add(o);{const c=1+s*l/e.dot(o);return t.add(dt.copy(e).multiplyScalar(c)).add(o.multiplyScalar(1-s))}}_updateNearPlaneCorners(){if(Ie(this._camera)){const t=this._camera,e=t.near,s=t.getEffectiveFOV()*as,i=Math.tan(s*.5)*e,n=i*t.aspect;this._nearPlaneCorners[0].set(-n,-i,0),this._nearPlaneCorners[1].set(n,-i,0),this._nearPlaneCorners[2].set(n,i,0),this._nearPlaneCorners[3].set(-n,i,0)}else if(Te(this._camera)){const t=this._camera,e=1/t.zoom,s=t.left*e,i=t.right*e,n=t.top*e,r=t.bottom*e;this._nearPlaneCorners[0].set(s,n,0),this._nearPlaneCorners[1].set(i,n,0),this._nearPlaneCorners[2].set(i,r,0),this._nearPlaneCorners[3].set(s,r,0)}}_collisionTest(){let t=1/0;if(!(this.colliderMeshes.length>=1)||vi(this._camera,"_collisionTest"))return t;const s=this._getTargetDirection(hs);Ei.lookAt(Mn,s,this._camera.up);for(let i=0;i<4;i++){const n=dt.copy(this._nearPlaneCorners[i]);n.applyMatrix4(Ei);const r=Re.addVectors(this._target,n);Rs.set(r,s),Rs.far=this._spherical.radius+1;const o=Rs.intersectObjects(this.colliderMeshes);o.length!==0&&o[0].distance<t&&(t=o[0].distance)}return t}_getClientRect(t){if(!this._domElement)return;const e=this._domElement.getBoundingClientRect();return t.x=e.left,t.y=e.top,this._viewport?(t.x+=this._viewport.x,t.y+=e.height-this._viewport.w-this._viewport.y,t.width=this._viewport.z,t.height=this._viewport.w):(t.width=e.width,t.height=e.height),t}_createOnRestPromise(t){return t?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise(e=>{const s=()=>{this.removeEventListener("rest",s),e()};this.addEventListener("rest",s)}))}_addAllEventListeners(t){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(t){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(t){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(t,e=new ot.Sphere){const s=e,i=s.center;Be.makeEmpty(),t.traverseVisible(r=>{r.isMesh&&Be.expandByObject(r)}),Be.getCenter(i);let n=0;return t.traverseVisible(r=>{if(!r.isMesh)return;const o=r;if(!o.geometry)return;const l=o.geometry.clone();l.applyMatrix4(o.matrixWorld);const h=l.attributes.position;for(let d=0,f=h.count;d<f;d++)lt.fromBufferAttribute(h,d),n=Math.max(n,i.distanceToSquared(lt))}),s.radius=Math.sqrt(n),s}}class As extends Ko{constructor(t){super(t),x(this,"onBeforeUpdate",new it),x(this,"onAfterUpdate",new it),x(this,"onAspectUpdated",new it),x(this,"onDisposed",new it),x(this,"three"),x(this,"_allControls",new Map),x(this,"updateAspect",()=>{var e;if(!(!this.currentWorld||!this.currentWorld.renderer)){if(this.three instanceof sn){this.onAspectUpdated.trigger();return}if((e=this.currentWorld.renderer)!=null&&e.isResizeable()){const s=this.currentWorld.renderer.getSize();this.three.aspect=s.width/s.height,this.three.updateProjectionMatrix(),this.onAspectUpdated.trigger()}}}),this.three=this.setupCamera(),this.setupEvents(!0),this.worlds.onItemSet.add(({value:e})=>{const s=this.newCameraControls();this._allControls.set(e.uuid,s)}),this.worlds.onBeforeDelete.add(({value:e})=>{const s=this._allControls.get(e.uuid);s&&(s.dispose(),this._allControls.delete(e.uuid))})}get controls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");const t=this._allControls.get(this.currentWorld.uuid);if(!t)throw new Error("Controls not found!");return t}get enabled(){return this.currentWorld===null?!1:this.controls.enabled}set enabled(t){this.currentWorld!==null&&(this.controls.enabled=t)}set currentWorld(t){if(super.currentWorld=t,!t)return;this.worlds.get(t.uuid)||this.worlds.set(t.uuid,t)}get currentWorld(){return this._currentWorld}dispose(){this.setupEvents(!1),this.onAspectUpdated.reset(),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.three.removeFromParent(),this.onDisposed.trigger(),this.onDisposed.reset();for(const[t,e]of this._allControls)e.dispose();this.worlds.clear()}async fitToItems(t){const e=await this.getItemsBounding(t);await this.controls.fitToSphere(e,!0)}async setOrbitToItems(t){const e=await this.getItemsBounding(t);this.controls.setOrbitPoint(e.center.x,e.center.y,e.center.z)}update(t){this.enabled&&(this.onBeforeUpdate.trigger(this),this.controls.update(t),this.onAfterUpdate.trigger(this))}async getItemsBounding(t){const e=this.components.get(ct),s=this.components.get($r);s.list.clear();const i=new oi;if(t)await s.addFromModelIdMap(t);else for(const[,n]of e.list)s.list.add(n.box);return s.get().getBoundingSphere(i),s.list.clear(),i}setupCamera(){const t=window.innerWidth/window.innerHeight,e=new Cr(60,t,1,1e3);return e.position.set(50,50,50),e.lookAt(new V(0,0,0)),e}newCameraControls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");if(!this.currentWorld.renderer)throw new Error("This camera needs a renderer to work!");Ut.install({THREE:As.getSubsetOfThree()});const{domElement:t}=this.currentWorld.renderer.three,e=new Ut(this.three,t);return e.smoothTime=.2,e.dollyToCursor=!0,e.infinityDolly=!0,e.minDistance=6,e}setupEvents(t){t?window.addEventListener("resize",this.updateAspect):window.removeEventListener("resize",this.updateAspect)}static getSubsetOfThree(){return{MOUSE:Do,Vector2:Wt,Vector3:V,Vector4:No,Quaternion:ae,Matrix4:Ot,Spherical:zo,Box3:Ft,Sphere:oi,Raycaster:en,MathUtils:Mo}}}const Jr=class to extends Dt{constructor(t){super(t),x(this,"onAfterUpdate",new it),x(this,"onBeforeUpdate",new it),x(this,"onDisposed",new it),x(this,"list",new Nt),x(this,"enabled",!0),t.add(to.uuid,this)}create(){const t=new xl(this.components),e=t.uuid;if(this.list.has(e))throw new Error("There is already a world with this name!");return this.list.set(e,t),t}delete(t){if(!this.list.has(t.uuid))throw new Error("The provided world is not found in the list!");this.list.delete(t.uuid),t.dispose()}dispose(){this.enabled=!1;for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger()}update(t){if(this.enabled)for(const[e,s]of this.list)s.update(t)}};x(Jr,"uuid","fdb61dc4-2ec1-4966-b83d-54ea795fad4a");let eo=Jr;class kl extends Ps{constructor(){super(...arguments),x(this,"_config",{visible:{value:!0,type:"Boolean"},color:{value:new zt,type:"Color"},primarySize:{type:"Number",interpolable:!0,value:1,min:0,max:1e3},secondarySize:{type:"Number",interpolable:!0,value:10,min:0,max:1e3},distance:{type:"Number",interpolable:!0,value:500,min:0,max:500}})}get visible(){return this._config.visible.value}set visible(t){this._config.visible.value=t,this._component.visible=t}get color(){return this._config.color.value}set color(t){this._config.color.value=t,this._component.material.uniforms.uColor.value=t,this._component.material.uniformsNeedUpdate=!0}get primarySize(){return this._config.primarySize.value}set primarySize(t){this._config.primarySize.value=t,this._component.material.uniforms.uSize1.value=t,this._component.material.uniformsNeedUpdate=!0}get secondarySize(){return this._config.secondarySize.value}set secondarySize(t){this._config.secondarySize.value=t,this._component.material.uniforms.uSize2.value=t,this._component.material.uniformsNeedUpdate=!0}get distance(){return this._config.distance.value}set distance(t){this._config.distance.value=t,this._component.material.uniforms.uDistance.value=t,this._component.material.uniformsNeedUpdate=!0}}class Ml{constructor(t,e){x(this,"onDisposed",new it),x(this,"onSetup",new it),x(this,"isSetup",!1),x(this,"world"),x(this,"components"),x(this,"config"),x(this,"_defaultConfig",{visible:!0,color:new zt(12303291),primarySize:1,secondarySize:10,distance:500}),x(this,"three"),x(this,"_fade",3),x(this,"updateZoom",()=>{this.world.camera instanceof As&&(this.material.uniforms.uZoom.value=this.world.camera.three.zoom)}),this.world=e;const{color:s,primarySize:i,secondarySize:n,distance:r}=this._defaultConfig;this.components=t,this.config=new kl(this,this.components,"Grid");const o=new nn(2,2,1,1),l=new jo({side:ci,uniforms:{uSize1:{value:i},uSize2:{value:n},uColor:{value:s},uDistance:{value:r},uFade:{value:this._fade},uZoom:{value:1}},transparent:!0,vertexShader:`
            
            varying vec3 worldPosition;
            
            uniform float uDistance;
            
            void main() {
            
                    vec3 pos = position.xzy * uDistance;
                    pos.xz += cameraPosition.xz;
                    
                    worldPosition = pos;
                    
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
            
            }
            `,fragmentShader:`
            
            varying vec3 worldPosition;
            
            uniform float uZoom;
            uniform float uFade;
            uniform float uSize1;
            uniform float uSize2;
            uniform vec3 uColor;
            uniform float uDistance;
                
                
                
                float getGrid(float size) {
                
                    vec2 r = worldPosition.xz / size;
                    
                    
                    vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);
                    float line = min(grid.x, grid.y);
                    
                
                    return 1.0 - min(line, 1.0);
                }
                
            void main() {
            
                    
                    float d = 1.0 - min(distance(cameraPosition.xz, worldPosition.xz) / uDistance, 1.0);
                    
                    float g1 = getGrid(uSize1);
                    float g2 = getGrid(uSize2);
                    
                    // Ortho camera fades the grid away when zooming out
                    float minZoom = step(0.2, uZoom);
                    float zoomFactor = pow(min(uZoom, 1.), 2.) * minZoom;
                    
                    gl_FragColor = vec4(uColor.rgb, mix(g2, g1, g1) * pow(d, uFade));
                    gl_FragColor.a = mix(0.5 * gl_FragColor.a, gl_FragColor.a, g2) * zoomFactor;
                    
                    if ( gl_FragColor.a <= 0.0 ) discard;
                    
            
            }
            
            `,extensions:{derivatives:!0}});this.three=new et(o,l),this.three.frustumCulled=!1,e.scene.three.add(this.three),this.setupEvents(!0)}get visible(){return this.three.visible}set visible(t){this.three.visible=t,t?this.world.scene.three.add(this.three):this.three.removeFromParent()}get material(){return this.three.material}get fade(){return this._fade===3}set fade(t){this._fade=t?3:0,this.material.uniforms.uFade.value=this._fade}setup(t){const e={...this._defaultConfig,...t};this.config.visible=!0,this.config.color=e.color,this.config.primarySize=e.primarySize,this.config.secondarySize=e.secondarySize,this.config.distance=e.distance,this.isSetup=!0,this.onSetup.trigger()}dispose(){this.setupEvents(!1),this.components.get(pi).list.delete(this.config.uuid),this.components.get(hi).destroy(this.three),this.onDisposed.trigger(),this.onDisposed.reset(),this.world=null,this.components=null}setupEvents(t){if(this.world.isDisposing||!(this.world.camera instanceof As))return;const e=this.world.camera.controls;t?e.addEventListener("update",this.updateZoom):e.removeEventListener("update",this.updateZoom)}}const so=class io extends Dt{constructor(t){super(t),x(this,"list",new Map),x(this,"onDisposed",new it),x(this,"enabled",!0),t.add(io.uuid,this)}create(t){if(this.list.has(t.uuid))throw new Error("This world already has a grid!");const e=new Ml(this.components,t);return this.list.set(t.uuid,e),t.onDisposed.add(()=>{this.delete(t)}),e}delete(t){const e=this.list.get(t.uuid);e&&e.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,e]of this.list)e.dispose();this.list.clear(),this.onDisposed.trigger(),this.onDisposed.reset()}};x(so,"uuid","d1e814d5-b81c-4452-87a2-f039375e0489");let vh=so;const no=0,zl=1,Nl=2,Rn=2,Si=1.25,Bn=1,ii=6*4+4+4,mi=65535,Dl=Math.pow(2,-24),Ai=Symbol("SKIP_GENERATION");function Ll(a){return a.index?a.index.count:a.attributes.position.count}function Je(a){return Ll(a)/3}function Rl(a,t=ArrayBuffer){return a>65535?new Uint32Array(new t(4*a)):new Uint16Array(new t(2*a))}function Bl(a,t){if(!a.index){const e=a.attributes.position.count,s=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=Rl(e,s);a.setIndex(new Tr(i,1));for(let n=0;n<e;n++)i[n]=n}}function ro(a){const t=Je(a),e=a.drawRange,s=e.start/3,i=(e.start+e.count)/3,n=Math.max(0,s),r=Math.min(t,i)-n;return[{offset:Math.floor(n),count:Math.floor(r)}]}function oo(a){if(!a.groups||!a.groups.length)return ro(a);const t=[],e=new Set,s=a.drawRange,i=s.start/3,n=(s.start+s.count)/3;for(const o of a.groups){const l=o.start/3,c=(o.start+o.count)/3;e.add(Math.max(i,l)),e.add(Math.min(n,c))}const r=Array.from(e.values()).sort((o,l)=>o-l);for(let o=0;o<r.length-1;o++){const l=r[o],c=r[o+1];t.push({offset:Math.floor(l),count:Math.floor(c-l)})}return t}function Ul(a){if(a.groups.length===0)return!1;const t=Je(a),e=oo(a).sort((n,r)=>n.offset-r.offset),s=e[e.length-1];s.count=Math.min(t-s.offset,s.count);let i=0;return e.forEach(({count:n})=>i+=n),t!==i}function Ct(a,t,e){return e.min.x=t[a],e.min.y=t[a+1],e.min.z=t[a+2],e.max.x=t[a+3],e.max.y=t[a+4],e.max.z=t[a+5],e}function Fl(a){a[0]=a[1]=a[2]=1/0,a[3]=a[4]=a[5]=-1/0}function Un(a){let t=-1,e=-1/0;for(let s=0;s<3;s++){const i=a[s+3]-a[s];i>e&&(e=i,t=s)}return t}function Fn(a,t){t.set(a)}function Vn(a,t,e){let s,i;for(let n=0;n<3;n++){const r=n+3;s=a[n],i=t[n],e[n]=s<i?s:i,s=a[r],i=t[r],e[r]=s>i?s:i}}function Bs(a,t,e){for(let s=0;s<3;s++){const i=t[a+2*s],n=t[a+2*s+1],r=i-n,o=i+n;r<e[s]&&(e[s]=r),o>e[s+3]&&(e[s+3]=o)}}function ds(a){const t=a[3]-a[0],e=a[4]-a[1],s=a[5]-a[2];return 2*(t*e+e*s+s*t)}function Oi(a,t,e,s,i=null){let n=1/0,r=1/0,o=1/0,l=-1/0,c=-1/0,h=-1/0,d=1/0,f=1/0,u=1/0,m=-1/0,g=-1/0,_=-1/0;const p=i!==null;for(let y=t*6,b=(t+e)*6;y<b;y+=6){const C=a[y+0],T=a[y+1],S=C-T,A=C+T;S<n&&(n=S),A>l&&(l=A),p&&C<d&&(d=C),p&&C>m&&(m=C);const M=a[y+2],P=a[y+3],N=M-P,H=M+P;N<r&&(r=N),H>c&&(c=H),p&&M<f&&(f=M),p&&M>g&&(g=M);const E=a[y+4],k=a[y+5],w=E-k,z=E+k;w<o&&(o=w),z>h&&(h=z),p&&E<u&&(u=E),p&&E>_&&(_=E)}s[0]=n,s[1]=r,s[2]=o,s[3]=l,s[4]=c,s[5]=h,p&&(i[0]=d,i[1]=f,i[2]=u,i[3]=m,i[4]=g,i[5]=_)}function Vl(a,t,e,s){let i=1/0,n=1/0,r=1/0,o=-1/0,l=-1/0,c=-1/0;for(let h=t*6,d=(t+e)*6;h<d;h+=6){const f=a[h+0];f<i&&(i=f),f>o&&(o=f);const u=a[h+2];u<n&&(n=u),u>l&&(l=u);const m=a[h+4];m<r&&(r=m),m>c&&(c=m)}s[0]=i,s[1]=n,s[2]=r,s[3]=o,s[4]=l,s[5]=c}function Hl(a,t){Fl(t);const e=a.attributes.position,s=a.index?a.index.array:null,i=Je(a),n=new Float32Array(i*6),r=e.normalized,o=e.array,l=e.offset||0;let c=3;e.isInterleavedBufferAttribute&&(c=e.data.stride);const h=["getX","getY","getZ"];for(let d=0;d<i;d++){const f=d*3,u=d*6;let m=f+0,g=f+1,_=f+2;s&&(m=s[m],g=s[g],_=s[_]),r||(m=m*c+l,g=g*c+l,_=_*c+l);for(let p=0;p<3;p++){let y,b,C;r?(y=e[h[p]](m),b=e[h[p]](g),C=e[h[p]](_)):(y=o[m+p],b=o[g+p],C=o[_+p]);let T=y;b<T&&(T=b),C<T&&(T=C);let S=y;b>S&&(S=b),C>S&&(S=C);const A=(S-T)/2,M=p*2;n[u+M+0]=T+A,n[u+M+1]=A+(Math.abs(T)+A)*Dl,T<t[p]&&(t[p]=T),S>t[p+3]&&(t[p+3]=S)}}return n}const _e=32,$l=(a,t)=>a.candidate-t.candidate,xe=new Array(_e).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),Us=new Float32Array(6);function Zl(a,t,e,s,i,n){let r=-1,o=0;if(n===no)r=Un(t),r!==-1&&(o=(t[r]+t[r+3])/2);else if(n===zl)r=Un(a),r!==-1&&(o=Yl(e,s,i,r));else if(n===Nl){const l=ds(a);let c=Si*i;const h=s*6,d=(s+i)*6;for(let f=0;f<3;f++){const u=t[f],_=(t[f+3]-u)/_e;if(i<_e/4){const p=[...xe];p.length=i;let y=0;for(let C=h;C<d;C+=6,y++){const T=p[y];T.candidate=e[C+2*f],T.count=0;const{bounds:S,leftCacheBounds:A,rightCacheBounds:M}=T;for(let P=0;P<3;P++)M[P]=1/0,M[P+3]=-1/0,A[P]=1/0,A[P+3]=-1/0,S[P]=1/0,S[P+3]=-1/0;Bs(C,e,S)}p.sort($l);let b=i;for(let C=0;C<b;C++){const T=p[C];for(;C+1<b&&p[C+1].candidate===T.candidate;)p.splice(C+1,1),b--}for(let C=h;C<d;C+=6){const T=e[C+2*f];for(let S=0;S<b;S++){const A=p[S];T>=A.candidate?Bs(C,e,A.rightCacheBounds):(Bs(C,e,A.leftCacheBounds),A.count++)}}for(let C=0;C<b;C++){const T=p[C],S=T.count,A=i-T.count,M=T.leftCacheBounds,P=T.rightCacheBounds;let N=0;S!==0&&(N=ds(M)/l);let H=0;A!==0&&(H=ds(P)/l);const E=Bn+Si*(N*S+H*A);E<c&&(r=f,c=E,o=T.candidate)}}else{for(let b=0;b<_e;b++){const C=xe[b];C.count=0,C.candidate=u+_+b*_;const T=C.bounds;for(let S=0;S<3;S++)T[S]=1/0,T[S+3]=-1/0}for(let b=h;b<d;b+=6){let S=~~((e[b+2*f]-u)/_);S>=_e&&(S=_e-1);const A=xe[S];A.count++,Bs(b,e,A.bounds)}const p=xe[_e-1];Fn(p.bounds,p.rightCacheBounds);for(let b=_e-2;b>=0;b--){const C=xe[b],T=xe[b+1];Vn(C.bounds,T.rightCacheBounds,C.rightCacheBounds)}let y=0;for(let b=0;b<_e-1;b++){const C=xe[b],T=C.count,S=C.bounds,M=xe[b+1].rightCacheBounds;T!==0&&(y===0?Fn(S,Us):Vn(S,Us,Us)),y+=T;let P=0,N=0;y!==0&&(P=ds(Us)/l);const H=i-y;H!==0&&(N=ds(M)/l);const E=Bn+Si*(P*y+N*H);E<c&&(r=f,c=E,o=C.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${n} used.`);return{axis:r,pos:o}}function Yl(a,t,e,s){let i=0;for(let n=t,r=t+e;n<r;n++)i+=a[n*6+s*2];return i/e}class Fs{constructor(){}}function jl(a,t,e,s,i,n){let r=s,o=s+i-1;const l=n.pos,c=n.axis*2;for(;;){for(;r<=o&&e[r*6+c]<l;)r++;for(;r<=o&&e[o*6+c]>=l;)o--;if(r<o){for(let h=0;h<3;h++){let d=t[r*3+h];t[r*3+h]=t[o*3+h],t[o*3+h]=d}for(let h=0;h<6;h++){let d=e[r*6+h];e[r*6+h]=e[o*6+h],e[o*6+h]=d}r++,o--}else return r}}function Wl(a,t,e,s,i,n){let r=s,o=s+i-1;const l=n.pos,c=n.axis*2;for(;;){for(;r<=o&&e[r*6+c]<l;)r++;for(;r<=o&&e[o*6+c]>=l;)o--;if(r<o){let h=a[r];a[r]=a[o],a[o]=h;for(let d=0;d<6;d++){let f=e[r*6+d];e[r*6+d]=e[o*6+d],e[o*6+d]=f}r++,o--}else return r}}function Xl(a,t){const e=(a.index?a.index.count:a.attributes.position.count)/3,s=e>2**16,i=s?4:2,n=t?new SharedArrayBuffer(e*i):new ArrayBuffer(e*i),r=s?new Uint32Array(n):new Uint16Array(n);for(let o=0,l=r.length;o<l;o++)r[o]=o;return r}function ql(a,t){const e=a.geometry,s=e.index?e.index.array:null,i=t.maxDepth,n=t.verbose,r=t.maxLeafTris,o=t.strategy,l=t.onProgress,c=Je(e),h=a._indirectBuffer;let d=!1;const f=new Float32Array(6),u=new Float32Array(6),m=Hl(e,f),g=t.indirect?Wl:jl,_=[],p=t.indirect?ro(e):oo(e);if(p.length===1){const C=p[0],T=new Fs;T.boundingData=f,Vl(m,C.offset,C.count,u),b(T,C.offset,C.count,u),_.push(T)}else for(let C of p){const T=new Fs;T.boundingData=new Float32Array(6),Oi(m,C.offset,C.count,T.boundingData,u),b(T,C.offset,C.count,u),_.push(T)}return _;function y(C){l&&l(C/c)}function b(C,T,S,A=null,M=0){if(!d&&M>=i&&(d=!0,n&&(console.warn(`MeshBVH: Max depth of ${i} reached when generating BVH. Consider increasing maxDepth.`),console.warn(e))),S<=r||M>=i)return y(T+S),C.offset=T,C.count=S,C;const P=Zl(C.boundingData,A,m,T,S,o);if(P.axis===-1)return y(T+S),C.offset=T,C.count=S,C;const N=g(h,s,m,T,S,P);if(N===T||N===T+S)y(T+S),C.offset=T,C.count=S;else{C.splitAxis=P.axis;const H=new Fs,E=T,k=N-T;C.left=H,H.boundingData=new Float32Array(6),Oi(m,E,k,H.boundingData,u),b(H,E,k,u,M+1);const w=new Fs,z=N,X=S-k;C.right=w,w.boundingData=new Float32Array(6),Oi(m,z,X,w.boundingData,u),b(w,z,X,u,M+1)}return C}}function Gl(a,t){const e=a.geometry;t.indirect&&(a._indirectBuffer=Xl(e,t.useSharedArrayBuffer),Ul(e)&&!t.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),a._indirectBuffer||Bl(e,t);const s=ql(a,t);let i,n,r;const o=[],l=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let d=0;d<s.length;d++){const f=s[d];let u=c(f);const m=new l(ii*u);i=new Float32Array(m),n=new Uint32Array(m),r=new Uint16Array(m),h(0,f),o.push(m)}a._roots=o;return;function c(d){return d.count?1:1+c(d.left)+c(d.right)}function h(d,f){const u=d/4,m=d/2,g=!!f.count,_=f.boundingData;for(let p=0;p<6;p++)i[u+p]=_[p];if(g){const p=f.offset,y=f.count;return n[u+6]=p,r[m+14]=y,r[m+15]=mi,d+ii}else{const p=f.left,y=f.right,b=f.splitAxis;let C;if(C=h(d+ii,p),C/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return n[u+6]=C/4,C=h(C,y),n[u+7]=b,C}}}class ve{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(t,e){let s=1/0,i=-1/0;for(let n=0,r=t.length;n<r;n++){const l=t[n][e];s=l<s?l:s,i=l>i?l:i}this.min=s,this.max=i}setFromPoints(t,e){let s=1/0,i=-1/0;for(let n=0,r=e.length;n<r;n++){const o=e[n],l=t.dot(o);s=l<s?l:s,i=l>i?l:i}this.min=s,this.max=i}isSeparated(t){return this.min>t.max||t.min>this.max}}ve.prototype.setFromBox=function(){const a=new V;return function(e,s){const i=s.min,n=s.max;let r=1/0,o=-1/0;for(let l=0;l<=1;l++)for(let c=0;c<=1;c++)for(let h=0;h<=1;h++){a.x=i.x*l+n.x*(1-l),a.y=i.y*c+n.y*(1-c),a.z=i.z*h+n.z*(1-h);const d=e.dot(a);r=Math.min(d,r),o=Math.max(d,o)}this.min=r,this.max=o}}();const Ql=function(){const a=new V,t=new V,e=new V;return function(i,n,r){const o=i.start,l=a,c=n.start,h=t;e.subVectors(o,c),a.subVectors(i.end,i.start),t.subVectors(n.end,n.start);const d=e.dot(h),f=h.dot(l),u=h.dot(h),m=e.dot(l),_=l.dot(l)*u-f*f;let p,y;_!==0?p=(d*f-m*u)/_:p=0,y=(d+p*f)/u,r.x=p,r.y=y}}(),hn=function(){const a=new Wt,t=new V,e=new V;return function(i,n,r,o){Ql(i,n,a);let l=a.x,c=a.y;if(l>=0&&l<=1&&c>=0&&c<=1){i.at(l,r),n.at(c,o);return}else if(l>=0&&l<=1){c<0?n.at(0,o):n.at(1,o),i.closestPointToPoint(o,!0,r);return}else if(c>=0&&c<=1){l<0?i.at(0,r):i.at(1,r),n.closestPointToPoint(r,!0,o);return}else{let h;l<0?h=i.start:h=i.end;let d;c<0?d=n.start:d=n.end;const f=t,u=e;if(i.closestPointToPoint(d,!0,t),n.closestPointToPoint(h,!0,e),f.distanceToSquared(d)<=u.distanceToSquared(h)){r.copy(f),o.copy(d);return}else{r.copy(h),o.copy(u);return}}}}(),Kl=function(){const a=new V,t=new V,e=new pe,s=new le;return function(n,r){const{radius:o,center:l}=n,{a:c,b:h,c:d}=r;if(s.start=c,s.end=h,s.closestPointToPoint(l,!0,a).distanceTo(l)<=o||(s.start=c,s.end=d,s.closestPointToPoint(l,!0,a).distanceTo(l)<=o)||(s.start=h,s.end=d,s.closestPointToPoint(l,!0,a).distanceTo(l)<=o))return!0;const g=r.getPlane(e);if(Math.abs(g.distanceToPoint(l))<=o){const p=g.projectPoint(l,t);if(r.containsPoint(p))return!0}return!1}}(),Jl=1e-15;function Pi(a){return Math.abs(a)<Jl}class ce extends vs{constructor(...t){super(...t),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new V),this.satBounds=new Array(4).fill().map(()=>new ve),this.points=[this.a,this.b,this.c],this.sphere=new oi,this.plane=new pe,this.needsUpdate=!0}intersectsSphere(t){return Kl(t,this)}update(){const t=this.a,e=this.b,s=this.c,i=this.points,n=this.satAxes,r=this.satBounds,o=n[0],l=r[0];this.getNormal(o),l.setFromPoints(o,i);const c=n[1],h=r[1];c.subVectors(t,e),h.setFromPoints(c,i);const d=n[2],f=r[2];d.subVectors(e,s),f.setFromPoints(d,i);const u=n[3],m=r[3];u.subVectors(s,t),m.setFromPoints(u,i),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,t),this.needsUpdate=!1}}ce.prototype.closestPointToSegment=function(){const a=new V,t=new V,e=new le;return function(i,n=null,r=null){const{start:o,end:l}=i,c=this.points;let h,d=1/0;for(let f=0;f<3;f++){const u=(f+1)%3;e.start.copy(c[f]),e.end.copy(c[u]),hn(e,i,a,t),h=a.distanceToSquared(t),h<d&&(d=h,n&&n.copy(a),r&&r.copy(t))}return this.closestPointToPoint(o,a),h=o.distanceToSquared(a),h<d&&(d=h,n&&n.copy(a),r&&r.copy(o)),this.closestPointToPoint(l,a),h=l.distanceToSquared(a),h<d&&(d=h,n&&n.copy(a),r&&r.copy(l)),Math.sqrt(d)}}();ce.prototype.intersectsTriangle=function(){const a=new ce,t=new Array(3),e=new Array(3),s=new ve,i=new ve,n=new V,r=new V,o=new V,l=new V,c=new V,h=new le,d=new le,f=new le,u=new V;function m(g,_,p){const y=g.points;let b=0,C=-1;for(let T=0;T<3;T++){const{start:S,end:A}=h;S.copy(y[T]),A.copy(y[(T+1)%3]),h.delta(r);const M=Pi(_.distanceToPoint(S));if(Pi(_.normal.dot(r))&&M){p.copy(h),b=2;break}const P=_.intersectLine(h,u);if(!P&&M&&u.copy(S),(P||M)&&!Pi(u.distanceTo(A))){if(b<=1)(b===1?p.start:p.end).copy(u),M&&(C=b);else if(b>=2){(C===1?p.start:p.end).copy(u),b=2;break}if(b++,b===2&&C===-1)break}}return b}return function(_,p=null,y=!1){this.needsUpdate&&this.update(),_.isExtendedTriangle?_.needsUpdate&&_.update():(a.copy(_),a.update(),_=a);const b=this.plane,C=_.plane;if(Math.abs(b.normal.dot(C.normal))>1-1e-10){const T=this.satBounds,S=this.satAxes;e[0]=_.a,e[1]=_.b,e[2]=_.c;for(let P=0;P<4;P++){const N=T[P],H=S[P];if(s.setFromPoints(H,e),N.isSeparated(s))return!1}const A=_.satBounds,M=_.satAxes;t[0]=this.a,t[1]=this.b,t[2]=this.c;for(let P=0;P<4;P++){const N=A[P],H=M[P];if(s.setFromPoints(H,t),N.isSeparated(s))return!1}for(let P=0;P<4;P++){const N=S[P];for(let H=0;H<4;H++){const E=M[H];if(n.crossVectors(N,E),s.setFromPoints(n,t),i.setFromPoints(n,e),s.isSeparated(i))return!1}}return p&&(y||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),p.start.set(0,0,0),p.end.set(0,0,0)),!0}else{const T=m(this,C,d);if(T===1&&_.containsPoint(d.end))return p&&(p.start.copy(d.end),p.end.copy(d.end)),!0;if(T!==2)return!1;const S=m(_,b,f);if(S===1&&this.containsPoint(f.end))return p&&(p.start.copy(f.end),p.end.copy(f.end)),!0;if(S!==2)return!1;if(d.delta(o),f.delta(l),o.dot(l)<0){let k=f.start;f.start=f.end,f.end=k}const A=d.start.dot(o),M=d.end.dot(o),P=f.start.dot(o),N=f.end.dot(o),H=M<P,E=A<N;return A!==N&&P!==M&&H===E?!1:(p&&(c.subVectors(d.start,f.start),c.dot(o)>0?p.start.copy(d.start):p.start.copy(f.start),c.subVectors(d.end,f.end),c.dot(o)<0?p.end.copy(d.end):p.end.copy(f.end)),!0)}}}();ce.prototype.distanceToPoint=function(){const a=new V;return function(e){return this.closestPointToPoint(e,a),e.distanceTo(a)}}();ce.prototype.distanceToTriangle=function(){const a=new V,t=new V,e=["a","b","c"],s=new le,i=new le;return function(r,o=null,l=null){const c=o||l?s:null;if(this.intersectsTriangle(r,c))return(o||l)&&(o&&c.getCenter(o),l&&c.getCenter(l)),0;let h=1/0;for(let d=0;d<3;d++){let f;const u=e[d],m=r[u];this.closestPointToPoint(m,a),f=m.distanceToSquared(a),f<h&&(h=f,o&&o.copy(a),l&&l.copy(m));const g=this[u];r.closestPointToPoint(g,a),f=g.distanceToSquared(a),f<h&&(h=f,o&&o.copy(g),l&&l.copy(a))}for(let d=0;d<3;d++){const f=e[d],u=e[(d+1)%3];s.set(this[f],this[u]);for(let m=0;m<3;m++){const g=e[m],_=e[(m+1)%3];i.set(r[g],r[_]),hn(s,i,a,t);const p=a.distanceToSquared(t);p<h&&(h=p,o&&o.copy(a),l&&l.copy(t))}}return Math.sqrt(h)}}();class Yt{constructor(t,e,s){this.isOrientedBox=!0,this.min=new V,this.max=new V,this.matrix=new Ot,this.invMatrix=new Ot,this.points=new Array(8).fill().map(()=>new V),this.satAxes=new Array(3).fill().map(()=>new V),this.satBounds=new Array(3).fill().map(()=>new ve),this.alignedSatBounds=new Array(3).fill().map(()=>new ve),this.needsUpdate=!1,t&&this.min.copy(t),e&&this.max.copy(e),s&&this.matrix.copy(s)}set(t,e,s){this.min.copy(t),this.max.copy(e),this.matrix.copy(s),this.needsUpdate=!0}copy(t){this.min.copy(t.min),this.max.copy(t.max),this.matrix.copy(t.matrix),this.needsUpdate=!0}}Yt.prototype.update=function(){return function(){const t=this.matrix,e=this.min,s=this.max,i=this.points;for(let c=0;c<=1;c++)for(let h=0;h<=1;h++)for(let d=0;d<=1;d++){const f=1*c|2*h|4*d,u=i[f];u.x=c?s.x:e.x,u.y=h?s.y:e.y,u.z=d?s.z:e.z,u.applyMatrix4(t)}const n=this.satBounds,r=this.satAxes,o=i[0];for(let c=0;c<3;c++){const h=r[c],d=n[c],f=1<<c,u=i[f];h.subVectors(o,u),d.setFromPoints(h,i)}const l=this.alignedSatBounds;l[0].setFromPointsField(i,"x"),l[1].setFromPointsField(i,"y"),l[2].setFromPointsField(i,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}();Yt.prototype.intersectsBox=function(){const a=new ve;return function(e){this.needsUpdate&&this.update();const s=e.min,i=e.max,n=this.satBounds,r=this.satAxes,o=this.alignedSatBounds;if(a.min=s.x,a.max=i.x,o[0].isSeparated(a)||(a.min=s.y,a.max=i.y,o[1].isSeparated(a))||(a.min=s.z,a.max=i.z,o[2].isSeparated(a)))return!1;for(let l=0;l<3;l++){const c=r[l],h=n[l];if(a.setFromBox(c,e),h.isSeparated(a))return!1}return!0}}();Yt.prototype.intersectsTriangle=function(){const a=new ce,t=new Array(3),e=new ve,s=new ve,i=new V;return function(r){this.needsUpdate&&this.update(),r.isExtendedTriangle?r.needsUpdate&&r.update():(a.copy(r),a.update(),r=a);const o=this.satBounds,l=this.satAxes;t[0]=r.a,t[1]=r.b,t[2]=r.c;for(let f=0;f<3;f++){const u=o[f],m=l[f];if(e.setFromPoints(m,t),u.isSeparated(e))return!1}const c=r.satBounds,h=r.satAxes,d=this.points;for(let f=0;f<3;f++){const u=c[f],m=h[f];if(e.setFromPoints(m,d),u.isSeparated(e))return!1}for(let f=0;f<3;f++){const u=l[f];for(let m=0;m<4;m++){const g=h[m];if(i.crossVectors(u,g),e.setFromPoints(i,t),s.setFromPoints(i,d),e.isSeparated(s))return!1}}return!0}}();Yt.prototype.closestPointToPoint=function(){return function(t,e){return this.needsUpdate&&this.update(),e.copy(t).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e}}();Yt.prototype.distanceToPoint=function(){const a=new V;return function(e){return this.closestPointToPoint(e,a),e.distanceTo(a)}}();Yt.prototype.distanceToBox=function(){const a=["x","y","z"],t=new Array(12).fill().map(()=>new le),e=new Array(12).fill().map(()=>new le),s=new V,i=new V;return function(r,o=0,l=null,c=null){if(this.needsUpdate&&this.update(),this.intersectsBox(r))return(l||c)&&(r.getCenter(i),this.closestPointToPoint(i,s),r.closestPointToPoint(s,i),l&&l.copy(s),c&&c.copy(i)),0;const h=o*o,d=r.min,f=r.max,u=this.points;let m=1/0;for(let _=0;_<8;_++){const p=u[_];i.copy(p).clamp(d,f);const y=p.distanceToSquared(i);if(y<m&&(m=y,l&&l.copy(p),c&&c.copy(i),y<h))return Math.sqrt(y)}let g=0;for(let _=0;_<3;_++)for(let p=0;p<=1;p++)for(let y=0;y<=1;y++){const b=(_+1)%3,C=(_+2)%3,T=p<<b|y<<C,S=1<<_|p<<b|y<<C,A=u[T],M=u[S];t[g].set(A,M);const N=a[_],H=a[b],E=a[C],k=e[g],w=k.start,z=k.end;w[N]=d[N],w[H]=p?d[H]:f[H],w[E]=y?d[E]:f[H],z[N]=f[N],z[H]=p?d[H]:f[H],z[E]=y?d[E]:f[H],g++}for(let _=0;_<=1;_++)for(let p=0;p<=1;p++)for(let y=0;y<=1;y++){i.x=_?f.x:d.x,i.y=p?f.y:d.y,i.z=y?f.z:d.z,this.closestPointToPoint(i,s);const b=i.distanceToSquared(s);if(b<m&&(m=b,l&&l.copy(s),c&&c.copy(i),b<h))return Math.sqrt(b)}for(let _=0;_<12;_++){const p=t[_];for(let y=0;y<12;y++){const b=e[y];hn(p,b,s,i);const C=s.distanceToSquared(i);if(C<m&&(m=C,l&&l.copy(s),c&&c.copy(i),C<h))return Math.sqrt(C)}}return Math.sqrt(m)}}();class un{constructor(t){this._getNewPrimitive=t,this._primitives=[]}getPrimitive(){const t=this._primitives;return t.length===0?this._getNewPrimitive():t.pop()}releasePrimitive(t){this._primitives.push(t)}}class tc extends un{constructor(){super(()=>new ce)}}const Jt=new tc;function Xt(a,t){return t[a+15]===65535}function Gt(a,t){return t[a+6]}function te(a,t){return t[a+14]}function ee(a){return a+8}function se(a,t){return t[a+6]}function ao(a,t){return t[a+7]}class ec{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const t=[];let e=null;this.setBuffer=s=>{e&&t.push(e),e=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{e=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,t.length!==0&&this.setBuffer(t.pop())}}}const wt=new ec;let Ae,Qe;const Ue=[],Vs=new un(()=>new Ft);function sc(a,t,e,s,i,n){Ae=Vs.getPrimitive(),Qe=Vs.getPrimitive(),Ue.push(Ae,Qe),wt.setBuffer(a._roots[t]);const r=Zi(0,a.geometry,e,s,i,n);wt.clearBuffer(),Vs.releasePrimitive(Ae),Vs.releasePrimitive(Qe),Ue.pop(),Ue.pop();const o=Ue.length;return o>0&&(Qe=Ue[o-1],Ae=Ue[o-2]),r}function Zi(a,t,e,s,i=null,n=0,r=0){const{float32Array:o,uint16Array:l,uint32Array:c}=wt;let h=a*2;if(Xt(h,l)){const f=Gt(a,c),u=te(h,l);return Ct(a,o,Ae),s(f,u,!1,r,n+a,Ae)}else{let f=function(E){const{uint16Array:k,uint32Array:w}=wt;let z=E*2;for(;!Xt(z,k);)E=ee(E),z=E*2;return Gt(E,w)},u=function(E){const{uint16Array:k,uint32Array:w}=wt;let z=E*2;for(;!Xt(z,k);)E=se(E,w),z=E*2;return Gt(E,w)+te(z,k)};const m=ee(a),g=se(a,c);let _=m,p=g,y,b,C,T;if(i&&(C=Ae,T=Qe,Ct(_,o,C),Ct(p,o,T),y=i(C),b=i(T),b<y)){_=g,p=m;const E=y;y=b,b=E,C=T}C||(C=Ae,Ct(_,o,C));const S=Xt(_*2,l),A=e(C,S,y,r+1,n+_);let M;if(A===Rn){const E=f(_),w=u(_)-E;M=s(E,w,!0,r+1,n+_,C)}else M=A&&Zi(_,t,e,s,i,n,r+1);if(M)return!0;T=Qe,Ct(p,o,T);const P=Xt(p*2,l),N=e(T,P,b,r+1,n+p);let H;if(N===Rn){const E=f(p),w=u(p)-E;H=s(E,w,!0,r+1,n+p,T)}else H=N&&Zi(p,t,e,s,i,n,r+1);return!!H}}const fs=new V,Ii=new V;function ic(a,t,e={},s=0,i=1/0){const n=s*s,r=i*i;let o=1/0,l=null;if(a.shapecast({boundsTraverseOrder:h=>(fs.copy(t).clamp(h.min,h.max),fs.distanceToSquared(t)),intersectsBounds:(h,d,f)=>f<o&&f<r,intersectsTriangle:(h,d)=>{h.closestPointToPoint(t,fs);const f=t.distanceToSquared(fs);return f<o&&(Ii.copy(fs),o=f,l=d),f<n}}),o===1/0)return null;const c=Math.sqrt(o);return e.point?e.point.copy(Ii):e.point=Ii.clone(),e.distance=c,e.faceIndex=l,e}const Fe=new V,Ve=new V,He=new V,Hs=new Wt,$s=new Wt,Zs=new Wt,Hn=new V,$n=new V,Zn=new V,Ys=new V;function nc(a,t,e,s,i,n){let r;return n===$o?r=a.intersectTriangle(s,e,t,!0,i):r=a.intersectTriangle(t,e,s,n!==ci,i),r===null?null:{distance:a.origin.distanceTo(i),point:i.clone()}}function rc(a,t,e,s,i,n,r,o,l){Fe.fromBufferAttribute(t,n),Ve.fromBufferAttribute(t,r),He.fromBufferAttribute(t,o);const c=nc(a,Fe,Ve,He,Ys,l);if(c){s&&(Hs.fromBufferAttribute(s,n),$s.fromBufferAttribute(s,r),Zs.fromBufferAttribute(s,o),c.uv=vs.getInterpolation(Ys,Fe,Ve,He,Hs,$s,Zs,new Wt)),i&&(Hs.fromBufferAttribute(i,n),$s.fromBufferAttribute(i,r),Zs.fromBufferAttribute(i,o),c.uv1=vs.getInterpolation(Ys,Fe,Ve,He,Hs,$s,Zs,new Wt)),e&&(Hn.fromBufferAttribute(e,n),$n.fromBufferAttribute(e,r),Zn.fromBufferAttribute(e,o),c.normal=vs.getInterpolation(Ys,Fe,Ve,He,Hn,$n,Zn,new V),c.normal.dot(a.direction)>0&&c.normal.multiplyScalar(-1));const h={a:n,b:r,c:o,normal:new V,materialIndex:0};vs.getNormal(Fe,Ve,He,h.normal),c.face=h,c.faceIndex=n}return c}function gi(a,t,e,s,i){const n=s*3;let r=n+0,o=n+1,l=n+2;const c=a.index;a.index&&(r=c.getX(r),o=c.getX(o),l=c.getX(l));const{position:h,normal:d,uv:f,uv1:u}=a.attributes,m=rc(e,h,d,f,u,r,o,l,t);return m?(m.faceIndex=s,i&&i.push(m),m):null}function At(a,t,e,s){const i=a.a,n=a.b,r=a.c;let o=t,l=t+1,c=t+2;e&&(o=e.getX(o),l=e.getX(l),c=e.getX(c)),i.x=s.getX(o),i.y=s.getY(o),i.z=s.getZ(o),n.x=s.getX(l),n.y=s.getY(l),n.z=s.getZ(l),r.x=s.getX(c),r.y=s.getY(c),r.z=s.getZ(c)}function oc(a,t,e,s,i,n){const{geometry:r,_indirectBuffer:o}=a;for(let l=s,c=s+i;l<c;l++)gi(r,t,e,l,n)}function ac(a,t,e,s,i){const{geometry:n,_indirectBuffer:r}=a;let o=1/0,l=null;for(let c=s,h=s+i;c<h;c++){let d;d=gi(n,t,e,c),d&&d.distance<o&&(l=d,o=d.distance)}return l}function lc(a,t,e,s,i,n,r){const{geometry:o}=e,{index:l}=o,c=o.attributes.position;for(let h=a,d=t+a;h<d;h++){let f;if(f=h,At(r,f*3,l,c),r.needsUpdate=!0,s(r,f,i,n))return!0}return!1}function cc(a,t=null){t&&Array.isArray(t)&&(t=new Set(t));const e=a.geometry,s=e.index?e.index.array:null,i=e.attributes.position;let n,r,o,l,c=0;const h=a._roots;for(let f=0,u=h.length;f<u;f++)n=h[f],r=new Uint32Array(n),o=new Uint16Array(n),l=new Float32Array(n),d(0,c),c+=n.byteLength;function d(f,u,m=!1){const g=f*2;if(o[g+15]===mi){const p=r[f+6],y=o[g+14];let b=1/0,C=1/0,T=1/0,S=-1/0,A=-1/0,M=-1/0;for(let P=3*p,N=3*(p+y);P<N;P++){let H=s[P];const E=i.getX(H),k=i.getY(H),w=i.getZ(H);E<b&&(b=E),E>S&&(S=E),k<C&&(C=k),k>A&&(A=k),w<T&&(T=w),w>M&&(M=w)}return l[f+0]!==b||l[f+1]!==C||l[f+2]!==T||l[f+3]!==S||l[f+4]!==A||l[f+5]!==M?(l[f+0]=b,l[f+1]=C,l[f+2]=T,l[f+3]=S,l[f+4]=A,l[f+5]=M,!0):!1}else{const p=f+8,y=r[f+6],b=p+u,C=y+u;let T=m,S=!1,A=!1;t?T||(S=t.has(b),A=t.has(C),T=!S&&!A):(S=!0,A=!0);const M=T||S,P=T||A;let N=!1;M&&(N=d(p,u,T));let H=!1;P&&(H=d(y,u,T));const E=N||H;if(E)for(let k=0;k<3;k++){const w=p+k,z=y+k,X=l[w],$=l[w+3],st=l[z],Z=l[z+3];l[f+k]=X<st?X:st,l[f+k+3]=$>Z?$:Z}return E}}}const Yn=new Ft;function Oe(a,t,e,s){return Ct(a,t,Yn),e.intersectBox(Yn,s)}function hc(a,t,e,s,i,n){const{geometry:r,_indirectBuffer:o}=a;for(let l=s,c=s+i;l<c;l++){let h=o?o[l]:l;gi(r,t,e,h,n)}}function uc(a,t,e,s,i){const{geometry:n,_indirectBuffer:r}=a;let o=1/0,l=null;for(let c=s,h=s+i;c<h;c++){let d;d=gi(n,t,e,r?r[c]:c),d&&d.distance<o&&(l=d,o=d.distance)}return l}function dc(a,t,e,s,i,n,r){const{geometry:o}=e,{index:l}=o,c=o.attributes.position;for(let h=a,d=t+a;h<d;h++){let f;if(f=e.resolveTriangleIndex(h),At(r,f*3,l,c),r.needsUpdate=!0,s(r,f,i,n))return!0}return!1}const jn=new V;function fc(a,t,e,s,i){wt.setBuffer(a._roots[t]),Yi(0,a,e,s,i),wt.clearBuffer()}function Yi(a,t,e,s,i){const{float32Array:n,uint16Array:r,uint32Array:o}=wt,l=a*2;if(Xt(l,r)){const h=Gt(a,o),d=te(l,r);oc(t,e,s,h,d,i)}else{const h=ee(a);Oe(h,n,s,jn)&&Yi(h,t,e,s,i);const d=se(a,o);Oe(d,n,s,jn)&&Yi(d,t,e,s,i)}}const Wn=new V,pc=["x","y","z"];function mc(a,t,e,s){wt.setBuffer(a._roots[t]);const i=ji(0,a,e,s);return wt.clearBuffer(),i}function ji(a,t,e,s){const{float32Array:i,uint16Array:n,uint32Array:r}=wt;let o=a*2;if(Xt(o,n)){const c=Gt(a,r),h=te(o,n);return ac(t,e,s,c,h)}else{const c=ao(a,r),h=pc[c],f=s.direction[h]>=0;let u,m;f?(u=ee(a),m=se(a,r)):(u=se(a,r),m=ee(a));const _=Oe(u,i,s,Wn)?ji(u,t,e,s):null;if(_){const b=_.point[h];if(f?b<=i[m+c]:b>=i[m+c+3])return _}const y=Oe(m,i,s,Wn)?ji(m,t,e,s):null;return _&&y?_.distance<=y.distance?_:y:_||y||null}}const js=new Ft,$e=new ce,Ze=new ce,ps=new Ot,Xn=new Yt,Ws=new Yt;function gc(a,t,e,s){wt.setBuffer(a._roots[t]);const i=Wi(0,a,e,s);return wt.clearBuffer(),i}function Wi(a,t,e,s,i=null){const{float32Array:n,uint16Array:r,uint32Array:o}=wt;let l=a*2;if(i===null&&(e.boundingBox||e.computeBoundingBox(),Xn.set(e.boundingBox.min,e.boundingBox.max,s),i=Xn),Xt(l,r)){const h=t.geometry,d=h.index,f=h.attributes.position,u=e.index,m=e.attributes.position,g=Gt(a,o),_=te(l,r);if(ps.copy(s).invert(),e.boundsTree)return Ct(a,n,Ws),Ws.matrix.copy(ps),Ws.needsUpdate=!0,e.boundsTree.shapecast({intersectsBounds:y=>Ws.intersectsBox(y),intersectsTriangle:y=>{y.a.applyMatrix4(s),y.b.applyMatrix4(s),y.c.applyMatrix4(s),y.needsUpdate=!0;for(let b=g*3,C=(_+g)*3;b<C;b+=3)if(At(Ze,b,d,f),Ze.needsUpdate=!0,y.intersectsTriangle(Ze))return!0;return!1}});for(let p=g*3,y=(_+g)*3;p<y;p+=3){At($e,p,d,f),$e.a.applyMatrix4(ps),$e.b.applyMatrix4(ps),$e.c.applyMatrix4(ps),$e.needsUpdate=!0;for(let b=0,C=u.count;b<C;b+=3)if(At(Ze,b,u,m),Ze.needsUpdate=!0,$e.intersectsTriangle(Ze))return!0}}else{const h=a+8,d=o[a+6];return Ct(h,n,js),!!(i.intersectsBox(js)&&Wi(h,t,e,s,i)||(Ct(d,n,js),i.intersectsBox(js)&&Wi(d,t,e,s,i)))}}const Xs=new Ot,ki=new Yt,ms=new Yt,_c=new V,yc=new V,wc=new V,vc=new V;function bc(a,t,e,s={},i={},n=0,r=1/0){t.boundingBox||t.computeBoundingBox(),ki.set(t.boundingBox.min,t.boundingBox.max,e),ki.needsUpdate=!0;const o=a.geometry,l=o.attributes.position,c=o.index,h=t.attributes.position,d=t.index,f=Jt.getPrimitive(),u=Jt.getPrimitive();let m=_c,g=yc,_=null,p=null;i&&(_=wc,p=vc);let y=1/0,b=null,C=null;return Xs.copy(e).invert(),ms.matrix.copy(Xs),a.shapecast({boundsTraverseOrder:T=>ki.distanceToBox(T),intersectsBounds:(T,S,A)=>A<y&&A<r?(S&&(ms.min.copy(T.min),ms.max.copy(T.max),ms.needsUpdate=!0),!0):!1,intersectsRange:(T,S)=>{if(t.boundsTree)return t.boundsTree.shapecast({boundsTraverseOrder:M=>ms.distanceToBox(M),intersectsBounds:(M,P,N)=>N<y&&N<r,intersectsRange:(M,P)=>{for(let N=M,H=M+P;N<H;N++){At(u,3*N,d,h),u.a.applyMatrix4(e),u.b.applyMatrix4(e),u.c.applyMatrix4(e),u.needsUpdate=!0;for(let E=T,k=T+S;E<k;E++){At(f,3*E,c,l),f.needsUpdate=!0;const w=f.distanceToTriangle(u,m,_);if(w<y&&(g.copy(m),p&&p.copy(_),y=w,b=E,C=N),w<n)return!0}}}});{const A=Je(t);for(let M=0,P=A;M<P;M++){At(u,3*M,d,h),u.a.applyMatrix4(e),u.b.applyMatrix4(e),u.c.applyMatrix4(e),u.needsUpdate=!0;for(let N=T,H=T+S;N<H;N++){At(f,3*N,c,l),f.needsUpdate=!0;const E=f.distanceToTriangle(u,m,_);if(E<y&&(g.copy(m),p&&p.copy(_),y=E,b=N,C=M),E<n)return!0}}}}}),Jt.releasePrimitive(f),Jt.releasePrimitive(u),y===1/0?null:(s.point?s.point.copy(g):s.point=g.clone(),s.distance=y,s.faceIndex=b,i&&(i.point?i.point.copy(p):i.point=p.clone(),i.point.applyMatrix4(Xs),g.applyMatrix4(Xs),i.distance=g.sub(i.point).length(),i.faceIndex=C),s)}function xc(a,t=null){t&&Array.isArray(t)&&(t=new Set(t));const e=a.geometry,s=e.index?e.index.array:null,i=e.attributes.position;let n,r,o,l,c=0;const h=a._roots;for(let f=0,u=h.length;f<u;f++)n=h[f],r=new Uint32Array(n),o=new Uint16Array(n),l=new Float32Array(n),d(0,c),c+=n.byteLength;function d(f,u,m=!1){const g=f*2;if(o[g+15]===mi){const p=r[f+6],y=o[g+14];let b=1/0,C=1/0,T=1/0,S=-1/0,A=-1/0,M=-1/0;for(let P=p,N=p+y;P<N;P++){const H=3*a.resolveTriangleIndex(P);for(let E=0;E<3;E++){let k=H+E;k=s?s[k]:k;const w=i.getX(k),z=i.getY(k),X=i.getZ(k);w<b&&(b=w),w>S&&(S=w),z<C&&(C=z),z>A&&(A=z),X<T&&(T=X),X>M&&(M=X)}}return l[f+0]!==b||l[f+1]!==C||l[f+2]!==T||l[f+3]!==S||l[f+4]!==A||l[f+5]!==M?(l[f+0]=b,l[f+1]=C,l[f+2]=T,l[f+3]=S,l[f+4]=A,l[f+5]=M,!0):!1}else{const p=f+8,y=r[f+6],b=p+u,C=y+u;let T=m,S=!1,A=!1;t?T||(S=t.has(b),A=t.has(C),T=!S&&!A):(S=!0,A=!0);const M=T||S,P=T||A;let N=!1;M&&(N=d(p,u,T));let H=!1;P&&(H=d(y,u,T));const E=N||H;if(E)for(let k=0;k<3;k++){const w=p+k,z=y+k,X=l[w],$=l[w+3],st=l[z],Z=l[z+3];l[f+k]=X<st?X:st,l[f+k+3]=$>Z?$:Z}return E}}}const qn=new V;function Cc(a,t,e,s,i){wt.setBuffer(a._roots[t]),Xi(0,a,e,s,i),wt.clearBuffer()}function Xi(a,t,e,s,i){const{float32Array:n,uint16Array:r,uint32Array:o}=wt,l=a*2;if(Xt(l,r)){const h=Gt(a,o),d=te(l,r);hc(t,e,s,h,d,i)}else{const h=ee(a);Oe(h,n,s,qn)&&Xi(h,t,e,s,i);const d=se(a,o);Oe(d,n,s,qn)&&Xi(d,t,e,s,i)}}const Gn=new V,Tc=["x","y","z"];function Ec(a,t,e,s){wt.setBuffer(a._roots[t]);const i=qi(0,a,e,s);return wt.clearBuffer(),i}function qi(a,t,e,s){const{float32Array:i,uint16Array:n,uint32Array:r}=wt;let o=a*2;if(Xt(o,n)){const c=Gt(a,r),h=te(o,n);return uc(t,e,s,c,h)}else{const c=ao(a,r),h=Tc[c],f=s.direction[h]>=0;let u,m;f?(u=ee(a),m=se(a,r)):(u=se(a,r),m=ee(a));const _=Oe(u,i,s,Gn)?qi(u,t,e,s):null;if(_){const b=_.point[h];if(f?b<=i[m+c]:b>=i[m+c+3])return _}const y=Oe(m,i,s,Gn)?qi(m,t,e,s):null;return _&&y?_.distance<=y.distance?_:y:_||y||null}}const qs=new Ft,Ye=new ce,je=new ce,gs=new Ot,Qn=new Yt,Gs=new Yt;function Sc(a,t,e,s){wt.setBuffer(a._roots[t]);const i=Gi(0,a,e,s);return wt.clearBuffer(),i}function Gi(a,t,e,s,i=null){const{float32Array:n,uint16Array:r,uint32Array:o}=wt;let l=a*2;if(i===null&&(e.boundingBox||e.computeBoundingBox(),Qn.set(e.boundingBox.min,e.boundingBox.max,s),i=Qn),Xt(l,r)){const h=t.geometry,d=h.index,f=h.attributes.position,u=e.index,m=e.attributes.position,g=Gt(a,o),_=te(l,r);if(gs.copy(s).invert(),e.boundsTree)return Ct(a,n,Gs),Gs.matrix.copy(gs),Gs.needsUpdate=!0,e.boundsTree.shapecast({intersectsBounds:y=>Gs.intersectsBox(y),intersectsTriangle:y=>{y.a.applyMatrix4(s),y.b.applyMatrix4(s),y.c.applyMatrix4(s),y.needsUpdate=!0;for(let b=g,C=_+g;b<C;b++)if(At(je,3*t.resolveTriangleIndex(b),d,f),je.needsUpdate=!0,y.intersectsTriangle(je))return!0;return!1}});for(let p=g,y=_+g;p<y;p++){const b=t.resolveTriangleIndex(p);At(Ye,3*b,d,f),Ye.a.applyMatrix4(gs),Ye.b.applyMatrix4(gs),Ye.c.applyMatrix4(gs),Ye.needsUpdate=!0;for(let C=0,T=u.count;C<T;C+=3)if(At(je,C,u,m),je.needsUpdate=!0,Ye.intersectsTriangle(je))return!0}}else{const h=a+8,d=o[a+6];return Ct(h,n,qs),!!(i.intersectsBox(qs)&&Gi(h,t,e,s,i)||(Ct(d,n,qs),i.intersectsBox(qs)&&Gi(d,t,e,s,i)))}}const Qs=new Ot,Mi=new Yt,_s=new Yt,Ac=new V,Oc=new V,Pc=new V,Ic=new V;function kc(a,t,e,s={},i={},n=0,r=1/0){t.boundingBox||t.computeBoundingBox(),Mi.set(t.boundingBox.min,t.boundingBox.max,e),Mi.needsUpdate=!0;const o=a.geometry,l=o.attributes.position,c=o.index,h=t.attributes.position,d=t.index,f=Jt.getPrimitive(),u=Jt.getPrimitive();let m=Ac,g=Oc,_=null,p=null;i&&(_=Pc,p=Ic);let y=1/0,b=null,C=null;return Qs.copy(e).invert(),_s.matrix.copy(Qs),a.shapecast({boundsTraverseOrder:T=>Mi.distanceToBox(T),intersectsBounds:(T,S,A)=>A<y&&A<r?(S&&(_s.min.copy(T.min),_s.max.copy(T.max),_s.needsUpdate=!0),!0):!1,intersectsRange:(T,S)=>{if(t.boundsTree){const A=t.boundsTree;return A.shapecast({boundsTraverseOrder:M=>_s.distanceToBox(M),intersectsBounds:(M,P,N)=>N<y&&N<r,intersectsRange:(M,P)=>{for(let N=M,H=M+P;N<H;N++){const E=A.resolveTriangleIndex(N);At(u,3*E,d,h),u.a.applyMatrix4(e),u.b.applyMatrix4(e),u.c.applyMatrix4(e),u.needsUpdate=!0;for(let k=T,w=T+S;k<w;k++){const z=a.resolveTriangleIndex(k);At(f,3*z,c,l),f.needsUpdate=!0;const X=f.distanceToTriangle(u,m,_);if(X<y&&(g.copy(m),p&&p.copy(_),y=X,b=k,C=N),X<n)return!0}}}})}else{const A=Je(t);for(let M=0,P=A;M<P;M++){At(u,3*M,d,h),u.a.applyMatrix4(e),u.b.applyMatrix4(e),u.c.applyMatrix4(e),u.needsUpdate=!0;for(let N=T,H=T+S;N<H;N++){const E=a.resolveTriangleIndex(N);At(f,3*E,c,l),f.needsUpdate=!0;const k=f.distanceToTriangle(u,m,_);if(k<y&&(g.copy(m),p&&p.copy(_),y=k,b=N,C=M),k<n)return!0}}}}}),Jt.releasePrimitive(f),Jt.releasePrimitive(u),y===1/0?null:(s.point?s.point.copy(g):s.point=g.clone(),s.distance=y,s.faceIndex=b,i&&(i.point?i.point.copy(p):i.point=p.clone(),i.point.applyMatrix4(Qs),g.applyMatrix4(Qs),i.distance=g.sub(i.point).length(),i.faceIndex=C),s)}function Mc(){return typeof SharedArrayBuffer<"u"}const Es=new wt.constructor,li=new wt.constructor,Se=new un(()=>new Ft),We=new Ft,Xe=new Ft,zi=new Ft,Ni=new Ft;let Di=!1;function zc(a,t,e,s){if(Di)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Di=!0;const i=a._roots,n=t._roots;let r,o=0,l=0;const c=new Ot().copy(e).invert();for(let h=0,d=i.length;h<d;h++){Es.setBuffer(i[h]),l=0;const f=Se.getPrimitive();Ct(0,Es.float32Array,f),f.applyMatrix4(c);for(let u=0,m=n.length;u<m&&(li.setBuffer(n[h]),r=oe(0,0,e,c,s,o,l,0,0,f),li.clearBuffer(),l+=n[u].length,!r);u++);if(Se.releasePrimitive(f),Es.clearBuffer(),o+=i[h].length,r)break}return Di=!1,r}function oe(a,t,e,s,i,n=0,r=0,o=0,l=0,c=null,h=!1){let d,f;h?(d=li,f=Es):(d=Es,f=li);const u=d.float32Array,m=d.uint32Array,g=d.uint16Array,_=f.float32Array,p=f.uint32Array,y=f.uint16Array,b=a*2,C=t*2,T=Xt(b,g),S=Xt(C,y);let A=!1;if(S&&T)h?A=i(Gt(t,p),te(t*2,y),Gt(a,m),te(a*2,g),l,r+t,o,n+a):A=i(Gt(a,m),te(a*2,g),Gt(t,p),te(t*2,y),o,n+a,l,r+t);else if(S){const M=Se.getPrimitive();Ct(t,_,M),M.applyMatrix4(e);const P=ee(a),N=se(a,m);Ct(P,u,We),Ct(N,u,Xe);const H=M.intersectsBox(We),E=M.intersectsBox(Xe);A=H&&oe(t,P,s,e,i,r,n,l,o+1,M,!h)||E&&oe(t,N,s,e,i,r,n,l,o+1,M,!h),Se.releasePrimitive(M)}else{const M=ee(t),P=se(t,p);Ct(M,_,zi),Ct(P,_,Ni);const N=c.intersectsBox(zi),H=c.intersectsBox(Ni);if(N&&H)A=oe(a,M,e,s,i,n,r,o,l+1,c,h)||oe(a,P,e,s,i,n,r,o,l+1,c,h);else if(N)if(T)A=oe(a,M,e,s,i,n,r,o,l+1,c,h);else{const E=Se.getPrimitive();E.copy(zi).applyMatrix4(e);const k=ee(a),w=se(a,m);Ct(k,u,We),Ct(w,u,Xe);const z=E.intersectsBox(We),X=E.intersectsBox(Xe);A=z&&oe(M,k,s,e,i,r,n,l,o+1,E,!h)||X&&oe(M,w,s,e,i,r,n,l,o+1,E,!h),Se.releasePrimitive(E)}else if(H)if(T)A=oe(a,P,e,s,i,n,r,o,l+1,c,h);else{const E=Se.getPrimitive();E.copy(Ni).applyMatrix4(e);const k=ee(a),w=se(a,m);Ct(k,u,We),Ct(w,u,Xe);const z=E.intersectsBox(We),X=E.intersectsBox(Xe);A=z&&oe(P,k,s,e,i,r,n,l,o+1,E,!h)||X&&oe(P,w,s,e,i,r,n,l,o+1,E,!h),Se.releasePrimitive(E)}}return A}const Ks=new Yt,Kn=new Ft;class dn{static serialize(t,e={}){e={cloneBuffers:!0,...e};const s=t.geometry,i=t._roots,n=t._indirectBuffer,r=s.getIndex();let o;return e.cloneBuffers?o={roots:i.map(l=>l.slice()),index:r.array.slice(),indirectBuffer:n?n.slice():null}:o={roots:i,index:r.array,indirectBuffer:n},o}static deserialize(t,e,s={}){s={setIndex:!0,indirect:!!t.indirectBuffer,...s};const{index:i,roots:n,indirectBuffer:r}=t,o=new dn(e,{...s,[Ai]:!0});if(o._roots=n,o._indirectBuffer=r||null,s.setIndex){const l=e.getIndex();if(l===null){const c=new Tr(t.index,1,!1);e.setIndex(c)}else l.array!==i&&(l.array.set(i),l.needsUpdate=!0)}return o}get indirect(){return!!this._indirectBuffer}constructor(t,e={}){if(t.isBufferGeometry){if(t.index&&t.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(e=Object.assign({strategy:no,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,[Ai]:!1},e),e.useSharedArrayBuffer&&!Mc())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=t,this._roots=null,this._indirectBuffer=null,e[Ai]||(Gl(this,e),!t.boundingBox&&e.setBoundingBox&&(t.boundingBox=this.getBoundingBox(new Ft)));const{_indirectBuffer:s}=this;this.resolveTriangleIndex=e.indirect?i=>s[i]:i=>i}refit(t=null){return(this.indirect?xc:cc)(this,t)}traverse(t,e=0){const s=this._roots[e],i=new Uint32Array(s),n=new Uint16Array(s);r(0);function r(o,l=0){const c=o*2,h=n[c+15]===mi;if(h){const d=i[o+6],f=n[c+14];t(l,h,new Float32Array(s,o*4,6),d,f)}else{const d=o+ii/4,f=i[o+6],u=i[o+7];t(l,h,new Float32Array(s,o*4,6),u)||(r(d,l+1),r(f,l+1))}}}raycast(t,e=wn){const s=this._roots,i=this.geometry,n=[],r=e.isMaterial,o=Array.isArray(e),l=i.groups,c=r?e.side:e,h=this.indirect?Cc:fc;for(let d=0,f=s.length;d<f;d++){const u=o?e[l[d].materialIndex].side:c,m=n.length;if(h(this,d,u,t,n),o){const g=l[d].materialIndex;for(let _=m,p=n.length;_<p;_++)n[_].face.materialIndex=g}}return n}raycastFirst(t,e=wn){const s=this._roots,i=this.geometry,n=e.isMaterial,r=Array.isArray(e);let o=null;const l=i.groups,c=n?e.side:e,h=this.indirect?Ec:mc;for(let d=0,f=s.length;d<f;d++){const u=r?e[l[d].materialIndex].side:c,m=h(this,d,u,t);m!=null&&(o==null||m.distance<o.distance)&&(o=m,r&&(m.face.materialIndex=l[d].materialIndex))}return o}intersectsGeometry(t,e){let s=!1;const i=this._roots,n=this.indirect?Sc:gc;for(let r=0,o=i.length;r<o&&(s=n(this,r,t,e),!s);r++);return s}shapecast(t){const e=Jt.getPrimitive(),s=this.indirect?dc:lc;let{boundsTraverseOrder:i,intersectsBounds:n,intersectsRange:r,intersectsTriangle:o}=t;if(r&&o){const d=r;r=(f,u,m,g,_)=>d(f,u,m,g,_)?!0:s(f,u,this,o,m,g,e)}else r||(o?r=(d,f,u,m)=>s(d,f,this,o,u,m,e):r=(d,f,u)=>u);let l=!1,c=0;const h=this._roots;for(let d=0,f=h.length;d<f;d++){const u=h[d];if(l=sc(this,d,n,r,i,c),l)break;c+=u.byteLength}return Jt.releasePrimitive(e),l}bvhcast(t,e,s){let{intersectsRanges:i,intersectsTriangles:n}=s;const r=Jt.getPrimitive(),o=this.geometry.index,l=this.geometry.attributes.position,c=this.indirect?m=>{const g=this.resolveTriangleIndex(m);At(r,g*3,o,l)}:m=>{At(r,m*3,o,l)},h=Jt.getPrimitive(),d=t.geometry.index,f=t.geometry.attributes.position,u=t.indirect?m=>{const g=t.resolveTriangleIndex(m);At(h,g*3,d,f)}:m=>{At(h,m*3,d,f)};if(n){const m=(g,_,p,y,b,C,T,S)=>{for(let A=p,M=p+y;A<M;A++){u(A),h.a.applyMatrix4(e),h.b.applyMatrix4(e),h.c.applyMatrix4(e),h.needsUpdate=!0;for(let P=g,N=g+_;P<N;P++)if(c(P),r.needsUpdate=!0,n(r,h,P,A,b,C,T,S))return!0}return!1};if(i){const g=i;i=function(_,p,y,b,C,T,S,A){return g(_,p,y,b,C,T,S,A)?!0:m(_,p,y,b,C,T,S,A)}}else i=m}return zc(this,t,e,i)}intersectsBox(t,e){return Ks.set(t.min,t.max,e),Ks.needsUpdate=!0,this.shapecast({intersectsBounds:s=>Ks.intersectsBox(s),intersectsTriangle:s=>Ks.intersectsTriangle(s)})}intersectsSphere(t){return this.shapecast({intersectsBounds:e=>t.intersectsBox(e),intersectsTriangle:e=>e.intersectsSphere(t)})}closestPointToGeometry(t,e,s={},i={},n=0,r=1/0){return(this.indirect?kc:bc)(this,t,e,s,i,n,r)}closestPointToPoint(t,e={},s=0,i=1/0){return ic(this,t,e,s,i)}getBoundingBox(t){return t.makeEmpty(),this._roots.forEach(s=>{Ct(0,new Float32Array(s),Kn),t.union(Kn)}),t}}function Jn(a,t,e){return a===null||(a.point.applyMatrix4(t.matrixWorld),a.distance=a.point.distanceTo(e.ray.origin),a.object=t,a.distance<e.near||a.distance>e.far)?null:a}const Li=new Io,tr=new Ot,Nc=et.prototype.raycast;function Dc(a,t){if(this.geometry.boundsTree){if(this.material===void 0)return;tr.copy(this.matrixWorld).invert(),Li.copy(a.ray).applyMatrix4(tr);const e=this.geometry.boundsTree;if(a.firstHitOnly===!0){const s=Jn(e.raycastFirst(Li,this.material),this,a);s&&t.push(s)}else{const s=e.raycast(Li,this.material);for(let i=0,n=s.length;i<n;i++){const r=Jn(s[i],this,a);r&&t.push(r)}}}else Nc.call(this,a,t)}function Lc(a){return this.boundsTree=new dn(this,a),this.boundsTree}function Rc(){this.boundsTree=null}const lo=class co{constructor(){x(this,"onDisposed",new it),x(this,"list",new Nt),x(this,"enabled",!1),x(this,"_clock"),x(this,"onInit",new it),x(this,"update",()=>{if(!this.enabled)return;const t=this._clock.getDelta();for(const[e,s]of this.list)s.enabled&&s.isUpdateable()&&s.update(t);requestAnimationFrame(this.update)}),this._clock=new Ao,co.setupBVH()}add(t,e){if(this.list.has(t))throw new Error("You're trying to add a component that already exists in the components instance. Use Components.get() instead.");qt.validate(t),this.list.set(t,e)}get(t){var e;const s=t.uuid;if(!this.list.has(s)){const i=new t(this);return(e=i.isDisposeable)!=null&&e.call(i)&&i.onDisposed.add(()=>this.list.delete(s)),this.list.has(s)||this.add(s,i),i}return this.list.get(s)}init(){this.enabled=!0;for(const[t,e]of this.list.entries())e.enabled=!0;this._clock.start(),this.update(),this.onInit.trigger()}dispose(){this.enabled=!1;let t;for(const[e,s]of this.list){if(s.enabled=!1,e===ct.uuid){t=s;continue}s.isDisposeable()&&s.dispose()}t==null||t.dispose(),this._clock.stop(),this.onDisposed.trigger()}static setupBVH(){ai.prototype.computeBoundsTree=Lc,ai.prototype.disposeBoundsTree=Rc,et.prototype.raycast=Dc}};x(lo,"release","2.4.3");let ho=lo;class Bc{constructor(t){x(this,"enabled",!1),x(this,"id","FirstPerson"),this.camera=t}set(t){if(this.enabled=t,t){if(this.camera.projection.current!=="Perspective"){this.camera.set("Orbit");return}this.setupFirstPersonCamera()}}setupFirstPersonCamera(){const t=this.camera.controls,e=new V;t.distance--,t.getPosition(e),t.minDistance=1,t.maxDistance=1,t.distance=1,t.moveTo(e.x,e.y,e.z),t.truckSpeed=50,t.mouseButtons.wheel=Ut.ACTION.DOLLY,t.touches.two=Ut.ACTION.TOUCH_ZOOM_TRUCK}}class Uc{constructor(t){x(this,"enabled",!0),x(this,"id","Orbit"),this.camera=t,this.activateOrbitControls()}set(t){this.enabled=t,t&&this.activateOrbitControls()}activateOrbitControls(){const t=this.camera.controls;t.minDistance=1,t.maxDistance=300;const e=new V;t.getPosition(e);const s=e.length();t.distance=s,t.truckSpeed=2;const{rotation:i}=this.camera.three,n=new V(0,0,-1).applyEuler(i),r=e.addScaledVector(n,s);t.moveTo(r.x,r.y,r.z)}}class Fc{constructor(t){x(this,"enabled",!1),x(this,"id","Plan"),x(this,"mouseAction1"),x(this,"mouseAction2"),x(this,"mouseInitialized",!1),x(this,"defaultAzimuthSpeed"),x(this,"defaultPolarSpeed"),this.camera=t,this.defaultAzimuthSpeed=t.controls.azimuthRotateSpeed,this.defaultPolarSpeed=t.controls.polarRotateSpeed}set(t){this.enabled=t;const e=this.camera.controls;e.azimuthRotateSpeed=t?0:this.defaultAzimuthSpeed,e.polarRotateSpeed=t?0:this.defaultPolarSpeed,this.mouseInitialized||(this.mouseAction1=e.touches.one,this.mouseAction2=e.touches.two,this.mouseInitialized=!0),t?(e.mouseButtons.left=Ut.ACTION.TRUCK,e.touches.one=Ut.ACTION.TOUCH_TRUCK,e.touches.two=Ut.ACTION.TOUCH_ZOOM):(e.mouseButtons.left=Ut.ACTION.ROTATE,e.touches.one=this.mouseAction1,e.touches.two=this.mouseAction2)}}class Vc{constructor(t){x(this,"onChanged",new it),x(this,"current","Perspective"),x(this,"camera"),x(this,"matchOrthoDistanceEnabled",!1),x(this,"_component"),x(this,"_previousDistance",-1),this._component=t,this.camera=t.three}async set(t){this.current!==t&&(t==="Orthographic"?this.setOrthoCamera():await this.setPerspectiveCamera(),this.onChanged.trigger(this.camera))}async toggle(){const e=this.current==="Perspective"?"Orthographic":"Perspective";await this.set(e)}setOrthoCamera(){if(this._component.mode===null||this._component.mode.id==="FirstPerson")return;this._previousDistance=this._component.controls.distance,this._component.controls.distance=200;const t=this.getPerspectiveDims();if(!t)return;const{width:e,height:s}=t;this.setupOrthoCamera(s,e),this.camera=this._component.threeOrtho,this.current="Orthographic"}getPerspectiveDims(){const t=this._component.currentWorld;if(!t||!t.renderer)return null;const e=new V;this._component.threePersp.getWorldDirection(e);const s=new V;this._component.controls.getTarget(s);const n=s.clone().sub(this._component.threePersp.position).dot(e),r=t.renderer.getSize(),o=r.x/r.y,l=this._component.threePersp,c=n*2*Math.atan(l.fov*(Math.PI/180)/2);return{width:c*o,height:c}}setupOrthoCamera(t,e){this._component.controls.mouseButtons.wheel=Ut.ACTION.ZOOM,this._component.controls.mouseButtons.middle=Ut.ACTION.ZOOM;const s=this._component.threePersp,i=this._component.threeOrtho;i.zoom=1,i.left=e/-2,i.right=e/2,i.top=t/2,i.bottom=t/-2,i.updateProjectionMatrix(),i.position.copy(s.position),i.quaternion.copy(s.quaternion),this._component.controls.camera=i}getDistance(){const t=this._component.threePersp,e=this._component.threeOrtho;return(e.top-e.bottom)/e.zoom/(2*Math.atan(t.fov*(Math.PI/180)/2))}async setPerspectiveCamera(){this._component.controls.mouseButtons.wheel=Ut.ACTION.DOLLY,this._component.controls.mouseButtons.middle=Ut.ACTION.DOLLY;const t=this._component.threePersp,e=this._component.threeOrtho;t.position.copy(e.position),t.quaternion.copy(e.quaternion),this._component.controls.mouseButtons.wheel=Ut.ACTION.DOLLY,this.matchOrthoDistanceEnabled?this._component.controls.distance=this.getDistance():this._component.controls.distance=this._previousDistance,await this._component.controls.zoomTo(1),t.updateProjectionMatrix(),this._component.controls.camera=t,this.camera=t,this.current="Perspective"}}class uo extends As{constructor(t){super(t),x(this,"projection"),x(this,"threeOrtho"),x(this,"threePersp"),x(this,"_userInputButtons",{}),x(this,"_frustumSize",50),x(this,"_navigationModes",new Map),x(this,"_mode",null),x(this,"previousSize",null),this.threePersp=this.three,this.threeOrtho=this.newOrthoCamera(),this.projection=new Vc(this),this.onAspectUpdated.add(()=>{this.setOrthoPerspCameraAspect()}),this.projection.onChanged.add(e=>{this.three=e,this.updateAspect()}),this.worlds.onItemSet.add(()=>{this._navigationModes.clear(),this._navigationModes.set("Orbit",new Uc(this)),this._navigationModes.set("FirstPerson",new Bc(this)),this._navigationModes.set("Plan",new Fc(this)),this._mode=this._navigationModes.get("Orbit"),this.mode.set(!0,{preventTargetAdjustment:!0}),this.currentWorld&&this.currentWorld.renderer&&(this.previousSize=this.currentWorld.renderer.getSize().clone())}),this.worlds.onItemDeleted.add(()=>{this._navigationModes.clear()})}get mode(){if(!this._mode)throw new Error("Mode not found, camera not initialized");return this._mode}dispose(){super.dispose(),this.threeOrtho.removeFromParent()}set(t){if(this.mode!==null&&this.mode.id!==t){if(this.mode.set(!1),!this._navigationModes.has(t))throw new Error("The specified mode does not exist!");this._mode=this._navigationModes.get(t),this.mode.set(!0)}}async fit(t,e=1.5){if(!this.enabled)return;const s=Number.MAX_VALUE,i=Number.MIN_VALUE,n=new V(s,s,s),r=new V(i,i,i);for(const u of t){const m=new Ft().setFromObject(u);m.min.x<n.x&&(n.x=m.min.x),m.min.y<n.y&&(n.y=m.min.y),m.min.z<n.z&&(n.z=m.min.z),m.max.x>r.x&&(r.x=m.max.x),m.max.y>r.y&&(r.y=m.max.y),m.max.z>r.z&&(r.z=m.max.z)}const o=new Ft(n,r),l=this.components.get(ct);if(l.initialized)for(const[,u]of l.list){const m=u.box;m.min.x<n.x&&(n.x=m.min.x),m.min.y<n.y&&(n.y=m.min.y),m.min.z<n.z&&(n.z=m.min.z),m.max.x>r.x&&(r.x=m.max.x),m.max.y>r.y&&(r.y=m.max.y),m.max.z>r.z&&(r.z=m.max.z)}const c=new V;o.getSize(c);const h=new V;o.getCenter(h);const d=Math.max(c.x,c.y,c.z)*e,f=new oi(h,d);await this.controls.fitToSphere(f,!0)}setUserInput(t){t?this.enableUserInput():this.disableUserInput()}addCustomNavigationMode(t){this._navigationModes.set(t.id,t)}disableUserInput(){this._userInputButtons.left=this.controls.mouseButtons.left,this._userInputButtons.right=this.controls.mouseButtons.right,this._userInputButtons.middle=this.controls.mouseButtons.middle,this._userInputButtons.wheel=this.controls.mouseButtons.wheel,this.controls.mouseButtons.left=0,this.controls.mouseButtons.right=0,this.controls.mouseButtons.middle=0,this.controls.mouseButtons.wheel=0}enableUserInput(){Object.keys(this._userInputButtons).length!==0&&(this.controls.mouseButtons.left=this._userInputButtons.left,this.controls.mouseButtons.right=this._userInputButtons.right,this.controls.mouseButtons.middle=this._userInputButtons.middle,this.controls.mouseButtons.wheel=this._userInputButtons.wheel)}newOrthoCamera(){const t=window.innerWidth/window.innerHeight;return new sn(this._frustumSize*t/-2,this._frustumSize*t/2,this._frustumSize/2,this._frustumSize/-2,.1,1e3)}setOrthoPerspCameraAspect(){if(!this.currentWorld||!this.currentWorld.renderer||!this.previousSize)return;const t=this.currentWorld.renderer.getSize(),e=this.threeOrtho.top,s=this.threeOrtho.right,i=t.y/this.previousSize.y,n=t.x/this.previousSize.x,r=e*i,o=s*n;this.threeOrtho.left=-o,this.threeOrtho.right=o,this.threeOrtho.top=r,this.threeOrtho.bottom=-r,this.threeOrtho.updateProjectionMatrix(),this.previousSize.copy(t)}}function Js(a){throw new Error('Could not dynamically require "'+a+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var fo={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(a,t){(function(e){a.exports=e()})(function(){return function e(s,i,n){function r(c,h){if(!i[c]){if(!s[c]){var d=typeof Js=="function"&&Js;if(!h&&d)return d(c,!0);if(o)return o(c,!0);var f=new Error("Cannot find module '"+c+"'");throw f.code="MODULE_NOT_FOUND",f}var u=i[c]={exports:{}};s[c][0].call(u.exports,function(m){var g=s[c][1][m];return r(g||m)},u,u.exports,e,s,i,n)}return i[c].exports}for(var o=typeof Js=="function"&&Js,l=0;l<n.length;l++)r(n[l]);return r}({1:[function(e,s,i){var n=e("./utils"),r=e("./support"),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";i.encode=function(l){for(var c,h,d,f,u,m,g,_=[],p=0,y=l.length,b=y,C=n.getTypeOf(l)!=="string";p<l.length;)b=y-p,d=C?(c=l[p++],h=p<y?l[p++]:0,p<y?l[p++]:0):(c=l.charCodeAt(p++),h=p<y?l.charCodeAt(p++):0,p<y?l.charCodeAt(p++):0),f=c>>2,u=(3&c)<<4|h>>4,m=1<b?(15&h)<<2|d>>6:64,g=2<b?63&d:64,_.push(o.charAt(f)+o.charAt(u)+o.charAt(m)+o.charAt(g));return _.join("")},i.decode=function(l){var c,h,d,f,u,m,g=0,_=0,p="data:";if(l.substr(0,p.length)===p)throw new Error("Invalid base64 input, it looks like a data url.");var y,b=3*(l=l.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(l.charAt(l.length-1)===o.charAt(64)&&b--,l.charAt(l.length-2)===o.charAt(64)&&b--,b%1!=0)throw new Error("Invalid base64 input, bad content length.");for(y=r.uint8array?new Uint8Array(0|b):new Array(0|b);g<l.length;)c=o.indexOf(l.charAt(g++))<<2|(f=o.indexOf(l.charAt(g++)))>>4,h=(15&f)<<4|(u=o.indexOf(l.charAt(g++)))>>2,d=(3&u)<<6|(m=o.indexOf(l.charAt(g++))),y[_++]=c,u!==64&&(y[_++]=h),m!==64&&(y[_++]=d);return y}},{"./support":30,"./utils":32}],2:[function(e,s,i){var n=e("./external"),r=e("./stream/DataWorker"),o=e("./stream/Crc32Probe"),l=e("./stream/DataLengthProbe");function c(h,d,f,u,m){this.compressedSize=h,this.uncompressedSize=d,this.crc32=f,this.compression=u,this.compressedContent=m}c.prototype={getContentWorker:function(){var h=new r(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new l("data_length")),d=this;return h.on("end",function(){if(this.streamInfo.data_length!==d.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),h},getCompressedWorker:function(){return new r(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},c.createWorkerFrom=function(h,d,f){return h.pipe(new o).pipe(new l("uncompressedSize")).pipe(d.compressWorker(f)).pipe(new l("compressedSize")).withStreamInfo("compression",d)},s.exports=c},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,s,i){var n=e("./stream/GenericWorker");i.STORE={magic:"\0\0",compressWorker:function(){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},i.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,s,i){var n=e("./utils"),r=function(){for(var o,l=[],c=0;c<256;c++){o=c;for(var h=0;h<8;h++)o=1&o?3988292384^o>>>1:o>>>1;l[c]=o}return l}();s.exports=function(o,l){return o!==void 0&&o.length?n.getTypeOf(o)!=="string"?function(c,h,d,f){var u=r,m=f+d;c^=-1;for(var g=f;g<m;g++)c=c>>>8^u[255&(c^h[g])];return-1^c}(0|l,o,o.length,0):function(c,h,d,f){var u=r,m=f+d;c^=-1;for(var g=f;g<m;g++)c=c>>>8^u[255&(c^h.charCodeAt(g))];return-1^c}(0|l,o,o.length,0):0}},{"./utils":32}],5:[function(e,s,i){i.base64=!1,i.binary=!1,i.dir=!1,i.createFolders=!0,i.date=null,i.compression=null,i.compressionOptions=null,i.comment=null,i.unixPermissions=null,i.dosPermissions=null},{}],6:[function(e,s,i){var n=null;n=typeof Promise<"u"?Promise:e("lie"),s.exports={Promise:n}},{lie:37}],7:[function(e,s,i){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",r=e("pako"),o=e("./utils"),l=e("./stream/GenericWorker"),c=n?"uint8array":"array";function h(d,f){l.call(this,"FlateWorker/"+d),this._pako=null,this._pakoAction=d,this._pakoOptions=f,this.meta={}}i.magic="\b\0",o.inherits(h,l),h.prototype.processChunk=function(d){this.meta=d.meta,this._pako===null&&this._createPako(),this._pako.push(o.transformTo(c,d.data),!1)},h.prototype.flush=function(){l.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},h.prototype.cleanUp=function(){l.prototype.cleanUp.call(this),this._pako=null},h.prototype._createPako=function(){this._pako=new r[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var d=this;this._pako.onData=function(f){d.push({data:f,meta:d.meta})}},i.compressWorker=function(d){return new h("Deflate",d)},i.uncompressWorker=function(){return new h("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(e,s,i){function n(u,m){var g,_="";for(g=0;g<m;g++)_+=String.fromCharCode(255&u),u>>>=8;return _}function r(u,m,g,_,p,y){var b,C,T=u.file,S=u.compression,A=y!==c.utf8encode,M=o.transformTo("string",y(T.name)),P=o.transformTo("string",c.utf8encode(T.name)),N=T.comment,H=o.transformTo("string",y(N)),E=o.transformTo("string",c.utf8encode(N)),k=P.length!==T.name.length,w=E.length!==N.length,z="",X="",$="",st=T.dir,Z=T.date,J={crc32:0,compressedSize:0,uncompressedSize:0};m&&!g||(J.crc32=u.crc32,J.compressedSize=u.compressedSize,J.uncompressedSize=u.uncompressedSize);var U=0;m&&(U|=8),A||!k&&!w||(U|=2048);var L=0,nt=0;st&&(L|=16),p==="UNIX"?(nt=798,L|=function(q,pt){var Tt=q;return q||(Tt=pt?16893:33204),(65535&Tt)<<16}(T.unixPermissions,st)):(nt=20,L|=function(q){return 63&(q||0)}(T.dosPermissions)),b=Z.getUTCHours(),b<<=6,b|=Z.getUTCMinutes(),b<<=5,b|=Z.getUTCSeconds()/2,C=Z.getUTCFullYear()-1980,C<<=4,C|=Z.getUTCMonth()+1,C<<=5,C|=Z.getUTCDate(),k&&(X=n(1,1)+n(h(M),4)+P,z+="up"+n(X.length,2)+X),w&&($=n(1,1)+n(h(H),4)+E,z+="uc"+n($.length,2)+$);var K="";return K+=`
\0`,K+=n(U,2),K+=S.magic,K+=n(b,2),K+=n(C,2),K+=n(J.crc32,4),K+=n(J.compressedSize,4),K+=n(J.uncompressedSize,4),K+=n(M.length,2),K+=n(z.length,2),{fileRecord:d.LOCAL_FILE_HEADER+K+M+z,dirRecord:d.CENTRAL_FILE_HEADER+n(nt,2)+K+n(H.length,2)+"\0\0\0\0"+n(L,4)+n(_,4)+M+z+H}}var o=e("../utils"),l=e("../stream/GenericWorker"),c=e("../utf8"),h=e("../crc32"),d=e("../signature");function f(u,m,g,_){l.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=m,this.zipPlatform=g,this.encodeFileName=_,this.streamFiles=u,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}o.inherits(f,l),f.prototype.push=function(u){var m=u.meta.percent||0,g=this.entriesCount,_=this._sources.length;this.accumulate?this.contentBuffer.push(u):(this.bytesWritten+=u.data.length,l.prototype.push.call(this,{data:u.data,meta:{currentFile:this.currentFile,percent:g?(m+100*(g-_-1))/g:100}}))},f.prototype.openedSource=function(u){this.currentSourceOffset=this.bytesWritten,this.currentFile=u.file.name;var m=this.streamFiles&&!u.file.dir;if(m){var g=r(u,m,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:g.fileRecord,meta:{percent:0}})}else this.accumulate=!0},f.prototype.closedSource=function(u){this.accumulate=!1;var m=this.streamFiles&&!u.file.dir,g=r(u,m,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(g.dirRecord),m)this.push({data:function(_){return d.DATA_DESCRIPTOR+n(_.crc32,4)+n(_.compressedSize,4)+n(_.uncompressedSize,4)}(u),meta:{percent:100}});else for(this.push({data:g.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},f.prototype.flush=function(){for(var u=this.bytesWritten,m=0;m<this.dirRecords.length;m++)this.push({data:this.dirRecords[m],meta:{percent:100}});var g=this.bytesWritten-u,_=function(p,y,b,C,T){var S=o.transformTo("string",T(C));return d.CENTRAL_DIRECTORY_END+"\0\0\0\0"+n(p,2)+n(p,2)+n(y,4)+n(b,4)+n(S.length,2)+S}(this.dirRecords.length,g,u,this.zipComment,this.encodeFileName);this.push({data:_,meta:{percent:100}})},f.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},f.prototype.registerPrevious=function(u){this._sources.push(u);var m=this;return u.on("data",function(g){m.processChunk(g)}),u.on("end",function(){m.closedSource(m.previous.streamInfo),m._sources.length?m.prepareNextSource():m.end()}),u.on("error",function(g){m.error(g)}),this},f.prototype.resume=function(){return!!l.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},f.prototype.error=function(u){var m=this._sources;if(!l.prototype.error.call(this,u))return!1;for(var g=0;g<m.length;g++)try{m[g].error(u)}catch{}return!0},f.prototype.lock=function(){l.prototype.lock.call(this);for(var u=this._sources,m=0;m<u.length;m++)u[m].lock()},s.exports=f},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,s,i){var n=e("../compressions"),r=e("./ZipFileWorker");i.generateWorker=function(o,l,c){var h=new r(l.streamFiles,c,l.platform,l.encodeFileName),d=0;try{o.forEach(function(f,u){d++;var m=function(y,b){var C=y||b,T=n[C];if(!T)throw new Error(C+" is not a valid compression method !");return T}(u.options.compression,l.compression),g=u.options.compressionOptions||l.compressionOptions||{},_=u.dir,p=u.date;u._compressWorker(m,g).withStreamInfo("file",{name:f,dir:_,date:p,comment:u.comment||"",unixPermissions:u.unixPermissions,dosPermissions:u.dosPermissions}).pipe(h)}),h.entriesCount=d}catch(f){h.error(f)}return h}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,s,i){function n(){if(!(this instanceof n))return new n;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var r=new n;for(var o in this)typeof this[o]!="function"&&(r[o]=this[o]);return r}}(n.prototype=e("./object")).loadAsync=e("./load"),n.support=e("./support"),n.defaults=e("./defaults"),n.version="3.10.1",n.loadAsync=function(r,o){return new n().loadAsync(r,o)},n.external=e("./external"),s.exports=n},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,s,i){var n=e("./utils"),r=e("./external"),o=e("./utf8"),l=e("./zipEntries"),c=e("./stream/Crc32Probe"),h=e("./nodejsUtils");function d(f){return new r.Promise(function(u,m){var g=f.decompressed.getContentWorker().pipe(new c);g.on("error",function(_){m(_)}).on("end",function(){g.streamInfo.crc32!==f.decompressed.crc32?m(new Error("Corrupted zip : CRC32 mismatch")):u()}).resume()})}s.exports=function(f,u){var m=this;return u=n.extend(u||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),h.isNode&&h.isStream(f)?r.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",f,!0,u.optimizedBinaryString,u.base64).then(function(g){var _=new l(u);return _.load(g),_}).then(function(g){var _=[r.Promise.resolve(g)],p=g.files;if(u.checkCRC32)for(var y=0;y<p.length;y++)_.push(d(p[y]));return r.Promise.all(_)}).then(function(g){for(var _=g.shift(),p=_.files,y=0;y<p.length;y++){var b=p[y],C=b.fileNameStr,T=n.resolve(b.fileNameStr);m.file(T,b.decompressed,{binary:!0,optimizedBinaryString:!0,date:b.date,dir:b.dir,comment:b.fileCommentStr.length?b.fileCommentStr:null,unixPermissions:b.unixPermissions,dosPermissions:b.dosPermissions,createFolders:u.createFolders}),b.dir||(m.file(T).unsafeOriginalName=C)}return _.zipComment.length&&(m.comment=_.zipComment),m})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,s,i){var n=e("../utils"),r=e("../stream/GenericWorker");function o(l,c){r.call(this,"Nodejs stream input adapter for "+l),this._upstreamEnded=!1,this._bindStream(c)}n.inherits(o,r),o.prototype._bindStream=function(l){var c=this;(this._stream=l).pause(),l.on("data",function(h){c.push({data:h,meta:{percent:0}})}).on("error",function(h){c.isPaused?this.generatedError=h:c.error(h)}).on("end",function(){c.isPaused?c._upstreamEnded=!0:c.end()})},o.prototype.pause=function(){return!!r.prototype.pause.call(this)&&(this._stream.pause(),!0)},o.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},s.exports=o},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,s,i){var n=e("readable-stream").Readable;function r(o,l,c){n.call(this,l),this._helper=o;var h=this;o.on("data",function(d,f){h.push(d)||h._helper.pause(),c&&c(f)}).on("error",function(d){h.emit("error",d)}).on("end",function(){h.push(null)})}e("../utils").inherits(r,n),r.prototype._read=function(){this._helper.resume()},s.exports=r},{"../utils":32,"readable-stream":16}],14:[function(e,s,i){s.exports={isNode:typeof Buffer<"u",newBufferFrom:function(n,r){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(n,r);if(typeof n=="number")throw new Error('The "data" argument must not be a number');return new Buffer(n,r)},allocBuffer:function(n){if(Buffer.alloc)return Buffer.alloc(n);var r=new Buffer(n);return r.fill(0),r},isBuffer:function(n){return Buffer.isBuffer(n)},isStream:function(n){return n&&typeof n.on=="function"&&typeof n.pause=="function"&&typeof n.resume=="function"}}},{}],15:[function(e,s,i){function n(T,S,A){var M,P=o.getTypeOf(S),N=o.extend(A||{},h);N.date=N.date||new Date,N.compression!==null&&(N.compression=N.compression.toUpperCase()),typeof N.unixPermissions=="string"&&(N.unixPermissions=parseInt(N.unixPermissions,8)),N.unixPermissions&&16384&N.unixPermissions&&(N.dir=!0),N.dosPermissions&&16&N.dosPermissions&&(N.dir=!0),N.dir&&(T=p(T)),N.createFolders&&(M=_(T))&&y.call(this,M,!0);var H=P==="string"&&N.binary===!1&&N.base64===!1;A&&A.binary!==void 0||(N.binary=!H),(S instanceof d&&S.uncompressedSize===0||N.dir||!S||S.length===0)&&(N.base64=!1,N.binary=!0,S="",N.compression="STORE",P="string");var E=null;E=S instanceof d||S instanceof l?S:m.isNode&&m.isStream(S)?new g(T,S):o.prepareContent(T,S,N.binary,N.optimizedBinaryString,N.base64);var k=new f(T,E,N);this.files[T]=k}var r=e("./utf8"),o=e("./utils"),l=e("./stream/GenericWorker"),c=e("./stream/StreamHelper"),h=e("./defaults"),d=e("./compressedObject"),f=e("./zipObject"),u=e("./generate"),m=e("./nodejsUtils"),g=e("./nodejs/NodejsStreamInputAdapter"),_=function(T){T.slice(-1)==="/"&&(T=T.substring(0,T.length-1));var S=T.lastIndexOf("/");return 0<S?T.substring(0,S):""},p=function(T){return T.slice(-1)!=="/"&&(T+="/"),T},y=function(T,S){return S=S!==void 0?S:h.createFolders,T=p(T),this.files[T]||n.call(this,T,null,{dir:!0,createFolders:S}),this.files[T]};function b(T){return Object.prototype.toString.call(T)==="[object RegExp]"}var C={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(T){var S,A,M;for(S in this.files)M=this.files[S],(A=S.slice(this.root.length,S.length))&&S.slice(0,this.root.length)===this.root&&T(A,M)},filter:function(T){var S=[];return this.forEach(function(A,M){T(A,M)&&S.push(M)}),S},file:function(T,S,A){if(arguments.length!==1)return T=this.root+T,n.call(this,T,S,A),this;if(b(T)){var M=T;return this.filter(function(N,H){return!H.dir&&M.test(N)})}var P=this.files[this.root+T];return P&&!P.dir?P:null},folder:function(T){if(!T)return this;if(b(T))return this.filter(function(P,N){return N.dir&&T.test(P)});var S=this.root+T,A=y.call(this,S),M=this.clone();return M.root=A.name,M},remove:function(T){T=this.root+T;var S=this.files[T];if(S||(T.slice(-1)!=="/"&&(T+="/"),S=this.files[T]),S&&!S.dir)delete this.files[T];else for(var A=this.filter(function(P,N){return N.name.slice(0,T.length)===T}),M=0;M<A.length;M++)delete this.files[A[M].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(T){var S,A={};try{if((A=o.extend(T||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:r.utf8encode})).type=A.type.toLowerCase(),A.compression=A.compression.toUpperCase(),A.type==="binarystring"&&(A.type="string"),!A.type)throw new Error("No output type specified.");o.checkSupport(A.type),A.platform!=="darwin"&&A.platform!=="freebsd"&&A.platform!=="linux"&&A.platform!=="sunos"||(A.platform="UNIX"),A.platform==="win32"&&(A.platform="DOS");var M=A.comment||this.comment||"";S=u.generateWorker(this,A,M)}catch(P){(S=new l("error")).error(P)}return new c(S,A.type||"string",A.mimeType)},generateAsync:function(T,S){return this.generateInternalStream(T).accumulate(S)},generateNodeStream:function(T,S){return(T=T||{}).type||(T.type="nodebuffer"),this.generateInternalStream(T).toNodejsStream(S)}};s.exports=C},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,s,i){s.exports=e("stream")},{stream:void 0}],17:[function(e,s,i){var n=e("./DataReader");function r(o){n.call(this,o);for(var l=0;l<this.data.length;l++)o[l]=255&o[l]}e("../utils").inherits(r,n),r.prototype.byteAt=function(o){return this.data[this.zero+o]},r.prototype.lastIndexOfSignature=function(o){for(var l=o.charCodeAt(0),c=o.charCodeAt(1),h=o.charCodeAt(2),d=o.charCodeAt(3),f=this.length-4;0<=f;--f)if(this.data[f]===l&&this.data[f+1]===c&&this.data[f+2]===h&&this.data[f+3]===d)return f-this.zero;return-1},r.prototype.readAndCheckSignature=function(o){var l=o.charCodeAt(0),c=o.charCodeAt(1),h=o.charCodeAt(2),d=o.charCodeAt(3),f=this.readData(4);return l===f[0]&&c===f[1]&&h===f[2]&&d===f[3]},r.prototype.readData=function(o){if(this.checkOffset(o),o===0)return[];var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},s.exports=r},{"../utils":32,"./DataReader":18}],18:[function(e,s,i){var n=e("../utils");function r(o){this.data=o,this.length=o.length,this.index=0,this.zero=0}r.prototype={checkOffset:function(o){this.checkIndex(this.index+o)},checkIndex:function(o){if(this.length<this.zero+o||o<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+o+"). Corrupted zip ?")},setIndex:function(o){this.checkIndex(o),this.index=o},skip:function(o){this.setIndex(this.index+o)},byteAt:function(){},readInt:function(o){var l,c=0;for(this.checkOffset(o),l=this.index+o-1;l>=this.index;l--)c=(c<<8)+this.byteAt(l);return this.index+=o,c},readString:function(o){return n.transformTo("string",this.readData(o))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var o=this.readInt(4);return new Date(Date.UTC(1980+(o>>25&127),(o>>21&15)-1,o>>16&31,o>>11&31,o>>5&63,(31&o)<<1))}},s.exports=r},{"../utils":32}],19:[function(e,s,i){var n=e("./Uint8ArrayReader");function r(o){n.call(this,o)}e("../utils").inherits(r,n),r.prototype.readData=function(o){this.checkOffset(o);var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},s.exports=r},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,s,i){var n=e("./DataReader");function r(o){n.call(this,o)}e("../utils").inherits(r,n),r.prototype.byteAt=function(o){return this.data.charCodeAt(this.zero+o)},r.prototype.lastIndexOfSignature=function(o){return this.data.lastIndexOf(o)-this.zero},r.prototype.readAndCheckSignature=function(o){return o===this.readData(4)},r.prototype.readData=function(o){this.checkOffset(o);var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},s.exports=r},{"../utils":32,"./DataReader":18}],21:[function(e,s,i){var n=e("./ArrayReader");function r(o){n.call(this,o)}e("../utils").inherits(r,n),r.prototype.readData=function(o){if(this.checkOffset(o),o===0)return new Uint8Array(0);var l=this.data.subarray(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},s.exports=r},{"../utils":32,"./ArrayReader":17}],22:[function(e,s,i){var n=e("../utils"),r=e("../support"),o=e("./ArrayReader"),l=e("./StringReader"),c=e("./NodeBufferReader"),h=e("./Uint8ArrayReader");s.exports=function(d){var f=n.getTypeOf(d);return n.checkSupport(f),f!=="string"||r.uint8array?f==="nodebuffer"?new c(d):r.uint8array?new h(n.transformTo("uint8array",d)):new o(n.transformTo("array",d)):new l(d)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,s,i){i.LOCAL_FILE_HEADER="PK",i.CENTRAL_FILE_HEADER="PK",i.CENTRAL_DIRECTORY_END="PK",i.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",i.ZIP64_CENTRAL_DIRECTORY_END="PK",i.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(e,s,i){var n=e("./GenericWorker"),r=e("../utils");function o(l){n.call(this,"ConvertWorker to "+l),this.destType=l}r.inherits(o,n),o.prototype.processChunk=function(l){this.push({data:r.transformTo(this.destType,l.data),meta:l.meta})},s.exports=o},{"../utils":32,"./GenericWorker":28}],25:[function(e,s,i){var n=e("./GenericWorker"),r=e("../crc32");function o(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}e("../utils").inherits(o,n),o.prototype.processChunk=function(l){this.streamInfo.crc32=r(l.data,this.streamInfo.crc32||0),this.push(l)},s.exports=o},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,s,i){var n=e("../utils"),r=e("./GenericWorker");function o(l){r.call(this,"DataLengthProbe for "+l),this.propName=l,this.withStreamInfo(l,0)}n.inherits(o,r),o.prototype.processChunk=function(l){if(l){var c=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=c+l.data.length}r.prototype.processChunk.call(this,l)},s.exports=o},{"../utils":32,"./GenericWorker":28}],27:[function(e,s,i){var n=e("../utils"),r=e("./GenericWorker");function o(l){r.call(this,"DataWorker");var c=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,l.then(function(h){c.dataIsReady=!0,c.data=h,c.max=h&&h.length||0,c.type=n.getTypeOf(h),c.isPaused||c._tickAndRepeat()},function(h){c.error(h)})}n.inherits(o,r),o.prototype.cleanUp=function(){r.prototype.cleanUp.call(this),this.data=null},o.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},o.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},o.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var l=null,c=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":l=this.data.substring(this.index,c);break;case"uint8array":l=this.data.subarray(this.index,c);break;case"array":case"nodebuffer":l=this.data.slice(this.index,c)}return this.index=c,this.push({data:l,meta:{percent:this.max?this.index/this.max*100:0}})},s.exports=o},{"../utils":32,"./GenericWorker":28}],28:[function(e,s,i){function n(r){this.name=r||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}n.prototype={push:function(r){this.emit("data",r)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(r){this.emit("error",r)}return!0},error:function(r){return!this.isFinished&&(this.isPaused?this.generatedError=r:(this.isFinished=!0,this.emit("error",r),this.previous&&this.previous.error(r),this.cleanUp()),!0)},on:function(r,o){return this._listeners[r].push(o),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(r,o){if(this._listeners[r])for(var l=0;l<this._listeners[r].length;l++)this._listeners[r][l].call(this,o)},pipe:function(r){return r.registerPrevious(this)},registerPrevious:function(r){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=r.streamInfo,this.mergeStreamInfo(),this.previous=r;var o=this;return r.on("data",function(l){o.processChunk(l)}),r.on("end",function(){o.end()}),r.on("error",function(l){o.error(l)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var r=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),r=!0),this.previous&&this.previous.resume(),!r},flush:function(){},processChunk:function(r){this.push(r)},withStreamInfo:function(r,o){return this.extraStreamInfo[r]=o,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var r in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,r)&&(this.streamInfo[r]=this.extraStreamInfo[r])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var r="Worker "+this.name;return this.previous?this.previous+" -> "+r:r}},s.exports=n},{}],29:[function(e,s,i){var n=e("../utils"),r=e("./ConvertWorker"),o=e("./GenericWorker"),l=e("../base64"),c=e("../support"),h=e("../external"),d=null;if(c.nodestream)try{d=e("../nodejs/NodejsStreamOutputAdapter")}catch{}function f(m,g){return new h.Promise(function(_,p){var y=[],b=m._internalType,C=m._outputType,T=m._mimeType;m.on("data",function(S,A){y.push(S),g&&g(A)}).on("error",function(S){y=[],p(S)}).on("end",function(){try{var S=function(A,M,P){switch(A){case"blob":return n.newBlob(n.transformTo("arraybuffer",M),P);case"base64":return l.encode(M);default:return n.transformTo(A,M)}}(C,function(A,M){var P,N=0,H=null,E=0;for(P=0;P<M.length;P++)E+=M[P].length;switch(A){case"string":return M.join("");case"array":return Array.prototype.concat.apply([],M);case"uint8array":for(H=new Uint8Array(E),P=0;P<M.length;P++)H.set(M[P],N),N+=M[P].length;return H;case"nodebuffer":return Buffer.concat(M);default:throw new Error("concat : unsupported type '"+A+"'")}}(b,y),T);_(S)}catch(A){p(A)}y=[]}).resume()})}function u(m,g,_){var p=g;switch(g){case"blob":case"arraybuffer":p="uint8array";break;case"base64":p="string"}try{this._internalType=p,this._outputType=g,this._mimeType=_,n.checkSupport(p),this._worker=m.pipe(new r(p)),m.lock()}catch(y){this._worker=new o("error"),this._worker.error(y)}}u.prototype={accumulate:function(m){return f(this,m)},on:function(m,g){var _=this;return m==="data"?this._worker.on(m,function(p){g.call(_,p.data,p.meta)}):this._worker.on(m,function(){n.delay(g,arguments,_)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(m){if(n.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new d(this,{objectMode:this._outputType!=="nodebuffer"},m)}},s.exports=u},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,s,i){if(i.base64=!0,i.array=!0,i.string=!0,i.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",i.nodebuffer=typeof Buffer<"u",i.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")i.blob=!1;else{var n=new ArrayBuffer(0);try{i.blob=new Blob([n],{type:"application/zip"}).size===0}catch{try{var r=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);r.append(n),i.blob=r.getBlob("application/zip").size===0}catch{i.blob=!1}}}try{i.nodestream=!!e("readable-stream").Readable}catch{i.nodestream=!1}},{"readable-stream":16}],31:[function(e,s,i){for(var n=e("./utils"),r=e("./support"),o=e("./nodejsUtils"),l=e("./stream/GenericWorker"),c=new Array(256),h=0;h<256;h++)c[h]=252<=h?6:248<=h?5:240<=h?4:224<=h?3:192<=h?2:1;c[254]=c[254]=1;function d(){l.call(this,"utf-8 decode"),this.leftOver=null}function f(){l.call(this,"utf-8 encode")}i.utf8encode=function(u){return r.nodebuffer?o.newBufferFrom(u,"utf-8"):function(m){var g,_,p,y,b,C=m.length,T=0;for(y=0;y<C;y++)(64512&(_=m.charCodeAt(y)))==55296&&y+1<C&&(64512&(p=m.charCodeAt(y+1)))==56320&&(_=65536+(_-55296<<10)+(p-56320),y++),T+=_<128?1:_<2048?2:_<65536?3:4;for(g=r.uint8array?new Uint8Array(T):new Array(T),y=b=0;b<T;y++)(64512&(_=m.charCodeAt(y)))==55296&&y+1<C&&(64512&(p=m.charCodeAt(y+1)))==56320&&(_=65536+(_-55296<<10)+(p-56320),y++),_<128?g[b++]=_:(_<2048?g[b++]=192|_>>>6:(_<65536?g[b++]=224|_>>>12:(g[b++]=240|_>>>18,g[b++]=128|_>>>12&63),g[b++]=128|_>>>6&63),g[b++]=128|63&_);return g}(u)},i.utf8decode=function(u){return r.nodebuffer?n.transformTo("nodebuffer",u).toString("utf-8"):function(m){var g,_,p,y,b=m.length,C=new Array(2*b);for(g=_=0;g<b;)if((p=m[g++])<128)C[_++]=p;else if(4<(y=c[p]))C[_++]=65533,g+=y-1;else{for(p&=y===2?31:y===3?15:7;1<y&&g<b;)p=p<<6|63&m[g++],y--;1<y?C[_++]=65533:p<65536?C[_++]=p:(p-=65536,C[_++]=55296|p>>10&1023,C[_++]=56320|1023&p)}return C.length!==_&&(C.subarray?C=C.subarray(0,_):C.length=_),n.applyFromCharCode(C)}(u=n.transformTo(r.uint8array?"uint8array":"array",u))},n.inherits(d,l),d.prototype.processChunk=function(u){var m=n.transformTo(r.uint8array?"uint8array":"array",u.data);if(this.leftOver&&this.leftOver.length){if(r.uint8array){var g=m;(m=new Uint8Array(g.length+this.leftOver.length)).set(this.leftOver,0),m.set(g,this.leftOver.length)}else m=this.leftOver.concat(m);this.leftOver=null}var _=function(y,b){var C;for((b=b||y.length)>y.length&&(b=y.length),C=b-1;0<=C&&(192&y[C])==128;)C--;return C<0||C===0?b:C+c[y[C]]>b?C:b}(m),p=m;_!==m.length&&(r.uint8array?(p=m.subarray(0,_),this.leftOver=m.subarray(_,m.length)):(p=m.slice(0,_),this.leftOver=m.slice(_,m.length))),this.push({data:i.utf8decode(p),meta:u.meta})},d.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:i.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},i.Utf8DecodeWorker=d,n.inherits(f,l),f.prototype.processChunk=function(u){this.push({data:i.utf8encode(u.data),meta:u.meta})},i.Utf8EncodeWorker=f},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,s,i){var n=e("./support"),r=e("./base64"),o=e("./nodejsUtils"),l=e("./external");function c(g){return g}function h(g,_){for(var p=0;p<g.length;++p)_[p]=255&g.charCodeAt(p);return _}e("setimmediate"),i.newBlob=function(g,_){i.checkSupport("blob");try{return new Blob([g],{type:_})}catch{try{var p=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return p.append(g),p.getBlob(_)}catch{throw new Error("Bug : can't construct the Blob.")}}};var d={stringifyByChunk:function(g,_,p){var y=[],b=0,C=g.length;if(C<=p)return String.fromCharCode.apply(null,g);for(;b<C;)_==="array"||_==="nodebuffer"?y.push(String.fromCharCode.apply(null,g.slice(b,Math.min(b+p,C)))):y.push(String.fromCharCode.apply(null,g.subarray(b,Math.min(b+p,C)))),b+=p;return y.join("")},stringifyByChar:function(g){for(var _="",p=0;p<g.length;p++)_+=String.fromCharCode(g[p]);return _},applyCanBeUsed:{uint8array:function(){try{return n.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return n.nodebuffer&&String.fromCharCode.apply(null,o.allocBuffer(1)).length===1}catch{return!1}}()}};function f(g){var _=65536,p=i.getTypeOf(g),y=!0;if(p==="uint8array"?y=d.applyCanBeUsed.uint8array:p==="nodebuffer"&&(y=d.applyCanBeUsed.nodebuffer),y)for(;1<_;)try{return d.stringifyByChunk(g,p,_)}catch{_=Math.floor(_/2)}return d.stringifyByChar(g)}function u(g,_){for(var p=0;p<g.length;p++)_[p]=g[p];return _}i.applyFromCharCode=f;var m={};m.string={string:c,array:function(g){return h(g,new Array(g.length))},arraybuffer:function(g){return m.string.uint8array(g).buffer},uint8array:function(g){return h(g,new Uint8Array(g.length))},nodebuffer:function(g){return h(g,o.allocBuffer(g.length))}},m.array={string:f,array:c,arraybuffer:function(g){return new Uint8Array(g).buffer},uint8array:function(g){return new Uint8Array(g)},nodebuffer:function(g){return o.newBufferFrom(g)}},m.arraybuffer={string:function(g){return f(new Uint8Array(g))},array:function(g){return u(new Uint8Array(g),new Array(g.byteLength))},arraybuffer:c,uint8array:function(g){return new Uint8Array(g)},nodebuffer:function(g){return o.newBufferFrom(new Uint8Array(g))}},m.uint8array={string:f,array:function(g){return u(g,new Array(g.length))},arraybuffer:function(g){return g.buffer},uint8array:c,nodebuffer:function(g){return o.newBufferFrom(g)}},m.nodebuffer={string:f,array:function(g){return u(g,new Array(g.length))},arraybuffer:function(g){return m.nodebuffer.uint8array(g).buffer},uint8array:function(g){return u(g,new Uint8Array(g.length))},nodebuffer:c},i.transformTo=function(g,_){if(_=_||"",!g)return _;i.checkSupport(g);var p=i.getTypeOf(_);return m[p][g](_)},i.resolve=function(g){for(var _=g.split("/"),p=[],y=0;y<_.length;y++){var b=_[y];b==="."||b===""&&y!==0&&y!==_.length-1||(b===".."?p.pop():p.push(b))}return p.join("/")},i.getTypeOf=function(g){return typeof g=="string"?"string":Object.prototype.toString.call(g)==="[object Array]"?"array":n.nodebuffer&&o.isBuffer(g)?"nodebuffer":n.uint8array&&g instanceof Uint8Array?"uint8array":n.arraybuffer&&g instanceof ArrayBuffer?"arraybuffer":void 0},i.checkSupport=function(g){if(!n[g.toLowerCase()])throw new Error(g+" is not supported by this platform")},i.MAX_VALUE_16BITS=65535,i.MAX_VALUE_32BITS=-1,i.pretty=function(g){var _,p,y="";for(p=0;p<(g||"").length;p++)y+="\\x"+((_=g.charCodeAt(p))<16?"0":"")+_.toString(16).toUpperCase();return y},i.delay=function(g,_,p){setImmediate(function(){g.apply(p||null,_||[])})},i.inherits=function(g,_){function p(){}p.prototype=_.prototype,g.prototype=new p},i.extend=function(){var g,_,p={};for(g=0;g<arguments.length;g++)for(_ in arguments[g])Object.prototype.hasOwnProperty.call(arguments[g],_)&&p[_]===void 0&&(p[_]=arguments[g][_]);return p},i.prepareContent=function(g,_,p,y,b){return l.Promise.resolve(_).then(function(C){return n.blob&&(C instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(C))!==-1)&&typeof FileReader<"u"?new l.Promise(function(T,S){var A=new FileReader;A.onload=function(M){T(M.target.result)},A.onerror=function(M){S(M.target.error)},A.readAsArrayBuffer(C)}):C}).then(function(C){var T=i.getTypeOf(C);return T?(T==="arraybuffer"?C=i.transformTo("uint8array",C):T==="string"&&(b?C=r.decode(C):p&&y!==!0&&(C=function(S){return h(S,n.uint8array?new Uint8Array(S.length):new Array(S.length))}(C))),C):l.Promise.reject(new Error("Can't read the data of '"+g+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(e,s,i){var n=e("./reader/readerFor"),r=e("./utils"),o=e("./signature"),l=e("./zipEntry"),c=e("./support");function h(d){this.files=[],this.loadOptions=d}h.prototype={checkSignature:function(d){if(!this.reader.readAndCheckSignature(d)){this.reader.index-=4;var f=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+r.pretty(f)+", expected "+r.pretty(d)+")")}},isSignature:function(d,f){var u=this.reader.index;this.reader.setIndex(d);var m=this.reader.readString(4)===f;return this.reader.setIndex(u),m},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var d=this.reader.readData(this.zipCommentLength),f=c.uint8array?"uint8array":"array",u=r.transformTo(f,d);this.zipComment=this.loadOptions.decodeFileName(u)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var d,f,u,m=this.zip64EndOfCentralSize-44;0<m;)d=this.reader.readInt(2),f=this.reader.readInt(4),u=this.reader.readData(f),this.zip64ExtensibleData[d]={id:d,length:f,value:u}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var d,f;for(d=0;d<this.files.length;d++)f=this.files[d],this.reader.setIndex(f.localHeaderOffset),this.checkSignature(o.LOCAL_FILE_HEADER),f.readLocalPart(this.reader),f.handleUTF8(),f.processAttributes()},readCentralDir:function(){var d;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(o.CENTRAL_FILE_HEADER);)(d=new l({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(d);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var d=this.reader.lastIndexOfSignature(o.CENTRAL_DIRECTORY_END);if(d<0)throw this.isSignature(0,o.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(d);var f=d;if(this.checkSignature(o.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===r.MAX_VALUE_16BITS||this.diskWithCentralDirStart===r.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===r.MAX_VALUE_16BITS||this.centralDirRecords===r.MAX_VALUE_16BITS||this.centralDirSize===r.MAX_VALUE_32BITS||this.centralDirOffset===r.MAX_VALUE_32BITS){if(this.zip64=!0,(d=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(d),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,o.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var u=this.centralDirOffset+this.centralDirSize;this.zip64&&(u+=20,u+=12+this.zip64EndOfCentralSize);var m=f-u;if(0<m)this.isSignature(f,o.CENTRAL_FILE_HEADER)||(this.reader.zero=m);else if(m<0)throw new Error("Corrupted zip: missing "+Math.abs(m)+" bytes.")},prepareReader:function(d){this.reader=n(d)},load:function(d){this.prepareReader(d),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},s.exports=h},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(e,s,i){var n=e("./reader/readerFor"),r=e("./utils"),o=e("./compressedObject"),l=e("./crc32"),c=e("./utf8"),h=e("./compressions"),d=e("./support");function f(u,m){this.options=u,this.loadOptions=m}f.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(u){var m,g;if(u.skip(22),this.fileNameLength=u.readInt(2),g=u.readInt(2),this.fileName=u.readData(this.fileNameLength),u.skip(g),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((m=function(_){for(var p in h)if(Object.prototype.hasOwnProperty.call(h,p)&&h[p].magic===_)return h[p];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+r.pretty(this.compressionMethod)+" unknown (inner file : "+r.transformTo("string",this.fileName)+")");this.decompressed=new o(this.compressedSize,this.uncompressedSize,this.crc32,m,u.readData(this.compressedSize))},readCentralPart:function(u){this.versionMadeBy=u.readInt(2),u.skip(2),this.bitFlag=u.readInt(2),this.compressionMethod=u.readString(2),this.date=u.readDate(),this.crc32=u.readInt(4),this.compressedSize=u.readInt(4),this.uncompressedSize=u.readInt(4);var m=u.readInt(2);if(this.extraFieldsLength=u.readInt(2),this.fileCommentLength=u.readInt(2),this.diskNumberStart=u.readInt(2),this.internalFileAttributes=u.readInt(2),this.externalFileAttributes=u.readInt(4),this.localHeaderOffset=u.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");u.skip(m),this.readExtraFields(u),this.parseZIP64ExtraField(u),this.fileComment=u.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var u=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),u==0&&(this.dosPermissions=63&this.externalFileAttributes),u==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var u=n(this.extraFields[1].value);this.uncompressedSize===r.MAX_VALUE_32BITS&&(this.uncompressedSize=u.readInt(8)),this.compressedSize===r.MAX_VALUE_32BITS&&(this.compressedSize=u.readInt(8)),this.localHeaderOffset===r.MAX_VALUE_32BITS&&(this.localHeaderOffset=u.readInt(8)),this.diskNumberStart===r.MAX_VALUE_32BITS&&(this.diskNumberStart=u.readInt(4))}},readExtraFields:function(u){var m,g,_,p=u.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});u.index+4<p;)m=u.readInt(2),g=u.readInt(2),_=u.readData(g),this.extraFields[m]={id:m,length:g,value:_};u.setIndex(p)},handleUTF8:function(){var u=d.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=c.utf8decode(this.fileName),this.fileCommentStr=c.utf8decode(this.fileComment);else{var m=this.findExtraFieldUnicodePath();if(m!==null)this.fileNameStr=m;else{var g=r.transformTo(u,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(g)}var _=this.findExtraFieldUnicodeComment();if(_!==null)this.fileCommentStr=_;else{var p=r.transformTo(u,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(p)}}},findExtraFieldUnicodePath:function(){var u=this.extraFields[28789];if(u){var m=n(u.value);return m.readInt(1)!==1||l(this.fileName)!==m.readInt(4)?null:c.utf8decode(m.readData(u.length-5))}return null},findExtraFieldUnicodeComment:function(){var u=this.extraFields[25461];if(u){var m=n(u.value);return m.readInt(1)!==1||l(this.fileComment)!==m.readInt(4)?null:c.utf8decode(m.readData(u.length-5))}return null}},s.exports=f},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,s,i){function n(m,g,_){this.name=m,this.dir=_.dir,this.date=_.date,this.comment=_.comment,this.unixPermissions=_.unixPermissions,this.dosPermissions=_.dosPermissions,this._data=g,this._dataBinary=_.binary,this.options={compression:_.compression,compressionOptions:_.compressionOptions}}var r=e("./stream/StreamHelper"),o=e("./stream/DataWorker"),l=e("./utf8"),c=e("./compressedObject"),h=e("./stream/GenericWorker");n.prototype={internalStream:function(m){var g=null,_="string";try{if(!m)throw new Error("No output type specified.");var p=(_=m.toLowerCase())==="string"||_==="text";_!=="binarystring"&&_!=="text"||(_="string"),g=this._decompressWorker();var y=!this._dataBinary;y&&!p&&(g=g.pipe(new l.Utf8EncodeWorker)),!y&&p&&(g=g.pipe(new l.Utf8DecodeWorker))}catch(b){(g=new h("error")).error(b)}return new r(g,_,"")},async:function(m,g){return this.internalStream(m).accumulate(g)},nodeStream:function(m,g){return this.internalStream(m||"nodebuffer").toNodejsStream(g)},_compressWorker:function(m,g){if(this._data instanceof c&&this._data.compression.magic===m.magic)return this._data.getCompressedWorker();var _=this._decompressWorker();return this._dataBinary||(_=_.pipe(new l.Utf8EncodeWorker)),c.createWorkerFrom(_,m,g)},_decompressWorker:function(){return this._data instanceof c?this._data.getContentWorker():this._data instanceof h?this._data:new o(this._data)}};for(var d=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],f=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},u=0;u<d.length;u++)n.prototype[d[u]]=f;s.exports=n},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,s,i){(function(n){var r,o,l=n.MutationObserver||n.WebKitMutationObserver;if(l){var c=0,h=new l(m),d=n.document.createTextNode("");h.observe(d,{characterData:!0}),r=function(){d.data=c=++c%2}}else if(n.setImmediate||n.MessageChannel===void 0)r="document"in n&&"onreadystatechange"in n.document.createElement("script")?function(){var g=n.document.createElement("script");g.onreadystatechange=function(){m(),g.onreadystatechange=null,g.parentNode.removeChild(g),g=null},n.document.documentElement.appendChild(g)}:function(){setTimeout(m,0)};else{var f=new n.MessageChannel;f.port1.onmessage=m,r=function(){f.port2.postMessage(0)}}var u=[];function m(){var g,_;o=!0;for(var p=u.length;p;){for(_=u,u=[],g=-1;++g<p;)_[g]();p=u.length}o=!1}s.exports=function(g){u.push(g)!==1||o||r()}}).call(this,typeof zs<"u"?zs:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(e,s,i){var n=e("immediate");function r(){}var o={},l=["REJECTED"],c=["FULFILLED"],h=["PENDING"];function d(p){if(typeof p!="function")throw new TypeError("resolver must be a function");this.state=h,this.queue=[],this.outcome=void 0,p!==r&&g(this,p)}function f(p,y,b){this.promise=p,typeof y=="function"&&(this.onFulfilled=y,this.callFulfilled=this.otherCallFulfilled),typeof b=="function"&&(this.onRejected=b,this.callRejected=this.otherCallRejected)}function u(p,y,b){n(function(){var C;try{C=y(b)}catch(T){return o.reject(p,T)}C===p?o.reject(p,new TypeError("Cannot resolve promise with itself")):o.resolve(p,C)})}function m(p){var y=p&&p.then;if(p&&(typeof p=="object"||typeof p=="function")&&typeof y=="function")return function(){y.apply(p,arguments)}}function g(p,y){var b=!1;function C(A){b||(b=!0,o.reject(p,A))}function T(A){b||(b=!0,o.resolve(p,A))}var S=_(function(){y(T,C)});S.status==="error"&&C(S.value)}function _(p,y){var b={};try{b.value=p(y),b.status="success"}catch(C){b.status="error",b.value=C}return b}(s.exports=d).prototype.finally=function(p){if(typeof p!="function")return this;var y=this.constructor;return this.then(function(b){return y.resolve(p()).then(function(){return b})},function(b){return y.resolve(p()).then(function(){throw b})})},d.prototype.catch=function(p){return this.then(null,p)},d.prototype.then=function(p,y){if(typeof p!="function"&&this.state===c||typeof y!="function"&&this.state===l)return this;var b=new this.constructor(r);return this.state!==h?u(b,this.state===c?p:y,this.outcome):this.queue.push(new f(b,p,y)),b},f.prototype.callFulfilled=function(p){o.resolve(this.promise,p)},f.prototype.otherCallFulfilled=function(p){u(this.promise,this.onFulfilled,p)},f.prototype.callRejected=function(p){o.reject(this.promise,p)},f.prototype.otherCallRejected=function(p){u(this.promise,this.onRejected,p)},o.resolve=function(p,y){var b=_(m,y);if(b.status==="error")return o.reject(p,b.value);var C=b.value;if(C)g(p,C);else{p.state=c,p.outcome=y;for(var T=-1,S=p.queue.length;++T<S;)p.queue[T].callFulfilled(y)}return p},o.reject=function(p,y){p.state=l,p.outcome=y;for(var b=-1,C=p.queue.length;++b<C;)p.queue[b].callRejected(y);return p},d.resolve=function(p){return p instanceof this?p:o.resolve(new this(r),p)},d.reject=function(p){var y=new this(r);return o.reject(y,p)},d.all=function(p){var y=this;if(Object.prototype.toString.call(p)!=="[object Array]")return this.reject(new TypeError("must be an array"));var b=p.length,C=!1;if(!b)return this.resolve([]);for(var T=new Array(b),S=0,A=-1,M=new this(r);++A<b;)P(p[A],A);return M;function P(N,H){y.resolve(N).then(function(E){T[H]=E,++S!==b||C||(C=!0,o.resolve(M,T))},function(E){C||(C=!0,o.reject(M,E))})}},d.race=function(p){var y=this;if(Object.prototype.toString.call(p)!=="[object Array]")return this.reject(new TypeError("must be an array"));var b=p.length,C=!1;if(!b)return this.resolve([]);for(var T=-1,S=new this(r);++T<b;)A=p[T],y.resolve(A).then(function(M){C||(C=!0,o.resolve(S,M))},function(M){C||(C=!0,o.reject(S,M))});var A;return S}},{immediate:36}],38:[function(e,s,i){var n={};(0,e("./lib/utils/common").assign)(n,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),s.exports=n},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(e,s,i){var n=e("./zlib/deflate"),r=e("./utils/common"),o=e("./utils/strings"),l=e("./zlib/messages"),c=e("./zlib/zstream"),h=Object.prototype.toString,d=0,f=-1,u=0,m=8;function g(p){if(!(this instanceof g))return new g(p);this.options=r.assign({level:f,method:m,chunkSize:16384,windowBits:15,memLevel:8,strategy:u,to:""},p||{});var y=this.options;y.raw&&0<y.windowBits?y.windowBits=-y.windowBits:y.gzip&&0<y.windowBits&&y.windowBits<16&&(y.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new c,this.strm.avail_out=0;var b=n.deflateInit2(this.strm,y.level,y.method,y.windowBits,y.memLevel,y.strategy);if(b!==d)throw new Error(l[b]);if(y.header&&n.deflateSetHeader(this.strm,y.header),y.dictionary){var C;if(C=typeof y.dictionary=="string"?o.string2buf(y.dictionary):h.call(y.dictionary)==="[object ArrayBuffer]"?new Uint8Array(y.dictionary):y.dictionary,(b=n.deflateSetDictionary(this.strm,C))!==d)throw new Error(l[b]);this._dict_set=!0}}function _(p,y){var b=new g(y);if(b.push(p,!0),b.err)throw b.msg||l[b.err];return b.result}g.prototype.push=function(p,y){var b,C,T=this.strm,S=this.options.chunkSize;if(this.ended)return!1;C=y===~~y?y:y===!0?4:0,typeof p=="string"?T.input=o.string2buf(p):h.call(p)==="[object ArrayBuffer]"?T.input=new Uint8Array(p):T.input=p,T.next_in=0,T.avail_in=T.input.length;do{if(T.avail_out===0&&(T.output=new r.Buf8(S),T.next_out=0,T.avail_out=S),(b=n.deflate(T,C))!==1&&b!==d)return this.onEnd(b),!(this.ended=!0);T.avail_out!==0&&(T.avail_in!==0||C!==4&&C!==2)||(this.options.to==="string"?this.onData(o.buf2binstring(r.shrinkBuf(T.output,T.next_out))):this.onData(r.shrinkBuf(T.output,T.next_out)))}while((0<T.avail_in||T.avail_out===0)&&b!==1);return C===4?(b=n.deflateEnd(this.strm),this.onEnd(b),this.ended=!0,b===d):C!==2||(this.onEnd(d),!(T.avail_out=0))},g.prototype.onData=function(p){this.chunks.push(p)},g.prototype.onEnd=function(p){p===d&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=p,this.msg=this.strm.msg},i.Deflate=g,i.deflate=_,i.deflateRaw=function(p,y){return(y=y||{}).raw=!0,_(p,y)},i.gzip=function(p,y){return(y=y||{}).gzip=!0,_(p,y)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(e,s,i){var n=e("./zlib/inflate"),r=e("./utils/common"),o=e("./utils/strings"),l=e("./zlib/constants"),c=e("./zlib/messages"),h=e("./zlib/zstream"),d=e("./zlib/gzheader"),f=Object.prototype.toString;function u(g){if(!(this instanceof u))return new u(g);this.options=r.assign({chunkSize:16384,windowBits:0,to:""},g||{});var _=this.options;_.raw&&0<=_.windowBits&&_.windowBits<16&&(_.windowBits=-_.windowBits,_.windowBits===0&&(_.windowBits=-15)),!(0<=_.windowBits&&_.windowBits<16)||g&&g.windowBits||(_.windowBits+=32),15<_.windowBits&&_.windowBits<48&&!(15&_.windowBits)&&(_.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h,this.strm.avail_out=0;var p=n.inflateInit2(this.strm,_.windowBits);if(p!==l.Z_OK)throw new Error(c[p]);this.header=new d,n.inflateGetHeader(this.strm,this.header)}function m(g,_){var p=new u(_);if(p.push(g,!0),p.err)throw p.msg||c[p.err];return p.result}u.prototype.push=function(g,_){var p,y,b,C,T,S,A=this.strm,M=this.options.chunkSize,P=this.options.dictionary,N=!1;if(this.ended)return!1;y=_===~~_?_:_===!0?l.Z_FINISH:l.Z_NO_FLUSH,typeof g=="string"?A.input=o.binstring2buf(g):f.call(g)==="[object ArrayBuffer]"?A.input=new Uint8Array(g):A.input=g,A.next_in=0,A.avail_in=A.input.length;do{if(A.avail_out===0&&(A.output=new r.Buf8(M),A.next_out=0,A.avail_out=M),(p=n.inflate(A,l.Z_NO_FLUSH))===l.Z_NEED_DICT&&P&&(S=typeof P=="string"?o.string2buf(P):f.call(P)==="[object ArrayBuffer]"?new Uint8Array(P):P,p=n.inflateSetDictionary(this.strm,S)),p===l.Z_BUF_ERROR&&N===!0&&(p=l.Z_OK,N=!1),p!==l.Z_STREAM_END&&p!==l.Z_OK)return this.onEnd(p),!(this.ended=!0);A.next_out&&(A.avail_out!==0&&p!==l.Z_STREAM_END&&(A.avail_in!==0||y!==l.Z_FINISH&&y!==l.Z_SYNC_FLUSH)||(this.options.to==="string"?(b=o.utf8border(A.output,A.next_out),C=A.next_out-b,T=o.buf2string(A.output,b),A.next_out=C,A.avail_out=M-C,C&&r.arraySet(A.output,A.output,b,C,0),this.onData(T)):this.onData(r.shrinkBuf(A.output,A.next_out)))),A.avail_in===0&&A.avail_out===0&&(N=!0)}while((0<A.avail_in||A.avail_out===0)&&p!==l.Z_STREAM_END);return p===l.Z_STREAM_END&&(y=l.Z_FINISH),y===l.Z_FINISH?(p=n.inflateEnd(this.strm),this.onEnd(p),this.ended=!0,p===l.Z_OK):y!==l.Z_SYNC_FLUSH||(this.onEnd(l.Z_OK),!(A.avail_out=0))},u.prototype.onData=function(g){this.chunks.push(g)},u.prototype.onEnd=function(g){g===l.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=g,this.msg=this.strm.msg},i.Inflate=u,i.inflate=m,i.inflateRaw=function(g,_){return(_=_||{}).raw=!0,m(g,_)},i.ungzip=m},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(e,s,i){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";i.assign=function(l){for(var c=Array.prototype.slice.call(arguments,1);c.length;){var h=c.shift();if(h){if(typeof h!="object")throw new TypeError(h+"must be non-object");for(var d in h)h.hasOwnProperty(d)&&(l[d]=h[d])}}return l},i.shrinkBuf=function(l,c){return l.length===c?l:l.subarray?l.subarray(0,c):(l.length=c,l)};var r={arraySet:function(l,c,h,d,f){if(c.subarray&&l.subarray)l.set(c.subarray(h,h+d),f);else for(var u=0;u<d;u++)l[f+u]=c[h+u]},flattenChunks:function(l){var c,h,d,f,u,m;for(c=d=0,h=l.length;c<h;c++)d+=l[c].length;for(m=new Uint8Array(d),c=f=0,h=l.length;c<h;c++)u=l[c],m.set(u,f),f+=u.length;return m}},o={arraySet:function(l,c,h,d,f){for(var u=0;u<d;u++)l[f+u]=c[h+u]},flattenChunks:function(l){return[].concat.apply([],l)}};i.setTyped=function(l){l?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,r)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,o))},i.setTyped(n)},{}],42:[function(e,s,i){var n=e("./common"),r=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch{r=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{o=!1}for(var l=new n.Buf8(256),c=0;c<256;c++)l[c]=252<=c?6:248<=c?5:240<=c?4:224<=c?3:192<=c?2:1;function h(d,f){if(f<65537&&(d.subarray&&o||!d.subarray&&r))return String.fromCharCode.apply(null,n.shrinkBuf(d,f));for(var u="",m=0;m<f;m++)u+=String.fromCharCode(d[m]);return u}l[254]=l[254]=1,i.string2buf=function(d){var f,u,m,g,_,p=d.length,y=0;for(g=0;g<p;g++)(64512&(u=d.charCodeAt(g)))==55296&&g+1<p&&(64512&(m=d.charCodeAt(g+1)))==56320&&(u=65536+(u-55296<<10)+(m-56320),g++),y+=u<128?1:u<2048?2:u<65536?3:4;for(f=new n.Buf8(y),g=_=0;_<y;g++)(64512&(u=d.charCodeAt(g)))==55296&&g+1<p&&(64512&(m=d.charCodeAt(g+1)))==56320&&(u=65536+(u-55296<<10)+(m-56320),g++),u<128?f[_++]=u:(u<2048?f[_++]=192|u>>>6:(u<65536?f[_++]=224|u>>>12:(f[_++]=240|u>>>18,f[_++]=128|u>>>12&63),f[_++]=128|u>>>6&63),f[_++]=128|63&u);return f},i.buf2binstring=function(d){return h(d,d.length)},i.binstring2buf=function(d){for(var f=new n.Buf8(d.length),u=0,m=f.length;u<m;u++)f[u]=d.charCodeAt(u);return f},i.buf2string=function(d,f){var u,m,g,_,p=f||d.length,y=new Array(2*p);for(u=m=0;u<p;)if((g=d[u++])<128)y[m++]=g;else if(4<(_=l[g]))y[m++]=65533,u+=_-1;else{for(g&=_===2?31:_===3?15:7;1<_&&u<p;)g=g<<6|63&d[u++],_--;1<_?y[m++]=65533:g<65536?y[m++]=g:(g-=65536,y[m++]=55296|g>>10&1023,y[m++]=56320|1023&g)}return h(y,m)},i.utf8border=function(d,f){var u;for((f=f||d.length)>d.length&&(f=d.length),u=f-1;0<=u&&(192&d[u])==128;)u--;return u<0||u===0?f:u+l[d[u]]>f?u:f}},{"./common":41}],43:[function(e,s,i){s.exports=function(n,r,o,l){for(var c=65535&n|0,h=n>>>16&65535|0,d=0;o!==0;){for(o-=d=2e3<o?2e3:o;h=h+(c=c+r[l++]|0)|0,--d;);c%=65521,h%=65521}return c|h<<16|0}},{}],44:[function(e,s,i){s.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(e,s,i){var n=function(){for(var r,o=[],l=0;l<256;l++){r=l;for(var c=0;c<8;c++)r=1&r?3988292384^r>>>1:r>>>1;o[l]=r}return o}();s.exports=function(r,o,l,c){var h=n,d=c+l;r^=-1;for(var f=c;f<d;f++)r=r>>>8^h[255&(r^o[f])];return-1^r}},{}],46:[function(e,s,i){var n,r=e("../utils/common"),o=e("./trees"),l=e("./adler32"),c=e("./crc32"),h=e("./messages"),d=0,f=4,u=0,m=-2,g=-1,_=4,p=2,y=8,b=9,C=286,T=30,S=19,A=2*C+1,M=15,P=3,N=258,H=N+P+1,E=42,k=113,w=1,z=2,X=3,$=4;function st(v,Y){return v.msg=h[Y],Y}function Z(v){return(v<<1)-(4<v?9:0)}function J(v){for(var Y=v.length;0<=--Y;)v[Y]=0}function U(v){var Y=v.state,F=Y.pending;F>v.avail_out&&(F=v.avail_out),F!==0&&(r.arraySet(v.output,Y.pending_buf,Y.pending_out,F,v.next_out),v.next_out+=F,Y.pending_out+=F,v.total_out+=F,v.avail_out-=F,Y.pending-=F,Y.pending===0&&(Y.pending_out=0))}function L(v,Y){o._tr_flush_block(v,0<=v.block_start?v.block_start:-1,v.strstart-v.block_start,Y),v.block_start=v.strstart,U(v.strm)}function nt(v,Y){v.pending_buf[v.pending++]=Y}function K(v,Y){v.pending_buf[v.pending++]=Y>>>8&255,v.pending_buf[v.pending++]=255&Y}function q(v,Y){var F,I,O=v.max_chain_length,D=v.strstart,j=v.prev_length,W=v.nice_match,R=v.strstart>v.w_size-H?v.strstart-(v.w_size-H):0,G=v.window,tt=v.w_mask,Q=v.prev,rt=v.strstart+N,_t=G[D+j-1],ut=G[D+j];v.prev_length>=v.good_match&&(O>>=2),W>v.lookahead&&(W=v.lookahead);do if(G[(F=Y)+j]===ut&&G[F+j-1]===_t&&G[F]===G[D]&&G[++F]===G[D+1]){D+=2,F++;do;while(G[++D]===G[++F]&&G[++D]===G[++F]&&G[++D]===G[++F]&&G[++D]===G[++F]&&G[++D]===G[++F]&&G[++D]===G[++F]&&G[++D]===G[++F]&&G[++D]===G[++F]&&D<rt);if(I=N-(rt-D),D=rt-N,j<I){if(v.match_start=Y,W<=(j=I))break;_t=G[D+j-1],ut=G[D+j]}}while((Y=Q[Y&tt])>R&&--O!=0);return j<=v.lookahead?j:v.lookahead}function pt(v){var Y,F,I,O,D,j,W,R,G,tt,Q=v.w_size;do{if(O=v.window_size-v.lookahead-v.strstart,v.strstart>=Q+(Q-H)){for(r.arraySet(v.window,v.window,Q,Q,0),v.match_start-=Q,v.strstart-=Q,v.block_start-=Q,Y=F=v.hash_size;I=v.head[--Y],v.head[Y]=Q<=I?I-Q:0,--F;);for(Y=F=Q;I=v.prev[--Y],v.prev[Y]=Q<=I?I-Q:0,--F;);O+=Q}if(v.strm.avail_in===0)break;if(j=v.strm,W=v.window,R=v.strstart+v.lookahead,G=O,tt=void 0,tt=j.avail_in,G<tt&&(tt=G),F=tt===0?0:(j.avail_in-=tt,r.arraySet(W,j.input,j.next_in,tt,R),j.state.wrap===1?j.adler=l(j.adler,W,tt,R):j.state.wrap===2&&(j.adler=c(j.adler,W,tt,R)),j.next_in+=tt,j.total_in+=tt,tt),v.lookahead+=F,v.lookahead+v.insert>=P)for(D=v.strstart-v.insert,v.ins_h=v.window[D],v.ins_h=(v.ins_h<<v.hash_shift^v.window[D+1])&v.hash_mask;v.insert&&(v.ins_h=(v.ins_h<<v.hash_shift^v.window[D+P-1])&v.hash_mask,v.prev[D&v.w_mask]=v.head[v.ins_h],v.head[v.ins_h]=D,D++,v.insert--,!(v.lookahead+v.insert<P)););}while(v.lookahead<H&&v.strm.avail_in!==0)}function Tt(v,Y){for(var F,I;;){if(v.lookahead<H){if(pt(v),v.lookahead<H&&Y===d)return w;if(v.lookahead===0)break}if(F=0,v.lookahead>=P&&(v.ins_h=(v.ins_h<<v.hash_shift^v.window[v.strstart+P-1])&v.hash_mask,F=v.prev[v.strstart&v.w_mask]=v.head[v.ins_h],v.head[v.ins_h]=v.strstart),F!==0&&v.strstart-F<=v.w_size-H&&(v.match_length=q(v,F)),v.match_length>=P)if(I=o._tr_tally(v,v.strstart-v.match_start,v.match_length-P),v.lookahead-=v.match_length,v.match_length<=v.max_lazy_match&&v.lookahead>=P){for(v.match_length--;v.strstart++,v.ins_h=(v.ins_h<<v.hash_shift^v.window[v.strstart+P-1])&v.hash_mask,F=v.prev[v.strstart&v.w_mask]=v.head[v.ins_h],v.head[v.ins_h]=v.strstart,--v.match_length!=0;);v.strstart++}else v.strstart+=v.match_length,v.match_length=0,v.ins_h=v.window[v.strstart],v.ins_h=(v.ins_h<<v.hash_shift^v.window[v.strstart+1])&v.hash_mask;else I=o._tr_tally(v,0,v.window[v.strstart]),v.lookahead--,v.strstart++;if(I&&(L(v,!1),v.strm.avail_out===0))return w}return v.insert=v.strstart<P-1?v.strstart:P-1,Y===f?(L(v,!0),v.strm.avail_out===0?X:$):v.last_lit&&(L(v,!1),v.strm.avail_out===0)?w:z}function at(v,Y){for(var F,I,O;;){if(v.lookahead<H){if(pt(v),v.lookahead<H&&Y===d)return w;if(v.lookahead===0)break}if(F=0,v.lookahead>=P&&(v.ins_h=(v.ins_h<<v.hash_shift^v.window[v.strstart+P-1])&v.hash_mask,F=v.prev[v.strstart&v.w_mask]=v.head[v.ins_h],v.head[v.ins_h]=v.strstart),v.prev_length=v.match_length,v.prev_match=v.match_start,v.match_length=P-1,F!==0&&v.prev_length<v.max_lazy_match&&v.strstart-F<=v.w_size-H&&(v.match_length=q(v,F),v.match_length<=5&&(v.strategy===1||v.match_length===P&&4096<v.strstart-v.match_start)&&(v.match_length=P-1)),v.prev_length>=P&&v.match_length<=v.prev_length){for(O=v.strstart+v.lookahead-P,I=o._tr_tally(v,v.strstart-1-v.prev_match,v.prev_length-P),v.lookahead-=v.prev_length-1,v.prev_length-=2;++v.strstart<=O&&(v.ins_h=(v.ins_h<<v.hash_shift^v.window[v.strstart+P-1])&v.hash_mask,F=v.prev[v.strstart&v.w_mask]=v.head[v.ins_h],v.head[v.ins_h]=v.strstart),--v.prev_length!=0;);if(v.match_available=0,v.match_length=P-1,v.strstart++,I&&(L(v,!1),v.strm.avail_out===0))return w}else if(v.match_available){if((I=o._tr_tally(v,0,v.window[v.strstart-1]))&&L(v,!1),v.strstart++,v.lookahead--,v.strm.avail_out===0)return w}else v.match_available=1,v.strstart++,v.lookahead--}return v.match_available&&(I=o._tr_tally(v,0,v.window[v.strstart-1]),v.match_available=0),v.insert=v.strstart<P-1?v.strstart:P-1,Y===f?(L(v,!0),v.strm.avail_out===0?X:$):v.last_lit&&(L(v,!1),v.strm.avail_out===0)?w:z}function ht(v,Y,F,I,O){this.good_length=v,this.max_lazy=Y,this.nice_length=F,this.max_chain=I,this.func=O}function vt(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=y,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new r.Buf16(2*A),this.dyn_dtree=new r.Buf16(2*(2*T+1)),this.bl_tree=new r.Buf16(2*(2*S+1)),J(this.dyn_ltree),J(this.dyn_dtree),J(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new r.Buf16(M+1),this.heap=new r.Buf16(2*C+1),J(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new r.Buf16(2*C+1),J(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function gt(v){var Y;return v&&v.state?(v.total_in=v.total_out=0,v.data_type=p,(Y=v.state).pending=0,Y.pending_out=0,Y.wrap<0&&(Y.wrap=-Y.wrap),Y.status=Y.wrap?E:k,v.adler=Y.wrap===2?0:1,Y.last_flush=d,o._tr_init(Y),u):st(v,m)}function Vt(v){var Y=gt(v);return Y===u&&function(F){F.window_size=2*F.w_size,J(F.head),F.max_lazy_match=n[F.level].max_lazy,F.good_match=n[F.level].good_length,F.nice_match=n[F.level].nice_length,F.max_chain_length=n[F.level].max_chain,F.strstart=0,F.block_start=0,F.lookahead=0,F.insert=0,F.match_length=F.prev_length=P-1,F.match_available=0,F.ins_h=0}(v.state),Y}function Lt(v,Y,F,I,O,D){if(!v)return m;var j=1;if(Y===g&&(Y=6),I<0?(j=0,I=-I):15<I&&(j=2,I-=16),O<1||b<O||F!==y||I<8||15<I||Y<0||9<Y||D<0||_<D)return st(v,m);I===8&&(I=9);var W=new vt;return(v.state=W).strm=v,W.wrap=j,W.gzhead=null,W.w_bits=I,W.w_size=1<<W.w_bits,W.w_mask=W.w_size-1,W.hash_bits=O+7,W.hash_size=1<<W.hash_bits,W.hash_mask=W.hash_size-1,W.hash_shift=~~((W.hash_bits+P-1)/P),W.window=new r.Buf8(2*W.w_size),W.head=new r.Buf16(W.hash_size),W.prev=new r.Buf16(W.w_size),W.lit_bufsize=1<<O+6,W.pending_buf_size=4*W.lit_bufsize,W.pending_buf=new r.Buf8(W.pending_buf_size),W.d_buf=1*W.lit_bufsize,W.l_buf=3*W.lit_bufsize,W.level=Y,W.strategy=D,W.method=F,Vt(v)}n=[new ht(0,0,0,0,function(v,Y){var F=65535;for(F>v.pending_buf_size-5&&(F=v.pending_buf_size-5);;){if(v.lookahead<=1){if(pt(v),v.lookahead===0&&Y===d)return w;if(v.lookahead===0)break}v.strstart+=v.lookahead,v.lookahead=0;var I=v.block_start+F;if((v.strstart===0||v.strstart>=I)&&(v.lookahead=v.strstart-I,v.strstart=I,L(v,!1),v.strm.avail_out===0)||v.strstart-v.block_start>=v.w_size-H&&(L(v,!1),v.strm.avail_out===0))return w}return v.insert=0,Y===f?(L(v,!0),v.strm.avail_out===0?X:$):(v.strstart>v.block_start&&(L(v,!1),v.strm.avail_out),w)}),new ht(4,4,8,4,Tt),new ht(4,5,16,8,Tt),new ht(4,6,32,32,Tt),new ht(4,4,16,16,at),new ht(8,16,32,32,at),new ht(8,16,128,128,at),new ht(8,32,128,256,at),new ht(32,128,258,1024,at),new ht(32,258,258,4096,at)],i.deflateInit=function(v,Y){return Lt(v,Y,y,15,8,0)},i.deflateInit2=Lt,i.deflateReset=Vt,i.deflateResetKeep=gt,i.deflateSetHeader=function(v,Y){return v&&v.state?v.state.wrap!==2?m:(v.state.gzhead=Y,u):m},i.deflate=function(v,Y){var F,I,O,D;if(!v||!v.state||5<Y||Y<0)return v?st(v,m):m;if(I=v.state,!v.output||!v.input&&v.avail_in!==0||I.status===666&&Y!==f)return st(v,v.avail_out===0?-5:m);if(I.strm=v,F=I.last_flush,I.last_flush=Y,I.status===E)if(I.wrap===2)v.adler=0,nt(I,31),nt(I,139),nt(I,8),I.gzhead?(nt(I,(I.gzhead.text?1:0)+(I.gzhead.hcrc?2:0)+(I.gzhead.extra?4:0)+(I.gzhead.name?8:0)+(I.gzhead.comment?16:0)),nt(I,255&I.gzhead.time),nt(I,I.gzhead.time>>8&255),nt(I,I.gzhead.time>>16&255),nt(I,I.gzhead.time>>24&255),nt(I,I.level===9?2:2<=I.strategy||I.level<2?4:0),nt(I,255&I.gzhead.os),I.gzhead.extra&&I.gzhead.extra.length&&(nt(I,255&I.gzhead.extra.length),nt(I,I.gzhead.extra.length>>8&255)),I.gzhead.hcrc&&(v.adler=c(v.adler,I.pending_buf,I.pending,0)),I.gzindex=0,I.status=69):(nt(I,0),nt(I,0),nt(I,0),nt(I,0),nt(I,0),nt(I,I.level===9?2:2<=I.strategy||I.level<2?4:0),nt(I,3),I.status=k);else{var j=y+(I.w_bits-8<<4)<<8;j|=(2<=I.strategy||I.level<2?0:I.level<6?1:I.level===6?2:3)<<6,I.strstart!==0&&(j|=32),j+=31-j%31,I.status=k,K(I,j),I.strstart!==0&&(K(I,v.adler>>>16),K(I,65535&v.adler)),v.adler=1}if(I.status===69)if(I.gzhead.extra){for(O=I.pending;I.gzindex<(65535&I.gzhead.extra.length)&&(I.pending!==I.pending_buf_size||(I.gzhead.hcrc&&I.pending>O&&(v.adler=c(v.adler,I.pending_buf,I.pending-O,O)),U(v),O=I.pending,I.pending!==I.pending_buf_size));)nt(I,255&I.gzhead.extra[I.gzindex]),I.gzindex++;I.gzhead.hcrc&&I.pending>O&&(v.adler=c(v.adler,I.pending_buf,I.pending-O,O)),I.gzindex===I.gzhead.extra.length&&(I.gzindex=0,I.status=73)}else I.status=73;if(I.status===73)if(I.gzhead.name){O=I.pending;do{if(I.pending===I.pending_buf_size&&(I.gzhead.hcrc&&I.pending>O&&(v.adler=c(v.adler,I.pending_buf,I.pending-O,O)),U(v),O=I.pending,I.pending===I.pending_buf_size)){D=1;break}D=I.gzindex<I.gzhead.name.length?255&I.gzhead.name.charCodeAt(I.gzindex++):0,nt(I,D)}while(D!==0);I.gzhead.hcrc&&I.pending>O&&(v.adler=c(v.adler,I.pending_buf,I.pending-O,O)),D===0&&(I.gzindex=0,I.status=91)}else I.status=91;if(I.status===91)if(I.gzhead.comment){O=I.pending;do{if(I.pending===I.pending_buf_size&&(I.gzhead.hcrc&&I.pending>O&&(v.adler=c(v.adler,I.pending_buf,I.pending-O,O)),U(v),O=I.pending,I.pending===I.pending_buf_size)){D=1;break}D=I.gzindex<I.gzhead.comment.length?255&I.gzhead.comment.charCodeAt(I.gzindex++):0,nt(I,D)}while(D!==0);I.gzhead.hcrc&&I.pending>O&&(v.adler=c(v.adler,I.pending_buf,I.pending-O,O)),D===0&&(I.status=103)}else I.status=103;if(I.status===103&&(I.gzhead.hcrc?(I.pending+2>I.pending_buf_size&&U(v),I.pending+2<=I.pending_buf_size&&(nt(I,255&v.adler),nt(I,v.adler>>8&255),v.adler=0,I.status=k)):I.status=k),I.pending!==0){if(U(v),v.avail_out===0)return I.last_flush=-1,u}else if(v.avail_in===0&&Z(Y)<=Z(F)&&Y!==f)return st(v,-5);if(I.status===666&&v.avail_in!==0)return st(v,-5);if(v.avail_in!==0||I.lookahead!==0||Y!==d&&I.status!==666){var W=I.strategy===2?function(R,G){for(var tt;;){if(R.lookahead===0&&(pt(R),R.lookahead===0)){if(G===d)return w;break}if(R.match_length=0,tt=o._tr_tally(R,0,R.window[R.strstart]),R.lookahead--,R.strstart++,tt&&(L(R,!1),R.strm.avail_out===0))return w}return R.insert=0,G===f?(L(R,!0),R.strm.avail_out===0?X:$):R.last_lit&&(L(R,!1),R.strm.avail_out===0)?w:z}(I,Y):I.strategy===3?function(R,G){for(var tt,Q,rt,_t,ut=R.window;;){if(R.lookahead<=N){if(pt(R),R.lookahead<=N&&G===d)return w;if(R.lookahead===0)break}if(R.match_length=0,R.lookahead>=P&&0<R.strstart&&(Q=ut[rt=R.strstart-1])===ut[++rt]&&Q===ut[++rt]&&Q===ut[++rt]){_t=R.strstart+N;do;while(Q===ut[++rt]&&Q===ut[++rt]&&Q===ut[++rt]&&Q===ut[++rt]&&Q===ut[++rt]&&Q===ut[++rt]&&Q===ut[++rt]&&Q===ut[++rt]&&rt<_t);R.match_length=N-(_t-rt),R.match_length>R.lookahead&&(R.match_length=R.lookahead)}if(R.match_length>=P?(tt=o._tr_tally(R,1,R.match_length-P),R.lookahead-=R.match_length,R.strstart+=R.match_length,R.match_length=0):(tt=o._tr_tally(R,0,R.window[R.strstart]),R.lookahead--,R.strstart++),tt&&(L(R,!1),R.strm.avail_out===0))return w}return R.insert=0,G===f?(L(R,!0),R.strm.avail_out===0?X:$):R.last_lit&&(L(R,!1),R.strm.avail_out===0)?w:z}(I,Y):n[I.level].func(I,Y);if(W!==X&&W!==$||(I.status=666),W===w||W===X)return v.avail_out===0&&(I.last_flush=-1),u;if(W===z&&(Y===1?o._tr_align(I):Y!==5&&(o._tr_stored_block(I,0,0,!1),Y===3&&(J(I.head),I.lookahead===0&&(I.strstart=0,I.block_start=0,I.insert=0))),U(v),v.avail_out===0))return I.last_flush=-1,u}return Y!==f?u:I.wrap<=0?1:(I.wrap===2?(nt(I,255&v.adler),nt(I,v.adler>>8&255),nt(I,v.adler>>16&255),nt(I,v.adler>>24&255),nt(I,255&v.total_in),nt(I,v.total_in>>8&255),nt(I,v.total_in>>16&255),nt(I,v.total_in>>24&255)):(K(I,v.adler>>>16),K(I,65535&v.adler)),U(v),0<I.wrap&&(I.wrap=-I.wrap),I.pending!==0?u:1)},i.deflateEnd=function(v){var Y;return v&&v.state?(Y=v.state.status)!==E&&Y!==69&&Y!==73&&Y!==91&&Y!==103&&Y!==k&&Y!==666?st(v,m):(v.state=null,Y===k?st(v,-3):u):m},i.deflateSetDictionary=function(v,Y){var F,I,O,D,j,W,R,G,tt=Y.length;if(!v||!v.state||(D=(F=v.state).wrap)===2||D===1&&F.status!==E||F.lookahead)return m;for(D===1&&(v.adler=l(v.adler,Y,tt,0)),F.wrap=0,tt>=F.w_size&&(D===0&&(J(F.head),F.strstart=0,F.block_start=0,F.insert=0),G=new r.Buf8(F.w_size),r.arraySet(G,Y,tt-F.w_size,F.w_size,0),Y=G,tt=F.w_size),j=v.avail_in,W=v.next_in,R=v.input,v.avail_in=tt,v.next_in=0,v.input=Y,pt(F);F.lookahead>=P;){for(I=F.strstart,O=F.lookahead-(P-1);F.ins_h=(F.ins_h<<F.hash_shift^F.window[I+P-1])&F.hash_mask,F.prev[I&F.w_mask]=F.head[F.ins_h],F.head[F.ins_h]=I,I++,--O;);F.strstart=I,F.lookahead=P-1,pt(F)}return F.strstart+=F.lookahead,F.block_start=F.strstart,F.insert=F.lookahead,F.lookahead=0,F.match_length=F.prev_length=P-1,F.match_available=0,v.next_in=W,v.input=R,v.avail_in=j,F.wrap=D,u},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(e,s,i){s.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(e,s,i){s.exports=function(n,r){var o,l,c,h,d,f,u,m,g,_,p,y,b,C,T,S,A,M,P,N,H,E,k,w,z;o=n.state,l=n.next_in,w=n.input,c=l+(n.avail_in-5),h=n.next_out,z=n.output,d=h-(r-n.avail_out),f=h+(n.avail_out-257),u=o.dmax,m=o.wsize,g=o.whave,_=o.wnext,p=o.window,y=o.hold,b=o.bits,C=o.lencode,T=o.distcode,S=(1<<o.lenbits)-1,A=(1<<o.distbits)-1;t:do{b<15&&(y+=w[l++]<<b,b+=8,y+=w[l++]<<b,b+=8),M=C[y&S];e:for(;;){if(y>>>=P=M>>>24,b-=P,(P=M>>>16&255)===0)z[h++]=65535&M;else{if(!(16&P)){if(!(64&P)){M=C[(65535&M)+(y&(1<<P)-1)];continue e}if(32&P){o.mode=12;break t}n.msg="invalid literal/length code",o.mode=30;break t}N=65535&M,(P&=15)&&(b<P&&(y+=w[l++]<<b,b+=8),N+=y&(1<<P)-1,y>>>=P,b-=P),b<15&&(y+=w[l++]<<b,b+=8,y+=w[l++]<<b,b+=8),M=T[y&A];s:for(;;){if(y>>>=P=M>>>24,b-=P,!(16&(P=M>>>16&255))){if(!(64&P)){M=T[(65535&M)+(y&(1<<P)-1)];continue s}n.msg="invalid distance code",o.mode=30;break t}if(H=65535&M,b<(P&=15)&&(y+=w[l++]<<b,(b+=8)<P&&(y+=w[l++]<<b,b+=8)),u<(H+=y&(1<<P)-1)){n.msg="invalid distance too far back",o.mode=30;break t}if(y>>>=P,b-=P,(P=h-d)<H){if(g<(P=H-P)&&o.sane){n.msg="invalid distance too far back",o.mode=30;break t}if(k=p,(E=0)===_){if(E+=m-P,P<N){for(N-=P;z[h++]=p[E++],--P;);E=h-H,k=z}}else if(_<P){if(E+=m+_-P,(P-=_)<N){for(N-=P;z[h++]=p[E++],--P;);if(E=0,_<N){for(N-=P=_;z[h++]=p[E++],--P;);E=h-H,k=z}}}else if(E+=_-P,P<N){for(N-=P;z[h++]=p[E++],--P;);E=h-H,k=z}for(;2<N;)z[h++]=k[E++],z[h++]=k[E++],z[h++]=k[E++],N-=3;N&&(z[h++]=k[E++],1<N&&(z[h++]=k[E++]))}else{for(E=h-H;z[h++]=z[E++],z[h++]=z[E++],z[h++]=z[E++],2<(N-=3););N&&(z[h++]=z[E++],1<N&&(z[h++]=z[E++]))}break}}break}}while(l<c&&h<f);l-=N=b>>3,y&=(1<<(b-=N<<3))-1,n.next_in=l,n.next_out=h,n.avail_in=l<c?c-l+5:5-(l-c),n.avail_out=h<f?f-h+257:257-(h-f),o.hold=y,o.bits=b}},{}],49:[function(e,s,i){var n=e("../utils/common"),r=e("./adler32"),o=e("./crc32"),l=e("./inffast"),c=e("./inftrees"),h=1,d=2,f=0,u=-2,m=1,g=852,_=592;function p(E){return(E>>>24&255)+(E>>>8&65280)+((65280&E)<<8)+((255&E)<<24)}function y(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function b(E){var k;return E&&E.state?(k=E.state,E.total_in=E.total_out=k.total=0,E.msg="",k.wrap&&(E.adler=1&k.wrap),k.mode=m,k.last=0,k.havedict=0,k.dmax=32768,k.head=null,k.hold=0,k.bits=0,k.lencode=k.lendyn=new n.Buf32(g),k.distcode=k.distdyn=new n.Buf32(_),k.sane=1,k.back=-1,f):u}function C(E){var k;return E&&E.state?((k=E.state).wsize=0,k.whave=0,k.wnext=0,b(E)):u}function T(E,k){var w,z;return E&&E.state?(z=E.state,k<0?(w=0,k=-k):(w=1+(k>>4),k<48&&(k&=15)),k&&(k<8||15<k)?u:(z.window!==null&&z.wbits!==k&&(z.window=null),z.wrap=w,z.wbits=k,C(E))):u}function S(E,k){var w,z;return E?(z=new y,(E.state=z).window=null,(w=T(E,k))!==f&&(E.state=null),w):u}var A,M,P=!0;function N(E){if(P){var k;for(A=new n.Buf32(512),M=new n.Buf32(32),k=0;k<144;)E.lens[k++]=8;for(;k<256;)E.lens[k++]=9;for(;k<280;)E.lens[k++]=7;for(;k<288;)E.lens[k++]=8;for(c(h,E.lens,0,288,A,0,E.work,{bits:9}),k=0;k<32;)E.lens[k++]=5;c(d,E.lens,0,32,M,0,E.work,{bits:5}),P=!1}E.lencode=A,E.lenbits=9,E.distcode=M,E.distbits=5}function H(E,k,w,z){var X,$=E.state;return $.window===null&&($.wsize=1<<$.wbits,$.wnext=0,$.whave=0,$.window=new n.Buf8($.wsize)),z>=$.wsize?(n.arraySet($.window,k,w-$.wsize,$.wsize,0),$.wnext=0,$.whave=$.wsize):(z<(X=$.wsize-$.wnext)&&(X=z),n.arraySet($.window,k,w-z,X,$.wnext),(z-=X)?(n.arraySet($.window,k,w-z,z,0),$.wnext=z,$.whave=$.wsize):($.wnext+=X,$.wnext===$.wsize&&($.wnext=0),$.whave<$.wsize&&($.whave+=X))),0}i.inflateReset=C,i.inflateReset2=T,i.inflateResetKeep=b,i.inflateInit=function(E){return S(E,15)},i.inflateInit2=S,i.inflate=function(E,k){var w,z,X,$,st,Z,J,U,L,nt,K,q,pt,Tt,at,ht,vt,gt,Vt,Lt,v,Y,F,I,O=0,D=new n.Buf8(4),j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!E||!E.state||!E.output||!E.input&&E.avail_in!==0)return u;(w=E.state).mode===12&&(w.mode=13),st=E.next_out,X=E.output,J=E.avail_out,$=E.next_in,z=E.input,Z=E.avail_in,U=w.hold,L=w.bits,nt=Z,K=J,Y=f;t:for(;;)switch(w.mode){case m:if(w.wrap===0){w.mode=13;break}for(;L<16;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}if(2&w.wrap&&U===35615){D[w.check=0]=255&U,D[1]=U>>>8&255,w.check=o(w.check,D,2,0),L=U=0,w.mode=2;break}if(w.flags=0,w.head&&(w.head.done=!1),!(1&w.wrap)||(((255&U)<<8)+(U>>8))%31){E.msg="incorrect header check",w.mode=30;break}if((15&U)!=8){E.msg="unknown compression method",w.mode=30;break}if(L-=4,v=8+(15&(U>>>=4)),w.wbits===0)w.wbits=v;else if(v>w.wbits){E.msg="invalid window size",w.mode=30;break}w.dmax=1<<v,E.adler=w.check=1,w.mode=512&U?10:12,L=U=0;break;case 2:for(;L<16;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}if(w.flags=U,(255&w.flags)!=8){E.msg="unknown compression method",w.mode=30;break}if(57344&w.flags){E.msg="unknown header flags set",w.mode=30;break}w.head&&(w.head.text=U>>8&1),512&w.flags&&(D[0]=255&U,D[1]=U>>>8&255,w.check=o(w.check,D,2,0)),L=U=0,w.mode=3;case 3:for(;L<32;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}w.head&&(w.head.time=U),512&w.flags&&(D[0]=255&U,D[1]=U>>>8&255,D[2]=U>>>16&255,D[3]=U>>>24&255,w.check=o(w.check,D,4,0)),L=U=0,w.mode=4;case 4:for(;L<16;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}w.head&&(w.head.xflags=255&U,w.head.os=U>>8),512&w.flags&&(D[0]=255&U,D[1]=U>>>8&255,w.check=o(w.check,D,2,0)),L=U=0,w.mode=5;case 5:if(1024&w.flags){for(;L<16;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}w.length=U,w.head&&(w.head.extra_len=U),512&w.flags&&(D[0]=255&U,D[1]=U>>>8&255,w.check=o(w.check,D,2,0)),L=U=0}else w.head&&(w.head.extra=null);w.mode=6;case 6:if(1024&w.flags&&(Z<(q=w.length)&&(q=Z),q&&(w.head&&(v=w.head.extra_len-w.length,w.head.extra||(w.head.extra=new Array(w.head.extra_len)),n.arraySet(w.head.extra,z,$,q,v)),512&w.flags&&(w.check=o(w.check,z,q,$)),Z-=q,$+=q,w.length-=q),w.length))break t;w.length=0,w.mode=7;case 7:if(2048&w.flags){if(Z===0)break t;for(q=0;v=z[$+q++],w.head&&v&&w.length<65536&&(w.head.name+=String.fromCharCode(v)),v&&q<Z;);if(512&w.flags&&(w.check=o(w.check,z,q,$)),Z-=q,$+=q,v)break t}else w.head&&(w.head.name=null);w.length=0,w.mode=8;case 8:if(4096&w.flags){if(Z===0)break t;for(q=0;v=z[$+q++],w.head&&v&&w.length<65536&&(w.head.comment+=String.fromCharCode(v)),v&&q<Z;);if(512&w.flags&&(w.check=o(w.check,z,q,$)),Z-=q,$+=q,v)break t}else w.head&&(w.head.comment=null);w.mode=9;case 9:if(512&w.flags){for(;L<16;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}if(U!==(65535&w.check)){E.msg="header crc mismatch",w.mode=30;break}L=U=0}w.head&&(w.head.hcrc=w.flags>>9&1,w.head.done=!0),E.adler=w.check=0,w.mode=12;break;case 10:for(;L<32;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}E.adler=w.check=p(U),L=U=0,w.mode=11;case 11:if(w.havedict===0)return E.next_out=st,E.avail_out=J,E.next_in=$,E.avail_in=Z,w.hold=U,w.bits=L,2;E.adler=w.check=1,w.mode=12;case 12:if(k===5||k===6)break t;case 13:if(w.last){U>>>=7&L,L-=7&L,w.mode=27;break}for(;L<3;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}switch(w.last=1&U,L-=1,3&(U>>>=1)){case 0:w.mode=14;break;case 1:if(N(w),w.mode=20,k!==6)break;U>>>=2,L-=2;break t;case 2:w.mode=17;break;case 3:E.msg="invalid block type",w.mode=30}U>>>=2,L-=2;break;case 14:for(U>>>=7&L,L-=7&L;L<32;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}if((65535&U)!=(U>>>16^65535)){E.msg="invalid stored block lengths",w.mode=30;break}if(w.length=65535&U,L=U=0,w.mode=15,k===6)break t;case 15:w.mode=16;case 16:if(q=w.length){if(Z<q&&(q=Z),J<q&&(q=J),q===0)break t;n.arraySet(X,z,$,q,st),Z-=q,$+=q,J-=q,st+=q,w.length-=q;break}w.mode=12;break;case 17:for(;L<14;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}if(w.nlen=257+(31&U),U>>>=5,L-=5,w.ndist=1+(31&U),U>>>=5,L-=5,w.ncode=4+(15&U),U>>>=4,L-=4,286<w.nlen||30<w.ndist){E.msg="too many length or distance symbols",w.mode=30;break}w.have=0,w.mode=18;case 18:for(;w.have<w.ncode;){for(;L<3;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}w.lens[j[w.have++]]=7&U,U>>>=3,L-=3}for(;w.have<19;)w.lens[j[w.have++]]=0;if(w.lencode=w.lendyn,w.lenbits=7,F={bits:w.lenbits},Y=c(0,w.lens,0,19,w.lencode,0,w.work,F),w.lenbits=F.bits,Y){E.msg="invalid code lengths set",w.mode=30;break}w.have=0,w.mode=19;case 19:for(;w.have<w.nlen+w.ndist;){for(;ht=(O=w.lencode[U&(1<<w.lenbits)-1])>>>16&255,vt=65535&O,!((at=O>>>24)<=L);){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}if(vt<16)U>>>=at,L-=at,w.lens[w.have++]=vt;else{if(vt===16){for(I=at+2;L<I;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}if(U>>>=at,L-=at,w.have===0){E.msg="invalid bit length repeat",w.mode=30;break}v=w.lens[w.have-1],q=3+(3&U),U>>>=2,L-=2}else if(vt===17){for(I=at+3;L<I;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}L-=at,v=0,q=3+(7&(U>>>=at)),U>>>=3,L-=3}else{for(I=at+7;L<I;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}L-=at,v=0,q=11+(127&(U>>>=at)),U>>>=7,L-=7}if(w.have+q>w.nlen+w.ndist){E.msg="invalid bit length repeat",w.mode=30;break}for(;q--;)w.lens[w.have++]=v}}if(w.mode===30)break;if(w.lens[256]===0){E.msg="invalid code -- missing end-of-block",w.mode=30;break}if(w.lenbits=9,F={bits:w.lenbits},Y=c(h,w.lens,0,w.nlen,w.lencode,0,w.work,F),w.lenbits=F.bits,Y){E.msg="invalid literal/lengths set",w.mode=30;break}if(w.distbits=6,w.distcode=w.distdyn,F={bits:w.distbits},Y=c(d,w.lens,w.nlen,w.ndist,w.distcode,0,w.work,F),w.distbits=F.bits,Y){E.msg="invalid distances set",w.mode=30;break}if(w.mode=20,k===6)break t;case 20:w.mode=21;case 21:if(6<=Z&&258<=J){E.next_out=st,E.avail_out=J,E.next_in=$,E.avail_in=Z,w.hold=U,w.bits=L,l(E,K),st=E.next_out,X=E.output,J=E.avail_out,$=E.next_in,z=E.input,Z=E.avail_in,U=w.hold,L=w.bits,w.mode===12&&(w.back=-1);break}for(w.back=0;ht=(O=w.lencode[U&(1<<w.lenbits)-1])>>>16&255,vt=65535&O,!((at=O>>>24)<=L);){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}if(ht&&!(240&ht)){for(gt=at,Vt=ht,Lt=vt;ht=(O=w.lencode[Lt+((U&(1<<gt+Vt)-1)>>gt)])>>>16&255,vt=65535&O,!(gt+(at=O>>>24)<=L);){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}U>>>=gt,L-=gt,w.back+=gt}if(U>>>=at,L-=at,w.back+=at,w.length=vt,ht===0){w.mode=26;break}if(32&ht){w.back=-1,w.mode=12;break}if(64&ht){E.msg="invalid literal/length code",w.mode=30;break}w.extra=15&ht,w.mode=22;case 22:if(w.extra){for(I=w.extra;L<I;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}w.length+=U&(1<<w.extra)-1,U>>>=w.extra,L-=w.extra,w.back+=w.extra}w.was=w.length,w.mode=23;case 23:for(;ht=(O=w.distcode[U&(1<<w.distbits)-1])>>>16&255,vt=65535&O,!((at=O>>>24)<=L);){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}if(!(240&ht)){for(gt=at,Vt=ht,Lt=vt;ht=(O=w.distcode[Lt+((U&(1<<gt+Vt)-1)>>gt)])>>>16&255,vt=65535&O,!(gt+(at=O>>>24)<=L);){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}U>>>=gt,L-=gt,w.back+=gt}if(U>>>=at,L-=at,w.back+=at,64&ht){E.msg="invalid distance code",w.mode=30;break}w.offset=vt,w.extra=15&ht,w.mode=24;case 24:if(w.extra){for(I=w.extra;L<I;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}w.offset+=U&(1<<w.extra)-1,U>>>=w.extra,L-=w.extra,w.back+=w.extra}if(w.offset>w.dmax){E.msg="invalid distance too far back",w.mode=30;break}w.mode=25;case 25:if(J===0)break t;if(q=K-J,w.offset>q){if((q=w.offset-q)>w.whave&&w.sane){E.msg="invalid distance too far back",w.mode=30;break}pt=q>w.wnext?(q-=w.wnext,w.wsize-q):w.wnext-q,q>w.length&&(q=w.length),Tt=w.window}else Tt=X,pt=st-w.offset,q=w.length;for(J<q&&(q=J),J-=q,w.length-=q;X[st++]=Tt[pt++],--q;);w.length===0&&(w.mode=21);break;case 26:if(J===0)break t;X[st++]=w.length,J--,w.mode=21;break;case 27:if(w.wrap){for(;L<32;){if(Z===0)break t;Z--,U|=z[$++]<<L,L+=8}if(K-=J,E.total_out+=K,w.total+=K,K&&(E.adler=w.check=w.flags?o(w.check,X,K,st-K):r(w.check,X,K,st-K)),K=J,(w.flags?U:p(U))!==w.check){E.msg="incorrect data check",w.mode=30;break}L=U=0}w.mode=28;case 28:if(w.wrap&&w.flags){for(;L<32;){if(Z===0)break t;Z--,U+=z[$++]<<L,L+=8}if(U!==(4294967295&w.total)){E.msg="incorrect length check",w.mode=30;break}L=U=0}w.mode=29;case 29:Y=1;break t;case 30:Y=-3;break t;case 31:return-4;case 32:default:return u}return E.next_out=st,E.avail_out=J,E.next_in=$,E.avail_in=Z,w.hold=U,w.bits=L,(w.wsize||K!==E.avail_out&&w.mode<30&&(w.mode<27||k!==4))&&H(E,E.output,E.next_out,K-E.avail_out)?(w.mode=31,-4):(nt-=E.avail_in,K-=E.avail_out,E.total_in+=nt,E.total_out+=K,w.total+=K,w.wrap&&K&&(E.adler=w.check=w.flags?o(w.check,X,K,E.next_out-K):r(w.check,X,K,E.next_out-K)),E.data_type=w.bits+(w.last?64:0)+(w.mode===12?128:0)+(w.mode===20||w.mode===15?256:0),(nt==0&&K===0||k===4)&&Y===f&&(Y=-5),Y)},i.inflateEnd=function(E){if(!E||!E.state)return u;var k=E.state;return k.window&&(k.window=null),E.state=null,f},i.inflateGetHeader=function(E,k){var w;return E&&E.state&&2&(w=E.state).wrap?((w.head=k).done=!1,f):u},i.inflateSetDictionary=function(E,k){var w,z=k.length;return E&&E.state?(w=E.state).wrap!==0&&w.mode!==11?u:w.mode===11&&r(1,k,z,0)!==w.check?-3:H(E,k,z,z)?(w.mode=31,-4):(w.havedict=1,f):u},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(e,s,i){var n=e("../utils/common"),r=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],l=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],c=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];s.exports=function(h,d,f,u,m,g,_,p){var y,b,C,T,S,A,M,P,N,H=p.bits,E=0,k=0,w=0,z=0,X=0,$=0,st=0,Z=0,J=0,U=0,L=null,nt=0,K=new n.Buf16(16),q=new n.Buf16(16),pt=null,Tt=0;for(E=0;E<=15;E++)K[E]=0;for(k=0;k<u;k++)K[d[f+k]]++;for(X=H,z=15;1<=z&&K[z]===0;z--);if(z<X&&(X=z),z===0)return m[g++]=20971520,m[g++]=20971520,p.bits=1,0;for(w=1;w<z&&K[w]===0;w++);for(X<w&&(X=w),E=Z=1;E<=15;E++)if(Z<<=1,(Z-=K[E])<0)return-1;if(0<Z&&(h===0||z!==1))return-1;for(q[1]=0,E=1;E<15;E++)q[E+1]=q[E]+K[E];for(k=0;k<u;k++)d[f+k]!==0&&(_[q[d[f+k]]++]=k);if(A=h===0?(L=pt=_,19):h===1?(L=r,nt-=257,pt=o,Tt-=257,256):(L=l,pt=c,-1),E=w,S=g,st=k=U=0,C=-1,T=(J=1<<($=X))-1,h===1&&852<J||h===2&&592<J)return 1;for(;;){for(M=E-st,N=_[k]<A?(P=0,_[k]):_[k]>A?(P=pt[Tt+_[k]],L[nt+_[k]]):(P=96,0),y=1<<E-st,w=b=1<<$;m[S+(U>>st)+(b-=y)]=M<<24|P<<16|N|0,b!==0;);for(y=1<<E-1;U&y;)y>>=1;if(y!==0?(U&=y-1,U+=y):U=0,k++,--K[E]==0){if(E===z)break;E=d[f+_[k]]}if(X<E&&(U&T)!==C){for(st===0&&(st=X),S+=w,Z=1<<($=E-st);$+st<z&&!((Z-=K[$+st])<=0);)$++,Z<<=1;if(J+=1<<$,h===1&&852<J||h===2&&592<J)return 1;m[C=U&T]=X<<24|$<<16|S-g|0}}return U!==0&&(m[S+U]=E-st<<24|64<<16|0),p.bits=X,0}},{"../utils/common":41}],51:[function(e,s,i){s.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(e,s,i){var n=e("../utils/common"),r=0,o=1;function l(O){for(var D=O.length;0<=--D;)O[D]=0}var c=0,h=29,d=256,f=d+1+h,u=30,m=19,g=2*f+1,_=15,p=16,y=7,b=256,C=16,T=17,S=18,A=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],M=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],P=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],N=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],H=new Array(2*(f+2));l(H);var E=new Array(2*u);l(E);var k=new Array(512);l(k);var w=new Array(256);l(w);var z=new Array(h);l(z);var X,$,st,Z=new Array(u);function J(O,D,j,W,R){this.static_tree=O,this.extra_bits=D,this.extra_base=j,this.elems=W,this.max_length=R,this.has_stree=O&&O.length}function U(O,D){this.dyn_tree=O,this.max_code=0,this.stat_desc=D}function L(O){return O<256?k[O]:k[256+(O>>>7)]}function nt(O,D){O.pending_buf[O.pending++]=255&D,O.pending_buf[O.pending++]=D>>>8&255}function K(O,D,j){O.bi_valid>p-j?(O.bi_buf|=D<<O.bi_valid&65535,nt(O,O.bi_buf),O.bi_buf=D>>p-O.bi_valid,O.bi_valid+=j-p):(O.bi_buf|=D<<O.bi_valid&65535,O.bi_valid+=j)}function q(O,D,j){K(O,j[2*D],j[2*D+1])}function pt(O,D){for(var j=0;j|=1&O,O>>>=1,j<<=1,0<--D;);return j>>>1}function Tt(O,D,j){var W,R,G=new Array(_+1),tt=0;for(W=1;W<=_;W++)G[W]=tt=tt+j[W-1]<<1;for(R=0;R<=D;R++){var Q=O[2*R+1];Q!==0&&(O[2*R]=pt(G[Q]++,Q))}}function at(O){var D;for(D=0;D<f;D++)O.dyn_ltree[2*D]=0;for(D=0;D<u;D++)O.dyn_dtree[2*D]=0;for(D=0;D<m;D++)O.bl_tree[2*D]=0;O.dyn_ltree[2*b]=1,O.opt_len=O.static_len=0,O.last_lit=O.matches=0}function ht(O){8<O.bi_valid?nt(O,O.bi_buf):0<O.bi_valid&&(O.pending_buf[O.pending++]=O.bi_buf),O.bi_buf=0,O.bi_valid=0}function vt(O,D,j,W){var R=2*D,G=2*j;return O[R]<O[G]||O[R]===O[G]&&W[D]<=W[j]}function gt(O,D,j){for(var W=O.heap[j],R=j<<1;R<=O.heap_len&&(R<O.heap_len&&vt(D,O.heap[R+1],O.heap[R],O.depth)&&R++,!vt(D,W,O.heap[R],O.depth));)O.heap[j]=O.heap[R],j=R,R<<=1;O.heap[j]=W}function Vt(O,D,j){var W,R,G,tt,Q=0;if(O.last_lit!==0)for(;W=O.pending_buf[O.d_buf+2*Q]<<8|O.pending_buf[O.d_buf+2*Q+1],R=O.pending_buf[O.l_buf+Q],Q++,W===0?q(O,R,D):(q(O,(G=w[R])+d+1,D),(tt=A[G])!==0&&K(O,R-=z[G],tt),q(O,G=L(--W),j),(tt=M[G])!==0&&K(O,W-=Z[G],tt)),Q<O.last_lit;);q(O,b,D)}function Lt(O,D){var j,W,R,G=D.dyn_tree,tt=D.stat_desc.static_tree,Q=D.stat_desc.has_stree,rt=D.stat_desc.elems,_t=-1;for(O.heap_len=0,O.heap_max=g,j=0;j<rt;j++)G[2*j]!==0?(O.heap[++O.heap_len]=_t=j,O.depth[j]=0):G[2*j+1]=0;for(;O.heap_len<2;)G[2*(R=O.heap[++O.heap_len]=_t<2?++_t:0)]=1,O.depth[R]=0,O.opt_len--,Q&&(O.static_len-=tt[2*R+1]);for(D.max_code=_t,j=O.heap_len>>1;1<=j;j--)gt(O,G,j);for(R=rt;j=O.heap[1],O.heap[1]=O.heap[O.heap_len--],gt(O,G,1),W=O.heap[1],O.heap[--O.heap_max]=j,O.heap[--O.heap_max]=W,G[2*R]=G[2*j]+G[2*W],O.depth[R]=(O.depth[j]>=O.depth[W]?O.depth[j]:O.depth[W])+1,G[2*j+1]=G[2*W+1]=R,O.heap[1]=R++,gt(O,G,1),2<=O.heap_len;);O.heap[--O.heap_max]=O.heap[1],function(ut,Qt){var es,he,ss,Et,Is,_i,ge=Qt.dyn_tree,_n=Qt.max_code,bo=Qt.stat_desc.static_tree,xo=Qt.stat_desc.has_stree,Co=Qt.stat_desc.extra_bits,yn=Qt.stat_desc.extra_base,is=Qt.stat_desc.max_length,ks=0;for(Et=0;Et<=_;Et++)ut.bl_count[Et]=0;for(ge[2*ut.heap[ut.heap_max]+1]=0,es=ut.heap_max+1;es<g;es++)is<(Et=ge[2*ge[2*(he=ut.heap[es])+1]+1]+1)&&(Et=is,ks++),ge[2*he+1]=Et,_n<he||(ut.bl_count[Et]++,Is=0,yn<=he&&(Is=Co[he-yn]),_i=ge[2*he],ut.opt_len+=_i*(Et+Is),xo&&(ut.static_len+=_i*(bo[2*he+1]+Is)));if(ks!==0){do{for(Et=is-1;ut.bl_count[Et]===0;)Et--;ut.bl_count[Et]--,ut.bl_count[Et+1]+=2,ut.bl_count[is]--,ks-=2}while(0<ks);for(Et=is;Et!==0;Et--)for(he=ut.bl_count[Et];he!==0;)_n<(ss=ut.heap[--es])||(ge[2*ss+1]!==Et&&(ut.opt_len+=(Et-ge[2*ss+1])*ge[2*ss],ge[2*ss+1]=Et),he--)}}(O,D),Tt(G,_t,O.bl_count)}function v(O,D,j){var W,R,G=-1,tt=D[1],Q=0,rt=7,_t=4;for(tt===0&&(rt=138,_t=3),D[2*(j+1)+1]=65535,W=0;W<=j;W++)R=tt,tt=D[2*(W+1)+1],++Q<rt&&R===tt||(Q<_t?O.bl_tree[2*R]+=Q:R!==0?(R!==G&&O.bl_tree[2*R]++,O.bl_tree[2*C]++):Q<=10?O.bl_tree[2*T]++:O.bl_tree[2*S]++,G=R,_t=(Q=0)===tt?(rt=138,3):R===tt?(rt=6,3):(rt=7,4))}function Y(O,D,j){var W,R,G=-1,tt=D[1],Q=0,rt=7,_t=4;for(tt===0&&(rt=138,_t=3),W=0;W<=j;W++)if(R=tt,tt=D[2*(W+1)+1],!(++Q<rt&&R===tt)){if(Q<_t)for(;q(O,R,O.bl_tree),--Q!=0;);else R!==0?(R!==G&&(q(O,R,O.bl_tree),Q--),q(O,C,O.bl_tree),K(O,Q-3,2)):Q<=10?(q(O,T,O.bl_tree),K(O,Q-3,3)):(q(O,S,O.bl_tree),K(O,Q-11,7));G=R,_t=(Q=0)===tt?(rt=138,3):R===tt?(rt=6,3):(rt=7,4)}}l(Z);var F=!1;function I(O,D,j,W){K(O,(c<<1)+(W?1:0),3),function(R,G,tt,Q){ht(R),nt(R,tt),nt(R,~tt),n.arraySet(R.pending_buf,R.window,G,tt,R.pending),R.pending+=tt}(O,D,j)}i._tr_init=function(O){F||(function(){var D,j,W,R,G,tt=new Array(_+1);for(R=W=0;R<h-1;R++)for(z[R]=W,D=0;D<1<<A[R];D++)w[W++]=R;for(w[W-1]=R,R=G=0;R<16;R++)for(Z[R]=G,D=0;D<1<<M[R];D++)k[G++]=R;for(G>>=7;R<u;R++)for(Z[R]=G<<7,D=0;D<1<<M[R]-7;D++)k[256+G++]=R;for(j=0;j<=_;j++)tt[j]=0;for(D=0;D<=143;)H[2*D+1]=8,D++,tt[8]++;for(;D<=255;)H[2*D+1]=9,D++,tt[9]++;for(;D<=279;)H[2*D+1]=7,D++,tt[7]++;for(;D<=287;)H[2*D+1]=8,D++,tt[8]++;for(Tt(H,f+1,tt),D=0;D<u;D++)E[2*D+1]=5,E[2*D]=pt(D,5);X=new J(H,A,d+1,f,_),$=new J(E,M,0,u,_),st=new J(new Array(0),P,0,m,y)}(),F=!0),O.l_desc=new U(O.dyn_ltree,X),O.d_desc=new U(O.dyn_dtree,$),O.bl_desc=new U(O.bl_tree,st),O.bi_buf=0,O.bi_valid=0,at(O)},i._tr_stored_block=I,i._tr_flush_block=function(O,D,j,W){var R,G,tt=0;0<O.level?(O.strm.data_type===2&&(O.strm.data_type=function(Q){var rt,_t=4093624447;for(rt=0;rt<=31;rt++,_t>>>=1)if(1&_t&&Q.dyn_ltree[2*rt]!==0)return r;if(Q.dyn_ltree[18]!==0||Q.dyn_ltree[20]!==0||Q.dyn_ltree[26]!==0)return o;for(rt=32;rt<d;rt++)if(Q.dyn_ltree[2*rt]!==0)return o;return r}(O)),Lt(O,O.l_desc),Lt(O,O.d_desc),tt=function(Q){var rt;for(v(Q,Q.dyn_ltree,Q.l_desc.max_code),v(Q,Q.dyn_dtree,Q.d_desc.max_code),Lt(Q,Q.bl_desc),rt=m-1;3<=rt&&Q.bl_tree[2*N[rt]+1]===0;rt--);return Q.opt_len+=3*(rt+1)+5+5+4,rt}(O),R=O.opt_len+3+7>>>3,(G=O.static_len+3+7>>>3)<=R&&(R=G)):R=G=j+5,j+4<=R&&D!==-1?I(O,D,j,W):O.strategy===4||G===R?(K(O,2+(W?1:0),3),Vt(O,H,E)):(K(O,4+(W?1:0),3),function(Q,rt,_t,ut){var Qt;for(K(Q,rt-257,5),K(Q,_t-1,5),K(Q,ut-4,4),Qt=0;Qt<ut;Qt++)K(Q,Q.bl_tree[2*N[Qt]+1],3);Y(Q,Q.dyn_ltree,rt-1),Y(Q,Q.dyn_dtree,_t-1)}(O,O.l_desc.max_code+1,O.d_desc.max_code+1,tt+1),Vt(O,O.dyn_ltree,O.dyn_dtree)),at(O),W&&ht(O)},i._tr_tally=function(O,D,j){return O.pending_buf[O.d_buf+2*O.last_lit]=D>>>8&255,O.pending_buf[O.d_buf+2*O.last_lit+1]=255&D,O.pending_buf[O.l_buf+O.last_lit]=255&j,O.last_lit++,D===0?O.dyn_ltree[2*j]++:(O.matches++,D--,O.dyn_ltree[2*(w[j]+d+1)]++,O.dyn_dtree[2*L(D)]++),O.last_lit===O.lit_bufsize-1},i._tr_align=function(O){K(O,2,3),q(O,b,H),function(D){D.bi_valid===16?(nt(D,D.bi_buf),D.bi_buf=0,D.bi_valid=0):8<=D.bi_valid&&(D.pending_buf[D.pending++]=255&D.bi_buf,D.bi_buf>>=8,D.bi_valid-=8)}(O)}},{"../utils/common":41}],53:[function(e,s,i){s.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(e,s,i){(function(n){(function(r,o){if(!r.setImmediate){var l,c,h,d,f=1,u={},m=!1,g=r.document,_=Object.getPrototypeOf&&Object.getPrototypeOf(r);_=_&&_.setTimeout?_:r,l={}.toString.call(r.process)==="[object process]"?function(C){process.nextTick(function(){y(C)})}:function(){if(r.postMessage&&!r.importScripts){var C=!0,T=r.onmessage;return r.onmessage=function(){C=!1},r.postMessage("","*"),r.onmessage=T,C}}()?(d="setImmediate$"+Math.random()+"$",r.addEventListener?r.addEventListener("message",b,!1):r.attachEvent("onmessage",b),function(C){r.postMessage(d+C,"*")}):r.MessageChannel?((h=new MessageChannel).port1.onmessage=function(C){y(C.data)},function(C){h.port2.postMessage(C)}):g&&"onreadystatechange"in g.createElement("script")?(c=g.documentElement,function(C){var T=g.createElement("script");T.onreadystatechange=function(){y(C),T.onreadystatechange=null,c.removeChild(T),T=null},c.appendChild(T)}):function(C){setTimeout(y,0,C)},_.setImmediate=function(C){typeof C!="function"&&(C=new Function(""+C));for(var T=new Array(arguments.length-1),S=0;S<T.length;S++)T[S]=arguments[S+1];var A={callback:C,args:T};return u[f]=A,l(f),f++},_.clearImmediate=p}function p(C){delete u[C]}function y(C){if(m)setTimeout(y,0,C);else{var T=u[C];if(T){m=!0;try{(function(S){var A=S.callback,M=S.args;switch(M.length){case 0:A();break;case 1:A(M[0]);break;case 2:A(M[0],M[1]);break;case 3:A(M[0],M[1],M[2]);break;default:A.apply(o,M)}})(T)}finally{p(C),m=!1}}}}function b(C){C.source===r&&typeof C.data=="string"&&C.data.indexOf(d)===0&&y(+C.data.slice(d.length))}})(typeof self>"u"?n===void 0?this:n:self)}).call(this,typeof zs<"u"?zs:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(fo);var Hc=fo.exports;const er=ea(Hc);class Qi{constructor(t,e){x(this,"date",new Date),x(this,"author"),x(this,"guid",qt.create()),x(this,"viewpoint"),x(this,"modifiedAuthor"),x(this,"modifiedDate"),x(this,"topic"),x(this,"_components"),x(this,"_comment",""),this._components=t,this._comment=e;const s=this._components.get(kt);this.author=s.config.author}set comment(t){var e;const s=this._components.get(kt);this._comment=t,this.modifiedDate=new Date,this.modifiedAuthor=s.config.author,(e=this.topic)==null||e.comments.set(this.guid,this)}get comment(){return this._comment}toJSON(){var t,e;const s={guid:this.guid,date:this.date.toISOString(),author:this.author,comment:this.comment,topic_guid:(t=this.topic)==null?void 0:t.guid,viewpoint_guid:this.viewpoint,modified_date:(e=this.modifiedDate)==null?void 0:e.toISOString(),modified_author:this.modifiedAuthor};for(const[i,n]of Object.entries(s))n===void 0&&delete s[i];return s}}const po=class Ee{constructor(t){x(this,"guid",qt.create()),x(this,"title",Ee.default.title),x(this,"creationDate",new Date),x(this,"creationAuthor",""),x(this,"viewpoints",new we),x(this,"relatedTopics",new we),x(this,"comments",new Nt),x(this,"documentReferences",new we),x(this,"customData",{}),x(this,"description"),x(this,"serverAssignedId"),x(this,"dueDate"),x(this,"modifiedAuthor"),x(this,"modifiedDate"),x(this,"index"),x(this,"_type",Ee.default.type),x(this,"_status",Ee.default.status),x(this,"_priority",Ee.default.priority),x(this,"_stage",Ee.default.stage),x(this,"_assignedTo",Ee.default.assignedTo),x(this,"_labels",Ee.default.labels??new Set),x(this,"_components"),this._components=t;const e=t.get(kt);this.creationAuthor=e.config.author,this.relatedTopics.guard=s=>s!==this.guid}set type(t){const e=this._components.get(kt),{strict:s,types:i}=e.config;(!s||i.has(t))&&(this._type=t)}get type(){return this._type}set status(t){const e=this._components.get(kt),{strict:s,statuses:i}=e.config;(!s||i.has(t))&&(this._status=t)}get status(){return this._status}set priority(t){const e=this._components.get(kt);if(t){const{strict:s,priorities:i}=e.config;if(!(s?i.has(t):!0))return;this._priority=t}else this._priority=t}get priority(){return this._priority}set stage(t){const e=this._components.get(kt);if(t){const{strict:s,stages:i}=e.config;if(!(s?i.has(t):!0))return;this._stage=t}else this._stage=t}get stage(){return this._stage}set assignedTo(t){const e=this._components.get(kt);if(t){const{strict:s,users:i}=e.config;if(!(s?i.has(t):!0))return;this._assignedTo=t}else this._assignedTo=t}get assignedTo(){return this._assignedTo}set labels(t){const e=this._components.get(kt),{strict:s,labels:i}=e.config;if(s){const n=new Set;for(const r of t)(!s||i.has(r))&&n.add(r);this._labels=n}else this._labels=t}get labels(){return this._labels}get _managerVersion(){return this._components.get(kt).config.version}set(t){const e=t,s=this;for(const n in t){if(n==="guid")continue;const r=e[n];n in this&&(s[n]=r)}return this._components.get(kt).list.set(this.guid,this),this}createComment(t,e){const s=new Qi(this._components,t);return s.viewpoint=e,s.topic=this,this.comments.set(s.guid,s),s}createLabelTags(){const t=[...this.labels];if(this._components.get(kt).config.exportCustomDataAsLabels)for(const s in this.customData){const i=this.customData[s];typeof i=="string"&&t.push(i)}return t}createCommentTags(){return[...this.comments.values()].map(t=>{var e;return{$Guid:t.guid,Date:t.date.toISOString(),Author:t.author,Comment:t.comment,ModifiedAuthor:t.modifiedAuthor,ModifiedDate:(e=t.modifiedDate)==null?void 0:e.toISOString(),Viewpoint:t.viewpoint?{$Guid:t.viewpoint}:void 0}})}createViewpointTags(){const t=this._components.get(ye);return[...this.viewpoints].map(s=>t.list.get(s)).filter(s=>s).map(s=>{const i={$Guid:s.guid,Viewpoint:`${s.title??s.guid}.bcfv`};if(t.snapshots.get(s.snapshot)){const r=t.getSnapshotExtension(s.snapshot);i.Snapshot=`${s.snapshot}.${r}`}return i})}createRelatedTopicTags(){return[...this.relatedTopics].map(t=>({$Guid:t}))}createDocumentReferencesTag(t=this._managerVersion){const e=[];if(!(t==="3"||t==="2.1"))return e;const s=this._components.get(kt);for(const i of this.documentReferences){const n=s.documents.get(i);if(!n)continue;let r={$Guid:qt.create(),Description:n.description};t==="2.1"&&(r={...r,$isExternal:n.type==="external"?!0:void 0,ReferencedDocument:n.type==="external"?n.url:`../${n.fileName}`}),t==="3"&&(r={...r,DocumentGuid:n.type==="internal"?i:void 0,Url:n.type==="external"?n.url:void 0}),Object.keys(r).length>0&&e.push(r)}return e}toJSON(){var t,e;const s={guid:this.guid,server_assigned_id:this.serverAssignedId,topic_type:this.type,topic_status:this.status,title:this.title,priority:this.priority,index:this.index,labels:[...this.labels],creation_date:this.creationDate.toISOString(),creation_author:this.creationAuthor,modified_date:(t=this.modifiedDate)==null?void 0:t.toISOString(),modified_author:this.modifiedAuthor,assigned_to:this.assignedTo,stage:this.stage,description:this.description,due_date:(e=this.dueDate)==null?void 0:e.toISOString(),comments:[...this.comments].map(([r,o])=>o.toJSON()),relatedTopics:[...this.relatedTopics].map(r=>({related_topic_guid:r}))},i=this._components.get(ye);for(const r of this.viewpoints){const o=i.list.get(r);o&&(s.viewpoints||(s.viewpoints=[]),s.viewpoints.push(o.toJSON()))}const n=this._components.get(kt);for(const r of this.documentReferences){const o=n.documents.get(r);o&&(s.document_references||(s.document_references=[]),o.type==="external"?s.document_references.push({guid:qt.create(),description:o.description,url:o.url}):s.document_references.push({guid:qt.create(),description:o.description,document_guid:r}))}for(const[r,o]of Object.entries(s))(o===void 0||Array.isArray(o)&&o.length===0)&&delete s[r];return s}serialize(){var t,e;const s=this._managerVersion,i={$Guid:this.guid,$TopicType:this.type,$TopicStatus:this.status,$ServerAssignedId:this.serverAssignedId,Title:this.title,CreationAuthor:this.creationAuthor,CreationDate:this.creationDate.toISOString(),Priority:this.priority,Index:s==="2.1"?this.index:void 0,ModifiedDate:(t=this.modifiedDate)==null?void 0:t.toISOString(),ModifiedAuthor:this.modifiedAuthor,DueDate:(e=this.dueDate)==null?void 0:e.toISOString(),AssignedTo:this.assignedTo,Description:this.description,Stage:this.stage,DocumentReferences:s==="3"?{DocumentReference:this.createDocumentReferencesTag(s)}:void 0,RelatedTopics:s==="3"?{RelatedTopic:this.createRelatedTopicTags()}:void 0,RelatedTopic:s==="2.1"?this.createRelatedTopicTags():void 0,Labels:s==="3"?{Label:this.createLabelTags()}:void 0,Viewpoints:s==="3"?{ViewPoint:this.createViewpointTags()}:void 0,Comments:s==="3"?{Comment:this.createCommentTags()}:void 0};s==="2.1"&&(i.Labels=this.createLabelTags(),i.DocumentReference=this.createDocumentReferencesTag(s));const n={Markup:{Topic:i}};return s==="2.1"&&(n.Markup.Viewpoints=this.createViewpointTags(),n.Markup.Comment=this.createCommentTags()),`<?xml version="1.0" encoding="UTF-8"?>
    ${fi.builder.build(n)}`}};x(po,"default",{title:"BCF Topic",type:"Issue",status:"Active"});let sr=po;const $c=(a,t)=>{if(t.trim()==="")return;const e=kt.xmlParser.parse(t).Extensions;if(!e)return;const{Priorities:s,TopicStatuses:i,TopicTypes:n,Users:r}=e;if(s&&s.Priority){const o=Array.isArray(s.Priority)?s.Priority:[s.Priority];for(const l of o)a.config.priorities.add(l)}if(i&&i.TopicStatus){const o=Array.isArray(i.TopicStatus)?i.TopicStatus:[i.TopicStatus];for(const l of o)a.config.statuses.add(l)}if(n&&n.TopicType){const o=Array.isArray(n.TopicType)?n.TopicType:[n.TopicType];for(const l of o)a.config.types.add(l)}if(r&&r.User){const o=Array.isArray(r.User)?r.User:[r.User];for(const l of o)a.config.users.add(l)}};class Zc extends Ps{constructor(){super(...arguments),x(this,"_config",{version:{type:"Select",options:new Set(["2.1","3"]),multiple:!1,value:""},author:{type:"Text",value:""},types:{type:"TextSet",value:new Set},statuses:{type:"TextSet",value:new Set},priorities:{type:"TextSet",value:new Set},labels:{type:"TextSet",value:new Set},stages:{type:"TextSet",value:new Set},users:{type:"TextSet",value:new Set},includeSelectionTag:{type:"Boolean",value:!1},updateExtensionsOnImport:{type:"Boolean",value:!1},strict:{type:"Boolean",value:!1},includeAllExtensionsOnExport:{type:"Boolean",value:!1},fallbackVersionOnImport:{type:"Select",multiple:!1,options:new Set(["2.1","3"]),value:""},ignoreIncompleteTopicsOnImport:{type:"Boolean",value:!1},exportCustomDataAsLabels:{type:"Boolean",value:!1}})}get version(){return this._config.version.value}set version(t){this._config.version.value=t}get author(){return this._config.author.value}set author(t){this._config.author.value=t}get types(){return this._config.types.value}set types(t){this._config.types.value=t}get statuses(){return this._config.statuses.value}set statuses(t){this._config.statuses.value=t}get priorities(){return this._config.priorities.value}set priorities(t){this._config.priorities.value=t}get labels(){return this._config.labels.value}set labels(t){this._config.labels.value=t}get stages(){return this._config.stages.value}set stages(t){this._config.stages.value=t}get users(){return this._config.users.value}set users(t){this._config.users.value=t}get includeSelectionTag(){return this._config.includeSelectionTag.value}set includeSelectionTag(t){this._config.includeSelectionTag.value=t}get updateExtensionsOnImport(){return this._config.updateExtensionsOnImport.value}set updateExtensionsOnImport(t){this._config.updateExtensionsOnImport.value=t}get strict(){return this._config.strict.value}set strict(t){this._config.strict.value=t}get includeAllExtensionsOnExport(){return this._config.includeAllExtensionsOnExport.value}set includeAllExtensionsOnExport(t){this._config.includeAllExtensionsOnExport.value=t}get fallbackVersionOnImport(){return this._config.fallbackVersionOnImport.value}set fallbackVersionOnImport(t){this._config.fallbackVersionOnImport.value=t}get ignoreIncompleteTopicsOnImport(){return this._config.ignoreIncompleteTopicsOnImport.value}set ignoreIncompleteTopicsOnImport(t){this._config.ignoreIncompleteTopicsOnImport.value=t}get exportCustomDataAsLabels(){return this._config.exportCustomDataAsLabels.value}set exportCustomDataAsLabels(t){this._config.exportCustomDataAsLabels.value=t}}const fn=class bs extends Dt{constructor(){super(...arguments),x(this,"enabled",!1),x(this,"_defaultConfig",{author:"jhon.doe@example.com",version:"2.1",types:new Set(["Clash","Failure","Fault","Inquiry","Issue","Remark","Request"]),statuses:new Set(["Active","In Progress","Done","In Review","Closed"]),priorities:new Set(["On hold","Minor","Normal","Major","Critical"]),labels:new Set,stages:new Set,users:new Set,includeSelectionTag:!1,updateExtensionsOnImport:!0,strict:!1,includeAllExtensionsOnExport:!0,fallbackVersionOnImport:"2.1",ignoreIncompleteTopicsOnImport:!1,exportCustomDataAsLabels:!1}),x(this,"config",new Zc(this,this.components,"BCF Topics",bs.uuid)),x(this,"list",new Nt),x(this,"documents",new Nt),x(this,"onSetup",new it),x(this,"isSetup",!1),x(this,"onBCFImported",new it),x(this,"onDisposed",new it)}setup(t){if(this.isSetup)return;const e={...this._defaultConfig,...t};this.config.version=e.version,this.config.author=e.author,this.config.types=e.types,this.config.statuses=e.statuses,this.config.priorities=e.priorities,this.config.labels=e.labels,this.config.stages=e.stages,this.config.users=e.users,this.config.includeSelectionTag=e.includeSelectionTag,this.config.updateExtensionsOnImport=e.updateExtensionsOnImport,this.config.strict=e.strict,this.config.includeAllExtensionsOnExport=e.includeAllExtensionsOnExport,this.config.fallbackVersionOnImport=e.fallbackVersionOnImport||"",this.config.ignoreIncompleteTopicsOnImport=e.ignoreIncompleteTopicsOnImport,this.isSetup=!0,this.enabled=!0,this.onSetup.trigger()}create(t){const e=new sr(this.components);return t?(e.guid=t.guid??e.guid,e.set(t)):this.list.set(e.guid,e),e}dispose(){this.list.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}get usedTypes(){const t=[...this.list].map(([e,s])=>s.type);return new Set(t)}get usedStatuses(){const t=[...this.list].map(([e,s])=>s.status);return new Set(t)}get usedPriorities(){const t=[...this.list].map(([e,s])=>s.priority).filter(e=>e);return new Set(t)}get usedStages(){const t=[...this.list].map(([e,s])=>s.stage).filter(e=>e);return new Set(t)}get usedUsers(){const t=[];for(const[e,s]of this.list){t.push(s.creationAuthor),s.assignedTo&&t.push(s.assignedTo),s.modifiedAuthor&&t.push(s.modifiedAuthor);for(const[i,n]of s.comments)t.push(n.author),n.modifiedAuthor&&t.push(n.modifiedAuthor)}return new Set(t)}get usedLabels(){const t=[];for(const[e,s]of this.list)t.push(...s.labels);return new Set(t)}updateExtensions(){for(const[t,e]of this.list){for(const s of e.labels)this.config.labels.add(s);this.config.types.add(e.type),e.priority&&this.config.priorities.add(e.priority),e.stage&&this.config.stages.add(e.stage),this.config.statuses.add(e.status),this.config.users.add(e.creationAuthor),e.assignedTo&&this.config.users.add(e.assignedTo),e.modifiedAuthor&&this.config.users.add(e.modifiedAuthor);for(const[s,i]of e.comments)this.config.users.add(i.author),i.modifiedAuthor&&this.config.users.add(i.modifiedAuthor)}}updateViewpointReferences(){const t=this.components.get(ye);for(const[e,s]of this.list)for(const i of s.viewpoints)t.list.has(i)||s.viewpoints.delete(i)}async export(t=this.list.values()){const e=new er;e.file("bcf.version",`<?xml version="1.0" encoding="UTF-8"?>
    <Version VersionId="${this.config.version}" xsi:noNamespaceSchemaLocation="https://raw.githubusercontent.com/buildingSMART/BCF-XML/release_3_0/Schemas/version.xsd"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    </Version>`);for(const[n,r]of this.documents.entries())r.type!=="external"&&e.file(this.config.version==="2.1"?r.fileName:`documents/${n}`,r.data);if(this.config.version==="3"){const n=[];for(const[r,o]of this.documents.entries()){const{type:l,description:c}=o;l!=="external"&&n.push(`<Document Guid="${r}">
        <Filename>${o.fileName}</Filename>
        ${c?`<Description>${c}</Description>`:""}
      </Document>`)}n.length>0&&e.file("documents.xml",`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <DocumentInfo xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="documents.xsd">
    <Documents>
      ${n.join(`
`)}
    </Documents>
  </DocumentInfo>`)}e.file("bcf.extensions",this.serializeExtensions());const s=this.components.get(ye);for(const n of t){const r=e.folder(n.guid);r.file("markup.bcf",n.serialize());for(const o of n.viewpoints){const l=s.list.get(o);if(!l)continue;const c=l.title??l.guid;r.file(`${c}.bcfv`,await l.serialize());const h=s.snapshots.get(l.snapshot);if(!h)continue;const d=h?l.snapshot:l.guid,f=s.getSnapshotExtension(l.snapshot);r.file(`${d}.${f}`,h,{binary:!0})}}return await e.generateAsync({type:"blob"})}serializeExtensions(){const t=[...this.config.types].map(o=>`<TopicType>${o}</TopicType>`).join(`
`),e=[...this.config.statuses].map(o=>`<TopicStatus>${o}</TopicStatus>`).join(`
`),s=[...this.config.priorities].map(o=>`<Priority>${o}</Priority>`).join(`
`),i=[...this.config.labels].map(o=>`<TopicLabel>${o}</TopicLabel>`).join(`
`),n=[...this.config.stages].map(o=>`<Stage>${o}</Stage>`).join(`
`),r=[...this.config.users].map(o=>`<User>${o}</User>`).join(`
`);return`
      <?xml version="1.0" encoding="UTF-8"?>
      <Extensions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="your-schema-location.xsd">
        ${t.length!==0?`<TopicTypes>
${t}
</TopicTypes>`:""}
        ${e.length!==0?`<TopicStatuses>
${e}
</TopicStatuses>`:""}
        ${s.length!==0?`<Priorities>
${s}
</Priorities>`:""}
        ${i.length!==0?`<TopicLabels>
${i}
</TopicLabels>`:""}
        ${n.length!==0?`<Stages>
${n}
</Stages>`:""}
        ${r.length!==0?`<Users>
${r}
</Users>`:""}
      </Extensions>
    `}processMarkupComment(t){const{Guid:e,Date:s,Author:i,Comment:n,Viewpoint:r}=t;if(!(e&&s&&i&&(Qi||r)))return null;const o=new Qi(this.components,n??"");return o.guid=e,o.date=new Date(s),o.author=i,o.viewpoint=r==null?void 0:r.Guid,o.modifiedAuthor=t.ModifiedAuthor,o.modifiedDate=t.ModifiedDate?new Date(t.ModifiedDate):void 0,o}getMarkupComments(t,e){var s;let i;if(e==="2.1"&&(i=t.Comment),e==="3"&&(i=(s=t.Topic.Comments)==null?void 0:s.Comment),!i)return[];i=Array.isArray(i)?i:[i];const n=i.map(o=>this.processMarkupComment(o)).filter(o=>o);return Array.isArray(n)?n:[n]}getMarkupLabels(t,e){var s;let i;return e==="2.1"&&(i=t.Topic.Labels),e==="3"&&(i=(s=t.Topic.Labels)==null?void 0:s.Label),i?Array.isArray(i)?i:[i]:[]}getMarkupViewpoints(t,e){var s;let i;return e==="2.1"&&(i=t.Viewpoints),e==="3"&&(i=(s=t.Topic.Viewpoints)==null?void 0:s.ViewPoint),i?(i=Array.isArray(i)?i:[i],i):[]}getMarkupRelatedTopics(t,e){var s;let i;return e==="2.1"&&(i=t.Topic.RelatedTopic),e==="3"&&(i=(s=t.Topic.RelatedTopics)==null?void 0:s.RelatedTopic),i?(Array.isArray(i)?i:[i]).map(r=>r.Guid):[]}getMarkupDocumentReferences(t,e){var s;let i;return e==="2.1"&&(i=t.Topic.DocumentReference),e==="3"&&(i=(s=t.Topic.DocumentReferences)==null?void 0:s.DocumentReference),i?Array.isArray(i)?i:[i]:[]}async load(t){var e,s,i;const{fallbackVersionOnImport:n,ignoreIncompleteTopicsOnImport:r,updateExtensionsOnImport:o}=this.config,l=new er;await l.loadAsync(t);const c=Object.values(l.files);let h=n;const d=c.find(b=>b.name.endsWith(".version"));if(d){const b=await d.async("string"),C=bs.xmlParser.parse(b).Version.VersionId;h=String(C)}if(!(h&&(h==="2.1"||h==="3")))throw new Error(`BCFTopics: ${h} is not supported.`);const f=c.find(b=>b.name.endsWith(".extensions"));if(o&&f){const b=await f.async("string");$c(this,b)}const u=[],m=this.components.get(ye),g=c.filter(b=>b.name.endsWith(".bcfv"));for(const b of g){const C=await b.async("string"),T=bs.xmlParser.parse(C).VisualizationInfo;if(!T){console.warn("Missing VisualizationInfo in Viewpoint");continue}const S={},{Guid:A,ClippingPlanes:M,Components:P,OrthogonalCamera:N,PerspectiveCamera:H}=T;if(A&&(S.guid=A),P){const k={selection:[],coloring:[],visibility:{default_visibility:!1,exceptions:[],view_setup_hints:{spaces_visible:!1,space_boundaries_visible:!1,openings_visible:!1}}};S.components=k;const{Selection:w,Visibility:z}=P;if(w&&w.Component){const st=Array.isArray(w.Component)?w.Component:[w.Component];k.selection=st.map(Z=>Z.IfcGuid?{ifc_guid:Z.IfcGuid}:null).filter(Z=>Z!==null)}if(z&&"DefaultVisibility"in z&&(k.visibility.default_visibility=z.DefaultVisibility),z&&z.Exceptions&&"Component"in z.Exceptions){const{Component:st}=z.Exceptions,Z=Array.isArray(st)?st:[st];k.visibility.exceptions=Z.map(J=>J.IfcGuid?{ifc_guid:J.IfcGuid}:null).filter(J=>J!==null)}let X;h==="2.1"&&(X=P.ViewSetupHints),h==="3"&&(X=(e=P.Visibility)==null?void 0:e.ViewSetupHints),X&&("OpeningsVisible"in X&&(k.visibility.view_setup_hints.openings_visible=X.OpeningsVisible),"SpacesVisible"in X&&(k.visibility.view_setup_hints.spaces_visible=X.SpacesVisible),"SpaceBoundariesVisible"in X&&(k.visibility.view_setup_hints.space_boundaries_visible=X.SpaceBoundariesVisible));const{Coloring:$}=P;if($&&$.Color){const st=Array.isArray($.Color)?$.Color:[$.Color];for(const Z of st){const{Color:J,Component:U}=Z;if(!(J.length===6||J.length===8))continue;const L=J.length===6?J:J.slice(2),K=(Array.isArray(U)?U:[U]).map(q=>q.IfcGuid?{ifc_guid:q.IfcGuid}:null).filter(q=>q!==null);k.coloring.push({color:L,components:K})}}}if(N||H){const k=T.PerspectiveCamera??T.OrthogonalCamera,{CameraViewPoint:w,CameraDirection:z}=k,X=new V(Number(w.X),Number(w.Z),Number(-w.Y)),$=new V(Number(z.X),Number(z.Z),Number(-z.Y)),st={camera_view_point:{x:X.x,y:X.y,z:X.z},camera_direction:{x:$.x,y:$.y,z:$.z},aspect_ratio:"AspectRatio"in k?k.AspectRatio:1,camera_up_vector:{x:0,y:0,z:0}};"ViewToWorldScale"in k&&(S.orthogonal_camera={...st,view_to_world_scale:k.ViewToWorldScale}),"FieldOfView"in k&&(S.perspective_camera={...st,field_of_view:k.FieldOfView})}if(M){const w=(Array.isArray(M.ClippingPlane)?M.ClippingPlane:[M.ClippingPlane]).map(({Location:z,Direction:X})=>({location:{x:z.x,y:z.y,z:z.z},direction:{x:X.x,y:X.y,z:X.z}}));S.clipping_planes=w}const E=new go(this.components,S);u.push(E)}const _={},p=[],y=c.filter(b=>b.name.endsWith(".bcf"));for(const b of y){const C=await b.async("string"),T=bs.xmlParser.parse(C).Markup,S=T.Topic,{Guid:A,TopicType:M,TopicStatus:P,Title:N,CreationDate:H,CreationAuthor:E}=S;if(r&&!(A&&M&&P&&N&&H&&E))continue;const k=new sr(this.components);k.guid=A??k.guid;const w=this.getMarkupRelatedTopics(T,h);_[k.guid]=new Set(w),k.type=M??k.type,k.status=P??k.status,k.title=N??k.title,k.creationDate=H?new Date(H):k.creationDate,k.creationAuthor=E??k.creationAuthor,k.serverAssignedId=S.ServerAssignedId,k.priority=S.Priority,k.index=S.Index,k.modifiedDate=S.ModifiedDate?new Date(S.ModifiedDate):void 0,k.modifiedAuthor=S.ModifiedAuthor,k.dueDate=S.DueDate?new Date(S.DueDate):void 0,k.assignedTo=S.AssignedTo,k.description=S.Description,k.stage=S.Stage;const z=this.getMarkupLabels(T,h);for(const L of z)k.labels.add(L);const X=this.getMarkupComments(T,h);for(const L of X)k.comments.set(L.guid,L);const $=this.getMarkupViewpoints(T,h);for(const L of $){if(!(L&&L.Guid))continue;const nt=m.list.get(L.Guid);if(!nt)continue;k.viewpoints.add(nt.guid);const K=`${k.guid}/${L.Snapshot}`,q=c.find(({name:pt})=>pt===K);if(q){const pt=await q.async("arraybuffer"),Tt=new Uint8Array(pt);m.snapshots.set(nt.guid,Tt),nt.snapshot=nt.guid??null}}const st=this.getMarkupDocumentReferences(T,h),Z=c.find(L=>L.name==="documents.xml");let J=[];const U=await(Z==null?void 0:Z.async("string"));if(U){const L=(i=(s=fi.parser.parse(U).DocumentInfo)==null?void 0:s.Documents)==null?void 0:i.Document;J=Array.isArray(L)?L:[L]}for(const L of st){const{Description:nt,DocumentGuid:K,Url:q,isExternal:pt,ReferencedDocument:Tt}=L;if(K&&J.length>0){const at=J.find(({Guid:Lt})=>Lt===K),ht=c.find(Lt=>Lt.name.endsWith(K)),vt=await(ht==null?void 0:ht.async("uint8array"));if(!(at&&vt))continue;const{Description:gt,Filename:Vt}=at;this.documents.set(K,{type:"internal",fileName:Vt,description:gt,data:vt}),k.documentReferences.add(K)}if(q){const at=this.documents.add({type:"external",url:q,description:nt});k.documentReferences.add(at)}if(Tt){let at=null;if(pt)at=this.documents.add({type:"external",url:Tt,description:nt});else{const ht=Tt.split("/"),vt=ht[ht.length-1],gt=c.find(Lt=>Lt.name.endsWith(vt)),Vt=await(gt==null?void 0:gt.async("uint8array"));if(!Vt)continue;at=this.documents.add({type:"internal",fileName:vt,data:Vt,description:nt})}k.documentReferences.add(at)}}this.list.set(k.guid,k),p.push(k)}for(const b in _){const C=this.list.get(b);if(!C)continue;const T=_[b];for(const S of T)C.relatedTopics.add(S)}return this.onBCFImported.trigger(p),{viewpoints:u,topics:p}}};x(fn,"uuid","de977976-e4f6-4e4f-a01a-204727839802");x(fn,"xmlParser",new di.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));let kt=fn;const Me=new en,Bt=new V,Ce=new V,bt=new ae,ir={X:new V(1,0,0),Y:new V(0,1,0),Z:new V(0,0,1)},Ri={type:"change"},nr={type:"mouseDown",mode:null},rr={type:"mouseUp",mode:null},or={type:"objectChange"};class Yc extends Lo{constructor(t,e=null){super(void 0,e);const s=new Qc(this);this._root=s;const i=new Kc;this._gizmo=i,s.add(i);const n=new Jc;this._plane=n,s.add(n);const r=this;function o(b,C){let T=C;Object.defineProperty(r,b,{get:function(){return T!==void 0?T:C},set:function(S){T!==S&&(T=S,n[b]=S,i[b]=S,r.dispatchEvent({type:b+"-changed",value:S}),r.dispatchEvent(Ri))}}),r[b]=C,n[b]=C,i[b]=C}o("camera",t),o("object",void 0),o("enabled",!0),o("axis",null),o("mode","translate"),o("translationSnap",null),o("rotationSnap",null),o("scaleSnap",null),o("space","world"),o("size",1),o("dragging",!1),o("showX",!0),o("showY",!0),o("showZ",!0),o("minX",-1/0),o("maxX",1/0),o("minY",-1/0),o("maxY",1/0),o("minZ",-1/0),o("maxZ",1/0);const l=new V,c=new V,h=new ae,d=new ae,f=new V,u=new ae,m=new V,g=new V,_=new V,p=0,y=new V;o("worldPosition",l),o("worldPositionStart",c),o("worldQuaternion",h),o("worldQuaternionStart",d),o("cameraPosition",f),o("cameraQuaternion",u),o("pointStart",m),o("pointEnd",g),o("rotationAxis",_),o("rotationAngle",p),o("eye",y),this._offset=new V,this._startNorm=new V,this._endNorm=new V,this._cameraScale=new V,this._parentPosition=new V,this._parentQuaternion=new ae,this._parentQuaternionInv=new ae,this._parentScale=new V,this._worldScaleStart=new V,this._worldQuaternionInv=new ae,this._worldScale=new V,this._positionStart=new V,this._quaternionStart=new ae,this._scaleStart=new V,this._getPointer=jc.bind(this),this._onPointerDown=Xc.bind(this),this._onPointerHover=Wc.bind(this),this._onPointerMove=qc.bind(this),this._onPointerUp=Gc.bind(this),e!==null&&this.connect(e)}connect(t){super.connect(t),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(t){if(this.object===void 0||this.dragging===!0)return;t!==null&&Me.setFromCamera(t,this.camera);const e=Bi(this._gizmo.picker[this.mode],Me);e?this.axis=e.object.name:this.axis=null}pointerDown(t){if(!(this.object===void 0||this.dragging===!0||t!=null&&t.button!==0)&&this.axis!==null){t!==null&&Me.setFromCamera(t,this.camera);const e=Bi(this._plane,Me,!0);e&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(e.point).sub(this.worldPositionStart)),this.dragging=!0,nr.mode=this.mode,this.dispatchEvent(nr)}}pointerMove(t){const e=this.axis,s=this.mode,i=this.object;let n=this.space;if(s==="scale"?n="local":(e==="E"||e==="XYZE"||e==="XYZ")&&(n="world"),i===void 0||e===null||this.dragging===!1||t!==null&&t.button!==-1)return;t!==null&&Me.setFromCamera(t,this.camera);const r=Bi(this._plane,Me,!0);if(r){if(this.pointEnd.copy(r.point).sub(this.worldPositionStart),s==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),n==="local"&&e!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),e.indexOf("X")===-1&&(this._offset.x=0),e.indexOf("Y")===-1&&(this._offset.y=0),e.indexOf("Z")===-1&&(this._offset.z=0),n==="local"&&e!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),i.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(n==="local"&&(i.position.applyQuaternion(bt.copy(this._quaternionStart).invert()),e.search("X")!==-1&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),e.search("Y")!==-1&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),e.search("Z")!==-1&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.position.applyQuaternion(this._quaternionStart)),n==="world"&&(i.parent&&i.position.add(Bt.setFromMatrixPosition(i.parent.matrixWorld)),e.search("X")!==-1&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),e.search("Y")!==-1&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),e.search("Z")!==-1&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.parent&&i.position.sub(Bt.setFromMatrixPosition(i.parent.matrixWorld)))),i.position.x=Math.max(this.minX,Math.min(this.maxX,i.position.x)),i.position.y=Math.max(this.minY,Math.min(this.maxY,i.position.y)),i.position.z=Math.max(this.minZ,Math.min(this.maxZ,i.position.z));else if(s==="scale"){if(e.search("XYZ")!==-1){let o=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(o*=-1),Ce.set(o,o,o)}else Bt.copy(this.pointStart),Ce.copy(this.pointEnd),Bt.applyQuaternion(this._worldQuaternionInv),Ce.applyQuaternion(this._worldQuaternionInv),Ce.divide(Bt),e.search("X")===-1&&(Ce.x=1),e.search("Y")===-1&&(Ce.y=1),e.search("Z")===-1&&(Ce.z=1);i.scale.copy(this._scaleStart).multiply(Ce),this.scaleSnap&&(e.search("X")!==-1&&(i.scale.x=Math.round(i.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),e.search("Y")!==-1&&(i.scale.y=Math.round(i.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),e.search("Z")!==-1&&(i.scale.z=Math.round(i.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(s==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const o=20/this.worldPosition.distanceTo(Bt.setFromMatrixPosition(this.camera.matrixWorld));let l=!1;e==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(Bt.copy(this.rotationAxis).cross(this.eye))*o):(e==="X"||e==="Y"||e==="Z")&&(this.rotationAxis.copy(ir[e]),Bt.copy(ir[e]),n==="local"&&Bt.applyQuaternion(this.worldQuaternion),Bt.cross(this.eye),Bt.length()===0?l=!0:this.rotationAngle=this._offset.dot(Bt.normalize())*o),(e==="E"||l)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),n==="local"&&e!=="E"&&e!=="XYZE"?(i.quaternion.copy(this._quaternionStart),i.quaternion.multiply(bt.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),i.quaternion.copy(bt.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),i.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(Ri),this.dispatchEvent(or)}}pointerUp(t){t!==null&&t.button!==0||(this.dragging&&this.axis!==null&&(rr.mode=this.mode,this.dispatchEvent(rr)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(t){return this.object=t,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(Ri),this.dispatchEvent(or),this.pointStart.copy(this.pointEnd))}getRaycaster(){return Me}getMode(){return this.mode}setMode(t){this.mode=t}setTranslationSnap(t){this.translationSnap=t}setRotationSnap(t){this.rotationSnap=t}setScaleSnap(t){this.scaleSnap=t}setSize(t){this.size=t}setSpace(t){this.space=t}}function jc(a){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:a.button};{const t=this.domElement.getBoundingClientRect();return{x:(a.clientX-t.left)/t.width*2-1,y:-(a.clientY-t.top)/t.height*2+1,button:a.button}}}function Wc(a){if(this.enabled)switch(a.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(a));break}}function Xc(a){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(a.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(a)),this.pointerDown(this._getPointer(a)))}function qc(a){this.enabled&&this.pointerMove(this._getPointer(a))}function Gc(a){this.enabled&&(this.domElement.releasePointerCapture(a.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(a)))}function Bi(a,t,e){const s=t.intersectObject(a,!0);for(let i=0;i<s.length;i++)if(s[i].object.visible||e)return s[i];return!1}const ti=new Uo,mt=new V(0,1,0),ar=new V(0,0,0),lr=new Ot,ei=new ae,ni=new ae,fe=new V,cr=new Ot,xs=new V(1,0,0),ze=new V(0,1,0),Cs=new V(0,0,1),si=new V,ys=new V,ws=new V;class Qc extends Ss{constructor(t){super(),this.isTransformControlsRoot=!0,this.controls=t,this.visible=!1}updateMatrixWorld(t){const e=this.controls;e.object!==void 0&&(e.object.updateMatrixWorld(),e.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):e.object.parent.matrixWorld.decompose(e._parentPosition,e._parentQuaternion,e._parentScale),e.object.matrixWorld.decompose(e.worldPosition,e.worldQuaternion,e._worldScale),e._parentQuaternionInv.copy(e._parentQuaternion).invert(),e._worldQuaternionInv.copy(e.worldQuaternion).invert()),e.camera.updateMatrixWorld(),e.camera.matrixWorld.decompose(e.cameraPosition,e.cameraQuaternion,e._cameraScale),e.camera.isOrthographicCamera?e.camera.getWorldDirection(e.eye).negate():e.eye.copy(e.cameraPosition).sub(e.worldPosition).normalize(),super.updateMatrixWorld(t)}dispose(){this.traverse(function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})}}class Kc extends Ss{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const t=new Os({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),e=new Ro({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),s=t.clone();s.opacity=.15;const i=e.clone();i.opacity=.5;const n=t.clone();n.color.setHex(16711680);const r=t.clone();r.color.setHex(65280);const o=t.clone();o.color.setHex(255);const l=t.clone();l.color.setHex(16711680),l.opacity=.5;const c=t.clone();c.color.setHex(65280),c.opacity=.5;const h=t.clone();h.color.setHex(255),h.opacity=.5;const d=t.clone();d.opacity=.25;const f=t.clone();f.color.setHex(16776960),f.opacity=.25,t.clone().color.setHex(16776960);const m=t.clone();m.color.setHex(7895160);const g=new $t(0,.04,.1,12);g.translate(0,.05,0);const _=new Ht(.08,.08,.08);_.translate(0,.04,0);const p=new ai;p.setAttribute("position",new vn([0,0,0,1,0,0],3));const y=new $t(.0075,.0075,.5,3);y.translate(0,.25,0);function b(z,X){const $=new ns(z,.0075,3,64,X*Math.PI*2);return $.rotateY(Math.PI/2),$.rotateX(Math.PI/2),$}function C(){const z=new ai;return z.setAttribute("position",new vn([0,0,0,1,1,1],3)),z}const T={X:[[new et(g,n),[.5,0,0],[0,0,-Math.PI/2]],[new et(g,n),[-.5,0,0],[0,0,Math.PI/2]],[new et(y,n),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new et(g,r),[0,.5,0]],[new et(g,r),[0,-.5,0],[Math.PI,0,0]],[new et(y,r)]],Z:[[new et(g,o),[0,0,.5],[Math.PI/2,0,0]],[new et(g,o),[0,0,-.5],[-Math.PI/2,0,0]],[new et(y,o),null,[Math.PI/2,0,0]]],XYZ:[[new et(new Ms(.1,0),d.clone()),[0,0,0]]],XY:[[new et(new Ht(.15,.15,.01),h.clone()),[.15,.15,0]]],YZ:[[new et(new Ht(.15,.15,.01),l.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new et(new Ht(.15,.15,.01),c.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},S={X:[[new et(new $t(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new et(new $t(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new et(new $t(.2,0,.6,4),s),[0,.3,0]],[new et(new $t(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new et(new $t(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new et(new $t(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new et(new Ms(.2,0),s)]],XY:[[new et(new Ht(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new et(new Ht(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new et(new Ht(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]]},A={START:[[new et(new Ms(.01,2),i),null,null,null,"helper"]],END:[[new et(new Ms(.01,2),i),null,null,null,"helper"]],DELTA:[[new be(C(),i),null,null,null,"helper"]],X:[[new be(p,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new be(p,i.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new be(p,i.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},M={XYZE:[[new et(b(.5,1),m),null,[0,Math.PI/2,0]]],X:[[new et(b(.5,.5),n)]],Y:[[new et(b(.5,.5),r),null,[0,0,-Math.PI/2]]],Z:[[new et(b(.5,.5),o),null,[0,Math.PI/2,0]]],E:[[new et(b(.75,1),f),null,[0,Math.PI/2,0]]]},P={AXIS:[[new be(p,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},N={XYZE:[[new et(new Bo(.25,10,8),s)]],X:[[new et(new ns(.5,.1,4,24),s),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new et(new ns(.5,.1,4,24),s),[0,0,0],[Math.PI/2,0,0]]],Z:[[new et(new ns(.5,.1,4,24),s),[0,0,0],[0,0,-Math.PI/2]]],E:[[new et(new ns(.75,.1,2,24),s)]]},H={X:[[new et(_,n),[.5,0,0],[0,0,-Math.PI/2]],[new et(y,n),[0,0,0],[0,0,-Math.PI/2]],[new et(_,n),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new et(_,r),[0,.5,0]],[new et(y,r)],[new et(_,r),[0,-.5,0],[0,0,Math.PI]]],Z:[[new et(_,o),[0,0,.5],[Math.PI/2,0,0]],[new et(y,o),[0,0,0],[Math.PI/2,0,0]],[new et(_,o),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new et(new Ht(.15,.15,.01),h),[.15,.15,0]]],YZ:[[new et(new Ht(.15,.15,.01),l),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new et(new Ht(.15,.15,.01),c),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new et(new Ht(.1,.1,.1),d.clone())]]},E={X:[[new et(new $t(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new et(new $t(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new et(new $t(.2,0,.6,4),s),[0,.3,0]],[new et(new $t(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new et(new $t(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new et(new $t(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new et(new Ht(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new et(new Ht(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new et(new Ht(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new et(new Ht(.2,.2,.2),s),[0,0,0]]]},k={X:[[new be(p,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new be(p,i.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new be(p,i.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function w(z){const X=new Ss;for(const $ in z)for(let st=z[$].length;st--;){const Z=z[$][st][0].clone(),J=z[$][st][1],U=z[$][st][2],L=z[$][st][3],nt=z[$][st][4];Z.name=$,Z.tag=nt,J&&Z.position.set(J[0],J[1],J[2]),U&&Z.rotation.set(U[0],U[1],U[2]),L&&Z.scale.set(L[0],L[1],L[2]),Z.updateMatrix();const K=Z.geometry.clone();K.applyMatrix4(Z.matrix),Z.geometry=K,Z.renderOrder=1/0,Z.position.set(0,0,0),Z.rotation.set(0,0,0),Z.scale.set(1,1,1),X.add(Z)}return X}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=w(T)),this.add(this.gizmo.rotate=w(M)),this.add(this.gizmo.scale=w(H)),this.add(this.picker.translate=w(S)),this.add(this.picker.rotate=w(N)),this.add(this.picker.scale=w(E)),this.add(this.helper.translate=w(A)),this.add(this.helper.rotate=w(P)),this.add(this.helper.scale=w(k)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(t){const s=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:ni;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let i=[];i=i.concat(this.picker[this.mode].children),i=i.concat(this.gizmo[this.mode].children),i=i.concat(this.helper[this.mode].children);for(let n=0;n<i.length;n++){const r=i[n];r.visible=!0,r.rotation.set(0,0,0),r.position.copy(this.worldPosition);let o;if(this.camera.isOrthographicCamera?o=(this.camera.top-this.camera.bottom)/this.camera.zoom:o=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),r.scale.set(1,1,1).multiplyScalar(o*this.size/4),r.tag==="helper"){r.visible=!1,r.name==="AXIS"?(r.visible=!!this.axis,this.axis==="X"&&(bt.setFromEuler(ti.set(0,0,0)),r.quaternion.copy(s).multiply(bt),Math.abs(mt.copy(xs).applyQuaternion(s).dot(this.eye))>.9&&(r.visible=!1)),this.axis==="Y"&&(bt.setFromEuler(ti.set(0,0,Math.PI/2)),r.quaternion.copy(s).multiply(bt),Math.abs(mt.copy(ze).applyQuaternion(s).dot(this.eye))>.9&&(r.visible=!1)),this.axis==="Z"&&(bt.setFromEuler(ti.set(0,Math.PI/2,0)),r.quaternion.copy(s).multiply(bt),Math.abs(mt.copy(Cs).applyQuaternion(s).dot(this.eye))>.9&&(r.visible=!1)),this.axis==="XYZE"&&(bt.setFromEuler(ti.set(0,Math.PI/2,0)),mt.copy(this.rotationAxis),r.quaternion.setFromRotationMatrix(lr.lookAt(ar,mt,ze)),r.quaternion.multiply(bt),r.visible=this.dragging),this.axis==="E"&&(r.visible=!1)):r.name==="START"?(r.position.copy(this.worldPositionStart),r.visible=this.dragging):r.name==="END"?(r.position.copy(this.worldPosition),r.visible=this.dragging):r.name==="DELTA"?(r.position.copy(this.worldPositionStart),r.quaternion.copy(this.worldQuaternionStart),Bt.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),Bt.applyQuaternion(this.worldQuaternionStart.clone().invert()),r.scale.copy(Bt),r.visible=this.dragging):(r.quaternion.copy(s),this.dragging?r.position.copy(this.worldPositionStart):r.position.copy(this.worldPosition),this.axis&&(r.visible=this.axis.search(r.name)!==-1));continue}r.quaternion.copy(s),this.mode==="translate"||this.mode==="scale"?(r.name==="X"&&Math.abs(mt.copy(xs).applyQuaternion(s).dot(this.eye))>.99&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),r.name==="Y"&&Math.abs(mt.copy(ze).applyQuaternion(s).dot(this.eye))>.99&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),r.name==="Z"&&Math.abs(mt.copy(Cs).applyQuaternion(s).dot(this.eye))>.99&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),r.name==="XY"&&Math.abs(mt.copy(Cs).applyQuaternion(s).dot(this.eye))<.2&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),r.name==="YZ"&&Math.abs(mt.copy(xs).applyQuaternion(s).dot(this.eye))<.2&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),r.name==="XZ"&&Math.abs(mt.copy(ze).applyQuaternion(s).dot(this.eye))<.2&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1)):this.mode==="rotate"&&(ei.copy(s),mt.copy(this.eye).applyQuaternion(bt.copy(s).invert()),r.name.search("E")!==-1&&r.quaternion.setFromRotationMatrix(lr.lookAt(this.eye,ar,ze)),r.name==="X"&&(bt.setFromAxisAngle(xs,Math.atan2(-mt.y,mt.z)),bt.multiplyQuaternions(ei,bt),r.quaternion.copy(bt)),r.name==="Y"&&(bt.setFromAxisAngle(ze,Math.atan2(mt.x,mt.z)),bt.multiplyQuaternions(ei,bt),r.quaternion.copy(bt)),r.name==="Z"&&(bt.setFromAxisAngle(Cs,Math.atan2(mt.y,mt.x)),bt.multiplyQuaternions(ei,bt),r.quaternion.copy(bt))),r.visible=r.visible&&(r.name.indexOf("X")===-1||this.showX),r.visible=r.visible&&(r.name.indexOf("Y")===-1||this.showY),r.visible=r.visible&&(r.name.indexOf("Z")===-1||this.showZ),r.visible=r.visible&&(r.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),r.material._color=r.material._color||r.material.color.clone(),r.material._opacity=r.material._opacity||r.material.opacity,r.material.color.copy(r.material._color),r.material.opacity=r.material._opacity,this.enabled&&this.axis&&(r.name===this.axis||this.axis.split("").some(function(l){return r.name===l}))&&(r.material.color.setHex(16776960),r.material.opacity=1)}super.updateMatrixWorld(t)}}class Jc extends et{constructor(){super(new nn(1e5,1e5,2,2),new Os({visible:!1,wireframe:!0,side:ci,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(t){let e=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(e="local"),si.copy(xs).applyQuaternion(e==="local"?this.worldQuaternion:ni),ys.copy(ze).applyQuaternion(e==="local"?this.worldQuaternion:ni),ws.copy(Cs).applyQuaternion(e==="local"?this.worldQuaternion:ni),mt.copy(ys),this.mode){case"translate":case"scale":switch(this.axis){case"X":mt.copy(this.eye).cross(si),fe.copy(si).cross(mt);break;case"Y":mt.copy(this.eye).cross(ys),fe.copy(ys).cross(mt);break;case"Z":mt.copy(this.eye).cross(ws),fe.copy(ws).cross(mt);break;case"XY":fe.copy(ws);break;case"YZ":fe.copy(si);break;case"XZ":mt.copy(ws),fe.copy(ys);break;case"XYZ":case"E":fe.set(0,0,0);break}break;case"rotate":default:fe.set(0,0,0)}fe.length()===0?this.quaternion.copy(this.cameraQuaternion):(cr.lookAt(Bt.set(0,0,0),fe,mt),this.quaternion.setFromRotationMatrix(cr)),super.updateMatrixWorld(t)}}class pn{constructor(t,e,s,i,n,r=5,o=!0){if(x(this,"onDraggingStarted",new it),x(this,"onDraggingEnded",new it),x(this,"onDisposed",new it),x(this,"normal"),x(this,"origin"),x(this,"three",new pe),x(this,"components"),x(this,"world"),x(this,"type","default"),x(this,"_title","Clipping Plane"),x(this,"_helper"),x(this,"_visible",!0),x(this,"_enabled",!0),x(this,"_controlsActive",!1),x(this,"_arrowBoundBox",new et),x(this,"_planeMesh"),x(this,"_controls"),x(this,"_hiddenMaterial",new Os({visible:!1})),x(this,"_visibilityBeforeDisabled",!0),x(this,"notifyManager",()=>{const l=this.components.get(Ge),c=l.list.getKey(this);c&&l.list.set(c,this)}),x(this,"update",()=>{this._enabled&&this.three.setFromNormalAndCoplanarPoint(this.normal,this._helper.position)}),x(this,"changeDrag",l=>{this._visible=!l.value,this.preventCameraMovement(),this.notifyDraggingChanged(l)}),this.components=t,this.world=e,!e.renderer)throw new Error("The given world must have a renderer!");this.normal=i,this.origin=s,e.renderer.setPlane(!0,this.three),this._planeMesh=pn.newPlaneMesh(r,n),this._helper=this.newHelper(),this._controls=this.newTransformControls(),this.three.setFromNormalAndCoplanarPoint(i,s),o&&this.toggleControls(!0)}set title(t){this._title=t,this.notifyManager()}get title(){return this._title}get enabled(){return this._enabled}set enabled(t){if(!this.world.isDisposing){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");this._enabled=t,t?this.visible=this._visibilityBeforeDisabled:(this._visibilityBeforeDisabled=this.visible,this.visible=!1),this.world.renderer.setPlane(t,this.three),this.notifyManager()}}get visible(){return this._visible}set visible(t){this._visible=t,this._controls.getHelper().visible=t,this._helper.visible=t,this.toggleControls(t),this.notifyManager()}get meshes(){return[this._planeMesh,this._arrowBoundBox]}get planeMaterial(){return this._planeMesh.material}set planeMaterial(t){this._planeMesh.material=t}get size(){return this._planeMesh.scale.x}set size(t){this._planeMesh.scale.set(t,t,t)}get helper(){return this._helper}get controls(){return this._controls}setFromNormalAndCoplanarPoint(t,e){this.reset(),this.normal.equals(t)||(this.normal.copy(t),this._helper.lookAt(t)),this.origin.copy(e),this._helper.position.copy(e),this._helper.updateMatrix(),this.update()}dispose(){this._enabled=!1,this.onDraggingStarted.reset(),this.onDraggingEnded.reset(),this._helper.removeFromParent(),this.world.renderer&&this.world.renderer.setPlane(!1,this.three),this._arrowBoundBox.removeFromParent(),this._arrowBoundBox.geometry.dispose(),this._planeMesh.geometry.dispose(),this._controls.getHelper().removeFromParent(),this._controls.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}reset(){const t=new V(1,0,0),e=new V;this.normal.equals(t)||(this.normal.copy(t),this._helper.lookAt(t)),this.origin.copy(e),this._helper.position.copy(e),this._helper.updateMatrix()}toggleControls(t){if(t){if(this._controlsActive)return;this._controls.addEventListener("change",this.update),this._controls.addEventListener("dragging-changed",this.changeDrag)}else this._controls.removeEventListener("change",this.update),this._controls.removeEventListener("dragging-changed",this.changeDrag);this._controlsActive=t}newTransformControls(){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");const t=this.world.camera.three,e=this.world.renderer.three.domElement,s=new Yc(t,e);return this.initializeControls(s),this.world.scene.three.add(s.getHelper()),s}initializeControls(t){t.attach(this._helper),t.showX=!1,t.showY=!1,t.setSpace("local"),this.createArrowBoundingBox(),t.getHelper().children[0].children[0].add(this._arrowBoundBox)}createArrowBoundingBox(){this._arrowBoundBox.geometry=new $t(.18,.18,1.2),this._arrowBoundBox.material=this._hiddenMaterial,this._arrowBoundBox.rotateX(Math.PI/2),this._arrowBoundBox.updateMatrix(),this._arrowBoundBox.geometry.applyMatrix4(this._arrowBoundBox.matrix)}notifyDraggingChanged(t){t.value?this.onDraggingStarted.trigger():this.onDraggingEnded.trigger()}preventCameraMovement(){this.world.camera.enabled=this._visible}newHelper(){const t=new Ss;return t.lookAt(this.normal),t.position.copy(this.origin),this._planeMesh.position.z+=.01,t.add(this._planeMesh),this.world.scene.three.add(t),t}static newPlaneMesh(t,e){const s=new nn(1),i=new et(s,e);return i.scale.set(t,t,t),i}}class th extends Ps{constructor(){super(...arguments),x(this,"_config",{enabled:{value:!0,type:"Boolean"},visible:{value:!0,type:"Boolean"},color:{value:new zt,type:"Color"},opacity:{type:"Number",interpolable:!0,value:1,min:0,max:1},size:{type:"Number",interpolable:!0,value:2,min:0,max:100}})}get enabled(){return this._config.enabled.value}set enabled(t){this._config.enabled.value=t,this._component.enabled=t}get visible(){return this._config.visible.value}set visible(t){this._config.visible.value=t,this._component.visible=t}get color(){return this._config.color.value}set color(t){this._config.color.value=t,this._component.material.color.copy(t)}get opacity(){return this._config.opacity.value}set opacity(t){this._config.opacity.value=t,this._component.material.opacity=t}get size(){return this._config.size.value}set size(t){this._config.size.value=t,this._component.size=t}}const mo=class ri extends Dt{constructor(t){super(t),x(this,"onSetup",new it),x(this,"onBeforeDrag",new it),x(this,"onAfterDrag",new it),x(this,"onBeforeCreate",new it),x(this,"onBeforeCancel",new it),x(this,"onAfterCancel",new it),x(this,"onBeforeDelete",new it),x(this,"onAfterCreate",new it),x(this,"onAfterDelete",new it),x(this,"onDisposed",new it),x(this,"isSetup",!1),x(this,"orthogonalY",!1),x(this,"toleranceOrthogonalY",.7),x(this,"Type",pn),x(this,"list",new Nt),x(this,"config",new th(this,this.components,"Clipper",ri.uuid)),x(this,"_defaultConfig",{color:new zt(12255487),opacity:.2,size:2}),x(this,"_material",new Os({color:12255487,side:ci,transparent:!0,opacity:.2})),x(this,"_size",5),x(this,"_enabled",!1),x(this,"_visible",!0),x(this,"onStateChanged",new it),x(this,"_onStartDragging",()=>{this.onBeforeDrag.trigger()}),x(this,"_onEndDragging",()=>{this.onAfterDrag.trigger()}),this.components.add(ri.uuid,this),this.setEvents()}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this.onStateChanged.trigger(["enabled"])}get visible(){return this._visible}set visible(t){this._visible=t;for(const[e,s]of this.list)s.visible=t;this.onStateChanged.trigger(["visibility"])}get material(){return this._material}set material(t){this._material=t;for(const[e,s]of this.list)s.planeMaterial=t;this.onStateChanged.trigger(["material"])}get size(){return this._size}set size(t){this._size=t;for(const[e,s]of this.list)s.size=t;this.onStateChanged.trigger(["size"])}setEvents(){this.list.onBeforeDelete.add(({value:t})=>{if(!t.world.renderer)throw new Error("Renderer not found for this plane's world!");t.world.renderer.setPlane(!1,t.three),t.dispose(),this.updateMaterialsAndPlanes(),this.onAfterDelete.trigger(t)})}dispose(){this._enabled=!1,this.components.get(pi).list.delete(this.config.uuid),this.list.clear(),this._material.dispose(),this.onBeforeCreate.reset(),this.onBeforeCancel.reset(),this.onBeforeDelete.reset(),this.onBeforeDrag.reset(),this.onAfterCreate.reset(),this.onAfterCancel.reset(),this.onAfterDelete.reset(),this.onAfterDrag.reset(),this.onDisposed.trigger(ri.uuid),this.onDisposed.reset()}async create(t){const i=await this.components.get(Ke).get(t).castRay();return i?this.createPlaneFromIntersection(t,i):null}createFromNormalAndCoplanarPoint(t,e,s){const i=this.newPlane(t,s,e);return this.updateMaterialsAndPlanes(),i}async delete(t,e){if(!e){const s=await this.pickPlane(t);if(!s)return;e=this.list.getKey(s)}e&&this.list.delete(e)}deleteAll(t){for(const[e,s]of this.list)(!t||t.has(s.type))&&this.list.delete(e)}setup(t){const e={...this._defaultConfig,...t};this.config.color=e.color,this.config.opacity=e.opacity,this.config.size=e.size,this.isSetup=!0,this.onSetup.trigger()}async pickPlane(t){const s=this.components.get(Ke).get(t),i=this.getAllPlaneMeshes(),n=await s.castRay({items:i});if(n){const r=n.object;return[...this.list.values()].find(o=>o.meshes.includes(r))}}getAllPlaneMeshes(){const t=[];for(const[e,s]of this.list)t.push(...s.meshes);return t}createPlaneFromIntersection(t,e){var s;if(!t.renderer)throw new Error("The given world must have a renderer!");const i=e.point.distanceTo(new V(0,0,0)),n=e.normal||((s=e.face)==null?void 0:s.normal);if(!i||!n)return null;const r=this.getWorldNormal(e,n),o=this.newPlane(t,e.point,r.negate()),l=this.list.get(o);return l.visible=this._visible,l.size=this._size,t.renderer.setPlane(!0,l.three),this.updateMaterialsAndPlanes(),l}getWorldNormal(t,e){const s=t.object;let i=t.object.matrixWorld.clone();if(s instanceof ko&&t.instanceId!==void 0){const l=new Ot;s.getMatrixAt(t.instanceId,l),i=l.multiply(i)}const r=new Po().getNormalMatrix(i),o=e.clone().applyMatrix3(r).normalize();return this.normalizePlaneDirectionY(o),o}normalizePlaneDirectionY(t){this.orthogonalY&&(t.y>this.toleranceOrthogonalY&&(t.x=0,t.y=1,t.z=0),t.y<-this.toleranceOrthogonalY&&(t.x=0,t.y=-1,t.z=0))}newPlane(t,e,s){const i=new this.Type(this.components,t,e,s,this._material);i.onDraggingStarted.add(this._onStartDragging),i.onDraggingEnded.add(this._onEndDragging);const n=qt.create();return this.list.set(n,i),this.onAfterCreate.trigger(i),n}updateMaterialsAndPlanes(){const t=this.components.get(eo);for(const[e,s]of t.list){if(!s.renderer)continue;s.renderer.updateClippingPlanes();const{clippingPlanes:i}=s.renderer;for(const n of s.meshes)if(n.material)if(Array.isArray(n.material))for(const r of n.material)r.clippingPlanes=i;else n.material.clippingPlanes=i}}};x(mo,"uuid","66290bc5-18c4-4cd1-9379-2e17a0617611");let Ge=mo;class go{constructor(t,e){x(this,"title"),x(this,"guid",qt.create()),x(this,"clippingPlanes",new we),x(this,"camera",{aspect_ratio:1,field_of_view:60,camera_direction:{x:0,y:0,z:0},camera_view_point:{x:0,y:0,z:0},camera_up_vector:{x:0,y:1,z:0}}),x(this,"customData",{}),x(this,"exceptionComponents",new we),x(this,"selectionComponents",new we),x(this,"componentColors",new Nt),x(this,"spacesVisible",!1),x(this,"spaceBoundariesVisible",!1),x(this,"openingsVisible",!1),x(this,"defaultVisibility",!0),x(this,"snapshot",this.guid),x(this,"_components"),x(this,"_world",null),x(this,"notifyUpdate",()=>{this._components.get(ye).list.set(this.guid,this)}),this._components=t,e&&(this.guid=e.guid??this.guid,this.set(e)),this.setEvents()}async getSelectionMap(){return await this._components.get(ct).guidsToModelIdMap([...this.selectionComponents])}async getExceptionMap(){return await this._components.get(ct).guidsToModelIdMap([...this.exceptionComponents])}get projection(){return"field_of_view"in this.camera?"Perspective":"Orthographic"}get position(){const t=this._components.get(ct),{camera_view_point:e}=this.camera,{x:s,y:i,z:n}=e,r=new V(s,i,n);return t.applyBaseCoordinateSystem(r,new Ot),r}set position(t){const e=t.clone(),s=this._components.get(ct);t.clone().applyMatrix4(s.baseCoordinationMatrix.clone().invert()),this.camera.camera_view_point={x:e.x,y:e.y,z:e.z}}get direction(){const{camera_direction:t}=this.camera,{x:e,y:s,z:i}=t;return new V(e,s,i)}set world(t){this._world=t}get world(){return this._world}get _managerVersion(){return this._components.get(kt).config.version}get topics(){return[...this._components.get(kt).list.values()].filter(i=>i.viewpoints.has(this.guid))}setEvents(){this.selectionComponents.onUpdated.add(this.notifyUpdate),this.exceptionComponents.onUpdated.add(this.notifyUpdate),this.clippingPlanes.onUpdated.add(this.notifyUpdate),this.componentColors.onItemSet.add(this.notifyUpdate),this.componentColors.onItemDeleted.add(this.notifyUpdate),this.componentColors.onItemUpdated.add(this.notifyUpdate),this.componentColors.onCleared.add(this.notifyUpdate)}set(t){this.title=t.title;const{components:e,perspective_camera:s,orthogonal_camera:i,clipping_planes:n}=t;if(e){const{selection:r,visibility:o,coloring:l}=e;if(r){this.selectionComponents.clear();for(const{ifc_guid:c}of r)c&&this.selectionComponents.add(c)}if(o){const{default_visibility:c,exceptions:h,view_setup_hints:d}=o;if(c!==void 0&&(this.defaultVisibility=c),h){this.exceptionComponents.clear();for(const{ifc_guid:f}of h)f&&this.exceptionComponents.add(f)}if(d){const{spaces_visible:f,space_boundaries_visible:u,openings_visible:m}=d;f!==void 0&&(this.spacesVisible=f),u!==void 0&&(this.spaceBoundariesVisible=u),m!==void 0&&(this.openingsVisible=m)}}if(l){this.componentColors.clear();for(const c of l){const{color:h,components:d}=c,f=d.map(u=>u.ifc_guid).filter(u=>u!==null);this.componentColors.set(h,f)}}}if((s||i)&&(this.camera=s??i),n&&this.world){const r=this._components.get(Ge);for(const o of n){const{location:l,direction:c}=o,h=new V(l.x,l.z,-l.y),d=new V(c.x,c.z,-c.y),f=r.createFromNormalAndCoplanarPoint(this.world,d,h);this.clippingPlanes.add(f),r.list.get(f).enabled=!1,r.list.get(f).visible=!1}}this.notifyUpdate()}async go(t){if(!this.world)return;const{camera:e}=this.world;if(!(e instanceof uo))throw new Error("Viewpoint: the world's camera component must be of type OrthoPerspectiveCamera to switch between perspective and orthographic projections.");const{transition:s,applyClippings:i,applyVisibility:n,clippingsVisibility:r}={transition:!0,applyClippings:!0,applyVisibility:!0,clippingsVisibility:!0,...t};e.projection.set(this.projection);const o=new V(this.camera.camera_view_point.x,this.camera.camera_view_point.y,this.camera.camera_view_point.z),l=new V(this.camera.camera_direction.x,this.camera.camera_direction.y,this.camera.camera_direction.z);if(o.equals(new V)&&l.equals(new V))return;const c=this.position,h=this.direction,d=80,f={x:c.x+h.x*d,y:c.y+h.y*d,z:c.z+h.z*d},u=[];i&&this.setClippingState(!0),n&&u.push(this.applyVisibility()),this.setClippingVisibility(r),u.push(e.controls.setLookAt(c.x,c.y,c.z,f.x,f.y,f.z,s)),await Promise.all(u)}async updateCamera(t=!0){return new Promise(e=>{if(!this.world){e(!1);return}const{camera:s,renderer:i}=this.world;if(!i)throw new Error("Viewpoint: the world needs to have a renderer!");if(!s.hasCameraControls())throw new Error("Viewpoint: world's camera need camera controls!");const n=new V;s.controls.getPosition(n);const r=s.three,o=new V(0,0,-1).applyEuler(r.rotation),{width:l,height:c}=i.getSize();let h=l/c;Number.isNaN(h)&&(h=1);const d=this._components.get(ct);n.applyMatrix4(d.baseCoordinationMatrix.clone().invert());const f={aspect_ratio:h,camera_view_point:{x:n.x,y:n.y,z:n.z},camera_direction:{x:o.x,y:o.y,z:o.z},camera_up_vector:{x:0,y:1,z:0}};if(r instanceof Cr?this.camera={...f,field_of_view:r.fov}:r instanceof sn&&(this.camera={...f,view_to_world_scale:r.top-r.bottom}),t){const u=this._components.get(ye),m=i.three.domElement;i.three.render(this.world.scene.three,s.three),m.toBlob(async g=>{if(g){const _=await g.arrayBuffer(),p=new Uint8Array(_);u.snapshots.set(this.guid,p)}this.notifyUpdate(),e(!0)})}else this.notifyUpdate(),e(!0)})}takeSnapshot(){return new Promise(t=>{if(!this.world){t(!1);return}const{camera:e,renderer:s}=this.world;if(!s)throw new Error("Viewpoint: the world needs to have a renderer!");const i=this._components.get(ye),n=s.three.domElement;s.three.render(this.world.scene.three,e.three),n.toBlob(async r=>{if(r){const o=await r.arrayBuffer(),l=new Uint8Array(o);i.snapshots.set(this.guid,l)}this.notifyUpdate(),t(!0)})})}updateClippingPlanes(){this.clippingPlanes.clear();const t=this._components.get(Ge);for(const[e,s]of t.list)s.enabled&&this.clippingPlanes.add(e)}async applyVisibility(){const t=this._components.get(_l);t.set(this.defaultVisibility);const e=await this.getExceptionMap();t.set(!this.defaultVisibility,e);const s=await this.getSelectionMap();t.set(!0,s)}async setColorizationState(t){const e=this._components.get(ct),s=[];if(t)for(const[i,n]of this.componentColors){const r=`#${i}`,o=await e.guidsToModelIdMap(n);for(const[l,c]of Object.entries(o)){const h=e.list.get(l);h&&s.push(h.highlight([...c],{customId:r,color:new zt(r),renderedFaces:So.ONE,opacity:1,transparent:!1}))}}else for(const[i,n]of this.componentColors){const r=await e.guidsToModelIdMap(n);for(const[o,l]of Object.entries(r)){const c=e.list.get(o);c&&s.push(c.resetHighlight([...l]))}}s.push(e.core.update(!0)),await Promise.all(s)}setClippingState(t){const e=this._components.get(Ge);for(const[s,i]of e.list)i.enabled=t&&this.clippingPlanes.has(s)}setClippingVisibility(t){const e=this._components.get(Ge);for(const s of this.clippingPlanes){const i=e.list.get(s);i&&(i.visible=t)}}async createComponentTags(t){var e;const s=this._components.get(ct),i=this._components.get(kt);let n="";if(i.config.includeSelectionTag){const r=t==="selection"?await this.getSelectionMap():await this.getExceptionMap();for(const o in r){const l=s.list.get(o);if(!l)continue;const c=r[o];for(const h of c){const d=l.getItem(h),f=await d.getGuid();if(!f)continue;const u=(e=await d.getAttributes())==null?void 0:e.getValue("Tag");let m=null;u&&(m=`AuthoringToolId="${u}"`),n+=`
<Component IfcGuid="${f}" ${m??""} />`}}}else n=[...this.selectionComponents].map(r=>`<Component IfcGuid="${r}" />`).join(`
`);return n}createColorTags(){let t="";for(const[e,s]of this.componentColors.entries()){const i=s.map(n=>`
<Component IfcGuid="${n}" />`).join(`
`);t+=`<Color Color="${e}">
${i}
</Color>`}return t.length!==0?`<Coloring>
${t}
</Coloring>`:"<Coloring />"}toJSON(){const t=this._components.get(Ge),e={guid:this.guid,components:{selection:[...this.selectionComponents].map(n=>({ifc_guid:n,authoring_tool_id:null})),coloring:[...this.componentColors].map(([n,r])=>({color:n,components:r.map(o=>({ifc_guid:o,authoring_tool_id:null}))})),visibility:{default_visibility:this.defaultVisibility,exceptions:[...this.exceptionComponents].map(n=>({ifc_guid:n,authoring_tool_id:null})),view_setup_hints:{spaces_visible:this.spacesVisible,space_boundaries_visible:this.spaceBoundariesVisible,openings_visible:this.openingsVisible}}},clipping_planes:[...this.clippingPlanes].map(n=>{const r=t.list.get(n);if(!r)return null;const o=r._controls.worldPosition??r.origin,{normal:l}=r;return{location:{x:o.x,y:-o.z,z:o.y},direction:{x:l.x,y:-l.z,z:l.y}}}).filter(n=>n!==null)};"field_of_view"in this.camera?e.perspective_camera=this.camera:e.orthogonal_camera=this.camera;const s=this._components.get(ye),i=s.snapshots.get(this.snapshot);if(i){const n=i.toString(),r=btoa(n),o=s.getSnapshotExtension(this.snapshot);e.snapshot={snapshot_type:o,snapshot_data:r}}return e}async serialize(t=this._managerVersion){const e=this._components.get(ct),s=this.position;s.applyMatrix4(e.baseCoordinationMatrix.clone().invert());const i=this.direction;i.normalize();const n=new Ot().makeRotationX(Math.PI/2),r=i.clone().applyMatrix4(n);r.normalize();const o=`<CameraViewPoint>
      <X>${s.x}</X>
      <Y>${-s.z}</Y>
      <Z>${s.y}</Z>
    </CameraViewPoint>`,l=`<CameraDirection>
      <X>${i.x}</X>
      <Y>${-i.z}</Y>
      <Z>${i.y}</Z>
    </CameraDirection>`,c=`<CameraUpVector>
      <X>${r.x}</X>
      <Y>${-r.z}</Y>
      <Z>${r.y}</Z>
    </CameraUpVector>`,h=`<AspectRatio>${this.camera.aspect_ratio}</AspectRatio>`;let d="";"view_to_world_scale"in this.camera?d=`<OrthogonalCamera>
        ${o}
        ${l}
        ${c}
        ${h}
        <ViewToWorldScale>${this.camera.view_to_world_scale}</ViewToWorldScale>
      </OrthogonalCamera>`:"field_of_view"in this.camera&&(d=`<PerspectiveCamera>
        ${o}
        ${l}
        ${c}
        ${h}
        <FieldOfView>${this.camera.field_of_view}</FieldOfView>
      </PerspectiveCamera>`);const f=`<ViewSetupHints SpacesVisible="${this.spacesVisible??!1}" SpaceBoundariesVisible="${this.spaceBoundariesVisible??!1}" OpeningsVisible="${this.openingsVisible??!1}" />`,u=(await this.createComponentTags("selection")).trim(),m=(await this.createComponentTags("exception")).trim(),g=this.createColorTags();return`<?xml version="1.0" encoding="UTF-8"?>
    <VisualizationInfo Guid="${this.guid}">
      <Components>
        ${t==="2.1"?f:""}
        ${u.length!==0?`<Selection>${u}</Selection>`:""}
        <Visibility DefaultVisibility="${this.defaultVisibility}">
          ${t==="3"?f:""}
          ${m.length!==0?`<Exceptions>${m}</Exceptions>`:""}
        </Visibility>
        ${g}
      </Components>
      ${d}
    </VisualizationInfo>`}}class eh extends Ps{constructor(){super(...arguments),x(this,"_config",{overwriteColors:{value:!1,type:"Boolean"}})}get overwriteColors(){return this._config.overwriteColors.value}set overwriteColors(t){this._config.overwriteColors.value=t}}const _o=class Ki extends Dt{constructor(t){super(t),x(this,"enabled",!0),x(this,"world",null),x(this,"list",new Nt),x(this,"snapshots",new Nt),x(this,"isSetup",!1),x(this,"onSetup",new it),x(this,"config",new eh(this,this.components,"Viewpoints",Ki.uuid)),x(this,"onDisposed",new it),t.add(Ki.uuid,this)}create(t){const e=new go(this.components,t);return e.world=this.world,t||this.list.set(e.guid,e),e}getSnapshotExtension(t){let e="jpeg";const s=this.snapshots.get(t);if(!s)return e;const i=s.subarray(0,4);let n="";for(let r=0;r<i.length;r++)n+=i[r].toString(16);return n.startsWith("89504e47")&&(e="png"),n.startsWith("ffd8ffe")&&(e="jpeg"),e}setup(){}dispose(){this.list.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}};x(_o,"uuid","ee867824-a796-408d-8aa0-4e5962a83c66");let ye=_o;class hr{constructor(t,e){x(this,"_components"),x(this,"_cameraOffset",10),x(this,"_planeHelper"),x(this,"_farPlaneHelper"),x(this,"_cameraHelper"),x(this,"onStateChanged",new it),x(this,"onUpdated",new it),x(this,"onDisposed",new it),x(this,"camera"),x(this,"plane",new pe),x(this,"farPlane",new pe),x(this,"id",qt.create()),x(this,"_open",!1),x(this,"_range",sh.defaultRange),x(this,"_world",null),x(this,"_helpersVisible",!1),x(this,"_planesEnabled",!1),this._components=t,this.camera=new uo(this._components);const{threeOrtho:s}=this.camera;if(e!=null&&e.id&&(this.id=e.id),e!=null&&e.normal&&(e!=null&&e.point)){const{normal:i,point:n}=e;this.plane.setFromNormalAndCoplanarPoint(i,n)}this._cameraHelper=new Wo(s),this._planeHelper=new xn(this.plane,50),this._farPlaneHelper=new xn(this.farPlane,50),this.farPlaneHelperColor=new zt("blue"),this.update()}get _planeNormalOpposite(){return this.plane.normal.clone().negate()}get _planePosition(){return this.plane.normal.clone().multiplyScalar(-this.plane.constant)}get _cameraPosition(){return this._planePosition.addScaledVector(this._planeNormalOpposite,this._cameraOffset)}set open(t){this._open=t,this.onStateChanged.trigger(["open"])}get open(){return this._open}set planeHelperColor(t){!Array.isArray(this._planeHelper.material)&&"color"in this._planeHelper.material&&this._planeHelper.material.color instanceof zt&&(this._planeHelper.material.color=t)}set farPlaneHelperColor(t){!Array.isArray(this._farPlaneHelper.material)&&"color"in this._farPlaneHelper.material&&this._farPlaneHelper.material.color instanceof zt&&(this._farPlaneHelper.material.color=t)}set range(t){this._range=t,this.update()}get range(){return this._range}set distance(t){this.plane.constant=t,this.update()}get distance(){return this.plane.constant}set world(t){this._world=t,this.camera.currentWorld=t,t&&(this.camera.projection.set("Orthographic"),this.camera.set("Plan"),this.camera.controls.dollySpeed=6,this.camera.controls.restThreshold=.005,this.update())}get world(){return this._world}set helpersVisible(t){if(!t){this._helpersVisible=t,this._planeHelper.removeFromParent(),this._farPlaneHelper.removeFromParent(),this._cameraHelper.removeFromParent();return}this.world&&(this._helpersVisible=t,this.world.scene.three.add(this._planeHelper,this._farPlaneHelper))}get helpersVisible(){return this._helpersVisible}set planesEnabled(t){const{world:e}=this;if(!e)return;const{renderer:s}=e;s&&(s.setPlane(t,this.plane),s.setPlane(t,this.farPlane),this._planesEnabled=t)}get planesEnabled(){return this._planesEnabled}dispose(){this.helpersVisible=!1;const t=this._components.get(hi);t.destroy(this._planeHelper),t.destroy(this._farPlaneHelper),t.destroy(this._cameraHelper),this.camera.dispose(),this.onDisposed.trigger()}update(){if(this.world){const t=this._cameraPosition,e=this._planePosition;this.camera.controls.setLookAt(t.x,t.y,t.z,e.x,e.y,e.z,!1)}this.farPlane.normal.copy(this._planeNormalOpposite),this.farPlane.constant=this.range-this.plane.constant,this.onUpdated.trigger()}flip(){this.plane.normal.negate(),this.update()}}const mn=class yo extends Dt{constructor(t){super(t),x(this,"list",new Nt),x(this,"enabled",!0),x(this,"world",null),x(this,"_fragmentsUpdateEvent",()=>{this.components.get(ct).core.update(!0)}),t.add(yo.uuid,this),this.setupEvents()}get hasOpenViews(){return[...this.list.values()].some(t=>t.open)}setupEvents(){this.list.onBeforeDelete.add(({key:t,value:e})=>{e.open&&this.close(t),e.dispose()})}create(t,e,s){const i=new hr(this.components,{id:s==null?void 0:s.id,normal:t,point:e});return i.world=(s==null?void 0:s.world)??this.world,this.list.set(i.id,i),i}createFromPlane(t,e){const s=new hr(this.components,{id:e==null?void 0:e.id});return s.plane.copy(t),s.update(),s.world=(e==null?void 0:e.world)??this.world,this.list.set(s.id,s),s}async createFromIfcStoreys(t){const e=[],s=this.components.get(ct),i=(t==null?void 0:t.offset)===void 0?.25:t.offset;for(const[n,r]of s.list){if(t&&t.modelIds&&!t.modelIds.some(d=>d.test(n)))continue;const o=Object.values(await r.getItemsOfCategories([/BUILDINGSTOREY/])).flat();if(o.length===0)continue;const l=await r.getItemsData(o),[,c]=await r.getCoordinates(),h=new V(0,-1,0);for(const d of l){if(!("value"in d.Name&&"value"in d.Elevation))continue;const{value:f}=d.Name;if(t!=null&&t.storeyNames&&!t.storeyNames.some(_=>_.test(f)))continue;const u=d.Elevation.value+c+i,m=new pe(h,u),g=this.createFromPlane(m,{id:f,world:t==null?void 0:t.world});e.push(g)}}return e}createElevations(t){const e=[],s=this.components.get(ct),i=(t==null?void 0:t.combine)===void 0?!1:t.combine,n=(t==null?void 0:t.namingCallback)??(o=>({front:`${i?"Front":`${o}: Front`}`,back:`${i?"Back":`${o}: Back`}`,left:`${i?"Left":`${o}: Left`}`,right:`${i?"Right":`${o}: Right`}`}));let r=[];for(const[o,l]of s.list)t&&t.modelIds&&!t.modelIds.some(c=>c.test(o))||r.push({id:o,box:l.box});if(i){const o=this.components.get($r);o.list.clear(),o.list.add(...r.map(c=>c.box)),r=[{id:"combined",box:o.get()}]}for(const{id:o,box:l}of r){const{min:c,max:h}=l,d=Math.abs(h.x-c.x),f=Math.abs(h.z-c.z),u=new V;l.getCenter(u);const m=new pe(new V(0,0,-1),h.z),g=new pe(new V(0,0,1),-c.z),_=new pe(new V(-1,0,0),h.x),p=new pe(new V(1,0,0),-c.x),{front:y,back:b,left:C,right:T}=n(o),S=this.createFromPlane(m,{id:y,world:t==null?void 0:t.world});S.range=f;const A=this.createFromPlane(g,{id:b,world:t==null?void 0:t.world});A.range=f;const M=this.createFromPlane(_,{id:C,world:t==null?void 0:t.world});M.range=d;const P=this.createFromPlane(p,{id:T,world:t==null?void 0:t.world});P.range=d,e.push(S,A,M,P)}return e}open(t){const e=this.list.get(t);if(!e)throw new Error(`Views: the view with id ${t} doesn't exist.`);if(e.open)return;const{world:s}=e;if(!s)throw new Error(`Views: no world found for view with id ${t}.`);const{renderer:i}=s;if(!i)throw new Error(`Views: no renderer found for world with id ${s.uuid}.`);for(const[,n]of this.list)n.world===s&&this.close(n.id);i.setPlane(!0,e.plane),i.setPlane(!0,e.farPlane),e.camera.controls.addEventListener("rest",this._fragmentsUpdateEvent),s.camera=e.camera,e.open=!0}close(t){let e;if(t?e=this.list.get(t):e=[...this.list.values()].find(n=>n.open),t&&!e)throw new Error(`Views: the view with id ${t} doesn't exist.`);if(!e||!e.open)return;const{world:s}=e;if(!s)throw new Error(`Views: no world found for view with id ${t}.`);const{renderer:i}=s;if(!i)throw new Error(`Views: no renderer found for world with id ${s.uuid}.`);i.setPlane(!1,e.plane),i.setPlane(!1,e.farPlane),e.camera.controls.removeEventListener("rest",this._fragmentsUpdateEvent),s.useDefaultCamera(),e.open=!1}};x(mn,"uuid","fb22f1f5-6598-4664-a11d-de8963ae420f");x(mn,"defaultRange",15);let sh=mn;class ts{constructor(t){x(this,"cardinality","required"),x(this,"instructions"),x(this,"evalRequirement",(e,s,i,n)=>{const r={parameter:i,currentValue:e,requiredValue:s,pass:!1};n&&this.addCheckResult(r,n);let o=!1;if(s.type==="simple"&&(o=e===s.parameter),s.type==="enumeration"&&(o=s.parameter.includes(e)),s.type==="pattern"&&(o=new RegExp(s.parameter).test(String(e))),s.type==="length"){const{min:l,length:c,max:h}=s.parameter;c!==void 0&&(o=String(e).length===c),l!==void 0&&(o=String(e).length>=l),h!==void 0&&(o=String(e).length<=h)}if(s.type==="bounds"&&typeof e=="number"){const{min:l,minInclusive:c,max:h,maxInclusive:d}=s.parameter;let f=!0,u=!0;l!==void 0&&(f=c?e>=l:e>l),h!==void 0&&(u=d?e<=h:e<h),o=f&&u}return this.cardinality==="prohibited"&&(o=!o),this.cardinality==="optional"&&(o=!0),r.pass=o,r.pass}),this._components=t}addCheckResult(t,e){const s=e.findIndex(({parameter:i})=>i===t.parameter);s!==-1?e[s]=t:e.push(t)}getItemChecks(t,e,s,i){if(!("value"in s._localId&&typeof s._localId.value=="number"))return null;let n=t.get(e);n||(n=new Nt,t.set(e,n));let r=n.get(s._localId.value);if(r&&i&&!r.pass)return null;if(!r){const c=[];r={guid:Array.isArray(s._guid)?void 0:s._guid.value,pass:!1,checks:c},Object.defineProperty(r,"pass",{get:()=>c.every(({pass:h})=>h)}),n.set(s._localId.value,r)}const o=[],l={facetType:this.facetType,cardinality:this.cardinality,checks:o,pass:!1};return Object.defineProperty(l,"pass",{get:()=>o.every(({pass:c})=>c)}),r.checks.push(l),l.checks}}const me=(a,t)=>{let e="";if(!t)return e;if(t.type==="simple"&&(e=`<simpleValue>${t.parameter}</simpleValue>`),t.type==="enumeration"&&(e=`<xs:restriction base="xs:string">
    ${t.parameter.map(n=>`<xs:enumeration value="${n}" />`).join(`
`)}
    </xs:restriction>`),t.type==="pattern"&&(e=`<xs:restriction base="xs:string">
      <xs:pattern value="${t.parameter}" />
    </xs:restriction>`),t.type==="bounds"){const{min:i,minInclusive:n,max:r,maxInclusive:o}=t.parameter;let l="";i!==void 0&&(l=`<xs:min${n?"Inclusive":"Exclusive"} value="${i}">`);let c="";r!==void 0&&(c=`<xs:max${o?"Inclusive":"Exclusive"} value="${r}">`),e=`<xs:restriction base="xs:double">
      ${l}
      ${c}
    </xs:restriction>`}if(t.type==="length"){const{length:i,min:n,max:r}=t.parameter;let o="";i!==void 0&&n===void 0&&r===void 0&&(o=`<xs:length value="${i}" />`);let l="";n!==void 0&&i===void 0&&(l=`<xs:minLength value="${n}" />`);let c="";r!==void 0&&i===void 0&&(c=`<xs:maxLength value="${r}" />`),e=`<xs:restriction base="xs:string">
      ${o}
      ${l}
      ${c}
    </xs:restriction>`}return`<${a[0].toLowerCase()+a.slice(1)}>
    ${e}
  </${a[0].toLowerCase()+a.slice(1)}>`};class ih extends ts{constructor(t,e){super(t),x(this,"facetType","Attribute"),x(this,"name"),x(this,"value"),this.name=e}serialize(t){const e=me("Name",this.name),s=me("Value",this.value);let i="";return t==="requirement"&&(i+=`cardinality="${this.cardinality}"`,i+=this.instructions?`instructions="${this.instructions}"`:""),`<attribute ${i}>
  ${e}
  ${s}
</attribute>`}async getEntities(){}async test(t,e,s={skipIfFails:!0}){const i=this._components.get(ct);for(const[n,r]of Object.entries(t)){const o=i.list.get(n);if(!o)continue;const l=await o.getItemsData([...r]);for(const c of l){const h=this.getItemChecks(e,n,c,s.skipIfFails);if(!h)continue;const f=Object.keys(c).filter(m=>{const g=this.evalRequirement(m,this.name,"Name");if(!g)return!1;const _=c[m];return Array.isArray(_)?!0:_===null||_.value===null?this.cardinality==="optional"||this.cardinality==="prohibited":Array.isArray(_.value)&&_.value.length===0||typeof _.value=="string"&&_.value.trim()===""?!1:g}),u=f.length>0;if(h.push({parameter:"Name",currentValue:u?f[0]:null,requiredValue:this.name,pass:this.cardinality==="prohibited"?!u:u}),this.value)if(f[0]){const m=c[f[0]];Array.isArray(m)?h.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:this.cardinality==="prohibited"}):Array.isArray(m.value)?h.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:this.cardinality==="prohibited"}):this.evalRequirement(m.value,this.value,"Value",h)}else h.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:this.cardinality==="prohibited"})}}}}class nh extends ts{constructor(t,e){super(t),x(this,"facetType","Classification"),x(this,"system"),x(this,"value"),x(this,"uri"),this.system=e}serialize(t){const e=me("System",this.system),s=me("Value",this.value);let i="";return t==="requirement"&&(i+=`cardinality="${this.cardinality}"`,i+=this.uri?`uri=${this.uri}`:"",i+=this.instructions?`instructions="${this.instructions}"`:""),`<classification ${i}>
  ${e}
  ${s}
</classification>`}async getEntities(t,e){}async test(t,e){}}class Ji extends ts{constructor(t,e){super(t),x(this,"facetType","Entity"),x(this,"name"),x(this,"predefinedType"),this.name=e}serialize(t){const e=me("Name",this.name),s=me("Name",this.predefinedType);let i="";return t==="requirement"&&(i+=`cardinality="${this.cardinality}"`,i+=this.instructions?`instructions="${this.instructions}"`:""),`<entity ${i}>
  ${e}
  ${s}
</entity>`}async getEntities(t,e){const s=this._components.get(ct),i=new Map;for(const[r,o]of s.list){if(!t.find(h=>h.test(r)))continue;const c=await o.getCategories();for(const h of c){if(!await this.evalName(h))continue;let f=i.get(r);f||(f=[],i.set(r,f)),f.push(h)}}const n={};if(await Promise.all(Array.from(i.entries()).map(async([r,o])=>{const l=s.list.get(r);if(!l)return;const c=o.map(f=>new RegExp(`^${f}$`)),h=await l.getItemsOfCategories(c),d=Object.values(h).flat();n[r]=new Set(d)})),!this.predefinedType){Mt.add(e,n);return}for(const[r,o]of Object.entries(n)){const l=s.list.get(r);if(!l)continue;const c=await l.getItemsData([...o]);for(const h of c){if(!("value"in h._localId))continue;await this.evalPredefinedType(r,h)&&Mt.append(e,r,h._localId.value)}}}async test(t,e,s){const i=this._components.get(ct);for(const[n,r]of Object.entries(t)){const o=i.list.get(n);if(!o)continue;const l=await o.getItemsData([...r]);for(const c of l){if(!("value"in c._category))continue;const h=this.getItemChecks(e,n,c,s.skipIfFails);h&&(await this.evalName(c._category.value,h),await this.evalPredefinedType(n,c,h))}}}async evalName(t,e){return this.evalRequirement(t,this.name,"Name",e)}async evalPredefinedType(t,e,s){if(!this.predefinedType||!("value"in e.PredefinedType))return null;const i=typeof this.predefinedType.parameter=="string"&&this.predefinedType.parameter==="USERDEFINED";let n=e.PredefinedType.value;if(n==="USERDEFINED"&&!i){const l=Object.keys(e).find(c=>/^((?!Predefined).)*Type$/.test(c));if(l){const c=e[l];"value"in c&&(n=c.value)}else n="USERDEFINED"}if(!n){const l=this._components.get(ct).list.get(t);if(l&&"value"in e._localId){const[c]=await l.getItemsData([e._localId.value],{relations:{IsTypedBy:{attributes:!0,relations:!1}}});if(Array.isArray(c.IsTypedBy)){const h=c.IsTypedBy[0];if(h&&"value"in h.PredefinedType&&(n=h.PredefinedType.value,n==="USERDEFINED"&&!i)){const f=Object.keys(h).find(u=>/^((?!Predefined).)*Type$/.test(u));if(f){const u=h[f];"value"in u&&(n=u.value)}else n="USERDEFINED"}}}}return this.evalRequirement(n,this.predefinedType,"PredefinedType",s)}}class rh extends ts{constructor(t,e,s){super(t),x(this,"facetType","Property"),x(this,"propertySet"),x(this,"baseName"),x(this,"value"),x(this,"dataType"),x(this,"uri"),x(this,"_unsupportedTypes",["IFCCOMPLEXPROPERTY","IFCPHYSICALCOMPLEXQUANTITY"]),this.propertySet=e,this.baseName=s}serialize(t){const e=me("PropertySet",this.propertySet),s=me("BaseName",this.baseName),i=me("Value",this.value),n=this.dataType?`dataType=${this.dataType}`:"";let r="";return t==="requirement"&&(r+=`cardinality="${this.cardinality}"`,r+=this.uri?`uri=${this.uri}`:"",r+=this.instructions?`instructions="${this.instructions}"`:""),`<property ${n} ${r}>
  ${e}
  ${s}
  ${i}
</property>`}async getEntities(t,e){const s=this._components.get(ct);for(const[i,n]of s.list){if(!t.find(h=>h.test(i)))continue;const o=await n.getItemsOfCategories([/PROPERTYSET/,/ELEMENTQUANTITY/]),l=Object.values(o).flat();if(l.length===0)continue;const c=await n.getItemsData(l,{relations:{HasProperties:{attributes:!0,relations:!1},DefinesOcurrence:{attributes:!0,relations:!1}}});for(const h of c){if(!("value"in h._localId&&"value"in h._category&&"value"in h.Name&&Array.isArray(h.DefinesOcurrence))||!this.evalRequirement(h.Name.value,this.propertySet,"PropertySet"))continue;let f;if(h._category.value==="IFCPROPERTYSET"&&(f="HasProperties"),h._category.value==="IFCELEMENTQUANTITY"&&(f="Quantities"),!f)continue;const u=h[f];if(Array.isArray(u))for(const m of u){const g=Object.keys(m),_=g.find(C=>/Name/.test(C));if(!(_&&"value"in m[_]))continue;const p=m[_];if(!("value"in p)||!this.evalRequirement(p.value,this.baseName,"BaseName"))continue;if(this.value){const C=g.find(A=>/Value/.test(A));if(!C)continue;const T=m[C];if(!("value"in T)||!this.evalRequirement(T.value,this.value,"Value"))continue}const b=h.DefinesOcurrence.map(C=>"value"in C._localId&&typeof C._localId.value=="number"?C._localId.value:null).filter(C=>C!==null);Mt.append(e,i,...b)}}}}async test(t,e,s={skipIfFails:!0}){const i=this._components.get(ct);for(const[n,r]of Object.entries(t)){const o=i.list.get(n);if(!o)continue;const l=await o.getItemsData([...r],{relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1},HasPropertySets:{attributes:!0,relations:!0},DefinesOcurrence:{attributes:!1,relations:!1}}});for(const c of l){const h=this.getItemChecks(e,n,c,s.skipIfFails);if(!h)continue;const f=(await this.getPsets(c)).filter(u=>!("value"in u.Name)||!this.evalRequirement(u.Name.value,this.propertySet,"PropertySet")?!1:(h.push({currentValue:u.Name.value,parameter:"PropertySet",pass:!0,requiredValue:this.propertySet}),!0));if(f.length===0){h.push({currentValue:null,parameter:"PropertySet",pass:!1,requiredValue:this.propertySet});continue}for(const u of f){const m=this.getPropertyListName(u);if(!m)continue;const g=u[m];if(!Array.isArray(g)){h.push({currentValue:null,parameter:"BaseName",pass:!1,requiredValue:this.baseName});continue}const _=g.filter(p=>!("value"in p._category&&"value"in p.Name)||this._unsupportedTypes.includes(p._category.value)||!this.evalRequirement(p.Name.value,this.baseName,"BaseName")?!1:(h.push({currentValue:p.Name.value,parameter:"BaseName",pass:!0,requiredValue:this.baseName}),!0));if(_.length===0){h.push({currentValue:null,parameter:"BaseName",pass:!1,requiredValue:this.baseName});continue}for(const p of _)this.evalValue(p,h),this.evalDataType(p,h),this.evalURI()}}}}getPropertyListName(t){let e;return"value"in t._category&&(t._category.value==="IFCPROPERTYSET"&&(e="HasProperties"),t._category.value==="IFCELEMENTQUANTITY"&&(e="Quantities")),e}getValueKey(t){return Object.keys(t).find(e=>/Value/.test(e)||/Values/.test(e))}getTypePsets(t){if(!Array.isArray(t.IsTypedBy))return[];const[e]=t.IsTypedBy;return e&&Array.isArray(e.HasPropertySets)?e.HasPropertySets:[]}async getPsets(t){const e=this.getTypePsets(t);if(!Array.isArray(t.IsDefinedBy))return e;const s=[];for(const i of t.IsDefinedBy){if(!("value"in i.Name))continue;const n=i.Name.value,r=this.getPropertyListName(i);if(!(n&&r))continue;const o=e.find(l=>"value"in l.Name?l.Name.value===n:!1);if(o&&Array.isArray(o.HasProperties)&&Array.isArray(i.HasProperties))for(const l of o.HasProperties){if(!("value"in l.Name))continue;const c=l.Name.value;i.HasProperties.find(d=>"value"in d.Name?d.Name.value===c:!1)||i.HasProperties.push(l)}s.push(i)}return s}evalValue(t,e){const s=this.getValueKey(t),i=t[s];if(!("value"in i))return!1;if(this.value){if(!s)return e==null||e.push({parameter:"Value",currentValue:null,pass:!1,requiredValue:this.value}),!1;const n=structuredClone(this.value);return i.type==="IFCLABEL"&&n.type==="simple"&&(n.parameter=String(n.parameter)),this.evalRequirement(i.value,n,"Value",e)}return s&&typeof i.value=="string"&&i.value.trim()===""?(e==null||e.push({parameter:"Value",currentValue:"",pass:!1,requiredValue:this.value}),!1):!0}evalDataType(t,e){if(!this.dataType)return!0;const s=this.getValueKey(t);if(!(s&&"value"in t[s]))return e==null||e.push({parameter:"DataType",currentValue:null,pass:!1,requiredValue:this.dataType}),!1;const i=t[s];return this.evalRequirement(i.type??null,{type:"simple",parameter:this.dataType},"DataType",e)}evalURI(){return!0}}class oh extends ts{constructor(){super(...arguments),x(this,"_ifcMaterialEntities",[/^IFCMATERIALLAYERSETUSAGE$/,/^IFCMATERIALCONSTITUENTSET$/,/^IFCMATERIAL$/,/^IFCMATERIALLIST$/]),x(this,"facetType","Material"),x(this,"value"),x(this,"uri")}serialize(t){if(!(this.value&&this.uri))return"<material />";const e=me("Value",this.value);let s="";return t==="requirement"&&(s+=`cardinality="${this.cardinality}"`,s+=this.uri?`uri=${this.uri}`:"",s+=this.instructions?`instructions="${this.instructions}"`:""),`<material ${s}>
  ${e}
</material>`}async getEntities(t,e){const s=this._components.get(ct);for(const[i,n]of s.list){if(!t.find(h=>h.test(i)))continue;const o=await n.getItemsOfCategories(this._ifcMaterialEntities),l=Object.values(o).flat();if(l.length===0)continue;const c=await n.getItemsData(l,{relations:{AssociatedTo:{attributes:!0,relations:!1},MaterialConstituents:{attributes:!0,relations:!0},ForLayerSet:{attributes:!0,relations:!0},MaterialLayers:{attributes:!0,relations:!0},Materials:{attributes:!0,relations:!1}}});for(const h of c){if(!("value"in h._localId&&"value"in h._category&&Array.isArray(h.AssociatedTo))||!this.hasValidMaterial(h))continue;const f=h.AssociatedTo.map(u=>"value"in u._localId&&u._localId.value?u._localId.value:null).filter(u=>u!==null);Mt.append(e,i,...f)}}}async test(t,e,s={skipIfFails:!0}){const i=this._components.get(ct);for(const[n,r]of Object.entries(t)){const o=i.list.get(n);if(!o)continue;const l=await o.getItemsData([[...r][0]],{relations:{AssociatedTo:{attributes:!1,relations:!1},HasAssociations:{attributes:!0,relations:!0},MaterialConstituents:{attributes:!0,relations:!0},ForLayerSet:{attributes:!0,relations:!0},MaterialLayers:{attributes:!0,relations:!0},Materials:{attributes:!0,relations:!1}}});for(const c of l){const h=this.getItemChecks(e,n,c,s.skipIfFails);if(h){if(!Array.isArray(c.HasAssociations)){h.push({parameter:null,currentValue:null,requiredValue:this.value,pass:!1});continue}for(const d of c.HasAssociations){if(!this._ifcMaterialEntities.some(u=>"value"in d._category?u.test(d._category.value):!1))continue;if(this.hasValidMaterial(d,h))break}}}}}hasValidMaterial(t,e){let s=!1;if("value"in t._category&&t._category.value==="IFCMATERIAL")this.evalValue(t,e)&&(s=!0);else for(const[i,n]of Object.entries(t))if(["ForLayerSet","MaterialLayers","Material","MaterialConstituents","Materials"].includes(i)&&Array.isArray(n)){for(const r of n)if("value"in r._category&&r._category.value==="IFCMATERIAL"){if(this.evalValue(r,e)){s=!0;break}}else if(this.hasValidMaterial(r)){s=!0;break}}return s}evalValue(t,e){if(!this.value)return e==null||e.push({parameter:null,currentValue:t.Name&&"value"in t.Name?t.Name.value:null,pass:!0}),!0;if(!("value"in t._category&&t._category.value==="IFCMATERIAL"))return null;let s=!1;return t.Name&&"value"in t.Name&&(s=this.evalRequirement(t.Name.value,this.value,"Value",e)),s||(t.Category&&"value"in t.Category&&(s=this.evalRequirement(t.Category.value,this.value,"Value",e)),s)}}class ah extends ts{constructor(t,e){super(t),x(this,"facetType","PartOf"),x(this,"_entityFacet"),x(this,"_entity"),x(this,"relation"),x(this,"cardinality","required"),this._entity=e,this._entityFacet=new Ji(t,e.name),this._entityFacet.predefinedType=e.predefinedType}set entity(t){this._entity=t;const{name:e,predefinedType:s}=t;this._entityFacet=new Ji(this._components,e),this._entityFacet.predefinedType=s}get entity(){return this._entity}serialize(){return""}async getEntities(t,e){}async test(t){}}class lh{constructor(t,e,s){x(this,"name"),x(this,"ifcVersion",new Set),x(this,"identifier",qt.create()),x(this,"description"),x(this,"instructions"),x(this,"requirementsDescription"),x(this,"applicability",new we),x(this,"requirements",new we),x(this,"components"),this.components=t,this.name=e;for(const i of s)this.ifcVersion.add(i)}set(t){const e=t,s=this;for(const n in t){if(n==="identifier")continue;const r=e[n];n in this&&(s[n]=r)}return this.components.get(ch).list.set(this.identifier,this),this}async test(t,e={skipIfFails:!0}){const s=new Nt;if(this.requirements.size===0)return s;const i={},n=[];for(const o of this.applicability)n.push(o.getEntities(t,i));await Promise.all(n);const r=[];for(const o of this.requirements)r.push(o.test(i,s,e));return await Promise.all(r),s}serialize(){const t=`name="${this.name}"`,e=this.identifier?`identifier="${this.identifier}"`:"",s=this.description?`description="${this.description}"`:"",i=this.instructions?`instructions="${this.instructions}"`:"";return`<specification ifcVersion="${[...this.ifcVersion].join(" ")}" ${t} ${e} ${s} ${i}>
      <applicability minOccurs="1" maxOccurs="unbounded">
        ${[...this.applicability].map(r=>r.serialize("applicability")).join(`
`)}
      </applicability>
      <requirements>
        ${[...this.requirements].map(r=>r.serialize("requirement")).join(`
`)}
      </requirements>
    </specification>`}}const ie=a=>{if(!a)return;const t={};if("simpleValue"in a&&(t.type="simple",t.parameter=a.simpleValue),"restriction"in a){const e=a.restriction,s=Object.keys(e);if("pattern"in e&&(t.type="pattern",t.parameter=e.pattern.value),"enumeration"in e){t.type="enumeration";const i=e.enumeration.map(({value:n})=>e.base.includes("string")?String(n):e.base.includes("integer")||e.base.includes("double")?Number(n):n);t.parameter=i}if(s.some(i=>["minInclusive","minExclusive","maxInclusive","maxExclusive"].includes(i))){t.type="bounds";const i={},n=s.find(o=>o.includes("min")),r=s.find(o=>o.includes("max"));n&&(i.minInclusive=n==="minInclusive",i.min=e[n].value),r&&(i.maxInclusive=r==="maxInclusive",i.max=e[r].value),t.parameter=i}if(s.some(i=>["minLength","length","maxLength"].includes(i))){t.type="length";const i={};e.length!==void 0&&(i.length=e.length.value),e.minLength!==void 0&&(i.min=e.minLength.value),e.maxLength!==void 0&&(i.max=e.maxLength.value),t.parameter=i}}if(t.parameter!==void 0)return t},ur=(a,t)=>{const e=[];for(const s of t){const i=s.name,n=ie(i);if(!n)continue;const r=new Ji(a,n);s.cardinality&&(r.cardinality=s.cardinality),r.predefinedType=ie(s.predefinedType),r.instructions=s.instructions,e.push(r)}return e},dr=(a,t)=>{const e=[];for(const s of t){const i=s.name,n=ie(i);if(!n)continue;const r=new ih(a,n);s.cardinality&&(r.cardinality=s.cardinality),r.value=ie(s.value),r.instructions=s.instructions,e.push(r)}return e},fr=(a,t)=>{const e=[];for(const s of t){const i=new oh(a);s.cardinality&&(i.cardinality=s.cardinality);const n=ie(s.value);(n==null?void 0:n.type)==="enumeration"&&Array.isArray(n.parameter)&&(n.parameter=n.parameter.map(String)),i.value=n,i.uri=s.uri,i.instructions=s.instructions,e.push(i)}return e},pr=(a,t)=>{const e=[];for(const s of t){const i=s.propertySet,n=s.baseName,r=ie(i),o=ie(n);if(!(o&&r))continue;const l=new rh(a,r,o);s.cardinality&&(l.cardinality=s.cardinality);const c=ie(s.value);l.value=c,l.dataType=s.dataType,l.uri=s.uri,l.instructions=s.instructions,e.push(l)}return e},mr=(a,t)=>{const e=[];for(const s of t){const i=s.system,n=ie(i);if(!n)continue;const r=new nh(a,n);s.cardinality&&(r.cardinality=s.cardinality);const o=ie(s.value);(o==null?void 0:o.type)==="simple"&&(o.parameter=String(o.parameter)),(o==null?void 0:o.type)==="enumeration"&&Array.isArray(o.parameter)&&(o.parameter=o.parameter.map(String)),r.value=o,r.uri=s.uri,r.instructions=s.instructions,e.push(r)}return e},gr=(a,t)=>{const e=[];for(const s of t){const i=ie(s.entity.name);if(!i)continue;const n=ie(s.entity.predefinedType),r=new ah(a,{name:i,predefinedType:n});r.relation=s.relation,s.cardinality&&(r.cardinality=s.cardinality),r.instructions=s.instructions,e.push(r)}return e},gn=class tn extends Dt{constructor(t){super(t),x(this,"enabled",!0),x(this,"IDSInfo"),x(this,"list",new Nt),t.add(tn.uuid,this)}getModelIdMap(t){const e={},s={};for(const[i,n]of t){const o=[...n].filter(([,h])=>h.pass).map(([h])=>h);Mt.append(e,i,...o);const c=[...n].filter(([,h])=>!h.pass).map(([h])=>h);Mt.append(s,i,...c)}return{pass:e,fail:s}}create(t,e,s){const i=new lh(this.components,t,e);return s&&(i.identifier=s),this.list.set(i.identifier,i),i}load(t){const e=[],s=tn.xmlParser.parse(t).ids,{specifications:i,info:n}=s;if(this.IDSInfo={...n},i&&i.specification){const r=Array.isArray(i.specification)?i.specification:[i.specification];for(const o of r){const{name:l,ifcVersion:c,description:h,instructions:d,identifier:f}=o;if(!(l&&c))continue;const u=[],m=[],{applicability:g,requirements:_}=o;if(g){const{maxOccurs:b,...C}=g,T=Array.isArray(C)?C:[C];for(const S of T)for(const A in S){const M=Array.isArray(S[A])?S[A]:[S[A]];if(A==="entity"){const P=ur(this.components,M);u.push(...P)}if(A==="attribute"){const P=dr(this.components,M);u.push(...P)}if(A==="material"){const P=fr(this.components,M);u.push(...P)}if(A==="classification"){const P=mr(this.components,M);u.push(...P)}if(A==="property"){const P=pr(this.components,M);u.push(...P)}if(A==="partOf"){const P=gr(this.components,M);u.push(...P)}}}let p;if(_){const{maxOccurs:b,...C}=_;p=_.description;const T=Array.isArray(C)?C:[C];for(const S of T)for(const A in S){const M=Array.isArray(S[A])?S[A]:[S[A]];if(A==="entity"){const P=ur(this.components,M);m.push(...P)}if(A==="attribute"){const P=dr(this.components,M);m.push(...P)}if(A==="material"){const P=fr(this.components,M);m.push(...P)}if(A==="classification"){const P=mr(this.components,M);m.push(...P)}if(A==="property"){const P=pr(this.components,M);m.push(...P)}if(A==="partOf"){const P=gr(this.components,M);m.push(...P)}}}const y=this.create(l,c.split(/\s+/),f);y.description=h,y.instructions=d,y.requirementsDescription=p,y.applicability.add(...u),y.requirements.add(...m),e.push(y)}}return e}export(t,e=this.list.values()){const s=e??this.list;return`<ids xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://standards.buildingsmart.org/IDS http://standards.buildingsmart.org/IDS/1.0/ids.xsd" xmlns:ids="http://standards.buildingsmart.org/IDS">
  <!-- Made with That Open Engine ${ho.release} (https://github.com/thatopen/engine_components) -->
  <info>
    <title>${t.title}</title>
    ${t.copyright?`<copyright>${t.copyright}</copyright>`:""}
    ${t.version?`<version>${t.version}</version>`:""}
    ${t.description?`<description>${t.description}</description>`:""}
    ${t.author?`<author>${t.author}</author>`:""}
    ${t.date?`<date>${t.date.toISOString().split("T")[0]}</date>`:""}
    ${t.purpose?`<purpose>${t.purpose}</purpose>`:""}
    ${t.milestone?`<milestone>${t.milestone}</milestone>`:""}
  </info>
  <specifications>
    ${[...s].map(n=>n.serialize()).join(`
`)}
  </specifications>
</ids>`}};x(gn,"uuid","9f0b9f78-9b2e-481a-b766-2fbfd01f342c");x(gn,"xmlParser",new di.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));let ch=gn;const wo=class vo extends Dt{constructor(t){super(t),x(this,"enabled",!0),t.add(vo.uuid,this)}static distanceFromPointToLine(t,e,s,i=!1){const n=new le,r=new V;return n.set(e,s),n.closestPointToPoint(t,i,r),r.distanceTo(t)}round(t){t.x=Math.trunc(t.x*1e3)/1e3,t.y=Math.trunc(t.y*1e3)/1e3,t.z=Math.trunc(t.z*1e3)/1e3}async getVolumeFromFragments(t){return console.warn("getVolumeFromFragments is deprecated. Use getItemsVolume instead."),this.getItemsVolume(t)}async getItemsVolume(t){let e=0;const s=this.components.get(ct);for(const[i,n]of Object.entries(t)){const r=s.list.get(i);r&&(e+=await r.getItemsVolume([...n]))}return e}static convertUnits(t,e,s,i=2){const n={m:1,cm:.01,mm:.001,km:1e3,m2:1,cm2:1e-4,mm2:1e-6,km2:1e6,m3:1,cm3:1e-6,mm3:1e-9,km3:1e9};if(!n[e]||!n[s])throw new Error("Invalid units provided for conversion.");if(!Number.isInteger(i)||i<0||i>5)throw new Error("Precision must be an integer between 0 and 5.");let r=n[e]/n[s];const o=t*r,l=10**i;return Math.round(o*l)/l}};x(wo,"uuid","267ca032-672f-4cb0-afa9-d24e904f39d6");let bh=wo;class hh extends Ss{constructor(t=document.createElement("div")){super(),this.isCSS2DObject=!0,this.element=t,this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.center=new Wt(.5,.5),this.addEventListener("removed",function(){this.traverse(function(e){e.element instanceof e.element.ownerDocument.defaultView.Element&&e.element.parentNode!==null&&e.element.remove()})})}copy(t,e){return super.copy(t,e),this.element=t.element.cloneNode(!0),this.center=t.center,this}}const qe=new V,_r=new Ot,yr=new Ot,wr=new V,vr=new V;class uh{constructor(t={}){const e=this;let s,i,n,r;const o={objects:new WeakMap},l=t.element!==void 0?t.element:document.createElement("div");l.style.overflow="hidden",this.domElement=l,this.getSize=function(){return{width:s,height:i}},this.render=function(m,g){m.matrixWorldAutoUpdate===!0&&m.updateMatrixWorld(),g.parent===null&&g.matrixWorldAutoUpdate===!0&&g.updateMatrixWorld(),_r.copy(g.matrixWorldInverse),yr.multiplyMatrices(g.projectionMatrix,_r),h(m,m,g),u(m)},this.setSize=function(m,g){s=m,i=g,n=s/2,r=i/2,l.style.width=m+"px",l.style.height=g+"px"};function c(m){m.isCSS2DObject&&(m.element.style.display="none");for(let g=0,_=m.children.length;g<_;g++)c(m.children[g])}function h(m,g,_){if(m.visible===!1){c(m);return}if(m.isCSS2DObject){qe.setFromMatrixPosition(m.matrixWorld),qe.applyMatrix4(yr);const p=qe.z>=-1&&qe.z<=1&&m.layers.test(_.layers)===!0,y=m.element;y.style.display=p===!0?"":"none",p===!0&&(m.onBeforeRender(e,g,_),y.style.transform="translate("+-100*m.center.x+"%,"+-100*m.center.y+"%)translate("+(qe.x*n+n)+"px,"+(-qe.y*r+r)+"px)",y.parentNode!==l&&l.appendChild(y),m.onAfterRender(e,g,_));const b={distanceToCameraSquared:d(_,m)};o.objects.set(m,b)}for(let p=0,y=m.children.length;p<y;p++)h(m.children[p],g,_)}function d(m,g){return wr.setFromMatrixPosition(m.matrixWorld),vr.setFromMatrixPosition(g.matrixWorld),wr.distanceToSquared(vr)}function f(m){const g=[];return m.traverseVisible(function(_){_.isCSS2DObject&&g.push(_)}),g}function u(m){const g=f(m).sort(function(p,y){if(p.renderOrder!==y.renderOrder)return y.renderOrder-p.renderOrder;const b=o.objects.get(p).distanceToCameraSquared,C=o.objects.get(y).distanceToCameraSquared;return b-C}),_=g.length;for(let p=0,y=g.length;p<y;p++)g[p].element.style.zIndex=_-p}}}class br{constructor(t,e,s){Pt(this,"three");Pt(this,"world");Pt(this,"wasVisible",!0);Pt(this,"onDisposed",new it);this.world=t;let i;if(e)i=e;else{i=document.createElement("div");const r="6px";i.style.color="white",i.style.height=r,i.style.width=r,i.style.borderRadius="50%",i.style.border="2px solid rgb(122, 75, 209)",i.style.zIndex="-20"}this.three=new hh(i),(s||t.scene.three).add(this.three),this.visible=!0}set visible(t){this.three.visible=t,this.wasVisible=t}get visible(){return this.three.visible}toggleVisibility(){this.visible=!this.visible}notDisplay(){this.visible=!1}dispose(){this.three.removeFromParent(),this.three.element.remove(),this.onDisposed.trigger(),this.onDisposed.reset()}}class xh extends Al{constructor(e,s,i){super(e,s,i);Pt(this,"three2D",new uh);this.onAfterUpdate.add(()=>{if(this.onBeforeUpdate.trigger(this),!this.enabled||!this.currentWorld)return;const n=this.currentWorld.scene.three,r=this.currentWorld.camera.three;n instanceof Er&&this.three2D.render(n,r)}),this.onDisposed.add(()=>{this.three2D.domElement.remove()}),this.onResize.add(({x:n,y:r})=>{this.three2D.setSize(n,r)}),this.setupHtmlRenderer(),this.resize()}setupHtmlRenderer(){this.three2D.domElement.style.position="absolute",this.three2D.domElement.style.top="0px",this.three2D.domElement.style.pointerEvents="none",this.container&&(this.container.appendChild(this.three2D.domElement),this.container.style.position="relative")}}const Rt=class Rt{constructor(t){Pt(this,"onDisposed",new it);Pt(this,"marker",null);Pt(this,"world",null);Pt(this,"mode",0);Pt(this,"maxDistance",1);Pt(this,"_enabled",!1);Pt(this,"_components");Pt(this,"_preview",document.createElement("div"));Pt(this,"_pointerVisible",!1);Pt(this,"_intersectionFound",!1);this._components=t;for(const e in Rt.baseSnappingStyle){const s=Rt.baseSnappingStyle[e];this._preview.style[e]=s}this._preview.style.zIndex="999",this._preview.style.pointerEvents="none",this._preview.style.position="fixed",this._preview.style.top="0",this._preview.style.left="0"}set enabled(t){this._enabled=t,this.marker&&(this.marker.visible=t),t&&this.get()}get enabled(){return this._enabled}dispose(){this.marker&&this.marker.dispose()}async get(t){return this.mode===1?this.getSynchronous(t):this.getDefault(t)}async getSynchronous(t){const e=(t==null?void 0:t.world)??this.world;if(!e)throw new Error("GraphicVertexPicker: a world is need to get a casting result.");const i=this._components.get(Ke).get(e);let n=null;if(this.mode===0?n=await i.castRay({snappingClasses:t==null?void 0:t.snappingClasses}):this.mode===1&&(n=await i.castRayToObjects()),this._intersectionFound=!!n,n){const{point:r}=n;if(!this.marker){const l=document.createElement("div");this.marker=new br(e,l)}if(this.marker.world!==e&&(this.marker.world=e,this.marker.three.removeFromParent(),e.scene.three.add(this.marker.three)),this.hidePointer(),this.marker.visible=!0,!!(t!=null&&t.snappingClasses)){const l=(t==null?void 0:t.snappingClasses)||[];let c=ne.FACE;l.includes(ne.POINT)?c=ne.POINT:l.includes(ne.LINE)&&(c=ne.LINE);let h=!1;if(c!==ne.FACE&&(h=this.applySnapping(n,c)),!h)Object.assign(this.marker.three.element.style,Rt.baseSnappingStyle);else{const d=Rt.snappingStyles[c]??Rt.baseSnappingStyle;Object.assign(this.marker.three.element.style,d)}this.marker.three.position.copy(r)}else Object.assign(this.marker.three.element.style,Rt.baseSnappingStyle)}else this.marker&&(this.marker.visible=!1);return n}async getDefault(t){const e=(t==null?void 0:t.world)??this.world;if(!e)throw new Error("GraphicVertexPicker: a world is need to get a casting result.");const n=await this._components.get(Ke).get(e).castRay({snappingClasses:t==null?void 0:t.snappingClasses});if(this._intersectionFound=!!n,n){const{point:r}=n;if(!this.marker){const o=document.createElement("div");this.marker=new br(e,o)}if(this.marker.world!==e&&(this.marker.world=e,this.marker.three.removeFromParent(),e.scene.three.add(this.marker.three)),this.hidePointer(),this.marker.visible=!0,this.marker.three.position.copy(r),"snappingClass"in n&&typeof n.snappingClass=="number"&&(n.snappingClass===0||n.snappingClass===1||n.snappingClass===2)){const o=Rt.snappingStyles[n.snappingClass]??Rt.baseSnappingStyle;Object.assign(this.marker.three.element.style,o)}else Object.assign(this.marker.three.element.style,Rt.baseSnappingStyle)}else this.marker&&(this.marker.visible=!1);return n}updatePointer(){if(!this.world||!this.marker)return;if(this.mode===1&&this._intersectionFound){this.hidePointer();return}this.showPointer(),this.marker.visible&&(this.marker.visible=!1);const s=this._components.get(Ke).get(this.world).mouse.rawPosition;this._preview.style.transform=`translate(-50%, -50%) translate(${s.x}px, ${s.y}px)`}showPointer(){var e;if(!this.world||this._pointerVisible)return;this._pointerVisible=!0,(e=this.world.renderer.three.domElement.parentElement)==null||e.appendChild(this._preview)}hidePointer(){var e;if(!this.world||!this._pointerVisible)return;this._pointerVisible=!1,(e=this.world.renderer.three.domElement.parentElement)==null||e.removeChild(this._preview)}applySnapping(t,e){if(e===ne.FACE)return!0;const s=t.object;if(!t.face||!s||!s.geometry||!s.geometry.index||!s.geometry.attributes||!s.geometry.attributes.position)return!1;const i=t.object.matrixWorld,r=s.geometry.attributes.position.array,o=t.point,l=t.face.a,c=t.face.b,h=t.face.c,d=new V(r[l*3],r[l*3+1],r[l*3+2]).applyMatrix4(i),f=new V(r[c*3],r[c*3+1],r[c*3+2]).applyMatrix4(i),u=new V(r[h*3],r[h*3+1],r[h*3+2]).applyMatrix4(i);if(t.facePoints=[d.x,d.y,d.z,f.x,f.y,f.z,u.x,u.y,u.z],e===ne.LINE){const b=[[d,f],[f,u],[u,d]],C=new V,T=new V,S=new le;let A=Number.MAX_SAFE_INTEGER,M=!1;const P=this.maxDistance*this.maxDistance;for(const[N,H]of b){S.set(N,H),S.closestPointToPoint(o,!0,C);const E=o.distanceToSquared(C);E<P&&E<A&&(t.snappedEdgeP1=N,t.snappedEdgeP2=H,A=E,T.copy(C),M=!0)}return M?(t.point.copy(T),!0):!1}const m=[d,f,u],g=new V;let _=Number.MAX_SAFE_INTEGER,p=!1;const y=this.maxDistance*this.maxDistance;for(let b=0;b<m.length;b++){const C=m[b],T=o.distanceToSquared(C);T<y&&T<_&&(_=T,g.copy(C),p=!0)}return p?(t.point.copy(g),!0):!1}};Pt(Rt,"baseSnappingStyle",{height:"6px",width:"6px",borderRadius:"100%",borderWidth:"2px",borderColor:"rgb(122, 75, 209)",borderStyle:"solid",zIndex:"-20"}),Pt(Rt,"snappingStyles",{[ne.FACE]:{...Rt.baseSnappingStyle},[ne.POINT]:{...Rt.baseSnappingStyle,borderColor:"#e25959",borderRadius:"0"},[ne.LINE]:{...Rt.baseSnappingStyle,borderColor:"#2d2d2d",borderRadius:"0"}});let xr=Rt;export{$r as B,ho as C,hi as D,it as E,ct as F,xr as G,Ts as I,Mt as M,uo as O,Ke as R,wh as S,sr as T,qt as U,sh as V,eo as W,bh as a,br as b,Dt as c,vh as d,Sl as e,gh as f,yh as g,Ge as h,xh as i,hh as j,Al as k,kt as l,ye as m,_h as n,As as o};
