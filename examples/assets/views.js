var G=Object.defineProperty;var J=(o,t,e)=>t in o?G(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var n=(o,t,e)=>(J(o,typeof t!="symbol"?t+"":t,e),e);import{P as b,C as O,aw as K,ax as z,Y as Q,b as P,u as X,V as L,f as $,a as Z,J as ee}from"./index-BVinSk0X.js";import{E as S,U as te,O as T,D as se,d as ae,F as E,e as re,C as ne,W as oe,S as le,a as ie,R as de}from"./index-DBG1qVuX.js";class B{constructor(t,e){n(this,"_components");n(this,"_cameraOffset",10);n(this,"_planeHelper");n(this,"_farPlaneHelper");n(this,"_cameraHelper");n(this,"onStateChanged",new S);n(this,"onUpdated",new S);n(this,"onDisposed",new S);n(this,"camera");n(this,"plane",new b);n(this,"farPlane",new b);n(this,"id",te.create());n(this,"_open",!1);n(this,"_range",f.defaultRange);n(this,"_world",null);n(this,"_helpersVisible",!1);n(this,"_planesEnabled",!1);this._components=t,this.camera=new T(this._components);const{threeOrtho:s}=this.camera;if(e!=null&&e.id&&(this.id=e.id),e!=null&&e.normal&&(e!=null&&e.point)){const{normal:a,point:r}=e;this.plane.setFromNormalAndCoplanarPoint(a,r)}this._cameraHelper=new K(s),this._planeHelper=new z(this.plane,50),this._farPlaneHelper=new z(this.farPlane,50),this.farPlaneHelperColor=new O("blue"),this.update()}get _planeNormalOpposite(){return this.plane.normal.clone().negate()}get _planePosition(){return this.plane.normal.clone().multiplyScalar(-this.plane.constant)}get _cameraPosition(){return this._planePosition.addScaledVector(this._planeNormalOpposite,this._cameraOffset)}set open(t){this._open=t,this.onStateChanged.trigger(["open"])}get open(){return this._open}set planeHelperColor(t){!Array.isArray(this._planeHelper.material)&&"color"in this._planeHelper.material&&this._planeHelper.material.color instanceof O&&(this._planeHelper.material.color=t)}set farPlaneHelperColor(t){!Array.isArray(this._farPlaneHelper.material)&&"color"in this._farPlaneHelper.material&&this._farPlaneHelper.material.color instanceof O&&(this._farPlaneHelper.material.color=t)}set range(t){this._range=t,this.update()}get range(){return this._range}set distance(t){this.plane.constant=t,this.update()}get distance(){return this.plane.constant}set world(t){this._world=t,this.camera.currentWorld=t,t&&(this.camera.projection.set("Orthographic"),this.camera.set("Plan"),this.camera.controls.dollySpeed=6,this.camera.controls.restThreshold=.005,this.update())}get world(){return this._world}set helpersVisible(t){if(!t){this._helpersVisible=t,this._planeHelper.removeFromParent(),this._farPlaneHelper.removeFromParent(),this._cameraHelper.removeFromParent();return}this.world&&(this._helpersVisible=t,this.world.scene.three.add(this._planeHelper,this._farPlaneHelper))}get helpersVisible(){return this._helpersVisible}set planesEnabled(t){const{world:e}=this;if(!e)return;const{renderer:s}=e;s&&(s.setPlane(t,this.plane),s.setPlane(t,this.farPlane),this._planesEnabled=t)}get planesEnabled(){return this._planesEnabled}dispose(){this.helpersVisible=!1;const t=this._components.get(se);t.destroy(this._planeHelper),t.destroy(this._farPlaneHelper),t.destroy(this._cameraHelper),this.camera.dispose(),this.onDisposed.trigger()}update(){if(this.world){const t=this._cameraPosition,e=this._planePosition;this.camera.controls.setLookAt(t.x,t.y,t.z,e.x,e.y,e.z,!1)}this.farPlane.normal.copy(this._planeNormalOpposite),this.farPlane.constant=this.range-this.plane.constant,this.onUpdated.trigger()}flip(){this.plane.normal.negate(),this.update()}}const H=class H extends ae{constructor(e){super(e);n(this,"list",new Q);n(this,"enabled",!0);n(this,"world",null);n(this,"_fragmentsUpdateEvent",()=>{this.components.get(E).core.update(!0)});e.add(H.uuid,this),this.setupEvents()}get hasOpenViews(){return[...this.list.values()].some(e=>e.open)}setupEvents(){this.list.onBeforeDelete.add(({key:e,value:s})=>{s.open&&this.close(e),s.dispose()})}create(e,s,a){const r=new B(this.components,{id:a==null?void 0:a.id,normal:e,point:s});return r.world=(a==null?void 0:a.world)??this.world,this.list.set(r.id,r),r}createFromPlane(e,s){const a=new B(this.components,{id:s==null?void 0:s.id});return a.plane.copy(e),a.update(),a.world=(s==null?void 0:s.world)??this.world,this.list.set(a.id,a),a}async createFromIfcStoreys(e){const s=[],a=this.components.get(E),r=(e==null?void 0:e.offset)===void 0?.25:e.offset;for(const[d,u]of a.list){if(e&&e.modelIds&&!e.modelIds.some(h=>h.test(d)))continue;const l=Object.values(await u.getItemsOfCategories([/BUILDINGSTOREY/])).flat();if(l.length===0)continue;const w=await u.getItemsData(l),[,c]=await u.getCoordinates(),v=new P(0,-1,0);for(const h of w){if(!("value"in h.Name&&"value"in h.Elevation))continue;const{value:V}=h.Name;if(e!=null&&e.storeyNames&&!e.storeyNames.some(N=>N.test(V)))continue;const I=h.Elevation.value+c+r,g=new b(v,I),F=this.createFromPlane(g,{id:V,world:e==null?void 0:e.world});s.push(F)}}return s}createElevations(e){const s=[],a=this.components.get(E),r=(e==null?void 0:e.combine)===void 0?!1:e.combine,d=(e==null?void 0:e.namingCallback)??(l=>({front:`${r?"Front":`${l}: Front`}`,back:`${r?"Back":`${l}: Back`}`,left:`${r?"Left":`${l}: Left`}`,right:`${r?"Right":`${l}: Right`}`}));let u=[];for(const[l,w]of a.list)e&&e.modelIds&&!e.modelIds.some(c=>c.test(l))||u.push({id:l,box:w.box});if(r){const l=this.components.get(re);l.list.clear(),l.list.add(...u.map(c=>c.box)),u=[{id:"combined",box:l.get()}]}for(const{id:l,box:w}of u){const{min:c,max:v}=w,h=Math.abs(v.x-c.x),V=Math.abs(v.z-c.z),I=new P;w.getCenter(I);const g=new b(new P(0,0,-1),v.z),F=new b(new P(0,0,1),-c.z),N=new b(new P(-1,0,0),v.x),j=new b(new P(1,0,0),-c.x),{front:M,back:W,left:Y,right:q}=d(l),D=this.createFromPlane(g,{id:M,world:e==null?void 0:e.world});D.range=V;const R=this.createFromPlane(F,{id:W,world:e==null?void 0:e.world});R.range=V;const U=this.createFromPlane(N,{id:Y,world:e==null?void 0:e.world});U.range=h;const A=this.createFromPlane(j,{id:q,world:e==null?void 0:e.world});A.range=h,s.push(D,R,U,A)}return s}open(e){const s=this.list.get(e);if(!s)throw new Error(`Views: the view with id ${e} doesn't exist.`);if(s.open)return;const{world:a}=s;if(!a)throw new Error(`Views: no world found for view with id ${e}.`);const{renderer:r}=a;if(!r)throw new Error(`Views: no renderer found for world with id ${a.uuid}.`);for(const[,d]of this.list)d.world===a&&this.close(d.id);r.setPlane(!0,s.plane),r.setPlane(!0,s.farPlane),s.camera.controls.addEventListener("rest",this._fragmentsUpdateEvent),a.camera=s.camera,s.open=!0}close(e){let s;if(e?s=this.list.get(e):s=[...this.list.values()].find(d=>d.open),e&&!s)throw new Error(`Views: the view with id ${e} doesn't exist.`);if(!s||!s.open)return;const{world:a}=s;if(!a)throw new Error(`Views: no world found for view with id ${e}.`);const{renderer:r}=a;if(!r)throw new Error(`Views: no renderer found for world with id ${a.uuid}.`);r.setPlane(!1,s.plane),r.setPlane(!1,s.farPlane),s.camera.controls.removeEventListener("rest",this._fragmentsUpdateEvent),a.useDefaultCamera(),s.open=!1}};n(H,"uuid","fb22f1f5-6598-4664-a11d-de8963ae420f"),n(H,"defaultRange",15);let f=H;const m=new ne,ce=m.get(oe),i=ce.create();i.scene=new le(m);i.scene.setup();i.scene.three.background=null;const pe=document.getElementById("container");i.renderer=new ie(m,pe);i.camera=new T(m);await i.camera.controls.setLookAt(78,20,-2.2,26,-4,25);m.init();const me="https://thatopen.github.io/engine_fragment/resources/worker.mjs",_=m.get(E);_.init(me);i.camera.controls.addEventListener("rest",()=>_.core.update(!0));i.onCameraChanged.add(o=>{for(const[,t]of _.list)t.useCamera(o.three);_.core.update(!0)});_.list.onItemSet.add(({value:o})=>{o.useCamera(i.camera.three),i.scene.three.add(o.object),_.core.update(!0)});const he=["https://thatopen.github.io/engine_components/resources/frags/school_arq.frag","https://thatopen.github.io/engine_components/resources/frags/school_str.frag"];await Promise.all(he.map(async o=>{var a;const t=(a=o.split("/").pop())==null?void 0:a.split(".").shift();if(!t)return null;const s=await(await fetch(o)).arrayBuffer();return _.core.load(s,{modelId:t})}));const p=m.get(f);f.defaultRange=100;p.world=i;await p.createFromIfcStoreys({modelIds:[/arq/]});p.createElevations({combine:!0});const ue=m.get(de),we=ue.get(i);window.addEventListener("dblclick",async()=>{const o=await we.castRay();if(!o)return;const{normal:t,point:e}=o;if(!(t&&e))return;const s=t.clone().negate(),a=p.create(s,e.addScaledVector(t,1),{id:`View - ${p.list.size+1}`,world:i});a.range=10,a.helpersVisible=!0});X.init();const be=o=>{const{components:t}=o,e=t.get(f);return $`<bim-table ${ee(a=>{if(!a)return;const r=a;r.data=[...e.list.keys()].map(d=>({data:{Name:d,Actions:""}}))})}></bim-table>`},[C,fe]=L.create(be,{components:m});C.headersHidden=!0;C.noIndentation=!0;C.columns=["Name",{name:"Actions",width:"auto"}];C.dataTransform={Actions:(o,t)=>{const{Name:e}=t;if(!e)return o;const s=m.get(f);return s.list.get(e)?$`
      <bim-button label-hidden icon="solar:cursor-bold" label="Open" @click=${()=>{s.open(e)}}></bim-button>
      <bim-button label-hidden icon="material-symbols:delete" label="Remove" @click=${()=>{s.list.delete(e)}}></bim-button>
    `:o}};const k=()=>fe();p.list.onItemSet.add(k);p.list.onItemDeleted.add(k);p.list.onItemUpdated.add(k);p.list.onCleared.add(k);const x=L.create(()=>$`
    <bim-panel active label="2D Views Tutorial" class="options-menu">
      <bim-panel-section  label="Info">
        <bim-label style="width: 16rem; white-space: normal;" icon="noto-v1:light-bulb">Tip: Go inside the building and double click a wall to create a section</bim-label>
      </bim-panel-section>
      <bim-panel-section  label="Views">
        <bim-button label="Close Active 2D View" @click=${()=>p.close()}></bim-button>
        ${C}
      </bim-panel-section>
    </bim-panel>
  `);document.body.append(x);const _e=L.create(()=>$`
      <bim-button class="phone-menu-toggler" icon="solar:settings-bold"
        @click="${()=>{x.classList.contains("options-menu-visible")?x.classList.remove("options-menu-visible"):x.classList.add("options-menu-visible")}}">
      </bim-button>
    `);document.body.append(_e);const y=new Z;y.showPanel(2);document.body.append(y.dom);y.dom.style.left="0px";y.dom.style.zIndex="unset";i.renderer.onBeforeUpdate.add(()=>y.begin());i.renderer.onAfterUpdate.add(()=>y.end());
