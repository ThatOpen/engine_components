var G=Object.defineProperty;var J=(r,t,e)=>t in r?G(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var o=(r,t,e)=>(J(r,typeof t!="symbol"?t+"":t,e),e);import{P as f,C as L,aw as K,ax as B,Y as Q,V as P,l as X,c as N,a as g,b as Z,t as ee}from"./index-BET5fVdQ.js";import{E as U,U as te,O as T,D as se,d as ae,F as E,e as re,C as ne,W as oe,S as le,a as ie,R as de}from"./index-B31d80Z1.js";class z{constructor(t,e){o(this,"_components");o(this,"_cameraOffset",10);o(this,"_planeHelper");o(this,"_farPlaneHelper");o(this,"_cameraHelper");o(this,"onStateChanged",new U);o(this,"onUpdated",new U);o(this,"onDisposed",new U);o(this,"camera");o(this,"plane",new f);o(this,"farPlane",new f);o(this,"id",te.create());o(this,"_open",!1);o(this,"_range",_.defaultRange);o(this,"_world",null);o(this,"_helpersVisible",!1);o(this,"_planesEnabled",!1);this._components=t,this.camera=new T(this._components);const{threeOrtho:s}=this.camera;if(e!=null&&e.id&&(this.id=e.id),e!=null&&e.normal&&(e!=null&&e.point)){const{normal:a,point:n}=e;this.plane.setFromNormalAndCoplanarPoint(a,n)}this._cameraHelper=new K(s),this._planeHelper=new B(this.plane,50),this._farPlaneHelper=new B(this.farPlane,50),this.farPlaneHelperColor=new L("blue"),this.update()}get _planeNormalOpposite(){return this.plane.normal.clone().negate()}get _planePosition(){return this.plane.normal.clone().multiplyScalar(-this.plane.constant)}get _cameraPosition(){return this._planePosition.addScaledVector(this._planeNormalOpposite,this._cameraOffset)}set open(t){this._open=t,this.onStateChanged.trigger(["open"])}get open(){return this._open}set planeHelperColor(t){!Array.isArray(this._planeHelper.material)&&"color"in this._planeHelper.material&&this._planeHelper.material.color instanceof L&&(this._planeHelper.material.color=t)}set farPlaneHelperColor(t){!Array.isArray(this._farPlaneHelper.material)&&"color"in this._farPlaneHelper.material&&this._farPlaneHelper.material.color instanceof L&&(this._farPlaneHelper.material.color=t)}set range(t){this._range=t,this.update()}get range(){return this._range}set distance(t){this.plane.constant=t,this.update()}get distance(){return this.plane.constant}set world(t){this._world=t,this.camera.currentWorld=t,t&&(this.camera.projection.set("Orthographic"),this.camera.set("Plan"),this.camera.controls.dollySpeed=6,this.camera.controls.restThreshold=.005,this.update())}get world(){return this._world}set helpersVisible(t){if(!t){this._helpersVisible=t,this._planeHelper.removeFromParent(),this._farPlaneHelper.removeFromParent(),this._cameraHelper.removeFromParent();return}this.world&&(this._helpersVisible=t,this.world.scene.three.add(this._planeHelper,this._farPlaneHelper))}get helpersVisible(){return this._helpersVisible}set planesEnabled(t){const{world:e}=this;if(!e)return;const{renderer:s}=e;s&&(s.setPlane(t,this.plane),s.setPlane(t,this.farPlane),this._planesEnabled=t)}get planesEnabled(){return this._planesEnabled}dispose(){this.helpersVisible=!1;const t=this._components.get(se);t.destroy(this._planeHelper),t.destroy(this._farPlaneHelper),t.destroy(this._cameraHelper),this.camera.dispose(),this.onDisposed.trigger()}update(){if(this.world){const t=this._cameraPosition,e=this._planePosition;this.camera.controls.setLookAt(t.x,t.y,t.z,e.x,e.y,e.z,!1)}this.farPlane.normal.copy(this._planeNormalOpposite),this.farPlane.constant=this.range-this.plane.constant,this.onUpdated.trigger()}flip(){this.plane.normal.negate(),this.update()}}const H=class H extends ae{constructor(e){super(e);o(this,"list",new Q);o(this,"enabled",!0);o(this,"world",null);o(this,"_fragmentsUpdateEvent",()=>{this.components.get(E).core.update(!0)});e.add(H.uuid,this),this.setupEvents()}get hasOpenViews(){return[...this.list.values()].some(e=>e.open)}setupEvents(){this.list.onBeforeDelete.add(({key:e,value:s})=>{s.open&&this.close(e),s.dispose()})}create(e,s,a){const n=new z(this.components,{id:a==null?void 0:a.id,normal:e,point:s});return n.world=(a==null?void 0:a.world)??this.world,this.list.set(n.id,n),n}createFromPlane(e,s){const a=new z(this.components,{id:s==null?void 0:s.id});return a.plane.copy(e),a.update(),a.world=(s==null?void 0:s.world)??this.world,this.list.set(a.id,a),a}async createFromIfcStoreys(e){const s=[],a=this.components.get(E),n=(e==null?void 0:e.offset)===void 0?.25:e.offset;for(const[d,u]of a.list){if(e&&e.modelIds&&!e.modelIds.some(h=>h.test(d)))continue;const l=Object.values(await u.getItemsOfCategories([/BUILDINGSTOREY/])).flat();if(l.length===0)continue;const b=await u.getItemsData(l),[,c]=await u.getCoordinates(),v=new P(0,-1,0);for(const h of b){if(!("value"in h.Name&&"value"in h.Elevation))continue;const{value:C}=h.Name;if(e!=null&&e.storeyNames&&!e.storeyNames.some(O=>O.test(C)))continue;const F=h.Elevation.value+c+n,I=new f(v,F),$=this.createFromPlane(I,{id:C,world:e==null?void 0:e.world});s.push($)}}return s}createElevations(e){const s=[],a=this.components.get(E),n=(e==null?void 0:e.combine)===void 0?!1:e.combine,d=(e==null?void 0:e.namingCallback)??(l=>({front:`${n?"Front":`${l}: Front`}`,back:`${n?"Back":`${l}: Back`}`,left:`${n?"Left":`${l}: Left`}`,right:`${n?"Right":`${l}: Right`}`}));let u=[];for(const[l,b]of a.list)e&&e.modelIds&&!e.modelIds.some(c=>c.test(l))||u.push({id:l,box:b.box});if(n){const l=this.components.get(re);l.list.clear(),l.list.add(...u.map(c=>c.box)),u=[{id:"combined",box:l.get()}]}for(const{id:l,box:b}of u){const{min:c,max:v}=b,h=Math.abs(v.x-c.x),C=Math.abs(v.z-c.z),F=new P;b.getCenter(F);const I=new f(new P(0,0,-1),v.z),$=new f(new P(0,0,1),-c.z),O=new f(new P(-1,0,0),v.x),j=new f(new P(1,0,0),-c.x),{front:M,back:W,left:Y,right:q}=d(l),S=this.createFromPlane(I,{id:M,world:e==null?void 0:e.world});S.range=C;const R=this.createFromPlane($,{id:W,world:e==null?void 0:e.world});R.range=C;const D=this.createFromPlane(O,{id:Y,world:e==null?void 0:e.world});D.range=h;const A=this.createFromPlane(j,{id:q,world:e==null?void 0:e.world});A.range=h,s.push(S,R,D,A)}return s}open(e){const s=this.list.get(e);if(!s)throw new Error(`Views: the view with id ${e} doesn't exist.`);if(s.open)return;const{world:a}=s;if(!a)throw new Error(`Views: no world found for view with id ${e}.`);const{renderer:n}=a;if(!n)throw new Error(`Views: no renderer found for world with id ${a.uuid}.`);for(const[,d]of this.list)d.world===a&&this.close(d.id);n.setPlane(!0,s.plane),n.setPlane(!0,s.farPlane),s.camera.controls.addEventListener("rest",this._fragmentsUpdateEvent),a.camera=s.camera,s.open=!0}close(e){let s;if(e?s=this.list.get(e):s=[...this.list.values()].find(d=>d.open),e&&!s)throw new Error(`Views: the view with id ${e} doesn't exist.`);if(!s||!s.open)return;const{world:a}=s;if(!a)throw new Error(`Views: no world found for view with id ${e}.`);const{renderer:n}=a;if(!n)throw new Error(`Views: no renderer found for world with id ${a.uuid}.`);n.setPlane(!1,s.plane),n.setPlane(!1,s.farPlane),s.camera.controls.removeEventListener("rest",this._fragmentsUpdateEvent),a.useDefaultCamera(),s.open=!1}};o(H,"uuid","fb22f1f5-6598-4664-a11d-de8963ae420f"),o(H,"defaultRange",15);let _=H;const m=new ne,ce=m.get(oe),i=ce.create();i.scene=new le(m);i.scene.setup();i.scene.three.background=null;const pe=document.getElementById("container");i.renderer=new ie(m,pe);i.camera=new T(m);await i.camera.controls.setLookAt(78,20,-2.2,26,-4,25);m.init();const me="https://thatopen.github.io/engine_fragment/resources/worker.mjs",he=await fetch(me),ue=await he.blob(),we=new File([ue],"worker.mjs",{type:"text/javascript"}),be=URL.createObjectURL(we),w=m.get(E);w.init(be);i.camera.controls.addEventListener("update",()=>w.core.update());i.onCameraChanged.add(r=>{for(const[,t]of w.list)t.useCamera(r.three);w.core.update(!0)});w.list.onItemSet.add(({value:r})=>{r.useCamera(i.camera.three),i.scene.three.add(r.object),w.core.update(!0)});w.core.models.materials.list.onItemSet.add(({value:r})=>{"isLodMaterial"in r&&r.isLodMaterial||(r.polygonOffset=!0,r.polygonOffsetUnits=1,r.polygonOffsetFactor=Math.random())});const fe=["https://thatopen.github.io/engine_components/resources/frags/school_arq.frag","https://thatopen.github.io/engine_components/resources/frags/school_str.frag"];await Promise.all(fe.map(async r=>{var a;const t=(a=r.split("/").pop())==null?void 0:a.split(".").shift();if(!t)return null;const s=await(await fetch(r)).arrayBuffer();return w.core.load(s,{modelId:t})}));const p=m.get(_);_.defaultRange=100;p.world=i;await p.createFromIfcStoreys({modelIds:[/arq/]});p.createElevations({combine:!0});const _e=m.get(de),ve=_e.get(i);window.addEventListener("dblclick",async()=>{const r=await ve.castRay();if(!r)return;const{normal:t,point:e}=r;if(!(t&&e))return;const s=t.clone().negate(),a=p.create(s,e.addScaledVector(t,1),{id:`View - ${p.list.size+1}`,world:i});a.range=10,a.helpersVisible=!0});X.init();const Pe=r=>{const{components:t}=r,e=t.get(_);return g`<bim-table ${ee(a=>{if(!a)return;const n=a;n.data=[...e.list.keys()].map(d=>({data:{Name:d,Actions:""}}))})}></bim-table>`},[V,ye]=N.create(Pe,{components:m});V.headersHidden=!0;V.noIndentation=!0;V.columns=["Name",{name:"Actions",width:"auto"}];V.dataTransform={Actions:(r,t)=>{const{Name:e}=t;if(!e)return r;const s=m.get(_);return s.list.get(e)?g`
      <bim-button label-hidden icon="solar:cursor-bold" label="Open" @click=${()=>{s.open(e)}}></bim-button>
      <bim-button label-hidden icon="material-symbols:delete" label="Remove" @click=${()=>{s.list.delete(e)}}></bim-button>
    `:r}};const k=()=>ye();p.list.onItemSet.add(k);p.list.onItemDeleted.add(k);p.list.onItemUpdated.add(k);p.list.onCleared.add(k);const x=N.create(()=>g`
    <bim-panel active label="2D Views Tutorial" class="options-menu">
      <bim-panel-section  label="Info">
        <bim-label style="width: 16rem; white-space: normal;" icon="noto-v1:light-bulb">Tip: Go inside the building and double click a wall to create a section</bim-label>
      </bim-panel-section>
      <bim-panel-section  label="Views">
        <bim-button label="Close Active 2D View" @click=${()=>p.close()}></bim-button>
        ${V}
      </bim-panel-section>
    </bim-panel>
  `);document.body.append(x);const Ce=N.create(()=>g`
      <bim-button class="phone-menu-toggler" icon="solar:settings-bold"
        @click="${()=>{x.classList.contains("options-menu-visible")?x.classList.remove("options-menu-visible"):x.classList.add("options-menu-visible")}}">
      </bim-button>
    `);document.body.append(Ce);const y=new Z;y.showPanel(2);document.body.append(y.dom);y.dom.style.left="0px";y.dom.style.zIndex="unset";i.renderer.onBeforeUpdate.add(()=>y.begin());i.renderer.onAfterUpdate.add(()=>y.end());
