var oe=Object.defineProperty;var re=(i,t,e)=>t in i?oe(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var r=(i,t,e)=>(re(i,typeof t!="symbol"?t+"":t,e),e);import{U as $,a as v,D as G,b as B,E as y,B as Y,M as le,c as ae,G as he}from"./graphic-vertex-picker-BY8Y4wOR.js";import{L as ce,d as q,G as H,W as b,V as x,B as ue,P as ee,e as de,f as te,g as me,h as X,i as pe,j as fe,C as D,k as I,D as Z,F as ge,M as N,m as xe}from"./index-D_lOu8Cy.js";import{M as J}from"./index-CenXdrKi.js";function ne(){const i=document.createElement("div");return i.style.backgroundColor="blue",i.style.color="white",i.style.padding="6px",i.style.borderRadius="6px",i.style.boxShadow="0px 4px 6px rgba(0, 0, 0, 0.6)",i.style.zIndex="-10",i}function _e(i={}){const{color:t="white",size:e="4px",border:n="2px solid blue",background:s="white"}=i,l=document.createElement("div");return l.style.backgroundColor=s,l.style.color=t,l.style.height=e,l.style.width=e,l.style.borderRadius="50%",l.style.border=n,l.style.zIndex="-20",l}class P extends ce{constructor(){super(...arguments);r(this,"id",$.create());r(this,"_units","m");r(this,"_rounding",2)}set units(e){this._units=e}get units(){return this._units}set rounding(e){this._rounding=e}get rounding(){return this._rounding}get value(){const e=this.distance();return v.convertUnits(e,"m",this.units,this.rounding)}}class j{constructor(t,e,n,s=2,l="m"){r(this,"label");r(this,"boundingBox",new q);r(this,"world");r(this,"_components");r(this,"_units","m");r(this,"_rounding",2);r(this,"startNormal",null);r(this,"line");r(this,"rectangleComponentLines",[]);r(this,"projectionComponentLines",[]);r(this,"_visible",!0);r(this,"_root",new H);r(this,"_endpoints",new b);r(this,"lineElement");r(this,"rectangleDimensions",new b);r(this,"projectionDimensions",new b);r(this,"isSelected",!1);r(this,"_latestRectangularInversion",!1);r(this,"_endpointElement",_e());r(this,"_material");r(this,"_componentsMaterial",new de({depthTest:!1,gapSize:.2,dashSize:.2,transparent:!0,opacity:.5,color:3026478}));r(this,"valueFormatter",null);this._components=t,this.world=e,this._material=n.lineMaterial,this._rounding=s,this._units=l,this.line=n.line,this.startNormal=n.startNormal??null,this.rectangleComponentLines=[new P,new P],this.updateRectangleComponents(),this.updateProjectionComponents(),this.lineElement=this.createLine(n),this._endpoints.onItemAdded.add(o=>{this._root.add(o.three);const a=this._endpoints.size===1?this.line.start:this.line.end;o.three.position.copy(a)}),this._endpoints.onBeforeDelete.add(o=>o.dispose()),this.createEndpoints();for(const o of this._endpoints)o.three.element.style.borderColor=`#${n.lineMaterial.color.getHexString()}`;this.label=this.newText(),this.label.three.element.style.backgroundColor=`#${n.lineMaterial.color.getHexString()}`,this.label.three.renderOrder=1,this._root.renderOrder=2,this.world.scene.three.add(this._root),this.setupEvents()}set units(t){for(const e of this.rectangleDimensions)e.units=t;for(const e of this.projectionDimensions)e.units=t;this._units=t,this.updateLabel()}get units(){return this._units}set rounding(t){for(const e of this.rectangleDimensions)e.rounding=t;for(const e of this.projectionDimensions)e.rounding=t;this._rounding=t,this.updateLabel()}get rounding(){return this._rounding}get visible(){return this._visible}set visible(t){for(const a of this.rectangleDimensions)a.visible=t;for(const a of this.projectionDimensions)a.visible=t;this._visible=t,this.label.visible=t;for(const a of this._endpoints)a.visible=t;const[e,n]=this._endpoints,s=e.three,l=n.three,o=this.label.three;t?(this.world.scene.three.add(this._root),this._root.add(o,s,l)):(o.removeFromParent(),s.removeFromParent(),l.removeFromParent(),this._root.removeFromParent())}set end(t){this.line.end=t;const e=this.lineElement.geometry.attributes.position;e.setXYZ(1,t.x,t.y,t.z),e.needsUpdate=!0,this.update()}set start(t){this.line.start=t;const e=this.lineElement.geometry.attributes.position;e.setXYZ(0,t.x,t.y,t.z),e.needsUpdate=!0,this.update()}applyPlanesVisibility(t){for(const e of this._endpoints){if(!e.wasVisible)continue;let n=!1;for(const s of t)if(s.distanceToPoint(e.three.position)<0){n=!0;break}e.three.visible=!n}if(this.label.wasVisible){let e=!1;const n=this.label.three.position;for(const s of t)if(s.distanceToPoint(n)<0){e=!0;break}this.label.three.visible=!e}for(const e of this.rectangleDimensions)e.applyPlanesVisibility(t);for(const e of this.projectionDimensions)e.applyPlanesVisibility(t)}setupEvents(){this.rectangleDimensions.onBeforeDelete.add(t=>t.dispose()),this.projectionDimensions.onBeforeDelete.add(t=>t.dispose())}dispose(){this.visible=!1;const t=this._components.get(G);t.destroy(this._root),t.destroy(this.lineElement),this._endpoints.clear(),this.label.dispose(),this.boundingBox&&t.destroy(this.boundingBox),this.rectangleDimensions.clear(),this.projectionDimensions.clear(),this._components=null}createBoundingBox(){const t=new x;this.line.getCenter(t);const e=this.line.distance();this.boundingBox.geometry=new ue(1,1,e),this.boundingBox.position.copy(t),this.boundingBox.lookAt(this.line.end),this.boundingBox.visible=!1,this._root.add(this.boundingBox)}invertRectangularDimensions(){this.rectangleDimensions.size!==0&&(this.rectangleDimensions.clear(),this._latestRectangularInversion=!this._latestRectangularInversion,this.updateRectangleComponents(this._latestRectangularInversion),this.displayRectangularDimensions())}displayRectangularDimensions(){this.rectangleDimensions.clear();for(const t of this.rectangleComponentLines){const e=new j(this._components,this.world,{line:t,lineMaterial:this._componentsMaterial,endpointElement:this.endpointElement});e.lineElement.computeLineDistances(),this.rectangleDimensions.add(e)}}displayProjectionDimensions(){this.projectionDimensions.clear();for(const t of this.projectionComponentLines){const e=new j(this._components,this.world,{line:t,lineMaterial:this._componentsMaterial,endpointElement:this.endpointElement});e.lineElement.computeLineDistances(),this.projectionDimensions.add(e)}}set endpointElement(t){for(const e of this.rectangleDimensions)e.endpointElement=t;for(const e of this.projectionDimensions)e.endpointElement=t;this._endpointElement=t,this.createEndpoints()}get endpointElement(){return this._endpointElement}createEndpoints(){this._endpoints.clear();const t=new B(this.world,this._endpointElement),e=new B(this.world,this._endpointElement.cloneNode(!0));this._endpoints.add(t,e)}updateProjectionComponents(){if(!this.startNormal)return;const t=new ee().setFromNormalAndCoplanarPoint(this.startNormal,this.line.start),e=new x;t.projectPoint(this.line.end,e);let[n]=this.projectionComponentLines;n||(n=new P,this.projectionComponentLines.push(n)),n.set(this.line.end,e),n.distance()<.01&&this.projectionComponentLines.shift();for(const s of this.projectionDimensions)s&&s.update()}updateRectangleComponents(t=!1){const e=t?this.line.end:this.line.start,n=t?this.line.start:this.line.end,s=new x;s.subVectors(n,e),Math.abs(n.y-e.y)>=.1?s.y=0:s.x=0;const o=e.clone().add(s),[a,u]=this.rectangleComponentLines;a.set(o,e),u.set(o,n);for(const d of this.rectangleDimensions)d.update()}updateLabel(){this.label.three.element.textContent=this.getTextContent();const t=new x;this.line.getCenter(t),this.label.three.position.copy(t)}updateGeometry(){this.updateRectangleComponents(),this.updateProjectionComponents(),[...this._endpoints][0].three.position.copy(this.line.start),[...this._endpoints][1].three.position.copy(this.line.end),this.lineElement.geometry.computeBoundingSphere()}update(){this.updateGeometry(),this.updateLabel()}set material(t){this._material.dispose(),this._material=t,this.lineElement.material=t}get material(){return this._material}createLine(t){const e=new te;e.setFromPoints([t.line.start,t.line.end]);const n=new me(e,t.lineMaterial);return this._root.add(n),n}newText(){const t=ne();t.textContent=this.getTextContent();const e=new B(this.world,t),n=new x;return this.line.getCenter(n),e.three.position.copy(n),this._root.add(e.three),e}getTextContent(t=this.line.distance()){return`${v.convertUnits(t,"m",this._units,this.rounding).toFixed(this.rounding)} ${this._units}`}set color(t){const e=`#${t.getHexString()}`;this.label.three.element.style.backgroundColor=e;for(const n of this._endpoints)n.three.element.style.borderColor=e;this._material.color.set(t)}}class z{constructor(t){r(this,"id",$.create());r(this,"points",new b);r(this,"tolerance",.005);r(this,"_plane",null);r(this,"_rounding",2);r(this,"_units","m2");this.points.guard=e=>{const n=[...this.points].some(l=>l.equals(e)),s=this.isPointInPlane(e);return!n&&s},this.points.onItemAdded.add(e=>{if(this.plane){const n=new x;this.plane.projectPoint(e,n),e.copy(n)}this.points.size<3||this.points.size===3&&this.computePlane()}),this.points.onItemDeleted.add(()=>{this.points.size>=3||(this._plane=null)}),this.points.onCleared.add(()=>{this._plane=null}),t&&this.points.add(...t)}get plane(){return this._plane}get _coordinateSystem(){if(!this.plane)return null;const t=this.plane.normal,e=new x,n=new x;return Math.abs(t.x)>Math.abs(t.z)?e.set(-t.y,t.x,0).normalize():e.set(0,-t.z,t.y).normalize(),n.crossVectors(t,e).normalize(),{normal:t.clone(),x:e.clone(),y:n.clone()}}get points2D(){if(!this.plane)if(this.points.size>=3)this.computePlane();else return null;return[...this.points].map(e=>this.convertPointTo2D(e)).filter(e=>e!==null)}get center(){if(!this.plane||this.points.size<3)return null;const t=this.points2D;if(!t||t.length===0)return null;const e=t.reduce((n,s)=>n.add(s),new X).divideScalar(t.length);return this.convertPointTo3D(e)}get value(){return v.convertUnits(this.rawValue,"m2",this.units,this.rounding)}get rawValue(){const t=this.points2D;return t?Math.abs(pe.area(t)):0}get boundingBox(){if(this.points.size===0)return null;const t=new fe;for(const e of this.points)t.expandByPoint(e);return t}get perimeter(){const t=this.points2D;if(!t||t.length<2)return 0;let e=0;for(let n=0;n<t.length;n++){const s=t[n],l=t[(n+1)%t.length];e+=s.distanceTo(l)}return e}set rounding(t){this._rounding=t}get rounding(){return this._rounding}set units(t){this._units=t}get units(){return this._units}isPointInPlane(t){if(!this.plane)return!0;const e=this.plane.distanceToPoint(t);return Math.abs(e)<this.tolerance}clone(){const t=new z([...this.points]);return t.units=this.units,t.rounding=this.rounding,t.tolerance=this.tolerance,t}computePlane(){const[t,e,n]=this.points;if(!(t&&e&&n))return null;const s=new x().subVectors(e,t),l=new x().subVectors(n,t),o=new x().crossVectors(s,l).normalize();return this._plane=new ee().setFromNormalAndCoplanarPoint(o,t),this.plane}convertPointTo2D(t){if(!this.isPointInPlane(t)||!this.plane)return null;const e=this._coordinateSystem;if(!e)return null;const n=new x;this.plane.projectPoint(t,n);const s=n.dot(e.x),l=n.dot(e.y);return new X(s,l)}convertPointTo3D(t){if(!this.plane)return null;const e=this._coordinateSystem;if(!e)return null;const{x:n,y:s,normal:l}=e;return new x().addScaledVector(n,t.x).addScaledVector(s,t.y).addScaledVector(l,-this.plane.constant)}}class U{constructor(t){r(this,"_components");r(this,"id",$.create());r(this,"onItemsChanged",new y);r(this,"_items",{});r(this,"_units","m3");r(this,"_rounding",2);this._components=t}set items(t){this._items=t,this.onItemsChanged.trigger()}get items(){return this._items}set units(t){this._units=t}get units(){return this._units}set rounding(t){this._rounding=t}get rounding(){return this._rounding}async getRawValue(){return await this._components.get(v).getItemsVolume(this.items)}async getValue(){const t=await this.getRawValue();return v.convertUnits(t,"m3",this.units,this.rounding)}async getCenter(){return await this._components.get(Y).getCenter(this.items)}async getBox(){const t=this._components.get(Y);t.list.clear(),await t.addFromModelIdMap(this.items);const e=t.get();return t.list.clear(),e}clone(){const t=new U(this._components);return t.items=le.clone(this.items),t}}function we(i,t,e=2){const n=i.length;let s=be(i,0,n,e,!0);const l=[];if(!s||s.next===s.prev)return l;let o,a,u;if(i.length>80*e){o=1/0,a=1/0;let d=-1/0,_=-1/0;for(let f=e;f<n;f+=e){const g=i[f],w=i[f+1];g<o&&(o=g),w<a&&(a=w),g>d&&(d=g),w>_&&(_=w)}u=Math.max(d-o,_-a),u=u!==0?32767/u:0}return k(s,l,e,o,a,u,0),l}function be(i,t,e,n,s){let l;if(s===Le(i,t,e,n)>0)for(let o=t;o<e;o+=n)l=Q(o/n|0,i[o],i[o+1],l);else for(let o=e-n;o>=t;o-=n)l=Q(o/n|0,i[o],i[o+1],l);return l&&R(l,l.next)&&(F(l),l=l.next),l}function V(i,t){if(!i)return i;t||(t=i);let e=i,n;do if(n=!1,!e.steiner&&(R(e,e.next)||m(e.prev,e,e.next)===0)){if(F(e),e=t=e.prev,e===e.next)break;n=!0}else e=e.next;while(n||e!==t);return t}function k(i,t,e,n,s,l,o){if(!i)return;!o&&l&&Ee(i,n,s,l);let a=i;for(;i.prev!==i.next;){const u=i.prev,d=i.next;if(l?ve(i,n,s,l):ye(i)){t.push(u.i,i.i,d.i),F(i),i=d.next,a=d.next;continue}if(i=d,i===a){o?o===1?(i=Me(V(i),t),k(i,t,e,n,s,l,2)):o===2&&Ce(i,t,e,n,s,l):k(V(i),t,e,n,s,l,1);break}}}function ye(i){const t=i.prev,e=i,n=i.next;if(m(t,e,n)>=0)return!1;const s=t.x,l=e.x,o=n.x,a=t.y,u=e.y,d=n.y,_=Math.min(s,l,o),f=Math.min(a,u,d),g=Math.max(s,l,o),w=Math.max(a,u,d);let p=n.next;for(;p!==t;){if(p.x>=_&&p.x<=g&&p.y>=f&&p.y<=w&&E(s,a,l,u,o,d,p.x,p.y)&&m(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function ve(i,t,e,n){const s=i.prev,l=i,o=i.next;if(m(s,l,o)>=0)return!1;const a=s.x,u=l.x,d=o.x,_=s.y,f=l.y,g=o.y,w=Math.min(a,u,d),p=Math.min(_,f,g),M=Math.max(a,u,d),C=Math.max(_,f,g),W=A(w,p,t,e,n),K=A(M,C,t,e,n);let h=i.prevZ,c=i.nextZ;for(;h&&h.z>=W&&c&&c.z<=K;){if(h.x>=w&&h.x<=M&&h.y>=p&&h.y<=C&&h!==s&&h!==o&&E(a,_,u,f,d,g,h.x,h.y)&&m(h.prev,h,h.next)>=0||(h=h.prevZ,c.x>=w&&c.x<=M&&c.y>=p&&c.y<=C&&c!==s&&c!==o&&E(a,_,u,f,d,g,c.x,c.y)&&m(c.prev,c,c.next)>=0))return!1;c=c.nextZ}for(;h&&h.z>=W;){if(h.x>=w&&h.x<=M&&h.y>=p&&h.y<=C&&h!==s&&h!==o&&E(a,_,u,f,d,g,h.x,h.y)&&m(h.prev,h,h.next)>=0)return!1;h=h.prevZ}for(;c&&c.z<=K;){if(c.x>=w&&c.x<=M&&c.y>=p&&c.y<=C&&c!==s&&c!==o&&E(a,_,u,f,d,g,c.x,c.y)&&m(c.prev,c,c.next)>=0)return!1;c=c.nextZ}return!0}function Me(i,t){let e=i;do{const n=e.prev,s=e.next.next;!R(n,s)&&ie(n,e,e.next,s)&&S(n,s)&&S(s,n)&&(t.push(n.i,e.i,s.i),F(e),F(e.next),e=i=s),e=e.next}while(e!==i);return V(e)}function Ce(i,t,e,n,s,l){let o=i;do{let a=o.next.next;for(;a!==o.prev;){if(o.i!==a.i&&Ve(o,a)){let u=Te(o,a);o=V(o,o.next),u=V(u,u.next),k(o,t,e,n,s,l,0),k(u,t,e,n,s,l,0);return}a=a.next}o=o.next}while(o!==i)}function Ee(i,t,e,n){let s=i;do s.z===0&&(s.z=A(s.x,s.y,t,e,n)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next;while(s!==i);s.prevZ.nextZ=null,s.prevZ=null,Pe(s)}function Pe(i){let t,e=1;do{let n=i,s;i=null;let l=null;for(t=0;n;){t++;let o=n,a=0;for(let d=0;d<e&&(a++,o=o.nextZ,!!o);d++);let u=e;for(;a>0||u>0&&o;)a!==0&&(u===0||!o||n.z<=o.z)?(s=n,n=n.nextZ,a--):(s=o,o=o.nextZ,u--),l?l.nextZ=s:i=s,s.prevZ=l,l=s;n=o}l.nextZ=null,e*=2}while(t>1);return i}function A(i,t,e,n,s){return i=(i-e)*s|0,t=(t-n)*s|0,i=(i|i<<8)&16711935,i=(i|i<<4)&252645135,i=(i|i<<2)&858993459,i=(i|i<<1)&1431655765,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,i|t<<1}function De(i,t,e,n,s,l,o,a){return(s-o)*(t-a)>=(i-o)*(l-a)&&(i-o)*(n-a)>=(e-o)*(t-a)&&(e-o)*(l-a)>=(s-o)*(n-a)}function E(i,t,e,n,s,l,o,a){return!(i===o&&t===a)&&De(i,t,e,n,s,l,o,a)}function Ve(i,t){return i.next.i!==t.i&&i.prev.i!==t.i&&!ke(i,t)&&(S(i,t)&&S(t,i)&&Fe(i,t)&&(m(i.prev,i,t.prev)||m(i,t.prev,t))||R(i,t)&&m(i.prev,i,i.next)>0&&m(t.prev,t,t.next)>0)}function m(i,t,e){return(t.y-i.y)*(e.x-t.x)-(t.x-i.x)*(e.y-t.y)}function R(i,t){return i.x===t.x&&i.y===t.y}function ie(i,t,e,n){const s=L(m(i,t,e)),l=L(m(i,t,n)),o=L(m(e,n,i)),a=L(m(e,n,t));return!!(s!==l&&o!==a||s===0&&T(i,e,t)||l===0&&T(i,n,t)||o===0&&T(e,i,n)||a===0&&T(e,t,n))}function T(i,t,e){return t.x<=Math.max(i.x,e.x)&&t.x>=Math.min(i.x,e.x)&&t.y<=Math.max(i.y,e.y)&&t.y>=Math.min(i.y,e.y)}function L(i){return i>0?1:i<0?-1:0}function ke(i,t){let e=i;do{if(e.i!==i.i&&e.next.i!==i.i&&e.i!==t.i&&e.next.i!==t.i&&ie(e,e.next,i,t))return!0;e=e.next}while(e!==i);return!1}function S(i,t){return m(i.prev,i,i.next)<0?m(i,t,i.next)>=0&&m(i,i.prev,t)>=0:m(i,t,i.prev)<0||m(i,i.next,t)<0}function Fe(i,t){let e=i,n=!1;const s=(i.x+t.x)/2,l=(i.y+t.y)/2;do e.y>l!=e.next.y>l&&e.next.y!==e.y&&s<(e.next.x-e.x)*(l-e.y)/(e.next.y-e.y)+e.x&&(n=!n),e=e.next;while(e!==i);return n}function Te(i,t){const e=O(i.i,i.x,i.y),n=O(t.i,t.x,t.y),s=i.next,l=t.prev;return i.next=t,t.prev=i,e.next=s,s.prev=e,n.next=e,e.prev=n,l.next=n,n.prev=l,n}function Q(i,t,e,n){const s=O(i,t,e);return n?(s.next=n.next,s.prev=n,n.next.prev=s,n.next=s):(s.prev=s,s.next=s),s}function F(i){i.next.prev=i.prev,i.prev.next=i.next,i.prevZ&&(i.prevZ.nextZ=i.nextZ),i.nextZ&&(i.nextZ.prevZ=i.prevZ)}function O(i,t,e){return{i,x:t,y:e,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Le(i,t,e,n){let s=0;for(let l=t,o=e-n;l<e;l+=n)s+=(i[o]-i[l])*(i[l+1]+i[o+1]),o=l;return s}class se extends B{constructor(e){const n=document.createElement("div");n.style.backgroundColor="blue",n.style.color="white",n.style.padding="6px",n.style.borderRadius="6px",n.style.boxShadow="0px 4px 6px rgba(0, 0, 0, 0.6)",n.style.zIndex="-10";super(e,n);r(this,"_value",0);r(this,"_units","m2");r(this,"_worldUnits","m2");r(this,"_color",new D);r(this,"_textColor",new D);r(this,"_rounding",2);this.three.renderOrder=1,n.textContent=this.formattedValue}set value(e){this._value=e,this.three.element.textContent=this.formattedValue}get value(){return this._value}set units(e){this._units=e,this.three.element.textContent=this.formattedValue}get units(){return this._units}set worldUnits(e){this._worldUnits=e,this.three.element.textContent=this.formattedValue}get worldUnits(){return this._worldUnits}set color(e){this._color=e;const n=`#${e.getHexString()}`;this.three.element.style.backgroundColor=n}get color(){return this._color}set textColor(e){this._textColor=e;const n=`#${e.getHexString()}`;this.three.element.style.color=n}get textColor(){return this._textColor}set rounding(e){this._rounding=e,this.three.element.textContent=this.formattedValue}get rounding(){return this._rounding}get formattedValue(){return`${v.convertUnits(this.value,this.worldUnits,this.units,this.rounding).toFixed(this.rounding)} ${this.units}`}}class Be{constructor(t,e,n=new z){r(this,"_root",new H);r(this,"_components");r(this,"_material",new I({color:"red",transparent:!0,opacity:.5,side:Z,depthTest:!1}));r(this,"_visible",!0);r(this,"_color",new D);r(this,"label");r(this,"three",new q);r(this,"world");r(this,"area");r(this,"_triggerUpdate",()=>this.update());this._components=t,this.world=e,this.area=n,this.world.scene.three.add(this.three),this.label=new se(e),this._root.renderOrder=2,this.visible=!0,this.update(),n.points.onItemAdded.add(this._triggerUpdate),n.points.onItemDeleted.add(this._triggerUpdate),n.points.onCleared.add(this._triggerUpdate)}set material(t){this._material.dispose(),this._material=t,this.three.material=t}get material(){return this._material}set visible(t){this._visible=t,this.label.visible=t;const e=this.label.three;t?(this._root.add(e,this.three),this.world.scene.three.add(this._root)):(e.removeFromParent(),this._root.removeFromParent())}get visible(){return this._visible}set rounding(t){this.label.rounding=t}get rounding(){return this.label.rounding}set units(t){this.label.units=t}get units(){return this.label.units}set color(t){this._color=t,this.label.color=t,this._material.color.set(t)}get color(){return this._color}applyPlanesVisibility(t){if(!this.label.wasVisible)return;let e=!1;const n=this.area.center;if(n){for(const s of t)if(s.distanceToPoint(n)<0){e=!0;break}}this.label.three.visible=!e}updateMesh(){if(this.area.points.size<3)return;const t=this.area.points2D;if(!t||t.length<3)return;const e=t.flatMap(o=>[o.x,o.y]),n=we(e),s=[];for(const o of t){const a=this.area.convertPointTo3D(o);a&&s.push(a.x,a.y,a.z)}this.three.geometry&&this.three.geometry.dispose();const l=new te;l.setAttribute("position",new ge(s,3)),l.setIndex(n),this.three.geometry=l,this.three.material=this.material}update(){if(this.updateMesh(),this.area.rawValue===0)this.label.visible=!1;else{this.label.value=this.area.rawValue,this.label.visible=!0;const t=this.area.center;t&&this.label.three.position.copy(t)}}dispose(){this.label.dispose(),this._components.get(G).destroy(this._root,!0,!0),this.area.points.clear()}}const Ie={length:"m",area:"m2",volume:"m3"};class Ze{constructor(t,e,n=new U(t)){r(this,"_root",new H);r(this,"_components");r(this,"_material",new I({color:"red",transparent:!0,opacity:.75,side:Z,depthTest:!1}));r(this,"_visible",!0);r(this,"_color",new D);r(this,"label");r(this,"world");r(this,"volume");r(this,"meshes",[]);this._components=t,this.world=e,this.volume=n,this.label=new se(e),this._root.renderOrder=2,this.visible=!0,this.update(),this.volume.onItemsChanged.add(()=>this.update())}set material(t){this._material.dispose(),this._material=t;for(const e of this.meshes)e.material=t}get material(){return this._material}set visible(t){this._visible=t,this.label.visible=t;for(const e of this.meshes)t?this.world.scene.three.add(e):e.removeFromParent()}get visible(){return this._visible}set rounding(t){this.label.rounding=t}get rounding(){return this.label.rounding}set units(t){this.label.units=t}get units(){return this.label.units}set color(t){this._color=t,this.label.color=t,this._material.color.set(t)}get color(){return this._color}applyPlanesVisibility(t){if(!this.label.wasVisible)return;let e=!1;for(const n of this.meshes){for(const s of t)if(s.distanceToPoint(n.position)<0){e=!0;break}this.label.three.visible=!e}}async updateMesh(){this.cleanMeshes();const t=this._components.get(J),e=await t.get(this.volume.items,{material:this.material});this.meshes=t.getMeshesFromResult(e);for(const n of this.meshes)this.world.scene.three.add(n)}async update(){this.updateMesh();const t=await this.volume.getRawValue();this.label.visible=t!==0,this.label.value=t;const e=await this.volume.getCenter();e&&this.label.three.position.copy(e)}cleanMeshes(){const t=this._components.get(G);for(const n of this.meshes)t.destroy(n,!0,!0);this._components.get(J).remove(),this.meshes=[]}dispose(){this.label.dispose(),this.cleanMeshes(),this.volume.items={}}}class je extends ae{constructor(e,n){super(e);r(this,"list",new b);r(this,"onDisposed",new y);r(this,"snappings",[N.LINE,N.POINT,N.FACE]);r(this,"lines",new b);r(this,"fills",new b);r(this,"labels",new b);r(this,"volumes",new b);r(this,"delay",300);r(this,"_world",null);r(this,"measureType");r(this,"onPointerStop",new y);r(this,"onPointerMove",new y);r(this,"onStateChanged",new y);r(this,"pointerStopTimeout",null);r(this,"onMove",()=>{this.enabled&&(this._vertexPicker.updatePointer(),this.pointerStopTimeout!==null&&clearTimeout(this.pointerStopTimeout),this.pointerStopTimeout=window.setTimeout(()=>{this.onPointerStop.trigger()},this.delay),this.onPointerMove.trigger())});r(this,"onKeydown",e=>{this.enabled&&e.key==="Escape"&&this.cancelCreation()});r(this,"onEnabledChange",new y);r(this,"_enabled",!1);r(this,"onVisibilityChange",new y);r(this,"_visible",!0);r(this,"_units");r(this,"_rounding",2);r(this,"_linesEndpointElement",ne());r(this,"_linesMaterial",new xe({color:"#0000FF",depthTest:!1}));r(this,"_fillsMaterial",new I({color:2392594,side:Z,transparent:!0,opacity:.3,depthTest:!1}));r(this,"_volumesMaterial",new I({color:2392594,side:Z,transparent:!0,opacity:.3,depthTest:!1}));r(this,"_color",new D);r(this,"_vertexPicker",new he(this.components));r(this,"create",e=>{});r(this,"endCreation",e=>{});r(this,"cancelCreation",()=>{});r(this,"delete",e=>{});this.measureType=n,this._units=Ie[this.measureType],this.lines.onBeforeDelete.add(s=>s.dispose()),this.fills.onBeforeDelete.add(s=>s.dispose()),this.labels.onBeforeDelete.add(s=>s.dispose()),this.volumes.onBeforeDelete.add(s=>s.dispose()),this.list.onCleared.add(()=>{this.lines.clear(),this.fills.clear(),this.labels.clear(),this.volumes.clear()})}set world(e){this._world=e,this._vertexPicker.world=e}get world(){return this._world}get unitsList(){let e=[];return this.measureType==="length"?e=["mm","cm","m","km"]:this.measureType==="area"?e=["mm2","cm2","m2","km2"]:e=["mm3","cm3","m3","km3"],e}setEvents(e){if(!this.world)throw new Error("Measurement: you must specify a world first!");if(this.world.isDisposing)return;if(!this.world.renderer)throw new Error("Measurement: the world needs a renderer!");const s=this.world.renderer.three.domElement.parentElement;s&&(s.removeEventListener("pointermove",this.onMove),window.removeEventListener("keydown",this.onKeydown),e&&(s.addEventListener("pointermove",this.onMove),window.addEventListener("keydown",this.onKeydown)))}set enabled(e){this._enabled=e,this._vertexPicker.enabled=e,this.setEvents(e),this.cancelCreation(),this.onEnabledChange.trigger(e),this.onStateChanged.trigger(["enabled"])}get enabled(){return this._enabled}set visible(e){this._visible=e;for(const n of this.lines)n.visible=e;for(const n of this.fills)n.visible=e;for(const n of this.volumes)n.visible=e;this.onVisibilityChange.trigger(e),this.onStateChanged.trigger(["visibility"])}get visible(){return this._visible}set units(e){this._units=e;let n;e.endsWith("2")?n="area":e.endsWith("3")?n="volume":n="length";for(const s of this.list)(s instanceof P||s instanceof z||s instanceof U)&&(s.units=e);if(n==="length")for(const s of this.lines)s.units=e;else if(n==="area")for(const s of this.fills)s.units=e;else if(n==="volume")for(const s of this.volumes)s.units=e;this.onStateChanged.trigger(["units"])}get units(){return this._units}set rounding(e){this._rounding=e;for(const n of this.list)"rounding"in n&&typeof n.rounding=="number"&&(n.rounding=e);for(const n of this.lines)n.rounding=e;for(const n of this.fills)n.rounding=e;for(const n of this.volumes)n.rounding=e;this.onStateChanged.trigger(["rounding"])}get rounding(){return this._rounding}set linesEndpointElement(e){this._linesEndpointElement=e;for(const n of this.lines)n.endpointElement=e}get linesEndpointElement(){return this._linesEndpointElement}set linesMaterial(e){this._linesMaterial.dispose(),this._linesMaterial=e;for(const n of this.lines)n.material=e}get linesMaterial(){return this._linesMaterial}set fillsMaterial(e){this._fillsMaterial.dispose(),this._fillsMaterial=e;for(const n of this.fills)n.material=e}get fillsMaterial(){return this._fillsMaterial}set volumesMaterial(e){this._volumesMaterial.dispose(),this._volumesMaterial=e;for(const n of this.volumes)n.material=e}get volumesMaterial(){return this._volumesMaterial}set color(e){this._color=e,this._linesMaterial.color.set(e),this._fillsMaterial.color.set(e),this._volumesMaterial.color.set(e);for(const n of this.lines)n.color=e;for(const n of this.fills)n.color=e;for(const n of this.volumes)n.color=e;this.onStateChanged.trigger(["color"])}get color(){return this._color}get pickerMode(){return this._vertexPicker.mode}set pickerMode(e){this._vertexPicker.mode=e}get snapDistance(){return this._vertexPicker.maxDistance}set snapDistance(e){this._vertexPicker.maxDistance=e}dispose(){this._vertexPicker.dispose(),this.list.clear(),this.linesMaterial.dispose(),this.fillsMaterial.dispose(),this.volumesMaterial.dispose(),this.onDisposed.trigger()}applyPlanesVisibility(e){for(const n of this.lines)n.applyPlanesVisibility(e);for(const n of this.fills)n.applyPlanesVisibility(e);for(const n of this.volumes)n.applyPlanesVisibility(e)}createLineElement(e,n=null){if(!this.world)throw new Error("Measurement: world is need!");return new j(this.components,this.world,{line:e,startNormal:n??void 0,lineMaterial:this.linesMaterial,endpointElement:this.linesEndpointElement},this.rounding,this.units)}createFillElement(e){if(!this.world)throw new Error("Measurement: world is need!");const n=new Be(this.components,this.world,e);return n.rounding=this.rounding,(this.units.endsWith("2")?"area":void 0)==="area"&&(n.units=this.units),n}createVolumeElement(e){if(!this.world)throw new Error("Measurement: world is need!");const n=new Ze(this.components,this.world,e);return n.rounding=this.rounding,(this.units.endsWith("3")?"volume":void 0)==="volume"&&(n.units=this.units),n}addLineElementsFromPoints(e){for(let n=0;n<e.length;n++){const s=e[n],l=e[(n+1)%e.length],o=new P(s,l),a=this.createLineElement(o);a.label.visible=!1,this.lines.add(a)}}getLineBoxes(){const e=[];for(const n of this.lines)e.push(n.boundingBox);return e}getFillBoxes(){const e=[];for(const n of this.fills)e.push(n.three);return e}async getVolumeBoxes(){const e=[];for(const n of this.volumes)e.push(n.meshes);return e}}r(je,"valueFormatter",null);export{z as A,P as L,je as M,Ze as a};
