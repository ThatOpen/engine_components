var S=Object.defineProperty;var x=(o,i,e)=>i in o?S(o,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[i]=e;var t=(o,i,e)=>(x(o,typeof i!="symbol"?i+"":i,e),e);import{C as l,V as _,E as D,D as E,A as P,W as p,h as m,N as F,aw as U,Q as k,a as M}from"./web-ifc-api-Dxv4iFj4.js";import{g as b,E as a,D as w,h as y,i as L,S as f,j as R}from"./index-Ck_fWpAQ.js";class N extends b{constructor(){super(...arguments);t(this,"onAfterUpdate",new a);t(this,"onBeforeUpdate",new a);t(this,"onDisposed",new a);t(this,"onResize",new a);t(this,"onClippingPlanesUpdated",new a);t(this,"clippingPlanes",[])}updateClippingPlanes(){this.onClippingPlanesUpdated.trigger()}setPlane(e,s,n){s.isLocal=n;const r=this.clippingPlanes.indexOf(s);e&&r===-1?this.clippingPlanes.push(s):!e&&r>-1&&this.clippingPlanes.splice(r,1),this.three.clippingPlanes=this.clippingPlanes.filter(h=>!h.isLocal)}}class Z extends b{constructor(e){super(e);t(this,"onDisposed",new a);t(this,"directionalLights",new Map);t(this,"ambientLights",new Map)}dispose(){const e=this.components.get(w);for(const s of this.three.children){const n=s;n.geometry&&e.destroy(n)}this.deleteAllLights(),this.three.children=[],this.onDisposed.trigger(),this.onDisposed.reset()}deleteAllLights(){for(const[,e]of this.directionalLights)e.removeFromParent(),e.target.removeFromParent(),e.dispose();this.directionalLights.clear();for(const[,e]of this.ambientLights)e.removeFromParent(),e.dispose();this.ambientLights.clear()}}class A{constructor(i,e){t(this,"_list");t(this,"_scene");this._list=i,this._scene=e}get color(){return this._list.directionalLight.color.value}set color(i){this._list.directionalLight.color.value=i;for(const[,e]of this._scene.directionalLights)e.color.copy(i)}get intensity(){return this._list.directionalLight.intensity.value}set intensity(i){this._list.directionalLight.intensity.value=i;for(const[,e]of this._scene.directionalLights)e.intensity=i}get position(){return this._list.directionalLight.position.value.clone()}set position(i){this._list.directionalLight.position.value=i;for(const[,e]of this._scene.directionalLights)e.position.copy(i)}}class B{constructor(i,e){t(this,"_list");t(this,"_scene");this._list=i,this._scene=e}get color(){return this._list.ambientLight.color.value}set color(i){this._list.ambientLight.color.value=i;for(const[,e]of this._scene.ambientLights)e.color.copy(i)}get intensity(){return this._list.ambientLight.intensity.value}set intensity(i){this._list.ambientLight.intensity.value=i;for(const[,e]of this._scene.ambientLights)e.intensity=i}}class O extends y{constructor(){super(...arguments);t(this,"_config",{backgroundColor:{value:new l,type:"Color"},ambientLight:{color:{type:"Color",value:new l},intensity:{type:"Number",interpolable:!0,min:0,max:10,value:2}},directionalLight:{color:{type:"Color",value:new l},intensity:{type:"Number",interpolable:!0,min:0,max:10,value:2},position:{type:"Vector3",value:new _}}});t(this,"ambientLight",new B(this._config,this._component));t(this,"directionalLight",new A(this._config,this._component))}get backgroundColor(){return this._config.backgroundColor.value}set backgroundColor(e){this._config.backgroundColor.value=e,this._component.three.background=e}}class j extends Z{constructor(e){super(e);t(this,"onSetup",new a);t(this,"isSetup",!1);t(this,"three");t(this,"config",new O(this,this.components,"Scene"));t(this,"_defaultConfig",{backgroundColor:new l(2107698),directionalLight:{color:new l("white"),intensity:1.5,position:new _(5,10,3)},ambientLight:{color:new l("white"),intensity:1}});this.three=new D,this.three.background=new l(2107698)}setup(e){const s={...this._defaultConfig,...e};this.config.backgroundColor=s.backgroundColor;const n=s.ambientLight;this.config.ambientLight.color=n.color,this.config.ambientLight.intensity=n.intensity;const r=s.directionalLight;this.config.directionalLight.color=r.color,this.config.directionalLight.intensity=r.intensity,this.config.directionalLight.position=r.position,this.deleteAllLights();const{color:h,intensity:g}=this.config.directionalLight,c=new E(h,g);c.position.copy(r.position);const{color:z,intensity:C}=this.config.directionalLight,u=new P(z,C);this.three.add(c,u),this.directionalLights.set(c.uuid,c),this.ambientLights.set(u.uuid,u),this.isSetup=!0,this.onSetup.trigger()}dispose(){super.dispose(),this.components.get(L).list.delete(this.config.uuid)}}class I extends N{constructor(e,s,n){super(e);t(this,"enabled",!0);t(this,"container");t(this,"three");t(this,"_canvas");t(this,"_parameters");t(this,"_resizeObserver",null);t(this,"onContainerUpdated",new a);t(this,"_resizing",!1);t(this,"resize",e=>{if(this._resizing)return;this._resizing=!0,this.onContainerUpdated.trigger();const s=e?e.x:this.container.clientWidth,n=e?e.y:this.container.clientHeight;this.three.setSize(s,n),this.onResize.trigger(new m(s,n)),this._resizing=!1});t(this,"resizeEvent",()=>{this.resize()});t(this,"onContextLost",e=>{e.preventDefault(),this.enabled=!1});t(this,"onContextBack",()=>{this.three.setRenderTarget(null),this.three.dispose(),this.three=new p({canvas:this._canvas,antialias:!0,alpha:!0,...this._parameters}),this.enabled=!0});this.container=s,this._parameters=n,this.three=new p({antialias:!0,alpha:!0,...n}),this.three.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.setupRenderer(),this.setupEvents(!0),this.resize(),this._canvas=this.three.domElement;const r=this.three.getContext(),{canvas:h}=r;h.addEventListener("webglcontextlost",this.onContextLost,!1),h.addEventListener("webglcontextrestored",this.onContextBack,!1)}update(){if(!this.enabled||!this.currentWorld)return;this.onBeforeUpdate.trigger(this);const e=this.currentWorld.scene.three,s=this.currentWorld.camera.three;this.three.render(e,s),this.onAfterUpdate.trigger(this)}dispose(){this.enabled=!1,this.setupEvents(!1),this.three.domElement.remove(),this.three.forceContextLoss(),this.three.dispose(),this.onResize.reset(),this.onAfterUpdate.reset(),this.onBeforeUpdate.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}getSize(){return new m(this.three.domElement.clientWidth,this.three.domElement.clientHeight)}setupEvents(e){const s=this.three.domElement.parentElement;if(!s)throw new Error("This renderer needs to have an HTML container!");this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),window.removeEventListener("resize",this.resizeEvent),e&&(this._resizeObserver=new ResizeObserver(this.resizeEvent),this._resizeObserver.observe(s),window.addEventListener("resize",this.resizeEvent))}setupRenderer(){this.three.localClippingEnabled=!0,this.container&&this.container.appendChild(this.three.domElement),this.onContainerUpdated.trigger()}}class W extends y{constructor(){super(...arguments);t(this,"_config",{visible:{value:!0,type:"Boolean"},color:{value:new l,type:"Color"},primarySize:{type:"Number",interpolable:!0,value:1,min:0,max:1e3},secondarySize:{type:"Number",interpolable:!0,value:10,min:0,max:1e3},distance:{type:"Number",interpolable:!0,value:500,min:0,max:500}})}get visible(){return this._config.visible.value}set visible(e){this._config.visible.value=e,this._component.visible=e}get color(){return this._config.color.value}set color(e){this._config.color.value=e,this._component.material.uniforms.uColor.value=e,this._component.material.uniformsNeedUpdate=!0}get primarySize(){return this._config.primarySize.value}set primarySize(e){this._config.primarySize.value=e,this._component.material.uniforms.uSize1.value=e,this._component.material.uniformsNeedUpdate=!0}get secondarySize(){return this._config.secondarySize.value}set secondarySize(e){this._config.secondarySize.value=e,this._component.material.uniforms.uSize2.value=e,this._component.material.uniformsNeedUpdate=!0}get distance(){return this._config.distance.value}set distance(e){this._config.distance.value=e,this._component.material.uniforms.uDistance.value=e,this._component.material.uniformsNeedUpdate=!0}}class G{constructor(i,e){t(this,"onDisposed",new a);t(this,"onSetup",new a);t(this,"isSetup",!1);t(this,"world");t(this,"components");t(this,"config");t(this,"_defaultConfig",{visible:!0,color:new l(12303291),primarySize:1,secondarySize:10,distance:500});t(this,"three");t(this,"_fade",3);t(this,"updateZoom",()=>{this.world.camera instanceof f&&(this.material.uniforms.uZoom.value=this.world.camera.three.zoom)});this.world=e;const{color:s,primarySize:n,secondarySize:r,distance:h}=this._defaultConfig;this.components=i,this.config=new W(this,this.components,"Grid");const g=new F(2,2,1,1),c=new U({side:k,uniforms:{uSize1:{value:n},uSize2:{value:r},uColor:{value:s},uDistance:{value:h},uFade:{value:this._fade},uZoom:{value:1}},transparent:!0,vertexShader:`
            
            varying vec3 worldPosition;
            
            uniform float uDistance;
            
            void main() {
            
                    vec3 pos = position.xzy * uDistance;
                    pos.xz += cameraPosition.xz;
                    
                    worldPosition = pos;
                    
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
            
            }
            `,fragmentShader:`
            
            varying vec3 worldPosition;
            
            uniform float uZoom;
            uniform float uFade;
            uniform float uSize1;
            uniform float uSize2;
            uniform vec3 uColor;
            uniform float uDistance;
                
                
                
                float getGrid(float size) {
                
                    vec2 r = worldPosition.xz / size;
                    
                    
                    vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);
                    float line = min(grid.x, grid.y);
                    
                
                    return 1.0 - min(line, 1.0);
                }
                
            void main() {
            
                    
                    float d = 1.0 - min(distance(cameraPosition.xz, worldPosition.xz) / uDistance, 1.0);
                    
                    float g1 = getGrid(uSize1);
                    float g2 = getGrid(uSize2);
                    
                    // Ortho camera fades the grid away when zooming out
                    float minZoom = step(0.2, uZoom);
                    float zoomFactor = pow(min(uZoom, 1.), 2.) * minZoom;
                    
                    gl_FragColor = vec4(uColor.rgb, mix(g2, g1, g1) * pow(d, uFade));
                    gl_FragColor.a = mix(0.5 * gl_FragColor.a, gl_FragColor.a, g2) * zoomFactor;
                    
                    if ( gl_FragColor.a <= 0.0 ) discard;
                    
            
            }
            
            `,extensions:{derivatives:!0}});this.three=new M(g,c),this.three.frustumCulled=!1,e.scene.three.add(this.three),this.setupEvents(!0)}get visible(){return this.three.visible}set visible(i){i?this.world.scene.three.add(this.three):this.three.removeFromParent()}get material(){return this.three.material}get fade(){return this._fade===3}set fade(i){this._fade=i?3:0,this.material.uniforms.uFade.value=this._fade}setup(i){const e={...this._defaultConfig,...i};this.config.visible=!0,this.config.color=e.color,this.config.primarySize=e.primarySize,this.config.secondarySize=e.secondarySize,this.config.distance=e.distance,this.isSetup=!0,this.onSetup.trigger()}dispose(){this.setupEvents(!1),this.components.get(L).list.delete(this.config.uuid),this.components.get(w).destroy(this.three),this.onDisposed.trigger(),this.onDisposed.reset(),this.world=null,this.components=null}setupEvents(i){if(this.world.isDisposing||!(this.world.camera instanceof f))return;const e=this.world.camera.controls;i?e.addEventListener("update",this.updateZoom):e.removeEventListener("update",this.updateZoom)}}const d=class d extends R{constructor(e){super(e);t(this,"list",new Map);t(this,"onDisposed",new a);t(this,"enabled",!0);e.add(d.uuid,this)}create(e){if(this.list.has(e.uuid))throw new Error("This world already has a grid!");const s=new G(this.components,e);return this.list.set(e.uuid,s),e.onDisposed.add(()=>{this.delete(e)}),s}delete(e){const s=this.list.get(e.uuid);s&&s.dispose(),this.list.delete(e.uuid)}dispose(){for(const[e,s]of this.list)s.dispose();this.list.clear(),this.onDisposed.trigger(),this.onDisposed.reset()}};t(d,"uuid","d1e814d5-b81c-4452-87a2-f039375e0489");let v=d;export{v as G,j as S,I as a};
