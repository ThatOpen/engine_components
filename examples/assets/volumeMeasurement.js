var F=Object.defineProperty;var W=(i,a,e)=>a in i?F(i,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[a]=e;var l=(i,a,e)=>(W(i,typeof a!="symbol"?a+"":a,e),e);import{M as A,V as C,I as B,a as L,C as P}from"./web-ifc-api-Glg4rFxW.js";import{S as j}from"./stats.min-GTpOrGrX.js";import{J as I,D,W as R,R as K}from"./import-wrapper-prod-DOkjDpKP.js";import{P as U}from"./index-Cla0sIX3.js";import{D as H}from"./types-BHr6GdIp.js";import{M as N}from"./mark-C0U8dImi.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./index-CZFmkGMI.js";const g=class g extends I{constructor(e){super(e);l(this,"label");l(this,"world");l(this,"onVolumeFound",new D);l(this,"_enabled",!1);l(this,"onDisposed",new D);l(this,"create",()=>{if(!this.enabled)return;if(!this.world)throw new Error("World is needed for Volume Measurement!");const t=this.components.get(R).get(this.world).castRay();if(!t||!t.object)return;const{object:s}=t;if(s instanceof A){const c=this.getVolumeOfMesh(s);this.onVolumeFound.trigger(c)}});l(this,"onMouseMove",()=>{});l(this,"onKeydown",e=>{});this.components.add(g.uuid,this),this.label=this.newLabel(),this.label.three.removeFromParent()}set enabled(e){this._enabled=e,this.setupEvents(e),e||this.cancelCreation()}get enabled(){return this._enabled}async dispose(){this.setupEvents(!1),this.label.dispose(),this.onDisposed.trigger(),this.onDisposed.reset(),this.components=null}delete(){}async deleteAll(){}endCreation(){}cancelCreation(){}get(){}getVolumeFromMeshes(e){if(!this.world)throw new Error("World is needed for Volume Measurement!");let n=0;for(const d of e)n+=this.getVolumeOfMesh(d);const t=this.world.scene.three,s=this.label.three;t.add(s);const c=this.components.get(K);for(const d of e)d.geometry.computeBoundingSphere(),c.addMesh(d);const m=c.getSphere();c.reset(),s.position.copy(m.center);const r=Math.trunc(n*100)/100;return s.element.textContent=r.toString(),n}newLabel(){if(!this.world)throw new Error("World is needed for Volume Measurement!");const e=document.createElement("div");return e.className=H,new N(this.world,e)}setupEvents(e){if(!this.world)throw new Error("The volume measurement needs a world to work!");if(!this.world.renderer)throw new Error("The world of the volume measurement needs a renderer!");const t=this.world.renderer.three.domElement.parentElement;e?(t.addEventListener("click",this.create),t.addEventListener("mousemove",this.onMouseMove),window.addEventListener("keydown",this.onKeydown)):(t.removeEventListener("click",this.create),t.removeEventListener("mousemove",this.onMouseMove),window.removeEventListener("keydown",this.onKeydown))}getVolumeOfMesh(e){let n=0;const t=new C,s=new C,c=new C,{index:m}=e.geometry,r=e.geometry.attributes.position.array;if(!m)return console.warn("Geometry must be indexed to compute its volume!"),0;const d=[];if(e instanceof B)for(let u=0;u<e.count;u++){const p=new L;e.getMatrixAt(u,p),d.push(p)}else d.push(new L().identity());const{matrixWorld:b}=e;for(let u=0;u<m.array.length-2;u+=3)for(const p of d){const v=p.multiply(b),M=m.array[u]*3,x=m.array[u+1]*3,E=m.array[u+2]*3;t.set(r[M],r[M+1],r[M+2]).applyMatrix4(v),s.set(r[x],r[x+1],r[x+2]).applyMatrix4(v),c.set(r[E],r[E+1],r[E+2]).applyMatrix4(v),n+=this.getSignedVolumeOfTriangle(t,s,c)}return Math.abs(n)}getSignedVolumeOfTriangle(e,n,t){const s=t.x*n.y*e.z,c=n.x*t.y*e.z,m=t.x*e.y*n.z,r=e.x*t.y*n.z,d=n.x*e.y*t.z,b=e.x*n.y*t.z;return 1/6*(-s+c+m-r-d+b)}};l(g,"uuid","811da532-7af3-4635-b592-1c06ae494af5");let V=g;const k=document.getElementById("container"),o=new(void 0),T=new(void 0)(o);T.setup();o.scene=T;const h=new U(o,k);o.renderer=h;const O=new(void 0)(o);o.camera=O;o.raycaster=new(void 0)(o);o.init();h.postproduction.enabled=!0;O.controls.setLookAt(10,10,10,0,0,0);const _=new(void 0)(o,new P(6710886)),G=h.postproduction.customEffects;G.excludedMeshes.push(_.get());const f=new V(o),S=new(void 0)(o),J=await fetch("../../../resources/small.frag"),q=await J.arrayBuffer(),Q=new Uint8Array(q);S.load(Q);const y=new(void 0)(o);y.setup();y.updateHighlight();y.events.select.onHighlight.add(i=>{const a=Object.keys(i),e=[];for(const t of a){const s=S.list[t].fragments;s.select&&e.push(s.select.mesh)}const n=f.getVolumeFromMeshes(e);console.log(n)});y.events.select.onClear.add(()=>{f.label.get().removeFromParent()});k.ondblclick=()=>f.create();k.oncontextmenu=()=>f.endCreation();window.onkeydown=i=>{i.code==="Delete"||i.code};const z=new(void 0)(o,{name:"Main Toolbar",position:"bottom"});z.addChild(f.uiElement.get("main"));o.ui.addToolbar(z);const w=new j;w.showPanel(2);document.body.append(w.dom);w.dom.style.left="0px";h.onBeforeUpdate.add(()=>w.begin());h.onAfterUpdate.add(()=>w.end());
