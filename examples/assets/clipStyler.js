var Z=Object.defineProperty;var ee=(i,s,t)=>s in i?Z(i,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[s]=t;var c=(i,s,t)=>(ee(i,typeof s!="symbol"?s+"":s,t),t);import{Y as D,G as te,d as se,f as Q,q as ne,r as oe,s as ie,n as _,V as x,P as ae,l as re,c as $,a as b,t as H,b as le,u as ce,C as P}from"./index-D_lOu8Cy.js";import{L as de,a as me,b as F}from"./LineSegments2-DMoLV2Kl.js";import{E as q,F as G,D as j,g as Y,c as pe,U as ue,h as z,C as he,W as be,S as we,O as fe,I as ge,R as ye,V as T}from"./graphic-vertex-picker-BY8Y4wOR.js";import{P as Ce}from"./index-B5aStPSH.js";class Se{constructor(s,t){c(this,"_components");c(this,"_modelStyleGeometries",new D);c(this,"onDisposed",new q);c(this,"three",new te);c(this,"plane");c(this,"items",new D);c(this,"world",null);c(this,"_visible",!1);this._components=s,this.plane=t,this.setupEvents()}set visible(s){s?this.world&&(this.world.scene.three.add(this.three),this._visible=!0):(this.three.removeFromParent(),this._visible=!1)}get visible(){return this._visible}setupEvents(){const s=this._components.get(M);this.items.guard=(t,{style:e})=>!!s.styles.get(e),this.items.onItemSet.add(({value:t})=>{const{style:e,data:n}=t;this.create(e,n)})}async getStyleMeshes(s,t){const n=this._components.get(M).styles.get(t);if(!n)throw new Error(`ClipStyler: "${t}" style not found.`);const a=this._components.get(G),o=a.list.get(s);if(!o)throw new Error(`ClipEdges: model with id "${s}" not found.`);const{linesMaterial:r,fillsMaterial:u}=n;let d=this._modelStyleGeometries.get(s);d||(d=new D,this._modelStyleGeometries.set(s,d));let f=d.get(t);if(!f){let g;r&&(g=new de(new me,r),g.frustumCulled=!1,o&&a.applyBaseCoordinateSystem(g,await o.getCoordinationMatrix()),this.three.add(g));let C;u&&(C=new se(new Q,u),o&&a.applyBaseCoordinateSystem(C,await o.getCoordinationMatrix()),this.three.add(C)),f={edges:g,fills:C},d.set(t,f)}return f}async updateMeshes(s,t,e){const n=this._components.get(G),a=n.list.get(s);if(!a)return;const o=this._components.get(j),r=this.plane.clone(),u=(await a.getCoordinationMatrix()).clone().multiply(n.baseCoordinationMatrix.clone().invert());r.applyMatrix4(u),r.constant-=.01;const d=await a.getSection(r,e),{buffer:f,index:g,fillsIndices:C}=d,X=await this.getStyleMeshes(s,t),{edges:N,fills:A}=X,I=new ne(f,3,!1);if(N){I.setUsage(oe);const O=new Q;O.setAttribute("position",I),O.setDrawRange(0,g);const R=new ie(O);N.geometry.fromLineSegments(R),o.destroy(R)}A&&(A.geometry.attributes.position=I,A.geometry.setIndex(C))}async create(s,t){if(!this._components.get(M).styles.get(s))throw new Error(`ClipEdges: "${s}" style not found.`);const a=this._components.get(Y);let o=null;t&&(o=await a.find(t));const r=this._components.get(G);if(o)for(const[u,d]of Object.entries(o))r.list.get(u)&&this.updateMeshes(u,s,[...d]);else for(const[u]of r.list)this.updateMeshes(u,s)}async update(s){for(const[t,{data:e,style:n}]of this.items)s&&!s.includes(t)||this.create(n,e)}dispose(){this._components.get(j).destroy(this.three,!0,!0),this._modelStyleGeometries.clear()}}const L=class L extends pe{constructor(t){super(t);c(this,"onDisposed",new q);c(this,"enabled",!0);c(this,"world",null);c(this,"styles",new D);c(this,"list",new D);c(this,"_visible",!0);this.components.list.set(L.uuid,this),this.setEvents()}get visible(){return this._visible}set visible(t){this._visible=t;for(const[,e]of this.list)e.visible=t}setEvents(){this.list.onBeforeDelete.add(({value:t})=>t.dispose())}setEdgesConfig(t,e){if(t.world=(e==null?void 0:e.world)??this.world,e!=null&&e.items)for(const[a,o]of Object.entries(e.items))t.items.set(a,o);const n=(e==null?void 0:e.id)??ue.create();this.list.set(n,t)}create(t,e){const n=new Se(this.components,t);return e&&this.setEdgesConfig(n,e),n}createFromView(t,e){const n=this.create(t.plane,e);return((e==null?void 0:e.link)!==void 0?e.link:!0)&&(t.onDisposed.add(()=>n.dispose()),t.onUpdated.add(()=>n.update()),t.onStateChanged.add(()=>n.visible=t.open)),n}createFromClipping(t,e){const a=this.components.get(z).list.get(t);if(!a)throw new Error(`ClipStyler: Clipping plane with ID ${t} not found.`);const o=this.create(a.three,e);return o.visible=!0,((e==null?void 0:e.link)!==void 0?e.link:!0)&&(a.onDraggingEnded.add(()=>o.update()),a.onDisposed.add(()=>o.dispose())),o}dispose(){this.styles.clear(),this.list.clear(),this.onDisposed.trigger(L.uuid)}};c(L,"uuid","24dfc306-a3c4-410f-8071-babc4afa5e4d");let M=L;const m=new he,Me=m.get(be),l=Me.create();l.scene=new we(m);l.scene.setup();l.scene.three.background=null;const J=document.getElementById("container");l.renderer=new Ce(m,J);l.camera=new fe(m);await l.camera.controls.setLookAt(68,23,-8.5,21.5,-5.5,23);m.init();const ve="https://thatopen.github.io/engine_fragment/resources/worker.mjs",y=m.get(G);y.init(ve);l.camera.controls.addEventListener("rest",()=>y.core.update(!0));l.onCameraChanged.add(i=>{var s;for(const[,t]of y.list)t.useCamera(i.three);y.core.update(!0),(s=l.renderer)==null||s.postproduction.updateCamera()});y.list.onItemSet.add(({value:i})=>{i.useCamera(l.camera.three),l.scene.three.add(i.object),y.core.update(!0)});const ke=["https://thatopen.github.io/engine_components/resources/frags/school_arq.frag"];await Promise.all(ke.map(async i=>{var n;const s=(n=i.split("/").pop())==null?void 0:n.split(".").shift();if(!s)return null;const e=await(await fetch(i)).arrayBuffer();return y.core.load(e,{modelId:s})}));const p=m.get(M);p.world=l;p.styles.set("Blue",{linesMaterial:new F({color:"black",linewidth:2}),fillsMaterial:new _({color:"lightblue",side:2})});p.styles.set("Red",{linesMaterial:new F({color:"black",linewidth:3}),fillsMaterial:new _({color:"salmon",side:2})});p.styles.set("Green",{linesMaterial:new F({color:"black",linewidth:2}),fillsMaterial:new _({color:"lightgreen",side:2})});p.styles.set("Black",{linesMaterial:new F({color:"black",linewidth:2}),fillsMaterial:new _({color:"black",side:2})});p.styles.set("BlackFill",{fillsMaterial:new _({color:"black",side:2})});const v=m.get(ge);v.create("Walls",[{categories:[/WALL/]}]);v.create("Slabs",[{categories:[/SLAB/]}]);v.create("Columns",[{categories:[/COLUMN/]}]);v.create("Doors",[{categories:[/DOOR/]}]);v.create("Curtains",[{categories:[/PLATE/,/MEMBER/]}]);v.create("Windows",[{categories:[/WINDOW/]}]);const k=m.get(Y),h="ClipperGroups";k.setGroupQuery(h,"Walls",{name:"Walls"});k.setGroupQuery(h,"Slabs",{name:"Slabs"});k.setGroupQuery(h,"Columns",{name:"Columns"});k.setGroupQuery(h,"Doors",{name:"Doors"});k.setGroupQuery(h,"Curtains",{name:"Curtains"});k.setGroupQuery(h,"Windows",{name:"Windows"});const Ee=m.get(ye);Ee.get(l);const w=m.get(z);w.enabled=!0;J.ondblclick=()=>{w.enabled&&w.create(l)};window.onkeydown=i=>{(i.code==="Delete"||i.code==="Backspace")&&w.enabled&&w.delete(l)};w.list.onItemSet.add(({key:i})=>{p.createFromClipping(i,{items:{All:{style:"BlackFill"}}})});w.createFromNormalAndCoplanarPoint(l,new x(0,-1,0),new x(0,3,0));const S=m.get(T),V=S.createFromPlane(new ae(new x(-1,0,0),35),{id:"Section",world:l});V.range=5;V.helpersVisible=!0;p.createFromView(V,{items:{ArchElements:{style:"Blue",data:{[h]:["Walls","Slabs","Curtains","Windows"]}}}});const[U]=await S.createFromIfcStoreys({storeyNames:[/03/],world:l,offset:1});U.helpersVisible=!0;const De=p.createFromView(U,{items:{Walls:{style:"Blue",data:{[h]:["Walls"]}},Columns:{style:"Red",data:{[h]:["Columns"]}},Doors:{style:"Green",data:{[h]:["Doors"]}}}});De.items.set("Curtains & Windows",{style:"Black",data:{[h]:["Curtains","Windows"]}});const K=()=>{for(const[,i]of w.list)i.enabled=!S.hasOpenViews,i.visible=!S.hasOpenViews;for(const[,i]of S.list)i.helpersVisible=!S.hasOpenViews};U.onStateChanged.add(K);V.onStateChanged.add(K);re.init();const Le=i=>{const{components:s}=i,t=s.get(T);return b`<bim-table ${H(n=>{if(!n)return;const a=n;a.data=[...t.list.keys()].map(o=>({data:{Name:o,Actions:""}}))})}></bim-table>`},[B]=$.create(Le,{components:m});B.headersHidden=!0;B.noIndentation=!0;B.columns=["Name",{name:"Actions",width:"auto"}];B.dataTransform={Actions:(i,s)=>{const{Name:t}=s;if(!t)return i;const e=m.get(T);return e.list.get(t)?b`
      <bim-button label-hidden icon="solar:cursor-bold" label="Open" @click=${()=>{e.open(t)}}></bim-button>
      <bim-button label-hidden icon="material-symbols:close" label="Close" @click=${()=>{e.close(t)}}></bim-button>
    `:i}};const _e=$.create(()=>b`<bim-table no-indentation ${H(s=>{if(!(s instanceof ce))return;const t=s;t.dataTransform={LineWidth:(e,n)=>{const a=n.Name,o=p.styles.get(a);if(!o)return e;const{linesMaterial:r}=o;return r?b`
          <bim-number-input .value=${e} min=0.5 max=10 slider step=0.05 @change=${({target:d})=>{r.linewidth=d.value}}></bim-number-input>
        `:e},LineColor:(e,n)=>{const a=n.Name,o=p.styles.get(a);if(!o)return e;const{linesMaterial:r}=o;return r?b`
          <bim-color-input .color=${e} @input=${({target:d})=>{r.color=new P(d.color)}}></bim-color-input>
        `:e},FillColor:(e,n)=>{const a=n.Name,o=p.styles.get(a);if(!o)return e;const{fillsMaterial:r}=o;return r?b`
          <bim-color-input .color=${e} @input=${({target:d})=>{"color"in r&&r.color instanceof P&&(r.color=new P(d.color))}}></bim-color-input>
        `:e}},t.data=Array.from(p.styles.entries()).map(([e,n])=>{const a=n.linesMaterial,o=n.fillsMaterial,r={data:{Name:e}};return a&&(r.data.LineWidth=a.linewidth,r.data.LineColor=`#${a.color.getHexString()}`),o&&(r.data.FillColor=`#${o.color.getHexString()}`),r})})}></bim-table>`),W=$.create(()=>b`
    <bim-panel active label="Clip Styler Tutorial" class="options-menu">
      <bim-panel-section label="Styles">
        <bim-label style="white-space: normal;">Here you can manage the clipping styles of your app. Try to change some of these while a view is open to see the effect.</bim-label>
        ${_e}
      </bim-panel-section>
      <bim-panel-section label="Views">
        <bim-label style="white-space: normal;">These are the views created in the project. They are linked to the clipping styles.</bim-label>
        ${B}
      </bim-panel-section>
    </bim-panel>
  `);document.body.append(W);const Be=$.create(()=>b`
      <bim-button class="phone-menu-toggler" icon="solar:settings-bold"
        @click="${()=>{W.classList.contains("options-menu-visible")?W.classList.remove("options-menu-visible"):W.classList.add("options-menu-visible")}}">
      </bim-button>
    `);document.body.append(Be);const E=new le;E.showPanel(2);document.body.append(E.dom);E.dom.style.left="0px";E.dom.style.zIndex="unset";l.renderer.onBeforeUpdate.add(()=>E.begin());l.renderer.onAfterUpdate.add(()=>E.end());
