var Z=Object.defineProperty;var ee=(o,s,t)=>s in o?Z(o,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[s]=t;var c=(o,s,t)=>(ee(o,typeof s!="symbol"?s+"":s,t),t);import{Y as E,G as te,d as se,B as N,q as ne,r as oe,s as ie,n as B,V as x,P as ae,l as re,c as W,a as b,t as H,b as le,u as ce,C as U}from"./index-BET5fVdQ.js";import{L as de,a as me,b as $}from"./LineSegments2-cAwJmrXE.js";import{E as q,F,D as Q,h as Y,c as pe,U as ue,i as z,C as he,W as be,S as fe,O as we,I as ge,R as ye,V as P}from"./graphic-vertex-picker-D88BIZW2.js";import{P as Ce}from"./index-oGDxbV82.js";class Se{constructor(s,t){c(this,"_components");c(this,"_modelStyleGeometries",new E);c(this,"onDisposed",new q);c(this,"three",new te);c(this,"plane");c(this,"items",new E);c(this,"world",null);c(this,"_visible",!1);this._components=s,this.plane=t,this.setupEvents()}set visible(s){s?this.world&&(this.world.scene.three.add(this.three),this._visible=!0):(this.three.removeFromParent(),this._visible=!1)}get visible(){return this._visible}setupEvents(){const s=this._components.get(M);this.items.guard=(t,{style:e})=>!!s.styles.get(e),this.items.onItemSet.add(({value:t})=>{const{style:e,data:n}=t;this.create(e,n)})}async getStyleMeshes(s,t){const n=this._components.get(M).styles.get(t);if(!n)throw new Error(`ClipStyler: "${t}" style not found.`);const a=this._components.get(F),i=a.list.get(s);if(!i)throw new Error(`ClipEdges: model with id "${s}" not found.`);const{linesMaterial:r,fillsMaterial:u}=n;let d=this._modelStyleGeometries.get(s);d||(d=new E,this._modelStyleGeometries.set(s,d));let g=d.get(t);if(!g){let y;r&&(y=new de(new me,r),y.frustumCulled=!1,i&&a.applyBaseCoordinateSystem(y,await i.getCoordinationMatrix()),this.three.add(y));let C;u&&(C=new se(new N,u),i&&a.applyBaseCoordinateSystem(C,await i.getCoordinationMatrix()),this.three.add(C)),g={edges:y,fills:C},d.set(t,g)}return g}async updateMeshes(s,t,e){const n=this._components.get(F),a=n.list.get(s);if(!a)return;const i=this._components.get(Q),r=this.plane.clone(),u=(await a.getCoordinationMatrix()).clone().multiply(n.baseCoordinationMatrix.clone().invert());r.applyMatrix4(u),r.constant-=.01;const d=await a.getSection(r,e),{buffer:g,index:y,fillsIndices:C}=d,X=await this.getStyleMeshes(s,t),{edges:T,fills:V}=X,I=new ne(g,3,!1);if(T){I.setUsage(oe);const A=new N;A.setAttribute("position",I),A.setDrawRange(0,y);const j=new ie(A);T.geometry.fromLineSegments(j),i.destroy(j)}V&&(V.geometry.attributes.position=I,V.geometry.setIndex(C))}async create(s,t){if(!this._components.get(M).styles.get(s))throw new Error(`ClipEdges: "${s}" style not found.`);const a=this._components.get(Y);let i=null;t&&(i=await a.find(t));const r=this._components.get(F);if(i)for(const[u,d]of Object.entries(i))r.list.get(u)&&this.updateMeshes(u,s,[...d]);else for(const[u]of r.list)this.updateMeshes(u,s)}async update(s){for(const[t,{data:e,style:n}]of this.items)s&&!s.includes(t)||this.create(n,e)}dispose(){this._components.get(Q).destroy(this.three,!0,!0),this._modelStyleGeometries.clear()}}const D=class D extends pe{constructor(t){super(t);c(this,"onDisposed",new q);c(this,"enabled",!0);c(this,"world",null);c(this,"styles",new E);c(this,"list",new E);c(this,"_visible",!0);this.components.list.set(D.uuid,this),this.setEvents()}get visible(){return this._visible}set visible(t){this._visible=t;for(const[,e]of this.list)e.visible=t}setEvents(){this.list.onBeforeDelete.add(({value:t})=>t.dispose())}setEdgesConfig(t,e){if(t.world=(e==null?void 0:e.world)??this.world,e!=null&&e.items)for(const[a,i]of Object.entries(e.items))t.items.set(a,i);const n=(e==null?void 0:e.id)??ue.create();this.list.set(n,t)}create(t,e){const n=new Se(this.components,t);return e&&this.setEdgesConfig(n,e),n}createFromView(t,e){const n=this.create(t.plane,e);return((e==null?void 0:e.link)!==void 0?e.link:!0)&&(t.onDisposed.add(()=>n.dispose()),t.onUpdated.add(()=>n.update()),t.onStateChanged.add(()=>n.visible=t.open)),n}createFromClipping(t,e){const a=this.components.get(z).list.get(t);if(!a)throw new Error(`ClipStyler: Clipping plane with ID ${t} not found.`);const i=this.create(a.three,e);return i.visible=!0,((e==null?void 0:e.link)!==void 0?e.link:!0)&&(a.onDraggingEnded.add(()=>i.update()),a.onDisposed.add(()=>i.dispose())),i}dispose(){this.styles.clear(),this.list.clear(),this.onDisposed.trigger(D.uuid)}};c(D,"uuid","24dfc306-a3c4-410f-8071-babc4afa5e4d");let M=D;const m=new he,Me=m.get(be),l=Me.create();l.scene=new fe(m);l.scene.setup();l.scene.three.background=null;const J=document.getElementById("container");l.renderer=new Ce(m,J);l.camera=new we(m);await l.camera.controls.setLookAt(68,23,-8.5,21.5,-5.5,23);m.init();const ve="https://thatopen.github.io/engine_fragment/resources/worker.mjs",ke=await fetch(ve),Le=await ke.blob(),Ee=new File([Le],"worker.mjs",{type:"text/javascript"}),De=URL.createObjectURL(Ee),f=m.get(F);f.init(De);l.camera.controls.addEventListener("update",()=>f.core.update());l.onCameraChanged.add(o=>{var s;for(const[,t]of f.list)t.useCamera(o.three);f.core.update(!0),(s=l.renderer)==null||s.postproduction.updateCamera()});f.list.onItemSet.add(({value:o})=>{o.useCamera(l.camera.three),l.scene.three.add(o.object),f.core.update(!0)});f.core.models.materials.list.onItemSet.add(({value:o})=>{"isLodMaterial"in o&&o.isLodMaterial||(o.polygonOffset=!0,o.polygonOffsetUnits=1,o.polygonOffsetFactor=Math.random())});const Be=["https://thatopen.github.io/engine_components/resources/frags/school_arq.frag"];await Promise.all(Be.map(async o=>{var n;const s=(n=o.split("/").pop())==null?void 0:n.split(".").shift();if(!s)return null;const e=await(await fetch(o)).arrayBuffer();return f.core.load(e,{modelId:s})}));const p=m.get(M);p.world=l;p.styles.set("Blue",{linesMaterial:new $({color:"black",linewidth:2}),fillsMaterial:new B({color:"lightblue",side:2})});p.styles.set("Red",{linesMaterial:new $({color:"black",linewidth:3}),fillsMaterial:new B({color:"salmon",side:2})});p.styles.set("Green",{linesMaterial:new $({color:"black",linewidth:2}),fillsMaterial:new B({color:"lightgreen",side:2})});p.styles.set("Black",{linesMaterial:new $({color:"black",linewidth:2}),fillsMaterial:new B({color:"black",side:2})});p.styles.set("BlackFill",{fillsMaterial:new B({color:"black",side:2})});const v=m.get(ge);v.create("Walls",[{categories:[/WALL/]}]);v.create("Slabs",[{categories:[/SLAB/]}]);v.create("Columns",[{categories:[/COLUMN/]}]);v.create("Doors",[{categories:[/DOOR/]}]);v.create("Curtains",[{categories:[/PLATE/,/MEMBER/]}]);v.create("Windows",[{categories:[/WINDOW/]}]);const k=m.get(Y),h="ClipperGroups";k.setGroupQuery(h,"Walls",{name:"Walls"});k.setGroupQuery(h,"Slabs",{name:"Slabs"});k.setGroupQuery(h,"Columns",{name:"Columns"});k.setGroupQuery(h,"Doors",{name:"Doors"});k.setGroupQuery(h,"Curtains",{name:"Curtains"});k.setGroupQuery(h,"Windows",{name:"Windows"});const _e=m.get(ye);_e.get(l);const w=m.get(z);w.enabled=!0;J.ondblclick=()=>{w.enabled&&w.create(l)};window.onkeydown=o=>{(o.code==="Delete"||o.code==="Backspace")&&w.enabled&&w.delete(l)};w.list.onItemSet.add(({key:o})=>{p.createFromClipping(o,{items:{All:{style:"BlackFill"}}})});w.createFromNormalAndCoplanarPoint(l,new x(0,-1,0),new x(0,4,0));const S=m.get(P),O=S.createFromPlane(new ae(new x(-1,0,0),35),{id:"Section",world:l});O.range=5;O.helpersVisible=!0;p.createFromView(O,{items:{ArchElements:{style:"Blue",data:{[h]:["Walls","Slabs","Curtains","Windows"]}}}});const[R]=await S.createFromIfcStoreys({storeyNames:[/03/],world:l,offset:1});R.helpersVisible=!0;const Fe=p.createFromView(R,{items:{Walls:{style:"Blue",data:{[h]:["Walls"]}},Columns:{style:"Red",data:{[h]:["Columns"]}},Doors:{style:"Green",data:{[h]:["Doors"]}}}});Fe.items.set("Curtains & Windows",{style:"Black",data:{[h]:["Curtains","Windows"]}});const K=()=>{for(const[,o]of w.list)o.enabled=!S.hasOpenViews,o.visible=!S.hasOpenViews;for(const[,o]of S.list)o.helpersVisible=!S.hasOpenViews};R.onStateChanged.add(K);O.onStateChanged.add(K);re.init();const Ge=o=>{const{components:s}=o,t=s.get(P);return b`<bim-table ${H(n=>{if(!n)return;const a=n;a.data=[...t.list.keys()].map(i=>({data:{Name:i,Actions:""}}))})}></bim-table>`},[_]=W.create(Ge,{components:m});_.headersHidden=!0;_.noIndentation=!0;_.columns=["Name",{name:"Actions",width:"auto"}];_.dataTransform={Actions:(o,s)=>{const{Name:t}=s;if(!t)return o;const e=m.get(P);return e.list.get(t)?b`
      <bim-button label-hidden icon="solar:cursor-bold" label="Open" @click=${()=>{e.open(t)}}></bim-button>
      <bim-button label-hidden icon="material-symbols:close" label="Close" @click=${()=>{e.close(t)}}></bim-button>
    `:o}};const We=W.create(()=>b`<bim-table no-indentation ${H(s=>{if(!(s instanceof ce))return;const t=s;t.dataTransform={LineWidth:(e,n)=>{const a=n.Name,i=p.styles.get(a);if(!i)return e;const{linesMaterial:r}=i;return r?b`
          <bim-number-input .value=${e} min=0.5 max=10 slider step=0.05 @change=${({target:d})=>{r.linewidth=d.value}}></bim-number-input>
        `:e},LineColor:(e,n)=>{const a=n.Name,i=p.styles.get(a);if(!i)return e;const{linesMaterial:r}=i;return r?b`
          <bim-color-input .color=${e} @input=${({target:d})=>{r.color=new U(d.color)}}></bim-color-input>
        `:e},FillColor:(e,n)=>{const a=n.Name,i=p.styles.get(a);if(!i)return e;const{fillsMaterial:r}=i;return r?b`
          <bim-color-input .color=${e} @input=${({target:d})=>{"color"in r&&r.color instanceof U&&(r.color=new U(d.color))}}></bim-color-input>
        `:e}},t.data=Array.from(p.styles.entries()).map(([e,n])=>{const a=n.linesMaterial,i=n.fillsMaterial,r={data:{Name:e}};return a&&(r.data.LineWidth=a.linewidth,r.data.LineColor=`#${a.color.getHexString()}`),i&&(r.data.FillColor=`#${i.color.getHexString()}`),r})})}></bim-table>`),G=W.create(()=>b`
    <bim-panel active label="Clip Styler Tutorial" class="options-menu">
      <bim-panel-section label="Styles">
        <bim-label style="white-space: normal;">Here you can manage the clipping styles of your app. Try to change some of these while a view is open to see the effect.</bim-label>
        ${We}
      </bim-panel-section>
      <bim-panel-section label="Views">
        <bim-label style="white-space: normal;">These are the views created in the project. They are linked to the clipping styles.</bim-label>
        ${_}
      </bim-panel-section>
    </bim-panel>
  `);document.body.append(G);const $e=W.create(()=>b`
      <bim-button class="phone-menu-toggler" icon="solar:settings-bold"
        @click="${()=>{G.classList.contains("options-menu-visible")?G.classList.remove("options-menu-visible"):G.classList.add("options-menu-visible")}}">
      </bim-button>
    `);document.body.append($e);const L=new le;L.showPanel(2);document.body.append(L.dom);L.dom.style.left="0px";L.dom.style.zIndex="unset";l.renderer.onBeforeUpdate.add(()=>L.begin());l.renderer.onAfterUpdate.add(()=>L.end());
