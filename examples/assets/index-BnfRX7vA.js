var x=Object.defineProperty;var I=(u,e,t)=>e in u?x(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var a=(u,e,t)=>(I(u,typeof e!="symbol"?e+"":e,t),t);import{Y as R}from"./index-D_lOu8Cy.js";import{U as z,d as A,F as v,M as w}from"./index-BXecBxnk.js";class E{constructor(e,t){a(this,"name","Query");a(this,"customData",{});a(this,"_components");a(this,"_queries",[]);a(this,"_aggregation","exclusive");a(this,"result",null);a(this,"cache",!0);a(this,"serializeQueryParameters",e=>{var s;return{categories:(s=e.categories)==null?void 0:s.map(i=>i.source),attributes:e.attributes?{aggregation:e.attributes.aggregation,queries:e.attributes.queries.map(this.serializeAttributeQuery)}:void 0,relation:e.relation?{name:e.relation.name,query:e.relation.query?this.serializeQueryParameters(e.relation.query):void 0}:void 0}});a(this,"deserializeQueryParameters",e=>{var s;return{categories:(s=e.categories)==null?void 0:s.map(i=>new RegExp(i)),attributes:e.attributes?{aggregation:e.attributes.aggregation,queries:e.attributes.queries.map(this.deserializeAttributeQuery)}:void 0,relation:e.relation?{name:e.relation.name,query:e.relation.query?this.deserializeQueryParameters(e.relation.query):void 0}:void 0}});this._components=e,this.queries=t}set queries(e){this._queries=e,this.clearCache()}get queries(){return this._queries}set aggregation(e){e!==this._aggregation&&this.clearCache(),this._aggregation=e}get aggregation(){return this._aggregation}async test(e){const{modelIds:t,force:s}={force:!1,...e};if(this.result&&!s)return this.result;const n=await this._components.get(m).getItems(this.queries,{modelIds:t,aggregation:this.aggregation});return this.cache&&(this.result=n),n}clearCache(){this.result=null}serializeAttributeQuery(e){let t;return Array.isArray(e.value)?t=e.value.map(i=>i.source):e.value instanceof RegExp?t=e.value.source:t=e.value,{name:e.name.source,value:t,type:e.type instanceof RegExp?e.type.source:e.type,negate:e.negate,itemIds:e.itemIds}}toJSON(){return{guid:this._components.get(m).list.getKey(this)??z.create(),name:this.name,customData:this.customData,queries:this.queries.map(this.serializeQueryParameters),aggregation:this.aggregation,cache:this.cache}}deserializeAttributeQuery(e){let t;return Array.isArray(e.value)?t=e.value.map(i=>new RegExp(i)):typeof e.value=="string"?t=new RegExp(e.value):t=e.value,{name:new RegExp(e.name),value:t,type:e.type?new RegExp(e.type):void 0,negate:e.negate,itemIds:e.itemIds}}fromJSON(e){return this.name=e.name,this.customData=e.customData,this.aggregation=e.aggregation,this.cache=e.cache,this.queries=e.queries.map(this.deserializeQueryParameters),this}}const h=class h extends A{constructor(t){super(t);a(this,"enabled",!0);a(this,"list",new R);t.add(h.uuid,this)}async getItems(t,s){let i;if(s){const{modelIds:r,items:c}=s;if(c){const l=Object.keys(c);l.length>0&&(i=l.map(d=>new RegExp(`^${d}$`)))}else r&&(i=r)}const n=(s==null?void 0:s.aggregation)??"exclusive",o=this.components.get(v),g=await Promise.all(t.map(async r=>{const c={};return await Promise.all(Array.from(o.list).map(async([l,d])=>{var y;if(i&&!i.some(b=>b.test(l)))return;const p=(y=s==null?void 0:s.items)==null?void 0:y[l],Q=await d.getItemsByQuery(r,{localIds:p?[...p]:void 0});c[l]=new Set(Q)})),c}));return n==="inclusive"?w.join(g):w.intersect(g)}create(t,s){const i=new E(this.components,s);return this.list.set(t,i),i}async addFromCategories(t){const s=new Set,i=this.components.get(v);for(const[n,o]of i.list){if(t&&!t.some(r=>r.test(n)))continue;const g=(await o.getItemsWithGeometryCategories()).filter(r=>r!==null),f=new Set(g);for(const r of f)this.list.has(r)||(this.create(r,[{categories:[new RegExp(`^${r}$`)]}]),s.add(r))}return[...s]}import(t){const{data:s}=t,i=[];if(!s)return i;for(const n of s){const o=this.create(n.guid,[]);o.fromJSON(n),i.push(o)}return i}export(){const t=[];for(const[s,i]of this.list.entries()){const o={...i.toJSON(),name:s};t.push(o)}return{data:t}}};a(h,"uuid","0da7ad77-f734-42ca-942f-a074adfd1e3a");let m=h;export{m as I};
