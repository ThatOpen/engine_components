var Br=Object.defineProperty;var Rr=(a,e,t)=>e in a?Br(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var C=(a,e,t)=>(Rr(a,typeof e!="symbol"?e+"":e,t),t);import{Y as Vt,C as $t,V as Z,h as jt,y as It,ak as Ur,W as me,j as Lt,w as Fr,a0 as Vr,a1 as Hr,n as Ai,d as it,ah as an,ae as $r,aO as Zr,aP as Yr,aN as Tn,O as ln,S as is,at as _r,aC as jr,aD as Xr,aE as se,af as Wr,aF as qr,q as yr,P as cn,L as ge,an as _i,aM as Gr,D as hn,aG as Cn,as as Qr,x as Kr,f as ss,aU as Pi,aV as Jr,aH as to,av as ns,m as eo,au as Bt,B as Dt,F as En,aI as Ii,g as ye,aJ as ei,aK as io,aL as so,ar as wr,ap as no,ao as ro,z as oo}from"./index-D_lOu8Cy.js";class rt{constructor(){C(this,"enabled",!0);C(this,"trigger",e=>{if(!this.enabled)return;const t=this.handlers.slice(0);for(const i of t)i(e)});C(this,"handlers",[])}add(e){this.handlers.push(e)}remove(e){this.handlers=this.handlers.filter(t=>t!==e)}reset(){this.handlers.length=0}}class un{constructor(e){C(this,"isDisposeable",()=>"dispose"in this&&"onDisposed"in this);C(this,"isResizeable",()=>"resize"in this&&"getSize"in this);C(this,"isUpdateable",()=>"onAfterUpdate"in this&&"onBeforeUpdate"in this&&"update"in this);C(this,"isHideable",()=>"visible"in this);C(this,"isConfigurable",()=>"setup"in this&&"config"in this&&"onSetup"in this);C(this,"isSerializable",()=>"import"in this&&"export"in this);this.components=e}}class te extends un{}class dn extends un{constructor(t){super(t);C(this,"worlds",new Vt);C(this,"onWorldChanged",new rt);C(this,"_currentWorld",null);this.onWorldChanged.add(({world:i,action:s})=>{s==="removed"&&this.worlds.delete(i.uuid)})}set currentWorld(t){this._currentWorld=t}get currentWorld(){return this._currentWorld}}class ao extends dn{constructor(){super(...arguments);C(this,"hasCameraControls",()=>"controls"in this)}}class lo extends dn{constructor(){super(...arguments);C(this,"onAfterUpdate",new rt);C(this,"onBeforeUpdate",new rt);C(this,"onDisposed",new rt);C(this,"onResize",new rt);C(this,"onClippingPlanesUpdated",new rt);C(this,"clippingPlanes",[])}updateClippingPlanes(){this.onClippingPlanesUpdated.trigger()}setPlane(t,i,s){i.isLocal=s;const n=this.clippingPlanes.indexOf(i);t&&n===-1?this.clippingPlanes.push(i):!t&&n>-1&&this.clippingPlanes.splice(n,1),this.three.clippingPlanes=this.clippingPlanes.filter(r=>!r.isLocal)}}const vi=class vi extends te{constructor(t){super(t);C(this,"_disposedComponents",new Set);C(this,"enabled",!0);t.add(vi.uuid,this)}get(){return this._disposedComponents}destroy(t,i=!0,s=!0){t.removeFromParent();const n=t;n.dispose&&n.dispose(),this.disposeGeometryAndMaterials(t,i),s&&n.children&&n.children.length&&this.disposeChildren(n),t.children.length=0}disposeGeometry(t){t.boundsTree&&t.disposeBoundsTree&&t.disposeBoundsTree(),t.dispose()}disposeGeometryAndMaterials(t,i){const s=t;s.geometry&&this.disposeGeometry(s.geometry),i&&s.material&&vi.disposeMaterial(s),s.material=[],s.geometry=null}disposeChildren(t){for(const i of t.children)this.destroy(i)}static disposeMaterial(t){if(t.material)if(Array.isArray(t.material))for(const i of t.material)i.dispose();else t.material.dispose()}};C(vi,"uuid","76e9cd8e-ad8f-4753-9ef6-cbc60f7247fe");let rs=vi;class co extends dn{constructor(t){super(t);C(this,"onDisposed",new rt);C(this,"directionalLights",new Map);C(this,"ambientLights",new Map)}dispose(){const t=this.components.get(rs);for(const i of this.three.children){const s=i;s.geometry&&t.destroy(s)}this.deleteAllLights(),this.three.children=[],this.onDisposed.trigger(),this.onDisposed.reset()}deleteAllLights(){for(const[,t]of this.directionalLights)t.removeFromParent(),t.target.removeFromParent(),t.dispose();this.directionalLights.clear();for(const[,t]of this.ambientLights)t.removeFromParent(),t.dispose();this.ambientLights.clear()}}const At=class At{static create(){const e=Math.random()*4294967295|0,t=Math.random()*4294967295|0,i=Math.random()*4294967295|0,s=Math.random()*4294967295|0;return`${At._lut[e&255]+At._lut[e>>8&255]+At._lut[e>>16&255]+At._lut[e>>24&255]}-${At._lut[t&255]}${At._lut[t>>8&255]}-${At._lut[t>>16&15|64]}${At._lut[t>>24&255]}-${At._lut[i&63|128]}${At._lut[i>>8&255]}-${At._lut[i>>16&255]}${At._lut[i>>24&255]}${At._lut[s&255]}${At._lut[s>>8&255]}${At._lut[s>>16&255]}${At._lut[s>>24&255]}`.toLowerCase()}static validate(e){if(!At._pattern.test(e))throw new Error(`${e} is not a valid UUID v4.

- If you're the tool creator, you can take one from https://www.uuidgenerator.net/.

- If you're using a platform tool, verify the uuid isn't misspelled or contact the tool creator.`)}};C(At,"_pattern",/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/),C(At,"_lut",["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"]);let Zt=At;var fn={},ys={};(function(a){const e=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",t=e+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",i="["+e+"]["+t+"]*",s=new RegExp("^"+i+"$"),n=function(o,l){const c=[];let u=l.exec(o);for(;u;){const h=[];h.startIndex=l.lastIndex-u[0].length;const p=u.length;for(let d=0;d<p;d++)h.push(u[d]);c.push(h),u=l.exec(o)}return c},r=function(o){const l=s.exec(o);return!(l===null||typeof l>"u")};a.isExist=function(o){return typeof o<"u"},a.isEmptyObject=function(o){return Object.keys(o).length===0},a.merge=function(o,l,c){if(l){const u=Object.keys(l),h=u.length;for(let p=0;p<h;p++)c==="strict"?o[u[p]]=[l[u[p]]]:o[u[p]]=l[u[p]]}},a.getValue=function(o){return a.isExist(o)?o:""},a.isName=r,a.getAllMatches=n,a.nameRegexp=i})(ys);const pn=ys,ho={allowBooleanAttributes:!1,unpairedTags:[]};fn.validate=function(a,e){e=Object.assign({},ho,e);const t=[];let i=!1,s=!1;a[0]==="\uFEFF"&&(a=a.substr(1));for(let n=0;n<a.length;n++)if(a[n]==="<"&&a[n+1]==="?"){if(n+=2,n=Sn(a,n),n.err)return n}else if(a[n]==="<"){let r=n;if(n++,a[n]==="!"){n=On(a,n);continue}else{let o=!1;a[n]==="/"&&(o=!0,n++);let l="";for(;n<a.length&&a[n]!==">"&&a[n]!==" "&&a[n]!=="	"&&a[n]!==`
`&&a[n]!=="\r";n++)l+=a[n];if(l=l.trim(),l[l.length-1]==="/"&&(l=l.substring(0,l.length-1),n--),!wo(l)){let h;return l.trim().length===0?h="Invalid space after '<'.":h="Tag '"+l+"' is an invalid name.",St("InvalidTag",h,Rt(a,n))}const c=po(a,n);if(c===!1)return St("InvalidAttr","Attributes for '"+l+"' have open quote.",Rt(a,n));let u=c.value;if(n=c.index,u[u.length-1]==="/"){const h=n-u.length;u=u.substring(0,u.length-1);const p=Pn(u,e);if(p===!0)i=!0;else return St(p.err.code,p.err.msg,Rt(a,h+p.err.line))}else if(o)if(c.tagClosed){if(u.trim().length>0)return St("InvalidTag","Closing tag '"+l+"' can't have attributes or invalid starting.",Rt(a,r));if(t.length===0)return St("InvalidTag","Closing tag '"+l+"' has not been opened.",Rt(a,r));{const h=t.pop();if(l!==h.tagName){let p=Rt(a,h.tagStartPos);return St("InvalidTag","Expected closing tag '"+h.tagName+"' (opened in line "+p.line+", col "+p.col+") instead of closing tag '"+l+"'.",Rt(a,r))}t.length==0&&(s=!0)}}else return St("InvalidTag","Closing tag '"+l+"' doesn't have proper closing.",Rt(a,n));else{const h=Pn(u,e);if(h!==!0)return St(h.err.code,h.err.msg,Rt(a,n-u.length+h.err.line));if(s===!0)return St("InvalidXml","Multiple possible root nodes found.",Rt(a,n));e.unpairedTags.indexOf(l)!==-1||t.push({tagName:l,tagStartPos:r}),i=!0}for(n++;n<a.length;n++)if(a[n]==="<")if(a[n+1]==="!"){n++,n=On(a,n);continue}else if(a[n+1]==="?"){if(n=Sn(a,++n),n.err)return n}else break;else if(a[n]==="&"){const h=_o(a,n);if(h==-1)return St("InvalidChar","char '&' is not expected.",Rt(a,n));n=h}else if(s===!0&&!An(a[n]))return St("InvalidXml","Extra text at the end",Rt(a,n));a[n]==="<"&&n--}}else{if(An(a[n]))continue;return St("InvalidChar","char '"+a[n]+"' is not expected.",Rt(a,n))}if(i){if(t.length==1)return St("InvalidTag","Unclosed tag '"+t[0].tagName+"'.",Rt(a,t[0].tagStartPos));if(t.length>0)return St("InvalidXml","Invalid '"+JSON.stringify(t.map(n=>n.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return St("InvalidXml","Start tag expected.",1);return!0};function An(a){return a===" "||a==="	"||a===`
`||a==="\r"}function Sn(a,e){const t=e;for(;e<a.length;e++)if(a[e]=="?"||a[e]==" "){const i=a.substr(t,e-t);if(e>5&&i==="xml")return St("InvalidXml","XML declaration allowed only at the start of the document.",Rt(a,e));if(a[e]=="?"&&a[e+1]==">"){e++;break}else continue}return e}function On(a,e){if(a.length>e+5&&a[e+1]==="-"&&a[e+2]==="-"){for(e+=3;e<a.length;e++)if(a[e]==="-"&&a[e+1]==="-"&&a[e+2]===">"){e+=2;break}}else if(a.length>e+8&&a[e+1]==="D"&&a[e+2]==="O"&&a[e+3]==="C"&&a[e+4]==="T"&&a[e+5]==="Y"&&a[e+6]==="P"&&a[e+7]==="E"){let t=1;for(e+=8;e<a.length;e++)if(a[e]==="<")t++;else if(a[e]===">"&&(t--,t===0))break}else if(a.length>e+9&&a[e+1]==="["&&a[e+2]==="C"&&a[e+3]==="D"&&a[e+4]==="A"&&a[e+5]==="T"&&a[e+6]==="A"&&a[e+7]==="["){for(e+=8;e<a.length;e++)if(a[e]==="]"&&a[e+1]==="]"&&a[e+2]===">"){e+=2;break}}return e}const uo='"',fo="'";function po(a,e){let t="",i="",s=!1;for(;e<a.length;e++){if(a[e]===uo||a[e]===fo)i===""?i=a[e]:i!==a[e]||(i="");else if(a[e]===">"&&i===""){s=!0;break}t+=a[e]}return i!==""?!1:{value:t,index:e,tagClosed:s}}const mo=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function Pn(a,e){const t=pn.getAllMatches(a,mo),i={};for(let s=0;s<t.length;s++){if(t[s][1].length===0)return St("InvalidAttr","Attribute '"+t[s][2]+"' has no space in starting.",ii(t[s]));if(t[s][3]!==void 0&&t[s][4]===void 0)return St("InvalidAttr","Attribute '"+t[s][2]+"' is without value.",ii(t[s]));if(t[s][3]===void 0&&!e.allowBooleanAttributes)return St("InvalidAttr","boolean attribute '"+t[s][2]+"' is not allowed.",ii(t[s]));const n=t[s][2];if(!yo(n))return St("InvalidAttr","Attribute '"+n+"' is an invalid name.",ii(t[s]));if(!i.hasOwnProperty(n))i[n]=1;else return St("InvalidAttr","Attribute '"+n+"' is repeated.",ii(t[s]))}return!0}function go(a,e){let t=/\d/;for(a[e]==="x"&&(e++,t=/[\da-fA-F]/);e<a.length;e++){if(a[e]===";")return e;if(!a[e].match(t))break}return-1}function _o(a,e){if(e++,a[e]===";")return-1;if(a[e]==="#")return e++,go(a,e);let t=0;for(;e<a.length;e++,t++)if(!(a[e].match(/\w/)&&t<20)){if(a[e]===";")break;return-1}return e}function St(a,e,t){return{err:{code:a,msg:e,line:t.line||t,col:t.col}}}function yo(a){return pn.isName(a)}function wo(a){return pn.isName(a)}function Rt(a,e){const t=a.substring(0,e).split(/\r?\n/);return{line:t.length,col:t[t.length-1].length+1}}function ii(a){return a.startIndex+a[1].length}var mn={};const br={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(a,e){return e},attributeValueProcessor:function(a,e){return e},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(a,e,t){return a}},bo=function(a){return Object.assign({},br,a)};mn.buildOptions=bo;mn.defaultOptions=br;class vo{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){e==="__proto__"&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e){e.tagname==="__proto__"&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child})}}var xo=vo;const To=ys;function Co(a,e){const t={};if(a[e+3]==="O"&&a[e+4]==="C"&&a[e+5]==="T"&&a[e+6]==="Y"&&a[e+7]==="P"&&a[e+8]==="E"){e=e+9;let i=1,s=!1,n=!1,r="";for(;e<a.length;e++)if(a[e]==="<"&&!n){if(s&&So(a,e))e+=7,[entityName,val,e]=Eo(a,e+1),val.indexOf("&")===-1&&(t[Mo(entityName)]={regx:RegExp(`&${entityName};`,"g"),val});else if(s&&Oo(a,e))e+=8;else if(s&&Po(a,e))e+=8;else if(s&&Io(a,e))e+=9;else if(Ao)n=!0;else throw new Error("Invalid DOCTYPE");i++,r=""}else if(a[e]===">"){if(n?a[e-1]==="-"&&a[e-2]==="-"&&(n=!1,i--):i--,i===0)break}else a[e]==="["?s=!0:r+=a[e];if(i!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:t,i:e}}function Eo(a,e){let t="";for(;e<a.length&&a[e]!=="'"&&a[e]!=='"';e++)t+=a[e];if(t=t.trim(),t.indexOf(" ")!==-1)throw new Error("External entites are not supported");const i=a[e++];let s="";for(;e<a.length&&a[e]!==i;e++)s+=a[e];return[t,s,e]}function Ao(a,e){return a[e+1]==="!"&&a[e+2]==="-"&&a[e+3]==="-"}function So(a,e){return a[e+1]==="!"&&a[e+2]==="E"&&a[e+3]==="N"&&a[e+4]==="T"&&a[e+5]==="I"&&a[e+6]==="T"&&a[e+7]==="Y"}function Oo(a,e){return a[e+1]==="!"&&a[e+2]==="E"&&a[e+3]==="L"&&a[e+4]==="E"&&a[e+5]==="M"&&a[e+6]==="E"&&a[e+7]==="N"&&a[e+8]==="T"}function Po(a,e){return a[e+1]==="!"&&a[e+2]==="A"&&a[e+3]==="T"&&a[e+4]==="T"&&a[e+5]==="L"&&a[e+6]==="I"&&a[e+7]==="S"&&a[e+8]==="T"}function Io(a,e){return a[e+1]==="!"&&a[e+2]==="N"&&a[e+3]==="O"&&a[e+4]==="T"&&a[e+5]==="A"&&a[e+6]==="T"&&a[e+7]==="I"&&a[e+8]==="O"&&a[e+9]==="N"}function Mo(a){if(To.isName(a))return a;throw new Error(`Invalid entity name ${a}`)}var ko=Co;const zo=/^[-+]?0x[a-fA-F0-9]+$/,No=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,Lo={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function Do(a,e={}){if(e=Object.assign({},Lo,e),!a||typeof a!="string")return a;let t=a.trim();if(e.skipLike!==void 0&&e.skipLike.test(t))return a;if(a==="0")return 0;if(e.hex&&zo.test(t))return Ro(t,16);if(t.search(/[eE]/)!==-1){const i=t.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(i){if(e.leadingZeros)t=(i[1]||"")+i[3];else if(!(i[2]==="0"&&i[3][0]==="."))return a;return e.eNotation?Number(t):a}else return a}else{const i=No.exec(t);if(i){const s=i[1],n=i[2];let r=Bo(i[3]);if(!e.leadingZeros&&n.length>0&&s&&t[2]!==".")return a;if(!e.leadingZeros&&n.length>0&&!s&&t[1]!==".")return a;if(e.leadingZeros&&n===a)return 0;{const o=Number(t),l=""+o;return l.search(/[eE]/)!==-1?e.eNotation?o:a:t.indexOf(".")!==-1?l==="0"&&r===""||l===r||s&&l==="-"+r?o:a:n?r===l||s+r===l?o:a:t===l||t===s+l?o:a}}else return a}}function Bo(a){return a&&a.indexOf(".")!==-1&&(a=a.replace(/0+$/,""),a==="."?a="0":a[0]==="."?a="0"+a:a[a.length-1]==="."&&(a=a.substr(0,a.length-1))),a}function Ro(a,e){if(parseInt)return parseInt(a,e);if(Number.parseInt)return Number.parseInt(a,e);if(window&&window.parseInt)return window.parseInt(a,e);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}var Uo=Do;const vr=ys,si=xo,Fo=ko,Vo=Uo;let Ho=class{constructor(e){this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(t,i)=>String.fromCharCode(Number.parseInt(i,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(t,i)=>String.fromCharCode(Number.parseInt(i,16))}},this.addExternalEntities=$o,this.parseXml=Wo,this.parseTextData=Zo,this.resolveNameSpace=Yo,this.buildAttributesMap=Xo,this.isItStopNode=Ko,this.replaceEntitiesValue=Go,this.readStopNodeData=ta,this.saveTextToParentTag=Qo,this.addChild=qo}};function $o(a){const e=Object.keys(a);for(let t=0;t<e.length;t++){const i=e[t];this.lastEntities[i]={regex:new RegExp("&"+i+";","g"),val:a[i]}}}function Zo(a,e,t,i,s,n,r){if(a!==void 0&&(this.options.trimValues&&!i&&(a=a.trim()),a.length>0)){r||(a=this.replaceEntitiesValue(a));const o=this.options.tagValueProcessor(e,a,t,s,n);return o==null?a:typeof o!=typeof a||o!==a?o:this.options.trimValues?Ys(a,this.options.parseTagValue,this.options.numberParseOptions):a.trim()===a?Ys(a,this.options.parseTagValue,this.options.numberParseOptions):a}}function Yo(a){if(this.options.removeNSPrefix){const e=a.split(":"),t=a.charAt(0)==="/"?"/":"";if(e[0]==="xmlns")return"";e.length===2&&(a=t+e[1])}return a}const jo=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function Xo(a,e,t){if(!this.options.ignoreAttributes&&typeof a=="string"){const i=vr.getAllMatches(a,jo),s=i.length,n={};for(let r=0;r<s;r++){const o=this.resolveNameSpace(i[r][1]);let l=i[r][4],c=this.options.attributeNamePrefix+o;if(o.length)if(this.options.transformAttributeName&&(c=this.options.transformAttributeName(c)),c==="__proto__"&&(c="#__proto__"),l!==void 0){this.options.trimValues&&(l=l.trim()),l=this.replaceEntitiesValue(l);const u=this.options.attributeValueProcessor(o,l,e);u==null?n[c]=l:typeof u!=typeof l||u!==l?n[c]=u:n[c]=Ys(l,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(n[c]=!0)}if(!Object.keys(n).length)return;if(this.options.attributesGroupName){const r={};return r[this.options.attributesGroupName]=n,r}return n}}const Wo=function(a){a=a.replace(/\r\n?/g,`
`);const e=new si("!xml");let t=e,i="",s="";for(let n=0;n<a.length;n++)if(a[n]==="<")if(a[n+1]==="/"){const o=ke(a,">",n,"Closing Tag is not closed.");let l=a.substring(n+2,o).trim();if(this.options.removeNSPrefix){const h=l.indexOf(":");h!==-1&&(l=l.substr(h+1))}this.options.transformTagName&&(l=this.options.transformTagName(l)),t&&(i=this.saveTextToParentTag(i,t,s));const c=s.substring(s.lastIndexOf(".")+1);if(l&&this.options.unpairedTags.indexOf(l)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${l}>`);let u=0;c&&this.options.unpairedTags.indexOf(c)!==-1?(u=s.lastIndexOf(".",s.lastIndexOf(".")-1),this.tagsNodeStack.pop()):u=s.lastIndexOf("."),s=s.substring(0,u),t=this.tagsNodeStack.pop(),i="",n=o}else if(a[n+1]==="?"){let o=Zs(a,n,!1,"?>");if(!o)throw new Error("Pi Tag is not closed.");if(i=this.saveTextToParentTag(i,t,s),!(this.options.ignoreDeclaration&&o.tagName==="?xml"||this.options.ignorePiTags)){const l=new si(o.tagName);l.add(this.options.textNodeName,""),o.tagName!==o.tagExp&&o.attrExpPresent&&(l[":@"]=this.buildAttributesMap(o.tagExp,s,o.tagName)),this.addChild(t,l,s)}n=o.closeIndex+1}else if(a.substr(n+1,3)==="!--"){const o=ke(a,"-->",n+4,"Comment is not closed.");if(this.options.commentPropName){const l=a.substring(n+4,o-2);i=this.saveTextToParentTag(i,t,s),t.add(this.options.commentPropName,[{[this.options.textNodeName]:l}])}n=o}else if(a.substr(n+1,2)==="!D"){const o=Fo(a,n);this.docTypeEntities=o.entities,n=o.i}else if(a.substr(n+1,2)==="!["){const o=ke(a,"]]>",n,"CDATA is not closed.")-2,l=a.substring(n+9,o);i=this.saveTextToParentTag(i,t,s);let c=this.parseTextData(l,t.tagname,s,!0,!1,!0,!0);c==null&&(c=""),this.options.cdataPropName?t.add(this.options.cdataPropName,[{[this.options.textNodeName]:l}]):t.add(this.options.textNodeName,c),n=o+2}else{let o=Zs(a,n,this.options.removeNSPrefix),l=o.tagName;const c=o.rawTagName;let u=o.tagExp,h=o.attrExpPresent,p=o.closeIndex;this.options.transformTagName&&(l=this.options.transformTagName(l)),t&&i&&t.tagname!=="!xml"&&(i=this.saveTextToParentTag(i,t,s,!1));const d=t;if(d&&this.options.unpairedTags.indexOf(d.tagname)!==-1&&(t=this.tagsNodeStack.pop(),s=s.substring(0,s.lastIndexOf("."))),l!==e.tagname&&(s+=s?"."+l:l),this.isItStopNode(this.options.stopNodes,s,l)){let g="";if(u.length>0&&u.lastIndexOf("/")===u.length-1)l[l.length-1]==="/"?(l=l.substr(0,l.length-1),s=s.substr(0,s.length-1),u=l):u=u.substr(0,u.length-1),n=o.closeIndex;else if(this.options.unpairedTags.indexOf(l)!==-1)n=o.closeIndex;else{const b=this.readStopNodeData(a,c,p+1);if(!b)throw new Error(`Unexpected end of ${c}`);n=b.i,g=b.tagContent}const m=new si(l);l!==u&&h&&(m[":@"]=this.buildAttributesMap(u,s,l)),g&&(g=this.parseTextData(g,l,s,!0,h,!0,!0)),s=s.substr(0,s.lastIndexOf(".")),m.add(this.options.textNodeName,g),this.addChild(t,m,s)}else{if(u.length>0&&u.lastIndexOf("/")===u.length-1){l[l.length-1]==="/"?(l=l.substr(0,l.length-1),s=s.substr(0,s.length-1),u=l):u=u.substr(0,u.length-1),this.options.transformTagName&&(l=this.options.transformTagName(l));const g=new si(l);l!==u&&h&&(g[":@"]=this.buildAttributesMap(u,s,l)),this.addChild(t,g,s),s=s.substr(0,s.lastIndexOf("."))}else{const g=new si(l);this.tagsNodeStack.push(t),l!==u&&h&&(g[":@"]=this.buildAttributesMap(u,s,l)),this.addChild(t,g,s),t=g}i="",n=p}}else i+=a[n];return e.child};function qo(a,e,t){const i=this.options.updateTag(e.tagname,t,e[":@"]);i===!1||(typeof i=="string"&&(e.tagname=i),a.addChild(e))}const Go=function(a){if(this.options.processEntities){for(let e in this.docTypeEntities){const t=this.docTypeEntities[e];a=a.replace(t.regx,t.val)}for(let e in this.lastEntities){const t=this.lastEntities[e];a=a.replace(t.regex,t.val)}if(this.options.htmlEntities)for(let e in this.htmlEntities){const t=this.htmlEntities[e];a=a.replace(t.regex,t.val)}a=a.replace(this.ampEntity.regex,this.ampEntity.val)}return a};function Qo(a,e,t,i){return a&&(i===void 0&&(i=Object.keys(e.child).length===0),a=this.parseTextData(a,e.tagname,t,!1,e[":@"]?Object.keys(e[":@"]).length!==0:!1,i),a!==void 0&&a!==""&&e.add(this.options.textNodeName,a),a=""),a}function Ko(a,e,t){const i="*."+t;for(const s in a){const n=a[s];if(i===n||e===n)return!0}return!1}function Jo(a,e,t=">"){let i,s="";for(let n=e;n<a.length;n++){let r=a[n];if(i)r===i&&(i="");else if(r==='"'||r==="'")i=r;else if(r===t[0])if(t[1]){if(a[n+1]===t[1])return{data:s,index:n}}else return{data:s,index:n};else r==="	"&&(r=" ");s+=r}}function ke(a,e,t,i){const s=a.indexOf(e,t);if(s===-1)throw new Error(i);return s+e.length-1}function Zs(a,e,t,i=">"){const s=Jo(a,e+1,i);if(!s)return;let n=s.data;const r=s.index,o=n.search(/\s/);let l=n,c=!0;o!==-1&&(l=n.substring(0,o),n=n.substring(o+1).trimStart());const u=l;if(t){const h=l.indexOf(":");h!==-1&&(l=l.substr(h+1),c=l!==s.data.substr(h+1))}return{tagName:l,tagExp:n,closeIndex:r,attrExpPresent:c,rawTagName:u}}function ta(a,e,t){const i=t;let s=1;for(;t<a.length;t++)if(a[t]==="<")if(a[t+1]==="/"){const n=ke(a,">",t,`${e} is not closed`);if(a.substring(t+2,n).trim()===e&&(s--,s===0))return{tagContent:a.substring(i,t),i:n};t=n}else if(a[t+1]==="?")t=ke(a,"?>",t+1,"StopNode is not closed.");else if(a.substr(t+1,3)==="!--")t=ke(a,"-->",t+3,"StopNode is not closed.");else if(a.substr(t+1,2)==="![")t=ke(a,"]]>",t,"StopNode is not closed.")-2;else{const n=Zs(a,t,">");n&&((n&&n.tagName)===e&&n.tagExp[n.tagExp.length-1]!=="/"&&s++,t=n.closeIndex)}}function Ys(a,e,t){if(e&&typeof a=="string"){const i=a.trim();return i==="true"?!0:i==="false"?!1:Vo(a,t)}else return vr.isExist(a)?a:""}var ea=Ho,xr={};function ia(a,e){return Tr(a,e)}function Tr(a,e,t){let i;const s={};for(let n=0;n<a.length;n++){const r=a[n],o=sa(r);let l="";if(t===void 0?l=o:l=t+"."+o,o===e.textNodeName)i===void 0?i=r[o]:i+=""+r[o];else{if(o===void 0)continue;if(r[o]){let c=Tr(r[o],e,l);const u=ra(c,e);r[":@"]?na(c,r[":@"],l,e):Object.keys(c).length===1&&c[e.textNodeName]!==void 0&&!e.alwaysCreateTextNode?c=c[e.textNodeName]:Object.keys(c).length===0&&(e.alwaysCreateTextNode?c[e.textNodeName]="":c=""),s[o]!==void 0&&s.hasOwnProperty(o)?(Array.isArray(s[o])||(s[o]=[s[o]]),s[o].push(c)):e.isArray(o,l,u)?s[o]=[c]:s[o]=c}}}return typeof i=="string"?i.length>0&&(s[e.textNodeName]=i):i!==void 0&&(s[e.textNodeName]=i),s}function sa(a){const e=Object.keys(a);for(let t=0;t<e.length;t++){const i=e[t];if(i!==":@")return i}}function na(a,e,t,i){if(e){const s=Object.keys(e),n=s.length;for(let r=0;r<n;r++){const o=s[r];i.isArray(o,t+"."+o,!0,!0)?a[o]=[e[o]]:a[o]=e[o]}}}function ra(a,e){const{textNodeName:t}=e,i=Object.keys(a).length;return!!(i===0||i===1&&(a[t]||typeof a[t]=="boolean"||a[t]===0))}xr.prettify=ia;const{buildOptions:oa}=mn,aa=ea,{prettify:la}=xr,ca=fn;let ha=class{constructor(e){this.externalEntities={},this.options=oa(e)}parse(e,t){if(typeof e!="string")if(e.toString)e=e.toString();else throw new Error("XML data is accepted in String or Bytes[] form.");if(t){t===!0&&(t={});const n=ca.validate(e,t);if(n!==!0)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const i=new aa(this.options);i.addExternalEntities(this.externalEntities);const s=i.parseXml(e);return this.options.preserveOrder||s===void 0?s:la(s,this.options)}addEntity(e,t){if(t.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(e.indexOf("&")!==-1||e.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(t==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}};var ua=ha;const da=`
`;function fa(a,e){let t="";return e.format&&e.indentBy.length>0&&(t=da),Cr(a,e,"",t)}function Cr(a,e,t,i){let s="",n=!1;for(let r=0;r<a.length;r++){const o=a[r],l=pa(o);if(l===void 0)continue;let c="";if(t.length===0?c=l:c=`${t}.${l}`,l===e.textNodeName){let g=o[l];ma(c,e)||(g=e.tagValueProcessor(l,g),g=Er(g,e)),n&&(s+=i),s+=g,n=!1;continue}else if(l===e.cdataPropName){n&&(s+=i),s+=`<![CDATA[${o[l][0][e.textNodeName]}]]>`,n=!1;continue}else if(l===e.commentPropName){s+=i+`<!--${o[l][0][e.textNodeName]}-->`,n=!0;continue}else if(l[0]==="?"){const g=In(o[":@"],e),m=l==="?xml"?"":i;let b=o[l][0][e.textNodeName];b=b.length!==0?" "+b:"",s+=m+`<${l}${b}${g}?>`,n=!0;continue}let u=i;u!==""&&(u+=e.indentBy);const h=In(o[":@"],e),p=i+`<${l}${h}`,d=Cr(o[l],e,c,u);e.unpairedTags.indexOf(l)!==-1?e.suppressUnpairedNode?s+=p+">":s+=p+"/>":(!d||d.length===0)&&e.suppressEmptyNode?s+=p+"/>":d&&d.endsWith(">")?s+=p+`>${d}${i}</${l}>`:(s+=p+">",d&&i!==""&&(d.includes("/>")||d.includes("</"))?s+=i+e.indentBy+d+i:s+=d,s+=`</${l}>`),n=!0}return s}function pa(a){const e=Object.keys(a);for(let t=0;t<e.length;t++){const i=e[t];if(a.hasOwnProperty(i)&&i!==":@")return i}}function In(a,e){let t="";if(a&&!e.ignoreAttributes)for(let i in a){if(!a.hasOwnProperty(i))continue;let s=e.attributeValueProcessor(i,a[i]);s=Er(s,e),s===!0&&e.suppressBooleanAttributes?t+=` ${i.substr(e.attributeNamePrefix.length)}`:t+=` ${i.substr(e.attributeNamePrefix.length)}="${s}"`}return t}function ma(a,e){a=a.substr(0,a.length-e.textNodeName.length-1);let t=a.substr(a.lastIndexOf(".")+1);for(let i in e.stopNodes)if(e.stopNodes[i]===a||e.stopNodes[i]==="*."+t)return!0;return!1}function Er(a,e){if(a&&a.length>0&&e.processEntities)for(let t=0;t<e.entities.length;t++){const i=e.entities[t];a=a.replace(i.regex,i.val)}return a}var ga=fa;const _a=ga,ya={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(a,e){return e},attributeValueProcessor:function(a,e){return e},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function Se(a){this.options=Object.assign({},ya,a),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=va),this.processTextOrObjNode=wa,this.options.format?(this.indentate=ba,this.tagEndChar=`>
`,this.newLine=`
`):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}Se.prototype.build=function(a){return this.options.preserveOrder?_a(a,this.options):(Array.isArray(a)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(a={[this.options.arrayNodeName]:a}),this.j2x(a,0).val)};Se.prototype.j2x=function(a,e){let t="",i="";for(let s in a)if(Object.prototype.hasOwnProperty.call(a,s))if(typeof a[s]>"u")this.isAttribute(s)&&(i+="");else if(a[s]===null)this.isAttribute(s)?i+="":s[0]==="?"?i+=this.indentate(e)+"<"+s+"?"+this.tagEndChar:i+=this.indentate(e)+"<"+s+"/"+this.tagEndChar;else if(a[s]instanceof Date)i+=this.buildTextValNode(a[s],s,"",e);else if(typeof a[s]!="object"){const n=this.isAttribute(s);if(n)t+=this.buildAttrPairStr(n,""+a[s]);else if(s===this.options.textNodeName){let r=this.options.tagValueProcessor(s,""+a[s]);i+=this.replaceEntitiesValue(r)}else i+=this.buildTextValNode(a[s],s,"",e)}else if(Array.isArray(a[s])){const n=a[s].length;let r="",o="";for(let l=0;l<n;l++){const c=a[s][l];if(!(typeof c>"u"))if(c===null)s[0]==="?"?i+=this.indentate(e)+"<"+s+"?"+this.tagEndChar:i+=this.indentate(e)+"<"+s+"/"+this.tagEndChar;else if(typeof c=="object")if(this.options.oneListGroup){const u=this.j2x(c,e+1);r+=u.val,this.options.attributesGroupName&&c.hasOwnProperty(this.options.attributesGroupName)&&(o+=u.attrStr)}else r+=this.processTextOrObjNode(c,s,e);else if(this.options.oneListGroup){let u=this.options.tagValueProcessor(s,c);u=this.replaceEntitiesValue(u),r+=u}else r+=this.buildTextValNode(c,s,"",e)}this.options.oneListGroup&&(r=this.buildObjectNode(r,s,o,e)),i+=r}else if(this.options.attributesGroupName&&s===this.options.attributesGroupName){const n=Object.keys(a[s]),r=n.length;for(let o=0;o<r;o++)t+=this.buildAttrPairStr(n[o],""+a[s][n[o]])}else i+=this.processTextOrObjNode(a[s],s,e);return{attrStr:t,val:i}};Se.prototype.buildAttrPairStr=function(a,e){return e=this.options.attributeValueProcessor(a,""+e),e=this.replaceEntitiesValue(e),this.options.suppressBooleanAttributes&&e==="true"?" "+a:" "+a+'="'+e+'"'};function wa(a,e,t){const i=this.j2x(a,t+1);return a[this.options.textNodeName]!==void 0&&Object.keys(a).length===1?this.buildTextValNode(a[this.options.textNodeName],e,i.attrStr,t):this.buildObjectNode(i.val,e,i.attrStr,t)}Se.prototype.buildObjectNode=function(a,e,t,i){if(a==="")return e[0]==="?"?this.indentate(i)+"<"+e+t+"?"+this.tagEndChar:this.indentate(i)+"<"+e+t+this.closeTag(e)+this.tagEndChar;{let s="</"+e+this.tagEndChar,n="";return e[0]==="?"&&(n="?",s=""),(t||t==="")&&a.indexOf("<")===-1?this.indentate(i)+"<"+e+t+n+">"+a+s:this.options.commentPropName!==!1&&e===this.options.commentPropName&&n.length===0?this.indentate(i)+`<!--${a}-->`+this.newLine:this.indentate(i)+"<"+e+t+n+this.tagEndChar+a+this.indentate(i)+s}};Se.prototype.closeTag=function(a){let e="";return this.options.unpairedTags.indexOf(a)!==-1?this.options.suppressUnpairedNode||(e="/"):this.options.suppressEmptyNode?e="/":e=`></${a}`,e};Se.prototype.buildTextValNode=function(a,e,t,i){if(this.options.cdataPropName!==!1&&e===this.options.cdataPropName)return this.indentate(i)+`<![CDATA[${a}]]>`+this.newLine;if(this.options.commentPropName!==!1&&e===this.options.commentPropName)return this.indentate(i)+`<!--${a}-->`+this.newLine;if(e[0]==="?")return this.indentate(i)+"<"+e+t+"?"+this.tagEndChar;{let s=this.options.tagValueProcessor(e,a);return s=this.replaceEntitiesValue(s),s===""?this.indentate(i)+"<"+e+t+this.closeTag(e)+this.tagEndChar:this.indentate(i)+"<"+e+t+">"+s+"</"+e+this.tagEndChar}};Se.prototype.replaceEntitiesValue=function(a){if(a&&a.length>0&&this.options.processEntities)for(let e=0;e<this.options.entities.length;e++){const t=this.options.entities[e];a=a.replace(t.regex,t.val)}return a};function ba(a){return this.options.indentBy.repeat(a)}function va(a){return a.startsWith(this.options.attributeNamePrefix)&&a!==this.options.textNodeName?a.substr(this.attrPrefixLen):!1}var xa=Se;const Ta=fn,Ca=ua,Ea=xa;var os={XMLParser:Ca,XMLValidator:Ta,XMLBuilder:Ea};class as{}C(as,"parser",new os.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0})),C(as,"builder",new os.XMLBuilder({attributeNamePrefix:"$",ignoreAttributes:!1,suppressBooleanAttributes:!1}));class ue{static join(e){const t={};for(const i of e)for(const s in i)if(!t[s])t[s]=new Set(i[s]);else for(const n of i[s])t[s].add(n);return t}static intersect(e){if(e.length===0)return{};let t=ue.clone(e[0]);for(let i=1;i<e.length;i++){const s=e[i],n={};for(const r in t)if(s[r]){const o=new Set;for(const l of t[r])s[r].has(l)&&o.add(l);o.size>0&&(n[r]=o)}t=n}return t}static clone(e){const t={};for(const i in e)t[i]=new Set(e[i]);return t}static remove(e,t,i=!1){i&&(e=ue.clone(e));for(const s in t)if(e[s]){for(const n of t[s])e[s].delete(n);e[s].size===0&&delete e[s]}}static add(e,t,i=!1){i&&(e=ue.clone(e));for(const s in t)if(!e[s])e[s]=new Set(t[s]);else for(const n of t[s])e[s].add(n)}static append(e,t,...i){let s=e[t];s||(s=new Set,e[t]=s);for(const n of i)s.add(n)}static isEqual(e,t){const i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length)return!1;for(const n of i){if(!t[n]||e[n].size!==t[n].size)return!1;for(const r of e[n])if(!t[n].has(r))return!1}return!0}static isEmpty(e){return Object.values(e).reduce((i,s)=>i+s.size,0)===0}static toRaw(e){const t={};for(const i in e)t[i]=Array.from(e[i]);return t}static fromRaw(e){const t={};for(const i in e)t[i]=new Set(e[i]);return t}}class Ts{static isEntry(e){return new Set(["Boolean","Color","Text","Number","Select","Vector3","TextSet","None"]).has(e.type)}static copySchema(e,t={}){for(const i in e){const s=e[i];this.isEntry(s)?t[i]=this.copyEntry(s):(t[i]={},this.copySchema(s,t[i]))}return t}static copyEntry(e){if(e.type==="Boolean"){const t=e;return{type:t.type,value:t.value}}if(e.type==="Color"){const t=e;return{type:t.type,value:t.value.clone()}}if(e.type==="Text"){const t=e;return{type:t.type,value:t.value}}if(e.type==="Number"){const t=e;return{type:t.type,value:t.value,min:t.min,max:t.max,interpolable:t.interpolable}}if(e.type==="Select"){const t=e;return{type:t.type,value:t.value,multiple:t.multiple,options:new Set(t.options)}}if(e.type==="Vector3"){const t=e;return{type:t.type,value:t.value.clone()}}if(e.type==="TextSet"){const t=e;return{type:t.type,value:new Set(t.value)}}if(e.type==="None"){const t=e;return{type:t.type,value:t.value}}throw new Error("Invalid entry!")}}class ws{constructor(e,t,i,s){C(this,"_component");C(this,"name");C(this,"uuid");this._component=e,this.name=i,this.uuid=s??Zt.create(),t.get(Ci).list.set(this.uuid,this)}get controls(){return Ts.copySchema(this._config)}set(e){for(const t in e)if(t in this){const i=t;this[i]=e[t].value}}export(e=this._config,t={}){for(const i in e){const s=e[i];if(Ts.isEntry(s))if(s.type==="Color"){const{r,g:o,b:l}=s.value;t[i]={...s,value:{r,g:o,b:l}}}else if(s.type==="Vector3"){const{x:r,y:o,z:l}=s.value;t[i]={...s,value:{x:r,y:o,z:l}}}else if(s.type==="TextSet"){const r=Array.from(s.value);t[i]={...s,value:r}}else if(s.type==="Select"){const r=Array.from(s.options);t[i]={...s,options:r}}else t[i]={...s};else t[i]={},this.export(s,t[i])}return t}import(e,t={},i=!0){for(const s in e){const n=e[s];if(Ts.isEntry(n))if(n.type==="Color"){const{r:o,g:l,b:c}=n.value;t[s]={...n,value:new $t(o,l,c)}}else if(n.type==="Vector3"){const{x:o,y:l,z:c}=n.value;t[s]={...n,value:new Z(o,l,c)}}else n.type==="TextSet"?t[s]={...n,value:new Set(n.value)}:n.type==="Select"?t[s]={...n,options:new Set(n.options)}:t[s]={...n};else t[s]={},this.import(n,t[s],!1)}i&&this.set(t)}}const us=class us extends te{constructor(t){super(t);C(this,"list",new Vt);C(this,"enabled",!0);t.add(us.uuid,this)}};C(us,"uuid","b8c764e0-6b24-4e77-9a32-35fa728ee5b4");let Ci=us;class Ar{constructor(e){C(this,"_event");C(this,"_position",new jt);C(this,"onDisposed",new rt);C(this,"updateMouseInfo",e=>{this._event=e});this.dom=e,this.setupEvents(!0)}get position(){return this.updatePosition(!1),this._position.clone()}get rawPosition(){return this.updatePosition(!0),this._position.clone()}dispose(){this.setupEvents(!1),this.onDisposed.trigger(),this.onDisposed.reset()}updatePosition(e){if(this._event){const t=this.dom.getBoundingClientRect();this._position.x=this.getPositionX(t,this._event,e),this._position.y=this.getPositionY(t,this._event,e)}}getPositionY(e,t,i){const s=this.getDataObject(t);return i?s.clientY:-((s.clientY-e.top)/(e.bottom-e.top))*2+1}getPositionX(e,t,i){const s=this.getDataObject(t);return i?s.clientX:(s.clientX-e.left)/(e.right-e.left)*2-1}getDataObject(e){return e instanceof MouseEvent?e:e.touches[0]}setupEvents(e){e?(this.dom.addEventListener("pointermove",this.updateMouseInfo),this.dom.addEventListener("touchstart",this.updateMouseInfo)):(this.dom.removeEventListener("pointermove",this.updateMouseInfo),this.dom.removeEventListener("touchstart",this.updateMouseInfo))}}const ds=class ds extends te{constructor(t){super(t);C(this,"onDisposed",new rt);C(this,"onBeforeDispose",new rt);C(this,"onFragmentsLoaded",new rt);C(this,"baseCoordinationModel","");C(this,"baseCoordinationMatrix",new It);C(this,"enabled",!0);C(this,"_core");this.components.add(ds.uuid,this)}get initialized(){return!!this._core}get list(){return this.core.models.list}get core(){if(!this._core)throw new Error("FragmentsManager not initialized. Call init() first.");return this._core}get _hasCoordinationModel(){return this.baseCoordinationModel!==""}dispose(){this.onBeforeDispose.trigger(),this._core&&(this.core.dispose(),this._core=void 0),this.baseCoordinationModel="",this.onFragmentsLoaded.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}init(t){this._core=new Ur(t),this.core.onModelLoaded.add(async()=>{if(this._hasCoordinationModel)return;const i=[...this.list.values()][0];i&&(this.baseCoordinationModel=i.modelId,this.baseCoordinationMatrix=await i.getCoordinationMatrix())}),this.list.onItemDeleted.add(()=>{this.list.size>0||(this.baseCoordinationModel="",this.baseCoordinationMatrix=new It)})}async raycast(t){const i=[];for(const r of this.core.models.list.values())if(t.snappingClasses&&t.snappingClasses.length>0){const o=await r.raycastWithSnapping(t);if(o&&o.length>0)i.push(o[0]);else{const l=await r.raycast(t);l&&i.push(l)}}else{const o=await r.raycast(t);o&&i.push(o)}if(await Promise.all(i),i.length===0)return;let s=i[0],n=s.distance;for(let r=1;r<i.length;r++)i[r].distance<n&&(n=i[r].distance,s=i[r]);return s}async getPositions(t){const i=[],s=async(r,o)=>{const l=await r.getPositions(o);for(const c of l)i.push(c)},n=[];for(const r in t){const o=this.core.models.list.get(r);o&&n.push(s(o,Array.from(t[r])))}return await Promise.all(n),i}async getBBoxes(t){const i=[],s=async(r,o)=>{const l=await r.getBoxes(o);if(l)for(const c of l)i.push(c)},n=[];for(const r in t){const o=this.core.models.list.get(r);o&&n.push(s(o,Array.from(t[r])))}return await Promise.all(n),i}async highlight(t,i){await this.forEachModel(i,"highlight",t)}async getData(t,i){const s={};for(const[n,r]of Object.entries(t)){const o=this.list.get(n);if(!o)continue;if(r.size===0){s[n]=[];continue}const l=await o.getItemsData([...r],i);s[n]=l}return s}async resetHighlight(t){await this.forEachModel(t,"resetHighlight")}async forEachModel(t,i,...s){const n={};if(t)for(const o in t){const l=t[o];n[o]=Array.from(l)}else for(const o of this.core.models.list.keys())n[o]=void 0;const r=[];for(const o in n){const l=this.core.models.list.get(o);if(l){const c=n[o],u=l[i](c,...s);r.push(u)}}await Promise.all(r)}async guidsToModelIdMap(t){const i={};for(const[s,n]of this.list){const r=(await n.getLocalIdsByGuids([...t])).filter(o=>o!==null);i[s]=new Set(r)}return i}async modelIdMapToGuids(t){const i=[];for(const[s,n]of Object.entries(t)){const r=this.list.get(s);if(!r)continue;const o=(await r.getGuidsByLocalIds([...n])).filter(l=>l!==null);i.push(...o)}return i}applyBaseCoordinateSystem(t,i){const s=new It;return i&&s.copy(i.clone()).invert(),s.multiply(this.baseCoordinationMatrix),t.applyMatrix4(s),s}};C(ds,"uuid","fef46874-46a3-461b-8c44-2922ab77c806");let ft=ds;const fs=class fs extends te{constructor(t){super(t);C(this,"enabled",!0);this.components.add(fs.uuid,this)}async set(t,i){const s=this.components.get(ft),n=[];if(i)for(const[r,o]of Object.entries(i)){const l=s.list.get(r);l&&n.push(l.setVisible([...o],t))}else for(const r of s.list.values())n.push(r.setVisible(void 0,t));await Promise.all(n),await s.core.update(!0)}async isolate(t){await Promise.all([this.set(!1),this.set(!0,t)])}async toggle(t){const i=[],s=this.components.get(ft);for(const[n,r]of Object.entries(t)){const o=s.list.get(n);o&&i.push(o.toggleVisible([...r]))}await Promise.all(i),await s.core.update(!0)}async getVisibilityMap(t,i){const s=[],n=[],r=this.components.get(ft);if(i)for(const c of i){const u=r.list.get(c);u&&(s.push(u.modelId),n.push(u.getItemsByVisibility(t)))}else for(const c of r.list.values())s.push(c.modelId),n.push(c.getItemsByVisibility(t));const o=await Promise.all(n),l={};for(const[c,u]of s.entries())l[u]=o[c];return l}};C(fs,"uuid","dd9ccf2d-8a21-4821-b7f6-2949add16a29");let js=fs;const xi=class xi extends te{constructor(t){super(t);C(this,"enabled",!0);C(this,"onDisposed",new rt);C(this,"list",new me);this.components.add(xi.uuid,this)}dispose(t=!0){this.list.clear(),this.onDisposed.trigger(xi.uuid),t&&(this.onDisposed.reset(),this.list.eventsEnabled=!1,this.list.dispose())}get(){const t=new Lt;for(const i of this.list)t.union(i);return t}async addFromModelIdMap(t){const i=this.components.get(ft),s=new Lt;for(const[n,r]of Object.entries(t)){const o=i.list.get(n);if(!o)continue;const l=await o.getMergedBox([...r]);s.union(l)}this.list.add(s)}addFromModels(t){const i=this.components.get(ft);for(const[s,n]of i.list)t&&!t.some(r=>r.test(s))||this.list.add(n.box)}async getCenter(t){this.list.clear(),await this.addFromModelIdMap(t);const i=this.get();this.list.clear();const s=new Z;return i.getCenter(s),s}async getCameraOrientation(t,i=1){const s=this.components.get(ft);this.list.clear();for(const[u,h]of s.list)this.list.add(h.box);const n=this.get();this.list.clear();const r=new Z;n.getCenter(r);const o=new Z;n.getSize(o);const l=Math.max(o.x,o.y,o.z)*i,c=new Z;switch(t){case"front":c.set(r.x,r.y,r.z+l);break;case"back":c.set(r.x,r.y,r.z-l);break;case"left":c.set(r.x-l,r.y,r.z);break;case"right":c.set(r.x+l,r.y,r.z);break;case"top":c.set(r.x,r.y+l,r.z);break;case"bottom":c.set(r.x,r.y-l,r.z);break;default:c.set(r.x,r.y,r.z+l)}return{position:c,target:r}}};C(xi,"uuid","d1444724-dba6-4cdd-a0c7-68ee1450d166");let Xs=xi;class Aa{constructor(e,t){C(this,"enabled",!0);C(this,"components");C(this,"onDisposed",new rt);C(this,"mouse");C(this,"world");C(this,"debugMode",!1);C(this,"colorToModelId",new Map);C(this,"modelIdToColor",new Map);C(this,"renderTarget");C(this,"renderTargetSize",new jt);C(this,"debugCanvas");C(this,"debugContainer");C(this,"colorMaterials",new Map);C(this,"originalMaterials",new Map);C(this,"originalLodColors",new Map);C(this,"colorsNeedUpdate",!0);const i=t.renderer;if(!i)throw new Error("A renderer is needed for the FastModelPicker to work!");this.world=t,this.mouse=new Ar(i.three.domElement),this.components=e,this.setupRenderTarget(),this.setupFragmentListeners()}setupFragmentListeners(){const e=this.components.get(ft);e.list.onItemSet.add(()=>{this.colorsNeedUpdate=!0}),e.list.onItemDeleted.add(()=>{this.colorsNeedUpdate=!0})}setupRenderTarget(){const t=this.world.renderer.three.getSize(new jt);this.renderTargetSize.copy(t),this.renderTarget=new Fr(t.x,t.y),this.renderTarget.texture.format=Vr,this.renderTarget.texture.type=Hr,this.debugMode&&this.setupDebugCanvas(),this.world.renderer.onResize.add(i=>{this.renderTargetSize.copy(i),this.renderTarget.setSize(i.x,i.y),this.debugCanvas&&(this.debugCanvas.width=i.x,this.debugCanvas.height=i.y)})}setupDebugCanvas(){if(this.debugCanvas)return;const e=this.world.renderer.three.getSize(new jt);this.debugContainer=document.createElement("div"),this.debugContainer.style.position="fixed",this.debugContainer.style.top="10px",this.debugContainer.style.right="10px",this.debugContainer.style.width="300px",this.debugContainer.style.height="300px",this.debugContainer.style.border="2px solid #fff",this.debugContainer.style.backgroundColor="#000",this.debugContainer.style.zIndex="10000",this.debugContainer.style.pointerEvents="none",this.debugCanvas=document.createElement("canvas"),this.debugCanvas.width=e.x,this.debugCanvas.height=e.y,this.debugCanvas.style.width="100%",this.debugCanvas.style.height="100%",this.debugCanvas.style.imageRendering="pixelated",this.debugContainer.appendChild(this.debugCanvas),document.body.appendChild(this.debugContainer)}generateColorForModel(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o),t&=t;let i=Math.abs(t)%16777215;i===0&&(i=1);const s=i>>16&255||1,n=i>>8&255||1,r=i&255||1;return new $t(s/255,n/255,r/255)}colorToId(e){const t=Math.round(e.r*255),i=Math.round(e.g*255),s=Math.round(e.b*255);return t<<16|i<<8|s}assignColors(){const e=this.components.get(ft);if(e.initialized){if(!this.colorsNeedUpdate){const t=new Set(e.list.keys()),i=new Set(this.modelIdToColor.keys());(t.size!==i.size||[...t].some(s=>!i.has(s)))&&(this.colorsNeedUpdate=!0)}if(this.colorsNeedUpdate){this.colorToModelId.clear(),this.modelIdToColor.clear();for(const t of this.colorMaterials.values())t.dispose();this.colorMaterials.clear();for(const[t]of e.list){const i=this.generateColorForModel(t),s=this.colorToId(i);this.colorToModelId.set(s,t),this.modelIdToColor.set(t,i);const n=new Ai({color:i,depthTest:!0,depthWrite:!0});this.colorMaterials.set(t,n)}this.colorsNeedUpdate=!1}}}applyColorMaterials(){const e=this.components.get(ft);if(e.initialized)for(const[t,i]of e.list){const s=this.colorMaterials.get(t);s&&i.object.traverse(n=>{if(n instanceof it){if("isLODGeometry"in n.geometry){const o=n.material[0].uniforms.lodColor;this.originalLodColors.has(o)||this.originalLodColors.set(o,o.value),o.value=s.color;return}this.originalMaterials.has(n)||this.originalMaterials.set(n,n.material),n.material=s}})}}restoreOriginalMaterials(){for(const[e,t]of this.originalMaterials)e.material=t;for(const[e,t]of this.originalLodColors)e.value=t;this.originalMaterials.clear()}renderColorCoded(){if(!this.renderTarget||!this.world.renderer)throw new Error("Render target not initialized!");const e=this.world.renderer.three,t=this.world.scene.three,i=this.world.camera.three,s=e.getRenderTarget(),n=e.autoClear,r=new $t,o=e.getClearAlpha();e.getClearColor(r),this.applyColorMaterials(),e.setRenderTarget(this.renderTarget),e.autoClear=!0,e.setClearColor(0,1),e.clear(!0,!0,!1),e.render(t,i),e.setRenderTarget(s),e.autoClear=n,e.setClearColor(r,o),this.restoreOriginalMaterials(),this.debugMode&&this.debugCanvas&&this.updateDebugCanvas()}updateDebugCanvas(){if(!this.debugCanvas||!this.renderTarget||!this.world.renderer)return;const e=this.world.renderer.three,t=this.renderTargetSize,i=new Uint8Array(t.x*t.y*4);e.readRenderTargetPixels(this.renderTarget,0,0,t.x,t.y,i);const s=this.debugCanvas.getContext("2d");if(!s)return;const n=s.createImageData(t.x,t.y),r=t.x*4;for(let o=0;o<t.y;o++){const l=o,c=t.y-1-o,u=l*r,h=c*r;n.data.set(i.subarray(u,u+r),h)}s.putImageData(n,0,0)}async getModelAt(e){if(!this.renderTarget||!this.world.renderer)throw new Error("Render target not initialized!");const t=this.components.get(ft);if(!t.initialized||t.list.size===0)return null;this.assignColors(),this.renderColorCoded();const i=e||this.mouse.position,s=this.renderTargetSize,n=Math.floor((i.x+1)*.5*s.x),r=Math.floor((i.y+1)*.5*(s.y-1)),o=Math.max(0,Math.min(s.x-1,n)),l=Math.max(0,Math.min(s.y-1,r)),c=this.world.renderer.three,u=new Uint8Array(4);c.readRenderTargetPixels(this.renderTarget,o,l,1,1,u);const h=u[0],p=u[1],d=u[2],g=h<<16|p<<8|d;return this.colorToModelId.get(g)||null}setDebugMode(e){this.debugMode=e,e?this.setupDebugCanvas():this.removeDebugCanvas()}removeDebugCanvas(){this.debugContainer&&(this.debugContainer.remove(),this.debugContainer=void 0,this.debugCanvas=void 0)}dispose(){this.mouse.dispose(),this.removeDebugCanvas();for(const e of this.colorMaterials.values())e.dispose();this.colorMaterials.clear(),this.renderTarget&&this.renderTarget.dispose(),this.colorToModelId.clear(),this.modelIdToColor.clear(),this.originalMaterials.clear(),this.originalLodColors.clear(),this.onDisposed.trigger(),this.onDisposed.reset()}}const ps=class ps extends te{constructor(t){super(t);C(this,"enabled",!0);C(this,"list",new Map);C(this,"onDisposed",new rt);t.add(ps.uuid,this)}get(t){if(this.list.has(t.uuid))return this.list.get(t.uuid);const i=new Aa(this.components,t);return this.list.set(t.uuid,i),t.onDisposed.add(()=>{this.delete(t)}),i}delete(t){const i=this.list.get(t.uuid);i&&i.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,i]of this.list)i.dispose();this.list.clear(),this.onDisposed.trigger()}};C(ps,"uuid","4a82430c-7ff2-49ea-9401-60807502dad6");let Ws=ps;class Sa{constructor(e,t){C(this,"enabled",!0);C(this,"components");C(this,"onDisposed",new rt);C(this,"mouse");C(this,"three",new an);C(this,"world");C(this,"useFastModelPicking",!1);const i=t.renderer;if(!i)throw new Error("A renderer is needed for the raycaster to work!");this.world=t,this.mouse=new Ar(i.three.domElement),this.components=e}dispose(){this.mouse.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}castRayToObjects(e=Array.from(this.world.meshes),t=this.mouse.position){if(!this.world)throw new Error("A world is needed to cast rays!");const i=this.world.camera.three;return this.three.setFromCamera(t,i),this.intersect(e)}async castRay(e){const t=e==null?void 0:e.snappingClasses,i=(e==null?void 0:e.items)??Array.from(this.world.meshes),s=(e==null?void 0:e.position)??this.mouse.position;if(!this.world)throw new Error("A world is needed to cast rays!");const n=this.world.camera.three,r=this.components.get(ft),o=this.world.renderer.three.domElement,l=this.mouse.rawPosition;let c=null;if(r.initialized){if(this.useFastModelPicking){const d=await this.components.get(Ws).get(this.world).getModelAt(s);if(d){const g=r.list.get(d);if(g)if(t&&t.length>0){const m=await g.raycastWithSnapping({camera:n,dom:o,mouse:l,snappingClasses:t});m&&m.length>0?c=m[0]:c=await g.raycast({camera:n,dom:o,mouse:l})}else c=await g.raycast({camera:n,dom:o,mouse:l})}}else c=await r.raycast({camera:n,dom:o,mouse:l,snappingClasses:t});if(i.length===0)return c}this.three.setFromCamera(s,n);const u=this.intersect(i);return c?u&&u.distance<c.distance?u:c:u}castRayFromVector(e,t,i=Array.from(this.world.meshes)){return this.three.set(e,t),this.intersect(i)}intersect(e=Array.from(this.world.meshes)){const t=this.three.intersectObjects(e),i=this.filterClippingPlanes(t);return i.length>0?i[0]:null}filterClippingPlanes(e){if(!this.world.renderer)throw new Error("Renderer not found!");const t=this.world.renderer.three;if(!t.clippingPlanes)return e;const i=t.clippingPlanes;return e.length<=0||!i||(i==null?void 0:i.length)<=0?e:e.filter(s=>i.every(n=>n.distanceToPoint(s.point)>0))}}const ms=class ms extends te{constructor(t){super(t);C(this,"enabled",!0);C(this,"list",new Map);C(this,"onDisposed",new rt);t.add(ms.uuid,this)}get(t){if(this.list.has(t.uuid))return this.list.get(t.uuid);const i=new Sa(this.components,t);return this.list.set(t.uuid,i),t.onDisposed.add(()=>{this.delete(t)}),i}delete(t){const i=this.list.get(t.uuid);i&&i.dispose(),this.list.delete(t.uuid)}dispose(){for(const[t,i]of this.list)i.dispose();this.list.clear(),this.onDisposed.trigger()}};C(ms,"uuid","d5d8bdf0-db25-4952-b951-b643af207ace");let Ei=ms;class Oa extends un{constructor(){super(...arguments);C(this,"onCameraChanged",new rt);C(this,"meshes",new Set);C(this,"onAfterUpdate",new rt);C(this,"onBeforeUpdate",new rt);C(this,"onDisposed",new rt);C(this,"isDisposing",!1);C(this,"enabled",!0);C(this,"_dynamicAnchor",!1);C(this,"uuid",Zt.create());C(this,"name");C(this,"_scene");C(this,"_camera");C(this,"_renderer",null);C(this,"onPointerDown",async t=>{if(!this.camera.hasCameraControls())throw new Error("World: can't set dynamic anchor if the camera doesn't have controls.");const s=await this.components.get(Ei).get(this).castRay();s&&s.point&&t.button===0&&this.camera.controls.setOrbitPoint(s.point.x,s.point.y,s.point.z)});C(this,"_defaultCamera")}set dynamicAnchor(t){var s;const i=(s=this.renderer)==null?void 0:s.three.domElement.parentElement;if(!i)throw new Error("World: the renderer must have a parentElement to set dynamic anchoring.");t?(this.camera.controls&&(this.camera.controls.minDistance=.01),i.addEventListener("pointerdown",this.onPointerDown)):i.removeEventListener("pointerdown",this.onPointerDown)}get dynamicAnchor(){return this._dynamicAnchor}get defaultCamera(){if(!this._defaultCamera)throw new Error("World: there is no default camera defined.");return this._defaultCamera}set defaultCamera(t){this._defaultCamera=t}get scene(){if(!this._scene)throw new Error("No scene initialized!");return this._scene}set scene(t){this._scene=t,t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"})}get camera(){if(!this._camera)throw new Error("No camera initialized!");return this._camera}set camera(t){this._camera||(this.defaultCamera=t),this._camera=t,t.currentWorld=this,this.onCameraChanged.trigger(t)}get renderer(){return this._renderer}set renderer(t){this._renderer=t,t&&(t.worlds.set(this.uuid,this),t.currentWorld=this,t.onWorldChanged.trigger({world:this,action:"added"}))}useDefaultCamera(){this.camera=this.defaultCamera}update(t){this.enabled&&(!this._scene||!this._camera||(this.scene.currentWorld=this,this.camera.currentWorld=this,this.renderer&&(this.renderer.currentWorld=this),this.onBeforeUpdate.trigger(),this.scene.isUpdateable()&&this.scene.update(t),this.camera.isUpdateable()&&this.camera.update(t),this.renderer&&this.renderer.update(t),this.onAfterUpdate.trigger()))}dispose(t=!0){if(this.enabled=!1,this.isDisposing=!0,this.scene.onWorldChanged.trigger({world:this,action:"removed"}),this.camera.onWorldChanged.trigger({world:this,action:"removed"}),this.renderer&&this.renderer.onWorldChanged.trigger({world:this,action:"removed"}),t){const s=this.components.get(rs);this.scene.dispose(),this.camera.isDisposeable()&&this.camera.dispose(),this.renderer&&this.renderer.dispose();for(const n of this.meshes)s.destroy(n);this.meshes.clear()}this._scene=null,this._camera=null,this._renderer=null,this.components.get(ls).list.delete(this.uuid),this.onDisposed.trigger(),this.onDisposed.reset()}}class Pa{constructor(e,t){C(this,"_list");C(this,"_scene");this._list=e,this._scene=t}get color(){return this._list.directionalLight.color.value}set color(e){this._list.directionalLight.color.value=e;for(const[,t]of this._scene.directionalLights)t.color.copy(e)}get intensity(){return this._list.directionalLight.intensity.value}set intensity(e){this._list.directionalLight.intensity.value=e;for(const[,t]of this._scene.directionalLights)t.intensity=e}get position(){return this._list.directionalLight.position.value.clone()}set position(e){this._list.directionalLight.position.value=e;for(const[,t]of this._scene.directionalLights)t.position.copy(e)}}class Ia{constructor(e,t){C(this,"_list");C(this,"_scene");this._list=e,this._scene=t}get color(){return this._list.ambientLight.color.value}set color(e){this._list.ambientLight.color.value=e;for(const[,t]of this._scene.ambientLights)t.color.copy(e)}get intensity(){return this._list.ambientLight.intensity.value}set intensity(e){this._list.ambientLight.intensity.value=e;for(const[,t]of this._scene.ambientLights)t.intensity=e}}class Ma extends ws{constructor(){super(...arguments);C(this,"_config",{backgroundColor:{value:new $t,type:"Color"},ambientLight:{color:{type:"Color",value:new $t},intensity:{type:"Number",interpolable:!0,min:0,max:10,value:2}},directionalLight:{color:{type:"Color",value:new $t},intensity:{type:"Number",interpolable:!0,min:0,max:10,value:2},position:{type:"Vector3",value:new Z}}});C(this,"ambientLight",new Ia(this._config,this._component));C(this,"directionalLight",new Pa(this._config,this._component))}get backgroundColor(){return this._config.backgroundColor.value}set backgroundColor(t){this._config.backgroundColor.value=t,this._component.three.background=t}}class mc extends co{constructor(t){super(t);C(this,"onSetup",new rt);C(this,"isSetup",!1);C(this,"three");C(this,"config",new Ma(this,this.components,"Scene"));C(this,"_defaultConfig",{backgroundColor:new $t(2107698),directionalLight:{color:new $t("white"),intensity:1.5,position:new Z(5,10,3)},ambientLight:{color:new $t("white"),intensity:1}});this.three=new $r,this.three.background=new $t(2107698)}setup(t){const i={...this._defaultConfig,...t};this.config.backgroundColor=i.backgroundColor;const s=i.ambientLight;this.config.ambientLight.color=s.color,this.config.ambientLight.intensity=s.intensity;const n=i.directionalLight;this.config.directionalLight.color=n.color,this.config.directionalLight.intensity=n.intensity,this.config.directionalLight.position=n.position,this.deleteAllLights();const{color:r,intensity:o}=this.config.directionalLight,l=new Zr(r,o);l.position.copy(n.position);const{color:c,intensity:u}=this.config.directionalLight,h=new Yr(c,u);this.three.add(l,h),this.directionalLights.set(l.uuid,l),this.ambientLights.set(h.uuid,h),this.isSetup=!0,this.onSetup.trigger()}dispose(){super.dispose(),this.components.get(Ci).list.delete(this.config.uuid)}}class gc extends lo{constructor(t,i,s){super(t);C(this,"enabled",!0);C(this,"container");C(this,"three");C(this,"mode",1);C(this,"needsUpdate",!1);C(this,"_canvas");C(this,"_parameters");C(this,"_resizeObserver",null);C(this,"onContainerUpdated",new rt);C(this,"_resizing",!1);C(this,"resize",t=>{if(this._resizing)return;this._resizing=!0,this.onContainerUpdated.trigger();const i=t?t.x:this.container.clientWidth,s=t?t.y:this.container.clientHeight;this.three.setSize(i,s),this.onResize.trigger(new jt(i,s)),this._resizing=!1});C(this,"resizeEvent",()=>{this.resize()});C(this,"onContextLost",t=>{t.preventDefault(),this.enabled=!1});C(this,"onContextBack",()=>{this.three.setRenderTarget(null),this.three.dispose(),this.three=new Tn({canvas:this._canvas,antialias:!0,alpha:!0,...this._parameters}),this.enabled=!0});this.container=i,this._parameters=s,this.three=new Tn({antialias:!0,alpha:!0,...s}),this.three.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.setupRenderer(),this.setupEvents(!0),this.resize(),this._canvas=this.three.domElement;const n=this.three.getContext(),{canvas:r}=n;r.addEventListener("webglcontextlost",this.onContextLost,!1),r.addEventListener("webglcontextrestored",this.onContextBack,!1)}update(){if(!this.enabled||!this.currentWorld||this.mode===0&&!this.needsUpdate)return;this.needsUpdate=!1,this.onBeforeUpdate.trigger(this);const t=this.currentWorld.scene.three,i=this.currentWorld.camera.three;this.three.render(t,i),this.onAfterUpdate.trigger(this)}dispose(){this.enabled=!1,this.setupEvents(!1),this.three.domElement.remove(),this.three.forceContextLoss(),this.three.dispose(),this.onResize.reset(),this.onAfterUpdate.reset(),this.onBeforeUpdate.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}getSize(){return new jt(this.three.domElement.clientWidth,this.three.domElement.clientHeight)}setupEvents(t){const i=this.three.domElement.parentElement;if(!i)throw new Error("This renderer needs to have an HTML container!");this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),window.removeEventListener("resize",this.resizeEvent),t&&(this._resizeObserver=new ResizeObserver(this.resizeEvent),this._resizeObserver.observe(i),window.addEventListener("resize",this.resizeEvent))}setupRenderer(){this.three.localClippingEnabled=!0,this.container&&this.container.appendChild(this.three.domElement),this.onContainerUpdated.trigger()}}/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */const xt={LEFT:1,RIGHT:2,MIDDLE:4},U=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,SCREEN_PAN:4,OFFSET:8,DOLLY:16,ZOOM:32,TOUCH_ROTATE:64,TOUCH_TRUCK:128,TOUCH_SCREEN_PAN:256,TOUCH_OFFSET:512,TOUCH_DOLLY:1024,TOUCH_ZOOM:2048,TOUCH_DOLLY_TRUCK:4096,TOUCH_DOLLY_SCREEN_PAN:8192,TOUCH_DOLLY_OFFSET:16384,TOUCH_DOLLY_ROTATE:32768,TOUCH_ZOOM_TRUCK:65536,TOUCH_ZOOM_OFFSET:131072,TOUCH_ZOOM_SCREEN_PAN:262144,TOUCH_ZOOM_ROTATE:524288}),ze={NONE:0,IN:1,OUT:-1};function Oe(a){return a.isPerspectiveCamera}function ve(a){return a.isOrthographicCamera}const Ne=Math.PI*2,Mn=Math.PI/2,Sr=1e-5,ni=Math.PI/180;function ee(a,e,t){return Math.max(e,Math.min(t,a))}function yt(a,e=Sr){return Math.abs(a)<e}function pt(a,e,t=Sr){return yt(a-e,t)}function kn(a,e){return Math.round(a/e)*e}function ri(a){return isFinite(a)?a:a<0?-Number.MAX_VALUE:Number.MAX_VALUE}function oi(a){return Math.abs(a)<Number.MAX_VALUE?a:a*(1/0)}function Mi(a,e,t,i,s=1/0,n){i=Math.max(1e-4,i);const r=2/i,o=r*n,l=1/(1+o+.48*o*o+.235*o*o*o);let c=a-e;const u=e,h=s*i;c=ee(c,-h,h),e=a-c;const p=(t.value+r*c)*n;t.value=(t.value-r*p)*l;let d=e+(c+p)*l;return u-a>0==d>u&&(d=u,t.value=(d-u)/n),d}function zn(a,e,t,i,s=1/0,n,r){i=Math.max(1e-4,i);const o=2/i,l=o*n,c=1/(1+l+.48*l*l+.235*l*l*l);let u=e.x,h=e.y,p=e.z,d=a.x-u,g=a.y-h,m=a.z-p;const b=u,f=h,y=p,v=s*i,x=v*v,T=d*d+g*g+m*m;if(T>x){const L=Math.sqrt(T);d=d/L*v,g=g/L*v,m=m/L*v}u=a.x-d,h=a.y-g,p=a.z-m;const A=(t.x+o*d)*n,S=(t.y+o*g)*n,M=(t.z+o*m)*n;t.x=(t.x-o*A)*c,t.y=(t.y-o*S)*c,t.z=(t.z-o*M)*c,r.x=u+(d+A)*c,r.y=h+(g+S)*c,r.z=p+(m+M)*c;const I=b-a.x,k=f-a.y,$=y-a.z,E=r.x-b,z=r.y-f,_=r.z-y;return I*E+k*z+$*_>0&&(r.x=b,r.y=f,r.z=y,t.x=(r.x-b)/n,t.y=(r.y-f)/n,t.z=(r.z-y)/n),r}function Cs(a,e){e.set(0,0),a.forEach(t=>{e.x+=t.clientX,e.y+=t.clientY}),e.x/=a.length,e.y/=a.length}function Es(a,e){return ve(a)?(console.warn(`${e} is not supported in OrthographicCamera`),!0):!1}class ka{constructor(){this._listeners={}}addEventListener(e,t){const i=this._listeners;i[e]===void 0&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t)}hasEventListener(e,t){const i=this._listeners;return i[e]!==void 0&&i[e].indexOf(t)!==-1}removeEventListener(e,t){const s=this._listeners[e];if(s!==void 0){const n=s.indexOf(t);n!==-1&&s.splice(n,1)}}removeAllEventListeners(e){if(!e){this._listeners={};return}Array.isArray(this._listeners[e])&&(this._listeners[e].length=0)}dispatchEvent(e){const i=this._listeners[e.type];if(i!==void 0){e.target=this;const s=i.slice(0);for(let n=0,r=s.length;n<r;n++)s[n].call(this,e)}}}var As;const za="2.10.1",ki=1/8,Na=/Mac/.test((As=globalThis==null?void 0:globalThis.navigator)===null||As===void 0?void 0:As.platform);let ot,Nn,zi,Ss,Ft,at,dt,Le,ai,ae,le,Pe,Ln,Dn,Wt,li,De,Bn,Os,Rn,Ps,Is,Ni;class Nt extends ka{static install(e){ot=e.THREE,Nn=Object.freeze(new ot.Vector3(0,0,0)),zi=Object.freeze(new ot.Vector3(0,1,0)),Ss=Object.freeze(new ot.Vector3(0,0,1)),Ft=new ot.Vector2,at=new ot.Vector3,dt=new ot.Vector3,Le=new ot.Vector3,ai=new ot.Vector3,ae=new ot.Vector3,le=new ot.Vector3,Pe=new ot.Vector3,Ln=new ot.Vector3,Dn=new ot.Vector3,Wt=new ot.Spherical,li=new ot.Spherical,De=new ot.Box3,Bn=new ot.Box3,Os=new ot.Sphere,Rn=new ot.Quaternion,Ps=new ot.Quaternion,Is=new ot.Matrix4,Ni=new ot.Raycaster}static get ACTION(){return U}set verticalDragToForward(e){console.warn("camera-controls: `verticalDragToForward` was removed. Use `mouseButtons.left = CameraControls.ACTION.SCREEN_PAN` instead.")}constructor(e,t){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=U.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=ze.NONE,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new ot.Vector3,this._focalOffsetVelocity=new ot.Vector3,this._zoomVelocity={value:0},this._truckInternal=(f,y,v,x)=>{let T,A;if(Oe(this._camera)){const S=at.copy(this._camera.position).sub(this._target),M=this._camera.getEffectiveFOV()*ni,I=S.length()*Math.tan(M*.5);T=this.truckSpeed*f*I/this._elementRect.height,A=this.truckSpeed*y*I/this._elementRect.height}else if(ve(this._camera)){const S=this._camera;T=this.truckSpeed*f*(S.right-S.left)/S.zoom/this._elementRect.width,A=this.truckSpeed*y*(S.top-S.bottom)/S.zoom/this._elementRect.height}else return;x?(v?this.setFocalOffset(this._focalOffsetEnd.x+T,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(T,0,!0),this.forward(-A,!0)):v?this.setFocalOffset(this._focalOffsetEnd.x+T,this._focalOffsetEnd.y+A,this._focalOffsetEnd.z,!0):this.truck(T,A,!0)},this._rotateInternal=(f,y)=>{const v=Ne*this.azimuthRotateSpeed*f/this._elementRect.height,x=Ne*this.polarRotateSpeed*y/this._elementRect.height;this.rotate(v,x,!0)},this._dollyInternal=(f,y,v)=>{const x=Math.pow(.95,-f*this.dollySpeed),T=this._sphericalEnd.radius,A=this._sphericalEnd.radius*x,S=ee(A,this.minDistance,this.maxDistance),M=S-A;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(A,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(M,!0),this._dollyToNoClamp(S,!0)):this._dollyToNoClamp(S,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?A:S)-T,this._dollyControlCoord.set(y,v)),this._lastDollyDirection=Math.sign(-f)},this._zoomInternal=(f,y,v)=>{const x=Math.pow(.95,f*this.dollySpeed),T=this._zoom,A=this._zoom*x;this.zoomTo(A,!0),this.dollyToCursor&&(this._changedZoom+=A-T,this._dollyControlCoord.set(y,v))},typeof ot>"u"&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=e,this._yAxisUpSpace=new ot.Quaternion().setFromUnitVectors(this._camera.up,zi),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=U.NONE,this._target=new ot.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new ot.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=new ot.Spherical().setFromVector3(at.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new ot.Vector3,new ot.Vector3,new ot.Vector3,new ot.Vector3],this._updateNearPlaneCorners(),this._boundary=new ot.Box3(new ot.Vector3(-1/0,-1/0,-1/0),new ot.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new ot.Vector2,this.mouseButtons={left:U.ROTATE,middle:U.DOLLY,right:U.TRUCK,wheel:Oe(this._camera)?U.DOLLY:ve(this._camera)?U.ZOOM:U.NONE},this.touches={one:U.TOUCH_ROTATE,two:Oe(this._camera)?U.TOUCH_DOLLY_TRUCK:ve(this._camera)?U.TOUCH_ZOOM_TRUCK:U.NONE,three:U.TOUCH_TRUCK};const i=new ot.Vector2,s=new ot.Vector2,n=new ot.Vector2,r=f=>{if(!this._enabled||!this._domElement)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const x=this._domElement.getBoundingClientRect(),T=f.clientX/x.width,A=f.clientY/x.height;if(T<this._interactiveArea.left||T>this._interactiveArea.right||A<this._interactiveArea.top||A>this._interactiveArea.bottom)return}const y=f.pointerType!=="mouse"?null:(f.buttons&xt.LEFT)===xt.LEFT?xt.LEFT:(f.buttons&xt.MIDDLE)===xt.MIDDLE?xt.MIDDLE:(f.buttons&xt.RIGHT)===xt.RIGHT?xt.RIGHT:null;if(y!==null){const x=this._findPointerByMouseButton(y);x&&this._disposePointer(x)}if((f.buttons&xt.LEFT)===xt.LEFT&&this._lockedPointer)return;const v={pointerId:f.pointerId,clientX:f.clientX,clientY:f.clientY,deltaX:0,deltaY:0,mouseButton:y};this._activePointers.push(v),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.ownerDocument.addEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",l),this._isDragging=!0,p(f)},o=f=>{f.cancelable&&f.preventDefault();const y=f.pointerId,v=this._lockedPointer||this._findPointerById(y);if(v){if(v.clientX=f.clientX,v.clientY=f.clientY,v.deltaX=f.movementX,v.deltaY=f.movementY,this._state=0,f.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(f.buttons&xt.LEFT)===xt.LEFT)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(f.buttons&xt.MIDDLE)===xt.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(f.buttons&xt.RIGHT)===xt.RIGHT&&(this._state=this._state|this.mouseButtons.right);d()}},l=f=>{const y=this._findPointerById(f.pointerId);if(!(y&&y===this._lockedPointer)){if(y&&this._disposePointer(y),f.pointerType==="touch")switch(this._activePointers.length){case 0:this._state=U.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else this._state=U.NONE;g()}};let c=-1;const u=f=>{if(!this._domElement||!this._enabled||this.mouseButtons.wheel===U.NONE)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const A=this._domElement.getBoundingClientRect(),S=f.clientX/A.width,M=f.clientY/A.height;if(S<this._interactiveArea.left||S>this._interactiveArea.right||M<this._interactiveArea.top||M>this._interactiveArea.bottom)return}if(f.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===U.ROTATE||this.mouseButtons.wheel===U.TRUCK){const A=performance.now();c-A<1e3&&this._getClientRect(this._elementRect),c=A}const y=Na?-1:-3,v=f.deltaMode===1||f.ctrlKey?f.deltaY/y:f.deltaY/(y*10),x=this.dollyToCursor?(f.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,T=this.dollyToCursor?(f.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case U.ROTATE:{this._rotateInternal(f.deltaX,f.deltaY),this._isUserControllingRotate=!0;break}case U.TRUCK:{this._truckInternal(f.deltaX,f.deltaY,!1,!1),this._isUserControllingTruck=!0;break}case U.SCREEN_PAN:{this._truckInternal(f.deltaX,f.deltaY,!1,!0),this._isUserControllingTruck=!0;break}case U.OFFSET:{this._truckInternal(f.deltaX,f.deltaY,!0,!1),this._isUserControllingOffset=!0;break}case U.DOLLY:{this._dollyInternal(-v,x,T),this._isUserControllingDolly=!0;break}case U.ZOOM:{this._zoomInternal(-v,x,T),this._isUserControllingZoom=!0;break}}this.dispatchEvent({type:"control"})},h=f=>{if(!(!this._domElement||!this._enabled)){if(this.mouseButtons.right===Nt.ACTION.NONE){const y=f instanceof PointerEvent?f.pointerId:0,v=this._findPointerById(y);v&&this._disposePointer(v),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l);return}f.preventDefault()}},p=f=>{if(!this._enabled)return;if(Cs(this._activePointers,Ft),this._getClientRect(this._elementRect),i.copy(Ft),s.copy(Ft),this._activePointers.length>=2){const v=Ft.x-this._activePointers[1].clientX,x=Ft.y-this._activePointers[1].clientY,T=Math.sqrt(v*v+x*x);n.set(0,T);const A=(this._activePointers[0].clientX+this._activePointers[1].clientX)*.5,S=(this._activePointers[0].clientY+this._activePointers[1].clientY)*.5;s.set(A,S)}if(this._state=0,!f)this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);else if("pointerType"in f&&f.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else!this._lockedPointer&&(f.buttons&xt.LEFT)===xt.LEFT&&(this._state=this._state|this.mouseButtons.left),(f.buttons&xt.MIDDLE)===xt.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(f.buttons&xt.RIGHT)===xt.RIGHT&&(this._state=this._state|this.mouseButtons.right);((this._state&U.ROTATE)===U.ROTATE||(this._state&U.TOUCH_ROTATE)===U.TOUCH_ROTATE||(this._state&U.TOUCH_DOLLY_ROTATE)===U.TOUCH_DOLLY_ROTATE||(this._state&U.TOUCH_ZOOM_ROTATE)===U.TOUCH_ZOOM_ROTATE)&&(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),((this._state&U.TRUCK)===U.TRUCK||(this._state&U.SCREEN_PAN)===U.SCREEN_PAN||(this._state&U.TOUCH_TRUCK)===U.TOUCH_TRUCK||(this._state&U.TOUCH_SCREEN_PAN)===U.TOUCH_SCREEN_PAN||(this._state&U.TOUCH_DOLLY_TRUCK)===U.TOUCH_DOLLY_TRUCK||(this._state&U.TOUCH_DOLLY_SCREEN_PAN)===U.TOUCH_DOLLY_SCREEN_PAN||(this._state&U.TOUCH_ZOOM_TRUCK)===U.TOUCH_ZOOM_TRUCK||(this._state&U.TOUCH_ZOOM_SCREEN_PAN)===U.TOUCH_DOLLY_SCREEN_PAN)&&(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),((this._state&U.DOLLY)===U.DOLLY||(this._state&U.TOUCH_DOLLY)===U.TOUCH_DOLLY||(this._state&U.TOUCH_DOLLY_TRUCK)===U.TOUCH_DOLLY_TRUCK||(this._state&U.TOUCH_DOLLY_SCREEN_PAN)===U.TOUCH_DOLLY_SCREEN_PAN||(this._state&U.TOUCH_DOLLY_OFFSET)===U.TOUCH_DOLLY_OFFSET||(this._state&U.TOUCH_DOLLY_ROTATE)===U.TOUCH_DOLLY_ROTATE)&&(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),((this._state&U.ZOOM)===U.ZOOM||(this._state&U.TOUCH_ZOOM)===U.TOUCH_ZOOM||(this._state&U.TOUCH_ZOOM_TRUCK)===U.TOUCH_ZOOM_TRUCK||(this._state&U.TOUCH_ZOOM_SCREEN_PAN)===U.TOUCH_ZOOM_SCREEN_PAN||(this._state&U.TOUCH_ZOOM_OFFSET)===U.TOUCH_ZOOM_OFFSET||(this._state&U.TOUCH_ZOOM_ROTATE)===U.TOUCH_ZOOM_ROTATE)&&(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),((this._state&U.OFFSET)===U.OFFSET||(this._state&U.TOUCH_OFFSET)===U.TOUCH_OFFSET||(this._state&U.TOUCH_DOLLY_OFFSET)===U.TOUCH_DOLLY_OFFSET||(this._state&U.TOUCH_ZOOM_OFFSET)===U.TOUCH_ZOOM_OFFSET)&&(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})},d=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,Cs(this._activePointers,Ft);const y=this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,v=y?-y.deltaX:s.x-Ft.x,x=y?-y.deltaY:s.y-Ft.y;if(s.copy(Ft),((this._state&U.ROTATE)===U.ROTATE||(this._state&U.TOUCH_ROTATE)===U.TOUCH_ROTATE||(this._state&U.TOUCH_DOLLY_ROTATE)===U.TOUCH_DOLLY_ROTATE||(this._state&U.TOUCH_ZOOM_ROTATE)===U.TOUCH_ZOOM_ROTATE)&&(this._rotateInternal(v,x),this._isUserControllingRotate=!0),(this._state&U.DOLLY)===U.DOLLY||(this._state&U.ZOOM)===U.ZOOM){const T=this.dollyToCursor?(i.x-this._elementRect.x)/this._elementRect.width*2-1:0,A=this.dollyToCursor?(i.y-this._elementRect.y)/this._elementRect.height*-2+1:0,S=this.dollyDragInverted?-1:1;(this._state&U.DOLLY)===U.DOLLY?(this._dollyInternal(S*x*ki,T,A),this._isUserControllingDolly=!0):(this._zoomInternal(S*x*ki,T,A),this._isUserControllingZoom=!0)}if((this._state&U.TOUCH_DOLLY)===U.TOUCH_DOLLY||(this._state&U.TOUCH_ZOOM)===U.TOUCH_ZOOM||(this._state&U.TOUCH_DOLLY_TRUCK)===U.TOUCH_DOLLY_TRUCK||(this._state&U.TOUCH_ZOOM_TRUCK)===U.TOUCH_ZOOM_TRUCK||(this._state&U.TOUCH_DOLLY_SCREEN_PAN)===U.TOUCH_DOLLY_SCREEN_PAN||(this._state&U.TOUCH_ZOOM_SCREEN_PAN)===U.TOUCH_ZOOM_SCREEN_PAN||(this._state&U.TOUCH_DOLLY_OFFSET)===U.TOUCH_DOLLY_OFFSET||(this._state&U.TOUCH_ZOOM_OFFSET)===U.TOUCH_ZOOM_OFFSET||(this._state&U.TOUCH_DOLLY_ROTATE)===U.TOUCH_DOLLY_ROTATE||(this._state&U.TOUCH_ZOOM_ROTATE)===U.TOUCH_ZOOM_ROTATE){const T=Ft.x-this._activePointers[1].clientX,A=Ft.y-this._activePointers[1].clientY,S=Math.sqrt(T*T+A*A),M=n.y-S;n.set(0,S);const I=this.dollyToCursor?(s.x-this._elementRect.x)/this._elementRect.width*2-1:0,k=this.dollyToCursor?(s.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&U.TOUCH_DOLLY)===U.TOUCH_DOLLY||(this._state&U.TOUCH_DOLLY_ROTATE)===U.TOUCH_DOLLY_ROTATE||(this._state&U.TOUCH_DOLLY_TRUCK)===U.TOUCH_DOLLY_TRUCK||(this._state&U.TOUCH_DOLLY_SCREEN_PAN)===U.TOUCH_DOLLY_SCREEN_PAN||(this._state&U.TOUCH_DOLLY_OFFSET)===U.TOUCH_DOLLY_OFFSET?(this._dollyInternal(M*ki,I,k),this._isUserControllingDolly=!0):(this._zoomInternal(M*ki,I,k),this._isUserControllingZoom=!0)}((this._state&U.TRUCK)===U.TRUCK||(this._state&U.TOUCH_TRUCK)===U.TOUCH_TRUCK||(this._state&U.TOUCH_DOLLY_TRUCK)===U.TOUCH_DOLLY_TRUCK||(this._state&U.TOUCH_ZOOM_TRUCK)===U.TOUCH_ZOOM_TRUCK)&&(this._truckInternal(v,x,!1,!1),this._isUserControllingTruck=!0),((this._state&U.SCREEN_PAN)===U.SCREEN_PAN||(this._state&U.TOUCH_SCREEN_PAN)===U.TOUCH_SCREEN_PAN||(this._state&U.TOUCH_DOLLY_SCREEN_PAN)===U.TOUCH_DOLLY_SCREEN_PAN||(this._state&U.TOUCH_ZOOM_SCREEN_PAN)===U.TOUCH_ZOOM_SCREEN_PAN)&&(this._truckInternal(v,x,!1,!0),this._isUserControllingTruck=!0),((this._state&U.OFFSET)===U.OFFSET||(this._state&U.TOUCH_OFFSET)===U.TOUCH_OFFSET||(this._state&U.TOUCH_DOLLY_OFFSET)===U.TOUCH_DOLLY_OFFSET||(this._state&U.TOUCH_ZOOM_OFFSET)===U.TOUCH_ZOOM_OFFSET)&&(this._truckInternal(v,x,!0,!1),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},g=()=>{Cs(this._activePointers,Ft),s.copy(Ft),this._dragNeedsUpdate=!1,(this._activePointers.length===0||this._activePointers.length===1&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),this._activePointers.length===0&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{!this._enabled||!this._domElement||(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",m),this._domElement.ownerDocument.addEventListener("pointerlockerror",b),this._domElement.ownerDocument.addEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",l),p())},this.unlockPointer=()=>{var f,y,v;this._lockedPointer!==null&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),(f=this._domElement)===null||f===void 0||f.ownerDocument.exitPointerLock(),(y=this._domElement)===null||y===void 0||y.ownerDocument.removeEventListener("pointerlockchange",m),(v=this._domElement)===null||v===void 0||v.ownerDocument.removeEventListener("pointerlockerror",b),this.cancel()};const m=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},b=()=>{this.unlockPointer()};this._addAllEventListeners=f=>{this._domElement=f,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",r),this._domElement.addEventListener("pointercancel",l),this._domElement.addEventListener("wheel",u,{passive:!1}),this._domElement.addEventListener("contextmenu",h)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",r),this._domElement.removeEventListener("pointercancel",l),this._domElement.removeEventListener("wheel",u,{passive:!1}),this._domElement.removeEventListener("contextmenu",h),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.ownerDocument.removeEventListener("pointerlockchange",m),this._domElement.ownerDocument.removeEventListener("pointerlockerror",b))},this.cancel=()=>{this._state!==U.NONE&&(this._state=U.NONE,this._activePointers.length=0,g())},t&&this.connect(t),this.update(0)}get camera(){return this._camera}set camera(e){this._camera=e,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._domElement&&(e?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(e){this._spherical.radius===e&&this._sphericalEnd.radius===e||(this._spherical.radius=e,this._sphericalEnd.radius=e,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(e){this._spherical.theta===e&&this._sphericalEnd.theta===e||(this._spherical.theta=e,this._sphericalEnd.theta=e,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(e){this._spherical.phi===e&&this._sphericalEnd.phi===e||(this._spherical.phi=e,this._sphericalEnd.phi=e,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(e){this._boundaryEnclosesCamera=e,this._needsUpdate=!0}set interactiveArea(e){this._interactiveArea.width=ee(e.width,0,1),this._interactiveArea.height=ee(e.height,0,1),this._interactiveArea.x=ee(e.x,0,1-this._interactiveArea.width),this._interactiveArea.y=ee(e.y,0,1-this._interactiveArea.height)}addEventListener(e,t){super.addEventListener(e,t)}removeEventListener(e,t){super.removeEventListener(e,t)}rotate(e,t,i=!1){return this.rotateTo(this._sphericalEnd.theta+e,this._sphericalEnd.phi+t,i)}rotateAzimuthTo(e,t=!1){return this.rotateTo(e,this._sphericalEnd.phi,t)}rotatePolarTo(e,t=!1){return this.rotateTo(this._sphericalEnd.theta,e,t)}rotateTo(e,t,i=!1){this._isUserControllingRotate=!1;const s=ee(e,this.minAzimuthAngle,this.maxAzimuthAngle),n=ee(t,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=s,this._sphericalEnd.phi=n,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,i||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const r=!i||pt(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&pt(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(r)}dolly(e,t=!1){return this.dollyTo(this._sphericalEnd.radius-e,t)}dollyTo(e,t=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=ze.NONE,this._changedDolly=0,this._dollyToNoClamp(ee(e,this.minDistance,this.maxDistance),t)}_dollyToNoClamp(e,t=!1){const i=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const r=this._collisionTest(),o=pt(r,this._spherical.radius);if(!(i>e)&&o)return Promise.resolve();this._sphericalEnd.radius=Math.min(e,r)}else this._sphericalEnd.radius=e;this._needsUpdate=!0,t||(this._spherical.radius=this._sphericalEnd.radius);const n=!t||pt(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(n)}dollyInFixed(e,t=!1){this._targetEnd.add(this._getCameraDirection(ai).multiplyScalar(e)),t||this._target.copy(this._targetEnd);const i=!t||pt(this._target.x,this._targetEnd.x,this.restThreshold)&&pt(this._target.y,this._targetEnd.y,this.restThreshold)&&pt(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(i)}zoom(e,t=!1){return this.zoomTo(this._zoomEnd+e,t)}zoomTo(e,t=!1){this._isUserControllingZoom=!1,this._zoomEnd=ee(e,this.minZoom,this.maxZoom),this._needsUpdate=!0,t||(this._zoom=this._zoomEnd);const i=!t||pt(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(i)}pan(e,t,i=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(e,t,i)}truck(e,t,i=!1){this._camera.updateMatrix(),ae.setFromMatrixColumn(this._camera.matrix,0),le.setFromMatrixColumn(this._camera.matrix,1),ae.multiplyScalar(e),le.multiplyScalar(-t);const s=at.copy(ae).add(le),n=dt.copy(this._targetEnd).add(s);return this.moveTo(n.x,n.y,n.z,i)}forward(e,t=!1){at.setFromMatrixColumn(this._camera.matrix,0),at.crossVectors(this._camera.up,at),at.multiplyScalar(e);const i=dt.copy(this._targetEnd).add(at);return this.moveTo(i.x,i.y,i.z,t)}elevate(e,t=!1){return at.copy(this._camera.up).multiplyScalar(e),this.moveTo(this._targetEnd.x+at.x,this._targetEnd.y+at.y,this._targetEnd.z+at.z,t)}moveTo(e,t,i,s=!1){this._isUserControllingTruck=!1;const n=at.set(e,t,i).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,n,this.boundaryFriction),this._needsUpdate=!0,s||this._target.copy(this._targetEnd);const r=!s||pt(this._target.x,this._targetEnd.x,this.restThreshold)&&pt(this._target.y,this._targetEnd.y,this.restThreshold)&&pt(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(r)}lookInDirectionOf(e,t,i,s=!1){const o=at.set(e,t,i).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius).add(this._targetEnd);return this.setPosition(o.x,o.y,o.z,s)}fitToBox(e,t,{cover:i=!1,paddingLeft:s=0,paddingRight:n=0,paddingBottom:r=0,paddingTop:o=0}={}){const l=[],c=e.isBox3?De.copy(e):De.setFromObject(e);c.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const u=kn(this._sphericalEnd.theta,Mn),h=kn(this._sphericalEnd.phi,Mn);l.push(this.rotateTo(u,h,t));const p=at.setFromSpherical(this._sphericalEnd).normalize(),d=Rn.setFromUnitVectors(p,Ss),g=pt(Math.abs(p.y),1);g&&d.multiply(Ps.setFromAxisAngle(zi,u)),d.multiply(this._yAxisUpSpaceInverse);const m=Bn.makeEmpty();dt.copy(c.min).applyQuaternion(d),m.expandByPoint(dt),dt.copy(c.min).setX(c.max.x).applyQuaternion(d),m.expandByPoint(dt),dt.copy(c.min).setY(c.max.y).applyQuaternion(d),m.expandByPoint(dt),dt.copy(c.max).setZ(c.min.z).applyQuaternion(d),m.expandByPoint(dt),dt.copy(c.min).setZ(c.max.z).applyQuaternion(d),m.expandByPoint(dt),dt.copy(c.max).setY(c.min.y).applyQuaternion(d),m.expandByPoint(dt),dt.copy(c.max).setX(c.min.x).applyQuaternion(d),m.expandByPoint(dt),dt.copy(c.max).applyQuaternion(d),m.expandByPoint(dt),m.min.x-=s,m.min.y-=r,m.max.x+=n,m.max.y+=o,d.setFromUnitVectors(Ss,p),g&&d.premultiply(Ps.invert()),d.premultiply(this._yAxisUpSpace);const b=m.getSize(at),f=m.getCenter(dt).applyQuaternion(d);if(Oe(this._camera)){const y=this.getDistanceToFitBox(b.x,b.y,b.z,i);l.push(this.moveTo(f.x,f.y,f.z,t)),l.push(this.dollyTo(y,t)),l.push(this.setFocalOffset(0,0,0,t))}else if(ve(this._camera)){const y=this._camera,v=y.right-y.left,x=y.top-y.bottom,T=i?Math.max(v/b.x,x/b.y):Math.min(v/b.x,x/b.y);l.push(this.moveTo(f.x,f.y,f.z,t)),l.push(this.zoomTo(T,t)),l.push(this.setFocalOffset(0,0,0,t))}return Promise.all(l)}fitToSphere(e,t){const i=[],n="isObject3D"in e?Nt.createBoundingSphere(e,Os):Os.copy(e);if(i.push(this.moveTo(n.center.x,n.center.y,n.center.z,t)),Oe(this._camera)){const r=this.getDistanceToFitSphere(n.radius);i.push(this.dollyTo(r,t))}else if(ve(this._camera)){const r=this._camera.right-this._camera.left,o=this._camera.top-this._camera.bottom,l=2*n.radius,c=Math.min(r/l,o/l);i.push(this.zoomTo(c,t))}return i.push(this.setFocalOffset(0,0,0,t)),Promise.all(i)}setLookAt(e,t,i,s,n,r,o=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=ze.NONE,this._changedDolly=0;const l=dt.set(s,n,r),c=at.set(e,t,i);this._targetEnd.copy(l),this._sphericalEnd.setFromVector3(c.sub(l).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,o||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const u=!o||pt(this._target.x,this._targetEnd.x,this.restThreshold)&&pt(this._target.y,this._targetEnd.y,this.restThreshold)&&pt(this._target.z,this._targetEnd.z,this.restThreshold)&&pt(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&pt(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&pt(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(u)}lerpLookAt(e,t,i,s,n,r,o,l,c,u,h,p,d,g=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=ze.NONE,this._changedDolly=0;const m=at.set(s,n,r),b=dt.set(e,t,i);Wt.setFromVector3(b.sub(m).applyQuaternion(this._yAxisUpSpace));const f=Le.set(u,h,p),y=dt.set(o,l,c);li.setFromVector3(y.sub(f).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(m.lerp(f,d));const v=li.theta-Wt.theta,x=li.phi-Wt.phi,T=li.radius-Wt.radius;this._sphericalEnd.set(Wt.radius+T*d,Wt.phi+x*d,Wt.theta+v*d),this.normalizeRotations(),this._needsUpdate=!0,g||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const A=!g||pt(this._target.x,this._targetEnd.x,this.restThreshold)&&pt(this._target.y,this._targetEnd.y,this.restThreshold)&&pt(this._target.z,this._targetEnd.z,this.restThreshold)&&pt(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&pt(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&pt(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(A)}setPosition(e,t,i,s=!1){return this.setLookAt(e,t,i,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,s)}setTarget(e,t,i,s=!1){const n=this.getPosition(at),r=this.setLookAt(n.x,n.y,n.z,e,t,i,s);return this._sphericalEnd.phi=ee(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),r}setFocalOffset(e,t,i,s=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(e,t,i),this._needsUpdate=!0,s||this._focalOffset.copy(this._focalOffsetEnd);const n=!s||pt(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&pt(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&pt(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(n)}setOrbitPoint(e,t,i){this._camera.updateMatrixWorld(),ae.setFromMatrixColumn(this._camera.matrixWorldInverse,0),le.setFromMatrixColumn(this._camera.matrixWorldInverse,1),Pe.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const s=at.set(e,t,i),n=s.distanceTo(this._camera.position),r=s.sub(this._camera.position);ae.multiplyScalar(r.x),le.multiplyScalar(r.y),Pe.multiplyScalar(r.z),at.copy(ae).add(le).add(Pe),at.z=at.z+n,this.dollyTo(n,!1),this.setFocalOffset(-at.x,at.y,-at.z,!1),this.moveTo(e,t,i,!1)}setBoundary(e){if(!e){this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),this._needsUpdate=!0;return}this._boundary.copy(e),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(e,t,i,s){if(e===null){this._viewport=null;return}this._viewport=this._viewport||new ot.Vector4,typeof e=="number"?this._viewport.set(e,t,i,s):this._viewport.copy(e)}getDistanceToFitBox(e,t,i,s=!1){if(Es(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const n=e/t,r=this._camera.getEffectiveFOV()*ni,o=this._camera.aspect;return((s?n>o:n<o)?t:e/o)*.5/Math.tan(r*.5)+i*.5}getDistanceToFitSphere(e){if(Es(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const t=this._camera.getEffectiveFOV()*ni,i=Math.atan(Math.tan(t*.5)*this._camera.aspect)*2,s=1<this._camera.aspect?t:i;return e/Math.sin(s*.5)}getTarget(e,t=!0){return(e&&e.isVector3?e:new ot.Vector3).copy(t?this._targetEnd:this._target)}getPosition(e,t=!0){return(e&&e.isVector3?e:new ot.Vector3).setFromSpherical(t?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(t?this._targetEnd:this._target)}getSpherical(e,t=!0){return(e||new ot.Spherical).copy(t?this._sphericalEnd:this._spherical)}getFocalOffset(e,t=!0){return(e&&e.isVector3?e:new ot.Vector3).copy(t?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%Ne,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=Ne),this._spherical.theta+=Ne*Math.round((this._sphericalEnd.theta-this._spherical.theta)/Ne)}stop(){this._focalOffset.copy(this._focalOffsetEnd),this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd),this._zoom=this._zoomEnd}reset(e=!1){if(!pt(this._camera.up.x,this._cameraUp0.x)||!pt(this._camera.up.y,this._cameraUp0.y)||!pt(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const i=this.getPosition(at);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}const t=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,e),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,e),this.zoomTo(this._zoom0,e)];return Promise.all(t)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,zi),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const e=at.subVectors(this._target,this._camera.position).normalize(),t=dt.crossVectors(e,this._camera.up);this._camera.up.crossVectors(t,e).normalize(),this._camera.updateMatrixWorld();const i=this.getPosition(at);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}update(e){const t=this._sphericalEnd.theta-this._spherical.theta,i=this._sphericalEnd.phi-this._spherical.phi,s=this._sphericalEnd.radius-this._spherical.radius,n=Ln.subVectors(this._targetEnd,this._target),r=Dn.subVectors(this._focalOffsetEnd,this._focalOffset),o=this._zoomEnd-this._zoom;if(yt(t))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const h=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=Mi(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,h,1/0,e),this._needsUpdate=!0}if(yt(i))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const h=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=Mi(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,h,1/0,e),this._needsUpdate=!0}if(yt(s))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const h=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=Mi(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,h,this.maxSpeed,e),this._needsUpdate=!0}if(yt(n.x)&&yt(n.y)&&yt(n.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const h=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;zn(this._target,this._targetEnd,this._targetVelocity,h,this.maxSpeed,e,this._target),this._needsUpdate=!0}if(yt(r.x)&&yt(r.y)&&yt(r.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const h=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;zn(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,h,this.maxSpeed,e,this._focalOffset),this._needsUpdate=!0}if(yt(o))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const h=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=Mi(this._zoom,this._zoomEnd,this._zoomVelocity,h,1/0,e)}if(this.dollyToCursor){if(Oe(this._camera)&&this._changedDolly!==0){const h=this._spherical.radius-this._lastDistance,p=this._camera,d=this._getCameraDirection(ai),g=at.copy(d).cross(p.up).normalize();g.lengthSq()===0&&(g.x=1);const m=dt.crossVectors(g,d),b=this._sphericalEnd.radius*Math.tan(p.getEffectiveFOV()*ni*.5),y=(this._sphericalEnd.radius-h-this._sphericalEnd.radius)/this._sphericalEnd.radius,v=Le.copy(this._targetEnd).add(g.multiplyScalar(this._dollyControlCoord.x*b*p.aspect)).add(m.multiplyScalar(this._dollyControlCoord.y*b)),x=at.copy(this._targetEnd).lerp(v,y),T=this._lastDollyDirection===ze.IN&&this._spherical.radius<=this.minDistance,A=this._lastDollyDirection===ze.OUT&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(T||A)){this._sphericalEnd.radius-=h,this._spherical.radius-=h;const M=dt.copy(d).multiplyScalar(-h);x.add(M)}this._boundary.clampPoint(x,x);const S=dt.subVectors(x,this._targetEnd);this._targetEnd.copy(x),this._target.add(S),this._changedDolly-=h,yt(this._changedDolly)&&(this._changedDolly=0)}else if(ve(this._camera)&&this._changedZoom!==0){const h=this._zoom-this._lastZoom,p=this._camera,d=at.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(p.near+p.far)/(p.near-p.far)).unproject(p),g=dt.set(0,0,-1).applyQuaternion(p.quaternion),m=Le.copy(d).add(g.multiplyScalar(-d.dot(p.up))),f=-(this._zoom-h-this._zoom)/this._zoom,y=this._getCameraDirection(ai),v=this._targetEnd.dot(y),x=at.copy(this._targetEnd).lerp(m,f),T=x.dot(y),A=y.multiplyScalar(T-v);x.sub(A),this._boundary.clampPoint(x,x);const S=dt.subVectors(x,this._targetEnd);this._targetEnd.copy(x),this._target.add(S),this._changedZoom-=h,yt(this._changedZoom)&&(this._changedZoom=0)}}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const l=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,l),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target),(!yt(this._focalOffset.x)||!yt(this._focalOffset.y)||!yt(this._focalOffset.z))&&(ae.setFromMatrixColumn(this._camera.matrix,0),le.setFromMatrixColumn(this._camera.matrix,1),Pe.setFromMatrixColumn(this._camera.matrix,2),ae.multiplyScalar(this._focalOffset.x),le.multiplyScalar(-this._focalOffset.y),Pe.multiplyScalar(this._focalOffset.z),at.copy(ae).add(le).add(Pe),this._camera.position.add(at),this._camera.updateMatrixWorld()),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),at.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const u=this._needsUpdate;return u&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):u?(this.dispatchEvent({type:"update"}),yt(t,this.restThreshold)&&yt(i,this.restThreshold)&&yt(s,this.restThreshold)&&yt(n.x,this.restThreshold)&&yt(n.y,this.restThreshold)&&yt(n.z,this.restThreshold)&&yt(r.x,this.restThreshold)&&yt(r.y,this.restThreshold)&&yt(r.z,this.restThreshold)&&yt(o,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!u&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=u,this._needsUpdate=!1,u}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:ri(this.maxDistance),minZoom:this.minZoom,maxZoom:ri(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:ri(this.maxPolarAngle),minAzimuthAngle:ri(this.minAzimuthAngle),maxAzimuthAngle:ri(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,target:this._targetEnd.toArray(),position:at.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(e,t=!1){const i=JSON.parse(e);this.enabled=i.enabled,this.minDistance=i.minDistance,this.maxDistance=oi(i.maxDistance),this.minZoom=i.minZoom,this.maxZoom=oi(i.maxZoom),this.minPolarAngle=i.minPolarAngle,this.maxPolarAngle=oi(i.maxPolarAngle),this.minAzimuthAngle=oi(i.minAzimuthAngle),this.maxAzimuthAngle=oi(i.maxAzimuthAngle),this.smoothTime=i.smoothTime,this.draggingSmoothTime=i.draggingSmoothTime,this.dollySpeed=i.dollySpeed,this.truckSpeed=i.truckSpeed,this.dollyToCursor=i.dollyToCursor,this._target0.fromArray(i.target0),this._position0.fromArray(i.position0),this._zoom0=i.zoom0,this._focalOffset0.fromArray(i.focalOffset0),this.moveTo(i.target[0],i.target[1],i.target[2],t),Wt.setFromVector3(at.fromArray(i.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(Wt.theta,Wt.phi,t),this.dollyTo(Wt.radius,t),this.zoomTo(i.zoom,t),this.setFocalOffset(i.focalOffset[0],i.focalOffset[1],i.focalOffset[2],t),this._needsUpdate=!0}connect(e){if(this._domElement){console.warn("camera-controls is already connected.");return}e.setAttribute("data-camera-controls-version",za),this._addAllEventListeners(e),this._getClientRect(this._elementRect)}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(e){return e.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(e){return this._getTargetDirection(e).negate()}_findPointerById(e){return this._activePointers.find(t=>t.pointerId===e)}_findPointerByMouseButton(e){return this._activePointers.find(t=>t.mouseButton===e)}_disposePointer(e){this._activePointers.splice(this._activePointers.indexOf(e),1)}_encloseToBoundary(e,t,i){const s=t.lengthSq();if(s===0)return e;const n=dt.copy(t).add(e),o=this._boundary.clampPoint(n,Le).sub(n),l=o.lengthSq();if(l===0)return e.add(t);if(l===s)return e;if(i===0)return e.add(t).add(o);{const c=1+i*l/t.dot(o);return e.add(dt.copy(t).multiplyScalar(c)).add(o.multiplyScalar(1-i))}}_updateNearPlaneCorners(){if(Oe(this._camera)){const e=this._camera,t=e.near,i=e.getEffectiveFOV()*ni,s=Math.tan(i*.5)*t,n=s*e.aspect;this._nearPlaneCorners[0].set(-n,-s,0),this._nearPlaneCorners[1].set(n,-s,0),this._nearPlaneCorners[2].set(n,s,0),this._nearPlaneCorners[3].set(-n,s,0)}else if(ve(this._camera)){const e=this._camera,t=1/e.zoom,i=e.left*t,s=e.right*t,n=e.top*t,r=e.bottom*t;this._nearPlaneCorners[0].set(i,n,0),this._nearPlaneCorners[1].set(s,n,0),this._nearPlaneCorners[2].set(s,r,0),this._nearPlaneCorners[3].set(i,r,0)}}_collisionTest(){let e=1/0;if(!(this.colliderMeshes.length>=1)||Es(this._camera,"_collisionTest"))return e;const i=this._getTargetDirection(ai);Is.lookAt(Nn,i,this._camera.up);for(let s=0;s<4;s++){const n=dt.copy(this._nearPlaneCorners[s]);n.applyMatrix4(Is);const r=Le.addVectors(this._target,n);Ni.set(r,i),Ni.far=this._spherical.radius+1;const o=Ni.intersectObjects(this.colliderMeshes);o.length!==0&&o[0].distance<e&&(e=o[0].distance)}return e}_getClientRect(e){if(!this._domElement)return;const t=this._domElement.getBoundingClientRect();return e.x=t.left,e.y=t.top,this._viewport?(e.x+=this._viewport.x,e.y+=t.height-this._viewport.w-this._viewport.y,e.width=this._viewport.z,e.height=this._viewport.w):(e.width=t.width,e.height=t.height),e}_createOnRestPromise(e){return e?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise(t=>{const i=()=>{this.removeEventListener("rest",i),t()};this.addEventListener("rest",i)}))}_addAllEventListeners(e){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(e){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(e){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(e,t=new ot.Sphere){const i=t,s=i.center;De.makeEmpty(),e.traverseVisible(r=>{r.isMesh&&De.expandByObject(r)}),De.getCenter(s);let n=0;return e.traverseVisible(r=>{if(!r.isMesh)return;const o=r;if(!o.geometry)return;const l=o.geometry.clone();l.applyMatrix4(o.matrixWorld);const u=l.attributes.position;for(let h=0,p=u.count;h<p;h++)at.fromBufferAttribute(u,h),n=Math.max(n,s.distanceToSquared(at))}),i.radius=Math.sqrt(n),i}}class gn extends ao{constructor(t){super(t);C(this,"onBeforeUpdate",new rt);C(this,"onAfterUpdate",new rt);C(this,"onAspectUpdated",new rt);C(this,"onDisposed",new rt);C(this,"three");C(this,"_allControls",new Map);C(this,"updateAspect",()=>{var t;if(!(!this.currentWorld||!this.currentWorld.renderer)){if(this.three instanceof ln){this.onAspectUpdated.trigger();return}if((t=this.currentWorld.renderer)!=null&&t.isResizeable()){const i=this.currentWorld.renderer.getSize();this.three.aspect=i.width/i.height,this.three.updateProjectionMatrix(),this.onAspectUpdated.trigger()}}});this.three=this.setupCamera(),this.setupEvents(!0),this.worlds.onItemSet.add(({value:i})=>{const s=this.newCameraControls();this._allControls.set(i.uuid,s)}),this.worlds.onBeforeDelete.add(({value:i})=>{const s=this._allControls.get(i.uuid);s&&(s.dispose(),this._allControls.delete(i.uuid))})}get controls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");const t=this._allControls.get(this.currentWorld.uuid);if(!t)throw new Error("Controls not found!");return t}get enabled(){return this.currentWorld===null?!1:this.controls.enabled}set enabled(t){this.currentWorld!==null&&(this.controls.enabled=t)}set currentWorld(t){if(super.currentWorld=t,!t)return;this.worlds.get(t.uuid)||this.worlds.set(t.uuid,t)}get currentWorld(){return this._currentWorld}dispose(){this.setupEvents(!1),this.onAspectUpdated.reset(),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.three.removeFromParent(),this.onDisposed.trigger(),this.onDisposed.reset();for(const[t,i]of this._allControls)i.dispose();this.worlds.clear()}async fitToItems(t){const i=await this.getItemsBounding(t);await this.controls.fitToSphere(i,!0)}async setOrbitToItems(t){const i=await this.getItemsBounding(t);this.controls.setOrbitPoint(i.center.x,i.center.y,i.center.z)}update(t){this.enabled&&(this.onBeforeUpdate.trigger(this),this.controls.update(t),this.onAfterUpdate.trigger(this))}async getItemsBounding(t){const i=this.components.get(ft),s=this.components.get(Xs);s.list.clear();const n=new is;if(t)await s.addFromModelIdMap(t);else for(const[,r]of i.list)s.list.add(r.box);return s.get().getBoundingSphere(n),s.list.clear(),n}setupCamera(){const t=window.innerWidth/window.innerHeight,i=new _r(60,t,1,1e3);return i.position.set(50,50,50),i.lookAt(new Z(0,0,0)),i}newCameraControls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");if(!this.currentWorld.renderer)throw new Error("This camera needs a renderer to work!");Nt.install({THREE:gn.getSubsetOfThree()});const{domElement:t}=this.currentWorld.renderer.three,i=new Nt(this.three,t);return i.smoothTime=.2,i.dollyToCursor=!0,i.infinityDolly=!0,i.minDistance=6,i}setupEvents(t){t?window.addEventListener("resize",this.updateAspect):window.removeEventListener("resize",this.updateAspect)}static getSubsetOfThree(){return{MOUSE:qr,Vector2:jt,Vector3:Z,Vector4:Wr,Quaternion:se,Matrix4:It,Spherical:Xr,Box3:Lt,Sphere:is,Raycaster:an,MathUtils:jr}}}const gs=class gs extends te{constructor(t){super(t);C(this,"onAfterUpdate",new rt);C(this,"onBeforeUpdate",new rt);C(this,"onDisposed",new rt);C(this,"list",new Vt);C(this,"enabled",!0);t.add(gs.uuid,this)}create(){const t=new Oa(this.components),i=t.uuid;if(this.list.has(i))throw new Error("There is already a world with this name!");return this.list.set(i,t),t}delete(t){if(!this.list.has(t.uuid))throw new Error("The provided world is not found in the list!");this.list.delete(t.uuid),t.dispose()}dispose(){this.enabled=!1;for(const[t,i]of this.list)i.dispose();this.list.clear(),this.onDisposed.trigger()}update(t){if(this.enabled)for(const[i,s]of this.list)s.update(t)}};C(gs,"uuid","fdb61dc4-2ec1-4966-b83d-54ea795fad4a");let ls=gs;const Or=0,La=1,Da=2,Un=2,Ms=1.25,Fn=1,ts=6*4+4+4,bs=65535,Ba=Math.pow(2,-24),ks=Symbol("SKIP_GENERATION");function Ra(a){return a.index?a.index.count:a.attributes.position.count}function Ge(a){return Ra(a)/3}function Ua(a,e=ArrayBuffer){return a>65535?new Uint32Array(new e(4*a)):new Uint16Array(new e(2*a))}function Fa(a,e){if(!a.index){const t=a.attributes.position.count,i=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,s=Ua(t,i);a.setIndex(new yr(s,1));for(let n=0;n<t;n++)s[n]=n}}function Pr(a){const e=Ge(a),t=a.drawRange,i=t.start/3,s=(t.start+t.count)/3,n=Math.max(0,i),r=Math.min(e,s)-n;return[{offset:Math.floor(n),count:Math.floor(r)}]}function Ir(a){if(!a.groups||!a.groups.length)return Pr(a);const e=[],t=new Set,i=a.drawRange,s=i.start/3,n=(i.start+i.count)/3;for(const o of a.groups){const l=o.start/3,c=(o.start+o.count)/3;t.add(Math.max(s,l)),t.add(Math.min(n,c))}const r=Array.from(t.values()).sort((o,l)=>o-l);for(let o=0;o<r.length-1;o++){const l=r[o],c=r[o+1];e.push({offset:Math.floor(l),count:Math.floor(c-l)})}return e}function Va(a){if(a.groups.length===0)return!1;const e=Ge(a),t=Ir(a).sort((n,r)=>n.offset-r.offset),i=t[t.length-1];i.count=Math.min(e-i.offset,i.count);let s=0;return t.forEach(({count:n})=>s+=n),e!==s}function Tt(a,e,t){return t.min.x=e[a],t.min.y=e[a+1],t.min.z=e[a+2],t.max.x=e[a+3],t.max.y=e[a+4],t.max.z=e[a+5],t}function Ha(a){a[0]=a[1]=a[2]=1/0,a[3]=a[4]=a[5]=-1/0}function Vn(a){let e=-1,t=-1/0;for(let i=0;i<3;i++){const s=a[i+3]-a[i];s>t&&(t=s,e=i)}return e}function Hn(a,e){e.set(a)}function $n(a,e,t){let i,s;for(let n=0;n<3;n++){const r=n+3;i=a[n],s=e[n],t[n]=i<s?i:s,i=a[r],s=e[r],t[r]=i>s?i:s}}function Li(a,e,t){for(let i=0;i<3;i++){const s=e[a+2*i],n=e[a+2*i+1],r=s-n,o=s+n;r<t[i]&&(t[i]=r),o>t[i+3]&&(t[i+3]=o)}}function ci(a){const e=a[3]-a[0],t=a[4]-a[1],i=a[5]-a[2];return 2*(e*t+t*i+i*e)}function zs(a,e,t,i,s=null){let n=1/0,r=1/0,o=1/0,l=-1/0,c=-1/0,u=-1/0,h=1/0,p=1/0,d=1/0,g=-1/0,m=-1/0,b=-1/0;const f=s!==null;for(let y=e*6,v=(e+t)*6;y<v;y+=6){const x=a[y+0],T=a[y+1],A=x-T,S=x+T;A<n&&(n=A),S>l&&(l=S),f&&x<h&&(h=x),f&&x>g&&(g=x);const M=a[y+2],I=a[y+3],k=M-I,$=M+I;k<r&&(r=k),$>c&&(c=$),f&&M<p&&(p=M),f&&M>m&&(m=M);const E=a[y+4],z=a[y+5],_=E-z,L=E+z;_<o&&(o=_),L>u&&(u=L),f&&E<d&&(d=E),f&&E>b&&(b=E)}i[0]=n,i[1]=r,i[2]=o,i[3]=l,i[4]=c,i[5]=u,f&&(s[0]=h,s[1]=p,s[2]=d,s[3]=g,s[4]=m,s[5]=b)}function $a(a,e,t,i){let s=1/0,n=1/0,r=1/0,o=-1/0,l=-1/0,c=-1/0;for(let u=e*6,h=(e+t)*6;u<h;u+=6){const p=a[u+0];p<s&&(s=p),p>o&&(o=p);const d=a[u+2];d<n&&(n=d),d>l&&(l=d);const g=a[u+4];g<r&&(r=g),g>c&&(c=g)}i[0]=s,i[1]=n,i[2]=r,i[3]=o,i[4]=l,i[5]=c}function Za(a,e){Ha(e);const t=a.attributes.position,i=a.index?a.index.array:null,s=Ge(a),n=new Float32Array(s*6),r=t.normalized,o=t.array,l=t.offset||0;let c=3;t.isInterleavedBufferAttribute&&(c=t.data.stride);const u=["getX","getY","getZ"];for(let h=0;h<s;h++){const p=h*3,d=h*6;let g=p+0,m=p+1,b=p+2;i&&(g=i[g],m=i[m],b=i[b]),r||(g=g*c+l,m=m*c+l,b=b*c+l);for(let f=0;f<3;f++){let y,v,x;r?(y=t[u[f]](g),v=t[u[f]](m),x=t[u[f]](b)):(y=o[g+f],v=o[m+f],x=o[b+f]);let T=y;v<T&&(T=v),x<T&&(T=x);let A=y;v>A&&(A=v),x>A&&(A=x);const S=(A-T)/2,M=f*2;n[d+M+0]=T+S,n[d+M+1]=S+(Math.abs(T)+S)*Ba,T<e[f]&&(e[f]=T),A>e[f+3]&&(e[f+3]=A)}}return n}const pe=32,Ya=(a,e)=>a.candidate-e.candidate,we=new Array(pe).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),Di=new Float32Array(6);function ja(a,e,t,i,s,n){let r=-1,o=0;if(n===Or)r=Vn(e),r!==-1&&(o=(e[r]+e[r+3])/2);else if(n===La)r=Vn(a),r!==-1&&(o=Xa(t,i,s,r));else if(n===Da){const l=ci(a);let c=Ms*s;const u=i*6,h=(i+s)*6;for(let p=0;p<3;p++){const d=e[p],b=(e[p+3]-d)/pe;if(s<pe/4){const f=[...we];f.length=s;let y=0;for(let x=u;x<h;x+=6,y++){const T=f[y];T.candidate=t[x+2*p],T.count=0;const{bounds:A,leftCacheBounds:S,rightCacheBounds:M}=T;for(let I=0;I<3;I++)M[I]=1/0,M[I+3]=-1/0,S[I]=1/0,S[I+3]=-1/0,A[I]=1/0,A[I+3]=-1/0;Li(x,t,A)}f.sort(Ya);let v=s;for(let x=0;x<v;x++){const T=f[x];for(;x+1<v&&f[x+1].candidate===T.candidate;)f.splice(x+1,1),v--}for(let x=u;x<h;x+=6){const T=t[x+2*p];for(let A=0;A<v;A++){const S=f[A];T>=S.candidate?Li(x,t,S.rightCacheBounds):(Li(x,t,S.leftCacheBounds),S.count++)}}for(let x=0;x<v;x++){const T=f[x],A=T.count,S=s-T.count,M=T.leftCacheBounds,I=T.rightCacheBounds;let k=0;A!==0&&(k=ci(M)/l);let $=0;S!==0&&($=ci(I)/l);const E=Fn+Ms*(k*A+$*S);E<c&&(r=p,c=E,o=T.candidate)}}else{for(let v=0;v<pe;v++){const x=we[v];x.count=0,x.candidate=d+b+v*b;const T=x.bounds;for(let A=0;A<3;A++)T[A]=1/0,T[A+3]=-1/0}for(let v=u;v<h;v+=6){let A=~~((t[v+2*p]-d)/b);A>=pe&&(A=pe-1);const S=we[A];S.count++,Li(v,t,S.bounds)}const f=we[pe-1];Hn(f.bounds,f.rightCacheBounds);for(let v=pe-2;v>=0;v--){const x=we[v],T=we[v+1];$n(x.bounds,T.rightCacheBounds,x.rightCacheBounds)}let y=0;for(let v=0;v<pe-1;v++){const x=we[v],T=x.count,A=x.bounds,M=we[v+1].rightCacheBounds;T!==0&&(y===0?Hn(A,Di):$n(A,Di,Di)),y+=T;let I=0,k=0;y!==0&&(I=ci(Di)/l);const $=s-y;$!==0&&(k=ci(M)/l);const E=Fn+Ms*(I*y+k*$);E<c&&(r=p,c=E,o=x.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${n} used.`);return{axis:r,pos:o}}function Xa(a,e,t,i){let s=0;for(let n=e,r=e+t;n<r;n++)s+=a[n*6+i*2];return s/t}class Bi{constructor(){}}function Wa(a,e,t,i,s,n){let r=i,o=i+s-1;const l=n.pos,c=n.axis*2;for(;;){for(;r<=o&&t[r*6+c]<l;)r++;for(;r<=o&&t[o*6+c]>=l;)o--;if(r<o){for(let u=0;u<3;u++){let h=e[r*3+u];e[r*3+u]=e[o*3+u],e[o*3+u]=h}for(let u=0;u<6;u++){let h=t[r*6+u];t[r*6+u]=t[o*6+u],t[o*6+u]=h}r++,o--}else return r}}function qa(a,e,t,i,s,n){let r=i,o=i+s-1;const l=n.pos,c=n.axis*2;for(;;){for(;r<=o&&t[r*6+c]<l;)r++;for(;r<=o&&t[o*6+c]>=l;)o--;if(r<o){let u=a[r];a[r]=a[o],a[o]=u;for(let h=0;h<6;h++){let p=t[r*6+h];t[r*6+h]=t[o*6+h],t[o*6+h]=p}r++,o--}else return r}}function Ga(a,e){const t=(a.index?a.index.count:a.attributes.position.count)/3,i=t>2**16,s=i?4:2,n=e?new SharedArrayBuffer(t*s):new ArrayBuffer(t*s),r=i?new Uint32Array(n):new Uint16Array(n);for(let o=0,l=r.length;o<l;o++)r[o]=o;return r}function Qa(a,e){const t=a.geometry,i=t.index?t.index.array:null,s=e.maxDepth,n=e.verbose,r=e.maxLeafTris,o=e.strategy,l=e.onProgress,c=Ge(t),u=a._indirectBuffer;let h=!1;const p=new Float32Array(6),d=new Float32Array(6),g=Za(t,p),m=e.indirect?qa:Wa,b=[],f=e.indirect?Pr(t):Ir(t);if(f.length===1){const x=f[0],T=new Bi;T.boundingData=p,$a(g,x.offset,x.count,d),v(T,x.offset,x.count,d),b.push(T)}else for(let x of f){const T=new Bi;T.boundingData=new Float32Array(6),zs(g,x.offset,x.count,T.boundingData,d),v(T,x.offset,x.count,d),b.push(T)}return b;function y(x){l&&l(x/c)}function v(x,T,A,S=null,M=0){if(!h&&M>=s&&(h=!0,n&&(console.warn(`MeshBVH: Max depth of ${s} reached when generating BVH. Consider increasing maxDepth.`),console.warn(t))),A<=r||M>=s)return y(T+A),x.offset=T,x.count=A,x;const I=ja(x.boundingData,S,g,T,A,o);if(I.axis===-1)return y(T+A),x.offset=T,x.count=A,x;const k=m(u,i,g,T,A,I);if(k===T||k===T+A)y(T+A),x.offset=T,x.count=A;else{x.splitAxis=I.axis;const $=new Bi,E=T,z=k-T;x.left=$,$.boundingData=new Float32Array(6),zs(g,E,z,$.boundingData,d),v($,E,z,d,M+1);const _=new Bi,L=k,W=A-z;x.right=_,_.boundingData=new Float32Array(6),zs(g,L,W,_.boundingData,d),v(_,L,W,d,M+1)}return x}}function Ka(a,e){const t=a.geometry;e.indirect&&(a._indirectBuffer=Ga(t,e.useSharedArrayBuffer),Va(t)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),a._indirectBuffer||Fa(t,e);const i=Qa(a,e);let s,n,r;const o=[],l=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let h=0;h<i.length;h++){const p=i[h];let d=c(p);const g=new l(ts*d);s=new Float32Array(g),n=new Uint32Array(g),r=new Uint16Array(g),u(0,p),o.push(g)}a._roots=o;return;function c(h){return h.count?1:1+c(h.left)+c(h.right)}function u(h,p){const d=h/4,g=h/2,m=!!p.count,b=p.boundingData;for(let f=0;f<6;f++)s[d+f]=b[f];if(m){const f=p.offset,y=p.count;return n[d+6]=f,r[g+14]=y,r[g+15]=bs,h+ts}else{const f=p.left,y=p.right,v=p.splitAxis;let x;if(x=u(h+ts,f),x/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return n[d+6]=x/4,x=u(x,y),n[d+7]=v,x}}}class _e{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let i=1/0,s=-1/0;for(let n=0,r=e.length;n<r;n++){const l=e[n][t];i=l<i?l:i,s=l>s?l:s}this.min=i,this.max=s}setFromPoints(e,t){let i=1/0,s=-1/0;for(let n=0,r=t.length;n<r;n++){const o=t[n],l=e.dot(o);i=l<i?l:i,s=l>s?l:s}this.min=i,this.max=s}isSeparated(e){return this.min>e.max||e.min>this.max}}_e.prototype.setFromBox=function(){const a=new Z;return function(t,i){const s=i.min,n=i.max;let r=1/0,o=-1/0;for(let l=0;l<=1;l++)for(let c=0;c<=1;c++)for(let u=0;u<=1;u++){a.x=s.x*l+n.x*(1-l),a.y=s.y*c+n.y*(1-c),a.z=s.z*u+n.z*(1-u);const h=t.dot(a);r=Math.min(h,r),o=Math.max(h,o)}this.min=r,this.max=o}}();const Ja=function(){const a=new Z,e=new Z,t=new Z;return function(s,n,r){const o=s.start,l=a,c=n.start,u=e;t.subVectors(o,c),a.subVectors(s.end,s.start),e.subVectors(n.end,n.start);const h=t.dot(u),p=u.dot(l),d=u.dot(u),g=t.dot(l),b=l.dot(l)*d-p*p;let f,y;b!==0?f=(h*p-g*d)/b:f=0,y=(h+f*p)/d,r.x=f,r.y=y}}(),_n=function(){const a=new jt,e=new Z,t=new Z;return function(s,n,r,o){Ja(s,n,a);let l=a.x,c=a.y;if(l>=0&&l<=1&&c>=0&&c<=1){s.at(l,r),n.at(c,o);return}else if(l>=0&&l<=1){c<0?n.at(0,o):n.at(1,o),s.closestPointToPoint(o,!0,r);return}else if(c>=0&&c<=1){l<0?s.at(0,r):s.at(1,r),n.closestPointToPoint(r,!0,o);return}else{let u;l<0?u=s.start:u=s.end;let h;c<0?h=n.start:h=n.end;const p=e,d=t;if(s.closestPointToPoint(h,!0,e),n.closestPointToPoint(u,!0,t),p.distanceToSquared(h)<=d.distanceToSquared(u)){r.copy(p),o.copy(h);return}else{r.copy(u),o.copy(d);return}}}}(),tl=function(){const a=new Z,e=new Z,t=new cn,i=new ge;return function(n,r){const{radius:o,center:l}=n,{a:c,b:u,c:h}=r;if(i.start=c,i.end=u,i.closestPointToPoint(l,!0,a).distanceTo(l)<=o||(i.start=c,i.end=h,i.closestPointToPoint(l,!0,a).distanceTo(l)<=o)||(i.start=u,i.end=h,i.closestPointToPoint(l,!0,a).distanceTo(l)<=o))return!0;const m=r.getPlane(t);if(Math.abs(m.distanceToPoint(l))<=o){const f=m.projectPoint(l,e);if(r.containsPoint(f))return!0}return!1}}(),el=1e-15;function Ns(a){return Math.abs(a)<el}class re extends _i{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new Z),this.satBounds=new Array(4).fill().map(()=>new _e),this.points=[this.a,this.b,this.c],this.sphere=new is,this.plane=new cn,this.needsUpdate=!0}intersectsSphere(e){return tl(e,this)}update(){const e=this.a,t=this.b,i=this.c,s=this.points,n=this.satAxes,r=this.satBounds,o=n[0],l=r[0];this.getNormal(o),l.setFromPoints(o,s);const c=n[1],u=r[1];c.subVectors(e,t),u.setFromPoints(c,s);const h=n[2],p=r[2];h.subVectors(t,i),p.setFromPoints(h,s);const d=n[3],g=r[3];d.subVectors(i,e),g.setFromPoints(d,s),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,e),this.needsUpdate=!1}}re.prototype.closestPointToSegment=function(){const a=new Z,e=new Z,t=new ge;return function(s,n=null,r=null){const{start:o,end:l}=s,c=this.points;let u,h=1/0;for(let p=0;p<3;p++){const d=(p+1)%3;t.start.copy(c[p]),t.end.copy(c[d]),_n(t,s,a,e),u=a.distanceToSquared(e),u<h&&(h=u,n&&n.copy(a),r&&r.copy(e))}return this.closestPointToPoint(o,a),u=o.distanceToSquared(a),u<h&&(h=u,n&&n.copy(a),r&&r.copy(o)),this.closestPointToPoint(l,a),u=l.distanceToSquared(a),u<h&&(h=u,n&&n.copy(a),r&&r.copy(l)),Math.sqrt(h)}}();re.prototype.intersectsTriangle=function(){const a=new re,e=new Array(3),t=new Array(3),i=new _e,s=new _e,n=new Z,r=new Z,o=new Z,l=new Z,c=new Z,u=new ge,h=new ge,p=new ge,d=new Z;function g(m,b,f){const y=m.points;let v=0,x=-1;for(let T=0;T<3;T++){const{start:A,end:S}=u;A.copy(y[T]),S.copy(y[(T+1)%3]),u.delta(r);const M=Ns(b.distanceToPoint(A));if(Ns(b.normal.dot(r))&&M){f.copy(u),v=2;break}const I=b.intersectLine(u,d);if(!I&&M&&d.copy(A),(I||M)&&!Ns(d.distanceTo(S))){if(v<=1)(v===1?f.start:f.end).copy(d),M&&(x=v);else if(v>=2){(x===1?f.start:f.end).copy(d),v=2;break}if(v++,v===2&&x===-1)break}}return v}return function(b,f=null,y=!1){this.needsUpdate&&this.update(),b.isExtendedTriangle?b.needsUpdate&&b.update():(a.copy(b),a.update(),b=a);const v=this.plane,x=b.plane;if(Math.abs(v.normal.dot(x.normal))>1-1e-10){const T=this.satBounds,A=this.satAxes;t[0]=b.a,t[1]=b.b,t[2]=b.c;for(let I=0;I<4;I++){const k=T[I],$=A[I];if(i.setFromPoints($,t),k.isSeparated(i))return!1}const S=b.satBounds,M=b.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let I=0;I<4;I++){const k=S[I],$=M[I];if(i.setFromPoints($,e),k.isSeparated(i))return!1}for(let I=0;I<4;I++){const k=A[I];for(let $=0;$<4;$++){const E=M[$];if(n.crossVectors(k,E),i.setFromPoints(n,e),s.setFromPoints(n,t),i.isSeparated(s))return!1}}return f&&(y||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),f.start.set(0,0,0),f.end.set(0,0,0)),!0}else{const T=g(this,x,h);if(T===1&&b.containsPoint(h.end))return f&&(f.start.copy(h.end),f.end.copy(h.end)),!0;if(T!==2)return!1;const A=g(b,v,p);if(A===1&&this.containsPoint(p.end))return f&&(f.start.copy(p.end),f.end.copy(p.end)),!0;if(A!==2)return!1;if(h.delta(o),p.delta(l),o.dot(l)<0){let z=p.start;p.start=p.end,p.end=z}const S=h.start.dot(o),M=h.end.dot(o),I=p.start.dot(o),k=p.end.dot(o),$=M<I,E=S<k;return S!==k&&I!==M&&$===E?!1:(f&&(c.subVectors(h.start,p.start),c.dot(o)>0?f.start.copy(h.start):f.start.copy(p.start),c.subVectors(h.end,p.end),c.dot(o)<0?f.end.copy(h.end):f.end.copy(p.end)),!0)}}}();re.prototype.distanceToPoint=function(){const a=new Z;return function(t){return this.closestPointToPoint(t,a),t.distanceTo(a)}}();re.prototype.distanceToTriangle=function(){const a=new Z,e=new Z,t=["a","b","c"],i=new ge,s=new ge;return function(r,o=null,l=null){const c=o||l?i:null;if(this.intersectsTriangle(r,c))return(o||l)&&(o&&c.getCenter(o),l&&c.getCenter(l)),0;let u=1/0;for(let h=0;h<3;h++){let p;const d=t[h],g=r[d];this.closestPointToPoint(g,a),p=g.distanceToSquared(a),p<u&&(u=p,o&&o.copy(a),l&&l.copy(g));const m=this[d];r.closestPointToPoint(m,a),p=m.distanceToSquared(a),p<u&&(u=p,o&&o.copy(m),l&&l.copy(a))}for(let h=0;h<3;h++){const p=t[h],d=t[(h+1)%3];i.set(this[p],this[d]);for(let g=0;g<3;g++){const m=t[g],b=t[(g+1)%3];s.set(r[m],r[b]),_n(i,s,a,e);const f=a.distanceToSquared(e);f<u&&(u=f,o&&o.copy(a),l&&l.copy(e))}}return Math.sqrt(u)}}();class Ut{constructor(e,t,i){this.isOrientedBox=!0,this.min=new Z,this.max=new Z,this.matrix=new It,this.invMatrix=new It,this.points=new Array(8).fill().map(()=>new Z),this.satAxes=new Array(3).fill().map(()=>new Z),this.satBounds=new Array(3).fill().map(()=>new _e),this.alignedSatBounds=new Array(3).fill().map(()=>new _e),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),i&&this.matrix.copy(i)}set(e,t,i){this.min.copy(e),this.max.copy(t),this.matrix.copy(i),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}Ut.prototype.update=function(){return function(){const e=this.matrix,t=this.min,i=this.max,s=this.points;for(let c=0;c<=1;c++)for(let u=0;u<=1;u++)for(let h=0;h<=1;h++){const p=1*c|2*u|4*h,d=s[p];d.x=c?i.x:t.x,d.y=u?i.y:t.y,d.z=h?i.z:t.z,d.applyMatrix4(e)}const n=this.satBounds,r=this.satAxes,o=s[0];for(let c=0;c<3;c++){const u=r[c],h=n[c],p=1<<c,d=s[p];u.subVectors(o,d),h.setFromPoints(u,s)}const l=this.alignedSatBounds;l[0].setFromPointsField(s,"x"),l[1].setFromPointsField(s,"y"),l[2].setFromPointsField(s,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}();Ut.prototype.intersectsBox=function(){const a=new _e;return function(t){this.needsUpdate&&this.update();const i=t.min,s=t.max,n=this.satBounds,r=this.satAxes,o=this.alignedSatBounds;if(a.min=i.x,a.max=s.x,o[0].isSeparated(a)||(a.min=i.y,a.max=s.y,o[1].isSeparated(a))||(a.min=i.z,a.max=s.z,o[2].isSeparated(a)))return!1;for(let l=0;l<3;l++){const c=r[l],u=n[l];if(a.setFromBox(c,t),u.isSeparated(a))return!1}return!0}}();Ut.prototype.intersectsTriangle=function(){const a=new re,e=new Array(3),t=new _e,i=new _e,s=new Z;return function(r){this.needsUpdate&&this.update(),r.isExtendedTriangle?r.needsUpdate&&r.update():(a.copy(r),a.update(),r=a);const o=this.satBounds,l=this.satAxes;e[0]=r.a,e[1]=r.b,e[2]=r.c;for(let p=0;p<3;p++){const d=o[p],g=l[p];if(t.setFromPoints(g,e),d.isSeparated(t))return!1}const c=r.satBounds,u=r.satAxes,h=this.points;for(let p=0;p<3;p++){const d=c[p],g=u[p];if(t.setFromPoints(g,h),d.isSeparated(t))return!1}for(let p=0;p<3;p++){const d=l[p];for(let g=0;g<4;g++){const m=u[g];if(s.crossVectors(d,m),t.setFromPoints(s,e),i.setFromPoints(s,h),t.isSeparated(i))return!1}}return!0}}();Ut.prototype.closestPointToPoint=function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}}();Ut.prototype.distanceToPoint=function(){const a=new Z;return function(t){return this.closestPointToPoint(t,a),t.distanceTo(a)}}();Ut.prototype.distanceToBox=function(){const a=["x","y","z"],e=new Array(12).fill().map(()=>new ge),t=new Array(12).fill().map(()=>new ge),i=new Z,s=new Z;return function(r,o=0,l=null,c=null){if(this.needsUpdate&&this.update(),this.intersectsBox(r))return(l||c)&&(r.getCenter(s),this.closestPointToPoint(s,i),r.closestPointToPoint(i,s),l&&l.copy(i),c&&c.copy(s)),0;const u=o*o,h=r.min,p=r.max,d=this.points;let g=1/0;for(let b=0;b<8;b++){const f=d[b];s.copy(f).clamp(h,p);const y=f.distanceToSquared(s);if(y<g&&(g=y,l&&l.copy(f),c&&c.copy(s),y<u))return Math.sqrt(y)}let m=0;for(let b=0;b<3;b++)for(let f=0;f<=1;f++)for(let y=0;y<=1;y++){const v=(b+1)%3,x=(b+2)%3,T=f<<v|y<<x,A=1<<b|f<<v|y<<x,S=d[T],M=d[A];e[m].set(S,M);const k=a[b],$=a[v],E=a[x],z=t[m],_=z.start,L=z.end;_[k]=h[k],_[$]=f?h[$]:p[$],_[E]=y?h[E]:p[$],L[k]=p[k],L[$]=f?h[$]:p[$],L[E]=y?h[E]:p[$],m++}for(let b=0;b<=1;b++)for(let f=0;f<=1;f++)for(let y=0;y<=1;y++){s.x=b?p.x:h.x,s.y=f?p.y:h.y,s.z=y?p.z:h.z,this.closestPointToPoint(s,i);const v=s.distanceToSquared(i);if(v<g&&(g=v,l&&l.copy(i),c&&c.copy(s),v<u))return Math.sqrt(v)}for(let b=0;b<12;b++){const f=e[b];for(let y=0;y<12;y++){const v=t[y];_n(f,v,i,s);const x=i.distanceToSquared(s);if(x<g&&(g=x,l&&l.copy(i),c&&c.copy(s),x<u))return Math.sqrt(x)}}return Math.sqrt(g)}}();class yn{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class il extends yn{constructor(){super(()=>new re)}}const qt=new il;function Ht(a,e){return e[a+15]===65535}function Yt(a,e){return e[a+6]}function Gt(a,e){return e[a+14]}function Qt(a){return a+8}function Kt(a,e){return e[a+6]}function Mr(a,e){return e[a+7]}class sl{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=i=>{t&&e.push(t),t=i,this.float32Array=new Float32Array(i),this.uint16Array=new Uint16Array(i),this.uint32Array=new Uint32Array(i)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const bt=new sl;let Ee,Xe;const Be=[],Ri=new yn(()=>new Lt);function nl(a,e,t,i,s,n){Ee=Ri.getPrimitive(),Xe=Ri.getPrimitive(),Be.push(Ee,Xe),bt.setBuffer(a._roots[e]);const r=qs(0,a.geometry,t,i,s,n);bt.clearBuffer(),Ri.releasePrimitive(Ee),Ri.releasePrimitive(Xe),Be.pop(),Be.pop();const o=Be.length;return o>0&&(Xe=Be[o-1],Ee=Be[o-2]),r}function qs(a,e,t,i,s=null,n=0,r=0){const{float32Array:o,uint16Array:l,uint32Array:c}=bt;let u=a*2;if(Ht(u,l)){const p=Yt(a,c),d=Gt(u,l);return Tt(a,o,Ee),i(p,d,!1,r,n+a,Ee)}else{let k=function(E){const{uint16Array:z,uint32Array:_}=bt;let L=E*2;for(;!Ht(L,z);)E=Qt(E),L=E*2;return Yt(E,_)},$=function(E){const{uint16Array:z,uint32Array:_}=bt;let L=E*2;for(;!Ht(L,z);)E=Kt(E,_),L=E*2;return Yt(E,_)+Gt(L,z)};const p=Qt(a),d=Kt(a,c);let g=p,m=d,b,f,y,v;if(s&&(y=Ee,v=Xe,Tt(g,o,y),Tt(m,o,v),b=s(y),f=s(v),f<b)){g=d,m=p;const E=b;b=f,f=E,y=v}y||(y=Ee,Tt(g,o,y));const x=Ht(g*2,l),T=t(y,x,b,r+1,n+g);let A;if(T===Un){const E=k(g),_=$(g)-E;A=i(E,_,!0,r+1,n+g,y)}else A=T&&qs(g,e,t,i,s,n,r+1);if(A)return!0;v=Xe,Tt(m,o,v);const S=Ht(m*2,l),M=t(v,S,f,r+1,n+m);let I;if(M===Un){const E=k(m),_=$(m)-E;I=i(E,_,!0,r+1,n+m,v)}else I=M&&qs(m,e,t,i,s,n,r+1);return!!I}}const hi=new Z,Ls=new Z;function rl(a,e,t={},i=0,s=1/0){const n=i*i,r=s*s;let o=1/0,l=null;if(a.shapecast({boundsTraverseOrder:u=>(hi.copy(e).clamp(u.min,u.max),hi.distanceToSquared(e)),intersectsBounds:(u,h,p)=>p<o&&p<r,intersectsTriangle:(u,h)=>{u.closestPointToPoint(e,hi);const p=e.distanceToSquared(hi);return p<o&&(Ls.copy(hi),o=p,l=h),p<n}}),o===1/0)return null;const c=Math.sqrt(o);return t.point?t.point.copy(Ls):t.point=Ls.clone(),t.distance=c,t.faceIndex=l,t}const Re=new Z,Ue=new Z,Fe=new Z,Ui=new jt,Fi=new jt,Vi=new jt,Zn=new Z,Yn=new Z,jn=new Z,Hi=new Z;function ol(a,e,t,i,s,n){let r;return n===Gr?r=a.intersectTriangle(i,t,e,!0,s):r=a.intersectTriangle(e,t,i,n!==hn,s),r===null?null:{distance:a.origin.distanceTo(s),point:s.clone()}}function al(a,e,t,i,s,n,r,o,l){Re.fromBufferAttribute(e,n),Ue.fromBufferAttribute(e,r),Fe.fromBufferAttribute(e,o);const c=ol(a,Re,Ue,Fe,Hi,l);if(c){i&&(Ui.fromBufferAttribute(i,n),Fi.fromBufferAttribute(i,r),Vi.fromBufferAttribute(i,o),c.uv=_i.getInterpolation(Hi,Re,Ue,Fe,Ui,Fi,Vi,new jt)),s&&(Ui.fromBufferAttribute(s,n),Fi.fromBufferAttribute(s,r),Vi.fromBufferAttribute(s,o),c.uv1=_i.getInterpolation(Hi,Re,Ue,Fe,Ui,Fi,Vi,new jt)),t&&(Zn.fromBufferAttribute(t,n),Yn.fromBufferAttribute(t,r),jn.fromBufferAttribute(t,o),c.normal=_i.getInterpolation(Hi,Re,Ue,Fe,Zn,Yn,jn,new Z),c.normal.dot(a.direction)>0&&c.normal.multiplyScalar(-1));const u={a:n,b:r,c:o,normal:new Z,materialIndex:0};_i.getNormal(Re,Ue,Fe,u.normal),c.face=u,c.faceIndex=n}return c}function vs(a,e,t,i,s){const n=i*3;let r=n+0,o=n+1,l=n+2;const c=a.index;a.index&&(r=c.getX(r),o=c.getX(o),l=c.getX(l));const{position:u,normal:h,uv:p,uv1:d}=a.attributes,g=al(t,u,h,p,d,r,o,l,e);return g?(g.faceIndex=i,s&&s.push(g),g):null}function Pt(a,e,t,i){const s=a.a,n=a.b,r=a.c;let o=e,l=e+1,c=e+2;t&&(o=t.getX(o),l=t.getX(l),c=t.getX(c)),s.x=i.getX(o),s.y=i.getY(o),s.z=i.getZ(o),n.x=i.getX(l),n.y=i.getY(l),n.z=i.getZ(l),r.x=i.getX(c),r.y=i.getY(c),r.z=i.getZ(c)}function ll(a,e,t,i,s,n){const{geometry:r,_indirectBuffer:o}=a;for(let l=i,c=i+s;l<c;l++)vs(r,e,t,l,n)}function cl(a,e,t,i,s){const{geometry:n,_indirectBuffer:r}=a;let o=1/0,l=null;for(let c=i,u=i+s;c<u;c++){let h;h=vs(n,e,t,c),h&&h.distance<o&&(l=h,o=h.distance)}return l}function hl(a,e,t,i,s,n,r){const{geometry:o}=t,{index:l}=o,c=o.attributes.position;for(let u=a,h=e+a;u<h;u++){let p;if(p=u,Pt(r,p*3,l,c),r.needsUpdate=!0,i(r,p,s,n))return!0}return!1}function ul(a,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=a.geometry,i=t.index?t.index.array:null,s=t.attributes.position;let n,r,o,l,c=0;const u=a._roots;for(let p=0,d=u.length;p<d;p++)n=u[p],r=new Uint32Array(n),o=new Uint16Array(n),l=new Float32Array(n),h(0,c),c+=n.byteLength;function h(p,d,g=!1){const m=p*2;if(o[m+15]===bs){const f=r[p+6],y=o[m+14];let v=1/0,x=1/0,T=1/0,A=-1/0,S=-1/0,M=-1/0;for(let I=3*f,k=3*(f+y);I<k;I++){let $=i[I];const E=s.getX($),z=s.getY($),_=s.getZ($);E<v&&(v=E),E>A&&(A=E),z<x&&(x=z),z>S&&(S=z),_<T&&(T=_),_>M&&(M=_)}return l[p+0]!==v||l[p+1]!==x||l[p+2]!==T||l[p+3]!==A||l[p+4]!==S||l[p+5]!==M?(l[p+0]=v,l[p+1]=x,l[p+2]=T,l[p+3]=A,l[p+4]=S,l[p+5]=M,!0):!1}else{const f=p+8,y=r[p+6],v=f+d,x=y+d;let T=g,A=!1,S=!1;e?T||(A=e.has(v),S=e.has(x),T=!A&&!S):(A=!0,S=!0);const M=T||A,I=T||S;let k=!1;M&&(k=h(f,d,T));let $=!1;I&&($=h(y,d,T));const E=k||$;if(E)for(let z=0;z<3;z++){const _=f+z,L=y+z,W=l[_],V=l[_+3],st=l[L],H=l[L+3];l[p+z]=W<st?W:st,l[p+z+3]=V>H?V:H}return E}}}const Xn=new Lt;function Ae(a,e,t,i){return Tt(a,e,Xn),t.intersectBox(Xn,i)}function dl(a,e,t,i,s,n){const{geometry:r,_indirectBuffer:o}=a;for(let l=i,c=i+s;l<c;l++){let u=o?o[l]:l;vs(r,e,t,u,n)}}function fl(a,e,t,i,s){const{geometry:n,_indirectBuffer:r}=a;let o=1/0,l=null;for(let c=i,u=i+s;c<u;c++){let h;h=vs(n,e,t,r?r[c]:c),h&&h.distance<o&&(l=h,o=h.distance)}return l}function pl(a,e,t,i,s,n,r){const{geometry:o}=t,{index:l}=o,c=o.attributes.position;for(let u=a,h=e+a;u<h;u++){let p;if(p=t.resolveTriangleIndex(u),Pt(r,p*3,l,c),r.needsUpdate=!0,i(r,p,s,n))return!0}return!1}const Wn=new Z;function ml(a,e,t,i,s){bt.setBuffer(a._roots[e]),Gs(0,a,t,i,s),bt.clearBuffer()}function Gs(a,e,t,i,s){const{float32Array:n,uint16Array:r,uint32Array:o}=bt,l=a*2;if(Ht(l,r)){const u=Yt(a,o),h=Gt(l,r);ll(e,t,i,u,h,s)}else{const u=Qt(a);Ae(u,n,i,Wn)&&Gs(u,e,t,i,s);const h=Kt(a,o);Ae(h,n,i,Wn)&&Gs(h,e,t,i,s)}}const qn=new Z,gl=["x","y","z"];function _l(a,e,t,i){bt.setBuffer(a._roots[e]);const s=Qs(0,a,t,i);return bt.clearBuffer(),s}function Qs(a,e,t,i){const{float32Array:s,uint16Array:n,uint32Array:r}=bt;let o=a*2;if(Ht(o,n)){const c=Yt(a,r),u=Gt(o,n);return cl(e,t,i,c,u)}else{const c=Mr(a,r),u=gl[c],p=i.direction[u]>=0;let d,g;p?(d=Qt(a),g=Kt(a,r)):(d=Kt(a,r),g=Qt(a));const b=Ae(d,s,i,qn)?Qs(d,e,t,i):null;if(b){const v=b.point[u];if(p?v<=s[g+c]:v>=s[g+c+3])return b}const y=Ae(g,s,i,qn)?Qs(g,e,t,i):null;return b&&y?b.distance<=y.distance?b:y:b||y||null}}const $i=new Lt,Ve=new re,He=new re,ui=new It,Gn=new Ut,Zi=new Ut;function yl(a,e,t,i){bt.setBuffer(a._roots[e]);const s=Ks(0,a,t,i);return bt.clearBuffer(),s}function Ks(a,e,t,i,s=null){const{float32Array:n,uint16Array:r,uint32Array:o}=bt;let l=a*2;if(s===null&&(t.boundingBox||t.computeBoundingBox(),Gn.set(t.boundingBox.min,t.boundingBox.max,i),s=Gn),Ht(l,r)){const u=e.geometry,h=u.index,p=u.attributes.position,d=t.index,g=t.attributes.position,m=Yt(a,o),b=Gt(l,r);if(ui.copy(i).invert(),t.boundsTree)return Tt(a,n,Zi),Zi.matrix.copy(ui),Zi.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:y=>Zi.intersectsBox(y),intersectsTriangle:y=>{y.a.applyMatrix4(i),y.b.applyMatrix4(i),y.c.applyMatrix4(i),y.needsUpdate=!0;for(let v=m*3,x=(b+m)*3;v<x;v+=3)if(Pt(He,v,h,p),He.needsUpdate=!0,y.intersectsTriangle(He))return!0;return!1}});for(let f=m*3,y=(b+m)*3;f<y;f+=3){Pt(Ve,f,h,p),Ve.a.applyMatrix4(ui),Ve.b.applyMatrix4(ui),Ve.c.applyMatrix4(ui),Ve.needsUpdate=!0;for(let v=0,x=d.count;v<x;v+=3)if(Pt(He,v,d,g),He.needsUpdate=!0,Ve.intersectsTriangle(He))return!0}}else{const u=a+8,h=o[a+6];return Tt(u,n,$i),!!(s.intersectsBox($i)&&Ks(u,e,t,i,s)||(Tt(h,n,$i),s.intersectsBox($i)&&Ks(h,e,t,i,s)))}}const Yi=new It,Ds=new Ut,di=new Ut,wl=new Z,bl=new Z,vl=new Z,xl=new Z;function Tl(a,e,t,i={},s={},n=0,r=1/0){e.boundingBox||e.computeBoundingBox(),Ds.set(e.boundingBox.min,e.boundingBox.max,t),Ds.needsUpdate=!0;const o=a.geometry,l=o.attributes.position,c=o.index,u=e.attributes.position,h=e.index,p=qt.getPrimitive(),d=qt.getPrimitive();let g=wl,m=bl,b=null,f=null;s&&(b=vl,f=xl);let y=1/0,v=null,x=null;return Yi.copy(t).invert(),di.matrix.copy(Yi),a.shapecast({boundsTraverseOrder:T=>Ds.distanceToBox(T),intersectsBounds:(T,A,S)=>S<y&&S<r?(A&&(di.min.copy(T.min),di.max.copy(T.max),di.needsUpdate=!0),!0):!1,intersectsRange:(T,A)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:M=>di.distanceToBox(M),intersectsBounds:(M,I,k)=>k<y&&k<r,intersectsRange:(M,I)=>{for(let k=M,$=M+I;k<$;k++){Pt(d,3*k,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let E=T,z=T+A;E<z;E++){Pt(p,3*E,c,l),p.needsUpdate=!0;const _=p.distanceToTriangle(d,g,b);if(_<y&&(m.copy(g),f&&f.copy(b),y=_,v=E,x=k),_<n)return!0}}}});{const S=Ge(e);for(let M=0,I=S;M<I;M++){Pt(d,3*M,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let k=T,$=T+A;k<$;k++){Pt(p,3*k,c,l),p.needsUpdate=!0;const E=p.distanceToTriangle(d,g,b);if(E<y&&(m.copy(g),f&&f.copy(b),y=E,v=k,x=M),E<n)return!0}}}}}),qt.releasePrimitive(p),qt.releasePrimitive(d),y===1/0?null:(i.point?i.point.copy(m):i.point=m.clone(),i.distance=y,i.faceIndex=v,s&&(s.point?s.point.copy(f):s.point=f.clone(),s.point.applyMatrix4(Yi),m.applyMatrix4(Yi),s.distance=m.sub(s.point).length(),s.faceIndex=x),i)}function Cl(a,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=a.geometry,i=t.index?t.index.array:null,s=t.attributes.position;let n,r,o,l,c=0;const u=a._roots;for(let p=0,d=u.length;p<d;p++)n=u[p],r=new Uint32Array(n),o=new Uint16Array(n),l=new Float32Array(n),h(0,c),c+=n.byteLength;function h(p,d,g=!1){const m=p*2;if(o[m+15]===bs){const f=r[p+6],y=o[m+14];let v=1/0,x=1/0,T=1/0,A=-1/0,S=-1/0,M=-1/0;for(let I=f,k=f+y;I<k;I++){const $=3*a.resolveTriangleIndex(I);for(let E=0;E<3;E++){let z=$+E;z=i?i[z]:z;const _=s.getX(z),L=s.getY(z),W=s.getZ(z);_<v&&(v=_),_>A&&(A=_),L<x&&(x=L),L>S&&(S=L),W<T&&(T=W),W>M&&(M=W)}}return l[p+0]!==v||l[p+1]!==x||l[p+2]!==T||l[p+3]!==A||l[p+4]!==S||l[p+5]!==M?(l[p+0]=v,l[p+1]=x,l[p+2]=T,l[p+3]=A,l[p+4]=S,l[p+5]=M,!0):!1}else{const f=p+8,y=r[p+6],v=f+d,x=y+d;let T=g,A=!1,S=!1;e?T||(A=e.has(v),S=e.has(x),T=!A&&!S):(A=!0,S=!0);const M=T||A,I=T||S;let k=!1;M&&(k=h(f,d,T));let $=!1;I&&($=h(y,d,T));const E=k||$;if(E)for(let z=0;z<3;z++){const _=f+z,L=y+z,W=l[_],V=l[_+3],st=l[L],H=l[L+3];l[p+z]=W<st?W:st,l[p+z+3]=V>H?V:H}return E}}}const Qn=new Z;function El(a,e,t,i,s){bt.setBuffer(a._roots[e]),Js(0,a,t,i,s),bt.clearBuffer()}function Js(a,e,t,i,s){const{float32Array:n,uint16Array:r,uint32Array:o}=bt,l=a*2;if(Ht(l,r)){const u=Yt(a,o),h=Gt(l,r);dl(e,t,i,u,h,s)}else{const u=Qt(a);Ae(u,n,i,Qn)&&Js(u,e,t,i,s);const h=Kt(a,o);Ae(h,n,i,Qn)&&Js(h,e,t,i,s)}}const Kn=new Z,Al=["x","y","z"];function Sl(a,e,t,i){bt.setBuffer(a._roots[e]);const s=tn(0,a,t,i);return bt.clearBuffer(),s}function tn(a,e,t,i){const{float32Array:s,uint16Array:n,uint32Array:r}=bt;let o=a*2;if(Ht(o,n)){const c=Yt(a,r),u=Gt(o,n);return fl(e,t,i,c,u)}else{const c=Mr(a,r),u=Al[c],p=i.direction[u]>=0;let d,g;p?(d=Qt(a),g=Kt(a,r)):(d=Kt(a,r),g=Qt(a));const b=Ae(d,s,i,Kn)?tn(d,e,t,i):null;if(b){const v=b.point[u];if(p?v<=s[g+c]:v>=s[g+c+3])return b}const y=Ae(g,s,i,Kn)?tn(g,e,t,i):null;return b&&y?b.distance<=y.distance?b:y:b||y||null}}const ji=new Lt,$e=new re,Ze=new re,fi=new It,Jn=new Ut,Xi=new Ut;function Ol(a,e,t,i){bt.setBuffer(a._roots[e]);const s=en(0,a,t,i);return bt.clearBuffer(),s}function en(a,e,t,i,s=null){const{float32Array:n,uint16Array:r,uint32Array:o}=bt;let l=a*2;if(s===null&&(t.boundingBox||t.computeBoundingBox(),Jn.set(t.boundingBox.min,t.boundingBox.max,i),s=Jn),Ht(l,r)){const u=e.geometry,h=u.index,p=u.attributes.position,d=t.index,g=t.attributes.position,m=Yt(a,o),b=Gt(l,r);if(fi.copy(i).invert(),t.boundsTree)return Tt(a,n,Xi),Xi.matrix.copy(fi),Xi.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:y=>Xi.intersectsBox(y),intersectsTriangle:y=>{y.a.applyMatrix4(i),y.b.applyMatrix4(i),y.c.applyMatrix4(i),y.needsUpdate=!0;for(let v=m,x=b+m;v<x;v++)if(Pt(Ze,3*e.resolveTriangleIndex(v),h,p),Ze.needsUpdate=!0,y.intersectsTriangle(Ze))return!0;return!1}});for(let f=m,y=b+m;f<y;f++){const v=e.resolveTriangleIndex(f);Pt($e,3*v,h,p),$e.a.applyMatrix4(fi),$e.b.applyMatrix4(fi),$e.c.applyMatrix4(fi),$e.needsUpdate=!0;for(let x=0,T=d.count;x<T;x+=3)if(Pt(Ze,x,d,g),Ze.needsUpdate=!0,$e.intersectsTriangle(Ze))return!0}}else{const u=a+8,h=o[a+6];return Tt(u,n,ji),!!(s.intersectsBox(ji)&&en(u,e,t,i,s)||(Tt(h,n,ji),s.intersectsBox(ji)&&en(h,e,t,i,s)))}}const Wi=new It,Bs=new Ut,pi=new Ut,Pl=new Z,Il=new Z,Ml=new Z,kl=new Z;function zl(a,e,t,i={},s={},n=0,r=1/0){e.boundingBox||e.computeBoundingBox(),Bs.set(e.boundingBox.min,e.boundingBox.max,t),Bs.needsUpdate=!0;const o=a.geometry,l=o.attributes.position,c=o.index,u=e.attributes.position,h=e.index,p=qt.getPrimitive(),d=qt.getPrimitive();let g=Pl,m=Il,b=null,f=null;s&&(b=Ml,f=kl);let y=1/0,v=null,x=null;return Wi.copy(t).invert(),pi.matrix.copy(Wi),a.shapecast({boundsTraverseOrder:T=>Bs.distanceToBox(T),intersectsBounds:(T,A,S)=>S<y&&S<r?(A&&(pi.min.copy(T.min),pi.max.copy(T.max),pi.needsUpdate=!0),!0):!1,intersectsRange:(T,A)=>{if(e.boundsTree){const S=e.boundsTree;return S.shapecast({boundsTraverseOrder:M=>pi.distanceToBox(M),intersectsBounds:(M,I,k)=>k<y&&k<r,intersectsRange:(M,I)=>{for(let k=M,$=M+I;k<$;k++){const E=S.resolveTriangleIndex(k);Pt(d,3*E,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let z=T,_=T+A;z<_;z++){const L=a.resolveTriangleIndex(z);Pt(p,3*L,c,l),p.needsUpdate=!0;const W=p.distanceToTriangle(d,g,b);if(W<y&&(m.copy(g),f&&f.copy(b),y=W,v=z,x=k),W<n)return!0}}}})}else{const S=Ge(e);for(let M=0,I=S;M<I;M++){Pt(d,3*M,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let k=T,$=T+A;k<$;k++){const E=a.resolveTriangleIndex(k);Pt(p,3*E,c,l),p.needsUpdate=!0;const z=p.distanceToTriangle(d,g,b);if(z<y&&(m.copy(g),f&&f.copy(b),y=z,v=k,x=M),z<n)return!0}}}}}),qt.releasePrimitive(p),qt.releasePrimitive(d),y===1/0?null:(i.point?i.point.copy(m):i.point=m.clone(),i.distance=y,i.faceIndex=v,s&&(s.point?s.point.copy(f):s.point=f.clone(),s.point.applyMatrix4(Wi),m.applyMatrix4(Wi),s.distance=m.sub(s.point).length(),s.faceIndex=x),i)}function Nl(){return typeof SharedArrayBuffer<"u"}const bi=new bt.constructor,cs=new bt.constructor,xe=new yn(()=>new Lt),Ye=new Lt,je=new Lt,Rs=new Lt,Us=new Lt;let Fs=!1;function Ll(a,e,t,i){if(Fs)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Fs=!0;const s=a._roots,n=e._roots;let r,o=0,l=0;const c=new It().copy(t).invert();for(let u=0,h=s.length;u<h;u++){bi.setBuffer(s[u]),l=0;const p=xe.getPrimitive();Tt(0,bi.float32Array,p),p.applyMatrix4(c);for(let d=0,g=n.length;d<g&&(cs.setBuffer(n[u]),r=ie(0,0,t,c,i,o,l,0,0,p),cs.clearBuffer(),l+=n[d].length,!r);d++);if(xe.releasePrimitive(p),bi.clearBuffer(),o+=s[u].length,r)break}return Fs=!1,r}function ie(a,e,t,i,s,n=0,r=0,o=0,l=0,c=null,u=!1){let h,p;u?(h=cs,p=bi):(h=bi,p=cs);const d=h.float32Array,g=h.uint32Array,m=h.uint16Array,b=p.float32Array,f=p.uint32Array,y=p.uint16Array,v=a*2,x=e*2,T=Ht(v,m),A=Ht(x,y);let S=!1;if(A&&T)u?S=s(Yt(e,f),Gt(e*2,y),Yt(a,g),Gt(a*2,m),l,r+e,o,n+a):S=s(Yt(a,g),Gt(a*2,m),Yt(e,f),Gt(e*2,y),o,n+a,l,r+e);else if(A){const M=xe.getPrimitive();Tt(e,b,M),M.applyMatrix4(t);const I=Qt(a),k=Kt(a,g);Tt(I,d,Ye),Tt(k,d,je);const $=M.intersectsBox(Ye),E=M.intersectsBox(je);S=$&&ie(e,I,i,t,s,r,n,l,o+1,M,!u)||E&&ie(e,k,i,t,s,r,n,l,o+1,M,!u),xe.releasePrimitive(M)}else{const M=Qt(e),I=Kt(e,f);Tt(M,b,Rs),Tt(I,b,Us);const k=c.intersectsBox(Rs),$=c.intersectsBox(Us);if(k&&$)S=ie(a,M,t,i,s,n,r,o,l+1,c,u)||ie(a,I,t,i,s,n,r,o,l+1,c,u);else if(k)if(T)S=ie(a,M,t,i,s,n,r,o,l+1,c,u);else{const E=xe.getPrimitive();E.copy(Rs).applyMatrix4(t);const z=Qt(a),_=Kt(a,g);Tt(z,d,Ye),Tt(_,d,je);const L=E.intersectsBox(Ye),W=E.intersectsBox(je);S=L&&ie(M,z,i,t,s,r,n,l,o+1,E,!u)||W&&ie(M,_,i,t,s,r,n,l,o+1,E,!u),xe.releasePrimitive(E)}else if($)if(T)S=ie(a,I,t,i,s,n,r,o,l+1,c,u);else{const E=xe.getPrimitive();E.copy(Us).applyMatrix4(t);const z=Qt(a),_=Kt(a,g);Tt(z,d,Ye),Tt(_,d,je);const L=E.intersectsBox(Ye),W=E.intersectsBox(je);S=L&&ie(I,z,i,t,s,r,n,l,o+1,E,!u)||W&&ie(I,_,i,t,s,r,n,l,o+1,E,!u),xe.releasePrimitive(E)}}return S}const qi=new Ut,tr=new Lt;class wn{static serialize(e,t={}){t={cloneBuffers:!0,...t};const i=e.geometry,s=e._roots,n=e._indirectBuffer,r=i.getIndex();let o;return t.cloneBuffers?o={roots:s.map(l=>l.slice()),index:r.array.slice(),indirectBuffer:n?n.slice():null}:o={roots:s,index:r.array,indirectBuffer:n},o}static deserialize(e,t,i={}){i={setIndex:!0,indirect:!!e.indirectBuffer,...i};const{index:s,roots:n,indirectBuffer:r}=e,o=new wn(t,{...i,[ks]:!0});if(o._roots=n,o._indirectBuffer=r||null,i.setIndex){const l=t.getIndex();if(l===null){const c=new yr(e.index,1,!1);t.setIndex(c)}else l.array!==s&&(l.array.set(s),l.needsUpdate=!0)}return o}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t=Object.assign({strategy:Or,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,[ks]:!1},t),t.useSharedArrayBuffer&&!Nl())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[ks]||(Ka(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new Lt)));const{_indirectBuffer:i}=this;this.resolveTriangleIndex=t.indirect?s=>i[s]:s=>s}refit(e=null){return(this.indirect?Cl:ul)(this,e)}traverse(e,t=0){const i=this._roots[t],s=new Uint32Array(i),n=new Uint16Array(i);r(0);function r(o,l=0){const c=o*2,u=n[c+15]===bs;if(u){const h=s[o+6],p=n[c+14];e(l,u,new Float32Array(i,o*4,6),h,p)}else{const h=o+ts/4,p=s[o+6],d=s[o+7];e(l,u,new Float32Array(i,o*4,6),d)||(r(h,l+1),r(p,l+1))}}}raycast(e,t=Cn){const i=this._roots,s=this.geometry,n=[],r=t.isMaterial,o=Array.isArray(t),l=s.groups,c=r?t.side:t,u=this.indirect?El:ml;for(let h=0,p=i.length;h<p;h++){const d=o?t[l[h].materialIndex].side:c,g=n.length;if(u(this,h,d,e,n),o){const m=l[h].materialIndex;for(let b=g,f=n.length;b<f;b++)n[b].face.materialIndex=m}}return n}raycastFirst(e,t=Cn){const i=this._roots,s=this.geometry,n=t.isMaterial,r=Array.isArray(t);let o=null;const l=s.groups,c=n?t.side:t,u=this.indirect?Sl:_l;for(let h=0,p=i.length;h<p;h++){const d=r?t[l[h].materialIndex].side:c,g=u(this,h,d,e);g!=null&&(o==null||g.distance<o.distance)&&(o=g,r&&(g.face.materialIndex=l[h].materialIndex))}return o}intersectsGeometry(e,t){let i=!1;const s=this._roots,n=this.indirect?Ol:yl;for(let r=0,o=s.length;r<o&&(i=n(this,r,e,t),!i);r++);return i}shapecast(e){const t=qt.getPrimitive(),i=this.indirect?pl:hl;let{boundsTraverseOrder:s,intersectsBounds:n,intersectsRange:r,intersectsTriangle:o}=e;if(r&&o){const h=r;r=(p,d,g,m,b)=>h(p,d,g,m,b)?!0:i(p,d,this,o,g,m,t)}else r||(o?r=(h,p,d,g)=>i(h,p,this,o,d,g,t):r=(h,p,d)=>d);let l=!1,c=0;const u=this._roots;for(let h=0,p=u.length;h<p;h++){const d=u[h];if(l=nl(this,h,n,r,s,c),l)break;c+=d.byteLength}return qt.releasePrimitive(t),l}bvhcast(e,t,i){let{intersectsRanges:s,intersectsTriangles:n}=i;const r=qt.getPrimitive(),o=this.geometry.index,l=this.geometry.attributes.position,c=this.indirect?g=>{const m=this.resolveTriangleIndex(g);Pt(r,m*3,o,l)}:g=>{Pt(r,g*3,o,l)},u=qt.getPrimitive(),h=e.geometry.index,p=e.geometry.attributes.position,d=e.indirect?g=>{const m=e.resolveTriangleIndex(g);Pt(u,m*3,h,p)}:g=>{Pt(u,g*3,h,p)};if(n){const g=(m,b,f,y,v,x,T,A)=>{for(let S=f,M=f+y;S<M;S++){d(S),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let I=m,k=m+b;I<k;I++)if(c(I),r.needsUpdate=!0,n(r,u,I,S,v,x,T,A))return!0}return!1};if(s){const m=s;s=function(b,f,y,v,x,T,A,S){return m(b,f,y,v,x,T,A,S)?!0:g(b,f,y,v,x,T,A,S)}}else s=g}return Ll(this,e,t,s)}intersectsBox(e,t){return qi.set(e.min,e.max,t),qi.needsUpdate=!0,this.shapecast({intersectsBounds:i=>qi.intersectsBox(i),intersectsTriangle:i=>qi.intersectsTriangle(i)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,i={},s={},n=0,r=1/0){return(this.indirect?zl:Tl)(this,e,t,i,s,n,r)}closestPointToPoint(e,t={},i=0,s=1/0){return rl(this,e,t,i,s)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(i=>{Tt(0,new Float32Array(i),tr),e.union(tr)}),e}}function er(a,e,t){return a===null||(a.point.applyMatrix4(e.matrixWorld),a.distance=a.point.distanceTo(t.ray.origin),a.object=e,a.distance<t.near||a.distance>t.far)?null:a}const Vs=new Qr,ir=new It,Dl=it.prototype.raycast;function Bl(a,e){if(this.geometry.boundsTree){if(this.material===void 0)return;ir.copy(this.matrixWorld).invert(),Vs.copy(a.ray).applyMatrix4(ir);const t=this.geometry.boundsTree;if(a.firstHitOnly===!0){const i=er(t.raycastFirst(Vs,this.material),this,a);i&&e.push(i)}else{const i=t.raycast(Vs,this.material);for(let s=0,n=i.length;s<n;s++){const r=er(i[s],this,a);r&&e.push(r)}}}else Dl.call(this,a,e)}function Rl(a){return this.boundsTree=new wn(this,a),this.boundsTree}function Ul(){this.boundsTree=null}const _s=class _s{constructor(){C(this,"onDisposed",new rt);C(this,"list",new Vt);C(this,"enabled",!1);C(this,"_clock");C(this,"onInit",new rt);C(this,"update",()=>{if(!this.enabled)return;const e=this._clock.getDelta();for(const[t,i]of this.list)i.enabled&&i.isUpdateable()&&i.update(e);requestAnimationFrame(this.update)});this._clock=new Kr,_s.setupBVH()}add(e,t){if(this.list.has(e))throw new Error("You're trying to add a component that already exists in the components instance. Use Components.get() instead.");Zt.validate(e),this.list.set(e,t)}get(e){var i;const t=e.uuid;if(!this.list.has(t)){const s=new e(this);return(i=s.isDisposeable)!=null&&i.call(s)&&s.onDisposed.add(()=>this.list.delete(t)),this.list.has(t)||this.add(t,s),s}return this.list.get(t)}init(){this.enabled=!0;for(const[e,t]of this.list.entries())t.enabled=!0;this._clock.start(),this.update(),this.onInit.trigger()}dispose(){this.enabled=!1;let e;for(const[t,i]of this.list){if(i.enabled=!1,t===ft.uuid){e=i;continue}i.isDisposeable()&&i.dispose()}e==null||e.dispose(),this._clock.stop(),this.onDisposed.trigger()}static setupBVH(){ss.prototype.computeBoundsTree=Rl,ss.prototype.disposeBoundsTree=Ul,it.prototype.raycast=Bl}};C(_s,"release","2.4.3");let sn=_s;class Fl{constructor(e){C(this,"enabled",!1);C(this,"id","FirstPerson");this.camera=e}set(e){if(this.enabled=e,e){if(this.camera.projection.current!=="Perspective"){this.camera.set("Orbit");return}this.setupFirstPersonCamera()}}setupFirstPersonCamera(){const e=this.camera.controls,t=new Z;e.distance--,e.getPosition(t),e.minDistance=1,e.maxDistance=1,e.distance=1,e.moveTo(t.x,t.y,t.z),e.truckSpeed=50,e.mouseButtons.wheel=Nt.ACTION.DOLLY,e.touches.two=Nt.ACTION.TOUCH_ZOOM_TRUCK}}class Vl{constructor(e){C(this,"enabled",!0);C(this,"id","Orbit");this.camera=e,this.activateOrbitControls()}set(e){this.enabled=e,e&&this.activateOrbitControls()}activateOrbitControls(){const e=this.camera.controls;e.minDistance=1,e.maxDistance=300;const t=new Z;e.getPosition(t);const i=t.length();e.distance=i,e.truckSpeed=2;const{rotation:s}=this.camera.three,n=new Z(0,0,-1).applyEuler(s),r=t.addScaledVector(n,i);e.moveTo(r.x,r.y,r.z)}}class Hl{constructor(e){C(this,"enabled",!1);C(this,"id","Plan");C(this,"mouseAction1");C(this,"mouseAction2");C(this,"mouseInitialized",!1);C(this,"defaultAzimuthSpeed");C(this,"defaultPolarSpeed");this.camera=e,this.defaultAzimuthSpeed=e.controls.azimuthRotateSpeed,this.defaultPolarSpeed=e.controls.polarRotateSpeed}set(e){this.enabled=e;const t=this.camera.controls;t.azimuthRotateSpeed=e?0:this.defaultAzimuthSpeed,t.polarRotateSpeed=e?0:this.defaultPolarSpeed,this.mouseInitialized||(this.mouseAction1=t.touches.one,this.mouseAction2=t.touches.two,this.mouseInitialized=!0),e?(t.mouseButtons.left=Nt.ACTION.TRUCK,t.touches.one=Nt.ACTION.TOUCH_TRUCK,t.touches.two=Nt.ACTION.TOUCH_ZOOM):(t.mouseButtons.left=Nt.ACTION.ROTATE,t.touches.one=this.mouseAction1,t.touches.two=this.mouseAction2)}}class $l{constructor(e){C(this,"onChanged",new rt);C(this,"current","Perspective");C(this,"camera");C(this,"matchOrthoDistanceEnabled",!1);C(this,"_component");C(this,"_previousDistance",-1);this._component=e,this.camera=e.three}async set(e){this.current!==e&&(e==="Orthographic"?this.setOrthoCamera():await this.setPerspectiveCamera(),this.onChanged.trigger(this.camera))}async toggle(){const t=this.current==="Perspective"?"Orthographic":"Perspective";await this.set(t)}setOrthoCamera(){if(this._component.mode===null||this._component.mode.id==="FirstPerson")return;this._previousDistance=this._component.controls.distance,this._component.controls.distance=200;const e=this.getPerspectiveDims();if(!e)return;const{width:t,height:i}=e;this.setupOrthoCamera(i,t),this.camera=this._component.threeOrtho,this.current="Orthographic"}getPerspectiveDims(){const e=this._component.currentWorld;if(!e||!e.renderer)return null;const t=new Z;this._component.threePersp.getWorldDirection(t);const i=new Z;this._component.controls.getTarget(i);const n=i.clone().sub(this._component.threePersp.position).dot(t),r=e.renderer.getSize(),o=r.x/r.y,l=this._component.threePersp,c=n*2*Math.atan(l.fov*(Math.PI/180)/2);return{width:c*o,height:c}}setupOrthoCamera(e,t){this._component.controls.mouseButtons.wheel=Nt.ACTION.ZOOM,this._component.controls.mouseButtons.middle=Nt.ACTION.ZOOM;const i=this._component.threePersp,s=this._component.threeOrtho;s.zoom=1,s.left=t/-2,s.right=t/2,s.top=e/2,s.bottom=e/-2,s.updateProjectionMatrix(),s.position.copy(i.position),s.quaternion.copy(i.quaternion),this._component.controls.camera=s}getDistance(){const e=this._component.threePersp,t=this._component.threeOrtho;return(t.top-t.bottom)/t.zoom/(2*Math.atan(e.fov*(Math.PI/180)/2))}async setPerspectiveCamera(){this._component.controls.mouseButtons.wheel=Nt.ACTION.DOLLY,this._component.controls.mouseButtons.middle=Nt.ACTION.DOLLY;const e=this._component.threePersp,t=this._component.threeOrtho;e.position.copy(t.position),e.quaternion.copy(t.quaternion),this._component.controls.mouseButtons.wheel=Nt.ACTION.DOLLY,this.matchOrthoDistanceEnabled?this._component.controls.distance=this.getDistance():this._component.controls.distance=this._previousDistance,await this._component.controls.zoomTo(1),e.updateProjectionMatrix(),this._component.controls.camera=e,this.camera=e,this.current="Perspective"}}class Zl extends gn{constructor(t){super(t);C(this,"projection");C(this,"threeOrtho");C(this,"threePersp");C(this,"_userInputButtons",{});C(this,"_frustumSize",50);C(this,"_navigationModes",new Map);C(this,"_mode",null);C(this,"previousSize",null);this.threePersp=this.three,this.threeOrtho=this.newOrthoCamera(),this.projection=new $l(this),this.onAspectUpdated.add(()=>{this.setOrthoPerspCameraAspect()}),this.projection.onChanged.add(i=>{this.three=i,this.updateAspect()}),this.worlds.onItemSet.add(()=>{this._navigationModes.clear(),this._navigationModes.set("Orbit",new Vl(this)),this._navigationModes.set("FirstPerson",new Fl(this)),this._navigationModes.set("Plan",new Hl(this)),this._mode=this._navigationModes.get("Orbit"),this.mode.set(!0,{preventTargetAdjustment:!0}),this.currentWorld&&this.currentWorld.renderer&&(this.previousSize=this.currentWorld.renderer.getSize().clone())}),this.worlds.onItemDeleted.add(()=>{this._navigationModes.clear()})}get mode(){if(!this._mode)throw new Error("Mode not found, camera not initialized");return this._mode}dispose(){super.dispose(),this.threeOrtho.removeFromParent()}set(t){if(this.mode!==null&&this.mode.id!==t){if(this.mode.set(!1),!this._navigationModes.has(t))throw new Error("The specified mode does not exist!");this._mode=this._navigationModes.get(t),this.mode.set(!0)}}async fit(t,i=1.5){if(!this.enabled)return;const s=Number.MAX_VALUE,n=Number.MIN_VALUE,r=new Z(s,s,s),o=new Z(n,n,n);for(const g of t){const m=new Lt().setFromObject(g);m.min.x<r.x&&(r.x=m.min.x),m.min.y<r.y&&(r.y=m.min.y),m.min.z<r.z&&(r.z=m.min.z),m.max.x>o.x&&(o.x=m.max.x),m.max.y>o.y&&(o.y=m.max.y),m.max.z>o.z&&(o.z=m.max.z)}const l=new Lt(r,o),c=this.components.get(ft);if(c.initialized)for(const[,g]of c.list){const m=g.box;m.min.x<r.x&&(r.x=m.min.x),m.min.y<r.y&&(r.y=m.min.y),m.min.z<r.z&&(r.z=m.min.z),m.max.x>o.x&&(o.x=m.max.x),m.max.y>o.y&&(o.y=m.max.y),m.max.z>o.z&&(o.z=m.max.z)}const u=new Z;l.getSize(u);const h=new Z;l.getCenter(h);const p=Math.max(u.x,u.y,u.z)*i,d=new is(h,p);await this.controls.fitToSphere(d,!0)}setUserInput(t){t?this.enableUserInput():this.disableUserInput()}addCustomNavigationMode(t){this._navigationModes.set(t.id,t)}disableUserInput(){this._userInputButtons.left=this.controls.mouseButtons.left,this._userInputButtons.right=this.controls.mouseButtons.right,this._userInputButtons.middle=this.controls.mouseButtons.middle,this._userInputButtons.wheel=this.controls.mouseButtons.wheel,this.controls.mouseButtons.left=0,this.controls.mouseButtons.right=0,this.controls.mouseButtons.middle=0,this.controls.mouseButtons.wheel=0}enableUserInput(){Object.keys(this._userInputButtons).length!==0&&(this.controls.mouseButtons.left=this._userInputButtons.left,this.controls.mouseButtons.right=this._userInputButtons.right,this.controls.mouseButtons.middle=this._userInputButtons.middle,this.controls.mouseButtons.wheel=this._userInputButtons.wheel)}newOrthoCamera(){const t=window.innerWidth/window.innerHeight;return new ln(this._frustumSize*t/-2,this._frustumSize*t/2,this._frustumSize/2,this._frustumSize/-2,.1,1e3)}setOrthoPerspCameraAspect(){if(!this.currentWorld||!this.currentWorld.renderer||!this.previousSize)return;const t=this.currentWorld.renderer.getSize(),i=this.threeOrtho.top,s=this.threeOrtho.right,n=t.y/this.previousSize.y,r=t.x/this.previousSize.x,o=i*n,l=s*r;this.threeOrtho.left=-l,this.threeOrtho.right=l,this.threeOrtho.top=o,this.threeOrtho.bottom=-o,this.threeOrtho.updateProjectionMatrix(),this.previousSize.copy(t)}}function Gi(a){throw new Error('Could not dynamically require "'+a+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var kr={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(a,e){(function(t){a.exports=t()})(function(){return function t(i,s,n){function r(c,u){if(!s[c]){if(!i[c]){var h=typeof Gi=="function"&&Gi;if(!u&&h)return h(c,!0);if(o)return o(c,!0);var p=new Error("Cannot find module '"+c+"'");throw p.code="MODULE_NOT_FOUND",p}var d=s[c]={exports:{}};i[c][0].call(d.exports,function(g){var m=i[c][1][g];return r(m||g)},d,d.exports,t,i,s,n)}return s[c].exports}for(var o=typeof Gi=="function"&&Gi,l=0;l<n.length;l++)r(n[l]);return r}({1:[function(t,i,s){var n=t("./utils"),r=t("./support"),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";s.encode=function(l){for(var c,u,h,p,d,g,m,b=[],f=0,y=l.length,v=y,x=n.getTypeOf(l)!=="string";f<l.length;)v=y-f,h=x?(c=l[f++],u=f<y?l[f++]:0,f<y?l[f++]:0):(c=l.charCodeAt(f++),u=f<y?l.charCodeAt(f++):0,f<y?l.charCodeAt(f++):0),p=c>>2,d=(3&c)<<4|u>>4,g=1<v?(15&u)<<2|h>>6:64,m=2<v?63&h:64,b.push(o.charAt(p)+o.charAt(d)+o.charAt(g)+o.charAt(m));return b.join("")},s.decode=function(l){var c,u,h,p,d,g,m=0,b=0,f="data:";if(l.substr(0,f.length)===f)throw new Error("Invalid base64 input, it looks like a data url.");var y,v=3*(l=l.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(l.charAt(l.length-1)===o.charAt(64)&&v--,l.charAt(l.length-2)===o.charAt(64)&&v--,v%1!=0)throw new Error("Invalid base64 input, bad content length.");for(y=r.uint8array?new Uint8Array(0|v):new Array(0|v);m<l.length;)c=o.indexOf(l.charAt(m++))<<2|(p=o.indexOf(l.charAt(m++)))>>4,u=(15&p)<<4|(d=o.indexOf(l.charAt(m++)))>>2,h=(3&d)<<6|(g=o.indexOf(l.charAt(m++))),y[b++]=c,d!==64&&(y[b++]=u),g!==64&&(y[b++]=h);return y}},{"./support":30,"./utils":32}],2:[function(t,i,s){var n=t("./external"),r=t("./stream/DataWorker"),o=t("./stream/Crc32Probe"),l=t("./stream/DataLengthProbe");function c(u,h,p,d,g){this.compressedSize=u,this.uncompressedSize=h,this.crc32=p,this.compression=d,this.compressedContent=g}c.prototype={getContentWorker:function(){var u=new r(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new l("data_length")),h=this;return u.on("end",function(){if(this.streamInfo.data_length!==h.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),u},getCompressedWorker:function(){return new r(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},c.createWorkerFrom=function(u,h,p){return u.pipe(new o).pipe(new l("uncompressedSize")).pipe(h.compressWorker(p)).pipe(new l("compressedSize")).withStreamInfo("compression",h)},i.exports=c},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,i,s){var n=t("./stream/GenericWorker");s.STORE={magic:"\0\0",compressWorker:function(){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},s.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,i,s){var n=t("./utils"),r=function(){for(var o,l=[],c=0;c<256;c++){o=c;for(var u=0;u<8;u++)o=1&o?3988292384^o>>>1:o>>>1;l[c]=o}return l}();i.exports=function(o,l){return o!==void 0&&o.length?n.getTypeOf(o)!=="string"?function(c,u,h,p){var d=r,g=p+h;c^=-1;for(var m=p;m<g;m++)c=c>>>8^d[255&(c^u[m])];return-1^c}(0|l,o,o.length,0):function(c,u,h,p){var d=r,g=p+h;c^=-1;for(var m=p;m<g;m++)c=c>>>8^d[255&(c^u.charCodeAt(m))];return-1^c}(0|l,o,o.length,0):0}},{"./utils":32}],5:[function(t,i,s){s.base64=!1,s.binary=!1,s.dir=!1,s.createFolders=!0,s.date=null,s.compression=null,s.compressionOptions=null,s.comment=null,s.unixPermissions=null,s.dosPermissions=null},{}],6:[function(t,i,s){var n=null;n=typeof Promise<"u"?Promise:t("lie"),i.exports={Promise:n}},{lie:37}],7:[function(t,i,s){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",r=t("pako"),o=t("./utils"),l=t("./stream/GenericWorker"),c=n?"uint8array":"array";function u(h,p){l.call(this,"FlateWorker/"+h),this._pako=null,this._pakoAction=h,this._pakoOptions=p,this.meta={}}s.magic="\b\0",o.inherits(u,l),u.prototype.processChunk=function(h){this.meta=h.meta,this._pako===null&&this._createPako(),this._pako.push(o.transformTo(c,h.data),!1)},u.prototype.flush=function(){l.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},u.prototype.cleanUp=function(){l.prototype.cleanUp.call(this),this._pako=null},u.prototype._createPako=function(){this._pako=new r[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var h=this;this._pako.onData=function(p){h.push({data:p,meta:h.meta})}},s.compressWorker=function(h){return new u("Deflate",h)},s.uncompressWorker=function(){return new u("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,i,s){function n(d,g){var m,b="";for(m=0;m<g;m++)b+=String.fromCharCode(255&d),d>>>=8;return b}function r(d,g,m,b,f,y){var v,x,T=d.file,A=d.compression,S=y!==c.utf8encode,M=o.transformTo("string",y(T.name)),I=o.transformTo("string",c.utf8encode(T.name)),k=T.comment,$=o.transformTo("string",y(k)),E=o.transformTo("string",c.utf8encode(k)),z=I.length!==T.name.length,_=E.length!==k.length,L="",W="",V="",st=T.dir,H=T.date,et={crc32:0,compressedSize:0,uncompressedSize:0};g&&!m||(et.crc32=d.crc32,et.compressedSize=d.compressedSize,et.uncompressedSize=d.uncompressedSize);var D=0;g&&(D|=8),S||!z&&!_||(D|=2048);var B=0,J=0;st&&(B|=16),f==="UNIX"?(J=798,B|=function(q,ut){var Ct=q;return q||(Ct=ut?16893:33204),(65535&Ct)<<16}(T.unixPermissions,st)):(J=20,B|=function(q){return 63&(q||0)}(T.dosPermissions)),v=H.getUTCHours(),v<<=6,v|=H.getUTCMinutes(),v<<=5,v|=H.getUTCSeconds()/2,x=H.getUTCFullYear()-1980,x<<=4,x|=H.getUTCMonth()+1,x<<=5,x|=H.getUTCDate(),z&&(W=n(1,1)+n(u(M),4)+I,L+="up"+n(W.length,2)+W),_&&(V=n(1,1)+n(u($),4)+E,L+="uc"+n(V.length,2)+V);var K="";return K+=`
\0`,K+=n(D,2),K+=A.magic,K+=n(v,2),K+=n(x,2),K+=n(et.crc32,4),K+=n(et.compressedSize,4),K+=n(et.uncompressedSize,4),K+=n(M.length,2),K+=n(L.length,2),{fileRecord:h.LOCAL_FILE_HEADER+K+M+L,dirRecord:h.CENTRAL_FILE_HEADER+n(J,2)+K+n($.length,2)+"\0\0\0\0"+n(B,4)+n(b,4)+M+L+$}}var o=t("../utils"),l=t("../stream/GenericWorker"),c=t("../utf8"),u=t("../crc32"),h=t("../signature");function p(d,g,m,b){l.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=g,this.zipPlatform=m,this.encodeFileName=b,this.streamFiles=d,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}o.inherits(p,l),p.prototype.push=function(d){var g=d.meta.percent||0,m=this.entriesCount,b=this._sources.length;this.accumulate?this.contentBuffer.push(d):(this.bytesWritten+=d.data.length,l.prototype.push.call(this,{data:d.data,meta:{currentFile:this.currentFile,percent:m?(g+100*(m-b-1))/m:100}}))},p.prototype.openedSource=function(d){this.currentSourceOffset=this.bytesWritten,this.currentFile=d.file.name;var g=this.streamFiles&&!d.file.dir;if(g){var m=r(d,g,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},p.prototype.closedSource=function(d){this.accumulate=!1;var g=this.streamFiles&&!d.file.dir,m=r(d,g,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),g)this.push({data:function(b){return h.DATA_DESCRIPTOR+n(b.crc32,4)+n(b.compressedSize,4)+n(b.uncompressedSize,4)}(d),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},p.prototype.flush=function(){for(var d=this.bytesWritten,g=0;g<this.dirRecords.length;g++)this.push({data:this.dirRecords[g],meta:{percent:100}});var m=this.bytesWritten-d,b=function(f,y,v,x,T){var A=o.transformTo("string",T(x));return h.CENTRAL_DIRECTORY_END+"\0\0\0\0"+n(f,2)+n(f,2)+n(y,4)+n(v,4)+n(A.length,2)+A}(this.dirRecords.length,m,d,this.zipComment,this.encodeFileName);this.push({data:b,meta:{percent:100}})},p.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},p.prototype.registerPrevious=function(d){this._sources.push(d);var g=this;return d.on("data",function(m){g.processChunk(m)}),d.on("end",function(){g.closedSource(g.previous.streamInfo),g._sources.length?g.prepareNextSource():g.end()}),d.on("error",function(m){g.error(m)}),this},p.prototype.resume=function(){return!!l.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},p.prototype.error=function(d){var g=this._sources;if(!l.prototype.error.call(this,d))return!1;for(var m=0;m<g.length;m++)try{g[m].error(d)}catch{}return!0},p.prototype.lock=function(){l.prototype.lock.call(this);for(var d=this._sources,g=0;g<d.length;g++)d[g].lock()},i.exports=p},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,i,s){var n=t("../compressions"),r=t("./ZipFileWorker");s.generateWorker=function(o,l,c){var u=new r(l.streamFiles,c,l.platform,l.encodeFileName),h=0;try{o.forEach(function(p,d){h++;var g=function(y,v){var x=y||v,T=n[x];if(!T)throw new Error(x+" is not a valid compression method !");return T}(d.options.compression,l.compression),m=d.options.compressionOptions||l.compressionOptions||{},b=d.dir,f=d.date;d._compressWorker(g,m).withStreamInfo("file",{name:p,dir:b,date:f,comment:d.comment||"",unixPermissions:d.unixPermissions,dosPermissions:d.dosPermissions}).pipe(u)}),u.entriesCount=h}catch(p){u.error(p)}return u}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,i,s){function n(){if(!(this instanceof n))return new n;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var r=new n;for(var o in this)typeof this[o]!="function"&&(r[o]=this[o]);return r}}(n.prototype=t("./object")).loadAsync=t("./load"),n.support=t("./support"),n.defaults=t("./defaults"),n.version="3.10.1",n.loadAsync=function(r,o){return new n().loadAsync(r,o)},n.external=t("./external"),i.exports=n},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,i,s){var n=t("./utils"),r=t("./external"),o=t("./utf8"),l=t("./zipEntries"),c=t("./stream/Crc32Probe"),u=t("./nodejsUtils");function h(p){return new r.Promise(function(d,g){var m=p.decompressed.getContentWorker().pipe(new c);m.on("error",function(b){g(b)}).on("end",function(){m.streamInfo.crc32!==p.decompressed.crc32?g(new Error("Corrupted zip : CRC32 mismatch")):d()}).resume()})}i.exports=function(p,d){var g=this;return d=n.extend(d||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),u.isNode&&u.isStream(p)?r.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",p,!0,d.optimizedBinaryString,d.base64).then(function(m){var b=new l(d);return b.load(m),b}).then(function(m){var b=[r.Promise.resolve(m)],f=m.files;if(d.checkCRC32)for(var y=0;y<f.length;y++)b.push(h(f[y]));return r.Promise.all(b)}).then(function(m){for(var b=m.shift(),f=b.files,y=0;y<f.length;y++){var v=f[y],x=v.fileNameStr,T=n.resolve(v.fileNameStr);g.file(T,v.decompressed,{binary:!0,optimizedBinaryString:!0,date:v.date,dir:v.dir,comment:v.fileCommentStr.length?v.fileCommentStr:null,unixPermissions:v.unixPermissions,dosPermissions:v.dosPermissions,createFolders:d.createFolders}),v.dir||(g.file(T).unsafeOriginalName=x)}return b.zipComment.length&&(g.comment=b.zipComment),g})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,i,s){var n=t("../utils"),r=t("../stream/GenericWorker");function o(l,c){r.call(this,"Nodejs stream input adapter for "+l),this._upstreamEnded=!1,this._bindStream(c)}n.inherits(o,r),o.prototype._bindStream=function(l){var c=this;(this._stream=l).pause(),l.on("data",function(u){c.push({data:u,meta:{percent:0}})}).on("error",function(u){c.isPaused?this.generatedError=u:c.error(u)}).on("end",function(){c.isPaused?c._upstreamEnded=!0:c.end()})},o.prototype.pause=function(){return!!r.prototype.pause.call(this)&&(this._stream.pause(),!0)},o.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},i.exports=o},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,i,s){var n=t("readable-stream").Readable;function r(o,l,c){n.call(this,l),this._helper=o;var u=this;o.on("data",function(h,p){u.push(h)||u._helper.pause(),c&&c(p)}).on("error",function(h){u.emit("error",h)}).on("end",function(){u.push(null)})}t("../utils").inherits(r,n),r.prototype._read=function(){this._helper.resume()},i.exports=r},{"../utils":32,"readable-stream":16}],14:[function(t,i,s){i.exports={isNode:typeof Buffer<"u",newBufferFrom:function(n,r){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(n,r);if(typeof n=="number")throw new Error('The "data" argument must not be a number');return new Buffer(n,r)},allocBuffer:function(n){if(Buffer.alloc)return Buffer.alloc(n);var r=new Buffer(n);return r.fill(0),r},isBuffer:function(n){return Buffer.isBuffer(n)},isStream:function(n){return n&&typeof n.on=="function"&&typeof n.pause=="function"&&typeof n.resume=="function"}}},{}],15:[function(t,i,s){function n(T,A,S){var M,I=o.getTypeOf(A),k=o.extend(S||{},u);k.date=k.date||new Date,k.compression!==null&&(k.compression=k.compression.toUpperCase()),typeof k.unixPermissions=="string"&&(k.unixPermissions=parseInt(k.unixPermissions,8)),k.unixPermissions&&16384&k.unixPermissions&&(k.dir=!0),k.dosPermissions&&16&k.dosPermissions&&(k.dir=!0),k.dir&&(T=f(T)),k.createFolders&&(M=b(T))&&y.call(this,M,!0);var $=I==="string"&&k.binary===!1&&k.base64===!1;S&&S.binary!==void 0||(k.binary=!$),(A instanceof h&&A.uncompressedSize===0||k.dir||!A||A.length===0)&&(k.base64=!1,k.binary=!0,A="",k.compression="STORE",I="string");var E=null;E=A instanceof h||A instanceof l?A:g.isNode&&g.isStream(A)?new m(T,A):o.prepareContent(T,A,k.binary,k.optimizedBinaryString,k.base64);var z=new p(T,E,k);this.files[T]=z}var r=t("./utf8"),o=t("./utils"),l=t("./stream/GenericWorker"),c=t("./stream/StreamHelper"),u=t("./defaults"),h=t("./compressedObject"),p=t("./zipObject"),d=t("./generate"),g=t("./nodejsUtils"),m=t("./nodejs/NodejsStreamInputAdapter"),b=function(T){T.slice(-1)==="/"&&(T=T.substring(0,T.length-1));var A=T.lastIndexOf("/");return 0<A?T.substring(0,A):""},f=function(T){return T.slice(-1)!=="/"&&(T+="/"),T},y=function(T,A){return A=A!==void 0?A:u.createFolders,T=f(T),this.files[T]||n.call(this,T,null,{dir:!0,createFolders:A}),this.files[T]};function v(T){return Object.prototype.toString.call(T)==="[object RegExp]"}var x={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(T){var A,S,M;for(A in this.files)M=this.files[A],(S=A.slice(this.root.length,A.length))&&A.slice(0,this.root.length)===this.root&&T(S,M)},filter:function(T){var A=[];return this.forEach(function(S,M){T(S,M)&&A.push(M)}),A},file:function(T,A,S){if(arguments.length!==1)return T=this.root+T,n.call(this,T,A,S),this;if(v(T)){var M=T;return this.filter(function(k,$){return!$.dir&&M.test(k)})}var I=this.files[this.root+T];return I&&!I.dir?I:null},folder:function(T){if(!T)return this;if(v(T))return this.filter(function(I,k){return k.dir&&T.test(I)});var A=this.root+T,S=y.call(this,A),M=this.clone();return M.root=S.name,M},remove:function(T){T=this.root+T;var A=this.files[T];if(A||(T.slice(-1)!=="/"&&(T+="/"),A=this.files[T]),A&&!A.dir)delete this.files[T];else for(var S=this.filter(function(I,k){return k.name.slice(0,T.length)===T}),M=0;M<S.length;M++)delete this.files[S[M].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(T){var A,S={};try{if((S=o.extend(T||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:r.utf8encode})).type=S.type.toLowerCase(),S.compression=S.compression.toUpperCase(),S.type==="binarystring"&&(S.type="string"),!S.type)throw new Error("No output type specified.");o.checkSupport(S.type),S.platform!=="darwin"&&S.platform!=="freebsd"&&S.platform!=="linux"&&S.platform!=="sunos"||(S.platform="UNIX"),S.platform==="win32"&&(S.platform="DOS");var M=S.comment||this.comment||"";A=d.generateWorker(this,S,M)}catch(I){(A=new l("error")).error(I)}return new c(A,S.type||"string",S.mimeType)},generateAsync:function(T,A){return this.generateInternalStream(T).accumulate(A)},generateNodeStream:function(T,A){return(T=T||{}).type||(T.type="nodebuffer"),this.generateInternalStream(T).toNodejsStream(A)}};i.exports=x},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,i,s){i.exports=t("stream")},{stream:void 0}],17:[function(t,i,s){var n=t("./DataReader");function r(o){n.call(this,o);for(var l=0;l<this.data.length;l++)o[l]=255&o[l]}t("../utils").inherits(r,n),r.prototype.byteAt=function(o){return this.data[this.zero+o]},r.prototype.lastIndexOfSignature=function(o){for(var l=o.charCodeAt(0),c=o.charCodeAt(1),u=o.charCodeAt(2),h=o.charCodeAt(3),p=this.length-4;0<=p;--p)if(this.data[p]===l&&this.data[p+1]===c&&this.data[p+2]===u&&this.data[p+3]===h)return p-this.zero;return-1},r.prototype.readAndCheckSignature=function(o){var l=o.charCodeAt(0),c=o.charCodeAt(1),u=o.charCodeAt(2),h=o.charCodeAt(3),p=this.readData(4);return l===p[0]&&c===p[1]&&u===p[2]&&h===p[3]},r.prototype.readData=function(o){if(this.checkOffset(o),o===0)return[];var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},i.exports=r},{"../utils":32,"./DataReader":18}],18:[function(t,i,s){var n=t("../utils");function r(o){this.data=o,this.length=o.length,this.index=0,this.zero=0}r.prototype={checkOffset:function(o){this.checkIndex(this.index+o)},checkIndex:function(o){if(this.length<this.zero+o||o<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+o+"). Corrupted zip ?")},setIndex:function(o){this.checkIndex(o),this.index=o},skip:function(o){this.setIndex(this.index+o)},byteAt:function(){},readInt:function(o){var l,c=0;for(this.checkOffset(o),l=this.index+o-1;l>=this.index;l--)c=(c<<8)+this.byteAt(l);return this.index+=o,c},readString:function(o){return n.transformTo("string",this.readData(o))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var o=this.readInt(4);return new Date(Date.UTC(1980+(o>>25&127),(o>>21&15)-1,o>>16&31,o>>11&31,o>>5&63,(31&o)<<1))}},i.exports=r},{"../utils":32}],19:[function(t,i,s){var n=t("./Uint8ArrayReader");function r(o){n.call(this,o)}t("../utils").inherits(r,n),r.prototype.readData=function(o){this.checkOffset(o);var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},i.exports=r},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,i,s){var n=t("./DataReader");function r(o){n.call(this,o)}t("../utils").inherits(r,n),r.prototype.byteAt=function(o){return this.data.charCodeAt(this.zero+o)},r.prototype.lastIndexOfSignature=function(o){return this.data.lastIndexOf(o)-this.zero},r.prototype.readAndCheckSignature=function(o){return o===this.readData(4)},r.prototype.readData=function(o){this.checkOffset(o);var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},i.exports=r},{"../utils":32,"./DataReader":18}],21:[function(t,i,s){var n=t("./ArrayReader");function r(o){n.call(this,o)}t("../utils").inherits(r,n),r.prototype.readData=function(o){if(this.checkOffset(o),o===0)return new Uint8Array(0);var l=this.data.subarray(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},i.exports=r},{"../utils":32,"./ArrayReader":17}],22:[function(t,i,s){var n=t("../utils"),r=t("../support"),o=t("./ArrayReader"),l=t("./StringReader"),c=t("./NodeBufferReader"),u=t("./Uint8ArrayReader");i.exports=function(h){var p=n.getTypeOf(h);return n.checkSupport(p),p!=="string"||r.uint8array?p==="nodebuffer"?new c(h):r.uint8array?new u(n.transformTo("uint8array",h)):new o(n.transformTo("array",h)):new l(h)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,i,s){s.LOCAL_FILE_HEADER="PK",s.CENTRAL_FILE_HEADER="PK",s.CENTRAL_DIRECTORY_END="PK",s.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",s.ZIP64_CENTRAL_DIRECTORY_END="PK",s.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(t,i,s){var n=t("./GenericWorker"),r=t("../utils");function o(l){n.call(this,"ConvertWorker to "+l),this.destType=l}r.inherits(o,n),o.prototype.processChunk=function(l){this.push({data:r.transformTo(this.destType,l.data),meta:l.meta})},i.exports=o},{"../utils":32,"./GenericWorker":28}],25:[function(t,i,s){var n=t("./GenericWorker"),r=t("../crc32");function o(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(o,n),o.prototype.processChunk=function(l){this.streamInfo.crc32=r(l.data,this.streamInfo.crc32||0),this.push(l)},i.exports=o},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,i,s){var n=t("../utils"),r=t("./GenericWorker");function o(l){r.call(this,"DataLengthProbe for "+l),this.propName=l,this.withStreamInfo(l,0)}n.inherits(o,r),o.prototype.processChunk=function(l){if(l){var c=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=c+l.data.length}r.prototype.processChunk.call(this,l)},i.exports=o},{"../utils":32,"./GenericWorker":28}],27:[function(t,i,s){var n=t("../utils"),r=t("./GenericWorker");function o(l){r.call(this,"DataWorker");var c=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,l.then(function(u){c.dataIsReady=!0,c.data=u,c.max=u&&u.length||0,c.type=n.getTypeOf(u),c.isPaused||c._tickAndRepeat()},function(u){c.error(u)})}n.inherits(o,r),o.prototype.cleanUp=function(){r.prototype.cleanUp.call(this),this.data=null},o.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},o.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},o.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var l=null,c=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":l=this.data.substring(this.index,c);break;case"uint8array":l=this.data.subarray(this.index,c);break;case"array":case"nodebuffer":l=this.data.slice(this.index,c)}return this.index=c,this.push({data:l,meta:{percent:this.max?this.index/this.max*100:0}})},i.exports=o},{"../utils":32,"./GenericWorker":28}],28:[function(t,i,s){function n(r){this.name=r||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}n.prototype={push:function(r){this.emit("data",r)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(r){this.emit("error",r)}return!0},error:function(r){return!this.isFinished&&(this.isPaused?this.generatedError=r:(this.isFinished=!0,this.emit("error",r),this.previous&&this.previous.error(r),this.cleanUp()),!0)},on:function(r,o){return this._listeners[r].push(o),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(r,o){if(this._listeners[r])for(var l=0;l<this._listeners[r].length;l++)this._listeners[r][l].call(this,o)},pipe:function(r){return r.registerPrevious(this)},registerPrevious:function(r){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=r.streamInfo,this.mergeStreamInfo(),this.previous=r;var o=this;return r.on("data",function(l){o.processChunk(l)}),r.on("end",function(){o.end()}),r.on("error",function(l){o.error(l)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var r=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),r=!0),this.previous&&this.previous.resume(),!r},flush:function(){},processChunk:function(r){this.push(r)},withStreamInfo:function(r,o){return this.extraStreamInfo[r]=o,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var r in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,r)&&(this.streamInfo[r]=this.extraStreamInfo[r])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var r="Worker "+this.name;return this.previous?this.previous+" -> "+r:r}},i.exports=n},{}],29:[function(t,i,s){var n=t("../utils"),r=t("./ConvertWorker"),o=t("./GenericWorker"),l=t("../base64"),c=t("../support"),u=t("../external"),h=null;if(c.nodestream)try{h=t("../nodejs/NodejsStreamOutputAdapter")}catch{}function p(g,m){return new u.Promise(function(b,f){var y=[],v=g._internalType,x=g._outputType,T=g._mimeType;g.on("data",function(A,S){y.push(A),m&&m(S)}).on("error",function(A){y=[],f(A)}).on("end",function(){try{var A=function(S,M,I){switch(S){case"blob":return n.newBlob(n.transformTo("arraybuffer",M),I);case"base64":return l.encode(M);default:return n.transformTo(S,M)}}(x,function(S,M){var I,k=0,$=null,E=0;for(I=0;I<M.length;I++)E+=M[I].length;switch(S){case"string":return M.join("");case"array":return Array.prototype.concat.apply([],M);case"uint8array":for($=new Uint8Array(E),I=0;I<M.length;I++)$.set(M[I],k),k+=M[I].length;return $;case"nodebuffer":return Buffer.concat(M);default:throw new Error("concat : unsupported type '"+S+"'")}}(v,y),T);b(A)}catch(S){f(S)}y=[]}).resume()})}function d(g,m,b){var f=m;switch(m){case"blob":case"arraybuffer":f="uint8array";break;case"base64":f="string"}try{this._internalType=f,this._outputType=m,this._mimeType=b,n.checkSupport(f),this._worker=g.pipe(new r(f)),g.lock()}catch(y){this._worker=new o("error"),this._worker.error(y)}}d.prototype={accumulate:function(g){return p(this,g)},on:function(g,m){var b=this;return g==="data"?this._worker.on(g,function(f){m.call(b,f.data,f.meta)}):this._worker.on(g,function(){n.delay(m,arguments,b)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(g){if(n.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new h(this,{objectMode:this._outputType!=="nodebuffer"},g)}},i.exports=d},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,i,s){if(s.base64=!0,s.array=!0,s.string=!0,s.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",s.nodebuffer=typeof Buffer<"u",s.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")s.blob=!1;else{var n=new ArrayBuffer(0);try{s.blob=new Blob([n],{type:"application/zip"}).size===0}catch{try{var r=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);r.append(n),s.blob=r.getBlob("application/zip").size===0}catch{s.blob=!1}}}try{s.nodestream=!!t("readable-stream").Readable}catch{s.nodestream=!1}},{"readable-stream":16}],31:[function(t,i,s){for(var n=t("./utils"),r=t("./support"),o=t("./nodejsUtils"),l=t("./stream/GenericWorker"),c=new Array(256),u=0;u<256;u++)c[u]=252<=u?6:248<=u?5:240<=u?4:224<=u?3:192<=u?2:1;c[254]=c[254]=1;function h(){l.call(this,"utf-8 decode"),this.leftOver=null}function p(){l.call(this,"utf-8 encode")}s.utf8encode=function(d){return r.nodebuffer?o.newBufferFrom(d,"utf-8"):function(g){var m,b,f,y,v,x=g.length,T=0;for(y=0;y<x;y++)(64512&(b=g.charCodeAt(y)))==55296&&y+1<x&&(64512&(f=g.charCodeAt(y+1)))==56320&&(b=65536+(b-55296<<10)+(f-56320),y++),T+=b<128?1:b<2048?2:b<65536?3:4;for(m=r.uint8array?new Uint8Array(T):new Array(T),y=v=0;v<T;y++)(64512&(b=g.charCodeAt(y)))==55296&&y+1<x&&(64512&(f=g.charCodeAt(y+1)))==56320&&(b=65536+(b-55296<<10)+(f-56320),y++),b<128?m[v++]=b:(b<2048?m[v++]=192|b>>>6:(b<65536?m[v++]=224|b>>>12:(m[v++]=240|b>>>18,m[v++]=128|b>>>12&63),m[v++]=128|b>>>6&63),m[v++]=128|63&b);return m}(d)},s.utf8decode=function(d){return r.nodebuffer?n.transformTo("nodebuffer",d).toString("utf-8"):function(g){var m,b,f,y,v=g.length,x=new Array(2*v);for(m=b=0;m<v;)if((f=g[m++])<128)x[b++]=f;else if(4<(y=c[f]))x[b++]=65533,m+=y-1;else{for(f&=y===2?31:y===3?15:7;1<y&&m<v;)f=f<<6|63&g[m++],y--;1<y?x[b++]=65533:f<65536?x[b++]=f:(f-=65536,x[b++]=55296|f>>10&1023,x[b++]=56320|1023&f)}return x.length!==b&&(x.subarray?x=x.subarray(0,b):x.length=b),n.applyFromCharCode(x)}(d=n.transformTo(r.uint8array?"uint8array":"array",d))},n.inherits(h,l),h.prototype.processChunk=function(d){var g=n.transformTo(r.uint8array?"uint8array":"array",d.data);if(this.leftOver&&this.leftOver.length){if(r.uint8array){var m=g;(g=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),g.set(m,this.leftOver.length)}else g=this.leftOver.concat(g);this.leftOver=null}var b=function(y,v){var x;for((v=v||y.length)>y.length&&(v=y.length),x=v-1;0<=x&&(192&y[x])==128;)x--;return x<0||x===0?v:x+c[y[x]]>v?x:v}(g),f=g;b!==g.length&&(r.uint8array?(f=g.subarray(0,b),this.leftOver=g.subarray(b,g.length)):(f=g.slice(0,b),this.leftOver=g.slice(b,g.length))),this.push({data:s.utf8decode(f),meta:d.meta})},h.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:s.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},s.Utf8DecodeWorker=h,n.inherits(p,l),p.prototype.processChunk=function(d){this.push({data:s.utf8encode(d.data),meta:d.meta})},s.Utf8EncodeWorker=p},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,i,s){var n=t("./support"),r=t("./base64"),o=t("./nodejsUtils"),l=t("./external");function c(m){return m}function u(m,b){for(var f=0;f<m.length;++f)b[f]=255&m.charCodeAt(f);return b}t("setimmediate"),s.newBlob=function(m,b){s.checkSupport("blob");try{return new Blob([m],{type:b})}catch{try{var f=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return f.append(m),f.getBlob(b)}catch{throw new Error("Bug : can't construct the Blob.")}}};var h={stringifyByChunk:function(m,b,f){var y=[],v=0,x=m.length;if(x<=f)return String.fromCharCode.apply(null,m);for(;v<x;)b==="array"||b==="nodebuffer"?y.push(String.fromCharCode.apply(null,m.slice(v,Math.min(v+f,x)))):y.push(String.fromCharCode.apply(null,m.subarray(v,Math.min(v+f,x)))),v+=f;return y.join("")},stringifyByChar:function(m){for(var b="",f=0;f<m.length;f++)b+=String.fromCharCode(m[f]);return b},applyCanBeUsed:{uint8array:function(){try{return n.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return n.nodebuffer&&String.fromCharCode.apply(null,o.allocBuffer(1)).length===1}catch{return!1}}()}};function p(m){var b=65536,f=s.getTypeOf(m),y=!0;if(f==="uint8array"?y=h.applyCanBeUsed.uint8array:f==="nodebuffer"&&(y=h.applyCanBeUsed.nodebuffer),y)for(;1<b;)try{return h.stringifyByChunk(m,f,b)}catch{b=Math.floor(b/2)}return h.stringifyByChar(m)}function d(m,b){for(var f=0;f<m.length;f++)b[f]=m[f];return b}s.applyFromCharCode=p;var g={};g.string={string:c,array:function(m){return u(m,new Array(m.length))},arraybuffer:function(m){return g.string.uint8array(m).buffer},uint8array:function(m){return u(m,new Uint8Array(m.length))},nodebuffer:function(m){return u(m,o.allocBuffer(m.length))}},g.array={string:p,array:c,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(m)}},g.arraybuffer={string:function(m){return p(new Uint8Array(m))},array:function(m){return d(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:c,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(new Uint8Array(m))}},g.uint8array={string:p,array:function(m){return d(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:c,nodebuffer:function(m){return o.newBufferFrom(m)}},g.nodebuffer={string:p,array:function(m){return d(m,new Array(m.length))},arraybuffer:function(m){return g.nodebuffer.uint8array(m).buffer},uint8array:function(m){return d(m,new Uint8Array(m.length))},nodebuffer:c},s.transformTo=function(m,b){if(b=b||"",!m)return b;s.checkSupport(m);var f=s.getTypeOf(b);return g[f][m](b)},s.resolve=function(m){for(var b=m.split("/"),f=[],y=0;y<b.length;y++){var v=b[y];v==="."||v===""&&y!==0&&y!==b.length-1||(v===".."?f.pop():f.push(v))}return f.join("/")},s.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":n.nodebuffer&&o.isBuffer(m)?"nodebuffer":n.uint8array&&m instanceof Uint8Array?"uint8array":n.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},s.checkSupport=function(m){if(!n[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},s.MAX_VALUE_16BITS=65535,s.MAX_VALUE_32BITS=-1,s.pretty=function(m){var b,f,y="";for(f=0;f<(m||"").length;f++)y+="\\x"+((b=m.charCodeAt(f))<16?"0":"")+b.toString(16).toUpperCase();return y},s.delay=function(m,b,f){setImmediate(function(){m.apply(f||null,b||[])})},s.inherits=function(m,b){function f(){}f.prototype=b.prototype,m.prototype=new f},s.extend=function(){var m,b,f={};for(m=0;m<arguments.length;m++)for(b in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],b)&&f[b]===void 0&&(f[b]=arguments[m][b]);return f},s.prepareContent=function(m,b,f,y,v){return l.Promise.resolve(b).then(function(x){return n.blob&&(x instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(x))!==-1)&&typeof FileReader<"u"?new l.Promise(function(T,A){var S=new FileReader;S.onload=function(M){T(M.target.result)},S.onerror=function(M){A(M.target.error)},S.readAsArrayBuffer(x)}):x}).then(function(x){var T=s.getTypeOf(x);return T?(T==="arraybuffer"?x=s.transformTo("uint8array",x):T==="string"&&(v?x=r.decode(x):f&&y!==!0&&(x=function(A){return u(A,n.uint8array?new Uint8Array(A.length):new Array(A.length))}(x))),x):l.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,i,s){var n=t("./reader/readerFor"),r=t("./utils"),o=t("./signature"),l=t("./zipEntry"),c=t("./support");function u(h){this.files=[],this.loadOptions=h}u.prototype={checkSignature:function(h){if(!this.reader.readAndCheckSignature(h)){this.reader.index-=4;var p=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+r.pretty(p)+", expected "+r.pretty(h)+")")}},isSignature:function(h,p){var d=this.reader.index;this.reader.setIndex(h);var g=this.reader.readString(4)===p;return this.reader.setIndex(d),g},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var h=this.reader.readData(this.zipCommentLength),p=c.uint8array?"uint8array":"array",d=r.transformTo(p,h);this.zipComment=this.loadOptions.decodeFileName(d)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var h,p,d,g=this.zip64EndOfCentralSize-44;0<g;)h=this.reader.readInt(2),p=this.reader.readInt(4),d=this.reader.readData(p),this.zip64ExtensibleData[h]={id:h,length:p,value:d}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var h,p;for(h=0;h<this.files.length;h++)p=this.files[h],this.reader.setIndex(p.localHeaderOffset),this.checkSignature(o.LOCAL_FILE_HEADER),p.readLocalPart(this.reader),p.handleUTF8(),p.processAttributes()},readCentralDir:function(){var h;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(o.CENTRAL_FILE_HEADER);)(h=new l({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(h);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var h=this.reader.lastIndexOfSignature(o.CENTRAL_DIRECTORY_END);if(h<0)throw this.isSignature(0,o.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(h);var p=h;if(this.checkSignature(o.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===r.MAX_VALUE_16BITS||this.diskWithCentralDirStart===r.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===r.MAX_VALUE_16BITS||this.centralDirRecords===r.MAX_VALUE_16BITS||this.centralDirSize===r.MAX_VALUE_32BITS||this.centralDirOffset===r.MAX_VALUE_32BITS){if(this.zip64=!0,(h=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(h),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,o.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var d=this.centralDirOffset+this.centralDirSize;this.zip64&&(d+=20,d+=12+this.zip64EndOfCentralSize);var g=p-d;if(0<g)this.isSignature(p,o.CENTRAL_FILE_HEADER)||(this.reader.zero=g);else if(g<0)throw new Error("Corrupted zip: missing "+Math.abs(g)+" bytes.")},prepareReader:function(h){this.reader=n(h)},load:function(h){this.prepareReader(h),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},i.exports=u},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,i,s){var n=t("./reader/readerFor"),r=t("./utils"),o=t("./compressedObject"),l=t("./crc32"),c=t("./utf8"),u=t("./compressions"),h=t("./support");function p(d,g){this.options=d,this.loadOptions=g}p.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(d){var g,m;if(d.skip(22),this.fileNameLength=d.readInt(2),m=d.readInt(2),this.fileName=d.readData(this.fileNameLength),d.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((g=function(b){for(var f in u)if(Object.prototype.hasOwnProperty.call(u,f)&&u[f].magic===b)return u[f];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+r.pretty(this.compressionMethod)+" unknown (inner file : "+r.transformTo("string",this.fileName)+")");this.decompressed=new o(this.compressedSize,this.uncompressedSize,this.crc32,g,d.readData(this.compressedSize))},readCentralPart:function(d){this.versionMadeBy=d.readInt(2),d.skip(2),this.bitFlag=d.readInt(2),this.compressionMethod=d.readString(2),this.date=d.readDate(),this.crc32=d.readInt(4),this.compressedSize=d.readInt(4),this.uncompressedSize=d.readInt(4);var g=d.readInt(2);if(this.extraFieldsLength=d.readInt(2),this.fileCommentLength=d.readInt(2),this.diskNumberStart=d.readInt(2),this.internalFileAttributes=d.readInt(2),this.externalFileAttributes=d.readInt(4),this.localHeaderOffset=d.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");d.skip(g),this.readExtraFields(d),this.parseZIP64ExtraField(d),this.fileComment=d.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var d=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),d==0&&(this.dosPermissions=63&this.externalFileAttributes),d==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var d=n(this.extraFields[1].value);this.uncompressedSize===r.MAX_VALUE_32BITS&&(this.uncompressedSize=d.readInt(8)),this.compressedSize===r.MAX_VALUE_32BITS&&(this.compressedSize=d.readInt(8)),this.localHeaderOffset===r.MAX_VALUE_32BITS&&(this.localHeaderOffset=d.readInt(8)),this.diskNumberStart===r.MAX_VALUE_32BITS&&(this.diskNumberStart=d.readInt(4))}},readExtraFields:function(d){var g,m,b,f=d.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});d.index+4<f;)g=d.readInt(2),m=d.readInt(2),b=d.readData(m),this.extraFields[g]={id:g,length:m,value:b};d.setIndex(f)},handleUTF8:function(){var d=h.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=c.utf8decode(this.fileName),this.fileCommentStr=c.utf8decode(this.fileComment);else{var g=this.findExtraFieldUnicodePath();if(g!==null)this.fileNameStr=g;else{var m=r.transformTo(d,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var b=this.findExtraFieldUnicodeComment();if(b!==null)this.fileCommentStr=b;else{var f=r.transformTo(d,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(f)}}},findExtraFieldUnicodePath:function(){var d=this.extraFields[28789];if(d){var g=n(d.value);return g.readInt(1)!==1||l(this.fileName)!==g.readInt(4)?null:c.utf8decode(g.readData(d.length-5))}return null},findExtraFieldUnicodeComment:function(){var d=this.extraFields[25461];if(d){var g=n(d.value);return g.readInt(1)!==1||l(this.fileComment)!==g.readInt(4)?null:c.utf8decode(g.readData(d.length-5))}return null}},i.exports=p},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,i,s){function n(g,m,b){this.name=g,this.dir=b.dir,this.date=b.date,this.comment=b.comment,this.unixPermissions=b.unixPermissions,this.dosPermissions=b.dosPermissions,this._data=m,this._dataBinary=b.binary,this.options={compression:b.compression,compressionOptions:b.compressionOptions}}var r=t("./stream/StreamHelper"),o=t("./stream/DataWorker"),l=t("./utf8"),c=t("./compressedObject"),u=t("./stream/GenericWorker");n.prototype={internalStream:function(g){var m=null,b="string";try{if(!g)throw new Error("No output type specified.");var f=(b=g.toLowerCase())==="string"||b==="text";b!=="binarystring"&&b!=="text"||(b="string"),m=this._decompressWorker();var y=!this._dataBinary;y&&!f&&(m=m.pipe(new l.Utf8EncodeWorker)),!y&&f&&(m=m.pipe(new l.Utf8DecodeWorker))}catch(v){(m=new u("error")).error(v)}return new r(m,b,"")},async:function(g,m){return this.internalStream(g).accumulate(m)},nodeStream:function(g,m){return this.internalStream(g||"nodebuffer").toNodejsStream(m)},_compressWorker:function(g,m){if(this._data instanceof c&&this._data.compression.magic===g.magic)return this._data.getCompressedWorker();var b=this._decompressWorker();return this._dataBinary||(b=b.pipe(new l.Utf8EncodeWorker)),c.createWorkerFrom(b,g,m)},_decompressWorker:function(){return this._data instanceof c?this._data.getContentWorker():this._data instanceof u?this._data:new o(this._data)}};for(var h=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],p=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},d=0;d<h.length;d++)n.prototype[h[d]]=p;i.exports=n},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,i,s){(function(n){var r,o,l=n.MutationObserver||n.WebKitMutationObserver;if(l){var c=0,u=new l(g),h=n.document.createTextNode("");u.observe(h,{characterData:!0}),r=function(){h.data=c=++c%2}}else if(n.setImmediate||n.MessageChannel===void 0)r="document"in n&&"onreadystatechange"in n.document.createElement("script")?function(){var m=n.document.createElement("script");m.onreadystatechange=function(){g(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},n.document.documentElement.appendChild(m)}:function(){setTimeout(g,0)};else{var p=new n.MessageChannel;p.port1.onmessage=g,r=function(){p.port2.postMessage(0)}}var d=[];function g(){var m,b;o=!0;for(var f=d.length;f;){for(b=d,d=[],m=-1;++m<f;)b[m]();f=d.length}o=!1}i.exports=function(m){d.push(m)!==1||o||r()}}).call(this,typeof Pi<"u"?Pi:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(t,i,s){var n=t("immediate");function r(){}var o={},l=["REJECTED"],c=["FULFILLED"],u=["PENDING"];function h(f){if(typeof f!="function")throw new TypeError("resolver must be a function");this.state=u,this.queue=[],this.outcome=void 0,f!==r&&m(this,f)}function p(f,y,v){this.promise=f,typeof y=="function"&&(this.onFulfilled=y,this.callFulfilled=this.otherCallFulfilled),typeof v=="function"&&(this.onRejected=v,this.callRejected=this.otherCallRejected)}function d(f,y,v){n(function(){var x;try{x=y(v)}catch(T){return o.reject(f,T)}x===f?o.reject(f,new TypeError("Cannot resolve promise with itself")):o.resolve(f,x)})}function g(f){var y=f&&f.then;if(f&&(typeof f=="object"||typeof f=="function")&&typeof y=="function")return function(){y.apply(f,arguments)}}function m(f,y){var v=!1;function x(S){v||(v=!0,o.reject(f,S))}function T(S){v||(v=!0,o.resolve(f,S))}var A=b(function(){y(T,x)});A.status==="error"&&x(A.value)}function b(f,y){var v={};try{v.value=f(y),v.status="success"}catch(x){v.status="error",v.value=x}return v}(i.exports=h).prototype.finally=function(f){if(typeof f!="function")return this;var y=this.constructor;return this.then(function(v){return y.resolve(f()).then(function(){return v})},function(v){return y.resolve(f()).then(function(){throw v})})},h.prototype.catch=function(f){return this.then(null,f)},h.prototype.then=function(f,y){if(typeof f!="function"&&this.state===c||typeof y!="function"&&this.state===l)return this;var v=new this.constructor(r);return this.state!==u?d(v,this.state===c?f:y,this.outcome):this.queue.push(new p(v,f,y)),v},p.prototype.callFulfilled=function(f){o.resolve(this.promise,f)},p.prototype.otherCallFulfilled=function(f){d(this.promise,this.onFulfilled,f)},p.prototype.callRejected=function(f){o.reject(this.promise,f)},p.prototype.otherCallRejected=function(f){d(this.promise,this.onRejected,f)},o.resolve=function(f,y){var v=b(g,y);if(v.status==="error")return o.reject(f,v.value);var x=v.value;if(x)m(f,x);else{f.state=c,f.outcome=y;for(var T=-1,A=f.queue.length;++T<A;)f.queue[T].callFulfilled(y)}return f},o.reject=function(f,y){f.state=l,f.outcome=y;for(var v=-1,x=f.queue.length;++v<x;)f.queue[v].callRejected(y);return f},h.resolve=function(f){return f instanceof this?f:o.resolve(new this(r),f)},h.reject=function(f){var y=new this(r);return o.reject(y,f)},h.all=function(f){var y=this;if(Object.prototype.toString.call(f)!=="[object Array]")return this.reject(new TypeError("must be an array"));var v=f.length,x=!1;if(!v)return this.resolve([]);for(var T=new Array(v),A=0,S=-1,M=new this(r);++S<v;)I(f[S],S);return M;function I(k,$){y.resolve(k).then(function(E){T[$]=E,++A!==v||x||(x=!0,o.resolve(M,T))},function(E){x||(x=!0,o.reject(M,E))})}},h.race=function(f){var y=this;if(Object.prototype.toString.call(f)!=="[object Array]")return this.reject(new TypeError("must be an array"));var v=f.length,x=!1;if(!v)return this.resolve([]);for(var T=-1,A=new this(r);++T<v;)S=f[T],y.resolve(S).then(function(M){x||(x=!0,o.resolve(A,M))},function(M){x||(x=!0,o.reject(A,M))});var S;return A}},{immediate:36}],38:[function(t,i,s){var n={};(0,t("./lib/utils/common").assign)(n,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),i.exports=n},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,i,s){var n=t("./zlib/deflate"),r=t("./utils/common"),o=t("./utils/strings"),l=t("./zlib/messages"),c=t("./zlib/zstream"),u=Object.prototype.toString,h=0,p=-1,d=0,g=8;function m(f){if(!(this instanceof m))return new m(f);this.options=r.assign({level:p,method:g,chunkSize:16384,windowBits:15,memLevel:8,strategy:d,to:""},f||{});var y=this.options;y.raw&&0<y.windowBits?y.windowBits=-y.windowBits:y.gzip&&0<y.windowBits&&y.windowBits<16&&(y.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new c,this.strm.avail_out=0;var v=n.deflateInit2(this.strm,y.level,y.method,y.windowBits,y.memLevel,y.strategy);if(v!==h)throw new Error(l[v]);if(y.header&&n.deflateSetHeader(this.strm,y.header),y.dictionary){var x;if(x=typeof y.dictionary=="string"?o.string2buf(y.dictionary):u.call(y.dictionary)==="[object ArrayBuffer]"?new Uint8Array(y.dictionary):y.dictionary,(v=n.deflateSetDictionary(this.strm,x))!==h)throw new Error(l[v]);this._dict_set=!0}}function b(f,y){var v=new m(y);if(v.push(f,!0),v.err)throw v.msg||l[v.err];return v.result}m.prototype.push=function(f,y){var v,x,T=this.strm,A=this.options.chunkSize;if(this.ended)return!1;x=y===~~y?y:y===!0?4:0,typeof f=="string"?T.input=o.string2buf(f):u.call(f)==="[object ArrayBuffer]"?T.input=new Uint8Array(f):T.input=f,T.next_in=0,T.avail_in=T.input.length;do{if(T.avail_out===0&&(T.output=new r.Buf8(A),T.next_out=0,T.avail_out=A),(v=n.deflate(T,x))!==1&&v!==h)return this.onEnd(v),!(this.ended=!0);T.avail_out!==0&&(T.avail_in!==0||x!==4&&x!==2)||(this.options.to==="string"?this.onData(o.buf2binstring(r.shrinkBuf(T.output,T.next_out))):this.onData(r.shrinkBuf(T.output,T.next_out)))}while((0<T.avail_in||T.avail_out===0)&&v!==1);return x===4?(v=n.deflateEnd(this.strm),this.onEnd(v),this.ended=!0,v===h):x!==2||(this.onEnd(h),!(T.avail_out=0))},m.prototype.onData=function(f){this.chunks.push(f)},m.prototype.onEnd=function(f){f===h&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=f,this.msg=this.strm.msg},s.Deflate=m,s.deflate=b,s.deflateRaw=function(f,y){return(y=y||{}).raw=!0,b(f,y)},s.gzip=function(f,y){return(y=y||{}).gzip=!0,b(f,y)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,i,s){var n=t("./zlib/inflate"),r=t("./utils/common"),o=t("./utils/strings"),l=t("./zlib/constants"),c=t("./zlib/messages"),u=t("./zlib/zstream"),h=t("./zlib/gzheader"),p=Object.prototype.toString;function d(m){if(!(this instanceof d))return new d(m);this.options=r.assign({chunkSize:16384,windowBits:0,to:""},m||{});var b=this.options;b.raw&&0<=b.windowBits&&b.windowBits<16&&(b.windowBits=-b.windowBits,b.windowBits===0&&(b.windowBits=-15)),!(0<=b.windowBits&&b.windowBits<16)||m&&m.windowBits||(b.windowBits+=32),15<b.windowBits&&b.windowBits<48&&!(15&b.windowBits)&&(b.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u,this.strm.avail_out=0;var f=n.inflateInit2(this.strm,b.windowBits);if(f!==l.Z_OK)throw new Error(c[f]);this.header=new h,n.inflateGetHeader(this.strm,this.header)}function g(m,b){var f=new d(b);if(f.push(m,!0),f.err)throw f.msg||c[f.err];return f.result}d.prototype.push=function(m,b){var f,y,v,x,T,A,S=this.strm,M=this.options.chunkSize,I=this.options.dictionary,k=!1;if(this.ended)return!1;y=b===~~b?b:b===!0?l.Z_FINISH:l.Z_NO_FLUSH,typeof m=="string"?S.input=o.binstring2buf(m):p.call(m)==="[object ArrayBuffer]"?S.input=new Uint8Array(m):S.input=m,S.next_in=0,S.avail_in=S.input.length;do{if(S.avail_out===0&&(S.output=new r.Buf8(M),S.next_out=0,S.avail_out=M),(f=n.inflate(S,l.Z_NO_FLUSH))===l.Z_NEED_DICT&&I&&(A=typeof I=="string"?o.string2buf(I):p.call(I)==="[object ArrayBuffer]"?new Uint8Array(I):I,f=n.inflateSetDictionary(this.strm,A)),f===l.Z_BUF_ERROR&&k===!0&&(f=l.Z_OK,k=!1),f!==l.Z_STREAM_END&&f!==l.Z_OK)return this.onEnd(f),!(this.ended=!0);S.next_out&&(S.avail_out!==0&&f!==l.Z_STREAM_END&&(S.avail_in!==0||y!==l.Z_FINISH&&y!==l.Z_SYNC_FLUSH)||(this.options.to==="string"?(v=o.utf8border(S.output,S.next_out),x=S.next_out-v,T=o.buf2string(S.output,v),S.next_out=x,S.avail_out=M-x,x&&r.arraySet(S.output,S.output,v,x,0),this.onData(T)):this.onData(r.shrinkBuf(S.output,S.next_out)))),S.avail_in===0&&S.avail_out===0&&(k=!0)}while((0<S.avail_in||S.avail_out===0)&&f!==l.Z_STREAM_END);return f===l.Z_STREAM_END&&(y=l.Z_FINISH),y===l.Z_FINISH?(f=n.inflateEnd(this.strm),this.onEnd(f),this.ended=!0,f===l.Z_OK):y!==l.Z_SYNC_FLUSH||(this.onEnd(l.Z_OK),!(S.avail_out=0))},d.prototype.onData=function(m){this.chunks.push(m)},d.prototype.onEnd=function(m){m===l.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},s.Inflate=d,s.inflate=g,s.inflateRaw=function(m,b){return(b=b||{}).raw=!0,g(m,b)},s.ungzip=g},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,i,s){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";s.assign=function(l){for(var c=Array.prototype.slice.call(arguments,1);c.length;){var u=c.shift();if(u){if(typeof u!="object")throw new TypeError(u+"must be non-object");for(var h in u)u.hasOwnProperty(h)&&(l[h]=u[h])}}return l},s.shrinkBuf=function(l,c){return l.length===c?l:l.subarray?l.subarray(0,c):(l.length=c,l)};var r={arraySet:function(l,c,u,h,p){if(c.subarray&&l.subarray)l.set(c.subarray(u,u+h),p);else for(var d=0;d<h;d++)l[p+d]=c[u+d]},flattenChunks:function(l){var c,u,h,p,d,g;for(c=h=0,u=l.length;c<u;c++)h+=l[c].length;for(g=new Uint8Array(h),c=p=0,u=l.length;c<u;c++)d=l[c],g.set(d,p),p+=d.length;return g}},o={arraySet:function(l,c,u,h,p){for(var d=0;d<h;d++)l[p+d]=c[u+d]},flattenChunks:function(l){return[].concat.apply([],l)}};s.setTyped=function(l){l?(s.Buf8=Uint8Array,s.Buf16=Uint16Array,s.Buf32=Int32Array,s.assign(s,r)):(s.Buf8=Array,s.Buf16=Array,s.Buf32=Array,s.assign(s,o))},s.setTyped(n)},{}],42:[function(t,i,s){var n=t("./common"),r=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch{r=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{o=!1}for(var l=new n.Buf8(256),c=0;c<256;c++)l[c]=252<=c?6:248<=c?5:240<=c?4:224<=c?3:192<=c?2:1;function u(h,p){if(p<65537&&(h.subarray&&o||!h.subarray&&r))return String.fromCharCode.apply(null,n.shrinkBuf(h,p));for(var d="",g=0;g<p;g++)d+=String.fromCharCode(h[g]);return d}l[254]=l[254]=1,s.string2buf=function(h){var p,d,g,m,b,f=h.length,y=0;for(m=0;m<f;m++)(64512&(d=h.charCodeAt(m)))==55296&&m+1<f&&(64512&(g=h.charCodeAt(m+1)))==56320&&(d=65536+(d-55296<<10)+(g-56320),m++),y+=d<128?1:d<2048?2:d<65536?3:4;for(p=new n.Buf8(y),m=b=0;b<y;m++)(64512&(d=h.charCodeAt(m)))==55296&&m+1<f&&(64512&(g=h.charCodeAt(m+1)))==56320&&(d=65536+(d-55296<<10)+(g-56320),m++),d<128?p[b++]=d:(d<2048?p[b++]=192|d>>>6:(d<65536?p[b++]=224|d>>>12:(p[b++]=240|d>>>18,p[b++]=128|d>>>12&63),p[b++]=128|d>>>6&63),p[b++]=128|63&d);return p},s.buf2binstring=function(h){return u(h,h.length)},s.binstring2buf=function(h){for(var p=new n.Buf8(h.length),d=0,g=p.length;d<g;d++)p[d]=h.charCodeAt(d);return p},s.buf2string=function(h,p){var d,g,m,b,f=p||h.length,y=new Array(2*f);for(d=g=0;d<f;)if((m=h[d++])<128)y[g++]=m;else if(4<(b=l[m]))y[g++]=65533,d+=b-1;else{for(m&=b===2?31:b===3?15:7;1<b&&d<f;)m=m<<6|63&h[d++],b--;1<b?y[g++]=65533:m<65536?y[g++]=m:(m-=65536,y[g++]=55296|m>>10&1023,y[g++]=56320|1023&m)}return u(y,g)},s.utf8border=function(h,p){var d;for((p=p||h.length)>h.length&&(p=h.length),d=p-1;0<=d&&(192&h[d])==128;)d--;return d<0||d===0?p:d+l[h[d]]>p?d:p}},{"./common":41}],43:[function(t,i,s){i.exports=function(n,r,o,l){for(var c=65535&n|0,u=n>>>16&65535|0,h=0;o!==0;){for(o-=h=2e3<o?2e3:o;u=u+(c=c+r[l++]|0)|0,--h;);c%=65521,u%=65521}return c|u<<16|0}},{}],44:[function(t,i,s){i.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,i,s){var n=function(){for(var r,o=[],l=0;l<256;l++){r=l;for(var c=0;c<8;c++)r=1&r?3988292384^r>>>1:r>>>1;o[l]=r}return o}();i.exports=function(r,o,l,c){var u=n,h=c+l;r^=-1;for(var p=c;p<h;p++)r=r>>>8^u[255&(r^o[p])];return-1^r}},{}],46:[function(t,i,s){var n,r=t("../utils/common"),o=t("./trees"),l=t("./adler32"),c=t("./crc32"),u=t("./messages"),h=0,p=4,d=0,g=-2,m=-1,b=4,f=2,y=8,v=9,x=286,T=30,A=19,S=2*x+1,M=15,I=3,k=258,$=k+I+1,E=42,z=113,_=1,L=2,W=3,V=4;function st(w,Y){return w.msg=u[Y],Y}function H(w){return(w<<1)-(4<w?9:0)}function et(w){for(var Y=w.length;0<=--Y;)w[Y]=0}function D(w){var Y=w.state,F=Y.pending;F>w.avail_out&&(F=w.avail_out),F!==0&&(r.arraySet(w.output,Y.pending_buf,Y.pending_out,F,w.next_out),w.next_out+=F,Y.pending_out+=F,w.total_out+=F,w.avail_out-=F,Y.pending-=F,Y.pending===0&&(Y.pending_out=0))}function B(w,Y){o._tr_flush_block(w,0<=w.block_start?w.block_start:-1,w.strstart-w.block_start,Y),w.block_start=w.strstart,D(w.strm)}function J(w,Y){w.pending_buf[w.pending++]=Y}function K(w,Y){w.pending_buf[w.pending++]=Y>>>8&255,w.pending_buf[w.pending++]=255&Y}function q(w,Y){var F,P,O=w.max_chain_length,N=w.strstart,j=w.prev_length,X=w.nice_match,R=w.strstart>w.w_size-$?w.strstart-(w.w_size-$):0,G=w.window,tt=w.w_mask,Q=w.prev,nt=w.strstart+k,_t=G[N+j-1],ht=G[N+j];w.prev_length>=w.good_match&&(O>>=2),X>w.lookahead&&(X=w.lookahead);do if(G[(F=Y)+j]===ht&&G[F+j-1]===_t&&G[F]===G[N]&&G[++F]===G[N+1]){N+=2,F++;do;while(G[++N]===G[++F]&&G[++N]===G[++F]&&G[++N]===G[++F]&&G[++N]===G[++F]&&G[++N]===G[++F]&&G[++N]===G[++F]&&G[++N]===G[++F]&&G[++N]===G[++F]&&N<nt);if(P=k-(nt-N),N=nt-k,j<P){if(w.match_start=Y,X<=(j=P))break;_t=G[N+j-1],ht=G[N+j]}}while((Y=Q[Y&tt])>R&&--O!=0);return j<=w.lookahead?j:w.lookahead}function ut(w){var Y,F,P,O,N,j,X,R,G,tt,Q=w.w_size;do{if(O=w.window_size-w.lookahead-w.strstart,w.strstart>=Q+(Q-$)){for(r.arraySet(w.window,w.window,Q,Q,0),w.match_start-=Q,w.strstart-=Q,w.block_start-=Q,Y=F=w.hash_size;P=w.head[--Y],w.head[Y]=Q<=P?P-Q:0,--F;);for(Y=F=Q;P=w.prev[--Y],w.prev[Y]=Q<=P?P-Q:0,--F;);O+=Q}if(w.strm.avail_in===0)break;if(j=w.strm,X=w.window,R=w.strstart+w.lookahead,G=O,tt=void 0,tt=j.avail_in,G<tt&&(tt=G),F=tt===0?0:(j.avail_in-=tt,r.arraySet(X,j.input,j.next_in,tt,R),j.state.wrap===1?j.adler=l(j.adler,X,tt,R):j.state.wrap===2&&(j.adler=c(j.adler,X,tt,R)),j.next_in+=tt,j.total_in+=tt,tt),w.lookahead+=F,w.lookahead+w.insert>=I)for(N=w.strstart-w.insert,w.ins_h=w.window[N],w.ins_h=(w.ins_h<<w.hash_shift^w.window[N+1])&w.hash_mask;w.insert&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[N+I-1])&w.hash_mask,w.prev[N&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=N,N++,w.insert--,!(w.lookahead+w.insert<I)););}while(w.lookahead<$&&w.strm.avail_in!==0)}function Ct(w,Y){for(var F,P;;){if(w.lookahead<$){if(ut(w),w.lookahead<$&&Y===h)return _;if(w.lookahead===0)break}if(F=0,w.lookahead>=I&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+I-1])&w.hash_mask,F=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),F!==0&&w.strstart-F<=w.w_size-$&&(w.match_length=q(w,F)),w.match_length>=I)if(P=o._tr_tally(w,w.strstart-w.match_start,w.match_length-I),w.lookahead-=w.match_length,w.match_length<=w.max_lazy_match&&w.lookahead>=I){for(w.match_length--;w.strstart++,w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+I-1])&w.hash_mask,F=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart,--w.match_length!=0;);w.strstart++}else w.strstart+=w.match_length,w.match_length=0,w.ins_h=w.window[w.strstart],w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+1])&w.hash_mask;else P=o._tr_tally(w,0,w.window[w.strstart]),w.lookahead--,w.strstart++;if(P&&(B(w,!1),w.strm.avail_out===0))return _}return w.insert=w.strstart<I-1?w.strstart:I-1,Y===p?(B(w,!0),w.strm.avail_out===0?W:V):w.last_lit&&(B(w,!1),w.strm.avail_out===0)?_:L}function lt(w,Y){for(var F,P,O;;){if(w.lookahead<$){if(ut(w),w.lookahead<$&&Y===h)return _;if(w.lookahead===0)break}if(F=0,w.lookahead>=I&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+I-1])&w.hash_mask,F=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),w.prev_length=w.match_length,w.prev_match=w.match_start,w.match_length=I-1,F!==0&&w.prev_length<w.max_lazy_match&&w.strstart-F<=w.w_size-$&&(w.match_length=q(w,F),w.match_length<=5&&(w.strategy===1||w.match_length===I&&4096<w.strstart-w.match_start)&&(w.match_length=I-1)),w.prev_length>=I&&w.match_length<=w.prev_length){for(O=w.strstart+w.lookahead-I,P=o._tr_tally(w,w.strstart-1-w.prev_match,w.prev_length-I),w.lookahead-=w.prev_length-1,w.prev_length-=2;++w.strstart<=O&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+I-1])&w.hash_mask,F=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),--w.prev_length!=0;);if(w.match_available=0,w.match_length=I-1,w.strstart++,P&&(B(w,!1),w.strm.avail_out===0))return _}else if(w.match_available){if((P=o._tr_tally(w,0,w.window[w.strstart-1]))&&B(w,!1),w.strstart++,w.lookahead--,w.strm.avail_out===0)return _}else w.match_available=1,w.strstart++,w.lookahead--}return w.match_available&&(P=o._tr_tally(w,0,w.window[w.strstart-1]),w.match_available=0),w.insert=w.strstart<I-1?w.strstart:I-1,Y===p?(B(w,!0),w.strm.avail_out===0?W:V):w.last_lit&&(B(w,!1),w.strm.avail_out===0)?_:L}function ct(w,Y,F,P,O){this.good_length=w,this.max_lazy=Y,this.nice_length=F,this.max_chain=P,this.func=O}function wt(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=y,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new r.Buf16(2*S),this.dyn_dtree=new r.Buf16(2*(2*T+1)),this.bl_tree=new r.Buf16(2*(2*A+1)),et(this.dyn_ltree),et(this.dyn_dtree),et(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new r.Buf16(M+1),this.heap=new r.Buf16(2*x+1),et(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new r.Buf16(2*x+1),et(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function mt(w){var Y;return w&&w.state?(w.total_in=w.total_out=0,w.data_type=f,(Y=w.state).pending=0,Y.pending_out=0,Y.wrap<0&&(Y.wrap=-Y.wrap),Y.status=Y.wrap?E:z,w.adler=Y.wrap===2?0:1,Y.last_flush=h,o._tr_init(Y),d):st(w,g)}function Mt(w){var Y=mt(w);return Y===d&&function(F){F.window_size=2*F.w_size,et(F.head),F.max_lazy_match=n[F.level].max_lazy,F.good_match=n[F.level].good_length,F.nice_match=n[F.level].nice_length,F.max_chain_length=n[F.level].max_chain,F.strstart=0,F.block_start=0,F.lookahead=0,F.insert=0,F.match_length=F.prev_length=I-1,F.match_available=0,F.ins_h=0}(w.state),Y}function kt(w,Y,F,P,O,N){if(!w)return g;var j=1;if(Y===m&&(Y=6),P<0?(j=0,P=-P):15<P&&(j=2,P-=16),O<1||v<O||F!==y||P<8||15<P||Y<0||9<Y||N<0||b<N)return st(w,g);P===8&&(P=9);var X=new wt;return(w.state=X).strm=w,X.wrap=j,X.gzhead=null,X.w_bits=P,X.w_size=1<<X.w_bits,X.w_mask=X.w_size-1,X.hash_bits=O+7,X.hash_size=1<<X.hash_bits,X.hash_mask=X.hash_size-1,X.hash_shift=~~((X.hash_bits+I-1)/I),X.window=new r.Buf8(2*X.w_size),X.head=new r.Buf16(X.hash_size),X.prev=new r.Buf16(X.w_size),X.lit_bufsize=1<<O+6,X.pending_buf_size=4*X.lit_bufsize,X.pending_buf=new r.Buf8(X.pending_buf_size),X.d_buf=1*X.lit_bufsize,X.l_buf=3*X.lit_bufsize,X.level=Y,X.strategy=N,X.method=F,Mt(w)}n=[new ct(0,0,0,0,function(w,Y){var F=65535;for(F>w.pending_buf_size-5&&(F=w.pending_buf_size-5);;){if(w.lookahead<=1){if(ut(w),w.lookahead===0&&Y===h)return _;if(w.lookahead===0)break}w.strstart+=w.lookahead,w.lookahead=0;var P=w.block_start+F;if((w.strstart===0||w.strstart>=P)&&(w.lookahead=w.strstart-P,w.strstart=P,B(w,!1),w.strm.avail_out===0)||w.strstart-w.block_start>=w.w_size-$&&(B(w,!1),w.strm.avail_out===0))return _}return w.insert=0,Y===p?(B(w,!0),w.strm.avail_out===0?W:V):(w.strstart>w.block_start&&(B(w,!1),w.strm.avail_out),_)}),new ct(4,4,8,4,Ct),new ct(4,5,16,8,Ct),new ct(4,6,32,32,Ct),new ct(4,4,16,16,lt),new ct(8,16,32,32,lt),new ct(8,16,128,128,lt),new ct(8,32,128,256,lt),new ct(32,128,258,1024,lt),new ct(32,258,258,4096,lt)],s.deflateInit=function(w,Y){return kt(w,Y,y,15,8,0)},s.deflateInit2=kt,s.deflateReset=Mt,s.deflateResetKeep=mt,s.deflateSetHeader=function(w,Y){return w&&w.state?w.state.wrap!==2?g:(w.state.gzhead=Y,d):g},s.deflate=function(w,Y){var F,P,O,N;if(!w||!w.state||5<Y||Y<0)return w?st(w,g):g;if(P=w.state,!w.output||!w.input&&w.avail_in!==0||P.status===666&&Y!==p)return st(w,w.avail_out===0?-5:g);if(P.strm=w,F=P.last_flush,P.last_flush=Y,P.status===E)if(P.wrap===2)w.adler=0,J(P,31),J(P,139),J(P,8),P.gzhead?(J(P,(P.gzhead.text?1:0)+(P.gzhead.hcrc?2:0)+(P.gzhead.extra?4:0)+(P.gzhead.name?8:0)+(P.gzhead.comment?16:0)),J(P,255&P.gzhead.time),J(P,P.gzhead.time>>8&255),J(P,P.gzhead.time>>16&255),J(P,P.gzhead.time>>24&255),J(P,P.level===9?2:2<=P.strategy||P.level<2?4:0),J(P,255&P.gzhead.os),P.gzhead.extra&&P.gzhead.extra.length&&(J(P,255&P.gzhead.extra.length),J(P,P.gzhead.extra.length>>8&255)),P.gzhead.hcrc&&(w.adler=c(w.adler,P.pending_buf,P.pending,0)),P.gzindex=0,P.status=69):(J(P,0),J(P,0),J(P,0),J(P,0),J(P,0),J(P,P.level===9?2:2<=P.strategy||P.level<2?4:0),J(P,3),P.status=z);else{var j=y+(P.w_bits-8<<4)<<8;j|=(2<=P.strategy||P.level<2?0:P.level<6?1:P.level===6?2:3)<<6,P.strstart!==0&&(j|=32),j+=31-j%31,P.status=z,K(P,j),P.strstart!==0&&(K(P,w.adler>>>16),K(P,65535&w.adler)),w.adler=1}if(P.status===69)if(P.gzhead.extra){for(O=P.pending;P.gzindex<(65535&P.gzhead.extra.length)&&(P.pending!==P.pending_buf_size||(P.gzhead.hcrc&&P.pending>O&&(w.adler=c(w.adler,P.pending_buf,P.pending-O,O)),D(w),O=P.pending,P.pending!==P.pending_buf_size));)J(P,255&P.gzhead.extra[P.gzindex]),P.gzindex++;P.gzhead.hcrc&&P.pending>O&&(w.adler=c(w.adler,P.pending_buf,P.pending-O,O)),P.gzindex===P.gzhead.extra.length&&(P.gzindex=0,P.status=73)}else P.status=73;if(P.status===73)if(P.gzhead.name){O=P.pending;do{if(P.pending===P.pending_buf_size&&(P.gzhead.hcrc&&P.pending>O&&(w.adler=c(w.adler,P.pending_buf,P.pending-O,O)),D(w),O=P.pending,P.pending===P.pending_buf_size)){N=1;break}N=P.gzindex<P.gzhead.name.length?255&P.gzhead.name.charCodeAt(P.gzindex++):0,J(P,N)}while(N!==0);P.gzhead.hcrc&&P.pending>O&&(w.adler=c(w.adler,P.pending_buf,P.pending-O,O)),N===0&&(P.gzindex=0,P.status=91)}else P.status=91;if(P.status===91)if(P.gzhead.comment){O=P.pending;do{if(P.pending===P.pending_buf_size&&(P.gzhead.hcrc&&P.pending>O&&(w.adler=c(w.adler,P.pending_buf,P.pending-O,O)),D(w),O=P.pending,P.pending===P.pending_buf_size)){N=1;break}N=P.gzindex<P.gzhead.comment.length?255&P.gzhead.comment.charCodeAt(P.gzindex++):0,J(P,N)}while(N!==0);P.gzhead.hcrc&&P.pending>O&&(w.adler=c(w.adler,P.pending_buf,P.pending-O,O)),N===0&&(P.status=103)}else P.status=103;if(P.status===103&&(P.gzhead.hcrc?(P.pending+2>P.pending_buf_size&&D(w),P.pending+2<=P.pending_buf_size&&(J(P,255&w.adler),J(P,w.adler>>8&255),w.adler=0,P.status=z)):P.status=z),P.pending!==0){if(D(w),w.avail_out===0)return P.last_flush=-1,d}else if(w.avail_in===0&&H(Y)<=H(F)&&Y!==p)return st(w,-5);if(P.status===666&&w.avail_in!==0)return st(w,-5);if(w.avail_in!==0||P.lookahead!==0||Y!==h&&P.status!==666){var X=P.strategy===2?function(R,G){for(var tt;;){if(R.lookahead===0&&(ut(R),R.lookahead===0)){if(G===h)return _;break}if(R.match_length=0,tt=o._tr_tally(R,0,R.window[R.strstart]),R.lookahead--,R.strstart++,tt&&(B(R,!1),R.strm.avail_out===0))return _}return R.insert=0,G===p?(B(R,!0),R.strm.avail_out===0?W:V):R.last_lit&&(B(R,!1),R.strm.avail_out===0)?_:L}(P,Y):P.strategy===3?function(R,G){for(var tt,Q,nt,_t,ht=R.window;;){if(R.lookahead<=k){if(ut(R),R.lookahead<=k&&G===h)return _;if(R.lookahead===0)break}if(R.match_length=0,R.lookahead>=I&&0<R.strstart&&(Q=ht[nt=R.strstart-1])===ht[++nt]&&Q===ht[++nt]&&Q===ht[++nt]){_t=R.strstart+k;do;while(Q===ht[++nt]&&Q===ht[++nt]&&Q===ht[++nt]&&Q===ht[++nt]&&Q===ht[++nt]&&Q===ht[++nt]&&Q===ht[++nt]&&Q===ht[++nt]&&nt<_t);R.match_length=k-(_t-nt),R.match_length>R.lookahead&&(R.match_length=R.lookahead)}if(R.match_length>=I?(tt=o._tr_tally(R,1,R.match_length-I),R.lookahead-=R.match_length,R.strstart+=R.match_length,R.match_length=0):(tt=o._tr_tally(R,0,R.window[R.strstart]),R.lookahead--,R.strstart++),tt&&(B(R,!1),R.strm.avail_out===0))return _}return R.insert=0,G===p?(B(R,!0),R.strm.avail_out===0?W:V):R.last_lit&&(B(R,!1),R.strm.avail_out===0)?_:L}(P,Y):n[P.level].func(P,Y);if(X!==W&&X!==V||(P.status=666),X===_||X===W)return w.avail_out===0&&(P.last_flush=-1),d;if(X===L&&(Y===1?o._tr_align(P):Y!==5&&(o._tr_stored_block(P,0,0,!1),Y===3&&(et(P.head),P.lookahead===0&&(P.strstart=0,P.block_start=0,P.insert=0))),D(w),w.avail_out===0))return P.last_flush=-1,d}return Y!==p?d:P.wrap<=0?1:(P.wrap===2?(J(P,255&w.adler),J(P,w.adler>>8&255),J(P,w.adler>>16&255),J(P,w.adler>>24&255),J(P,255&w.total_in),J(P,w.total_in>>8&255),J(P,w.total_in>>16&255),J(P,w.total_in>>24&255)):(K(P,w.adler>>>16),K(P,65535&w.adler)),D(w),0<P.wrap&&(P.wrap=-P.wrap),P.pending!==0?d:1)},s.deflateEnd=function(w){var Y;return w&&w.state?(Y=w.state.status)!==E&&Y!==69&&Y!==73&&Y!==91&&Y!==103&&Y!==z&&Y!==666?st(w,g):(w.state=null,Y===z?st(w,-3):d):g},s.deflateSetDictionary=function(w,Y){var F,P,O,N,j,X,R,G,tt=Y.length;if(!w||!w.state||(N=(F=w.state).wrap)===2||N===1&&F.status!==E||F.lookahead)return g;for(N===1&&(w.adler=l(w.adler,Y,tt,0)),F.wrap=0,tt>=F.w_size&&(N===0&&(et(F.head),F.strstart=0,F.block_start=0,F.insert=0),G=new r.Buf8(F.w_size),r.arraySet(G,Y,tt-F.w_size,F.w_size,0),Y=G,tt=F.w_size),j=w.avail_in,X=w.next_in,R=w.input,w.avail_in=tt,w.next_in=0,w.input=Y,ut(F);F.lookahead>=I;){for(P=F.strstart,O=F.lookahead-(I-1);F.ins_h=(F.ins_h<<F.hash_shift^F.window[P+I-1])&F.hash_mask,F.prev[P&F.w_mask]=F.head[F.ins_h],F.head[F.ins_h]=P,P++,--O;);F.strstart=P,F.lookahead=I-1,ut(F)}return F.strstart+=F.lookahead,F.block_start=F.strstart,F.insert=F.lookahead,F.lookahead=0,F.match_length=F.prev_length=I-1,F.match_available=0,w.next_in=X,w.input=R,w.avail_in=j,F.wrap=N,d},s.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,i,s){i.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,i,s){i.exports=function(n,r){var o,l,c,u,h,p,d,g,m,b,f,y,v,x,T,A,S,M,I,k,$,E,z,_,L;o=n.state,l=n.next_in,_=n.input,c=l+(n.avail_in-5),u=n.next_out,L=n.output,h=u-(r-n.avail_out),p=u+(n.avail_out-257),d=o.dmax,g=o.wsize,m=o.whave,b=o.wnext,f=o.window,y=o.hold,v=o.bits,x=o.lencode,T=o.distcode,A=(1<<o.lenbits)-1,S=(1<<o.distbits)-1;t:do{v<15&&(y+=_[l++]<<v,v+=8,y+=_[l++]<<v,v+=8),M=x[y&A];e:for(;;){if(y>>>=I=M>>>24,v-=I,(I=M>>>16&255)===0)L[u++]=65535&M;else{if(!(16&I)){if(!(64&I)){M=x[(65535&M)+(y&(1<<I)-1)];continue e}if(32&I){o.mode=12;break t}n.msg="invalid literal/length code",o.mode=30;break t}k=65535&M,(I&=15)&&(v<I&&(y+=_[l++]<<v,v+=8),k+=y&(1<<I)-1,y>>>=I,v-=I),v<15&&(y+=_[l++]<<v,v+=8,y+=_[l++]<<v,v+=8),M=T[y&S];i:for(;;){if(y>>>=I=M>>>24,v-=I,!(16&(I=M>>>16&255))){if(!(64&I)){M=T[(65535&M)+(y&(1<<I)-1)];continue i}n.msg="invalid distance code",o.mode=30;break t}if($=65535&M,v<(I&=15)&&(y+=_[l++]<<v,(v+=8)<I&&(y+=_[l++]<<v,v+=8)),d<($+=y&(1<<I)-1)){n.msg="invalid distance too far back",o.mode=30;break t}if(y>>>=I,v-=I,(I=u-h)<$){if(m<(I=$-I)&&o.sane){n.msg="invalid distance too far back",o.mode=30;break t}if(z=f,(E=0)===b){if(E+=g-I,I<k){for(k-=I;L[u++]=f[E++],--I;);E=u-$,z=L}}else if(b<I){if(E+=g+b-I,(I-=b)<k){for(k-=I;L[u++]=f[E++],--I;);if(E=0,b<k){for(k-=I=b;L[u++]=f[E++],--I;);E=u-$,z=L}}}else if(E+=b-I,I<k){for(k-=I;L[u++]=f[E++],--I;);E=u-$,z=L}for(;2<k;)L[u++]=z[E++],L[u++]=z[E++],L[u++]=z[E++],k-=3;k&&(L[u++]=z[E++],1<k&&(L[u++]=z[E++]))}else{for(E=u-$;L[u++]=L[E++],L[u++]=L[E++],L[u++]=L[E++],2<(k-=3););k&&(L[u++]=L[E++],1<k&&(L[u++]=L[E++]))}break}}break}}while(l<c&&u<p);l-=k=v>>3,y&=(1<<(v-=k<<3))-1,n.next_in=l,n.next_out=u,n.avail_in=l<c?c-l+5:5-(l-c),n.avail_out=u<p?p-u+257:257-(u-p),o.hold=y,o.bits=v}},{}],49:[function(t,i,s){var n=t("../utils/common"),r=t("./adler32"),o=t("./crc32"),l=t("./inffast"),c=t("./inftrees"),u=1,h=2,p=0,d=-2,g=1,m=852,b=592;function f(E){return(E>>>24&255)+(E>>>8&65280)+((65280&E)<<8)+((255&E)<<24)}function y(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function v(E){var z;return E&&E.state?(z=E.state,E.total_in=E.total_out=z.total=0,E.msg="",z.wrap&&(E.adler=1&z.wrap),z.mode=g,z.last=0,z.havedict=0,z.dmax=32768,z.head=null,z.hold=0,z.bits=0,z.lencode=z.lendyn=new n.Buf32(m),z.distcode=z.distdyn=new n.Buf32(b),z.sane=1,z.back=-1,p):d}function x(E){var z;return E&&E.state?((z=E.state).wsize=0,z.whave=0,z.wnext=0,v(E)):d}function T(E,z){var _,L;return E&&E.state?(L=E.state,z<0?(_=0,z=-z):(_=1+(z>>4),z<48&&(z&=15)),z&&(z<8||15<z)?d:(L.window!==null&&L.wbits!==z&&(L.window=null),L.wrap=_,L.wbits=z,x(E))):d}function A(E,z){var _,L;return E?(L=new y,(E.state=L).window=null,(_=T(E,z))!==p&&(E.state=null),_):d}var S,M,I=!0;function k(E){if(I){var z;for(S=new n.Buf32(512),M=new n.Buf32(32),z=0;z<144;)E.lens[z++]=8;for(;z<256;)E.lens[z++]=9;for(;z<280;)E.lens[z++]=7;for(;z<288;)E.lens[z++]=8;for(c(u,E.lens,0,288,S,0,E.work,{bits:9}),z=0;z<32;)E.lens[z++]=5;c(h,E.lens,0,32,M,0,E.work,{bits:5}),I=!1}E.lencode=S,E.lenbits=9,E.distcode=M,E.distbits=5}function $(E,z,_,L){var W,V=E.state;return V.window===null&&(V.wsize=1<<V.wbits,V.wnext=0,V.whave=0,V.window=new n.Buf8(V.wsize)),L>=V.wsize?(n.arraySet(V.window,z,_-V.wsize,V.wsize,0),V.wnext=0,V.whave=V.wsize):(L<(W=V.wsize-V.wnext)&&(W=L),n.arraySet(V.window,z,_-L,W,V.wnext),(L-=W)?(n.arraySet(V.window,z,_-L,L,0),V.wnext=L,V.whave=V.wsize):(V.wnext+=W,V.wnext===V.wsize&&(V.wnext=0),V.whave<V.wsize&&(V.whave+=W))),0}s.inflateReset=x,s.inflateReset2=T,s.inflateResetKeep=v,s.inflateInit=function(E){return A(E,15)},s.inflateInit2=A,s.inflate=function(E,z){var _,L,W,V,st,H,et,D,B,J,K,q,ut,Ct,lt,ct,wt,mt,Mt,kt,w,Y,F,P,O=0,N=new n.Buf8(4),j=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!E||!E.state||!E.output||!E.input&&E.avail_in!==0)return d;(_=E.state).mode===12&&(_.mode=13),st=E.next_out,W=E.output,et=E.avail_out,V=E.next_in,L=E.input,H=E.avail_in,D=_.hold,B=_.bits,J=H,K=et,Y=p;t:for(;;)switch(_.mode){case g:if(_.wrap===0){_.mode=13;break}for(;B<16;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}if(2&_.wrap&&D===35615){N[_.check=0]=255&D,N[1]=D>>>8&255,_.check=o(_.check,N,2,0),B=D=0,_.mode=2;break}if(_.flags=0,_.head&&(_.head.done=!1),!(1&_.wrap)||(((255&D)<<8)+(D>>8))%31){E.msg="incorrect header check",_.mode=30;break}if((15&D)!=8){E.msg="unknown compression method",_.mode=30;break}if(B-=4,w=8+(15&(D>>>=4)),_.wbits===0)_.wbits=w;else if(w>_.wbits){E.msg="invalid window size",_.mode=30;break}_.dmax=1<<w,E.adler=_.check=1,_.mode=512&D?10:12,B=D=0;break;case 2:for(;B<16;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}if(_.flags=D,(255&_.flags)!=8){E.msg="unknown compression method",_.mode=30;break}if(57344&_.flags){E.msg="unknown header flags set",_.mode=30;break}_.head&&(_.head.text=D>>8&1),512&_.flags&&(N[0]=255&D,N[1]=D>>>8&255,_.check=o(_.check,N,2,0)),B=D=0,_.mode=3;case 3:for(;B<32;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}_.head&&(_.head.time=D),512&_.flags&&(N[0]=255&D,N[1]=D>>>8&255,N[2]=D>>>16&255,N[3]=D>>>24&255,_.check=o(_.check,N,4,0)),B=D=0,_.mode=4;case 4:for(;B<16;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}_.head&&(_.head.xflags=255&D,_.head.os=D>>8),512&_.flags&&(N[0]=255&D,N[1]=D>>>8&255,_.check=o(_.check,N,2,0)),B=D=0,_.mode=5;case 5:if(1024&_.flags){for(;B<16;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}_.length=D,_.head&&(_.head.extra_len=D),512&_.flags&&(N[0]=255&D,N[1]=D>>>8&255,_.check=o(_.check,N,2,0)),B=D=0}else _.head&&(_.head.extra=null);_.mode=6;case 6:if(1024&_.flags&&(H<(q=_.length)&&(q=H),q&&(_.head&&(w=_.head.extra_len-_.length,_.head.extra||(_.head.extra=new Array(_.head.extra_len)),n.arraySet(_.head.extra,L,V,q,w)),512&_.flags&&(_.check=o(_.check,L,q,V)),H-=q,V+=q,_.length-=q),_.length))break t;_.length=0,_.mode=7;case 7:if(2048&_.flags){if(H===0)break t;for(q=0;w=L[V+q++],_.head&&w&&_.length<65536&&(_.head.name+=String.fromCharCode(w)),w&&q<H;);if(512&_.flags&&(_.check=o(_.check,L,q,V)),H-=q,V+=q,w)break t}else _.head&&(_.head.name=null);_.length=0,_.mode=8;case 8:if(4096&_.flags){if(H===0)break t;for(q=0;w=L[V+q++],_.head&&w&&_.length<65536&&(_.head.comment+=String.fromCharCode(w)),w&&q<H;);if(512&_.flags&&(_.check=o(_.check,L,q,V)),H-=q,V+=q,w)break t}else _.head&&(_.head.comment=null);_.mode=9;case 9:if(512&_.flags){for(;B<16;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}if(D!==(65535&_.check)){E.msg="header crc mismatch",_.mode=30;break}B=D=0}_.head&&(_.head.hcrc=_.flags>>9&1,_.head.done=!0),E.adler=_.check=0,_.mode=12;break;case 10:for(;B<32;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}E.adler=_.check=f(D),B=D=0,_.mode=11;case 11:if(_.havedict===0)return E.next_out=st,E.avail_out=et,E.next_in=V,E.avail_in=H,_.hold=D,_.bits=B,2;E.adler=_.check=1,_.mode=12;case 12:if(z===5||z===6)break t;case 13:if(_.last){D>>>=7&B,B-=7&B,_.mode=27;break}for(;B<3;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}switch(_.last=1&D,B-=1,3&(D>>>=1)){case 0:_.mode=14;break;case 1:if(k(_),_.mode=20,z!==6)break;D>>>=2,B-=2;break t;case 2:_.mode=17;break;case 3:E.msg="invalid block type",_.mode=30}D>>>=2,B-=2;break;case 14:for(D>>>=7&B,B-=7&B;B<32;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}if((65535&D)!=(D>>>16^65535)){E.msg="invalid stored block lengths",_.mode=30;break}if(_.length=65535&D,B=D=0,_.mode=15,z===6)break t;case 15:_.mode=16;case 16:if(q=_.length){if(H<q&&(q=H),et<q&&(q=et),q===0)break t;n.arraySet(W,L,V,q,st),H-=q,V+=q,et-=q,st+=q,_.length-=q;break}_.mode=12;break;case 17:for(;B<14;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}if(_.nlen=257+(31&D),D>>>=5,B-=5,_.ndist=1+(31&D),D>>>=5,B-=5,_.ncode=4+(15&D),D>>>=4,B-=4,286<_.nlen||30<_.ndist){E.msg="too many length or distance symbols",_.mode=30;break}_.have=0,_.mode=18;case 18:for(;_.have<_.ncode;){for(;B<3;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}_.lens[j[_.have++]]=7&D,D>>>=3,B-=3}for(;_.have<19;)_.lens[j[_.have++]]=0;if(_.lencode=_.lendyn,_.lenbits=7,F={bits:_.lenbits},Y=c(0,_.lens,0,19,_.lencode,0,_.work,F),_.lenbits=F.bits,Y){E.msg="invalid code lengths set",_.mode=30;break}_.have=0,_.mode=19;case 19:for(;_.have<_.nlen+_.ndist;){for(;ct=(O=_.lencode[D&(1<<_.lenbits)-1])>>>16&255,wt=65535&O,!((lt=O>>>24)<=B);){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}if(wt<16)D>>>=lt,B-=lt,_.lens[_.have++]=wt;else{if(wt===16){for(P=lt+2;B<P;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}if(D>>>=lt,B-=lt,_.have===0){E.msg="invalid bit length repeat",_.mode=30;break}w=_.lens[_.have-1],q=3+(3&D),D>>>=2,B-=2}else if(wt===17){for(P=lt+3;B<P;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}B-=lt,w=0,q=3+(7&(D>>>=lt)),D>>>=3,B-=3}else{for(P=lt+7;B<P;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}B-=lt,w=0,q=11+(127&(D>>>=lt)),D>>>=7,B-=7}if(_.have+q>_.nlen+_.ndist){E.msg="invalid bit length repeat",_.mode=30;break}for(;q--;)_.lens[_.have++]=w}}if(_.mode===30)break;if(_.lens[256]===0){E.msg="invalid code -- missing end-of-block",_.mode=30;break}if(_.lenbits=9,F={bits:_.lenbits},Y=c(u,_.lens,0,_.nlen,_.lencode,0,_.work,F),_.lenbits=F.bits,Y){E.msg="invalid literal/lengths set",_.mode=30;break}if(_.distbits=6,_.distcode=_.distdyn,F={bits:_.distbits},Y=c(h,_.lens,_.nlen,_.ndist,_.distcode,0,_.work,F),_.distbits=F.bits,Y){E.msg="invalid distances set",_.mode=30;break}if(_.mode=20,z===6)break t;case 20:_.mode=21;case 21:if(6<=H&&258<=et){E.next_out=st,E.avail_out=et,E.next_in=V,E.avail_in=H,_.hold=D,_.bits=B,l(E,K),st=E.next_out,W=E.output,et=E.avail_out,V=E.next_in,L=E.input,H=E.avail_in,D=_.hold,B=_.bits,_.mode===12&&(_.back=-1);break}for(_.back=0;ct=(O=_.lencode[D&(1<<_.lenbits)-1])>>>16&255,wt=65535&O,!((lt=O>>>24)<=B);){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}if(ct&&!(240&ct)){for(mt=lt,Mt=ct,kt=wt;ct=(O=_.lencode[kt+((D&(1<<mt+Mt)-1)>>mt)])>>>16&255,wt=65535&O,!(mt+(lt=O>>>24)<=B);){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}D>>>=mt,B-=mt,_.back+=mt}if(D>>>=lt,B-=lt,_.back+=lt,_.length=wt,ct===0){_.mode=26;break}if(32&ct){_.back=-1,_.mode=12;break}if(64&ct){E.msg="invalid literal/length code",_.mode=30;break}_.extra=15&ct,_.mode=22;case 22:if(_.extra){for(P=_.extra;B<P;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}_.length+=D&(1<<_.extra)-1,D>>>=_.extra,B-=_.extra,_.back+=_.extra}_.was=_.length,_.mode=23;case 23:for(;ct=(O=_.distcode[D&(1<<_.distbits)-1])>>>16&255,wt=65535&O,!((lt=O>>>24)<=B);){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}if(!(240&ct)){for(mt=lt,Mt=ct,kt=wt;ct=(O=_.distcode[kt+((D&(1<<mt+Mt)-1)>>mt)])>>>16&255,wt=65535&O,!(mt+(lt=O>>>24)<=B);){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}D>>>=mt,B-=mt,_.back+=mt}if(D>>>=lt,B-=lt,_.back+=lt,64&ct){E.msg="invalid distance code",_.mode=30;break}_.offset=wt,_.extra=15&ct,_.mode=24;case 24:if(_.extra){for(P=_.extra;B<P;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}_.offset+=D&(1<<_.extra)-1,D>>>=_.extra,B-=_.extra,_.back+=_.extra}if(_.offset>_.dmax){E.msg="invalid distance too far back",_.mode=30;break}_.mode=25;case 25:if(et===0)break t;if(q=K-et,_.offset>q){if((q=_.offset-q)>_.whave&&_.sane){E.msg="invalid distance too far back",_.mode=30;break}ut=q>_.wnext?(q-=_.wnext,_.wsize-q):_.wnext-q,q>_.length&&(q=_.length),Ct=_.window}else Ct=W,ut=st-_.offset,q=_.length;for(et<q&&(q=et),et-=q,_.length-=q;W[st++]=Ct[ut++],--q;);_.length===0&&(_.mode=21);break;case 26:if(et===0)break t;W[st++]=_.length,et--,_.mode=21;break;case 27:if(_.wrap){for(;B<32;){if(H===0)break t;H--,D|=L[V++]<<B,B+=8}if(K-=et,E.total_out+=K,_.total+=K,K&&(E.adler=_.check=_.flags?o(_.check,W,K,st-K):r(_.check,W,K,st-K)),K=et,(_.flags?D:f(D))!==_.check){E.msg="incorrect data check",_.mode=30;break}B=D=0}_.mode=28;case 28:if(_.wrap&&_.flags){for(;B<32;){if(H===0)break t;H--,D+=L[V++]<<B,B+=8}if(D!==(4294967295&_.total)){E.msg="incorrect length check",_.mode=30;break}B=D=0}_.mode=29;case 29:Y=1;break t;case 30:Y=-3;break t;case 31:return-4;case 32:default:return d}return E.next_out=st,E.avail_out=et,E.next_in=V,E.avail_in=H,_.hold=D,_.bits=B,(_.wsize||K!==E.avail_out&&_.mode<30&&(_.mode<27||z!==4))&&$(E,E.output,E.next_out,K-E.avail_out)?(_.mode=31,-4):(J-=E.avail_in,K-=E.avail_out,E.total_in+=J,E.total_out+=K,_.total+=K,_.wrap&&K&&(E.adler=_.check=_.flags?o(_.check,W,K,E.next_out-K):r(_.check,W,K,E.next_out-K)),E.data_type=_.bits+(_.last?64:0)+(_.mode===12?128:0)+(_.mode===20||_.mode===15?256:0),(J==0&&K===0||z===4)&&Y===p&&(Y=-5),Y)},s.inflateEnd=function(E){if(!E||!E.state)return d;var z=E.state;return z.window&&(z.window=null),E.state=null,p},s.inflateGetHeader=function(E,z){var _;return E&&E.state&&2&(_=E.state).wrap?((_.head=z).done=!1,p):d},s.inflateSetDictionary=function(E,z){var _,L=z.length;return E&&E.state?(_=E.state).wrap!==0&&_.mode!==11?d:_.mode===11&&r(1,z,L,0)!==_.check?-3:$(E,z,L,L)?(_.mode=31,-4):(_.havedict=1,p):d},s.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,i,s){var n=t("../utils/common"),r=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],l=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],c=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];i.exports=function(u,h,p,d,g,m,b,f){var y,v,x,T,A,S,M,I,k,$=f.bits,E=0,z=0,_=0,L=0,W=0,V=0,st=0,H=0,et=0,D=0,B=null,J=0,K=new n.Buf16(16),q=new n.Buf16(16),ut=null,Ct=0;for(E=0;E<=15;E++)K[E]=0;for(z=0;z<d;z++)K[h[p+z]]++;for(W=$,L=15;1<=L&&K[L]===0;L--);if(L<W&&(W=L),L===0)return g[m++]=20971520,g[m++]=20971520,f.bits=1,0;for(_=1;_<L&&K[_]===0;_++);for(W<_&&(W=_),E=H=1;E<=15;E++)if(H<<=1,(H-=K[E])<0)return-1;if(0<H&&(u===0||L!==1))return-1;for(q[1]=0,E=1;E<15;E++)q[E+1]=q[E]+K[E];for(z=0;z<d;z++)h[p+z]!==0&&(b[q[h[p+z]]++]=z);if(S=u===0?(B=ut=b,19):u===1?(B=r,J-=257,ut=o,Ct-=257,256):(B=l,ut=c,-1),E=_,A=m,st=z=D=0,x=-1,T=(et=1<<(V=W))-1,u===1&&852<et||u===2&&592<et)return 1;for(;;){for(M=E-st,k=b[z]<S?(I=0,b[z]):b[z]>S?(I=ut[Ct+b[z]],B[J+b[z]]):(I=96,0),y=1<<E-st,_=v=1<<V;g[A+(D>>st)+(v-=y)]=M<<24|I<<16|k|0,v!==0;);for(y=1<<E-1;D&y;)y>>=1;if(y!==0?(D&=y-1,D+=y):D=0,z++,--K[E]==0){if(E===L)break;E=h[p+b[z]]}if(W<E&&(D&T)!==x){for(st===0&&(st=W),A+=_,H=1<<(V=E-st);V+st<L&&!((H-=K[V+st])<=0);)V++,H<<=1;if(et+=1<<V,u===1&&852<et||u===2&&592<et)return 1;g[x=D&T]=W<<24|V<<16|A-m|0}}return D!==0&&(g[A+D]=E-st<<24|64<<16|0),f.bits=W,0}},{"../utils/common":41}],51:[function(t,i,s){i.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,i,s){var n=t("../utils/common"),r=0,o=1;function l(O){for(var N=O.length;0<=--N;)O[N]=0}var c=0,u=29,h=256,p=h+1+u,d=30,g=19,m=2*p+1,b=15,f=16,y=7,v=256,x=16,T=17,A=18,S=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],M=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],I=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],k=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],$=new Array(2*(p+2));l($);var E=new Array(2*d);l(E);var z=new Array(512);l(z);var _=new Array(256);l(_);var L=new Array(u);l(L);var W,V,st,H=new Array(d);function et(O,N,j,X,R){this.static_tree=O,this.extra_bits=N,this.extra_base=j,this.elems=X,this.max_length=R,this.has_stree=O&&O.length}function D(O,N){this.dyn_tree=O,this.max_code=0,this.stat_desc=N}function B(O){return O<256?z[O]:z[256+(O>>>7)]}function J(O,N){O.pending_buf[O.pending++]=255&N,O.pending_buf[O.pending++]=N>>>8&255}function K(O,N,j){O.bi_valid>f-j?(O.bi_buf|=N<<O.bi_valid&65535,J(O,O.bi_buf),O.bi_buf=N>>f-O.bi_valid,O.bi_valid+=j-f):(O.bi_buf|=N<<O.bi_valid&65535,O.bi_valid+=j)}function q(O,N,j){K(O,j[2*N],j[2*N+1])}function ut(O,N){for(var j=0;j|=1&O,O>>>=1,j<<=1,0<--N;);return j>>>1}function Ct(O,N,j){var X,R,G=new Array(b+1),tt=0;for(X=1;X<=b;X++)G[X]=tt=tt+j[X-1]<<1;for(R=0;R<=N;R++){var Q=O[2*R+1];Q!==0&&(O[2*R]=ut(G[Q]++,Q))}}function lt(O){var N;for(N=0;N<p;N++)O.dyn_ltree[2*N]=0;for(N=0;N<d;N++)O.dyn_dtree[2*N]=0;for(N=0;N<g;N++)O.bl_tree[2*N]=0;O.dyn_ltree[2*v]=1,O.opt_len=O.static_len=0,O.last_lit=O.matches=0}function ct(O){8<O.bi_valid?J(O,O.bi_buf):0<O.bi_valid&&(O.pending_buf[O.pending++]=O.bi_buf),O.bi_buf=0,O.bi_valid=0}function wt(O,N,j,X){var R=2*N,G=2*j;return O[R]<O[G]||O[R]===O[G]&&X[N]<=X[j]}function mt(O,N,j){for(var X=O.heap[j],R=j<<1;R<=O.heap_len&&(R<O.heap_len&&wt(N,O.heap[R+1],O.heap[R],O.depth)&&R++,!wt(N,X,O.heap[R],O.depth));)O.heap[j]=O.heap[R],j=R,R<<=1;O.heap[j]=X}function Mt(O,N,j){var X,R,G,tt,Q=0;if(O.last_lit!==0)for(;X=O.pending_buf[O.d_buf+2*Q]<<8|O.pending_buf[O.d_buf+2*Q+1],R=O.pending_buf[O.l_buf+Q],Q++,X===0?q(O,R,N):(q(O,(G=_[R])+h+1,N),(tt=S[G])!==0&&K(O,R-=L[G],tt),q(O,G=B(--X),j),(tt=M[G])!==0&&K(O,X-=H[G],tt)),Q<O.last_lit;);q(O,v,N)}function kt(O,N){var j,X,R,G=N.dyn_tree,tt=N.stat_desc.static_tree,Q=N.stat_desc.has_stree,nt=N.stat_desc.elems,_t=-1;for(O.heap_len=0,O.heap_max=m,j=0;j<nt;j++)G[2*j]!==0?(O.heap[++O.heap_len]=_t=j,O.depth[j]=0):G[2*j+1]=0;for(;O.heap_len<2;)G[2*(R=O.heap[++O.heap_len]=_t<2?++_t:0)]=1,O.depth[R]=0,O.opt_len--,Q&&(O.static_len-=tt[2*R+1]);for(N.max_code=_t,j=O.heap_len>>1;1<=j;j--)mt(O,G,j);for(R=nt;j=O.heap[1],O.heap[1]=O.heap[O.heap_len--],mt(O,G,1),X=O.heap[1],O.heap[--O.heap_max]=j,O.heap[--O.heap_max]=X,G[2*R]=G[2*j]+G[2*X],O.depth[R]=(O.depth[j]>=O.depth[X]?O.depth[j]:O.depth[X])+1,G[2*j+1]=G[2*X+1]=R,O.heap[1]=R++,mt(O,G,1),2<=O.heap_len;);O.heap[--O.heap_max]=O.heap[1],function(ht,Xt){var Ke,oe,Je,Et,Si,xs,fe=Xt.dyn_tree,vn=Xt.max_code,Nr=Xt.stat_desc.static_tree,Lr=Xt.stat_desc.has_stree,Dr=Xt.stat_desc.extra_bits,xn=Xt.stat_desc.extra_base,ti=Xt.stat_desc.max_length,Oi=0;for(Et=0;Et<=b;Et++)ht.bl_count[Et]=0;for(fe[2*ht.heap[ht.heap_max]+1]=0,Ke=ht.heap_max+1;Ke<m;Ke++)ti<(Et=fe[2*fe[2*(oe=ht.heap[Ke])+1]+1]+1)&&(Et=ti,Oi++),fe[2*oe+1]=Et,vn<oe||(ht.bl_count[Et]++,Si=0,xn<=oe&&(Si=Dr[oe-xn]),xs=fe[2*oe],ht.opt_len+=xs*(Et+Si),Lr&&(ht.static_len+=xs*(Nr[2*oe+1]+Si)));if(Oi!==0){do{for(Et=ti-1;ht.bl_count[Et]===0;)Et--;ht.bl_count[Et]--,ht.bl_count[Et+1]+=2,ht.bl_count[ti]--,Oi-=2}while(0<Oi);for(Et=ti;Et!==0;Et--)for(oe=ht.bl_count[Et];oe!==0;)vn<(Je=ht.heap[--Ke])||(fe[2*Je+1]!==Et&&(ht.opt_len+=(Et-fe[2*Je+1])*fe[2*Je],fe[2*Je+1]=Et),oe--)}}(O,N),Ct(G,_t,O.bl_count)}function w(O,N,j){var X,R,G=-1,tt=N[1],Q=0,nt=7,_t=4;for(tt===0&&(nt=138,_t=3),N[2*(j+1)+1]=65535,X=0;X<=j;X++)R=tt,tt=N[2*(X+1)+1],++Q<nt&&R===tt||(Q<_t?O.bl_tree[2*R]+=Q:R!==0?(R!==G&&O.bl_tree[2*R]++,O.bl_tree[2*x]++):Q<=10?O.bl_tree[2*T]++:O.bl_tree[2*A]++,G=R,_t=(Q=0)===tt?(nt=138,3):R===tt?(nt=6,3):(nt=7,4))}function Y(O,N,j){var X,R,G=-1,tt=N[1],Q=0,nt=7,_t=4;for(tt===0&&(nt=138,_t=3),X=0;X<=j;X++)if(R=tt,tt=N[2*(X+1)+1],!(++Q<nt&&R===tt)){if(Q<_t)for(;q(O,R,O.bl_tree),--Q!=0;);else R!==0?(R!==G&&(q(O,R,O.bl_tree),Q--),q(O,x,O.bl_tree),K(O,Q-3,2)):Q<=10?(q(O,T,O.bl_tree),K(O,Q-3,3)):(q(O,A,O.bl_tree),K(O,Q-11,7));G=R,_t=(Q=0)===tt?(nt=138,3):R===tt?(nt=6,3):(nt=7,4)}}l(H);var F=!1;function P(O,N,j,X){K(O,(c<<1)+(X?1:0),3),function(R,G,tt,Q){ct(R),J(R,tt),J(R,~tt),n.arraySet(R.pending_buf,R.window,G,tt,R.pending),R.pending+=tt}(O,N,j)}s._tr_init=function(O){F||(function(){var N,j,X,R,G,tt=new Array(b+1);for(R=X=0;R<u-1;R++)for(L[R]=X,N=0;N<1<<S[R];N++)_[X++]=R;for(_[X-1]=R,R=G=0;R<16;R++)for(H[R]=G,N=0;N<1<<M[R];N++)z[G++]=R;for(G>>=7;R<d;R++)for(H[R]=G<<7,N=0;N<1<<M[R]-7;N++)z[256+G++]=R;for(j=0;j<=b;j++)tt[j]=0;for(N=0;N<=143;)$[2*N+1]=8,N++,tt[8]++;for(;N<=255;)$[2*N+1]=9,N++,tt[9]++;for(;N<=279;)$[2*N+1]=7,N++,tt[7]++;for(;N<=287;)$[2*N+1]=8,N++,tt[8]++;for(Ct($,p+1,tt),N=0;N<d;N++)E[2*N+1]=5,E[2*N]=ut(N,5);W=new et($,S,h+1,p,b),V=new et(E,M,0,d,b),st=new et(new Array(0),I,0,g,y)}(),F=!0),O.l_desc=new D(O.dyn_ltree,W),O.d_desc=new D(O.dyn_dtree,V),O.bl_desc=new D(O.bl_tree,st),O.bi_buf=0,O.bi_valid=0,lt(O)},s._tr_stored_block=P,s._tr_flush_block=function(O,N,j,X){var R,G,tt=0;0<O.level?(O.strm.data_type===2&&(O.strm.data_type=function(Q){var nt,_t=4093624447;for(nt=0;nt<=31;nt++,_t>>>=1)if(1&_t&&Q.dyn_ltree[2*nt]!==0)return r;if(Q.dyn_ltree[18]!==0||Q.dyn_ltree[20]!==0||Q.dyn_ltree[26]!==0)return o;for(nt=32;nt<h;nt++)if(Q.dyn_ltree[2*nt]!==0)return o;return r}(O)),kt(O,O.l_desc),kt(O,O.d_desc),tt=function(Q){var nt;for(w(Q,Q.dyn_ltree,Q.l_desc.max_code),w(Q,Q.dyn_dtree,Q.d_desc.max_code),kt(Q,Q.bl_desc),nt=g-1;3<=nt&&Q.bl_tree[2*k[nt]+1]===0;nt--);return Q.opt_len+=3*(nt+1)+5+5+4,nt}(O),R=O.opt_len+3+7>>>3,(G=O.static_len+3+7>>>3)<=R&&(R=G)):R=G=j+5,j+4<=R&&N!==-1?P(O,N,j,X):O.strategy===4||G===R?(K(O,2+(X?1:0),3),Mt(O,$,E)):(K(O,4+(X?1:0),3),function(Q,nt,_t,ht){var Xt;for(K(Q,nt-257,5),K(Q,_t-1,5),K(Q,ht-4,4),Xt=0;Xt<ht;Xt++)K(Q,Q.bl_tree[2*k[Xt]+1],3);Y(Q,Q.dyn_ltree,nt-1),Y(Q,Q.dyn_dtree,_t-1)}(O,O.l_desc.max_code+1,O.d_desc.max_code+1,tt+1),Mt(O,O.dyn_ltree,O.dyn_dtree)),lt(O),X&&ct(O)},s._tr_tally=function(O,N,j){return O.pending_buf[O.d_buf+2*O.last_lit]=N>>>8&255,O.pending_buf[O.d_buf+2*O.last_lit+1]=255&N,O.pending_buf[O.l_buf+O.last_lit]=255&j,O.last_lit++,N===0?O.dyn_ltree[2*j]++:(O.matches++,N--,O.dyn_ltree[2*(_[j]+h+1)]++,O.dyn_dtree[2*B(N)]++),O.last_lit===O.lit_bufsize-1},s._tr_align=function(O){K(O,2,3),q(O,v,$),function(N){N.bi_valid===16?(J(N,N.bi_buf),N.bi_buf=0,N.bi_valid=0):8<=N.bi_valid&&(N.pending_buf[N.pending++]=255&N.bi_buf,N.bi_buf>>=8,N.bi_valid-=8)}(O)}},{"../utils/common":41}],53:[function(t,i,s){i.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,i,s){(function(n){(function(r,o){if(!r.setImmediate){var l,c,u,h,p=1,d={},g=!1,m=r.document,b=Object.getPrototypeOf&&Object.getPrototypeOf(r);b=b&&b.setTimeout?b:r,l={}.toString.call(r.process)==="[object process]"?function(x){process.nextTick(function(){y(x)})}:function(){if(r.postMessage&&!r.importScripts){var x=!0,T=r.onmessage;return r.onmessage=function(){x=!1},r.postMessage("","*"),r.onmessage=T,x}}()?(h="setImmediate$"+Math.random()+"$",r.addEventListener?r.addEventListener("message",v,!1):r.attachEvent("onmessage",v),function(x){r.postMessage(h+x,"*")}):r.MessageChannel?((u=new MessageChannel).port1.onmessage=function(x){y(x.data)},function(x){u.port2.postMessage(x)}):m&&"onreadystatechange"in m.createElement("script")?(c=m.documentElement,function(x){var T=m.createElement("script");T.onreadystatechange=function(){y(x),T.onreadystatechange=null,c.removeChild(T),T=null},c.appendChild(T)}):function(x){setTimeout(y,0,x)},b.setImmediate=function(x){typeof x!="function"&&(x=new Function(""+x));for(var T=new Array(arguments.length-1),A=0;A<T.length;A++)T[A]=arguments[A+1];var S={callback:x,args:T};return d[p]=S,l(p),p++},b.clearImmediate=f}function f(x){delete d[x]}function y(x){if(g)setTimeout(y,0,x);else{var T=d[x];if(T){g=!0;try{(function(A){var S=A.callback,M=A.args;switch(M.length){case 0:S();break;case 1:S(M[0]);break;case 2:S(M[0],M[1]);break;case 3:S(M[0],M[1],M[2]);break;default:S.apply(o,M)}})(T)}finally{f(x),g=!1}}}}function v(x){x.source===r&&typeof x.data=="string"&&x.data.indexOf(h)===0&&y(+x.data.slice(h.length))}})(typeof self>"u"?n===void 0?this:n:self)}).call(this,typeof Pi<"u"?Pi:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(kr);var Yl=kr.exports;const sr=Jr(Yl);class nn{constructor(e,t){C(this,"date",new Date);C(this,"author");C(this,"guid",Zt.create());C(this,"viewpoint");C(this,"modifiedAuthor");C(this,"modifiedDate");C(this,"topic");C(this,"_components");C(this,"_comment","");this._components=e,this._comment=t;const i=this._components.get(Ot);this.author=i.config.author}set comment(e){var i;const t=this._components.get(Ot);this._comment=e,this.modifiedDate=new Date,this.modifiedAuthor=t.config.author,(i=this.topic)==null||i.comments.set(this.guid,this)}get comment(){return this._comment}toJSON(){var t,i;const e={guid:this.guid,date:this.date.toISOString(),author:this.author,comment:this.comment,topic_guid:(t=this.topic)==null?void 0:t.guid,viewpoint_guid:this.viewpoint,modified_date:(i=this.modifiedDate)==null?void 0:i.toISOString(),modified_author:this.modifiedAuthor};for(const[s,n]of Object.entries(e))n===void 0&&delete e[s];return e}}const he=class he{constructor(e){C(this,"guid",Zt.create());C(this,"title",he.default.title);C(this,"creationDate",new Date);C(this,"creationAuthor","");C(this,"viewpoints",new me);C(this,"relatedTopics",new me);C(this,"comments",new Vt);C(this,"documentReferences",new me);C(this,"customData",{});C(this,"description");C(this,"serverAssignedId");C(this,"dueDate");C(this,"modifiedAuthor");C(this,"modifiedDate");C(this,"index");C(this,"_type",he.default.type);C(this,"_status",he.default.status);C(this,"_priority",he.default.priority);C(this,"_stage",he.default.stage);C(this,"_assignedTo",he.default.assignedTo);C(this,"_labels",he.default.labels??new Set);C(this,"_components");this._components=e;const t=e.get(Ot);this.creationAuthor=t.config.author,this.relatedTopics.guard=i=>i!==this.guid}set type(e){const t=this._components.get(Ot),{strict:i,types:s}=t.config;(!i||s.has(e))&&(this._type=e)}get type(){return this._type}set status(e){const t=this._components.get(Ot),{strict:i,statuses:s}=t.config;(!i||s.has(e))&&(this._status=e)}get status(){return this._status}set priority(e){const t=this._components.get(Ot);if(e){const{strict:i,priorities:s}=t.config;if(!(i?s.has(e):!0))return;this._priority=e}else this._priority=e}get priority(){return this._priority}set stage(e){const t=this._components.get(Ot);if(e){const{strict:i,stages:s}=t.config;if(!(i?s.has(e):!0))return;this._stage=e}else this._stage=e}get stage(){return this._stage}set assignedTo(e){const t=this._components.get(Ot);if(e){const{strict:i,users:s}=t.config;if(!(i?s.has(e):!0))return;this._assignedTo=e}else this._assignedTo=e}get assignedTo(){return this._assignedTo}set labels(e){const t=this._components.get(Ot),{strict:i,labels:s}=t.config;if(i){const n=new Set;for(const r of e)(!i||s.has(r))&&n.add(r);this._labels=n}else this._labels=e}get labels(){return this._labels}get _managerVersion(){return this._components.get(Ot).config.version}set(e){const t=e,i=this;for(const n in e){if(n==="guid")continue;const r=t[n];n in this&&(i[n]=r)}return this._components.get(Ot).list.set(this.guid,this),this}createComment(e,t){const i=new nn(this._components,e);return i.viewpoint=t,i.topic=this,this.comments.set(i.guid,i),i}createLabelTags(){const e=[...this.labels];if(this._components.get(Ot).config.exportCustomDataAsLabels)for(const i in this.customData){const s=this.customData[i];typeof s=="string"&&e.push(s)}return e}createCommentTags(){return[...this.comments.values()].map(e=>{var t;return{$Guid:e.guid,Date:e.date.toISOString(),Author:e.author,Comment:e.comment,ModifiedAuthor:e.modifiedAuthor,ModifiedDate:(t=e.modifiedDate)==null?void 0:t.toISOString(),Viewpoint:e.viewpoint?{$Guid:e.viewpoint}:void 0}})}createViewpointTags(){const e=this._components.get(ne);return[...this.viewpoints].map(i=>e.list.get(i)).filter(i=>i).map(i=>{const s={$Guid:i.guid,Viewpoint:`${i.title??i.guid}.bcfv`};if(e.snapshots.get(i.snapshot)){const r=e.getSnapshotExtension(i.snapshot);s.Snapshot=`${i.snapshot}.${r}`}return s})}createRelatedTopicTags(){return[...this.relatedTopics].map(e=>({$Guid:e}))}createDocumentReferencesTag(e=this._managerVersion){const t=[];if(!(e==="3"||e==="2.1"))return t;const i=this._components.get(Ot);for(const s of this.documentReferences){const n=i.documents.get(s);if(!n)continue;let r={$Guid:Zt.create(),Description:n.description};e==="2.1"&&(r={...r,$isExternal:n.type==="external"?!0:void 0,ReferencedDocument:n.type==="external"?n.url:`../${n.fileName}`}),e==="3"&&(r={...r,DocumentGuid:n.type==="internal"?s:void 0,Url:n.type==="external"?n.url:void 0}),Object.keys(r).length>0&&t.push(r)}return t}toJSON(){var s,n;const e={guid:this.guid,server_assigned_id:this.serverAssignedId,topic_type:this.type,topic_status:this.status,title:this.title,priority:this.priority,index:this.index,labels:[...this.labels],creation_date:this.creationDate.toISOString(),creation_author:this.creationAuthor,modified_date:(s=this.modifiedDate)==null?void 0:s.toISOString(),modified_author:this.modifiedAuthor,assigned_to:this.assignedTo,stage:this.stage,description:this.description,due_date:(n=this.dueDate)==null?void 0:n.toISOString(),comments:[...this.comments].map(([r,o])=>o.toJSON()),relatedTopics:[...this.relatedTopics].map(r=>({related_topic_guid:r}))},t=this._components.get(ne);for(const r of this.viewpoints){const o=t.list.get(r);o&&(e.viewpoints||(e.viewpoints=[]),e.viewpoints.push(o.toJSON()))}const i=this._components.get(Ot);for(const r of this.documentReferences){const o=i.documents.get(r);o&&(e.document_references||(e.document_references=[]),o.type==="external"?e.document_references.push({guid:Zt.create(),description:o.description,url:o.url}):e.document_references.push({guid:Zt.create(),description:o.description,document_guid:r}))}for(const[r,o]of Object.entries(e))(o===void 0||Array.isArray(o)&&o.length===0)&&delete e[r];return e}serialize(){var s,n;const e=this._managerVersion,t={$Guid:this.guid,$TopicType:this.type,$TopicStatus:this.status,$ServerAssignedId:this.serverAssignedId,Title:this.title,CreationAuthor:this.creationAuthor,CreationDate:this.creationDate.toISOString(),Priority:this.priority,Index:e==="2.1"?this.index:void 0,ModifiedDate:(s=this.modifiedDate)==null?void 0:s.toISOString(),ModifiedAuthor:this.modifiedAuthor,DueDate:(n=this.dueDate)==null?void 0:n.toISOString(),AssignedTo:this.assignedTo,Description:this.description,Stage:this.stage,DocumentReferences:e==="3"?{DocumentReference:this.createDocumentReferencesTag(e)}:void 0,RelatedTopics:e==="3"?{RelatedTopic:this.createRelatedTopicTags()}:void 0,RelatedTopic:e==="2.1"?this.createRelatedTopicTags():void 0,Labels:e==="3"?{Label:this.createLabelTags()}:void 0,Viewpoints:e==="3"?{ViewPoint:this.createViewpointTags()}:void 0,Comments:e==="3"?{Comment:this.createCommentTags()}:void 0};e==="2.1"&&(t.Labels=this.createLabelTags(),t.DocumentReference=this.createDocumentReferencesTag(e));const i={Markup:{Topic:t}};return e==="2.1"&&(i.Markup.Viewpoints=this.createViewpointTags(),i.Markup.Comment=this.createCommentTags()),`<?xml version="1.0" encoding="UTF-8"?>
    ${as.builder.build(i)}`}};C(he,"default",{title:"BCF Topic",type:"Issue",status:"Active"});let hs=he;const jl=(a,e)=>{if(e.trim()==="")return;const t=Ot.xmlParser.parse(e).Extensions;if(!t)return;const{Priorities:i,TopicStatuses:s,TopicTypes:n,Users:r}=t;if(i&&i.Priority){const o=Array.isArray(i.Priority)?i.Priority:[i.Priority];for(const l of o)a.config.priorities.add(l)}if(s&&s.TopicStatus){const o=Array.isArray(s.TopicStatus)?s.TopicStatus:[s.TopicStatus];for(const l of o)a.config.statuses.add(l)}if(n&&n.TopicType){const o=Array.isArray(n.TopicType)?n.TopicType:[n.TopicType];for(const l of o)a.config.types.add(l)}if(r&&r.User){const o=Array.isArray(r.User)?r.User:[r.User];for(const l of o)a.config.users.add(l)}};class Xl extends ws{constructor(){super(...arguments);C(this,"_config",{version:{type:"Select",options:new Set(["2.1","3"]),multiple:!1,value:""},author:{type:"Text",value:""},types:{type:"TextSet",value:new Set},statuses:{type:"TextSet",value:new Set},priorities:{type:"TextSet",value:new Set},labels:{type:"TextSet",value:new Set},stages:{type:"TextSet",value:new Set},users:{type:"TextSet",value:new Set},includeSelectionTag:{type:"Boolean",value:!1},updateExtensionsOnImport:{type:"Boolean",value:!1},strict:{type:"Boolean",value:!1},includeAllExtensionsOnExport:{type:"Boolean",value:!1},fallbackVersionOnImport:{type:"Select",multiple:!1,options:new Set(["2.1","3"]),value:""},ignoreIncompleteTopicsOnImport:{type:"Boolean",value:!1},exportCustomDataAsLabels:{type:"Boolean",value:!1}})}get version(){return this._config.version.value}set version(t){this._config.version.value=t}get author(){return this._config.author.value}set author(t){this._config.author.value=t}get types(){return this._config.types.value}set types(t){this._config.types.value=t}get statuses(){return this._config.statuses.value}set statuses(t){this._config.statuses.value=t}get priorities(){return this._config.priorities.value}set priorities(t){this._config.priorities.value=t}get labels(){return this._config.labels.value}set labels(t){this._config.labels.value=t}get stages(){return this._config.stages.value}set stages(t){this._config.stages.value=t}get users(){return this._config.users.value}set users(t){this._config.users.value=t}get includeSelectionTag(){return this._config.includeSelectionTag.value}set includeSelectionTag(t){this._config.includeSelectionTag.value=t}get updateExtensionsOnImport(){return this._config.updateExtensionsOnImport.value}set updateExtensionsOnImport(t){this._config.updateExtensionsOnImport.value=t}get strict(){return this._config.strict.value}set strict(t){this._config.strict.value=t}get includeAllExtensionsOnExport(){return this._config.includeAllExtensionsOnExport.value}set includeAllExtensionsOnExport(t){this._config.includeAllExtensionsOnExport.value=t}get fallbackVersionOnImport(){return this._config.fallbackVersionOnImport.value}set fallbackVersionOnImport(t){this._config.fallbackVersionOnImport.value=t}get ignoreIncompleteTopicsOnImport(){return this._config.ignoreIncompleteTopicsOnImport.value}set ignoreIncompleteTopicsOnImport(t){this._config.ignoreIncompleteTopicsOnImport.value=t}get exportCustomDataAsLabels(){return this._config.exportCustomDataAsLabels.value}set exportCustomDataAsLabels(t){this._config.exportCustomDataAsLabels.value=t}}const Te=class Te extends te{constructor(){super(...arguments);C(this,"enabled",!1);C(this,"_defaultConfig",{author:"jhon.doe@example.com",version:"2.1",types:new Set(["Clash","Failure","Fault","Inquiry","Issue","Remark","Request"]),statuses:new Set(["Active","In Progress","Done","In Review","Closed"]),priorities:new Set(["On hold","Minor","Normal","Major","Critical"]),labels:new Set,stages:new Set,users:new Set,includeSelectionTag:!1,updateExtensionsOnImport:!0,strict:!1,includeAllExtensionsOnExport:!0,fallbackVersionOnImport:"2.1",ignoreIncompleteTopicsOnImport:!1,exportCustomDataAsLabels:!1});C(this,"config",new Xl(this,this.components,"BCF Topics",Te.uuid));C(this,"list",new Vt);C(this,"documents",new Vt);C(this,"onSetup",new rt);C(this,"isSetup",!1);C(this,"onBCFImported",new rt);C(this,"onDisposed",new rt)}setup(t){if(this.isSetup)return;const i={...this._defaultConfig,...t};this.config.version=i.version,this.config.author=i.author,this.config.types=i.types,this.config.statuses=i.statuses,this.config.priorities=i.priorities,this.config.labels=i.labels,this.config.stages=i.stages,this.config.users=i.users,this.config.includeSelectionTag=i.includeSelectionTag,this.config.updateExtensionsOnImport=i.updateExtensionsOnImport,this.config.strict=i.strict,this.config.includeAllExtensionsOnExport=i.includeAllExtensionsOnExport,this.config.fallbackVersionOnImport=i.fallbackVersionOnImport||"",this.config.ignoreIncompleteTopicsOnImport=i.ignoreIncompleteTopicsOnImport,this.isSetup=!0,this.enabled=!0,this.onSetup.trigger()}create(t){const i=new hs(this.components);return t?(i.guid=t.guid??i.guid,i.set(t)):this.list.set(i.guid,i),i}dispose(){this.list.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}get usedTypes(){const t=[...this.list].map(([i,s])=>s.type);return new Set(t)}get usedStatuses(){const t=[...this.list].map(([i,s])=>s.status);return new Set(t)}get usedPriorities(){const t=[...this.list].map(([i,s])=>s.priority).filter(i=>i);return new Set(t)}get usedStages(){const t=[...this.list].map(([i,s])=>s.stage).filter(i=>i);return new Set(t)}get usedUsers(){const t=[];for(const[i,s]of this.list){t.push(s.creationAuthor),s.assignedTo&&t.push(s.assignedTo),s.modifiedAuthor&&t.push(s.modifiedAuthor);for(const[n,r]of s.comments)t.push(r.author),r.modifiedAuthor&&t.push(r.modifiedAuthor)}return new Set(t)}get usedLabels(){const t=[];for(const[i,s]of this.list)t.push(...s.labels);return new Set(t)}updateExtensions(){for(const[t,i]of this.list){for(const s of i.labels)this.config.labels.add(s);this.config.types.add(i.type),i.priority&&this.config.priorities.add(i.priority),i.stage&&this.config.stages.add(i.stage),this.config.statuses.add(i.status),this.config.users.add(i.creationAuthor),i.assignedTo&&this.config.users.add(i.assignedTo),i.modifiedAuthor&&this.config.users.add(i.modifiedAuthor);for(const[s,n]of i.comments)this.config.users.add(n.author),n.modifiedAuthor&&this.config.users.add(n.modifiedAuthor)}}updateViewpointReferences(){const t=this.components.get(ne);for(const[i,s]of this.list)for(const n of s.viewpoints)t.list.has(n)||s.viewpoints.delete(n)}async export(t=this.list.values()){const i=new sr;i.file("bcf.version",`<?xml version="1.0" encoding="UTF-8"?>
    <Version VersionId="${this.config.version}" xsi:noNamespaceSchemaLocation="https://raw.githubusercontent.com/buildingSMART/BCF-XML/release_3_0/Schemas/version.xsd"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    </Version>`);for(const[r,o]of this.documents.entries())o.type!=="external"&&i.file(this.config.version==="2.1"?o.fileName:`documents/${r}`,o.data);if(this.config.version==="3"){const r=[];for(const[o,l]of this.documents.entries()){const{type:c,description:u}=l;c!=="external"&&r.push(`<Document Guid="${o}">
        <Filename>${l.fileName}</Filename>
        ${u?`<Description>${u}</Description>`:""}
      </Document>`)}r.length>0&&i.file("documents.xml",`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <DocumentInfo xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="documents.xsd">
    <Documents>
      ${r.join(`
`)}
    </Documents>
  </DocumentInfo>`)}i.file("bcf.extensions",this.serializeExtensions());const s=this.components.get(ne);for(const r of t){const o=i.folder(r.guid);o.file("markup.bcf",r.serialize());for(const l of r.viewpoints){const c=s.list.get(l);if(!c)continue;const u=c.title??c.guid;o.file(`${u}.bcfv`,await c.serialize());const h=s.snapshots.get(c.snapshot);if(!h)continue;const p=h?c.snapshot:c.guid,d=s.getSnapshotExtension(c.snapshot);o.file(`${p}.${d}`,h,{binary:!0})}}return await i.generateAsync({type:"blob"})}serializeExtensions(){const t=[...this.config.types].map(l=>`<TopicType>${l}</TopicType>`).join(`
`),i=[...this.config.statuses].map(l=>`<TopicStatus>${l}</TopicStatus>`).join(`
`),s=[...this.config.priorities].map(l=>`<Priority>${l}</Priority>`).join(`
`),n=[...this.config.labels].map(l=>`<TopicLabel>${l}</TopicLabel>`).join(`
`),r=[...this.config.stages].map(l=>`<Stage>${l}</Stage>`).join(`
`),o=[...this.config.users].map(l=>`<User>${l}</User>`).join(`
`);return`
      <?xml version="1.0" encoding="UTF-8"?>
      <Extensions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="your-schema-location.xsd">
        ${t.length!==0?`<TopicTypes>
${t}
</TopicTypes>`:""}
        ${i.length!==0?`<TopicStatuses>
${i}
</TopicStatuses>`:""}
        ${s.length!==0?`<Priorities>
${s}
</Priorities>`:""}
        ${n.length!==0?`<TopicLabels>
${n}
</TopicLabels>`:""}
        ${r.length!==0?`<Stages>
${r}
</Stages>`:""}
        ${o.length!==0?`<Users>
${o}
</Users>`:""}
      </Extensions>
    `}processMarkupComment(t){const{Guid:i,Date:s,Author:n,Comment:r,Viewpoint:o}=t;if(!(i&&s&&n&&(nn||o)))return null;const l=new nn(this.components,r??"");return l.guid=i,l.date=new Date(s),l.author=n,l.viewpoint=o==null?void 0:o.Guid,l.modifiedAuthor=t.ModifiedAuthor,l.modifiedDate=t.ModifiedDate?new Date(t.ModifiedDate):void 0,l}getMarkupComments(t,i){var o;let s;if(i==="2.1"&&(s=t.Comment),i==="3"&&(s=(o=t.Topic.Comments)==null?void 0:o.Comment),!s)return[];s=Array.isArray(s)?s:[s];const n=s.map(l=>this.processMarkupComment(l)).filter(l=>l);return Array.isArray(n)?n:[n]}getMarkupLabels(t,i){var r;let s;return i==="2.1"&&(s=t.Topic.Labels),i==="3"&&(s=(r=t.Topic.Labels)==null?void 0:r.Label),s?Array.isArray(s)?s:[s]:[]}getMarkupViewpoints(t,i){var n;let s;return i==="2.1"&&(s=t.Viewpoints),i==="3"&&(s=(n=t.Topic.Viewpoints)==null?void 0:n.ViewPoint),s?(s=Array.isArray(s)?s:[s],s):[]}getMarkupRelatedTopics(t,i){var r;let s;return i==="2.1"&&(s=t.Topic.RelatedTopic),i==="3"&&(s=(r=t.Topic.RelatedTopics)==null?void 0:r.RelatedTopic),s?(Array.isArray(s)?s:[s]).map(o=>o.Guid):[]}getMarkupDocumentReferences(t,i){var r;let s;return i==="2.1"&&(s=t.Topic.DocumentReference),i==="3"&&(s=(r=t.Topic.DocumentReferences)==null?void 0:r.DocumentReference),s?Array.isArray(s)?s:[s]:[]}async load(t){var f,y,v;const{fallbackVersionOnImport:i,ignoreIncompleteTopicsOnImport:s,updateExtensionsOnImport:n}=this.config,r=new sr;await r.loadAsync(t);const o=Object.values(r.files);let l=i;const c=o.find(x=>x.name.endsWith(".version"));if(c){const x=await c.async("string"),T=Te.xmlParser.parse(x).Version.VersionId;l=String(T)}if(!(l&&(l==="2.1"||l==="3")))throw new Error(`BCFTopics: ${l} is not supported.`);const u=o.find(x=>x.name.endsWith(".extensions"));if(n&&u){const x=await u.async("string");jl(this,x)}const h=[],p=this.components.get(ne),d=o.filter(x=>x.name.endsWith(".bcfv"));for(const x of d){const T=await x.async("string"),A=Te.xmlParser.parse(T).VisualizationInfo;if(!A){console.warn("Missing VisualizationInfo in Viewpoint");continue}const S={},{Guid:M,ClippingPlanes:I,Components:k,OrthogonalCamera:$,PerspectiveCamera:E}=A;if(M&&(S.guid=M),k){const _={selection:[],coloring:[],visibility:{default_visibility:!1,exceptions:[],view_setup_hints:{spaces_visible:!1,space_boundaries_visible:!1,openings_visible:!1}}};S.components=_;const{Selection:L,Visibility:W}=k;if(L&&L.Component){const H=Array.isArray(L.Component)?L.Component:[L.Component];_.selection=H.map(et=>et.IfcGuid?{ifc_guid:et.IfcGuid}:null).filter(et=>et!==null)}if(W&&"DefaultVisibility"in W&&(_.visibility.default_visibility=W.DefaultVisibility),W&&W.Exceptions&&"Component"in W.Exceptions){const{Component:H}=W.Exceptions,et=Array.isArray(H)?H:[H];_.visibility.exceptions=et.map(D=>D.IfcGuid?{ifc_guid:D.IfcGuid}:null).filter(D=>D!==null)}let V;l==="2.1"&&(V=k.ViewSetupHints),l==="3"&&(V=(f=k.Visibility)==null?void 0:f.ViewSetupHints),V&&("OpeningsVisible"in V&&(_.visibility.view_setup_hints.openings_visible=V.OpeningsVisible),"SpacesVisible"in V&&(_.visibility.view_setup_hints.spaces_visible=V.SpacesVisible),"SpaceBoundariesVisible"in V&&(_.visibility.view_setup_hints.space_boundaries_visible=V.SpaceBoundariesVisible));const{Coloring:st}=k;if(st&&st.Color){const H=Array.isArray(st.Color)?st.Color:[st.Color];for(const et of H){const{Color:D,Component:B}=et;if(!(D.length===6||D.length===8))continue;const J=D.length===6?D:D.slice(2),q=(Array.isArray(B)?B:[B]).map(ut=>ut.IfcGuid?{ifc_guid:ut.IfcGuid}:null).filter(ut=>ut!==null);_.coloring.push({color:J,components:q})}}}if($||E){const _=A.PerspectiveCamera??A.OrthogonalCamera,{CameraViewPoint:L,CameraDirection:W}=_,V=new Z(Number(L.X),Number(L.Z),Number(-L.Y)),st=new Z(Number(W.X),Number(W.Z),Number(-W.Y)),H={camera_view_point:{x:V.x,y:V.y,z:V.z},camera_direction:{x:st.x,y:st.y,z:st.z},aspect_ratio:"AspectRatio"in _?_.AspectRatio:1,camera_up_vector:{x:0,y:0,z:0}};"ViewToWorldScale"in _&&(S.orthogonal_camera={...H,view_to_world_scale:_.ViewToWorldScale}),"FieldOfView"in _&&(S.perspective_camera={...H,field_of_view:_.FieldOfView})}if(I){const L=(Array.isArray(I.ClippingPlane)?I.ClippingPlane:[I.ClippingPlane]).map(({Location:W,Direction:V})=>({location:{x:W.x,y:W.y,z:W.z},direction:{x:V.x,y:V.y,z:V.z}}));S.clipping_planes=L}const z=new zr(this.components,S);h.push(z)}const g={},m=[],b=o.filter(x=>x.name.endsWith(".bcf"));for(const x of b){const T=await x.async("string"),A=Te.xmlParser.parse(T).Markup,S=A.Topic,{Guid:M,TopicType:I,TopicStatus:k,Title:$,CreationDate:E,CreationAuthor:z}=S;if(s&&!(M&&I&&k&&$&&E&&z))continue;const _=new hs(this.components);_.guid=M??_.guid;const L=this.getMarkupRelatedTopics(A,l);g[_.guid]=new Set(L),_.type=I??_.type,_.status=k??_.status,_.title=$??_.title,_.creationDate=E?new Date(E):_.creationDate,_.creationAuthor=z??_.creationAuthor,_.serverAssignedId=S.ServerAssignedId,_.priority=S.Priority,_.index=S.Index,_.modifiedDate=S.ModifiedDate?new Date(S.ModifiedDate):void 0,_.modifiedAuthor=S.ModifiedAuthor,_.dueDate=S.DueDate?new Date(S.DueDate):void 0,_.assignedTo=S.AssignedTo,_.description=S.Description,_.stage=S.Stage;const W=this.getMarkupLabels(A,l);for(const J of W)_.labels.add(J);const V=this.getMarkupComments(A,l);for(const J of V)_.comments.set(J.guid,J);const st=this.getMarkupViewpoints(A,l);for(const J of st){if(!(J&&J.Guid))continue;const K=p.list.get(J.Guid);if(!K)continue;_.viewpoints.add(K.guid);const q=`${_.guid}/${J.Snapshot}`,ut=o.find(({name:Ct})=>Ct===q);if(ut){const Ct=await ut.async("arraybuffer"),lt=new Uint8Array(Ct);p.snapshots.set(K.guid,lt),K.snapshot=K.guid??null}}const H=this.getMarkupDocumentReferences(A,l),et=o.find(J=>J.name==="documents.xml");let D=[];const B=await(et==null?void 0:et.async("string"));if(B){const J=(v=(y=as.parser.parse(B).DocumentInfo)==null?void 0:y.Documents)==null?void 0:v.Document;D=Array.isArray(J)?J:[J]}for(const J of H){const{Description:K,DocumentGuid:q,Url:ut,isExternal:Ct,ReferencedDocument:lt}=J;if(q&&D.length>0){const ct=D.find(({Guid:w})=>w===q),wt=o.find(w=>w.name.endsWith(q)),mt=await(wt==null?void 0:wt.async("uint8array"));if(!(ct&&mt))continue;const{Description:Mt,Filename:kt}=ct;this.documents.set(q,{type:"internal",fileName:kt,description:Mt,data:mt}),_.documentReferences.add(q)}if(ut){const ct=this.documents.add({type:"external",url:ut,description:K});_.documentReferences.add(ct)}if(lt){let ct=null;if(Ct)ct=this.documents.add({type:"external",url:lt,description:K});else{const wt=lt.split("/"),mt=wt[wt.length-1],Mt=o.find(w=>w.name.endsWith(mt)),kt=await(Mt==null?void 0:Mt.async("uint8array"));if(!kt)continue;ct=this.documents.add({type:"internal",fileName:mt,data:kt,description:K})}_.documentReferences.add(ct)}}this.list.set(_.guid,_),m.push(_)}for(const x in g){const T=this.list.get(x);if(!T)continue;const A=g[x];for(const S of A)T.relatedTopics.add(S)}return this.onBCFImported.trigger(m),{viewpoints:h,topics:m}}};C(Te,"uuid","de977976-e4f6-4e4f-a01a-204727839802"),C(Te,"xmlParser",new os.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));let Ot=Te;const Ie=new an,zt=new Z,be=new Z,vt=new se,nr={X:new Z(1,0,0),Y:new Z(0,1,0),Z:new Z(0,0,1)},Hs={type:"change"},rr={type:"mouseDown",mode:null},or={type:"mouseUp",mode:null},ar={type:"objectChange"};class Wl extends to{constructor(e,t=null){super(void 0,t);const i=new tc(this);this._root=i;const s=new ec;this._gizmo=s,i.add(s);const n=new ic;this._plane=n,i.add(n);const r=this;function o(v,x){let T=x;Object.defineProperty(r,v,{get:function(){return T!==void 0?T:x},set:function(A){T!==A&&(T=A,n[v]=A,s[v]=A,r.dispatchEvent({type:v+"-changed",value:A}),r.dispatchEvent(Hs))}}),r[v]=x,n[v]=x,s[v]=x}o("camera",e),o("object",void 0),o("enabled",!0),o("axis",null),o("mode","translate"),o("translationSnap",null),o("rotationSnap",null),o("scaleSnap",null),o("space","world"),o("size",1),o("dragging",!1),o("showX",!0),o("showY",!0),o("showZ",!0),o("minX",-1/0),o("maxX",1/0),o("minY",-1/0),o("maxY",1/0),o("minZ",-1/0),o("maxZ",1/0);const l=new Z,c=new Z,u=new se,h=new se,p=new Z,d=new se,g=new Z,m=new Z,b=new Z,f=0,y=new Z;o("worldPosition",l),o("worldPositionStart",c),o("worldQuaternion",u),o("worldQuaternionStart",h),o("cameraPosition",p),o("cameraQuaternion",d),o("pointStart",g),o("pointEnd",m),o("rotationAxis",b),o("rotationAngle",f),o("eye",y),this._offset=new Z,this._startNorm=new Z,this._endNorm=new Z,this._cameraScale=new Z,this._parentPosition=new Z,this._parentQuaternion=new se,this._parentQuaternionInv=new se,this._parentScale=new Z,this._worldScaleStart=new Z,this._worldQuaternionInv=new se,this._worldScale=new Z,this._positionStart=new Z,this._quaternionStart=new se,this._scaleStart=new Z,this._getPointer=ql.bind(this),this._onPointerDown=Ql.bind(this),this._onPointerHover=Gl.bind(this),this._onPointerMove=Kl.bind(this),this._onPointerUp=Jl.bind(this),t!==null&&this.connect(t)}connect(e){super.connect(e),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(e){if(this.object===void 0||this.dragging===!0)return;e!==null&&Ie.setFromCamera(e,this.camera);const t=$s(this._gizmo.picker[this.mode],Ie);t?this.axis=t.object.name:this.axis=null}pointerDown(e){if(!(this.object===void 0||this.dragging===!0||e!=null&&e.button!==0)&&this.axis!==null){e!==null&&Ie.setFromCamera(e,this.camera);const t=$s(this._plane,Ie,!0);t&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(t.point).sub(this.worldPositionStart)),this.dragging=!0,rr.mode=this.mode,this.dispatchEvent(rr)}}pointerMove(e){const t=this.axis,i=this.mode,s=this.object;let n=this.space;if(i==="scale"?n="local":(t==="E"||t==="XYZE"||t==="XYZ")&&(n="world"),s===void 0||t===null||this.dragging===!1||e!==null&&e.button!==-1)return;e!==null&&Ie.setFromCamera(e,this.camera);const r=$s(this._plane,Ie,!0);if(r){if(this.pointEnd.copy(r.point).sub(this.worldPositionStart),i==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),n==="local"&&t!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),t.indexOf("X")===-1&&(this._offset.x=0),t.indexOf("Y")===-1&&(this._offset.y=0),t.indexOf("Z")===-1&&(this._offset.z=0),n==="local"&&t!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),s.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(n==="local"&&(s.position.applyQuaternion(vt.copy(this._quaternionStart).invert()),t.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),t.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),t.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.position.applyQuaternion(this._quaternionStart)),n==="world"&&(s.parent&&s.position.add(zt.setFromMatrixPosition(s.parent.matrixWorld)),t.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),t.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),t.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.parent&&s.position.sub(zt.setFromMatrixPosition(s.parent.matrixWorld)))),s.position.x=Math.max(this.minX,Math.min(this.maxX,s.position.x)),s.position.y=Math.max(this.minY,Math.min(this.maxY,s.position.y)),s.position.z=Math.max(this.minZ,Math.min(this.maxZ,s.position.z));else if(i==="scale"){if(t.search("XYZ")!==-1){let o=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(o*=-1),be.set(o,o,o)}else zt.copy(this.pointStart),be.copy(this.pointEnd),zt.applyQuaternion(this._worldQuaternionInv),be.applyQuaternion(this._worldQuaternionInv),be.divide(zt),t.search("X")===-1&&(be.x=1),t.search("Y")===-1&&(be.y=1),t.search("Z")===-1&&(be.z=1);s.scale.copy(this._scaleStart).multiply(be),this.scaleSnap&&(t.search("X")!==-1&&(s.scale.x=Math.round(s.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),t.search("Y")!==-1&&(s.scale.y=Math.round(s.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),t.search("Z")!==-1&&(s.scale.z=Math.round(s.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(i==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const o=20/this.worldPosition.distanceTo(zt.setFromMatrixPosition(this.camera.matrixWorld));let l=!1;t==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(zt.copy(this.rotationAxis).cross(this.eye))*o):(t==="X"||t==="Y"||t==="Z")&&(this.rotationAxis.copy(nr[t]),zt.copy(nr[t]),n==="local"&&zt.applyQuaternion(this.worldQuaternion),zt.cross(this.eye),zt.length()===0?l=!0:this.rotationAngle=this._offset.dot(zt.normalize())*o),(t==="E"||l)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),n==="local"&&t!=="E"&&t!=="XYZE"?(s.quaternion.copy(this._quaternionStart),s.quaternion.multiply(vt.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),s.quaternion.copy(vt.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),s.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(Hs),this.dispatchEvent(ar)}}pointerUp(e){e!==null&&e.button!==0||(this.dragging&&this.axis!==null&&(or.mode=this.mode,this.dispatchEvent(or)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(e){return this.object=e,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(Hs),this.dispatchEvent(ar),this.pointStart.copy(this.pointEnd))}getRaycaster(){return Ie}getMode(){return this.mode}setMode(e){this.mode=e}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}setScaleSnap(e){this.scaleSnap=e}setSize(e){this.size=e}setSpace(e){this.space=e}}function ql(a){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:a.button};{const e=this.domElement.getBoundingClientRect();return{x:(a.clientX-e.left)/e.width*2-1,y:-(a.clientY-e.top)/e.height*2+1,button:a.button}}}function Gl(a){if(this.enabled)switch(a.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(a));break}}function Ql(a){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(a.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(a)),this.pointerDown(this._getPointer(a)))}function Kl(a){this.enabled&&this.pointerMove(this._getPointer(a))}function Jl(a){this.enabled&&(this.domElement.releasePointerCapture(a.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(a)))}function $s(a,e,t){const i=e.intersectObject(a,!0);for(let s=0;s<i.length;s++)if(i[s].object.visible||t)return i[s];return!1}const Qi=new so,gt=new Z(0,1,0),lr=new Z(0,0,0),cr=new It,Ki=new se,es=new se,ce=new Z,hr=new It,yi=new Z(1,0,0),Me=new Z(0,1,0),wi=new Z(0,0,1),Ji=new Z,mi=new Z,gi=new Z;class tc extends ns{constructor(e){super(),this.isTransformControlsRoot=!0,this.controls=e,this.visible=!1}updateMatrixWorld(e){const t=this.controls;t.object!==void 0&&(t.object.updateMatrixWorld(),t.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):t.object.parent.matrixWorld.decompose(t._parentPosition,t._parentQuaternion,t._parentScale),t.object.matrixWorld.decompose(t.worldPosition,t.worldQuaternion,t._worldScale),t._parentQuaternionInv.copy(t._parentQuaternion).invert(),t._worldQuaternionInv.copy(t.worldQuaternion).invert()),t.camera.updateMatrixWorld(),t.camera.matrixWorld.decompose(t.cameraPosition,t.cameraQuaternion,t._cameraScale),t.camera.isOrthographicCamera?t.camera.getWorldDirection(t.eye).negate():t.eye.copy(t.cameraPosition).sub(t.worldPosition).normalize(),super.updateMatrixWorld(e)}dispose(){this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})}}class ec extends ns{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const e=new Ai({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),t=new eo({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),i=e.clone();i.opacity=.15;const s=t.clone();s.opacity=.5;const n=e.clone();n.color.setHex(16711680);const r=e.clone();r.color.setHex(65280);const o=e.clone();o.color.setHex(255);const l=e.clone();l.color.setHex(16711680),l.opacity=.5;const c=e.clone();c.color.setHex(65280),c.opacity=.5;const u=e.clone();u.color.setHex(255),u.opacity=.5;const h=e.clone();h.opacity=.25;const p=e.clone();p.color.setHex(16776960),p.opacity=.25,e.clone().color.setHex(16776960);const g=e.clone();g.color.setHex(7895160);const m=new Bt(0,.04,.1,12);m.translate(0,.05,0);const b=new Dt(.08,.08,.08);b.translate(0,.04,0);const f=new ss;f.setAttribute("position",new En([0,0,0,1,0,0],3));const y=new Bt(.0075,.0075,.5,3);y.translate(0,.25,0);function v(L,W){const V=new ei(L,.0075,3,64,W*Math.PI*2);return V.rotateY(Math.PI/2),V.rotateX(Math.PI/2),V}function x(){const L=new ss;return L.setAttribute("position",new En([0,0,0,1,1,1],3)),L}const T={X:[[new it(m,n),[.5,0,0],[0,0,-Math.PI/2]],[new it(m,n),[-.5,0,0],[0,0,Math.PI/2]],[new it(y,n),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new it(m,r),[0,.5,0]],[new it(m,r),[0,-.5,0],[Math.PI,0,0]],[new it(y,r)]],Z:[[new it(m,o),[0,0,.5],[Math.PI/2,0,0]],[new it(m,o),[0,0,-.5],[-Math.PI/2,0,0]],[new it(y,o),null,[Math.PI/2,0,0]]],XYZ:[[new it(new Ii(.1,0),h.clone()),[0,0,0]]],XY:[[new it(new Dt(.15,.15,.01),u.clone()),[.15,.15,0]]],YZ:[[new it(new Dt(.15,.15,.01),l.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new it(new Dt(.15,.15,.01),c.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},A={X:[[new it(new Bt(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new it(new Bt(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new it(new Bt(.2,0,.6,4),i),[0,.3,0]],[new it(new Bt(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new it(new Bt(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new it(new Bt(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new it(new Ii(.2,0),i)]],XY:[[new it(new Dt(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new it(new Dt(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new it(new Dt(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]]},S={START:[[new it(new Ii(.01,2),s),null,null,null,"helper"]],END:[[new it(new Ii(.01,2),s),null,null,null,"helper"]],DELTA:[[new ye(x(),s),null,null,null,"helper"]],X:[[new ye(f,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new ye(f,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new ye(f,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},M={XYZE:[[new it(v(.5,1),g),null,[0,Math.PI/2,0]]],X:[[new it(v(.5,.5),n)]],Y:[[new it(v(.5,.5),r),null,[0,0,-Math.PI/2]]],Z:[[new it(v(.5,.5),o),null,[0,Math.PI/2,0]]],E:[[new it(v(.75,1),p),null,[0,Math.PI/2,0]]]},I={AXIS:[[new ye(f,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},k={XYZE:[[new it(new io(.25,10,8),i)]],X:[[new it(new ei(.5,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new it(new ei(.5,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new it(new ei(.5,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new it(new ei(.75,.1,2,24),i)]]},$={X:[[new it(b,n),[.5,0,0],[0,0,-Math.PI/2]],[new it(y,n),[0,0,0],[0,0,-Math.PI/2]],[new it(b,n),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new it(b,r),[0,.5,0]],[new it(y,r)],[new it(b,r),[0,-.5,0],[0,0,Math.PI]]],Z:[[new it(b,o),[0,0,.5],[Math.PI/2,0,0]],[new it(y,o),[0,0,0],[Math.PI/2,0,0]],[new it(b,o),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new it(new Dt(.15,.15,.01),u),[.15,.15,0]]],YZ:[[new it(new Dt(.15,.15,.01),l),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new it(new Dt(.15,.15,.01),c),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new it(new Dt(.1,.1,.1),h.clone())]]},E={X:[[new it(new Bt(.2,0,.6,4),i),[.3,0,0],[0,0,-Math.PI/2]],[new it(new Bt(.2,0,.6,4),i),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new it(new Bt(.2,0,.6,4),i),[0,.3,0]],[new it(new Bt(.2,0,.6,4),i),[0,-.3,0],[0,0,Math.PI]]],Z:[[new it(new Bt(.2,0,.6,4),i),[0,0,.3],[Math.PI/2,0,0]],[new it(new Bt(.2,0,.6,4),i),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new it(new Dt(.2,.2,.01),i),[.15,.15,0]]],YZ:[[new it(new Dt(.2,.2,.01),i),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new it(new Dt(.2,.2,.01),i),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new it(new Dt(.2,.2,.2),i),[0,0,0]]]},z={X:[[new ye(f,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new ye(f,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new ye(f,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function _(L){const W=new ns;for(const V in L)for(let st=L[V].length;st--;){const H=L[V][st][0].clone(),et=L[V][st][1],D=L[V][st][2],B=L[V][st][3],J=L[V][st][4];H.name=V,H.tag=J,et&&H.position.set(et[0],et[1],et[2]),D&&H.rotation.set(D[0],D[1],D[2]),B&&H.scale.set(B[0],B[1],B[2]),H.updateMatrix();const K=H.geometry.clone();K.applyMatrix4(H.matrix),H.geometry=K,H.renderOrder=1/0,H.position.set(0,0,0),H.rotation.set(0,0,0),H.scale.set(1,1,1),W.add(H)}return W}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=_(T)),this.add(this.gizmo.rotate=_(M)),this.add(this.gizmo.scale=_($)),this.add(this.picker.translate=_(A)),this.add(this.picker.rotate=_(k)),this.add(this.picker.scale=_(E)),this.add(this.helper.translate=_(S)),this.add(this.helper.rotate=_(I)),this.add(this.helper.scale=_(z)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(e){const i=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:es;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let s=[];s=s.concat(this.picker[this.mode].children),s=s.concat(this.gizmo[this.mode].children),s=s.concat(this.helper[this.mode].children);for(let n=0;n<s.length;n++){const r=s[n];r.visible=!0,r.rotation.set(0,0,0),r.position.copy(this.worldPosition);let o;if(this.camera.isOrthographicCamera?o=(this.camera.top-this.camera.bottom)/this.camera.zoom:o=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),r.scale.set(1,1,1).multiplyScalar(o*this.size/4),r.tag==="helper"){r.visible=!1,r.name==="AXIS"?(r.visible=!!this.axis,this.axis==="X"&&(vt.setFromEuler(Qi.set(0,0,0)),r.quaternion.copy(i).multiply(vt),Math.abs(gt.copy(yi).applyQuaternion(i).dot(this.eye))>.9&&(r.visible=!1)),this.axis==="Y"&&(vt.setFromEuler(Qi.set(0,0,Math.PI/2)),r.quaternion.copy(i).multiply(vt),Math.abs(gt.copy(Me).applyQuaternion(i).dot(this.eye))>.9&&(r.visible=!1)),this.axis==="Z"&&(vt.setFromEuler(Qi.set(0,Math.PI/2,0)),r.quaternion.copy(i).multiply(vt),Math.abs(gt.copy(wi).applyQuaternion(i).dot(this.eye))>.9&&(r.visible=!1)),this.axis==="XYZE"&&(vt.setFromEuler(Qi.set(0,Math.PI/2,0)),gt.copy(this.rotationAxis),r.quaternion.setFromRotationMatrix(cr.lookAt(lr,gt,Me)),r.quaternion.multiply(vt),r.visible=this.dragging),this.axis==="E"&&(r.visible=!1)):r.name==="START"?(r.position.copy(this.worldPositionStart),r.visible=this.dragging):r.name==="END"?(r.position.copy(this.worldPosition),r.visible=this.dragging):r.name==="DELTA"?(r.position.copy(this.worldPositionStart),r.quaternion.copy(this.worldQuaternionStart),zt.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),zt.applyQuaternion(this.worldQuaternionStart.clone().invert()),r.scale.copy(zt),r.visible=this.dragging):(r.quaternion.copy(i),this.dragging?r.position.copy(this.worldPositionStart):r.position.copy(this.worldPosition),this.axis&&(r.visible=this.axis.search(r.name)!==-1));continue}r.quaternion.copy(i),this.mode==="translate"||this.mode==="scale"?(r.name==="X"&&Math.abs(gt.copy(yi).applyQuaternion(i).dot(this.eye))>.99&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),r.name==="Y"&&Math.abs(gt.copy(Me).applyQuaternion(i).dot(this.eye))>.99&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),r.name==="Z"&&Math.abs(gt.copy(wi).applyQuaternion(i).dot(this.eye))>.99&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),r.name==="XY"&&Math.abs(gt.copy(wi).applyQuaternion(i).dot(this.eye))<.2&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),r.name==="YZ"&&Math.abs(gt.copy(yi).applyQuaternion(i).dot(this.eye))<.2&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1),r.name==="XZ"&&Math.abs(gt.copy(Me).applyQuaternion(i).dot(this.eye))<.2&&(r.scale.set(1e-10,1e-10,1e-10),r.visible=!1)):this.mode==="rotate"&&(Ki.copy(i),gt.copy(this.eye).applyQuaternion(vt.copy(i).invert()),r.name.search("E")!==-1&&r.quaternion.setFromRotationMatrix(cr.lookAt(this.eye,lr,Me)),r.name==="X"&&(vt.setFromAxisAngle(yi,Math.atan2(-gt.y,gt.z)),vt.multiplyQuaternions(Ki,vt),r.quaternion.copy(vt)),r.name==="Y"&&(vt.setFromAxisAngle(Me,Math.atan2(gt.x,gt.z)),vt.multiplyQuaternions(Ki,vt),r.quaternion.copy(vt)),r.name==="Z"&&(vt.setFromAxisAngle(wi,Math.atan2(gt.y,gt.x)),vt.multiplyQuaternions(Ki,vt),r.quaternion.copy(vt))),r.visible=r.visible&&(r.name.indexOf("X")===-1||this.showX),r.visible=r.visible&&(r.name.indexOf("Y")===-1||this.showY),r.visible=r.visible&&(r.name.indexOf("Z")===-1||this.showZ),r.visible=r.visible&&(r.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),r.material._color=r.material._color||r.material.color.clone(),r.material._opacity=r.material._opacity||r.material.opacity,r.material.color.copy(r.material._color),r.material.opacity=r.material._opacity,this.enabled&&this.axis&&(r.name===this.axis||this.axis.split("").some(function(l){return r.name===l}))&&(r.material.color.setHex(16776960),r.material.opacity=1)}super.updateMatrixWorld(e)}}class ic extends it{constructor(){super(new wr(1e5,1e5,2,2),new Ai({visible:!1,wireframe:!0,side:hn,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(e){let t=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(t="local"),Ji.copy(yi).applyQuaternion(t==="local"?this.worldQuaternion:es),mi.copy(Me).applyQuaternion(t==="local"?this.worldQuaternion:es),gi.copy(wi).applyQuaternion(t==="local"?this.worldQuaternion:es),gt.copy(mi),this.mode){case"translate":case"scale":switch(this.axis){case"X":gt.copy(this.eye).cross(Ji),ce.copy(Ji).cross(gt);break;case"Y":gt.copy(this.eye).cross(mi),ce.copy(mi).cross(gt);break;case"Z":gt.copy(this.eye).cross(gi),ce.copy(gi).cross(gt);break;case"XY":ce.copy(gi);break;case"YZ":ce.copy(Ji);break;case"XZ":gt.copy(gi),ce.copy(mi);break;case"XYZ":case"E":ce.set(0,0,0);break}break;case"rotate":default:ce.set(0,0,0)}ce.length()===0?this.quaternion.copy(this.cameraQuaternion):(hr.lookAt(zt.set(0,0,0),ce,gt),this.quaternion.setFromRotationMatrix(hr)),super.updateMatrixWorld(e)}}class bn{constructor(e,t,i,s,n,r=5,o=!0){C(this,"onDraggingStarted",new rt);C(this,"onDraggingEnded",new rt);C(this,"onDisposed",new rt);C(this,"normal");C(this,"origin");C(this,"three",new cn);C(this,"components");C(this,"world");C(this,"type","default");C(this,"_title","Clipping Plane");C(this,"_helper");C(this,"_visible",!0);C(this,"_enabled",!0);C(this,"_controlsActive",!1);C(this,"_arrowBoundBox",new it);C(this,"_planeMesh");C(this,"_controls");C(this,"_hiddenMaterial",new Ai({visible:!1}));C(this,"_visibilityBeforeDisabled",!0);C(this,"notifyManager",()=>{const e=this.components.get(Ce),t=e.list.getKey(this);t&&e.list.set(t,this)});C(this,"update",()=>{this._enabled&&this.three.setFromNormalAndCoplanarPoint(this.normal,this._helper.position)});C(this,"changeDrag",e=>{this._visible=!e.value,this.preventCameraMovement(),this.notifyDraggingChanged(e)});if(this.components=e,this.world=t,!t.renderer)throw new Error("The given world must have a renderer!");this.normal=s,this.origin=i,t.renderer.setPlane(!0,this.three),this._planeMesh=bn.newPlaneMesh(r,n),this._helper=this.newHelper(),this._controls=this.newTransformControls(),this.three.setFromNormalAndCoplanarPoint(s,i),o&&this.toggleControls(!0)}set title(e){this._title=e,this.notifyManager()}get title(){return this._title}get enabled(){return this._enabled}set enabled(e){if(!this.world.isDisposing){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");this._enabled=e,e?this.visible=this._visibilityBeforeDisabled:(this._visibilityBeforeDisabled=this.visible,this.visible=!1),this.world.renderer.setPlane(e,this.three),this.notifyManager()}}get visible(){return this._visible}set visible(e){this._visible=e,this._controls.getHelper().visible=e,this._helper.visible=e,this.toggleControls(e),this.notifyManager()}get meshes(){return[this._planeMesh,this._arrowBoundBox]}get planeMaterial(){return this._planeMesh.material}set planeMaterial(e){this._planeMesh.material=e}get size(){return this._planeMesh.scale.x}set size(e){this._planeMesh.scale.set(e,e,e)}get helper(){return this._helper}get controls(){return this._controls}setFromNormalAndCoplanarPoint(e,t){this.reset(),this.normal.equals(e)||(this.normal.copy(e),this._helper.lookAt(e)),this.origin.copy(t),this._helper.position.copy(t),this._helper.updateMatrix(),this.update()}dispose(){this._enabled=!1,this.onDraggingStarted.reset(),this.onDraggingEnded.reset(),this._helper.removeFromParent(),this.world.renderer&&this.world.renderer.setPlane(!1,this.three),this._arrowBoundBox.removeFromParent(),this._arrowBoundBox.geometry.dispose(),this._planeMesh.geometry.dispose(),this._controls.getHelper().removeFromParent(),this._controls.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}reset(){const e=new Z(1,0,0),t=new Z;this.normal.equals(e)||(this.normal.copy(e),this._helper.lookAt(e)),this.origin.copy(t),this._helper.position.copy(t),this._helper.updateMatrix()}toggleControls(e){if(e){if(this._controlsActive)return;this._controls.addEventListener("change",this.update),this._controls.addEventListener("dragging-changed",this.changeDrag)}else this._controls.removeEventListener("change",this.update),this._controls.removeEventListener("dragging-changed",this.changeDrag);this._controlsActive=e}newTransformControls(){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");const e=this.world.camera.three,t=this.world.renderer.three.domElement,i=new Wl(e,t);return this.initializeControls(i),this.world.scene.three.add(i.getHelper()),i}initializeControls(e){e.attach(this._helper),e.showX=!1,e.showY=!1,e.setSpace("local"),this.createArrowBoundingBox(),e.getHelper().children[0].children[0].add(this._arrowBoundBox)}createArrowBoundingBox(){this._arrowBoundBox.geometry=new Bt(.18,.18,1.2),this._arrowBoundBox.material=this._hiddenMaterial,this._arrowBoundBox.rotateX(Math.PI/2),this._arrowBoundBox.updateMatrix(),this._arrowBoundBox.geometry.applyMatrix4(this._arrowBoundBox.matrix)}notifyDraggingChanged(e){e.value?this.onDraggingStarted.trigger():this.onDraggingEnded.trigger()}preventCameraMovement(){this.world.camera.enabled=this._visible}newHelper(){const e=new ns;return e.lookAt(this.normal),e.position.copy(this.origin),this._planeMesh.position.z+=.01,e.add(this._planeMesh),this.world.scene.three.add(e),e}static newPlaneMesh(e,t){const i=new wr(1),s=new it(i,t);return s.scale.set(e,e,e),s}}class sc extends ws{constructor(){super(...arguments);C(this,"_config",{enabled:{value:!0,type:"Boolean"},visible:{value:!0,type:"Boolean"},color:{value:new $t,type:"Color"},opacity:{type:"Number",interpolable:!0,value:1,min:0,max:1},size:{type:"Number",interpolable:!0,value:2,min:0,max:100}})}get enabled(){return this._config.enabled.value}set enabled(t){this._config.enabled.value=t,this._component.enabled=t}get visible(){return this._config.visible.value}set visible(t){this._config.visible.value=t,this._component.visible=t}get color(){return this._config.color.value}set color(t){this._config.color.value=t,this._component.material.color.copy(t)}get opacity(){return this._config.opacity.value}set opacity(t){this._config.opacity.value=t,this._component.material.opacity=t}get size(){return this._config.size.value}set size(t){this._config.size.value=t,this._component.size=t}}const We=class We extends te{constructor(t){super(t);C(this,"onSetup",new rt);C(this,"onBeforeDrag",new rt);C(this,"onAfterDrag",new rt);C(this,"onBeforeCreate",new rt);C(this,"onBeforeCancel",new rt);C(this,"onAfterCancel",new rt);C(this,"onBeforeDelete",new rt);C(this,"onAfterCreate",new rt);C(this,"onAfterDelete",new rt);C(this,"onDisposed",new rt);C(this,"isSetup",!1);C(this,"orthogonalY",!1);C(this,"toleranceOrthogonalY",.7);C(this,"Type",bn);C(this,"list",new Vt);C(this,"config",new sc(this,this.components,"Clipper",We.uuid));C(this,"_defaultConfig",{color:new $t(12255487),opacity:.2,size:2});C(this,"_material",new Ai({color:12255487,side:hn,transparent:!0,opacity:.2}));C(this,"_size",5);C(this,"_enabled",!1);C(this,"_visible",!0);C(this,"onStateChanged",new rt);C(this,"_onStartDragging",()=>{this.onBeforeDrag.trigger()});C(this,"_onEndDragging",()=>{this.onAfterDrag.trigger()});this.components.add(We.uuid,this),this.setEvents()}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this.onStateChanged.trigger(["enabled"])}get visible(){return this._visible}set visible(t){this._visible=t;for(const[i,s]of this.list)s.visible=t;this.onStateChanged.trigger(["visibility"])}get material(){return this._material}set material(t){this._material=t;for(const[i,s]of this.list)s.planeMaterial=t;this.onStateChanged.trigger(["material"])}get size(){return this._size}set size(t){this._size=t;for(const[i,s]of this.list)s.size=t;this.onStateChanged.trigger(["size"])}setEvents(){this.list.onBeforeDelete.add(({value:t})=>{if(!t.world.renderer)throw new Error("Renderer not found for this plane's world!");t.world.renderer.setPlane(!1,t.three),t.dispose(),this.updateMaterialsAndPlanes(),this.onAfterDelete.trigger(t)})}dispose(){this._enabled=!1,this.components.get(Ci).list.delete(this.config.uuid),this.list.clear(),this._material.dispose(),this.onBeforeCreate.reset(),this.onBeforeCancel.reset(),this.onBeforeDelete.reset(),this.onBeforeDrag.reset(),this.onAfterCreate.reset(),this.onAfterCancel.reset(),this.onAfterDelete.reset(),this.onAfterDrag.reset(),this.onDisposed.trigger(We.uuid),this.onDisposed.reset()}async create(t){const n=await this.components.get(Ei).get(t).castRay();return n?this.createPlaneFromIntersection(t,n):null}createFromNormalAndCoplanarPoint(t,i,s){const n=this.newPlane(t,s,i);return this.updateMaterialsAndPlanes(),n}async delete(t,i){if(!i){const s=await this.pickPlane(t);if(!s)return;i=this.list.getKey(s)}i&&this.list.delete(i)}deleteAll(t){for(const[i,s]of this.list)(!t||t.has(s.type))&&this.list.delete(i)}setup(t){const i={...this._defaultConfig,...t};this.config.color=i.color,this.config.opacity=i.opacity,this.config.size=i.size,this.isSetup=!0,this.onSetup.trigger()}async pickPlane(t){const s=this.components.get(Ei).get(t),n=this.getAllPlaneMeshes(),r=await s.castRay({items:n});if(r){const o=r.object;return[...this.list.values()].find(l=>l.meshes.includes(o))}}getAllPlaneMeshes(){const t=[];for(const[i,s]of this.list)t.push(...s.meshes);return t}createPlaneFromIntersection(t,i){var c;if(!t.renderer)throw new Error("The given world must have a renderer!");const s=i.point.distanceTo(new Z(0,0,0)),n=i.normal||((c=i.face)==null?void 0:c.normal);if(!s||!n)return null;const r=this.getWorldNormal(i,n),o=this.newPlane(t,i.point,r.negate()),l=this.list.get(o);return l.visible=this._visible,l.size=this._size,t.renderer.setPlane(!0,l.three),this.updateMaterialsAndPlanes(),l}getWorldNormal(t,i){const s=t.object;let n=t.object.matrixWorld.clone();if(s instanceof ro&&t.instanceId!==void 0){const c=new It;s.getMatrixAt(t.instanceId,c),n=c.multiply(n)}const o=new no().getNormalMatrix(n),l=i.clone().applyMatrix3(o).normalize();return this.normalizePlaneDirectionY(l),l}normalizePlaneDirectionY(t){this.orthogonalY&&(t.y>this.toleranceOrthogonalY&&(t.x=0,t.y=1,t.z=0),t.y<-this.toleranceOrthogonalY&&(t.x=0,t.y=-1,t.z=0))}newPlane(t,i,s){const n=new this.Type(this.components,t,i,s,this._material);n.onDraggingStarted.add(this._onStartDragging),n.onDraggingEnded.add(this._onEndDragging);const r=Zt.create();return this.list.set(r,n),this.onAfterCreate.trigger(n),r}updateMaterialsAndPlanes(){const t=this.components.get(ls);for(const[i,s]of t.list){if(!s.renderer)continue;s.renderer.updateClippingPlanes();const{clippingPlanes:n}=s.renderer;for(const r of s.meshes)if(r.material)if(Array.isArray(r.material))for(const o of r.material)o.clippingPlanes=n;else r.material.clippingPlanes=n}}};C(We,"uuid","66290bc5-18c4-4cd1-9379-2e17a0617611");let Ce=We;class zr{constructor(e,t){C(this,"title");C(this,"guid",Zt.create());C(this,"clippingPlanes",new me);C(this,"camera",{aspect_ratio:1,field_of_view:60,camera_direction:{x:0,y:0,z:0},camera_view_point:{x:0,y:0,z:0},camera_up_vector:{x:0,y:1,z:0}});C(this,"customData",{});C(this,"exceptionComponents",new me);C(this,"selectionComponents",new me);C(this,"componentColors",new Vt);C(this,"spacesVisible",!1);C(this,"spaceBoundariesVisible",!1);C(this,"openingsVisible",!1);C(this,"defaultVisibility",!0);C(this,"snapshot",this.guid);C(this,"_components");C(this,"_world",null);C(this,"notifyUpdate",()=>{this._components.get(ne).list.set(this.guid,this)});this._components=e,t&&(this.guid=t.guid??this.guid,this.set(t)),this.setEvents()}async getSelectionMap(){return await this._components.get(ft).guidsToModelIdMap([...this.selectionComponents])}async getExceptionMap(){return await this._components.get(ft).guidsToModelIdMap([...this.exceptionComponents])}get projection(){return"field_of_view"in this.camera?"Perspective":"Orthographic"}get position(){const e=this._components.get(ft),{camera_view_point:t}=this.camera,{x:i,y:s,z:n}=t,r=new Z(i,s,n);return e.applyBaseCoordinateSystem(r,new It),r}set position(e){const t=e.clone(),i=this._components.get(ft);e.clone().applyMatrix4(i.baseCoordinationMatrix.clone().invert()),this.camera.camera_view_point={x:t.x,y:t.y,z:t.z}}get direction(){const{camera_direction:e}=this.camera,{x:t,y:i,z:s}=e;return new Z(t,i,s)}set world(e){this._world=e}get world(){return this._world}get _managerVersion(){return this._components.get(Ot).config.version}get topics(){return[...this._components.get(Ot).list.values()].filter(s=>s.viewpoints.has(this.guid))}setEvents(){this.selectionComponents.onUpdated.add(this.notifyUpdate),this.exceptionComponents.onUpdated.add(this.notifyUpdate),this.clippingPlanes.onUpdated.add(this.notifyUpdate),this.componentColors.onItemSet.add(this.notifyUpdate),this.componentColors.onItemDeleted.add(this.notifyUpdate),this.componentColors.onItemUpdated.add(this.notifyUpdate),this.componentColors.onCleared.add(this.notifyUpdate)}set(e){this.title=e.title;const{components:t,perspective_camera:i,orthogonal_camera:s,clipping_planes:n}=e;if(t){const{selection:r,visibility:o,coloring:l}=t;if(r){this.selectionComponents.clear();for(const{ifc_guid:c}of r)c&&this.selectionComponents.add(c)}if(o){const{default_visibility:c,exceptions:u,view_setup_hints:h}=o;if(c!==void 0&&(this.defaultVisibility=c),u){this.exceptionComponents.clear();for(const{ifc_guid:p}of u)p&&this.exceptionComponents.add(p)}if(h){const{spaces_visible:p,space_boundaries_visible:d,openings_visible:g}=h;p!==void 0&&(this.spacesVisible=p),d!==void 0&&(this.spaceBoundariesVisible=d),g!==void 0&&(this.openingsVisible=g)}}if(l){this.componentColors.clear();for(const c of l){const{color:u,components:h}=c,p=h.map(d=>d.ifc_guid).filter(d=>d!==null);this.componentColors.set(u,p)}}}if((i||s)&&(this.camera=i??s),n&&this.world){const r=this._components.get(Ce);for(const o of n){const{location:l,direction:c}=o,u=new Z(l.x,l.z,-l.y),h=new Z(c.x,c.z,-c.y),p=r.createFromNormalAndCoplanarPoint(this.world,h,u);this.clippingPlanes.add(p),r.list.get(p).enabled=!1,r.list.get(p).visible=!1}}this.notifyUpdate()}async go(e){if(!this.world)return;const{camera:t}=this.world;if(!(t instanceof Zl))throw new Error("Viewpoint: the world's camera component must be of type OrthoPerspectiveCamera to switch between perspective and orthographic projections.");const{transition:i,applyClippings:s,applyVisibility:n,clippingsVisibility:r}={transition:!0,applyClippings:!0,applyVisibility:!0,clippingsVisibility:!0,...e};t.projection.set(this.projection);const o=new Z(this.camera.camera_view_point.x,this.camera.camera_view_point.y,this.camera.camera_view_point.z),l=new Z(this.camera.camera_direction.x,this.camera.camera_direction.y,this.camera.camera_direction.z);if(o.equals(new Z)&&l.equals(new Z))return;const c=this.position,u=this.direction,h=80,p={x:c.x+u.x*h,y:c.y+u.y*h,z:c.z+u.z*h},d=[];s&&this.setClippingState(!0),n&&d.push(this.applyVisibility()),this.setClippingVisibility(r),d.push(t.controls.setLookAt(c.x,c.y,c.z,p.x,p.y,p.z,i)),await Promise.all(d)}async updateCamera(e=!0){return new Promise(t=>{if(!this.world){t(!1);return}const{camera:i,renderer:s}=this.world;if(!s)throw new Error("Viewpoint: the world needs to have a renderer!");if(!i.hasCameraControls())throw new Error("Viewpoint: world's camera need camera controls!");const n=new Z;i.controls.getPosition(n);const r=i.three,o=new Z(0,0,-1).applyEuler(r.rotation),{width:l,height:c}=s.getSize();let u=l/c;Number.isNaN(u)&&(u=1);const h=this._components.get(ft);n.applyMatrix4(h.baseCoordinationMatrix.clone().invert());const p={aspect_ratio:u,camera_view_point:{x:n.x,y:n.y,z:n.z},camera_direction:{x:o.x,y:o.y,z:o.z},camera_up_vector:{x:0,y:1,z:0}};if(r instanceof _r?this.camera={...p,field_of_view:r.fov}:r instanceof ln&&(this.camera={...p,view_to_world_scale:r.top-r.bottom}),e){const d=this._components.get(ne),g=s.three.domElement;s.three.render(this.world.scene.three,i.three),g.toBlob(async m=>{if(m){const b=await m.arrayBuffer(),f=new Uint8Array(b);d.snapshots.set(this.guid,f)}this.notifyUpdate(),t(!0)})}else this.notifyUpdate(),t(!0)})}takeSnapshot(){return new Promise(e=>{if(!this.world){e(!1);return}const{camera:t,renderer:i}=this.world;if(!i)throw new Error("Viewpoint: the world needs to have a renderer!");const s=this._components.get(ne),n=i.three.domElement;i.three.render(this.world.scene.three,t.three),n.toBlob(async r=>{if(r){const o=await r.arrayBuffer(),l=new Uint8Array(o);s.snapshots.set(this.guid,l)}this.notifyUpdate(),e(!0)})})}updateClippingPlanes(){this.clippingPlanes.clear();const e=this._components.get(Ce);for(const[t,i]of e.list)i.enabled&&this.clippingPlanes.add(t)}async applyVisibility(){const e=this._components.get(js);e.set(this.defaultVisibility);const t=await this.getExceptionMap();e.set(!this.defaultVisibility,t);const i=await this.getSelectionMap();e.set(!0,i)}async setColorizationState(e){const t=this._components.get(ft),i=[];if(e)for(const[s,n]of this.componentColors){const r=`#${s}`,o=await t.guidsToModelIdMap(n);for(const[l,c]of Object.entries(o)){const u=t.list.get(l);u&&i.push(u.highlight([...c],{customId:r,color:new $t(r),renderedFaces:oo.ONE,opacity:1,transparent:!1}))}}else for(const[s,n]of this.componentColors){const r=await t.guidsToModelIdMap(n);for(const[o,l]of Object.entries(r)){const c=t.list.get(o);c&&i.push(c.resetHighlight([...l]))}}i.push(t.core.update(!0)),await Promise.all(i)}setClippingState(e){const t=this._components.get(Ce);for(const[i,s]of t.list)s.enabled=e&&this.clippingPlanes.has(i)}setClippingVisibility(e){const t=this._components.get(Ce);for(const i of this.clippingPlanes){const s=t.list.get(i);s&&(s.visible=e)}}async createComponentTags(e){var n;const t=this._components.get(ft),i=this._components.get(Ot);let s="";if(i.config.includeSelectionTag){const r=e==="selection"?await this.getSelectionMap():await this.getExceptionMap();for(const o in r){const l=t.list.get(o);if(!l)continue;const c=r[o];for(const u of c){const h=l.getItem(u),p=await h.getGuid();if(!p)continue;const d=(n=await h.getAttributes())==null?void 0:n.getValue("Tag");let g=null;d&&(g=`AuthoringToolId="${d}"`),s+=`
<Component IfcGuid="${p}" ${g??""} />`}}}else s=[...this.selectionComponents].map(r=>`<Component IfcGuid="${r}" />`).join(`
`);return s}createColorTags(){let e="";for(const[t,i]of this.componentColors.entries()){const s=i.map(n=>`
<Component IfcGuid="${n}" />`).join(`
`);e+=`<Color Color="${t}">
${s}
</Color>`}return e.length!==0?`<Coloring>
${e}
</Coloring>`:"<Coloring />"}toJSON(){const e=this._components.get(Ce),t={guid:this.guid,components:{selection:[...this.selectionComponents].map(n=>({ifc_guid:n,authoring_tool_id:null})),coloring:[...this.componentColors].map(([n,r])=>({color:n,components:r.map(o=>({ifc_guid:o,authoring_tool_id:null}))})),visibility:{default_visibility:this.defaultVisibility,exceptions:[...this.exceptionComponents].map(n=>({ifc_guid:n,authoring_tool_id:null})),view_setup_hints:{spaces_visible:this.spacesVisible,space_boundaries_visible:this.spaceBoundariesVisible,openings_visible:this.openingsVisible}}},clipping_planes:[...this.clippingPlanes].map(n=>{const r=e.list.get(n);if(!r)return null;const o=r._controls.worldPosition??r.origin,{normal:l}=r;return{location:{x:o.x,y:-o.z,z:o.y},direction:{x:l.x,y:-l.z,z:l.y}}}).filter(n=>n!==null)};"field_of_view"in this.camera?t.perspective_camera=this.camera:t.orthogonal_camera=this.camera;const i=this._components.get(ne),s=i.snapshots.get(this.snapshot);if(s){const n=s.toString(),r=btoa(n),o=i.getSnapshotExtension(this.snapshot);t.snapshot={snapshot_type:o,snapshot_data:r}}return t}async serialize(e=this._managerVersion){const t=this._components.get(ft),i=this.position;i.applyMatrix4(t.baseCoordinationMatrix.clone().invert());const s=this.direction;s.normalize();const n=new It().makeRotationX(Math.PI/2),r=s.clone().applyMatrix4(n);r.normalize();const o=`<CameraViewPoint>
      <X>${i.x}</X>
      <Y>${-i.z}</Y>
      <Z>${i.y}</Z>
    </CameraViewPoint>`,l=`<CameraDirection>
      <X>${s.x}</X>
      <Y>${-s.z}</Y>
      <Z>${s.y}</Z>
    </CameraDirection>`,c=`<CameraUpVector>
      <X>${r.x}</X>
      <Y>${-r.z}</Y>
      <Z>${r.y}</Z>
    </CameraUpVector>`,u=`<AspectRatio>${this.camera.aspect_ratio}</AspectRatio>`;let h="";"view_to_world_scale"in this.camera?h=`<OrthogonalCamera>
        ${o}
        ${l}
        ${c}
        ${u}
        <ViewToWorldScale>${this.camera.view_to_world_scale}</ViewToWorldScale>
      </OrthogonalCamera>`:"field_of_view"in this.camera&&(h=`<PerspectiveCamera>
        ${o}
        ${l}
        ${c}
        ${u}
        <FieldOfView>${this.camera.field_of_view}</FieldOfView>
      </PerspectiveCamera>`);const p=`<ViewSetupHints SpacesVisible="${this.spacesVisible??!1}" SpaceBoundariesVisible="${this.spaceBoundariesVisible??!1}" OpeningsVisible="${this.openingsVisible??!1}" />`,d=(await this.createComponentTags("selection")).trim(),g=(await this.createComponentTags("exception")).trim(),m=this.createColorTags();return`<?xml version="1.0" encoding="UTF-8"?>
    <VisualizationInfo Guid="${this.guid}">
      <Components>
        ${e==="2.1"?p:""}
        ${d.length!==0?`<Selection>${d}</Selection>`:""}
        <Visibility DefaultVisibility="${this.defaultVisibility}">
          ${e==="3"?p:""}
          ${g.length!==0?`<Exceptions>${g}</Exceptions>`:""}
        </Visibility>
        ${m}
      </Components>
      ${h}
    </VisualizationInfo>`}}class nc extends ws{constructor(){super(...arguments);C(this,"_config",{overwriteColors:{value:!1,type:"Boolean"}})}get overwriteColors(){return this._config.overwriteColors.value}set overwriteColors(t){this._config.overwriteColors.value=t}}const Ti=class Ti extends te{constructor(t){super(t);C(this,"enabled",!0);C(this,"world",null);C(this,"list",new Vt);C(this,"snapshots",new Vt);C(this,"isSetup",!1);C(this,"onSetup",new rt);C(this,"config",new nc(this,this.components,"Viewpoints",Ti.uuid));C(this,"onDisposed",new rt);t.add(Ti.uuid,this)}create(t){const i=new zr(this.components,t);return i.world=this.world,t||this.list.set(i.guid,i),i}getSnapshotExtension(t){let i="jpeg";const s=this.snapshots.get(t);if(!s)return i;const n=s.subarray(0,4);let r="";for(let o=0;o<n.length;o++)r+=n[o].toString(16);return r.startsWith("89504e47")&&(i="png"),r.startsWith("ffd8ffe")&&(i="jpeg"),i}setup(){}dispose(){this.list.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}};C(Ti,"uuid","ee867824-a796-408d-8aa0-4e5962a83c66");let ne=Ti;class Qe{constructor(e){C(this,"cardinality","required");C(this,"instructions");C(this,"evalRequirement",(e,t,i,s)=>{const n={parameter:i,currentValue:e,requiredValue:t,pass:!1};s&&this.addCheckResult(n,s);let r=!1;if(t.type==="simple"&&(r=e===t.parameter),t.type==="enumeration"&&(r=t.parameter.includes(e)),t.type==="pattern"&&(r=new RegExp(t.parameter).test(String(e))),t.type==="length"){const{min:o,length:l,max:c}=t.parameter;l!==void 0&&(r=String(e).length===l),o!==void 0&&(r=String(e).length>=o),c!==void 0&&(r=String(e).length<=c)}if(t.type==="bounds"&&typeof e=="number"){const{min:o,minInclusive:l,max:c,maxInclusive:u}=t.parameter;let h=!0,p=!0;o!==void 0&&(h=l?e>=o:e>o),c!==void 0&&(p=u?e<=c:e<c),r=h&&p}return this.cardinality==="prohibited"&&(r=!r),this.cardinality==="optional"&&(r=!0),n.pass=r,n.pass});this._components=e}addCheckResult(e,t){const i=t.findIndex(({parameter:s})=>s===e.parameter);i!==-1?t[i]=e:t.push(e)}getItemChecks(e,t,i,s){if(!("value"in i._localId&&typeof i._localId.value=="number"))return null;let n=e.get(t);n||(n=new Vt,e.set(t,n));let r=n.get(i._localId.value);if(r&&s&&!r.pass)return null;if(!r){const c=[];r={guid:Array.isArray(i._guid)?void 0:i._guid.value,pass:!1,checks:c},Object.defineProperty(r,"pass",{get:()=>c.every(({pass:u})=>u)}),n.set(i._localId.value,r)}const o=[],l={facetType:this.facetType,cardinality:this.cardinality,checks:o,pass:!1};return Object.defineProperty(l,"pass",{get:()=>o.every(({pass:c})=>c)}),r.checks.push(l),l.checks}}const de=(a,e)=>{let t="";if(!e)return t;if(e.type==="simple"&&(t=`<simpleValue>${e.parameter}</simpleValue>`),e.type==="enumeration"&&(t=`<xs:restriction base="xs:string">
    ${e.parameter.map(n=>`<xs:enumeration value="${n}" />`).join(`
`)}
    </xs:restriction>`),e.type==="pattern"&&(t=`<xs:restriction base="xs:string">
      <xs:pattern value="${e.parameter}" />
    </xs:restriction>`),e.type==="bounds"){const{min:s,minInclusive:n,max:r,maxInclusive:o}=e.parameter;let l="";s!==void 0&&(l=`<xs:min${n?"Inclusive":"Exclusive"} value="${s}">`);let c="";r!==void 0&&(c=`<xs:max${o?"Inclusive":"Exclusive"} value="${r}">`),t=`<xs:restriction base="xs:double">
      ${l}
      ${c}
    </xs:restriction>`}if(e.type==="length"){const{length:s,min:n,max:r}=e.parameter;let o="";s!==void 0&&n===void 0&&r===void 0&&(o=`<xs:length value="${s}" />`);let l="";n!==void 0&&s===void 0&&(l=`<xs:minLength value="${n}" />`);let c="";r!==void 0&&s===void 0&&(c=`<xs:maxLength value="${r}" />`),t=`<xs:restriction base="xs:string">
      ${o}
      ${l}
      ${c}
    </xs:restriction>`}return`<${a[0].toLowerCase()+a.slice(1)}>
    ${t}
  </${a[0].toLowerCase()+a.slice(1)}>`};class rc extends Qe{constructor(t,i){super(t);C(this,"facetType","Attribute");C(this,"name");C(this,"value");this.name=i}serialize(t){const i=de("Name",this.name),s=de("Value",this.value);let n="";return t==="requirement"&&(n+=`cardinality="${this.cardinality}"`,n+=this.instructions?`instructions="${this.instructions}"`:""),`<attribute ${n}>
  ${i}
  ${s}
</attribute>`}async getEntities(){}async test(t,i,s={skipIfFails:!0}){const n=this._components.get(ft);for(const[r,o]of Object.entries(t)){const l=n.list.get(r);if(!l)continue;const c=await l.getItemsData([...o]);for(const u of c){const h=this.getItemChecks(i,r,u,s.skipIfFails);if(!h)continue;const d=Object.keys(u).filter(m=>{const b=this.evalRequirement(m,this.name,"Name");if(!b)return!1;const f=u[m];return Array.isArray(f)?!0:f===null||f.value===null?this.cardinality==="optional"||this.cardinality==="prohibited":Array.isArray(f.value)&&f.value.length===0||typeof f.value=="string"&&f.value.trim()===""?!1:b}),g=d.length>0;if(h.push({parameter:"Name",currentValue:g?d[0]:null,requiredValue:this.name,pass:this.cardinality==="prohibited"?!g:g}),this.value)if(d[0]){const m=u[d[0]];Array.isArray(m)?h.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:this.cardinality==="prohibited"}):Array.isArray(m.value)?h.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:this.cardinality==="prohibited"}):this.evalRequirement(m.value,this.value,"Value",h)}else h.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:this.cardinality==="prohibited"})}}}}class oc extends Qe{constructor(t,i){super(t);C(this,"facetType","Classification");C(this,"system");C(this,"value");C(this,"uri");this.system=i}serialize(t){const i=de("System",this.system),s=de("Value",this.value);let n="";return t==="requirement"&&(n+=`cardinality="${this.cardinality}"`,n+=this.uri?`uri=${this.uri}`:"",n+=this.instructions?`instructions="${this.instructions}"`:""),`<classification ${n}>
  ${i}
  ${s}
</classification>`}async getEntities(t,i){}async test(t,i){}}class rn extends Qe{constructor(t,i){super(t);C(this,"facetType","Entity");C(this,"name");C(this,"predefinedType");this.name=i}serialize(t){const i=de("Name",this.name),s=de("Name",this.predefinedType);let n="";return t==="requirement"&&(n+=`cardinality="${this.cardinality}"`,n+=this.instructions?`instructions="${this.instructions}"`:""),`<entity ${n}>
  ${i}
  ${s}
</entity>`}async getEntities(t,i){const s=this._components.get(ft),n=new Map;for(const[o,l]of s.list){if(!t.find(h=>h.test(o)))continue;const u=await l.getCategories();for(const h of u){if(!await this.evalName(h))continue;let d=n.get(o);d||(d=[],n.set(o,d)),d.push(h)}}const r={};if(await Promise.all(Array.from(n.entries()).map(async([o,l])=>{const c=s.list.get(o);if(!c)return;const u=l.map(d=>new RegExp(`^${d}$`)),h=await c.getItemsOfCategories(u),p=Object.values(h).flat();r[o]=new Set(p)})),!this.predefinedType){ue.add(i,r);return}for(const[o,l]of Object.entries(r)){const c=s.list.get(o);if(!c)continue;const u=await c.getItemsData([...l]);for(const h of u){if(!("value"in h._localId))continue;await this.evalPredefinedType(o,h)&&ue.append(i,o,h._localId.value)}}}async test(t,i,s){const n=this._components.get(ft);for(const[r,o]of Object.entries(t)){const l=n.list.get(r);if(!l)continue;const c=await l.getItemsData([...o]);for(const u of c){if(!("value"in u._category))continue;const h=this.getItemChecks(i,r,u,s.skipIfFails);h&&(await this.evalName(u._category.value,h),await this.evalPredefinedType(r,u,h))}}}async evalName(t,i){return this.evalRequirement(t,this.name,"Name",i)}async evalPredefinedType(t,i,s){if(!this.predefinedType||!("value"in i.PredefinedType))return null;const n=typeof this.predefinedType.parameter=="string"&&this.predefinedType.parameter==="USERDEFINED";let r=i.PredefinedType.value;if(r==="USERDEFINED"&&!n){const c=Object.keys(i).find(u=>/^((?!Predefined).)*Type$/.test(u));if(c){const u=i[c];"value"in u&&(r=u.value)}else r="USERDEFINED"}if(!r){const c=this._components.get(ft).list.get(t);if(c&&"value"in i._localId){const[u]=await c.getItemsData([i._localId.value],{relations:{IsTypedBy:{attributes:!0,relations:!1}}});if(Array.isArray(u.IsTypedBy)){const h=u.IsTypedBy[0];if(h&&"value"in h.PredefinedType&&(r=h.PredefinedType.value,r==="USERDEFINED"&&!n)){const d=Object.keys(h).find(g=>/^((?!Predefined).)*Type$/.test(g));if(d){const g=h[d];"value"in g&&(r=g.value)}else r="USERDEFINED"}}}}return this.evalRequirement(r,this.predefinedType,"PredefinedType",s)}}class ac extends Qe{constructor(t,i,s){super(t);C(this,"facetType","Property");C(this,"propertySet");C(this,"baseName");C(this,"value");C(this,"dataType");C(this,"uri");C(this,"_unsupportedTypes",["IFCCOMPLEXPROPERTY","IFCPHYSICALCOMPLEXQUANTITY"]);this.propertySet=i,this.baseName=s}serialize(t){const i=de("PropertySet",this.propertySet),s=de("BaseName",this.baseName),n=de("Value",this.value),r=this.dataType?`dataType=${this.dataType}`:"";let o="";return t==="requirement"&&(o+=`cardinality="${this.cardinality}"`,o+=this.uri?`uri=${this.uri}`:"",o+=this.instructions?`instructions="${this.instructions}"`:""),`<property ${r} ${o}>
  ${i}
  ${s}
  ${n}
</property>`}async getEntities(t,i){const s=this._components.get(ft);for(const[n,r]of s.list){if(!t.find(h=>h.test(n)))continue;const l=await r.getItemsOfCategories([/PROPERTYSET/,/ELEMENTQUANTITY/]),c=Object.values(l).flat();if(c.length===0)continue;const u=await r.getItemsData(c,{relations:{HasProperties:{attributes:!0,relations:!1},DefinesOcurrence:{attributes:!0,relations:!1}}});for(const h of u){if(!("value"in h._localId&&"value"in h._category&&"value"in h.Name&&Array.isArray(h.DefinesOcurrence))||!this.evalRequirement(h.Name.value,this.propertySet,"PropertySet"))continue;let d;if(h._category.value==="IFCPROPERTYSET"&&(d="HasProperties"),h._category.value==="IFCELEMENTQUANTITY"&&(d="Quantities"),!d)continue;const g=h[d];if(Array.isArray(g))for(const m of g){const b=Object.keys(m),f=b.find(T=>/Name/.test(T));if(!(f&&"value"in m[f]))continue;const y=m[f];if(!("value"in y)||!this.evalRequirement(y.value,this.baseName,"BaseName"))continue;if(this.value){const T=b.find(M=>/Value/.test(M));if(!T)continue;const A=m[T];if(!("value"in A)||!this.evalRequirement(A.value,this.value,"Value"))continue}const x=h.DefinesOcurrence.map(T=>"value"in T._localId&&typeof T._localId.value=="number"?T._localId.value:null).filter(T=>T!==null);ue.append(i,n,...x)}}}}async test(t,i,s={skipIfFails:!0}){const n=this._components.get(ft);for(const[r,o]of Object.entries(t)){const l=n.list.get(r);if(!l)continue;const c=await l.getItemsData([...o],{relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1},HasPropertySets:{attributes:!0,relations:!0},DefinesOcurrence:{attributes:!1,relations:!1}}});for(const u of c){const h=this.getItemChecks(i,r,u,s.skipIfFails);if(!h)continue;const d=(await this.getPsets(u)).filter(g=>!("value"in g.Name)||!this.evalRequirement(g.Name.value,this.propertySet,"PropertySet")?!1:(h.push({currentValue:g.Name.value,parameter:"PropertySet",pass:!0,requiredValue:this.propertySet}),!0));if(d.length===0){h.push({currentValue:null,parameter:"PropertySet",pass:!1,requiredValue:this.propertySet});continue}for(const g of d){const m=this.getPropertyListName(g);if(!m)continue;const b=g[m];if(!Array.isArray(b)){h.push({currentValue:null,parameter:"BaseName",pass:!1,requiredValue:this.baseName});continue}const f=b.filter(y=>!("value"in y._category&&"value"in y.Name)||this._unsupportedTypes.includes(y._category.value)||!this.evalRequirement(y.Name.value,this.baseName,"BaseName")?!1:(h.push({currentValue:y.Name.value,parameter:"BaseName",pass:!0,requiredValue:this.baseName}),!0));if(f.length===0){h.push({currentValue:null,parameter:"BaseName",pass:!1,requiredValue:this.baseName});continue}for(const y of f)this.evalValue(y,h),this.evalDataType(y,h),this.evalURI()}}}}getPropertyListName(t){let i;return"value"in t._category&&(t._category.value==="IFCPROPERTYSET"&&(i="HasProperties"),t._category.value==="IFCELEMENTQUANTITY"&&(i="Quantities")),i}getValueKey(t){return Object.keys(t).find(i=>/Value/.test(i)||/Values/.test(i))}getTypePsets(t){if(!Array.isArray(t.IsTypedBy))return[];const[i]=t.IsTypedBy;return i&&Array.isArray(i.HasPropertySets)?i.HasPropertySets:[]}async getPsets(t){const i=this.getTypePsets(t);if(!Array.isArray(t.IsDefinedBy))return i;const s=[];for(const n of t.IsDefinedBy){if(!("value"in n.Name))continue;const r=n.Name.value,o=this.getPropertyListName(n);if(!(r&&o))continue;const l=i.find(c=>"value"in c.Name?c.Name.value===r:!1);if(l&&Array.isArray(l.HasProperties)&&Array.isArray(n.HasProperties))for(const c of l.HasProperties){if(!("value"in c.Name))continue;const u=c.Name.value;n.HasProperties.find(p=>"value"in p.Name?p.Name.value===u:!1)||n.HasProperties.push(c)}s.push(n)}return s}evalValue(t,i){const s=this.getValueKey(t),n=t[s];if(!("value"in n))return!1;if(this.value){if(!s)return i==null||i.push({parameter:"Value",currentValue:null,pass:!1,requiredValue:this.value}),!1;const r=structuredClone(this.value);return n.type==="IFCLABEL"&&r.type==="simple"&&(r.parameter=String(r.parameter)),this.evalRequirement(n.value,r,"Value",i)}return s&&typeof n.value=="string"&&n.value.trim()===""?(i==null||i.push({parameter:"Value",currentValue:"",pass:!1,requiredValue:this.value}),!1):!0}evalDataType(t,i){if(!this.dataType)return!0;const s=this.getValueKey(t);if(!(s&&"value"in t[s]))return i==null||i.push({parameter:"DataType",currentValue:null,pass:!1,requiredValue:this.dataType}),!1;const n=t[s];return this.evalRequirement(n.type??null,{type:"simple",parameter:this.dataType},"DataType",i)}evalURI(){return!0}}class lc extends Qe{constructor(){super(...arguments);C(this,"_ifcMaterialEntities",[/^IFCMATERIALLAYERSETUSAGE$/,/^IFCMATERIALCONSTITUENTSET$/,/^IFCMATERIAL$/,/^IFCMATERIALLIST$/]);C(this,"facetType","Material");C(this,"value");C(this,"uri")}serialize(t){if(!(this.value&&this.uri))return"<material />";const i=de("Value",this.value);let s="";return t==="requirement"&&(s+=`cardinality="${this.cardinality}"`,s+=this.uri?`uri=${this.uri}`:"",s+=this.instructions?`instructions="${this.instructions}"`:""),`<material ${s}>
  ${i}
</material>`}async getEntities(t,i){const s=this._components.get(ft);for(const[n,r]of s.list){if(!t.find(h=>h.test(n)))continue;const l=await r.getItemsOfCategories(this._ifcMaterialEntities),c=Object.values(l).flat();if(c.length===0)continue;const u=await r.getItemsData(c,{relations:{AssociatedTo:{attributes:!0,relations:!1},MaterialConstituents:{attributes:!0,relations:!0},ForLayerSet:{attributes:!0,relations:!0},MaterialLayers:{attributes:!0,relations:!0},Materials:{attributes:!0,relations:!1}}});for(const h of u){if(!("value"in h._localId&&"value"in h._category&&Array.isArray(h.AssociatedTo))||!this.hasValidMaterial(h))continue;const d=h.AssociatedTo.map(g=>"value"in g._localId&&g._localId.value?g._localId.value:null).filter(g=>g!==null);ue.append(i,n,...d)}}}async test(t,i,s={skipIfFails:!0}){const n=this._components.get(ft);for(const[r,o]of Object.entries(t)){const l=n.list.get(r);if(!l)continue;const c=await l.getItemsData([[...o][0]],{relations:{AssociatedTo:{attributes:!1,relations:!1},HasAssociations:{attributes:!0,relations:!0},MaterialConstituents:{attributes:!0,relations:!0},ForLayerSet:{attributes:!0,relations:!0},MaterialLayers:{attributes:!0,relations:!0},Materials:{attributes:!0,relations:!1}}});for(const u of c){const h=this.getItemChecks(i,r,u,s.skipIfFails);if(h){if(!Array.isArray(u.HasAssociations)){h.push({parameter:null,currentValue:null,requiredValue:this.value,pass:!1});continue}for(const p of u.HasAssociations){if(!this._ifcMaterialEntities.some(g=>"value"in p._category?g.test(p._category.value):!1))continue;if(this.hasValidMaterial(p,h))break}}}}}hasValidMaterial(t,i){let s=!1;if("value"in t._category&&t._category.value==="IFCMATERIAL")this.evalValue(t,i)&&(s=!0);else for(const[n,r]of Object.entries(t))if(["ForLayerSet","MaterialLayers","Material","MaterialConstituents","Materials"].includes(n)&&Array.isArray(r)){for(const o of r)if("value"in o._category&&o._category.value==="IFCMATERIAL"){if(this.evalValue(o,i)){s=!0;break}}else if(this.hasValidMaterial(o)){s=!0;break}}return s}evalValue(t,i){if(!this.value)return i==null||i.push({parameter:null,currentValue:t.Name&&"value"in t.Name?t.Name.value:null,pass:!0}),!0;if(!("value"in t._category&&t._category.value==="IFCMATERIAL"))return null;let s=!1;return t.Name&&"value"in t.Name&&(s=this.evalRequirement(t.Name.value,this.value,"Value",i)),s||(t.Category&&"value"in t.Category&&(s=this.evalRequirement(t.Category.value,this.value,"Value",i)),s)}}class cc extends Qe{constructor(t,i){super(t);C(this,"facetType","PartOf");C(this,"_entityFacet");C(this,"_entity");C(this,"relation");C(this,"cardinality","required");this._entity=i,this._entityFacet=new rn(t,i.name),this._entityFacet.predefinedType=i.predefinedType}set entity(t){this._entity=t;const{name:i,predefinedType:s}=t;this._entityFacet=new rn(this._components,i),this._entityFacet.predefinedType=s}get entity(){return this._entity}serialize(){return""}async getEntities(t,i){}async test(t){}}class hc{constructor(e,t,i){C(this,"name");C(this,"ifcVersion",new Set);C(this,"identifier",Zt.create());C(this,"description");C(this,"instructions");C(this,"requirementsDescription");C(this,"applicability",new me);C(this,"requirements",new me);C(this,"components");this.components=e,this.name=t;for(const s of i)this.ifcVersion.add(s)}set(e){const t=e,i=this;for(const n in e){if(n==="identifier")continue;const r=t[n];n in this&&(i[n]=r)}return this.components.get(on).list.set(this.identifier,this),this}async test(e,t={skipIfFails:!0}){const i=new Vt;if(this.requirements.size===0)return i;const s={},n=[];for(const o of this.applicability)n.push(o.getEntities(e,s));await Promise.all(n);const r=[];for(const o of this.requirements)r.push(o.test(s,i,t));return await Promise.all(r),i}serialize(){const e=`name="${this.name}"`,t=this.identifier?`identifier="${this.identifier}"`:"",i=this.description?`description="${this.description}"`:"",s=this.instructions?`instructions="${this.instructions}"`:"";return`<specification ifcVersion="${[...this.ifcVersion].join(" ")}" ${e} ${t} ${i} ${s}>
      <applicability minOccurs="1" maxOccurs="unbounded">
        ${[...this.applicability].map(r=>r.serialize("applicability")).join(`
`)}
      </applicability>
      <requirements>
        ${[...this.requirements].map(r=>r.serialize("requirement")).join(`
`)}
      </requirements>
    </specification>`}}const Jt=a=>{if(!a)return;const e={};if("simpleValue"in a&&(e.type="simple",e.parameter=a.simpleValue),"restriction"in a){const t=a.restriction,i=Object.keys(t);if("pattern"in t&&(e.type="pattern",e.parameter=t.pattern.value),"enumeration"in t){e.type="enumeration";const s=t.enumeration.map(({value:n})=>t.base.includes("string")?String(n):t.base.includes("integer")||t.base.includes("double")?Number(n):n);e.parameter=s}if(i.some(s=>["minInclusive","minExclusive","maxInclusive","maxExclusive"].includes(s))){e.type="bounds";const s={},n=i.find(o=>o.includes("min")),r=i.find(o=>o.includes("max"));n&&(s.minInclusive=n==="minInclusive",s.min=t[n].value),r&&(s.maxInclusive=r==="maxInclusive",s.max=t[r].value),e.parameter=s}if(i.some(s=>["minLength","length","maxLength"].includes(s))){e.type="length";const s={};t.length!==void 0&&(s.length=t.length.value),t.minLength!==void 0&&(s.min=t.minLength.value),t.maxLength!==void 0&&(s.max=t.maxLength.value),e.parameter=s}}if(e.parameter!==void 0)return e},ur=(a,e)=>{const t=[];for(const i of e){const s=i.name,n=Jt(s);if(!n)continue;const r=new rn(a,n);i.cardinality&&(r.cardinality=i.cardinality),r.predefinedType=Jt(i.predefinedType),r.instructions=i.instructions,t.push(r)}return t},dr=(a,e)=>{const t=[];for(const i of e){const s=i.name,n=Jt(s);if(!n)continue;const r=new rc(a,n);i.cardinality&&(r.cardinality=i.cardinality),r.value=Jt(i.value),r.instructions=i.instructions,t.push(r)}return t},fr=(a,e)=>{const t=[];for(const i of e){const s=new lc(a);i.cardinality&&(s.cardinality=i.cardinality);const n=Jt(i.value);(n==null?void 0:n.type)==="enumeration"&&Array.isArray(n.parameter)&&(n.parameter=n.parameter.map(String)),s.value=n,s.uri=i.uri,s.instructions=i.instructions,t.push(s)}return t},pr=(a,e)=>{const t=[];for(const i of e){const s=i.propertySet,n=i.baseName,r=Jt(s),o=Jt(n);if(!(o&&r))continue;const l=new ac(a,r,o);i.cardinality&&(l.cardinality=i.cardinality);const c=Jt(i.value);l.value=c,l.dataType=i.dataType,l.uri=i.uri,l.instructions=i.instructions,t.push(l)}return t},mr=(a,e)=>{const t=[];for(const i of e){const s=i.system,n=Jt(s);if(!n)continue;const r=new oc(a,n);i.cardinality&&(r.cardinality=i.cardinality);const o=Jt(i.value);(o==null?void 0:o.type)==="simple"&&(o.parameter=String(o.parameter)),(o==null?void 0:o.type)==="enumeration"&&Array.isArray(o.parameter)&&(o.parameter=o.parameter.map(String)),r.value=o,r.uri=i.uri,r.instructions=i.instructions,t.push(r)}return t},gr=(a,e)=>{const t=[];for(const i of e){const s=Jt(i.entity.name);if(!s)continue;const n=Jt(i.entity.predefinedType),r=new cc(a,{name:s,predefinedType:n});r.relation=i.relation,i.cardinality&&(r.cardinality=i.cardinality),r.instructions=i.instructions,t.push(r)}return t},qe=class qe extends te{constructor(t){super(t);C(this,"enabled",!0);C(this,"IDSInfo");C(this,"list",new Vt);t.add(qe.uuid,this)}getModelIdMap(t){const i={},s={};for(const[n,r]of t){const l=[...r].filter(([,h])=>h.pass).map(([h])=>h);ue.append(i,n,...l);const u=[...r].filter(([,h])=>!h.pass).map(([h])=>h);ue.append(s,n,...u)}return{pass:i,fail:s}}create(t,i,s){const n=new hc(this.components,t,i);return s&&(n.identifier=s),this.list.set(n.identifier,n),n}load(t){const i=[],s=qe.xmlParser.parse(t).ids,{specifications:n,info:r}=s;if(this.IDSInfo={...r},n&&n.specification){const o=Array.isArray(n.specification)?n.specification:[n.specification];for(const l of o){const{name:c,ifcVersion:u,description:h,instructions:p,identifier:d}=l;if(!(c&&u))continue;const g=[],m=[],{applicability:b,requirements:f}=l;if(b){const{maxOccurs:x,...T}=b,A=Array.isArray(T)?T:[T];for(const S of A)for(const M in S){const I=Array.isArray(S[M])?S[M]:[S[M]];if(M==="entity"){const k=ur(this.components,I);g.push(...k)}if(M==="attribute"){const k=dr(this.components,I);g.push(...k)}if(M==="material"){const k=fr(this.components,I);g.push(...k)}if(M==="classification"){const k=mr(this.components,I);g.push(...k)}if(M==="property"){const k=pr(this.components,I);g.push(...k)}if(M==="partOf"){const k=gr(this.components,I);g.push(...k)}}}let y;if(f){const{maxOccurs:x,...T}=f;y=f.description;const A=Array.isArray(T)?T:[T];for(const S of A)for(const M in S){const I=Array.isArray(S[M])?S[M]:[S[M]];if(M==="entity"){const k=ur(this.components,I);m.push(...k)}if(M==="attribute"){const k=dr(this.components,I);m.push(...k)}if(M==="material"){const k=fr(this.components,I);m.push(...k)}if(M==="classification"){const k=mr(this.components,I);m.push(...k)}if(M==="property"){const k=pr(this.components,I);m.push(...k)}if(M==="partOf"){const k=gr(this.components,I);m.push(...k)}}}const v=this.create(c,u.split(/\s+/),d);v.description=h,v.instructions=p,v.requirementsDescription=y,v.applicability.add(...g),v.requirements.add(...m),i.push(v)}}return i}export(t,i=this.list.values()){const s=i??this.list;return`<ids xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://standards.buildingsmart.org/IDS http://standards.buildingsmart.org/IDS/1.0/ids.xsd" xmlns:ids="http://standards.buildingsmart.org/IDS">
  <!-- Made with That Open Engine ${sn.release} (https://github.com/thatopen/engine_components) -->
  <info>
    <title>${t.title}</title>
    ${t.copyright?`<copyright>${t.copyright}</copyright>`:""}
    ${t.version?`<version>${t.version}</version>`:""}
    ${t.description?`<description>${t.description}</description>`:""}
    ${t.author?`<author>${t.author}</author>`:""}
    ${t.date?`<date>${t.date.toISOString().split("T")[0]}</date>`:""}
    ${t.purpose?`<purpose>${t.purpose}</purpose>`:""}
    ${t.milestone?`<milestone>${t.milestone}</milestone>`:""}
  </info>
  <specifications>
    ${[...s].map(r=>r.serialize()).join(`
`)}
  </specifications>
</ids>`}};C(qe,"uuid","9f0b9f78-9b2e-481a-b766-2fbfd01f342c"),C(qe,"xmlParser",new os.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));let on=qe;export{Ot as B,sn as C,rs as D,rt as E,ft as F,js as H,on as I,ue as M,Zl as O,Ei as R,mc as S,hs as T,Zt as U,ne as V,ls as W,gc as a,rn as b,ac as c,te as d,Xs as e,gn as f,ws as g,Ci as h,Ce as i};
